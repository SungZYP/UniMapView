/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import"../../intl.js";import{E as s}from"../../chunks/Evented.js";import{HandleOwnerMixin as i}from"../../core/HandleOwner.js";import{L as n}from"../../chunks/Logger.js";import{b as o,u as r,x as l,i as a}from"../../core/lang.js";import{a as u}from"../../chunks/Promise.js";import{watch as p}from"../../core/reactiveUtils.js";import{R as c}from"../../chunks/watch.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../form/FormTemplate.js";import y from"../../core/Accessor.js";import f from"../../request.js";import{a as g,J as j}from"../../chunks/JSONSupport.js";import{L as b}from"../../chunks/Loadable.js";import{p as _}from"../../chunks/arcgisLayerUrl.js";import{l as v}from"../../chunks/arcadeOnDemand.js";import F from"./InputField.js";import V from"./InputFieldGroup.js";import{o as C}from"../../chunks/locale.js";import{f as E}from"../../chunks/messages.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../chunks/deprecate.js";import"../../config.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../layers/support/fieldUtils.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/assets.js";import"../../core/Handles.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/support/elements.js";import"../../core/accessorSupport/decorators/aliasOf.js";let I=class extends y{constructor(e){super(e),this.maxValue=null,this.minValue=null}};e([m()],I.prototype,"objectType",void 0),e([m()],I.prototype,"maxValue",void 0),e([m()],I.prototype,"minValue",void 0),e([m()],I.prototype,"codedValue",void 0),I=e([d("esri.layers.support.ContingentValue")],I);const S=I;let x=class extends y{constructor(e){super(e),this.isRetired=!1}};e([m()],x.prototype,"id",void 0),e([m()],x.prototype,"isRetired",void 0),e([m()],x.prototype,"subtype",void 0),e([m()],x.prototype,"values",void 0),x=e([d("esri.layers.support.Contingency")],x);const k=x;let T=class extends y{constructor(e){super(e)}};e([m()],T.prototype,"fieldGroup",void 0),e([m()],T.prototype,"type",void 0),T=e([d("esri.layers.support.ContingencyConstraintViolation")],T);const w=T;let G=class extends y{constructor(e){super(e)}};e([m()],G.prototype,"contingentValuesAllGroups",void 0),e([m()],G.prototype,"contingentValuesByFieldGroup",void 0),G=e([d("esri.layers.support.ContingentValuesResult")],G);const A=G;let L=class extends y{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};e([m()],L.prototype,"name",void 0),e([m()],L.prototype,"fields",void 0),e([m()],L.prototype,"isEditingRestrictive",void 0),e([m()],L.prototype,"contingencies",void 0),L=e([d("esri.layers.support.FieldGroup")],L);const D=L;let O=class extends g{constructor(){super(...arguments),this.code=null,this.defaultValues={},this.domains={},this.name=null}};e([m({type:Number,json:{write:!0}})],O.prototype,"code",void 0),e([m({type:Object,json:{write:!0}})],O.prototype,"defaultValues",void 0),e([m({type:Object,json:{write:!0}})],O.prototype,"domains",void 0),e([m({type:String,json:{write:!0}})],O.prototype,"name",void 0),O=e([d("esri.layers.support.Subtype")],O);const R=O;var M;let N=M=class extends(j(b)){constructor(e){super(e),this.request=f,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON.hasContingentValuesDefinition;if(t)return new M({layer:e}).load();if(void 0===t){const t=_(e.url);if(o(t))return null;const s=t.url.path;if((await M._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const t=e.layerId.toString(),i=await M._staticFetchEnterpriseFieldGroup(s,t);if(i){const t=i.map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names})));return new M({layer:e,fieldGroupDefinitions:t}).load()}}}return null}async load(e){const t=this.layer.load(e).then((()=>this._initializeContingentValues(this.fieldGroupDefinitions,e)));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const s=this.layer.typeIdField,i=Object.keys(e),n=[],o=[];for(const r of this.fieldGroups){const l=r.isEditingRestrictive?"error":"warning";if(t&&!r.fields.some((e=>t.includes(e))))continue;if(!r.fields.every((e=>i.includes(e)))){o.push(new w({fieldGroup:r,type:l}));continue}let a=!1;const u=e[s],p=r.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===u));for(const t of p){let s=!0;for(const i in t.values){const n=t.values[i];if("any"!==n.objectType)if("null"===n.objectType){if(null!=e[i]){s=!1;break}}else if("code"===n.objectType){if(e[i]!==n.codedValue.code){s=!1;break}}else if("range"===n.objectType){const t=e[i];if(t<n.minValue||t>n.maxValue){s=!1;break}}}if(s){a=!0;break}}a||n.push(new w({fieldGroup:r,type:l}))}return{invalid:n,incomplete:o}}getContingentValues(e,t,s=!1){const i=e[this.layer.typeIdField],n={};let o=[];const r=this.fieldGroups.filter((e=>e.fields.includes(t)));o.push(new S({objectType:"any"}));for(const l of r){let r=[];const a=l.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===i));let u=!1;const p={};for(const s of a){let i,n=!0;for(const o in s.values){const r=s.values[o];if(t!==o){if(void 0!==e[o]&&"any"!==r.objectType)if("null"===r.objectType)null!==e[o]&&(n=!1);else if("code"===r.objectType)e[o]!==r.codedValue.code&&(n=!1);else if("range"===r.objectType){const t=e[o];(t<r.minValue||t>r.maxValue)&&(n=!1)}}else i=r,u=u||"range"===r.objectType}if(i&&n){if("any"===i.objectType){r.length=0,r.push(i);break}const e=this._generateKey(i);p[e]||r.push(i),p[e]=!0}}u&&(r=this._joinRange(r)),n[l.name]=r,o=s?this._filterIntersection(o,r):null}return 1===r.length&&(o=[]),new A({contingentValuesAllGroups:o,contingentValuesByFieldGroup:n})}_generateKey(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}_joinRange(e){let t,s;e.sort(((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue));const i=[];for(const n of e)"null"!==n.objectType?void 0!==t?s<n.minValue?(i.push(new S({objectType:"range",minValue:t,maxValue:s})),t=n.minValue,s=n.maxValue):s<n.maxValue&&(s=n.maxValue):(t=n.minValue,s=n.maxValue):i.push(n);return i.push(new S({objectType:"range",minValue:t,maxValue:s})),i}_filterIntersection(e,t){var s,i;if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const n="range"===e[0].objectType||"range"===(null==(s=e[1])?void 0:s.objectType),o="range"===t[0].objectType||"range"===(null==(i=t[1])?void 0:i.objectType);return n||o?this._intersectRanges(e,t):this._intersectValues(e,t)}_intersectRanges(e,t){const s=[];let i,n=0;for(const o of e)for(;n<t.length;n++){const e=t[n];if("null"===o.objectType&&"null"===e.objectType)s.push(new S({objectType:"null"}));else{if("null"===o.objectType)break;if("null"===e.objectType)continue}if(o.maxValue<e.minValue)break;if(o.maxValue===e.minValue){s.push(new S({objectType:"range",minValue:o.maxValue,maxValue:e.minValue}));break}if(!(o.minValue>e.maxValue))if(o.minValue!==e.maxValue){if(i=o.minValue>e.minValue?o.minValue:e.minValue,o.maxValue<e.maxValue){s.push(new S({objectType:"range",minValue:i,maxValue:o.maxValue}));break}s.push(new S({objectType:"range",minValue:i,maxValue:e.maxValue}))}else s.push(new S({objectType:"range",minValue:o.minValue,maxValue:e.maxValue}))}return s}_intersectValues(e,t){const s=[];for(const i of e)t.some((e=>{if(i.objectType===e.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===e.codedValue.code&&i.codedValue.name===e.codedValue.name}return!1}))&&s.push(i);return s}static async _staticFetchEnterpriseFeatureRoot(e,t){return f(e,{responseType:"json",query:{f:"json"},...t}).then((e=>e.data))}static async _staticFetchEnterpriseFieldGroup(e,t,s){return f(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>{var t;return null==(t=e.data.layerDataElements)?void 0:t[0].dataElement.fieldGroups}))}async _initializeContingentValues(e,t){const s=e||await this._fetchFieldGroupDefs(t);if(0===s.length)return void(this.fieldGroups=[]);const i=await this._fetchContingentValues(s,t);this.fieldGroups=i}async _fetchFieldGroupDefs(e){const t=this.layer.sourceJSON,s=this.layer.layerId.toString(),i=r(_(this.layer.url)).url.path;if(t.hasContingentValuesDefinition){return(await this._fetchAGOLFieldGroup(i,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))})))}return void 0!==t.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(i,e).then((async t=>{if(t.supportsQueryDataElements){return(await this._fetchEnterpriseFieldGroup(i,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))})))}return[]}))}async _fetchAGOLFieldGroup(e,t,s){return f(`${e}/${t}/fieldgroups`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data.fieldGroups))}async _fetchEnterpriseFieldGroup(e,t,s){return M._staticFetchEnterpriseFieldGroup(e,t,s)}async _fetchEnterpriseFeatureRoot(e,t){return M._staticFetchEnterpriseFeatureRoot(e,t)}async _fetchContingentValues(e,t){const s=this.layer.sourceJSON,i=this.layer.layerId.toString(),n=r(_(this.layer.url)).url.path;if(s.hasContingentValuesDefinition){const s=await this._fetchAGOLContingentValues(n,i,t);return this._constructFieldGroupsAGOL(e,s)}const o=await this._fetchEnterpriseContingentValues(n,i,t);return this._constructFieldGroupsEnterprise(e,o)}_constructFieldGroupsAGOL(e,t){return e.map((e=>{const s=t.contingentValuesDefinition.fieldGroups.find((t=>t.name===e.name));if(s){let i=[];return i=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,s.subTypes):this._parseAGOLFieldGroup(e,t,s.contingentValues),new D({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:i})}return null})).filter((e=>null!==e))}_parseAGOLFieldGroupSubtype(e,t,s){let i=[];return s.forEach((s=>{const n=this._getSubtypeAGOL(s.name);i=i.concat(this._parseAGOLFieldGroup(e,t,s.contingentValues,n))})),i}_parseAGOLFieldGroup(e,t,s,i=null){const n=[];for(const o of s){const s=this._parseAGOLContingency(o,e,t,i);n.push(s)}return n}_parseAGOLContingency(e,t,s,i){const n=e.id,o=!!e.retired&&1===e.retired,r={};for(let n=0,o=0;n<t.fields.length;n++){const l=t.fields[n],a=s.typeCodes[e.types[n]];if("Code"===a){let t=e.values[o];o++;const n=this._getDomain(i,l);if("string"===this.layer.getField(l).type){const e=s.stringDicts.find((e=>e.domain===n.name));e&&(t=e.entries[t])}const a=n.codedValues.find((e=>e.code===t)),u=new S({codedValue:a,objectType:"code"});r[l]=u}else if("Range"===a){const t=e.values[o];o++;const s=t.range[0],i=t.range[1],n=new S({minValue:s,maxValue:i,objectType:"range"});r[l]=n}else if("Any"===a){const e=new S({objectType:"any"});r[l]=e}else{const e=new S({objectType:"null"});r[l]=e}}return new k({id:n,isRetired:o,subtype:i,values:r})}_constructFieldGroupsEnterprise(e,t){const s=t.fieldGroups;return e.map((e=>{const i=s.find((t=>t.name===e.name));if(i){const s=i.contingencies.map((s=>{const i=s.id,n=s.isRetired||!1,o=this._getSubtypeEnterprise(s.subtypeCode),r={};for(let i=0;i<e.fields.length;i++){const n=e.fields[i];let l=s.values[i];if("number"==typeof l||"string"==typeof l){const e=this._getDomain(o,n),s=this.layer.getField(n);if("string"===s.type)l=t.stringDictionary[l];else if("date"===s.type){const e=new Date(`${l}+00:00`);l=e.getTime()}const i=e.codedValues.find((e=>e.code===l)),a=new S({codedValue:i,objectType:"code"});r[n]=a}else if("object"==typeof l){const e=l.minValue,t=l.maxValue,s=new S({minValue:e,maxValue:t,objectType:"range"});r[n]=s}else if(l){const e=new S({objectType:"any"});r[n]=e}else{const e=new S({objectType:"null"});r[n]=e}}return new k({id:i,isRetired:n,subtype:o,values:r})}));return new D({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:s})}return null})).filter((e=>null!==e))}async _fetchEnterpriseContingentValues(e,t,s){return f(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>{var t;return null==(t=e.data.contingentValueSets)?void 0:t[0]}))}async _fetchAGOLContingentValues(e,t,s){return f(`${e}/${t}/contingentValues`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data))}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const i=t.subtypes.find((t=>t.code===e));s=R.fromJSON(i)}return s||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const i=t.subtypes.find((t=>t.name===e));s=R.fromJSON(i)}return s||null}_getDomain(e,t){const s=e?e.domains[t]:this.layer.getFieldDomain(t);return"inherited"===s.type?this.layer.getFieldDomain(t):s}};e([m({constructOnly:!0})],N.prototype,"layer",void 0),e([m({constructOnly:!0})],N.prototype,"request",void 0),e([m({type:[D]})],N.prototype,"fieldGroups",void 0),e([m()],N.prototype,"fieldGroupDefinitions",void 0),N=M=e([d("esri.layers.support.LayerContingentValuesCache")],N);const P=N;function U(e){return!!e.inputFields}const q=new t({attributes:{}}),J="esri.widgets.FeatureForm.FeatureFormViewModel",z=n.getLogger(J),B="#JSAPI_CONTINGENT_VALUE_ANY_HASH";let $=class extends(i(u(s.EventedAccessor))){constructor(e){super(e),this._arcade=null,this._compiledExpressionLookup=new Map,this._expressionLookup=new Map,this._contingentValuesCache=null,this._fieldPool=new c(F,(e=>this.handles.add(p((()=>e.value),(()=>{e.isUsingValueExpression&&this._afterValueChange(e)})),e.id)),(({id:e})=>this.handles.remove(e))),this._fieldGroupPool=new c(V),this._featureClone=q.clone(),this._initialFeature=q.clone(),this._needsArcade=!1,this._inputFieldCache=new Map,this._inputFieldGroupCache=new Map,this.contingencyConstraintViolations=new Map,this.messages=null,this.strict=!1}initialize(){const e=async()=>this.messages=await E("esri/widgets/FeatureForm/t9n/FeatureForm");e();const t=p((()=>this.layer),(e=>{"feature"===(null==e?void 0:e.type)&&this.addResolvingPromise(P.createLoadedLayerContingentValuesCache(e).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0}),s=p((()=>{var e,t;const{formTemplate:s}=this;if(o(s))return null;const i=null!=(e=s.expressionInfos)?e:[],n=null!=(t=s.elements)?t:[];return[...i.map((e=>e.expression)),...null==n?void 0:n.map((e=>this._getExpressionsFromElementRecursive(e))).flat()]}),(async e=>{if(!e||e.length<1)return this._compiledExpressionLookup.clear(),void this._expressionLookup.clear();const{_compiledExpressionLookup:t,_expressionLookup:i,formTemplate:n}=this,o=new Set(e);if(i.clear(),a(n)&&a(n.expressionInfos))for(const e of n.expressionInfos)o.delete(e.name),i.set(e.name,e.expression);for(const e of t.keys())o.delete(e),i.set(e,e);if(o.size<1)return;this._needsArcade=!0;const r=await v();this._arcade=r;const{arcadeUtils:l}=r;for(const e of o.values())l.hasGeometryOperations(e)&&(await l.enableGeometryOperations(),s.remove()),i.set(e,e),this._setFunctionForExpression(e);this.notifyChange("inputFields")}),{initial:!0});this.handles.add([C(e),s,t])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=l(this._contingentValuesCache),this._fieldPool.destroy(),this._fieldGroupPool.destroy()}get allInputFields(){return this.inputFields.reduce(((e,t)=>U(t)?[...e,...t.inputFields]:[...e,t]),[])}get _layerFieldsByName(){return new Map(this.layer.fields.map((e=>[e.name,e])))}get description(){const{formTemplate:e}=this;return a(e)?e.description:""}set description(e){void 0===e?this._clearOverride("description"):this._override("description",e)}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():q.clone(),this._initialFeature=this._featureClone.clone(),this._inputFieldCache.clear(),this._inputFieldGroupCache.clear(),this.contingencyConstraintViolations.clear(),this._set("feature",e)}get fieldsWithContingentValues(){if(o(this._contingentValuesCache))return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get inputFields(){const{_arcade:e,_featureClone:t,_initialFeature:s,_inputFieldCache:i,_inputFieldGroupCache:n,_needsArcade:o,formTemplate:r,messages:l,layer:u,state:p}=this;if("ready"!==p||o&&!e)return[];const c=t.clone(),m=Array.from(i.keys()),d=Array.from(n.keys()),h={arcade:e,feature:c,initialFeature:s,layer:u,messages:l},y=a(r)&&r.elements.length>0?this._generateInputFieldsFromElements(r.elements,h):this._generateInputFieldsFromLayerFields(null==u?void 0:u.fields,h);return this._cullCaches(y,m,d),this._releasePreviousInputFields(),y.filter((e=>e.visible))}get joinedContingentValues(){return this._joinContingentValues()}get layer(){var e;return null!=(e=this.feature)&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){e?this._override("layer",e):this._clearOverride("layer")}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get submittable(){return!!this.valid||this.allInputFields.filter((e=>!e.valid)).every((({submittable:e})=>e))}get title(){const{formTemplate:e}=this;return a(e)?e.title:""}set title(e){void 0===e?this._clearOverride("title"):this._override("title",e)}get valid(){const e=this.allInputFields;return e.length>0&&e.every((({valid:e})=>e))}findField(e){return this.allInputFields.find((t=>t.name===e))}getValue(e){var t;const{_featureClone:s,layer:i}=this,n=!(null==i||!i.getField(e));return null!=(t=s.getAttribute(e))?t:n?null:void 0}setValue(e,t){const{_featureClone:s,strict:i}=this,n=this.findField(e);t=""===t?null:t,n&&s.getAttribute(e)!==t&&(n.value=t,i&&!n.valid||this._afterValueChange(n))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this.allInputFields,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),s=e.filter((e=>!e.valid)).map((({name:e})=>e)),i=this.getValues();if(this.validateContingencyConstraints(i,{includeIncompleteViolations:!0}).length>0)for(const[e,i]of this.contingencyConstraintViolations.entries())"error"===i.type&&(t.delete(e),s.push(e));this.emit("submit",{valid:[...t],invalid:s,values:i})}validateContingencyConstraints(e,t){const{_contingentValuesCache:s}=this,i=new Map;if(this.contingencyConstraintViolations=i,o(s))return[];const{invalid:n,incomplete:r}=s.validateContingencyConstraints(e),l=[...n,...null!=t&&t.includeIncompleteViolations?r:[]];for(const e of l)for(const t of e.fieldGroup.fields)i.set(t,e);return l}_cullCaches(e,t,s){const i=[],n=[];for(const t of e)U(t)?(n.push(t.label),i.push(...t.inputFields.map((e=>e.name)))):i.push(t.name);this._cullInputFieldCache(i,t),this._cullInputFieldGroupCache(n,s)}_cullInputFieldCache(e,t){const s=t.filter((t=>!e.includes(t)));for(const e in s)this._inputFieldCache.delete(e)}_cullInputFieldGroupCache(e,t){const s=t.filter((t=>!e.includes(t)));for(const e in s)this._inputFieldGroupCache.delete(e)}_releasePreviousInputFields(){const e=this._get("inputFields");if(e&&!(e.length<1))for(const t of e)"groupElement"in t?this._releaseInputFieldGroup(t):this._releaseInputField(t)}_releaseInputFieldGroup(e){e.inputFields.forEach((e=>this._releaseInputField(e))),this._fieldGroupPool.release(e)}_releaseInputField(e){this._fieldPool.release(e)}_emitChangeEvent({name:e,valid:t,value:s}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:s,valid:t})}_generateInputFieldsFromElements(e,t){const s=[];for(const i of e)this._isSupportedElement(i)&&s.push("group"===i.type?this._acquireAndInitializeInputFieldGroup(i,t):this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(i.fieldName),fieldElement:i,...t}));return s}_generateInputFieldsFromLayerFields(e,t){return Array.isArray(e)?e.map((e=>this._acquireAndInitializeInputField({field:e,fieldElement:null,...t}))):(z.warn(J,"No attribute fields found."),[])}_acquireAndInitializeInputField(e){var t,s,i,n,o,r;const{arcade:l,feature:a,field:u,fieldElement:p,group:c,initialFeature:m,layer:d,messages:h}=e,y=null!=(t=this._getCompiledExpression(null==p?void 0:p.requiredExpression))?t:void 0,f=null!=(s=this._getCompiledExpression(null==p?void 0:p.visibilityExpression))?s:void 0,g=null!=(i=this._getCompiledExpression(null==p?void 0:p.valueExpression))?i:void 0,j=null!=(n=this._getCompiledExpression(null==p?void 0:p.editableExpression))?n:void 0,b=u.name,_=null!=(o=null==(r=this._inputFieldCache.get(b))?void 0:r.value)?o:this.getValue(b),v=this._fieldPool.acquire();return this._inputFieldCache.set(b,v),v.set({field:u,fieldElement:p,arcade:l,feature:a,group:c,initialFeature:m,layer:d,messages:h,requiredFunction:y,visibilityFunction:f,editableFunction:j,valueFunction:g,value:_})}_acquireAndInitializeInputFieldGroup(e,t){var s,i;const n=null!=(s=null==(i=this._inputFieldGroupCache.get(e.label))?void 0:i.state)?s:e.initialState,o=this._fieldGroupPool.acquire();this._inputFieldGroupCache.set(e.label,o);const r=[];for(const s of e.elements)this._isSupportedElement(s)&&r.push(this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(s.fieldName),fieldElement:s,group:o,...t}));const{arcade:l,feature:a}=t,u=this._getCompiledExpression(e.visibilityExpression);return o.set({arcade:l,feature:a,groupElement:e,inputFields:r,state:n,visibilityFunction:u})}_afterValueChange(e){const{name:t,value:s}=e;if(this.get("layer.typeIdField")===e.name&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}this._featureClone.setAttribute(t,s),this.notifyChange("inputFields"),this._emitChangeEvent(e)}_getCompiledExpression(e){return this._compiledExpressionLookup.get(this._expressionLookup.get(e))}_getExpressionsFromElementRecursive(e){const t=[];if(e.visibilityExpression&&t.push(e.visibilityExpression),"field"===e.type){const s=["requiredExpression","valueExpression","editableExpression"];for(const i of s)e[i]&&t.push(e[i])}if("group"===e.type&&e.elements)for(const s of e.elements)t.push(...this._getExpressionsFromElementRecursive(s));return t}_setFunctionForExpression(e){const{_arcade:{arcadeUtils:t},_compiledExpressionLookup:s}=this;s.set(e,t.createFunction(e))}_isSupportedElement(e){return"field"===e.type||"group"===e.type||(z.warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}_joinContingentValues(){const e=this._contingentValuesCache;if(o(e))return[];const t="typeIdField"in this.layer?this.layer.typeIdField:null,s=t?this.getValue(t):null,i=[];for(const t of e.fieldGroups){const{contingencies:e,fields:n,name:o}=t,r=[];for(const t of e)t.isRetired||a(t.subtype)&&t.subtype.code!==s||r.push({values:t.values});r.length>0&&i.push({name:o,fields:n,contingencies:r})}const[n,r]=this._generateJoinPlan(i);return[...n.flatMap((e=>this._joinFieldGroupContingencies(e))),...r.flatMap((e=>e.contingencies))]}_generateJoinPlan(e){const t=new Map,s=[],i=new Set;for(const n of e)for(const e of n.fields)if(t.has(e)){const o=t.get(e),r=n,l=[o.name,r.name].sort().join("|");if(i.has(l))continue;s.push([o,r]),i.add(l),t.set(e,r)}else t.set(e,n);const n=new Set(s.flat()),o=new Set(e);for(const e of n)o.delete(e);const r=new Map,l=new Map;for(const e of new Set(s.flat())){const t=Symbol(e.name);r.set(t,new Set([e])),l.set(e,t)}for(const[e,t]of s){const s=l.get(e),i=l.get(t);if(s===i)continue;const n=r.get(s),o=r.get(i);for(const e of o)n.add(e),l.set(e,s);r.delete(i)}return[[...r.values()].map((e=>[...e])),[...o]]}_joinFieldGroupContingencies(e){const t=e.slice(),s=t.shift();let i=t.shift(),n=this._generateJoinKey(s.fields,i.fields),r=new Set([...s.fields,...i.fields]),l=new Map;for(const e of s.contingencies){const[t]=this._hashContingency(e,n.codedValueFields,!0);l.has(t)?l.get(t).push(e):l.set(t,[e])}for(;t.length>0;){const e=new Map,s=t.shift(),a=this._generateJoinKey(r,s.fields);for(const t of i.contingencies){const[s,i]=this._hashContingency(t,n.codedValueFields),r=i?this._findMatchingContingenciesWithAnyHashMask(l,s):l.get(s);if(l.has(B)&&r.push(...this._findMatchingContingenciesContainingAny(t,l.get(B),n.codedValueFields)),!o(r))for(const s of r){const i=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(s,t,n.rangeFields):this._joinContingencies(s,t);if(o(i))break;const[r]=this._hashContingency(i,a.codedValueFields,!0);e.has(r)?e.get(r).push(i):e.set(r,[i])}}l=e,i=s,n=a,r=new Set([...r,...i.fields])}const u=[];for(const e of i.contingencies){const[t,s]=this._hashContingency(e,n.codedValueFields),i=s?this._findMatchingContingenciesWithAnyHashMask(l,t):l.get(t);if(l.has(B)&&i.push(...this._findMatchingContingenciesContainingAny(e,l.get(B),n.codedValueFields)),!o(i))for(const t of i){const s=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(t,e,n.rangeFields):this._joinContingencies(t,e);a(s)&&u.push(s)}}return u}_joinContingencies(e,t){const s={values:{...e.values,...t.values}};for(const[t,i]of Object.entries(s.values))"any"===i.objectType&&a(e.values[t])&&(s.values[t]=e.values[t]);return s}_joinContingenciesWithRangeDomains(e,t,s){const i=this._joinContingencies(e,t);for(const n of s){const s=e.values[n],o=t.values[n],{leftIsNull:r,rightIsNull:l,bothAreNull:a,leftIsAny:u,rightIsAny:p,bothAreAny:c,leftIsRange:m,rightIsRange:d}=this._compareObjectTypes(s.objectType,o.objectType);if(a||c)continue;if(r&&p||l&&u){i.values[n]=new S({objectType:"null"});continue}if(r&&d||l&&m)return null;u?(s.minValue=-1/0,s.maxValue=1/0):p&&(o.minValue=-1/0,o.maxValue=1/0);const h=Math.max(s.minValue,o.minValue),y=Math.min(s.maxValue,o.maxValue);if(h>y)return null;i.values[n]=new S({objectType:"range",minValue:h,maxValue:y})}return i}_findMatchingContingenciesContainingAny(e,t,s){return t.filter((t=>s.every((s=>{var i,n;const o=t.values[s],r=e.values[s];return"any"===o.objectType||"any"===r.objectType||(null==(i=o.codedValue)?void 0:i.code)===(null==(n=r.codedValue)?void 0:n.code)}))))}_findMatchingContingenciesWithAnyHashMask(e,t){const s=RegExp(`${t}$`),i=[];for(const[t,n]of e){if(t===B)break;s.test(t)&&i.push(...n)}return i}_generateJoinKey(e,t){const s=Array.isArray(e)?new Set(e):e,i=Array.isArray(t)?new Set(t):t,n=s.size<i.size?s:i,r=n===s?i:s,l=new Set,a=new Set;for(const e of n)if(r.has(e)){const t=this.layer.getFieldDomain(e,{feature:this.feature});if(o(t))continue;switch(t.type){case"coded-value":l.add(e);break;case"range":a.add(e)}}return{codedValueFields:[...l],rangeFields:[...a]}}_hashContingency(e,t,s=!1){if(t.length<1)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const i=[];let n=!1;for(const r of t){const t=e.values[r];if("any"===t.objectType){if(s)return[B,!0];n=!0,i.push(`${r}:.*`)}else if("null"===t.objectType)i.push(`${r}:#JSAPI_CONTINGENT_VALUE_NULL_HASH`);else{var o;i.push(`${r}:${null==(o=t.codedValue)?void 0:o.code}`)}}return[i.sort().join("&"),n]}_compareObjectTypes(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}}};e([m({readOnly:!0})],$.prototype,"allInputFields",null),e([m()],$.prototype,"_layerFieldsByName",null),e([m({readOnly:!0})],$.prototype,"_inputFieldCache",void 0),e([m({readOnly:!0})],$.prototype,"_inputFieldGroupCache",void 0),e([m()],$.prototype,"contingencyConstraintViolations",void 0),e([m()],$.prototype,"description",null),e([m()],$.prototype,"feature",null),e([m()],$.prototype,"fieldsWithContingentValues",null),e([m({type:h})],$.prototype,"formTemplate",null),e([m({readOnly:!0,dependsOn:["formTemplate","messages","feature","layer.fields","layer.loaded","state"]})],$.prototype,"inputFields",null),e([m()],$.prototype,"joinedContingentValues",null),e([m()],$.prototype,"layer",null),e([m()],$.prototype,"messages",void 0),e([m()],$.prototype,"state",null),e([m()],$.prototype,"strict",void 0),e([m()],$.prototype,"submittable",null),e([m()],$.prototype,"title",null),e([m()],$.prototype,"valid",null),e([m()],$.prototype,"getValues",null),e([m()],$.prototype,"submit",null),$=e([d(J)],$);const H=$;export{H as default};
