/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import{HandleOwnerMixin as i}from"../../core/HandleOwner.js";import{L as s}from"../../chunks/Loadable.js";import{b as r,i as o}from"../../core/lang.js";import{watch as a,on as n}from"../../core/reactiveUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import{cast as l}from"../../core/accessorSupport/decorators/cast.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as m,isLoaded as u,load as h}from"../../geometry/projection.js";import{e as d}from"../../geometry/SpatialReference.js";import{b as f}from"../../chunks/basemapUtils.js";import j from"../../core/Error.js";import{throwIfAborted as y}from"../../core/promiseUtils.js";import{c as g,i as v}from"../../chunks/layerUtils.js";import{s as w,V as b}from"../../chunks/ViewingMode.js";import{p as k,k as R,c as L}from"../../chunks/terrainUtils.js";import{T as P}from"../../chunks/TerrainConst.js";import{i as B}from"../../chunks/spatialReferenceSupport.js";import S from"./support/BasemapGalleryItem.js";import U from"./support/LocalBasemapsSource.js";import I from"./support/PortalBasemapsSource.js";import"../../chunks/ArrayPool.js";import"../../chunks/Evented.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/ensureType.js";import"../../chunks/shared.js";import"../../core/Handles.js";import"../../chunks/Promise.js";import"../../chunks/mathUtils.js";import"../../chunks/common.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/Ellipsoid.js";import"../../chunks/mat4.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../Basemap.js";import"../../chunks/collectionUtils.js";import"../../chunks/loadAll.js";import"../../chunks/asyncUtils.js";import"../../portal/Portal.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/messages.js";import"../../chunks/writeUtils.js";import"../../chunks/Util.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4f64.js";import"../../chunks/Scheduler.js";import"../../chunks/debugFlags.js";import"../../layers/support/TileInfo.js";import"../../layers/support/LOD.js";import"../../core/watchUtils.js";async function _(e,t={}){await async function(e,t){const{basemap:i,view:s}=e;if(await i.load(t),0===i.baseLayers.length)return;const a=function(e){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return e.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((e=>new j("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})))}(i.baseLayers.concat(i.referenceLayers));if(a.length)throw a[0];const n=i.baseLayers.getItemAt(0);try{await n.load(t)}catch(e){const t="basemap-compatibility:unknown-error",i="Unknown basemap compatibility error",{name:s=t,message:r=i,details:o}=e;throw new j(s,r,o)}!function(e,t){const i=t.state.viewingMode;if(!i)return;let s=e.tileInfo,a=e.fullExtent;if(v(e)){const o=k(e,t.spatialReference,i);if(r(o.tileInfo))throw new j("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");s=o.tileInfo,a=o.fullExtent}if(r(s))return;if(!B(s.spatialReference,i))throw new j(`basemapgalleryitem:spatial-reference-unsupported-${w(i)}`,`Basemap spatial reference is unsupported in ${w(i)} mode`);const n=s.spatialReference.isGeographic,p=R(e)?s.getOrCreateCompatible(256,n?1:2):null;if(i===b.Global){let t=L(s,a,null,i);if(t&&R(e)&&o(a)&&p&&!L(p,a,null,i)&&(t=null),t){const e=s.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new j(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(P.checkUnsupported(s))throw new j("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const l=t.get("basemapTerrain.tilingScheme");if(l&&!l.compatibleWith(s)&&!(R(e)&&p&&l.compatibleWith(p)))throw new j("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}(n,s)}(e,t),y(t)}async function T(e,t={}){const{basemap:i,view:s}=e;if(y(t),"spatialReferenceLocked"in s&&!s.spatialReferenceLocked)return;if(await i.load(t),y(t),0===i.baseLayers.length)return;const r=i.baseLayers.getItemAt(0);if(!g(r))return;if(i.spatialReference){if(s.spatialReference.equals(i.spatialReference))return;E()}await r.load(t),y(t);const o=(("supportedSpatialReferences"in r?r.supportedSpatialReferences:null)||["tileInfo"in r?r.tileInfo.spatialReference:null]).filter(Boolean);0!==o.length&&o.every((e=>!s.spatialReference.equals(e)))&&E()}function E(){throw new j("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}const O=t.ofType(S);let A=class extends(i(s)){constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new O,this.source=new I,this.view=null}initialize(){const e=()=>this._recreateItems();this.handles.add([a((()=>"ready"===this.state?this.compatibilityFunction:null),(()=>this._updateItems())),n((()=>{var e;return null==(e=this.source)?void 0:e.basemaps}),"change",e,{onListenerAdd:e})])}get activeBasemap(){var e,t,i;return null!=(e=null==(t=this.view)||null==(i=t.map)?void 0:i.basemap)?e:null}set activeBasemap(e){var t;if(!this.view.map)return;if(!e||!this.view.ready)return this.view.map.basemap=e,void this._clearOverride("activeBasemap");const i=e.spatialReference||(null==(t=this.items)?void 0:t.find((t=>t.basemap===e)).spatialReference);if(i&&"spatialReferenceLocked"in this.view&&!this.view.spatialReferenceLocked){const t=this.view.spatialReference;if(o(i)&&!d(t,i)&&!m(this.view.spatialReference,i)&&!u())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void h().then((()=>{this._get("activeBasemap")===e&&(this.view.map.basemap=e,this.view.spatialReference=i,this._clearOverride("activeBasemap"))}),(()=>{})).then((()=>{this._loadingProjectionEngine=!1}));this.view.map.basemap=e,this._clearOverride("activeBasemap"),o(i)&&!d(this.view.spatialReference,i)&&(this.view.spatialReference=i)}else this.view.map.basemap=e,this._clearOverride("activeBasemap")}get compatibilityFunction(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)?_:T}set compatibilityFunction(e){o(e)?this._override("compatibilityFunction",e):this._clearOverride("compatibilityFunction")}castSource(e){return Array.isArray(e)||t.isCollection(e)?new U({basemaps:e}):function(e){return e&&"esri.portal.Portal"===e.declaredClass}(e)?new I({portal:e}):function(e){return e&&!(e instanceof I)&&(!!e.portal||!!e.query)}(e)?new I(e):function(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}(e)?e:null}get state(){var e;return null!=(e=this.view)&&e.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,t){return f(e,t)}refresh(){this._recreateItems()}load(e){return this.addResolvingPromise(s.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)}_recreateItems(){var e;const t=null==(e=this.source)?void 0:e.basemaps,{view:i,compatibilityFunction:s}=this;this.items.removeAll().forEach((e=>e.destroy())),t&&this.items.addMany(t.map((e=>new S({basemap:e,compatibilityFunction:s,view:i}))))}_updateItems(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};e([p()],A.prototype,"_loadingProjectionEngine",void 0),e([p()],A.prototype,"activeBasemap",null),e([p()],A.prototype,"compatibilityFunction",null),e([p({readOnly:!0,type:O})],A.prototype,"items",void 0),e([p()],A.prototype,"source",void 0),e([l("source")],A.prototype,"castSource",null),e([p({readOnly:!0})],A.prototype,"state",null),e([p()],A.prototype,"view",void 0),A=e([c("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],A);const F=A;export{F as default};
