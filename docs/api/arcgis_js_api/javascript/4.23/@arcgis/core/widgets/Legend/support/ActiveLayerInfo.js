/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import{addTokenParameter as s}from"../../../kernel.js";import l from"../../../request.js";import{isSymbol3D as r}from"../../../symbols.js";import i,{a as n}from"../../../core/Accessor.js";import o from"../../../core/Collection.js";import a from"../../../core/Handles.js";import{J as u}from"../../../chunks/jsonMap.js";import{L as c}from"../../../chunks/Logger.js";import{u as m,i as p}from"../../../core/lang.js";import{eachAlways as d,debounce as y}from"../../../core/promiseUtils.js";import{p as h}from"../../../chunks/screenUtils.js";import{addQueryParameters as f}from"../../../core/urlUtils.js";import{on as b,init as g,whenFalseOnce as S,watch as v}from"../../../core/watchUtils.js";import{property as j}from"../../../core/accessorSupport/decorators/property.js";import"../../../chunks/ensureType.js";import{subclass as w}from"../../../core/accessorSupport/decorators/subclass.js";import{E as L}from"../../../chunks/EffectView.js";import{e as _}from"../../../chunks/jsonUtils.js";import{E as I}from"../../../chunks/ExportImageParameters.js";import{isDateField as A}from"../../../layers/support/fieldUtils.js";import{fromJSON as C}from"../../../renderers/support/jsonUtils.js";import{i as E}from"../../../chunks/rendererConversion.js";import k,{S as V}from"../../../renderers/visualVariables/SizeVariable.js";import{applyCIMSymbolColor as R}from"../../../symbols/support/cimSymbolUtils.js";import{renderColorRampPreviewHTML as F,renderDotDensityPreviewHTML as M,S as x,renderPreviewHTML as z}from"../../../symbols/support/symbolUtils.js";import{h as U}from"../../../chunks/renderUtils.js";import{h as T,i as D,j as O,k as P}from"../../../chunks/utils6.js";import{f as B,c as H}from"../../../chunks/number.js";import{f as N,r as q,n as W,p as Q}from"../../../chunks/numberUtils.js";import G from"../../../symbols/SimpleLineSymbol.js";import $ from"../../../renderers/support/HeatmapColorStop.js";import{getSymbolLayerFill as J}from"../../../chunks/previewSymbol3D.js";import{i as K}from"../../../chunks/widgetThemeUtils.js";import{formatNumberLabel as X}from"../../smartMapping/support/utils.js";import Y from"../../../symbols/SimpleMarkerSymbol.js";import Z from"../../../symbols/SimpleFillSymbol.js";import"../../../chunks/colorUtils.js";import"../../../chunks/mathUtils.js";import"../../../chunks/common.js";import"../../../config.js";import"../../../chunks/object.js";import"../../../chunks/string.js";import"../../../core/Error.js";import"../../../symbols/CIMSymbol.js";import"../../../chunks/enumeration.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../symbols/Symbol.js";import"../../../chunks/JSONSupport.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/deprecate.js";import"../../../chunks/metadata.js";import"../../../chunks/ArrayPool.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/arcadeOnDemand.js";import"../../../geometry.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../geometry/SpatialReference.js";import"../../../geometry/Point.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../chunks/Ellipsoid.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/extentUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils3.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils4.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/aaBoundingRect.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../chunks/persistableUrlUtils.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../chunks/Loadable.js";import"../../../chunks/Promise.js";import"../../../chunks/locale.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../portal/PortalGroup.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/Clonable.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/Evented.js";import"../../../chunks/shared.js";import"../../../chunks/Symbol3DVerticalOffset.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/parser.js";import"../../../chunks/mat4f32.js";import"../../../chunks/mat4.js";import"../../../chunks/_commonjsHelpers.js";import"../../../core/HandleOwner.js";import"../../../core/reactiveUtils.js";import"../../../chunks/commonProperties.js";import"../../../TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../support/timeUtils.js";import"../../../chunks/ElevationInfo.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/unitUtils.js";import"../../../chunks/projectionEllipsoid.js";import"../../../chunks/sublayerUtils.js";import"../../../chunks/floorFilterUtils.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../renderers/Renderer.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../chunks/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../chunks/LegendOptions.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties2.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/symbolConversion.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/sizeVariableUtils.js";import"../../../chunks/visualVariableUtils.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../chunks/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/TextContent.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../support/actions/ActionBase.js";import"../../../chunks/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../chunks/compilerUtils.js";import"../../../renderers/DictionaryRenderer.js";import"../../../chunks/DictionaryLoader.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../renderers/DotDensityRenderer.js";import"../../../core/accessorSupport/decorators/aliasOf.js";import"../../../renderers/support/AttributeColorInfo.js";import"../../../renderers/HeatmapRenderer.js";import"../../../renderers/SimpleRenderer.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils.js";import"../../../chunks/utils7.js";import"../../../chunks/asyncUtils.js";import"../../../chunks/assets.js";import"../../../chunks/ItemCache.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/projector.js";import"../../../chunks/widgetUtils.js";import"../../../chunks/mat2df32.js";import"../../../chunks/mat2d.js";import"../../../chunks/jsxFactory.js";import"../../../chunks/jsxWidgetSupport.js";import"../../../intl.js";import"../../../chunks/messages.js";import"../../../chunks/webStyleSymbolUtils.js";import"../../../chunks/devEnvironmentUtils.js";import"../../../chunks/utils13.js";const ee=H("short-date");function te(e,t,s,l){let r="";0===t?r="< ":t===s&&(r="> ");let i=null;return i=l?B(e,ee):N(e),r+i}const se=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function le(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const t=e.visualVariables.find((e=>"color"===e.type));if(!t)return null;let s=null,l=null;if(t.stops){if(1===t.stops.length)return t.stops[0].color;s=t.stops[0].value,l=t.stops[t.stops.length-1].value}const r=s+(l-s)/2,{getColor:i}=await import("../../../chunks/visualVariableUtils.js");return i(t,r)}async function re(e,t){const s=e.trailWidth||1,l=t||await le(e)||e.color;return new G({cap:"butt",color:l,width:s})}const ie=new t([64,64,64]);function ne(e,t){const s=[],l=e.length-1;return 5===e.length?s.push(0,2,4):s.push(0,l),e.map(((e,r)=>s.indexOf(r)>-1?te(e,r,l,t):null))}async function oe(e,s,l){let r=!1,i=[],n=[];if(e.stops){const t=e.stops;i=t.map((e=>e.value)),r=t.some((e=>!!e.label)),r&&(n=t.map((e=>e.label)))}const o=i[0],a=i[i.length-1];if(null==o&&null==a)return null;const u=r?null:ne(i,l),c=await Promise.all(i.map((async(l,i)=>{const o="opacity"===e.type?await async function(e,s,l=ie){const r=new t(l),i=(await import("../../../chunks/visualVariableUtils.js")).getOpacity(s,e);null!=i&&(r.a=i);return r}(l,e,s):(await import("../../../chunks/visualVariableUtils.js")).getColor(e,l);return{value:l,color:o,label:r?n[i]:u[i]}})));return c.reverse()}function ae(e,s){const{startIndex:l,endIndex:r,weight:i}=function(e,t){let s=0,l=t.length-1;return t.some(((t,r)=>e<t.value?(l=r,!0):(s=r,!1))),{startIndex:s,endIndex:l,weight:(e-t[s].value)/(t[l].value-t[s].value)}}(e,s);if(l===r)return s[l].color;const n=t.blendColors(s[l].color,s[r].color,i);return new t(n)}const ue={HH:315,HL:45,LL:135,LH:225},ce={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function me(e){if(!e)return;const{type:t}=e;if(t.indexOf("3d")>-1)return J(e.symbolLayers.getItemAt(0));if("simple-line"===t){const t=T(e);return t&&t.color}if("simple-marker"===e.type&&("x"===e.style||"cross"===e.style)){const t=T(e);return t&&t.color}return D(e)}function pe(e){let t=ue[e];return e&&null==t&&(t=ue.HH),t||0}const de=[255,255,255],ye=[200,200,200],he=[128,128,128];async function fe(e,t,s,l,i,n){var o,a;const u=t.legendOptions,c=u&&u.customValues,m=await async function(e,t){if("flow"===e.type)return re(e,t);let s=null,l=null;if("simple"===e.type)s=e.symbol;else if("class-breaks"===e.type){const t=e.classBreakInfos;s=t&&t[0]&&t[0].symbol,l=t.length>1}else if("unique-value"===e.type){const t=e.uniqueValueInfos;s=t&&t[0]&&t[0].symbol,l=t.length>1}if(!s||function(e){if(e){if(r(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return-1!==e.type.indexOf("fill")}return!1}(s))return null;s=s.clone(),(t||l)&&(s.type.indexOf("3d")>-1?be(s):ge(s));return s}(e,s),p=!!m,d=!!c,y=null!=t.minSize&&null!=t.maxSize,h=t.stops&&t.stops.length>1,f=!!t.target;if(!p||!d&&!(y||h&&!f))return;const b=O(m);let g=null,S=null,v=null;S=b&&!h?q([t.minDataValue,t.maxDataValue]):c||await async function(e,t,s,l){const r=(await import("../../../chunks/visualVariableUtils.js")).getSizeRangeAtScale(e,s,l),i=r&&Se(r);if(!r&&!i)return;let n=i.map((t=>function(e,t,s){const l=s.minSize,r=s.maxSize,i=t.minDataValue,n=t.maxDataValue;let o=null;if(e<=l)o=i;else if(e>=r)o=n;else{o=(e-l)/(r-l)*(n-i)+i}return o}(t,e,r)));n=q(n);for(let r=1;r<n.length-1;r++){const o=await ve(e,t,n[r],n[r-1],s,l);o&&(n[r]=o[0],i[r]=o[1])}return n}(t,m,l,i);const j=null==e?void 0:e.authoringInfo,w="univariate-color-size"===(null==j?void 0:j.type),L=w&&"above-and-below"===(null==j?void 0:j.univariateTheme);if(!S&&h&&(S=t.stops.map((e=>e.value)),g=t.stops.some((e=>!!e.label)),"flow"===e.type&&(S=q(S)),g&&(v=t.stops.map((e=>e.label)))),b&&(null==(o=S)?void 0:o.length)>2&&!L&&(S=[S[0],S[S.length-1]]),!S)return null;w&&5!==(null==(a=S)?void 0:a.length)&&(S=Se({minSize:S[0],maxSize:S[S.length-1]}));const _=b?function(e,t){const s=null==e?void 0:e.authoringInfo,l="univariate-color-size"===(null==s?void 0:s.type);let r=[12,30];if(l){const e=t[0],s=t[t.length-1],l=12,i=30;r=t.map((t=>l+(t-e)/(s-e)*(i-l)))}l&&"below"===(null==s?void 0:s.univariateTheme)&&r.reverse();return r}(e,S):null,I=P(m),A=g?null:function(e,t){const s=e.length-1;return e.map(((e,l)=>te(e,l,s,t)))}(S,n),C=await Promise.all(S.map((async(s,n)=>{const o=b?_[n]:await je(t,m,s,l,i),a=function(e,t){const s=e.clone();if(r(s))O(s)||s.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=t)}));else if("esri.symbols.SimpleMarkerSymbol"===s.declaredClass)s.size=t;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(s)){const e=s.width,l=s.height;s.height=t,s.width=t*(e/l)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(s)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(s)&&s.font&&(s.font.size=t):s.width=t;return s}(L&&"class-breaks"===e.type?function(e,t){const s=e.classBreakInfos,l=s.length,r=t>=2,i=l<2||!r?s[0].symbol.clone():s[l-1].symbol.clone();e.visualVariables.some((e=>"color"===e.type))&&(i.type.indexOf("3d")>-1?be(i):ge(i));return i}(e,n):m,o);return{value:s,symbol:a,label:g?v[n]:A[n],size:o,outlineSize:I}})));return C.reverse()}function be(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:he}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:ye}:(e.material={color:de},e.outline={color:he,size:1.5})}))}function ge(e){const s=K();if("cim"===e.type)R(e,new t(ye));else if(-1!==e.type.indexOf("line"))e.color=he;else if(e.color=s?he:de,"simple-marker"===e.type)if(e.outline){var l,r;"#ffffff"===(null==(l=e.outline)||null==(r=l.color)?void 0:r.toHex())&&(e.outline.color=he)}else e.outline={color:he,width:1.5}}function Se(e){const t=e.minSize,s=(e.maxSize-t)/4,l=[];for(let e=0;e<5;e++)l.push(t+s*e);return l}async function ve(e,t,s,l,r,i){const n=await je(e,t,s,r,i),o=await je(e,t,l,r,i),a=W(s),u=a.fractional;let c=a.integer,m=null,p=null;s>0&&s<1&&(m=10**u,c=W(s*=m).integer);for(let l=c-1;l>=0;l--){const a=10**l;let u=Math.floor(s/a)*a,c=Math.ceil(s/a)*a;null!=m&&(u/=m,c/=m);let d=(u+c)/2;[,d]=q([u,d,c],{indexes:[1]});const y=await je(e,t,u,r,i),h=await je(e,t,c,r,i),f=await je(e,t,d,r,i),b=Q(n,y,o,null),g=Q(n,h,o,null),S=Q(n,f,o,null);let v=b.previous<=20,j=g.previous<=20;if(v&&j&&(b.previous<=g.previous?(v=!0,j=!1):(j=!0,v=!1)),v?p=[u,y]:j?p=[c,h]:S.previous<=20&&(p=[d,f]),p)break}return p}async function je(e,t,s,l,r){const{getSize:i}=await import("../../../chunks/visualVariableUtils.js");return i(e,s,{scale:l,view:r,shape:"simple-marker"===t.type?t.style:null})}const we=c.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),Le=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,_e=new u({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Ie={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},Ae=new Y({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ce=new Z({style:"solid"});function Ee(e){return"flow"===e.type}function ke(e){return"vector-field"===e.type}function Ve(e){return"raster-colormap"===e.type}function Re(e){return"raster-stretch"===e.type}function Fe(e){return"raster-shaded-relief"===e.type}function Me(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function xe(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function ze(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function Ue(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function Te(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function De(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function Oe(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function Pe(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function Be(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function He(e){return"esri.layers.MapImageLayer"===e.declaredClass}function Ne(e){return"esri.layers.ImageryLayer"===e.declaredClass}function qe(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}const We=new Y({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Qe={},Ge=class extends i{constructor(e){super(e),this._handles=new a,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new o,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([b(this,"children","change",(t=>{const{added:s,removed:l}=t,r=this._handles;s.forEach((t=>{const s=`activeLayerInfo-ready-watcher-${t.layer.uid}`;r.add(g(t,"ready",e),s)})),l.forEach((e=>r.remove(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||(Qe={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Qe=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new L,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var e;const t=this.layer.opacity,s=null==(e=this.parent)?void 0:e.opacity,l=this.layer.parent,r=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=s?s*t:null!=r?r*t:t}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction&&"cluster"===e.featureReduction.type)return!0;if("renderer"in e&&e.renderer){if("dot-density"===e.renderer.type)return!0;const t=e.get("renderer.valueExpression");if(Le.test(t))return!0;const s=e.get("renderer.visualVariables");if(s)return s.some((e=>this._isScaleDrivenSizeVariable(e)))}return this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,(e=>{if("esri.layers.FeatureLayer"===e.declaredClass)return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet&&e.featureSet.features.length){const t=e.layerDefinition,s=t&&t.drawingInfo,l=s&&C(s.renderer),r=_e.read(t.geometryType);return l?this._getRendererLegendElements(l,{title:e.name,geometryType:r}):(we.warn("drawingInfo not available!"),null)}return null}));try{const e=[];await d(t).then((t=>{t.forEach((({value:t})=>t&&e.push(...t)))})),this.legendElements=e,this.notifyChange("ready")}catch(e){we.warn("error while building legend for layer!",e)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(e){we.warn("error while building legend for layer!",e)}}async buildLegendElementsForTools(){const e=this.layer;if(function(e){return"esri.layers.VoxelLayer"===e.declaredClass}(e))this._constructLegendElementsForVoxellayer();else if(function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e))this._constructLegendElementsForWMTSlayer();else if(function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e))await this._constructLegendElementsForWMSSublayers();else if(Be(e))await this._constructLegendElementsForBuildingSceneLayer();else if(He(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)||Be(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let l="default";if(Ne(e)){var t,s;const r=e;l=((null==r||null==(t=r.renderingRule)?void 0:t.functionName)||"default")+"_"+(null!=(s=e.bandIds)&&s.length?e.bandIds.join(""):"###")}await this._getLegendLayers(`${e.uid}-${l}`).then((async t=>{this.legendElements=[],this.notifyChange("ready");const s=t.map((async t=>{if(Ne(e)||qe(e)){const t=e.watch(["renderingRule","bandIds"],(()=>y((async()=>{Qe.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()}))()));this._handles.add(t,"imageryLayers-watcher")}const s=this._generateSymbolTableElementForLegendLayer(t);s&&s.infos.length&&(Ne(e)&&(s.title=e.title),this.legendElements.push(s)),this.notifyChange("ready")}));await d(s)})).catch((e=>{we.warn("Request to server for legend has failed!",e)}))}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!s&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await S(t,"updating");const l=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();l.geometry=this.view.extent;return 0!==(s?"queryFeatureCount"in t&&await t.queryFeatureCount(l):"queryFeatureCount"in e&&await e.queryFeatureCount(l))}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some((e=>e.ready))}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,s=t.minSize,l=t.maxSize;return"object"==typeof s&&s?this._isScaleDrivenSizeVariable(s):"object"==typeof l&&l?this._isScaleDrivenSizeVariable(l):!!t.expression||Le.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&He(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0;return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add(v(e,"style",(()=>this._constructLegendElementsForVoxellayer())),"voxel-style-watcher");const t=m(e.getVariableStyle(null)),s=[];var l;if(t)if(null!=(l=t.uniqueValues)&&l.length){const e=[];t.uniqueValues.forEach((t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new Z({color:t.color,outline:null})})})),e.length&&s.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:l}=t.transferFunction,r=e.toArray().reverse(),i=l.map(((e,t)=>`${0===t?"<":">"} ${X(e)}`)).reverse(),n=r.map((e=>({color:e.color,value:null,label:null})));n[0].label=i[0],n[n.length-1].label=i[1],s.push({type:"color-ramp",title:t.label,infos:n,preview:F(r.map((e=>e.color)))})}const r=e.opacity,i=s.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!(null==e||!e.symbol))).map((e=>this._getSymbolPreview(e,r)));await d(i),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(v(this.layer,"activeLayer",(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((s=>e.styleId===s.id&&(t=s.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add(v(this.layer,"sublayers",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const l=e.toArray();for(const e of l){const l=e.watch(["title","visible","legendEnabled"],(()=>this._constructLegendElementsForWMSSublayers()));if(this._handles.add(l,"wms-sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled){const l=await this._generateSymbolTableElementForWMSSublayer(e,t);l&&l.infos.length&&s.unshift(l)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var s;let r=e.legendUrl;if(!r)return;const i={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(r=f(r,t));let n=null;const o=null==(s=e.layer)?void 0:s.opacity;try{n=(await l(r,{responseType:"image"})).data,n&&(n.style.opacity=o)}catch{}return i.infos.push({src:r,preview:n,opacity:o}),i}_getLegendLayers(e,t){const s=Qe&&Qe[e];return s?Promise.resolve(s):this._legendRequest(t).then((t=>{const s=t.layers;return Qe[e]=s,s}))}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(Ne(t)){const e=t.exportImageServiceParameters.renderingRule;if(e&&(s.renderingRule=JSON.stringify(e.rasterFunctionDefinition||e.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:l,customParameters:r}=t;s={raster:e,viewId:l,...s,...r}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const e=r.indexOf("?");e>-1?r=r.substring(0,e)+"/legend"+r.substring(e):r+="/legend"}else{const e=r.toLowerCase().indexOf("/rest/"),t=r.substring(0,e)+r.substring(e+5,r.length);r="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(t)+"&returnbytes=true"}return l(r,{query:s}).then((e=>e.data))}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(v(e,"sublayers",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){we.warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const l=e.toArray();for(const e of l){const l=e.watch(["renderer","opacity","title","visible"],(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this._handles.add(l,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){const l=e&&null!=e.opacity?e.opacity:null,r=null!=l?l*t:t;if("building-group"===e.type){const t={type:"symbol-table",title:e.title,infos:[]},l=await this._generateLegendElementsForBuildingSublayers(e.sublayers,r);t.infos.push(...l),s=[t,...s]}else if(e.renderer){s=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:r,sublayer:e}),...s]}}}return s.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(v(e,"sublayers",(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){we.warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForSublayers(e,t,s){const l=this.layer;let r=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let i=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(i=this.sublayerIds.map((e=>l.findSublayerById(e))).filter(Boolean));for(const e of i){const l=e.watch("renderer, opacity, title, visible, legendEnabled",(()=>this._constructLegendElementsForSublayers()));if(this._handles.add(l,"sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled&&this._isSublayerInScale(e)){const l=e&&null!=e.opacity?e.opacity:null,i=null!=l?l*t:t;if(e.renderer&&!e.sublayers&&e.originIdOf("renderer")>n.SERVICE){await e.load();r=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:i,sublayer:e}),...r]}else{const t=await this._generateSymbolTableElementForSublayer(e,i,s);t&&r.unshift(t)}}}return r.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const t=this.layer,l=e.source;let r=null;if(!(!l||"map-layer"===l.type&&l.mapLayerId===e.id&&(!l.gdbVersion||l.gdbVersion===("gdbVersion"in t&&t.gdbVersion)))||e.originIdOf("renderer")>n.SERVICE||e.originIdOf("labelingInfo")>n.SERVICE||e.originIdOf("labelsVisible")>n.SERVICE){const e=new I({layer:this.layer});r=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const i=r||`${t.uid}-default`;(await this._getLegendLayers(i,r)).forEach((e=>s.set(e.layerId,e)))}const l=s.get(e.id);if((!l||null!=l&&l.subLayerIds&&l.defaultVisibility)&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(l,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){var l;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=null==t?void 0:t.renderer;let i=(null==t?void 0:t.title)||e.layerName;if(r&&(!t||(null==t?void 0:t.originIdOf("renderer"))>n.SERVICE)){const e=(null==t?void 0:t.title)||this._getRendererTitle(r,t);e&&(i&&"string"!=typeof e&&"title"in e&&(e.title=i),i=e)}const o={type:"symbol-table",title:i,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return(null==(l=e.legendGroups)?void 0:l.length)>0?e.legendGroups.forEach((t=>{var l;const r={type:"symbol-table",title:t.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter((e=>e.groupId===t.id)),e.layerId,s)};(null==(l=r.infos)?void 0:l.length)>0&&o.infos.push(r)})):o.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,s),o.infos.length>0?o:null}_generateSymbolTableElementInfosForLegendLayer(e,t,l){return e.map((e=>{let r=e.url;if(e.imageData&&e.imageData.length>0)r=`data:image/png;base64,${e.imageData}`;else{if(0===r.indexOf("http"))return null;r=s(`${this.layer.url}/${t}/images/${r}`)}return{label:e.label,src:r,opacity:null==l?this.opacity:l,width:e.width,height:e.height}})).filter((e=>!!e))}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let l=null,r=null,i=!0;return!s.minScale&&0!==s.minScale||!s.maxScale&&0!==s.maxScale?(0===e.minScale&&s.tileInfo&&(l=s.tileInfo.lods[0].scale),0===e.maxScale&&s.tileInfo&&(r=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(l=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,r=Math.max(s.maxScale,e.maxScale)),(l>0&&l<this.scale||r>this.scale)&&(i=!1),i}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;const s=t.renderer,l=e.some((e=>e.values));let r=null,i=null;return l&&e.some(((e,t)=>(e.values||(r=t,i=e,i.label||(i.label="others")),null!=i))),s?"unique-value"===s.type?i&&(e.splice(r,1),e.push(i)):"class-breaks"===s.type&&(i&&e.splice(r,1),e.reverse(),i&&e.push(i)):i&&(e.splice(r,1),e.push(i)),e}async _getRendererLegendElements(e,t={}){return function(e,t){return Me(e)||xe(e)||ze(e)||Ue(e)||Pe(e)?"2d"===t.type||E(e):Re(e)||Ve(e)||Fe(e)||Te(e)||De(e)||Oe(e)||ke(e)||Ee(e)}(e,this.view)?function(e){return Te(e)||De(e)||Oe(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e)?this._constructPointCloudRendererLegendElements(e,t):Pe(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(we.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,l=[];let r=null,i=null;if(Te(e))r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{r.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(Ae,e.color)})}));else if(De(e)){const t=e.stops;let l=null;if(t.length&&(1===t.length&&(l=t[0].color),!l)){const e=t[0].value,s=t[t.length-1].value;if(null!=e&&null!=s){l=ae(e+(s-e)/2,t)}}r={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(Ae,l||Ae.color)}]};const n=function(e){let t=!1,s=[],l=[];s=e.map((e=>e.value)),t=e.some((e=>!!e.label)),t&&(l=e.map((e=>e.label)));const r=s[0],i=s[s.length-1];if(null==r&&null==i)return null;const n=t?null:ne(s,!1);return s.map(((s,r)=>({value:s,color:ae(s,e),label:t?l[r]:n[r]}))).reverse()}(e.stops);i={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:n,preview:F(n.map((e=>e.color)))}}else Oe(e)&&(r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((e=>{r.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(Ae,e.color)})})));r&&r.infos.length&&l.push(r),i&&i.infos.length&&l.push(i);const n=l.reduce(((e,t)=>e.concat(t.infos)),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return d(n).then((()=>l))}_getElementInfoForDotDensity(e,t){const{backgroundColor:s,outline:l,dotSize:r}=e,i=this.effectList,n=null==i?void 0:i.effects.map((e=>e.toJSON())),o=_(n),a=r+"-"+t+"-"+s+"-"+(l&&JSON.stringify(l.toJSON()))+"-"+o,u=this._dotDensityUrlCache,c=u.has(a)?u.get(a):M(e,t);u.set(a,c);const m={shape:{type:"image",x:0,y:0,width:c.width,height:c.height,src:c.src},fill:null,stroke:null,offset:[0,0]},p=U([[m]],[c.width,c.height],{effectView:this.effectList});return{opacity:1,src:c.src,preview:p,width:c.width,height:c.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach((t=>{const s=this._getElementInfoForDotDensity(e,t.color);s.label=t.label||t.valueExpressionTitle||t.field,l.infos.push(s)})),Promise.resolve([l])}async _constructRendererLegendElements(e,t={}){const{title:s,sublayer:l}=t,r=l||this.layer;let i=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const n=await this._getVisualVariableLegendElements(i,r)||[],o={type:"symbol-table",title:s||this._getRendererTitle(i,r),infos:[]};let a=null,u=!1;const c=new Set;if(Ee(i)&&!this._hasSizeRamp){const e=await re(i);o.infos.push({label:null,symbol:e})}else if(function(e){const t="authoringInfo"in e&&(null==e?void 0:e.authoringInfo);return"univariate-color-size"===(null==t?void 0:t.type)}(i)){let e=s;const t=function(e){const t="authoringInfo"in e&&(null==e?void 0:e.authoringInfo);return"univariate-color-size"===(null==t?void 0:t.type)&&"above-and-below"===(null==t?void 0:t.univariateTheme)}(i)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",l=n.findIndex((e=>"color-ramp"===e.type)),r=-1!==l?n.splice(l,1)[0]:null,o=n.findIndex((e=>"size-ramp"===e.type)),a=-1!==o?n.splice(o,1)[0]:null,u=[];r&&(e=r.title,u.push(r)),a&&(e=a.title,u.push(a)),u.length>0&&n.push({type:t,title:e,infos:u})}else if(Ue(i)){const e=function(e){let t=e.colorStops,s=t.length-1;if(t&&t[0]){const e=t[s];e&&1!==e.ratio&&(t=t.slice(0),t.push(new $({ratio:1,color:e.color})),s++)}return t.map(((e,t)=>{let l="";return 0===t?l="low":t===s&&(l="high"),{color:e.color,label:l,ratio:e.ratio}})).reverse()}(i);n.push({type:"heatmap-ramp",title:s,infos:e,preview:F(e.map((e=>e.color)),{effectList:this.effectList})})}else if(ze(i)){const e=i&&i.authoringInfo;if(e&&"relationship"===e.type){const{focus:t,numClasses:s,field1:l,field2:a}=e;if(s&&l&&a){const e=[l,a];let u=pe(t)||0;for(const t of e){const{field:e,normalizationField:s,label:l}=t,i=l||{field:this._getFieldAlias(e,r),normField:s&&this._getFieldAlias(s,r)},n=We.clone();n.angle=u,o.infos.push({label:i,symbol:n}),c.add(n),u+=90}const m=function(e){const{focus:t,infos:s,numClasses:l}=e,r=ce[l],i={};s.forEach((e=>{i[e.value]={label:e.label,fill:me(e.symbol)}}));const n=[];for(let e=0;e<l;e++){const t=[];for(let s=0;s<l;s++){const l=i[r[e][s]];t.push(l.fill)}n.push(t)}const o=function(e,t){const s=t.HH.label,l=t.LL.label,r=t.HL.label,i=t.LH.label;switch(e){case"HH":default:return{top:s,bottom:l,left:r,right:i};case"HL":return{top:r,bottom:i,left:l,right:s};case"LL":return{top:l,bottom:s,left:i,right:r};case"LH":return{top:i,bottom:r,left:s,right:l}}}(t,i);return{type:"relationship-ramp",numClasses:l,focus:t,colors:n,labels:o,rotation:pe(t)}}({focus:t,numClasses:s,infos:i.uniqueValueInfos});n.unshift(m)}}else{const e=i.field;i.uniqueValueInfos.forEach((t=>{t.symbol&&o.infos.push({label:t.label||this._getDomainName(e,t.value,r)||t.value,value:t.value,symbol:t.symbol})}))}i.defaultSymbol&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),u=!0)}else if(xe(i)){a=this._isUnclassedRenderer(i);(!a||!this._hasSizeRamp)&&(i.classBreakInfos.forEach((e=>{e.symbol&&o.infos.unshift({label:e.label||(a?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),a&&(o.title=null),this._updateInfosforClassedSizeRenderer(i,o.infos)),i.defaultSymbol&&!a&&(o.infos.push({label:i.defaultLabel||"others",symbol:i.defaultSymbol}),u=!0)}else if(Re(i))if(qe(this.layer)||function(e){return"esri.layers.WCSLayer"===e.declaredClass}(this.layer)){const e=this._constructTileImageryStretchRendererElements(i);"stretch-ramp"===e.type?n.push(e):o.infos=e}else{const e=this.layer;let t,s;i.statistics&&i.statistics.length&&(t=null!=i.statistics[0].min?i.statistics[0].min:i.statistics[0][0],s=null!=i.statistics[0].max?i.statistics[0].max:i.statistics[0][1]);let l=[];const r=m(e.renderingRule?await e.generateRasterInfo(e.renderingRule):e.serviceRasterInfo),a=r.keyProperties.BandProperties,u=Ie[e.rasterInfo.pixelType.toLowerCase()];1===r.bandCount||e.bandIds&&1===e.bandIds.length?(t=null!=t?t:r.statistics?r.statistics[e.bandIds[0]].min:u[0],s=null!=s?s:r.statistics?r.statistics[e.bandIds[0]].max:u[1],t||s?n.push(this._getStretchLegendElements(i,{min:t,max:s})):this._getServerSideLegend()):r.bandCount>=3?a&&a.length>=r.bandCount?e.bandIds&&3===e.bandIds.length?(l=e.bandIds.map((e=>a[e].BandName)),o.infos=this._createSymbolTableElementMultiBand(l)):"lerc"===e.format?(l=[0,1,2].map((e=>a[e].BandName)),o.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():"lerc"===e.format?(l=["band1","band2","band3"],o.infos=this._createSymbolTableElementMultiBand(l)):this._getServerSideLegend():this._getServerSideLegend()}else if(Ve(i))i.colormapInfos.forEach((e=>{o.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(Ce,e.color)})}));else if(Me(i)){let e=i.symbol;switch(t.geometryType){case"point":e="pointSymbol"in r&&r.pointSymbol;break;case"polyline":e="lineSymbol"in r&&r.lineSymbol;break;case"polygon":e="polygonSymbol"in r&&r.polygonSymbol}i.symbol&&!this._hasSizeRamp&&o.infos.push({label:i.label,symbol:e})}else if(ke(i)){i.outputUnit&&(this.title="("+i.toJSON().outputUnit+")"),o.title=i.attributeField;const e=i.getClassBreakInfos();null!=e&&e.length?e.forEach((e=>{o.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):o.infos.push({label:i.attributeField,symbol:i.getDefaultSymbol()})}else Fe(i)&&n.push(this._getStretchLegendElements(i,{min:0,max:255}));const p=i.defaultSymbol;!p||u||Me(i)||a&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:i.defaultLabel||"others",symbol:p}]}),o.infos.length&&n.unshift(o);const y=null==t.opacity?this.opacity:t.opacity,h=this._isTallSymbol("visualVariables"in i&&i.visualVariables),f=Ne(this.layer)||qe(this.layer),b=n.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!(null==e||!e.symbol))).map((e=>this._getSymbolPreview(e,y,{isDefault:e.symbol===p,applyScaleDrivenSize:!c.has(e.symbol),symbolConfig:{isTall:h,isSquareFill:f},effectList:c.has(e.symbol)?null:this.effectList})));return i=null,await d(b),n}_getServerSideLegend(){setTimeout((()=>this.buildLegendElementsForTools()),0)}_getAllInfos(e){const t=null==e?void 0:e.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]}_constructTileImageryStretchRendererElements(e){var t,s;const l=this.layer,r=l.rasterInfo,i=r.bandCount||e.statistics.length;let n,o,a=[];const u=r.keyProperties&&r.keyProperties.BandProperties,c=null!=e&&null!=(t=e.statistics)&&t.length?e.statistics:null==r?void 0:r.statistics;if(c)n=void 0!==c[0].min?c[0].min:c[0][0],o=c[0].max||c[0][1];else{const e=Ie[l.rasterInfo.pixelType.toLowerCase()];n=e[0],o=e[1]}if(l.hasStandardTime()&&(n=l.getStandardTimeValue(n),o=l.getStandardTimeValue(o)),1===r.bandCount||1===(null==(s=l.bandIds)?void 0:s.length))return this._getStretchLegendElements(e,{min:n,max:o});function m(e){var t;const s=(null!=l&&null!=(t=l.bandIds)&&t.length?l.bandIds:Array.from(Array(Math.min(r.bandCount,3)).keys())).map((t=>e&&e[t]&&e[t].BandName||"band"+(t+1)));return s.length<3?s.push(s[1]):s.length>3&&s.splice(3),s}return a=u&&u.length>=i?m(u):m(),this._createSymbolTableElementMultiBand(a)}_getStretchLegendElements(e,s){const l=function(e,s){let l=[];if(e&&"multipart"===e.type)e.colorRamps.reverse().forEach((function(r,i){0===i?l.push({value:s.max,color:new t(r.toColor),label:"high"}):l.push({value:null,color:new t(r.toColor),label:""}),i===e.colorRamps.length-1?l.push({value:s.min,color:new t(r.fromColor),label:"low"}):l.push({value:null,color:new t(r.fromColor),label:""})}));else{let r,i;e&&"algorithmic"===e.type?(r=e.fromColor,i=e.toColor):(r=[0,0,0,1],i=[255,255,255,1]),l=[{value:s.max,color:new t(i),label:"high"},{value:s.min,color:new t(r),label:"low"}]}return l}(e.colorRamp,s);return{type:"stretch-ramp",title:"",infos:l,preview:F(l.map((e=>e.color)))}}async _getSizeLegendElement(e,t,s,l){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await fe(s,t,await le(s),this.scale,this.view.type,l)}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach(((e,l)=>{t.push({label:{colorName:s[l],bandName:e},src:se[l],opacity:1})})),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,l=e.classBreakInfos.some((e=>O(e.symbol)));if(s&&l){const s=30,l=12,r=e.classBreakInfos.length,i=(s-l)/(r>1?r-1:r);t.forEach(((e,t)=>{e.size=s-i*t}))}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let l=0;l<e.length&&(!t||!s);l++){const r=e[l];"size"===r.type&&("height"===r.axis&&(t=!0),"width-and-depth"===r.axis&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let l=null!=s&&s.isDefault||null!=e.size||!this._hasSizeRamp?e.size:h(x.size);if(this._scaleDrivenSizeVariable&&null!=s&&s.applyScaleDrivenSize){const{getSize:t}=await import("../../../chunks/visualVariableUtils.js");l=t(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===e.symbol.type?e.symbol.style:null})}return z(e.symbol,{size:l,opacity:t,scale:!1,symbolConfig:null==s?void 0:s.symbolConfig,effectView:null==s?void 0:s.effectList}).then((t=>(e.preview=t,e))).catch((()=>(e.preview=null,e)))}async _loadRenderer(e){var t,s;const l=[],r=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const i="visualVariables"in e&&(null==(t=e.visualVariables)?void 0:t.some((e=>"size"===e.type&&"outline"!==e.target&&!Le.test(e.valueExpression))));if(e&&"visualVariables"in e&&!i&&"featureReduction"in r&&"cluster"===(null==(s=r.featureReduction)?void 0:s.type)){const t=this.layerView._effectiveRenderer,s=m(function(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const s=e.visualVariables.find((e=>"size"===e.type)),l=((e,t)=>{const s=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return null!=t&&t.levels?t.levels[s]:null})(t,s);return l?new k({field:s.field,minSize:l[2].size,minDataValue:l[2].value,maxSize:l[3].size,maxDataValue:l[3].value}):null}(t,this.view));if(s){const t=r.featureReduction;if("clusterMinSize"in t&&"clusterMaxSize"in t){const{clusterMinSize:e,clusterMaxSize:l}=t;s.legendOptions=new V({showLegend:e!==l})}const l=e.visualVariables||[];e.visualVariables=l.concat([s]),this._hasClusterSizeVariable=!0}}const n=await le(e);if(xe(e)||ze(e)){const t=(e.classBreakInfos||e.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,n).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(l,t)}return l.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:n).then((t=>{this._applySymbolToRenderer(e,t,Me(e))})).catch((()=>{this._applySymbolToRenderer(e,null,Me(e))}))),d(l).then((()=>e))}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}_fetchSymbol(e,t){if(!e)return Promise.reject();if("web-style"===e.type){const s=e.portal,l=s&&s.url,r=s&&s.user&&s.user.username,i=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+l+"-"+r,n=this._webStyleSymbolCache;return n.has(i)||("2d"===this.view.type?n.set(i,e.fetchCIMSymbol()):n.set(i,e.fetchSymbol())),n.get(i).then((e=>this._getAppliedCloneSymbol(e,t))).catch((()=>(we.warn("Fetching web-style failed!"),Promise.reject())))}return Promise.resolve(this._getAppliedCloneSymbol(e,t))}_getAppliedCloneSymbol(e,s){if(!e||!s)return e;const l=e.clone(),r=s&&s.toRgba();return l.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(l,r):"cim"===l.type?R(l,s):l.color&&(l.color=new t(r||l.color)),l}_applyColorTo3dSymbol(e,s){s&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new t(s))}))}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const s=e.visualVariables,l=[],r=[],i=[];for(const e of s)"color"===e.type?l.push(e):"size"===e.type?r.push(e):"opacity"===e.type&&i.push(e);const n=[...l,...r,...i];let o,a;if(0===l.length&&xe(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];o=t&&t.symbol}if(0===l.length&&Me(e)&&(o=e.symbol),o)if(o.type.indexOf("3d")>-1){const e=o.symbolLayers.getItemAt(0);"water"===e.type?p(e.color)&&(a=e.color):p(e.material)&&p(e.material.color)&&(a=e.material.color)}else o.url||(a=o.color);const u=this.effectList;return(await Promise.all(n.map((async s=>{if(!s.legendOptions||!1!==s.legendOptions.showLegend){const l=Ee(e)?s.field:this._getRampTitle(s,t);let r=null;const i="getField"in t&&t.getField&&t.getField(s.field),n=i&&A(i);if("color"===s.type){const e=await oe(s,null,n);r={type:"color-ramp",title:l,infos:e,preview:F(e.map((e=>e.color)),{effectList:u})},this._hasColorRamp||(this._hasColorRamp=!(null==r.infos||!r.infos.length))}else if("size"===s.type&&"outline"!==s.target)Le.test(s.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=s):(r=await this._getSizeLegendElement(l,s,e,n),this._hasSizeRamp||(this._hasSizeRamp=!(null==r.infos||!r.infos.length)));else if("opacity"===s.type){const e=await oe(s,a,n);r={type:"opacity-ramp",title:l,infos:e,preview:F(e.map((e=>e.color)),{effectList:u})},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==r.infos||!r.infos.length))}return r&&r.infos?r:null}})))).filter((e=>!!e))}_getDomainName(e,t,s){if(e&&"function"!=typeof e){const l="getField"in s&&s.getField&&s.getField(e),r=l&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(l.name):null;return r&&"coded-value"===r.type?r.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,l="popupTemplate"in e&&e.popupTemplate,r=l&&l.fieldInfos;if(r)for(const e of r)if(e.fieldName===s)return"cluster_count"===s?e.label||{showCount:!0}:e.label}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,l=e.normalizationField,r=!1,i=!1,n=!1,o=null;s="function"==typeof s?null:s,l="function"==typeof l?null:l;const a=e.legendOptions&&e.legendOptions.title;if(null!=a)o=a;else if(e.valueExpressionTitle)o=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const s=e[t];if("color"===s.type){if("ratio"===s.style){r=!0;break}if("percent"===s.style){i=!0;break}if("percent-of-total"===s.style){n=!0;break}}}}o={field:s&&this._getFieldAlias(s,t),normField:l&&this._getFieldAlias(l,t),ratio:r,ratioPercent:i,ratioPercentTotal:n}}return o}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let l=s.field,r=null,i=null;xe(s)&&(r=s.normalizationField,i="percent-of-total"===s.normalizationType),l="function"==typeof l?null:l,r="function"==typeof r?null:r;let n=null;return(l||r)&&(n={field:l&&this._getFieldAlias(l,t),normField:r&&this._getFieldAlias(r,t),normByPct:i}),n}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,l=s&&s.fieldInfos;let r=null;l&&l.some((t=>e===t.fieldName&&(r=t,!0)));let i=null;"getField"in t&&t.getField?i=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(i=t.fieldsIndex.get(e));const n=r||i;let o=null;return n&&(o=r&&r.label||i&&i.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName),o}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return xe(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(s=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),s}};e([j()],Ge.prototype,"children",void 0),e([j({readOnly:!0})],Ge.prototype,"effectList",null),e([j()],Ge.prototype,"layerView",void 0),e([j()],Ge.prototype,"layer",void 0),e([j()],Ge.prototype,"legendElements",void 0),e([j({readOnly:!0})],Ge.prototype,"opacity",null),e([j()],Ge.prototype,"parent",void 0),e([j({readOnly:!0,dependsOn:[]})],Ge.prototype,"ready",null),e([j()],Ge.prototype,"hideLayersNotInCurrentView",void 0),e([j()],Ge.prototype,"keepCacheOnDestroy",void 0),e([j()],Ge.prototype,"respectLayerVisibility",void 0),e([j({readOnly:!0})],Ge.prototype,"scale",null),e([j()],Ge.prototype,"sublayerIds",void 0),e([j({readOnly:!0})],Ge.prototype,"isScaleDriven",null),e([j()],Ge.prototype,"title",void 0),e([j({readOnly:!0,dependsOn:["ready"],value:0})],Ge.prototype,"version",null),e([j()],Ge.prototype,"view",void 0),Ge=e([w("esri.widgets.Legend.support.ActiveLayerInfo")],Ge);const $e=Ge;export{$e as default};
