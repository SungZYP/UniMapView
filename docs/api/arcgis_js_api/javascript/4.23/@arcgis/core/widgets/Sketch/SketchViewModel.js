/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{symbolTypes as t}from"../../symbols.js";import o from"../../core/Collection.js";import{b as i,i as s,u as r,x as n,I as a,o as p,j as l}from"../../core/lang.js";import c from"../../core/Error.js";import{E as h}from"../../chunks/Evented.js";import d from"../../core/Handles.js";import{L as u}from"../../chunks/Logger.js";import{eachAlwaysValues as m,throwIfAborted as y,isAborted as g,createAbortError as v,whenOrAbort as f}from"../../core/promiseUtils.js";import{sync as _,watch as j,syncAndInitial as E,on as w,when as S,whenOnce as b}from"../../core/reactiveUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import{s as k}from"../../chunks/ensureType.js";import{subclass as G}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as O,isLoaded as P,load as x,project as C}from"../../geometry/projection.js";import{g as I}from"../../chunks/projectionEllipsoid.js";import{d as R}from"../../geometry/Polygon.js";import M,{e as A}from"../../geometry/SpatialReference.js";import H from"../../layers/GraphicsLayer.js";import{i as U}from"../../chunks/DOMContainer.js";import{c as D,h as V}from"../../chunks/elevationInfoUtils.js";import L from"../../geometry/Circle.js";import{V as F}from"../../chunks/InputManager.js";import{S as N}from"../../chunks/keybindings.js";import{HandleOwner as q}from"../../core/HandleOwner.js";import{f as Y,h as z,c as W,s as Z,m as B,u as K,q as Q,o as X,b as J}from"../../chunks/vec2.js";import{init as $}from"../../core/watchUtils.js";import{b as ee}from"../../chunks/mathUtils.js";import{S as te}from"../../chunks/QueryEngineResult.js";import{a as oe,f as ie}from"../../chunks/vec2f64.js";import{d as se}from"../../chunks/Settings2.js";import{o as re,L as ne,a as ae,R as pe,s as le,b as ce,c as he,d as de,P as ue,I as me}from"../../chunks/RightAngleSnappingHint.js";import{p as ye,a as ge,b as ve,L as fe,i as _e,c as je,d as Ee,e as we,f as Se}from"../../chunks/geometry2dUtils.js";import be from"../../core/Accessor.js";import Te from"../../views/interactive/snapping/SnappingOptions.js";import{c as ke}from"../../chunks/screenUtils2.js";import{n as Ge}from"../../chunks/compilerUtils.js";import Oe from"../../symbols/SimpleMarkerSymbol.js";import Pe from"../../symbols/SimpleFillSymbol.js";import xe from"../../symbols/SimpleLineSymbol.js";import"../../symbols/CIMSymbol.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/deprecate.js";import"../../config.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polyline.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils3.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils4.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/shared.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/unitUtils.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GraphicsCollection.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../layers/Layer.js";import"../../chunks/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4f32.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/domUtils.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../Popup.js";import"../../intl.js";import"../../chunks/messages.js";import"../../chunks/throttle.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../Feature.js";import"../Widget.js";import"../../chunks/uuid.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/widgetThemeUtils.js";import"../Attachments.js";import"../../chunks/unitFormatUtils.js";import"../../chunks/byteSizeEstimations.js";import"../Attachments/AttachmentsViewModel.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/messageBundle.js";import"../../chunks/jsxFactory.js";import"../Feature/FeatureViewModel.js";import"../../chunks/languageUtils.js";import"../../chunks/datetime.js";import"../../chunks/number3.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../rest/support/Query.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/DataLayerSource.js";import"../../rest/support/StatisticDefinition.js";import"../../rest/support/RelationshipQuery.js";import"../../tasks/QueryTask.js";import"../../chunks/executeForTopCount.js";import"../../chunks/utils5.js";import"../../chunks/scaleUtils.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/featureConversionUtils.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../chunks/executeQueryJSON.js";import"../../tasks/Task.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/symbolConversion.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryLoader.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/FeatureIndex.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../chunks/OperationalLayer.js";import"../../chunks/commonProperties.js";import"../../support/timeUtils.js";import"../../chunks/OrderedLayer.js";import"../../chunks/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/Heading.js";import"../support/widget.js";import"../../chunks/accessibleHandler.js";import"../../chunks/vmEvent.js";import"../Spinner/SpinnerViewModel.js";import"../../chunks/AnchorElementViewModel.js";import"../Popup/PopupViewModel.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/ItemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils7.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../../chunks/Queue.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/quantizationUtils.js";import"../../core/sql/WhereClause.js";import"../../chunks/utils11.js";import"../../chunks/generateRendererUtils.js";import"../../chunks/projectionSupport.js";import"../../chunks/json.js";import"../../chunks/utils17.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";function Ce(e){switch(e){case Ie.SUPPORTED:break;case Ie.GRAPHICS_LAYER_MISSING:return"not owned by a graphics layer";case Ie.GEOMETRY_MISSING:return"no geometry";case Ie.GEOMETRY_TYPE_UNSUPPORTED:return"the geometry type is not supported";case Ie.ELEVATION_MODE_UNSUPPORTED:return"the elevation mode is not supported";case Ie.SYMBOL_TYPE_UNSUPPORTED:return"the symbol type is not supported"}return""}var Ie,Re;function Me(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return Ie.GRAPHICS_LAYER_MISSING;if(i(e.geometry))return Ie.GEOMETRY_MISSING;switch(e.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;default:return Ie.GEOMETRY_TYPE_UNSUPPORTED}return"on-the-ground"!==D(e)&&V(e)?Ie.ELEVATION_MODE_UNSUPPORTED:Ie.SUPPORTED}function Ae(e){return Ue(e).result}function He(e){return Ue(e).geometry}function Ue(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return{result:Ie.GRAPHICS_LAYER_MISSING,geometry:null};if(i(e.geometry))return{result:Ie.GEOMETRY_MISSING,geometry:null};return"on-the-ground"!==D(e)&&V(e)?{result:Ie.ELEVATION_MODE_UNSUPPORTED,geometry:null}:"point"!==e.geometry.type&&"polyline"!==e.geometry.type&&("polygon"!==e.geometry.type||e.geometry instanceof L)?{result:Ie.GEOMETRY_TYPE_UNSUPPORTED,geometry:null}:{result:Ie.SUPPORTED,geometry:e.geometry}}function De(e,t,o){if(!t||!e||!e.map)return;const{map:i}=e,s=i.layers.find((e=>e===t));s||i.add(t,o),null!=o&&i.layers.reorder(s,o)}function Ve(e,t){return e.allLayerViews.find((e=>{const o=e.layer;return"sublayers"in o&&s(o.sublayers)&&!!o.sublayers.find((e=>e===t))||o===t}))}!function(e){e[e.SUPPORTED=0]="SUPPORTED",e[e.GRAPHICS_LAYER_MISSING=1]="GRAPHICS_LAYER_MISSING",e[e.GEOMETRY_MISSING=2]="GEOMETRY_MISSING",e[e.GEOMETRY_TYPE_UNSUPPORTED=3]="GEOMETRY_TYPE_UNSUPPORTED",e[e.ELEVATION_MODE_UNSUPPORTED=4]="ELEVATION_MODE_UNSUPPORTED",e[e.SYMBOL_TYPE_UNSUPPORTED=5]="SYMBOL_TYPE_UNSUPPORTED"}(Ie||(Ie={}));class Le{constructor(e){this.coordinateHelper=e}}class Fe extends Le{constructor(e,t){super(e),this.point=t}objectEqual(e){return e instanceof Fe&&re(this.point,e.point)}check(e){return Z(e,this.point)<se.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const t=[];return e instanceof Ne?t.push(...ve({start:e.start,end:e.end,type:e instanceof Ye?fe.LINE:fe.RAY},this.point)):e instanceof We&&t.push(...Se(e.center,e.radius,this.point)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class Ne extends Le{constructor(e,t,o){super(e),this.start=t,this.end=o}objectEqual(e){return e instanceof Ne&&(re(this.start,e.start)&&re(this.end,e.end))}intersect(e){const t=[];return e instanceof Fe?t.push(...ve({start:this.start,end:this.end,type:this instanceof Ye?fe.LINE:fe.RAY},e.point)):e instanceof Ne?t.push(..._e({start:this.start,end:this.end,type:this instanceof Ye?fe.LINE:fe.RAY},{start:e.start,end:e.end,type:e instanceof Ye?fe.LINE:fe.RAY})):e instanceof We&&t.push(...je({start:this.start,end:this.end,type:this instanceof Ye?fe.LINE:fe.RAY},e.center,e.radius)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class qe extends Ne{constructor(e,t,o){super(e,t,o),this.dir=oe(),this.p=oe()}objectEqual(e){return e instanceof qe&&super.objectEqual(e)}check(e){return Y(this.dir,this.end,this.start),Y(this.p,e,this.start),z(this.dir,this.p)>=0&&ye(e,this.start,this.end)<se.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return ge(t,e,this.start,this.end),t}}class Ye extends Ne{constructor(e,t,o){super(e,t,o)}objectEqual(e){return e instanceof Ye&&super.objectEqual(e)}check(e){return ye(e,this.start,this.end)<se.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Ee(t,e,this.start,this.end),t}}class ze extends Le{constructor(e,t,o,i){super(e),this.intersection=t,this.first=o,this.second=i}objectEqual(e){return e instanceof ze&&(this.first.objectEqual(e.first)&&this.second.objectEqual(e.second))}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return W(t,this.intersection),t}intersect(){return[]}}class We extends Le{constructor(e,t,o){super(e),this.center=t,this.radius=o}objectEqual(e){return e instanceof We&&(this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius)}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return we(t,e,this.center,this.radius),t}intersect(e){const t=[];return e instanceof Ne?t.push(...je({start:e.start,end:e.end,type:e instanceof Ye?fe.LINE:fe.RAY},this.center,this.radius)):e instanceof Fe&&t.push(...Se(this.center,this.radius,e.point)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class Ze{constructor(e,t,o){this.coordinateHelper=e,this.targetPoint=t,this.constraint=o}}class Be extends Ze{constructor({coordinateHelper:e,targetPoint:t,objectId:o,constraint:i}){super(e,t,i),this.objectId=o}}class Ke extends Be{constructor(e){super({...e,constraint:new Ye(e.coordinateHelper,e.edgeStart,e.edgeEnd)})}get hints(){return[new ne(ae.REFERENCE,this.constraint.start,this.constraint.end)]}}class Qe extends Ze{constructor({coordinateHelper:e,targetPoint:t,constraint:o,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:n}){super(e,t,o),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=n}get hints(){const e=this.previousVertex,t=this.otherVertexType===Re.CENTER?this.otherVertex:this.targetPoint,o=this.otherVertexType===Re.CENTER?this.targetPoint:this.otherVertex;return[new ne(ae.TARGET,t,o),new ne(ae.REFERENCE,e,t),new pe(this.previousVertex,t,o)]}}!function(e){e[e.NEXT=0]="NEXT",e[e.CENTER=1]="CENTER"}(Re||(Re={}));let Xe=class extends q{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return k(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,o=new Map;if(null!=(e=this.options)&&e.featureSources)for(const e of this.options.featureSources.items){const i=e.layer.uid,r=t.get(i);if(r){t.delete(i),o.set(i,r);continue}if(!e.layer.loaded){this.updatingHandles.addPromise(e.layer.load());continue}const n=this._createSourceInfo(e);s(n)&&o.set(i,n)}for(const[,e]of t)e.destroy();return o}initialize(){this.updatingHandles.add((()=>this.snappingSources),(()=>this.notifyChange("updating")),_),s(this.view)&&this.handles.add([this.view.on("layerview-create",(e=>this._updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this._updateLayerView(e.layer,null)))])}_updateLayerView(e,t){for(const[,o]of this.snappingSources)o.snappingSource.layerSource.layer===e&&(o.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,o){if(!this.options.effectiveFeatureEnabled)return[];const i=[],r=this._computeScreeenSizeDistanceParameters(e,t),n={distance:r,point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:e,layerView:r}]of this.snappingSources)!e.layerSource.enabled||s(r)&&r.suspended||i.push(e.fetchCandidates(n,o).then((o=>o.filter((o=>!this._candidateIsExcluded(e,o,t.excludeFeature))))));const a=(await m(i)).flat();return this._addRightAngleCandidates(a,e,r,t),y(o),le(e,a),a}_addRightAngleCandidates(e,t,o,i){var n,a,p,l,c,h,d,u;const m=s(i.vertexHandle)?null==(n=i.vertexHandle.rightEdge)||null==(a=n.rightVertex)?void 0:a.pos:s(i.editGeometryOperations)&&"polygon"===i.editGeometryOperations.data.type?null==(p=r(null==(l=i.editGeometryOperations.data.components[0])?void 0:l.getFirstVertex()))?void 0:p.pos:null,y=s(i.vertexHandle)?null==(c=i.vertexHandle.leftEdge)||null==(h=c.leftVertex)?void 0:h.pos:s(i.editGeometryOperations)?null==(d=r(null==(u=i.editGeometryOperations.data.components[0])?void 0:u.getLastVertex()))?void 0:d.pos:null,g=e.length;for(let s=0;s<g;s++)this._addRightAngleCandidate(e[s],y,t,o,i,e),this._addRightAngleCandidate(e[s],m,t,o,i,e)}_addRightAngleCandidate(e,t,o,s,r,n){if(i(t)||!(e instanceof Ke))return;const a=e.constraint.closestTo(t),p=(a[0]-o[0])/s.x,l=(a[1]-o[1])/s.y;if(p*p+l*l<=1){const o=r.coordinateHelper;n.push(new Qe({coordinateHelper:o,targetPoint:a,otherVertex:t,otherVertexType:Re.NEXT,previousVertex:e.constraint.start,constraint:new qe(o,t,a),objectId:e.objectId}))}}_computeScreeenSizeDistanceParameters(e,t){const o=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return i(this.view)?{x:o,y:o}:"2d"===this.view.type?{x:o*this.view.resolution,y:o*this.view.resolution}:this._computeScreeenSizeDistanceParameters3D(e,o,this.view,t)}_computeScreeenSizeDistanceParameters3D(e,t,o,i){const{coordinateHelper:s,elevationInfo:r}=i,n=o.state.camera.computeScreenPixelSizeAt(ce(e,s,r,o,$e))*o.renderCoordsHelper.unitInMeters/o.mapCoordsHelper.unitInMeters,a=t*n;return{x:a/this._computeScreenMagnitudeOfMapOffset(e,n,0,o,i),y:a/this._computeScreenMagnitudeOfMapOffset(e,0,n,o,i)}}_computeScreenMagnitudeOfMapOffset(e,t,o,i,{coordinateHelper:s,elevationInfo:r}){const n=s.clone(e);n[0]+=t,n[1]+=o;const a=he(e,s,r,i),p=he(n,s,r,i),l=p.x-a.x,c=p.y-a.y;return Math.sqrt(l*l+c*c)}get types(){return te.EDGE|te.VERTEX}_candidateIsExcluded(e,t,o){if(i(o))return!1;const s=this._getCandidateObjectId(t);if(i(s))return!1;const r=e.layerSource.layer;return"graphics"===r.type?o.uid===s:o.sourceLayer===r&&(!(!o.attributes||!("objectIdField"in r))&&o.attributes[r.objectIdField]===s)}_getCandidateObjectId(e){return e instanceof Be?e.objectId:null}_createSourceInfo(e){const t=this._createFeatureSnappingSourceType(e);if(i(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const o=s(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new Je(t.source,o)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e)}return null}_createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this._getSourceModule("featureService");return s(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this._getSourceModule("featureCollection");return s(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const t=this._getSourceModule("graphics");return s(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_getSourceModule(e){const t=this.sourceModules[e];if(i(t.loader)){const o=this._loadSourceModule(e).then((e=>{t.module=e}));return t.loader=o,{module:t.module,loader:o}}return{module:t.module,loader:t.loader}}_loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(import("../../chunks/FeatureServiceSnappingSource.js"));case"featureCollection":return this.updatingHandles.addPromise(import("../../chunks/FeatureCollectionSnappingSource.js"));case"graphics":return this.updatingHandles.addPromise(import("../../chunks/GraphicsSnappingSource.js"))}return null}};e([T({constructOnly:!0})],Xe.prototype,"spatialReference",void 0),e([T({constructOnly:!0})],Xe.prototype,"view",void 0),e([T()],Xe.prototype,"options",void 0),e([T({readOnly:!0})],Xe.prototype,"updating",null),e([T({readOnly:!0})],Xe.prototype,"snappingSources",null),Xe=e([G("esri.views.interactive.snapping.FeatureSnappingEngine")],Xe);class Je{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new d;const o=this.snappingSource.layerSource.layer;if("refresh"in o){const t=o;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([$(e,"updating",(t=>e.layerSource.updating=t),!0),$(e,"availability",(t=>e.layerSource.availability=t),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const $e=ee();class et{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=se.shortLineThreshold*se.shortLineThreshold}snap(e,t){return s(t.vertexHandle)?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.leftVertex.pos,e.rightVertex.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:o,editGeometryOperations:i}){const s=i.data.coordinateHelper;return 0===this.squaredShortLineThreshold||de(he(t,s,o,this.view),he(e,s,o,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,o=e*t;return o*o}}class tt extends Ze{constructor({coordinateHelper:e,lineStart:t,lineEnd:o,targetPoint:i}){super(e,i,new Ye(e,t,o)),this.referenceLineHint=new ne(ae.REFERENCE_EXTENSION,t,o)}get hints(){return[this.referenceLineHint,new ne(ae.TARGET,this._lineEndClosestToTarget(),this.targetPoint)]}_lineEndClosestToTarget(){const e=this.constraint.start,t=this.constraint.end;return Math.sign(z(Y(it,t,e),Y(ot,this.targetPoint,e)))>0?t:e}}const ot=oe(),it=oe();class st extends et{snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.edges.length,s=[];if(i<1)return s;const r=t.coordinateHelper,n=he(e,r,t.elevationInfo,this.view),a=o.edges[i-1];let p=a;do{this.edgeExceedsShortLineThreshold(p,t)&&this._processCandidateProposal(p.leftVertex.pos,p.rightVertex.pos,e,n,t,s),p=p.leftVertex.leftEdge}while(p&&p!==a);return s}snapExistingVertex(e,t){const o=[],i=r(t.vertexHandle),s=i.component;if(s.edges.length<2)return o;const n=t.coordinateHelper,a=he(e,n,t.elevationInfo,this.view),p=i.leftEdge,l=i.rightEdge;p&&l&&this.edgeExceedsShortLineThreshold(p,t)&&this.edgeExceedsShortLineThreshold(l,t)&&this._processCandidateProposal(p.leftVertex.pos,l.rightVertex.pos,e,a,t,o);const c=s.edges[0];let h=c;do{h!==i.leftEdge&&h!==i.rightEdge&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.leftVertex.pos,h.rightVertex.pos,e,a,t,o),h=h.rightVertex.rightEdge}while(h&&h!==c);return o}_processCandidateProposal(e,t,o,i,s,r){const n=Ee(oe(),o,e,t),a=s.coordinateHelper,p=a.fromXYZ(n,a.getZ(o,0));de(i,he(p,a,s.elevationInfo,this.view))<this.squaredProximityTreshold(s.pointer)&&r.push(new tt({coordinateHelper:s.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:p}))}}class rt extends Ze{constructor({coordinateHelper:e,referenceLine:t,lineStart:o,targetPoint:i}){const s=e.clone(o);Y(s,B(s,s,t.rightVertex.pos),t.leftVertex.pos),super(e,i,new Ye(e,o,s)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new ne(ae.TARGET,this.constraint.start,this.targetPoint),new ue(this.constraint.start,this.targetPoint),...this._referenceLines.map((e=>new ne(ae.REFERENCE,e.edge.leftVertex.pos,e.edge.rightVertex.pos,e.fadeLeft,e.fadeRight)))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((o=>{e.rightVertex.rightEdge===o.edge&&(o.fadeLeft=!1,t.fadeRight=!1),e.leftVertex.leftEdge===o.edge&&(o.fadeRight=!1,t.fadeLeft=!1)})),this._referenceLines.push(t)}}class nt extends et{constructor(){super(...arguments),this._tmpProjection=oe()}snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.edges.length,s=o.vertices.length,r=[];if(i<2)return r;const n=he(e,t.coordinateHelper,t.elevationInfo,this.view),a=o.vertices[s-1],p=o.vertices[0],l=o.edges[i-1];let c=l;do{this.edgeExceedsShortLineThreshold(c,t)&&(this._checkEdgeForParalleLines(c,a.pos,e,n,t,r),this._checkEdgeForParalleLines(c,p.pos,e,n,t,r)),c=c.leftVertex.leftEdge}while(c&&c!==l);return r}snapExistingVertex(e,t){const o=[],i=r(t.vertexHandle),s=i.component;if(s.edges.length<3)return o;const n=he(e,t.coordinateHelper,t.elevationInfo,this.view),a=i.leftEdge,p=i.rightEdge,l=s.vertices[0],c=s.vertices.length,h=s.vertices[c-1],d=s.edges[0];let u=d;do{u!==a&&u!==p&&this.edgeExceedsShortLineThreshold(u,t)&&(a&&this._checkEdgeForParalleLines(u,a.leftVertex.pos,e,n,t,o),p&&this._checkEdgeForParalleLines(u,p.rightVertex.pos,e,n,t,o),i===l?this._checkEdgeForParalleLines(u,h.pos,e,n,t,o):i===h&&this._checkEdgeForParalleLines(u,l.pos,e,n,t,o)),u=u.rightVertex.rightEdge}while(u&&u!==d);return o}_checkEdgeForParalleLines(e,t,o,i,s,r){const n=e.leftVertex.pos,a=e.rightVertex.pos;if(Ee(this._tmpProjection,t,n,a),Z(this._tmpProjection,t)<se.parallelLineThreshold)return;Ee(this._tmpProjection,o,n,a,t);const p=s.coordinateHelper,l=p.fromXYZ(this._tmpProjection,p.getZ(o,0));if(de(i,he(l,p,s.elevationInfo,this.view))<this.squaredProximityTreshold(s.pointer)){if(this._parallelToPreviousCandidate(e,r))return;r.push(new rt({coordinateHelper:p,referenceLine:e,lineStart:t,targetPoint:l}))}}_parallelToPreviousCandidate(e,t){const o=e.leftVertex.pos,i=e.rightVertex.pos;for(const s of t)if(Ee(this._tmpProjection,i,s.constraint.start,s.constraint.end,o),Z(this._tmpProjection,i)<se.parallelLineThreshold)return s.addReferenceLine(e),!0;return!1}}class at extends et{constructor(){super(...arguments),this._tmp=oe()}snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.vertices.length,s=[];if(i<2)return s;const r=he(e,t.coordinateHelper,t.elevationInfo,this.view),n=o.vertices[i-1];this._checkForSnappingCandidate(s,n.leftEdge,n.pos,e,n.leftEdge.leftVertex.pos,n.pos,t,e,r);const a=o.vertices[0];return this._checkForSnappingCandidate(s,a.rightEdge,a.pos,e,a.rightEdge.rightVertex.pos,a.pos,t,e,r),s}snapExistingVertex(e,t){const o=[],i=r(t.vertexHandle),s=i.component,n=s.vertices.length;if(n<3)return o;const a=he(e,t.coordinateHelper,t.elevationInfo,this.view),p=i.leftEdge,l=i.rightEdge,c=s.vertices[0],h=s.vertices[n-1];if(!p)return this._checkForSnappingCandidate(o,c.rightEdge.rightVertex.rightEdge,c.rightEdge.rightVertex.pos,e,c.rightEdge.rightVertex.rightEdge.rightVertex.pos,c.rightEdge.rightVertex.pos,t,e,a),o;if(!l)return this._checkForSnappingCandidate(o,h.leftEdge.leftVertex.leftEdge,h.leftEdge.leftVertex.pos,e,h.leftEdge.leftVertex.leftEdge.leftVertex.pos,h.leftEdge.leftVertex.pos,t,e,a),o;if(p&&p.leftVertex.leftEdge){const i=p.leftVertex.leftEdge;this._checkForSnappingCandidate(o,i,p.leftVertex.pos,e,i.leftVertex.pos,p.leftVertex.pos,t,e,a)}if(l&&l.rightVertex.rightEdge){const i=l.rightVertex.rightEdge;this._checkForSnappingCandidate(o,i,l.rightVertex.pos,e,i.rightVertex.pos,l.rightVertex.pos,t,e,a)}return o}_checkForSnappingCandidate(e,t,o,i,s,r,n,a,p){if(!this.edgeExceedsShortLineThreshold(t,n))return;Y(this._tmp,t.rightVertex.pos,t.leftVertex.pos);const l=ie(this._tmp[1],-this._tmp[0]),c=z(l,Y(this._tmp,i,o))/K(l),h=n.coordinateHelper,d=h.fromXYZ(Q(oe(),r,l,c),h.getZ(a,0));de(p,he(d,h,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)&&e.push(new Qe({coordinateHelper:h,targetPoint:d,constraint:new qe(h,r,Q(h.createVector(),r,l,Math.sign(c))),previousVertex:s,otherVertex:r,otherVertexType:Re.CENTER}))}}class pt extends Ze{constructor({coordinateHelper:e,targetPoint:t,point1:o,point2:i}){super(e,t,new We(e,X(lt,o,i,.5),.5*J(o,i))),this.p1=o,this.p2=i}get hints(){return[new ne(ae.REFERENCE,this.targetPoint,this.p1),new ne(ae.REFERENCE,this.targetPoint,this.p2),new pe(this.p1,this.targetPoint,this.p2)]}}const lt=oe();class ct extends et{snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=[],s=o.vertices.length;if("polygon"!==t.editGeometryOperations.data.type||s<2)return i;const r=o.vertices[0],n=o.vertices[s-1];return this._processCandidateProposal(r.pos,n.pos,e,t,i),i}snapExistingVertex(e,t){const o=[],i=r(t.vertexHandle),s=i.component;return s.edges.length<2?o:"polyline"!==t.editGeometryOperations.data.type||0!==i.index&&i.index!==s.vertices.length-1?(this._processCandidateProposal(i.leftEdge.leftVertex.pos,i.rightEdge.rightVertex.pos,e,t,o),o):o}_processCandidateProposal(e,t,o,i,s){if(!this.exceedsShortLineThreshold(e,t,i))return;const r=X(oe(),e,t,.5),n=.5*J(e,t),a=we(oe(),o,r,n),p=i.coordinateHelper,l=p.fromXYZ(a,p.getZ(o,0)),c=he(o,p,i.elevationInfo,this.view);de(c,he(l,p,i.elevationInfo,this.view))<this.squaredProximityTreshold(i.pointer)&&s.push(new pt({coordinateHelper:p,targetPoint:l,point1:e,point2:t}))}}let ht=class extends be{constructor(e){super(e),this.updating=!1,this._snappers=new o}initialize(){this._snappers.push(new nt(this.view,this.options),new st(this.view,this.options),new at(this.view,this.options),new ct(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t){if(!this.options.effectiveSelfEnabled)return[];const o=[];for(const i of this._snappers.items)o.push(...i.snap(e,t));return le(e,o),o}};e([T({readOnly:!0})],ht.prototype,"updating",void 0),e([T({constructOnly:!0})],ht.prototype,"view",void 0),e([T()],ht.prototype,"options",null),ht=e([G("esri.views.interactive.snapping.SelfSnappingEngine")],ht);class dt extends Ze{constructor(e,t,o,i){super(e,t,new ze(e,t,o.constraint,i.constraint)),this.first=o,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new me(this.targetPoint)]}}let ut=class extends(h.EventedMixin(q)){constructor(e){super(e),this.options=new Te,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([j((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:o,distance:i}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:o,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")}),_),j((()=>this.options),(e=>{for(const t of this.engines)t.options=e}),_),j((()=>({ready:this.view.ready,spatialReference:this.view.spatialReference})),(({ready:e,spatialReference:t})=>this._onViewChange(e,t)),E)])}destroy(){this._destroyEngines()}get updating(){return this.engines.some((e=>e.updating))}_onViewChange(e,t){this._destroyEngines(),e&&(this.engines=[new ht({view:this.view,options:this.options}),new Xe({view:this.view,spatialReference:null!=t?t:M.WGS84,options:this.options})])}_destroyEngines(){for(const e of this.engines)e.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,o=e*t;return o*o}async snap(e,t,o){const i=t.coordinateHelper.pointToVector(e),r=await this._fetchCandidates(i,t,o);return{get valid(){return!g(o)},apply:()=>{const{snappedPoint:e,hints:o}=this._processCandidates(i,r,t);return this._removeVisualization(),s(t.visualizer)&&this.handles.add(t.visualizer.draw(o,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),mt),e}}}update(e,t){this._removeVisualization();let o=e;const i=[];if(s(this._currentMainCandidate)){const s=t.coordinateHelper,r=s.pointToVector(e),n=this._currentMainCandidate.constraint.closestTo(r);if(de(he(r,s,t.elevationInfo,this.view),he(n,s,t.elevationInfo,this.view))<this._squaredPointProximityThreshold(t.pointer)){o=s.vectorToDehydratedPoint(n),this._currentMainCandidate.targetPoint=n,i.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=n,i.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return s(t.visualizer)&&this.handles.add(t.visualizer.draw(i,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),mt),o}doneSnapping(){this._removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}_removeVisualization(){this.handles.remove(mt)}async _fetchCandidates(e,t,o){return(await Promise.all(this.engines.map((i=>i.fetchCandidates(e,t,o))))).flat()}_processCandidates(e,t,o){if(t.length<1)return this.doneSnapping(),{snappedPoint:o.coordinateHelper.vectorToDehydratedPoint(e),hints:[]};le(e,t);const i=this._currentMainCandidate;if(s(i)){const s=this._findOldConstraintInNewCandidates(i,t);if(s>=0){if(!(t[s]instanceof dt))return this._intersectWithOtherCandidates(s,t,e,o);if(Z(e,i.targetPoint)<this._squaredPointProximityThreshold(o.pointer))return this._updateSnappingCandidate(i,t,o)}}return this._intersectWithOtherCandidates(0,t,e,o)}_findOldConstraintInNewCandidates(e,t){return e instanceof dt?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,o,i){const s=t[e],r=[],n=i.coordinateHelper;for(let a=0;a<t.length;++a){if(a===e)continue;const p=t[a];for(const e of s.constraint.intersect(p.constraint)){const t=n.fromXYZ(e.intersection,s.targetPoint[2]);r.push([new dt(n,t,s,p),de(he(o,i.coordinateHelper,i.elevationInfo,this.view),he(t,i.coordinateHelper,i.elevationInfo,this.view))])}}return r.length>0&&(r.sort(((e,t)=>e[1]-t[1])),r[0][1]<this._squaredPointProximityThreshold(i.pointer))?this._updateSnappingCandidate(r[0][0],t,i):this._updateSnappingCandidate(s,t,i)}_updateSnappingCandidate(e,t,o){this.doneSnapping(),this._currentMainCandidate=e;const i=this._currentMainCandidate.targetPoint,s=[];s.push(...e.hints);for(const o of t){if(e instanceof dt){if(o.constraint.objectEqual(e.first.constraint)||o.constraint.objectEqual(e.second.constraint))continue}else if(o.constraint.objectEqual(e.constraint))continue;o.constraint.check(i)&&(o.targetPoint=i,this._currentOtherActiveCandidates.push(o),s.push(...o.hints))}return{snappedPoint:o.coordinateHelper.vectorToDehydratedPoint(i),hints:s}}_squaredPointProximityThreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}_findOldCandidateIndex(e,t){let o=-1;for(let i=0;i<e.length;++i)if(t.constraint.objectEqual(e[i].constraint)){o=i;break}return o}get test(){return{visualizationsActive:this.handles.has(mt),engines:this.engines}}};e([T({constructOnly:!0})],ut.prototype,"view",void 0),e([T()],ut.prototype,"options",void 0),e([T({readOnly:!0})],ut.prototype,"updating",null),e([T()],ut.prototype,"engines",void 0),e([T()],ut.prototype,"squaredMouseProximityTreshold",null),e([T()],ut.prototype,"squaredTouchProximityThreshold",null),ut=e([G("esri.views.interactive.snapping.SnappingManager")],ut);const mt="visualization-handle";let yt=class extends h.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:Ge(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type&&"graphic-mover"!==e.type||e.refresh())}set undo(e){this._set("undo",(()=>{this.canUndo()&&e()}))}set redo(e){this._set("redo",(()=>{this.canRedo()&&e()}))}};e([T()],yt.prototype,"activeComponent",void 0),e([T()],yt.prototype,"cancelled",void 0),e([T()],yt.prototype,"history",void 0),e([T()],yt.prototype,"tool",null),e([T()],yt.prototype,"type",void 0),e([T()],yt.prototype,"canUndo",null),e([T()],yt.prototype,"canRedo",null),e([T()],yt.prototype,"onEnd",void 0),e([T()],yt.prototype,"undo",null),e([T()],yt.prototype,"redo",null),e([T()],yt.prototype,"toggleTool",void 0),e([T()],yt.prototype,"addToSelection",void 0),e([T()],yt.prototype,"removeFromSelection",void 0),yt=e([G("esri.widgets.Sketch.support.OperationHandle")],yt);let gt=class extends yt{};e([T()],gt.prototype,"activeComponent",void 0),gt=e([G("esri.widgets.Sketch.support.CreateOperationHandle")],gt);let vt=class extends yt{constructor(e){super(e)}};e([T()],vt.prototype,"activeComponent",void 0),vt=e([G("esri.widgets.Sketch.support.UpdateOperationHandle")],vt);const ft=u.getLogger("esri.widgets.Sketch.SketchViewModel"),_t={defaultZ:0},jt={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let Et=class extends h.EventedAccessor{constructor(e){super(e),this._numUpdating=0,this._handles=new d,this._internalGraphicsLayer=new H({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandles=new d,this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new Oe({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new Pe({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new xe({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new o,this.updateOnGraphicClick=!0,this.updatePointSymbol=new Oe({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new Pe({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new xe({color:[12,207,255],width:2}),this.vertexSymbol=new Oe({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=_t,this.defaultUpdateOptions=jt,this.snappingOptions=new Te}initialize(){this._handles.add([w((()=>{var e,t;return null==(e=this.view)||null==(t=e.map)?void 0:t.layers}),"change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),w((()=>{var e;return null==(e=this.layer)?void 0:e.graphics}),"change",(e=>{if(s(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),j((()=>{var e,t;return null!=(e=null==(t=this.layer)?void 0:t.elevationInfo)?e:null}),(e=>{e!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=e)}),E),j((()=>this.view),(e=>{n(this._snappingManager),e&&(this._snappingManager=new ut({view:e,options:this.snappingOptions}),"2d"===e.type?import("../../chunks/editingTools.js"):"3d"===e.type&&(import("../../chunks/editingTools2.js"),import("../../chunks/GraphicsLayerView3D.js")))}),E),j((()=>{var e;return null==(e=this.view)?void 0:e.spatialReference}),((e,t)=>{e&&t&&!e.equals(t)&&this.cancel()}))])}destroy(){this.cancel(),this._handles=n(this._handles),this._viewHandles=n(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=n(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return!s(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):r(this.activeComponent.graphic)}set defaultCreateOptions(e){this._set("defaultCreateOptions",{..._t,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...jt,...e,reshapeOptions:{...jt.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}set snappingOptions(e){s(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),o=this._operationHandle;return t&&o?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:o}=t;e&&(t.cursor=null),o&&o.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const o="view-ready";this._handles.remove(o),e&&this._handles.add(S((()=>e.ready),(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),E),o),this._set("view",e)}cancel(){this._moduleLoaderAbortController=a(this._moduleLoaderAbortController),this._viewReadyAbortController=a(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:o}=this,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:e})}}async create(e,t){if(this.cancel(),await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),v();if(s(this.view.activeTool)&&(this.view.activeTool=null),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");De(this.view,this._internalGraphicsLayer);const o=await this._setupCreateOperation(e,t);if(i(o)||this.destroyed)return void this.view.map.remove(this._internalGraphicsLayer);o.on("complete",(()=>{if(o===this._operationHandle){const t=this.createGraphic,i=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),o.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:i?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=o,this.view.ready&&U(this.view)&&this.view.focus()}async update(e,t){this.cancel(),await this._waitViewReady();const{layer:o,view:r,state:n}=this;if("disabled"===n)throw r||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),v();s(this.view.activeTool)&&(this.view.activeTool=null);const a=Array.isArray(e)?e:[e];if(null==e||!a||!a.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some((e=>e.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):!!i(e.geometry)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0))))return;const p=await this._setupUpdateOperation(a,t);this.destroyed||i(p)||Gt(p)||(De(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(p,t),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:p.tool,toolEventInfo:null,type:"update"}))}async _updateSpatialReference(e){this._beginAsyncOperation(),e=Array.isArray(e)?e:[e];for(const t of e)s(t.geometry)&&"mesh"!==t.geometry.type&&!A(t.geometry.spatialReference,this.view.spatialReference)&&(O(t.geometry.spatialReference,this.view.spatialReference)||P()||await x(),t.geometry=C(t.geometry,this.view.spatialReference));this._endAsyncOperation()}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const o=[];this.view.map.allLayers.forEach((e=>{"vector-tile"!==e.type&&"imagery"!==e.type||o.push(e)}));const i=await this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];e.graphic&&t.push(e)}}break;case"3d":{const o=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&o.push(e)}));const i=await this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];(!i.ground.mapPoint||this.view.map.ground.opacity<1||i.ground.distance-p(e.distance,0)>-Math.min(3*i.ground.distance,"global"===this.view.viewingMode?I(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(async t=>{const o="active"===this.state&&"create"===this._operationHandle.type;if("disabled"===this.state||o||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const i=(await t.async((()=>this._getFirstHit(ke(t))))).results;let r=null;if(i.length){for(const o of i)if(o.graphic){const i=o.graphic;if(this.updateGraphics.includes(i)||i.layer===this.layer){t.stopPropagation(),r=i;break}"2d"!==e.type||this._isComponentGraphic(i)||"active"!==this.state||this.cancel()}}else"active"===this.state&&this.cancel();s(r)&&!this.updateGraphics.includes(r)&&await this.update([r],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),F.WIDGET)]}async _setupCreateOperation(e,t){const o={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t},s=await this._setupDrawGraphicTool(e,this.view,o);return i(s)?null:(this.view.tools.add(s),this.view.activeTool=s,this._setupCreateOperationHandle(s))}async _setupDrawGraphicTool(e,t,o){if("multipoint"===e&&"3d"===t.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView"),null;const i="rectangle"!==e,s="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const r={view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...o,snapToScene:!1,geometryType:e,graphicSymbol:this._getGraphicSymbolFromTool(e),snappingManager:this._snappingManager,forceUniformSize:s,centered:i};return"2d"===this.view.type?this._makeDrawGraphicTool2D(r):this._makeDrawGraphicTool3D(r)}async _makeDrawGraphicTool2D(e){const t=await this._requireModule(import("../../chunks/editingTools.js"));return Gt(t)||this.destroyed?null:new t.module.DrawGraphicTool2D({...e,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:wt(e.geometryType)?this.activeFillSymbol:null})}async _makeDrawGraphicTool3D(e){const t=await this._requireModule(import("../../chunks/editingTools2.js"));return Gt(t)||this.destroyed?null:new t.module.DrawGraphicTool3D({...e,elevationInfo:this.layer.elevationInfo,snapToScene:!s(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode})}_setupCreateOperationHandle(e){let t=null;const o=e.forceUniformSize,s=e.centered,n=[this.view.on("key-down",(t=>{if(t.key===N.pan)t.stopPropagation(),t.repeat||(e.enabled=!1);else if(t.key===N.complete)t.stopPropagation(),e.completeCreateOperation();else if(t.key!==N.vertexAdd||t.repeat)t.key===N.undo?(t.stopPropagation(),a.undo()):t.key===N.redo?(t.stopPropagation(),a.redo()):t.key!==N.snappingToggle||"rectangle"===e.geometryType||"circle"===e.geometryType||t.repeat?t.key!==N.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType||t.repeat?t.key===N.center&&(t.repeat||(e.centered=!s,t.stopPropagation())):(e.forceUniformSize=!o,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation());else{const o=e.drawOperation.geometryType;"polyline"!==o&&"polygon"!==o&&"multipoint"!==o||(t.stopPropagation(),e.drawOperation.commitStagedVertex())}}),F.WIDGET),this.view.on("key-up",(t=>{t.key===N.pan?e.enabled=!0:t.key===N.snappingToggle&&"rectangle"!==e.geometryType&&"circle"!==e.geometryType?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==N.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType?t.key===N.center&&(e.centered=s,t.stopPropagation()):(e.forceUniformSize=o,t.stopPropagation())}),F.WIDGET),e.on("vertex-add",(o=>{switch(t=i(t)?"start":"active",o.operation){case"apply":this.emit("create",{graphic:r(e.graphic),state:t,tool:this.activeTool,toolEventInfo:o,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[r(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[r(e.graphic)],tool:e.geometryType})}})),e.on("cursor-update",(t=>{e.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:r(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:t.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),e.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:r(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[r(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[r(e.graphic)],tool:e.geometryType})}})),e.on("complete",(e=>{this._set("createGraphic",r(e.graphic)),t="complete",e.aborted?a&&a.cancel():a&&a.complete()})),j((()=>this._getGraphicSymbolFromTool(e.geometryType)),(t=>{e.graphicSymbol=t}))],a=new yt({activeComponent:e,tool:e.geometryType,type:"create",onEnd:()=>{var t;n.forEach((e=>e.remove())),n.length=0,null==(t=this.view.tools)||t.remove(e),e.destroy()},undo:()=>{e.canUndo&&e.undo()},redo:()=>{e.canRedo&&e.redo()},canUndo:()=>e.canUndo,canRedo:()=>e.canRedo});return a}_getGraphicSymbolFromTool(e){switch(e){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}async _setupUpdateOperation(e,t){const{layer:o,view:i}=this,s={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}};let r=s.tool;for(const t of e)o.remove(t),o.add(t);if("3d"===i.type){if(0===e.length)return null;switch(r){case"move":return this._setupMove3DOperation(e,s,i,r);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Ae(e[0]);return t===Ie.SUPPORTED?this._setupReshape3DOperation(e[0],s,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Ce(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,s,i)}}switch(r){case"move":return this._setupMove2DOperation(e,s,i);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Ae(e[0]);return t===Ie.SUPPORTED?this._setupTransformOrReshape2DOperation(e,r,s,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Ce(t)}).`),null)}case"transform":if(1===e.length){const t=l(e[0].geometry,"type");"point"!==t&&"multipoint"!==t||(r="reshape")}return this._setupTransformOrReshape2DOperation(e,r,s,i)}}async _setupMove3DOperation(e,t,o,i,s=!1){for(const t of e){const e=Me(t);if(e!==Ie.SUPPORTED)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Ce(e)}).`),null}const r=await this._requireModule(import("../../chunks/editingTools2.js"));if(Gt(r))return r;const n=new r.module.GraphicMoveTool({view:o,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(n),n.graphics.addMany(e),s||this.updateGraphics.addMany(e);const a=[],p=new vt({activeComponent:n,tool:i,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},undo:()=>{St(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{bt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:e=>{this.updateGraphics.push(e),n.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?n.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==i)return;const e=this.updateGraphics.getItemAt(0);if(Ae(e)!==Ie.SUPPORTED)return;const s=await this._setupReshape3DOperation(e,t,o,!0);Gt(s)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(s,t))}});return a.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),F.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),o.on("key-up",(e=>{e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),p}_setupGraphicTransform3DOperation(e,t,o,r=!1){if(1===e.length&&function(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return Ie.GRAPHICS_LAYER_MISSING;if(i(e.geometry))return Ie.GEOMETRY_MISSING;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return Ie.SUPPORTED;default:return Ie.GEOMETRY_TYPE_UNSUPPORTED}const o=s(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return o&&o.length>0&&o.some((e=>"object"===e.type))?"on-the-ground"!==D(e)&&V(e)?Ie.ELEVATION_MODE_UNSUPPORTED:Ie.SUPPORTED:Ie.SYMBOL_TYPE_UNSUPPORTED}(e[0])===Ie.SUPPORTED){const i=e[0],n=i.geometry;if(s(n)&&("point"===n.type||"mesh"===n.type))return this._setupPointTransform3DOperation(i,t,o);if(s(n)&&("polygon"===n.type||"polyline"===n.type))return this._setupPolyTransform3DOperation(i,t,o,r)}return this._setupMove3DOperation(e,t,o,"transform",r)}async _setupPointTransform3DOperation(e,t,o){const i="transform",{enableRotation:s,enableScaling:r,enableZ:n}=t,a=await this._requireModule(import("../../chunks/editingTools2.js"));if(Gt(a))return a;const p=new a.module.GraphicTransformTool({graphic:e,view:o,enableRotation:s,enableScaling:r,enableZ:n,snappingManager:this._snappingManager});this.view.tools.add(p),this.updateGraphics.add(e);const l=[],c=new vt({activeComponent:p,tool:i,type:"update",onEnd:()=>{var e;l.forEach((e=>e.remove())),l.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{St(c,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{bt(c,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);Gt(i)||(c.onEnd(),c.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),c.complete()},toggleTool:()=>{}});return l.push(...this._getHandlesForComponent(c,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(c,e,t)),F.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(c,e),e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),o.on("key-up",(e=>{e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),c}async _setupPolyTransform3DOperation(e,t,o,i=!1){const s="transform",{enableRotation:r,enableScaling:n,enableZ:a,preserveAspectRatio:p}=t,l=await this._requireModule(import("../../chunks/editingTools2.js"));if(Gt(l))return l;const c=new l.module.ExtentTransformTool({graphic:e,view:o,enableRotation:r,enableScaling:n,enableZ:a,preserveAspectRatio:p});this.view.tools.add(c),i||this.updateGraphics.add(e);const h=[],d=new vt({activeComponent:c,tool:s,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(c),c.destroyed||c.destroy()},canUndo:()=>c.canUndo,undo:()=>{c.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>c.canRedo,redo:()=>{c.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);Gt(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(Ae(e)!==Ie.SUPPORTED)return;const i=await this._setupReshape3DOperation(e,t,o,!0);Gt(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,t))}});return h.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,t)),F.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(d,e)),F.WIDGET),this.view.on("key-down",(e=>{e.key!==N.constraint||e.repeat||(c.preserveAspectRatio=!c.preserveAspectRatio,e.stopPropagation())}),F.WIDGET),this.view.on("key-up",(e=>{e.key===N.constraint&&(c.preserveAspectRatio=!c.preserveAspectRatio,e.stopPropagation())}),F.WIDGET)),d}async _setupMove2DOperation(e,t,o){const i="move";this.updateGraphics.addMany(e),await this._updateSpatialReference(e);const s=await this._getGraphicMover(e,t,o);if(Gt(s))return s;const r=new vt({activeComponent:s,tool:i,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),a.forEach((e=>e.remove())),p=[],a=[],s.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();St(r,e),r.refreshComponent(),this._emitUndoEvent({graphics:e,tool:i})},redo:()=>{const e=this.updateGraphics.toArray();bt(r,e),r.refreshComponent(),this._emitRedoEvent({graphics:e,tool:i})},addToSelection:async e=>{await this._updateSpatialReference(e),this.updateGraphics.push(e),s.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);r.history.undo.forEach((e=>e.updates.splice(t,1))),r.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?s.graphics=o:r.complete()}});let n=!1,a=[o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(r,e,t)),F.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(r,e),e.key!==N.constraint||e.repeat||(n=!0,s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),F.WIDGET),o.on("key-up",(e=>{e.key===N.constraint&&n&&(n=!1,s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),F.WIDGET)],p=this._getHandlesForComponent(r,t);return r}async _setupReshape3DOperation(e,t,o,i=!1){const s="reshape",r=await this._requireModule(import("../../chunks/editingTools2.js"));if(Gt(r))return r;this.snappingOptions.enabledToggled=!1;const n=new r.module.GraphicReshapeTool({view:o,graphic:e,enableZVertex:t.enableZ&&"move"===t.reshapeOptions.vertexOperation,enableZShape:t.enableZ&&"move"===t.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===t.reshapeOptions.shapeOperation||"move-xy"===t.reshapeOptions.shapeOperation,enableMidpoints:"split"===t.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===t.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});o.tools.add(n),i||this.updateGraphics.add(e);const a=[],p=new vt({activeComponent:n,tool:s,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},canUndo:()=>n.canUndo,undo:()=>{n.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>n.canRedo,redo:()=>{n.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);Gt(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,o,!0);Gt(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return a.push(...this._getHandlesForComponent(p,t),o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),F.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),F.WIDGET),o.on("key-up",(e=>{e.key===N.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),F.WIDGET)),p}async _setupTransformOrReshape2DOperation(e,t,o,i){this.updateGraphics.addMany(e),await this._updateSpatialReference(e);const r="transform"===t?await this._getBox(e,o,i):await this._getReshape(e,o,i);if(Gt(r))return r;const n=new vt({activeComponent:r,type:"update",onEnd:()=>{p.forEach((e=>e.remove())),a.forEach((e=>e.remove())),p=[],a=[],n.activeComponent&&!n.activeComponent.destroyed&&n.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{St(n,this.updateGraphics.toArray()),n.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n.tool})},redo:()=>{bt(n,this.updateGraphics.toArray()),n.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n.tool})},addToSelection:async e=>{let t=n.activeComponent;if("reshape"===t.type){const t=[...this.updateGraphics,e];this.updateGraphics.removeAll();const s=await this._setupMove2DOperation(t,o,i);if(Gt(s))return;n.onEnd(),n.destroy(),this._setUpdateOperationHandle(s,o)}else this.updateGraphics.add(e),t=t,t.graphics=this.updateGraphics.toArray(),t.refresh(),n.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async e=>{const t=this.updateGraphics.indexOf(e);n.history.undo.forEach((e=>e.updates.splice(t,1))),n.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();if(0===o.length)n.complete();else{const e=o[0].geometry;1!==o.length||!s(e)||"point"!==e.type&&"multipoint"!==e.type?n.activeComponent.graphics=o:n.toggleTool()}this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const e=this.updateGraphics.getItemAt(0),t=e.geometry;if(s(t)&&("reshape"===n.tool&&("point"===t.type||"multipoint"===t.type)||"transform"===n.tool&&"extent"===t.type))return;let r=null;"transform"===n.tool?r=await this._getReshape([e],o,i):"reshape"===n.tool&&(r=await this._getBox([e],o,i)),Gt(r)||(n.activeComponent.destroy(),n.activeComponent=r,n.activeComponent&&(p.forEach((e=>e.remove())),p=this._getHandlesForComponent(n,o)))}});let a=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(n,e,o)),F.WIDGET),i.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(n,e),e.key!==N.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===N.constraint&&!e.repeat&&n){const e=n.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),F.WIDGET),i.on("key-up",(e=>{var t;if(e.key===N.snappingToggle&&"reshape"===(null==n||null==(t=n.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===N.constraint&&n){const e=n.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),F.WIDGET)],p=this._getHandlesForComponent(n,o);return n}async _getGraphicMover(e,t,o){const{enableMoveAllGraphics:i}=t,s=await this._requireModule(import("../../chunks/GraphicMover.js").then((e=>e.a)));return Gt(s)?s:new s.module.default({enableMoveAllGraphics:i,highlightsEnabled:!0,indicatorsEnabled:!1,graphics:e,view:o,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:o})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:o})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,o){const{enableRotation:i,enableScaling:s,preserveAspectRatio:r}=t,n=await this._requireModule(import("../../chunks/Box.js"));return Gt(n)?n:new n.module.default({graphics:e,enableRotation:i,enableScaling:s,preserveAspectRatio:r,layer:this._internalGraphicsLayer,view:o,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,o){var i,s;const r="split"===(null==(i=t.reshapeOptions)?void 0:i.edgeOperation),n="move"===(null==(s=t.reshapeOptions)?void 0:s.shapeOperation),a=await this._requireModule(import("../../chunks/Reshape.js"));return Gt(a)?a:new a.module.default({enableMidpoints:r,enableMovement:n,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:o,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMove:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMoveStop:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onVertexAdd:({added:e,type:t,vertices:o})=>{const i=e.map((e=>R(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:o})=>{const i=e.map((e=>R(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-click",(({graphic:t,viewEvent:o})=>{var i;null!=(i=o.native)&&i.shiftKey&&(o.stopPropagation(),e.removeFromSelection(t))})),o.on("graphic-move-start",(t=>e.addToHistory(kt(t.allGraphics))))];case"box":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(kt(t.graphics)))),o.on("rotate-start",(t=>e.addToHistory(kt(t.graphics)))),o.on("scale-start",(t=>e.addToHistory(kt(t.graphics))))];case"reshape":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(kt([t.mover])))),o.on("reshape-start",(t=>e.addToHistory(kt([t.graphic])))),o.on("vertex-add",(t=>e.addToHistory(kt([t.oldGraphic])))),o.on("vertex-remove",(t=>e.addToHistory(kt([t.oldGraphic]))))];case"move-3d":return[o.on("graphic-move-start",(t=>{e.addToHistory(kt(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),o.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[o.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];default:return}}_onTransformOrReshape2DGraphicClick(e,t,o){var i;const{graphic:s,viewEvent:r}=o;return null!=(i=r.native)&&i.shiftKey&&s.layer===this.layer?(r.stopPropagation(),e.removeFromSelection(s)):t.toggleToolOnClick?(r.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,t){this._operationHandle=e;const o=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const i=this.updateGraphics.toArray(),s=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:i,state:"complete",aborted:e.cancelled,tool:s,toolEventInfo:null,type:"update"})}}))}async _getCommonUpdateOperationClickHandlers(e,t,o){const i=ke(t),s=(await t.async((()=>this._getFirstHit(i)))).results;if(!s.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(s.map((e=>e.graphic)),e,o))return void t.stopPropagation();s.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}_toggleSelection(e,t,o){const i=!!o.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!i||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const o=t.key;o===N.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):o===N.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):o===N.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&N.delete.includes(o)&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,o=this.updateGraphics.toArray();i(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===o.length&&"point"===l(o[0].geometry,"type"))&&(e.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=n(this._internalGraphicsLayer))}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||i(t))&&(e.attributes&&e.attributes.esriSketchTool||"draw-2d"===t.type&&t.graphic===e||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,o){ft.error(new c(e,t,o))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const o=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:o}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:jt}}wait(){return b((()=>!this.updating))}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||s(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&i(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&s(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){const e=this.view;e&&(a(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await f(b((()=>null==e?void 0:e.ready)),this._viewReadyAbortController.signal))}};function wt(e){return"polygon"===e||"rectangle"===e||"circle"===e}function St(e,t){Tt("undo",e.history.undo,e.history.redo,t)}function bt(e,t){Tt("redo",e.history.redo,e.history.undo,t)}function Tt(e,t,o,i){const r=t.pop().updates,n=[];i.forEach(((t,o)=>{const i=r[o];null!=i&&("geometry"in i&&s(i.geometry)&&(n.push({geometry:t.geometry}),t.geometry=i.geometry),"symbol"in i&&s(i.symbol)&&(n.push({symbol:t.symbol}),t.symbol=i.symbol),"undo"in i&&(n.push(i),i[e](t)))})),o.push({updates:n})}function kt(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function Gt(e){return"requireError"in e&&"aborted"===e.requireError}e([T()],Et.prototype,"updating",null),e([T()],Et.prototype,"_operationHandle",void 0),e([T({readOnly:!0})],Et.prototype,"activeTool",null),e([T()],Et.prototype,"activeFillSymbol",void 0),e([T()],Et.prototype,"activeLineSymbol",void 0),e([T()],Et.prototype,"activeVertexSymbol",void 0),e([T()],Et.prototype,"allowDeleteKey",void 0),e([T({readOnly:!0})],Et.prototype,"createGraphic",null),e([T()],Et.prototype,"defaultCreateOptions",null),e([T()],Et.prototype,"defaultUpdateOptions",null),e([T()],Et.prototype,"layer",void 0),e([T({types:t})],Et.prototype,"pointSymbol",void 0),e([T({types:t})],Et.prototype,"polygonSymbol",void 0),e([T({types:t})],Et.prototype,"polylineSymbol",void 0),e([T({type:Te,nonNullable:!0})],Et.prototype,"snappingOptions",null),e([T()],Et.prototype,"_snappingManager",void 0),e([T({readOnly:!0})],Et.prototype,"state",null),e([T({readOnly:!0})],Et.prototype,"updateGraphics",void 0),e([T()],Et.prototype,"updateOnGraphicClick",void 0),e([T({types:t})],Et.prototype,"updatePointSymbol",void 0),e([T({types:t})],Et.prototype,"updatePolygonSymbol",void 0),e([T({types:t})],Et.prototype,"updatePolylineSymbol",void 0),e([T({types:t})],Et.prototype,"vertexSymbol",void 0),e([T({value:null})],Et.prototype,"view",null),Et=e([G("esri.widgets.Sketch.SketchViewModel")],Et);const Ot=Et;export{Ke as E,Be as F,Fe as P,Ie as S,Ae as a,De as b,Ot as default,Ve as f,He as g,Me as i};
