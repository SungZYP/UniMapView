/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../config.js";import n from"./Error.js";import{L as e}from"../chunks/Logger.js";import{a as r,i as o,b as i}from"./lang.js";import"../chunks/object.js";import"../chunks/string.js";const s=e.getLogger("esri.core.urlUtils"),u=t.request,c="esri/config: esriConfig.request.proxyUrl is not set.",l=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,f=/^\s*http:/i,a=/^\s*https:/i,h=/^\s*file:/i,p=/:\d+$/,d=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,g=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),m=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class y{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let n=r(this.uri.match(g));this.scheme=n[2]||(n[1]?"":null),this.authority=n[4]||(n[3]?"":null),this.path=n[5],this.query=n[7]||(n[6]?"":null),this.fragment=n[9]||(n[8]?"":null),null!=this.authority&&(n=r(this.authority.match(m)),this.user=n[3]||null,this.password=n[4]||null,this.host=n[6]||n[7],this.port=n[9]||null)}toString(){return this.uri}}const $={},x=new y(t.applicationUrl);let w=x;const O=function(){const t=r(w.path),n=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${w.scheme}://${w.host}${null!=w.port?`:${w.port}`:""}${n}`}();let U=O;const b=()=>w,C=()=>U;const q={setAppUrl:t=>w=t,setAppBaseUrl:t=>U=t,restoreUrls:()=>{w=x,U=O}};function R(t){const n={path:null,query:null},e=new y(t),r=t.indexOf("?");return null===e.query?n.path=t:(n.path=t.substring(0,r),n.query=j(e.query)),e.fragment&&(n.hash=e.fragment,null===e.query&&(n.path=n.path.substring(0,n.path.length-(e.fragment.length+1)))),n}function j(t){const n=t.split("&"),e={};for(const t of n){if(!t)continue;const n=t.indexOf("=");let r,o;n<0?(r=decodeURIComponent(t),o=""):(r=decodeURIComponent(t.slice(0,n)),o=decodeURIComponent(t.slice(n+1)));let i=e[r];"string"==typeof i&&(i=e[r]=[i]),Array.isArray(i)?i.push(o):e[r]=o}return e}function v(t){return t&&"object"==typeof t&&"toJSON"in t&&"function"==typeof t.toJSON}function L(t,n){return t?n&&"function"==typeof n?Object.keys(t).map((e=>encodeURIComponent(e)+"="+encodeURIComponent(n(e,t[e])))).join("&"):Object.keys(t).map((e=>{const r=t[e];if(null==r)return"";const o=encodeURIComponent(e)+"=",i=n&&n[e];return i?o+encodeURIComponent(i(r)):Array.isArray(r)?r.map((t=>v(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t))).join("&"):v(r)?o+encodeURIComponent(JSON.stringify(r)):o+encodeURIComponent(r)})).filter((t=>t)).join("&"):""}function I(t=!1){let e,r=u.proxyUrl;if("string"==typeof t){e=lt(t);const n=E(t);n&&(r=n.proxyUrl)}else e=!!t;if(!r)throw s.warn(c),new n("urlutils:proxy-not-set",c);e&&ht()&&(r=at(r));return R(r)}function A(t){const n=E(t);let e,r;if(n){const t=k(n.proxyUrl);e=t.path,r=t.query?j(t.query):null}if(e){const n=R(t);t=e+"?"+n.path;const o=L({...r,...n.query});o&&(t=`${t}?${o}`)}return t}const S={path:"",query:""};function k(t){const n=t.indexOf("?");return-1!==n?(S.path=t.slice(0,n),S.query=t.slice(n+1)):(S.path=t,S.query=null),S}function B(t){return t=(t=pt(t=function(t){if(!t||"/"!==t[t.length-1])return`${t}/`;return t}(t=k(t).path),!0)).toLowerCase()}function P(t){const n={proxyUrl:t.proxyUrl,urlPrefix:B(t.urlPrefix)},e=u.proxyRules,r=n.urlPrefix;let o=e.length;for(let t=0;t<e.length;t++){const n=e[t].urlPrefix;if(0===r.indexOf(n)){if(r.length===n.length)return-1;o=t;break}0===n.indexOf(r)&&(o=t+1)}return e.splice(o,0,n),o}function E(t){const n=u.proxyRules,e=B(t);for(let t=0;t<n.length;t++)if(0===e.indexOf(n[t].urlPrefix))return n[t]}function J(t,n){return t=N(t),n=N(n),pt(t)===pt(n)}function N(t){const n=(t=_(t)).indexOf("/sharing");return n>0?t.substring(0,n):t.replace(/\/+$/,"")}function T(t){const n=n=>null==n||n instanceof RegExp&&n.test(t)||"string"==typeof n&&t.startsWith(n),e=u.interceptors;if(e)for(const t of e)if(Array.isArray(t.urls)){if(t.urls.some(n))return t}else if(n(t.urls))return t;return null}function W(t,n,e=!1){const r=$t(t),o=$t(n);return!(!e&&r.scheme!==o.scheme)&&(null!=r.host&&null!=o.host&&(r.host.toLowerCase()===o.host.toLowerCase()&&r.port===o.port))}function z(t){if("string"==typeof t){if(!H(t))return!0;t=$t(t)}if(W(t,w))return!0;const n=u.trustedServers||[];for(let e=0;e<n.length;e++){const r=D(n[e]);for(let n=0;n<r.length;n++)if(W(t,r[n]))return!0}return!1}function D(t){return $[t]||(ct(t)||ut(t)?$[t]=[new y(M(t))]:$[t]=[new y(`http://${t}`),new y(`https://${t}`)]),$[t]}function M(t,n=U,e){return ut(t)?e&&e.preserveProtocolRelative?t:"http"===w.scheme&&w.authority===G(t).slice(2)?`http:${t}`:`https:${t}`:ct(t)?t:r(F("/"===t[0]?function(t){const n=t.indexOf("//"),e=t.indexOf("/",n+2);if(-1===e)return t;return t.slice(0,e)}(n):n,t))}function Q(t,n=U,e){if(!H(t))return t;const r=_(t),o=r.toLowerCase(),i=_(n).toLowerCase().replace(/\/+$/,""),s=e?_(e).toLowerCase().replace(/\/+$/,""):null;if(s&&0!==i.indexOf(s))return t;const u=(t,n,e)=>-1===(e=t.indexOf(n,e))?t.length:e;let c=u(o,"/",o.indexOf("//")+2),l=-1;for(;o.slice(0,c+1)===i.slice(0,c)+"/"&&(l=c+1,c!==o.length);)c=u(o,"/",c+1);if(-1===l)return t;if(s&&l<s.length)return t;t=r.slice(l);const f=i.slice(l-1).replace(/[^/]+/g,"").length;if(f>0)for(let n=0;n<f;n++)t=`../${t}`;else t=`./${t}`;return t}function _(t){return t=function(t){const n=u.httpsDomains;if(!function(t){return f.test(t)||"http"===w.scheme&&ut(t)}(t))return t;const e=t.indexOf("/",7);let r;r=-1===e?t:t.slice(0,e);if(r=r.toLowerCase().slice(7),p.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}if("http"===w.scheme&&r===w.authority&&!d.test(t))return t;(ht()&&r===w.authority||n&&n.some((t=>r===t||r.endsWith(`.${t}`)))||ht()&&!E(t))&&(t=at(t));return t}(t=function(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}(t=function(t){if(/^https?:\/\//i.test(t)){const n=k(t);t=(t=n.path.replace(/\/{2,}/g,"/")).replace("/","//"),n.query&&(t+=`?${n.query}`)}return t}(t=M(t=t.trim()))))}function F(...t){const n=t.filter(o);if(!n||!n.length)return;const e=[];if(H(n[0])){const t=n[0],o=t.indexOf("//");-1!==o&&(e.push(t.slice(0,o+1)),r=n[0],h.test(r)&&(e[0]+="/"),n[0]=t.slice(o+2))}else"/"===n[0][0]&&e.push("");var r;const i=n.reduce(((t,n)=>n?t.concat(n.split("/")):t),[]);for(let t=0;t<i.length;t++){const n=i[t];".."===n&&e.length>0&&".."!==e[e.length-1]?e.pop():(!n&&t===i.length-1||n&&("."!==n||0===e.length))&&e.push(n)}return e.join("/")}function G(t,n=!1){if(K(t)||V(t))return null;let e=t.indexOf("://");if(-1===e&&ut(t))e=2;else{if(-1===e)return null;e+=3}const r=t.indexOf("/",e);return-1!==r&&(t=t.slice(0,r)),n&&(t=pt(t,!0)),t}function H(t){return ut(t)||ct(t)}function K(t){return null!=t&&"blob:"===t.slice(0,5)}function V(t){return"data:"===t.slice(0,5)}function X(t){const n=tt(t);if(!n||!n.isBase64)return null;const e=atob(n.data),r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return r.buffer}function Y(t){return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const Z=/^data:(.*?)(;base64)?,(.*)$/;function tt(t){const n=t.match(Z);if(!n)return null;const[,e,r,o]=n;return{mediaType:e,isBase64:!!r,data:o}}function nt(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function et(t){const n=X(t);if(!n)return null;const e=tt(t);return new Blob([n],{type:e.mediaType})}function rt(t,n){(function(t,n){const e=et(t);if(!e)return!1;return it(e,n)})(t,n)||function(t,n){const e=et(t);if(!e)return!1;st(e,n)}(t,n)}function ot(t,n){it(t,n)||st(t,n)}function it(t,n){if(!t)return!1;const e=document.createElement("a");if(!("download"in e))return!1;const r=URL.createObjectURL(t);return e.download=n,e.href=r,e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(r),!0}function st(t,n){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(t,n)}function ut(t){return null!=t&&void 0!==t&&"/"===t[0]&&"/"===t[1]}function ct(t){return l.test(t)}function lt(t){return a.test(t)||"https"===w.scheme&&ut(t)}function ft(t){return ut(t)?`http:${t}`:t.replace(a,"http:")}function at(t){return ut(t)?`https:${t}`:t.replace(f,"https:")}function ht(){return"https"===w.scheme}function pt(t,n=!1){return ut(t)?t.slice(2):(t=t.replace(l,""),n&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function dt(t){let n=0;if(H(t)){const e=t.indexOf("//");-1!==e&&(n=e+2)}const e=t.lastIndexOf("/");return e<n?t:t.slice(0,e+1)}function gt(t,n){if(!t)return"";const e=R(t).path.replace(/\/+$/,""),r=e.substring(e.lastIndexOf("/")+1);if(null==n||!n.length)return r;const o=new RegExp(`.(${n.join("|")})$`,"ig");return r.replace(o,"")}function mt(t){return t.replace(/\/+$/,"")}function yt(t,n,e){if(!(n&&e&&t&&H(t)))return t;const r=t.indexOf("//"),o=t.indexOf("/",r+2),i=t.indexOf(":",r+2),s=Math.min(o<0?t.length:o,i<0?t.length:i);if(t.slice(r+2,s).toLowerCase()!==n.toLowerCase())return t;return`${t.slice(0,r+2)}${e}${t.slice(s)}`}function $t(t){return"string"==typeof t?new y(M(t)):(t.scheme||(t.scheme=w.scheme),t)}function xt(t){return Rt.test(t)}function wt(t,n){const e=R(t),r=Object.keys(e.query||{});return r.length>0&&n&&n.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),e.path}function Ot(t,n,e){const r=R(t),o=r.query||{};return o[n]=String(e),`${r.path}?${L(o)}`}function Ut(t,n){const e=R(t),r=e.query||{};for(const t in n)r[t]=n[t];const o=L(r);return o?`${e.path}?${o}`:e.path}function bt(t,n){const{path:e,query:r}=R(t);if(!r)return t;delete r[n];const o=L(r);return o?`${e}?${o}`:e}function Ct(t){if(i(t))return null;const n=t.match(qt);return n?n[1]:null}const qt=/.*?\.([^\/]*)$/,Rt=/(^data:image\/svg|\.svg$)/i;export{y as Url,A as addProxy,P as addProxyRule,Ot as addQueryParameter,Ut as addQueryParameters,Y as base64UrlEncode,yt as changeDomain,tt as dataComponents,X as dataToArrayBuffer,et as dataToBlob,ot as downloadBlobAsFile,rt as downloadDataAsFile,C as getAppBaseUrl,b as getAppUrl,gt as getFilename,T as getInterceptor,G as getOrigin,Ct as getPathExtension,E as getProxyRule,I as getProxyUrl,ct as hasProtocol,W as hasSameOrigin,J as hasSamePortal,H as isAbsolute,ht as isAppHTTPS,K as isBlobProtocol,V as isDataProtocol,lt as isHTTPSProtocol,ut as isProtocolRelative,xt as isSVG,z as isTrustedServer,F as join,M as makeAbsolute,nt as makeData,Q as makeRelative,_ as normalize,L as objectToQuery,j as queryToObject,dt as removeFile,bt as removeQueryParameter,wt as removeQueryParameters,mt as removeTrailingSlash,q as test,ft as toHTTP,at as toHTTPS,$ as trustedServersUrlCache,R as urlToObject};
