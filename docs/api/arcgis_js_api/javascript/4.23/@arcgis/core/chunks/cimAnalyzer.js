/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../Color.js";import{clone as t,i as o}from"../core/lang.js";import{L as i}from"./Logger.js";import{e as r}from"./screenUtils.js";import{n}from"./string.js";import{a,A as l}from"./arcadeOnDemand.js";import{R as s,c,S as f,g as m,d as u,O as p,a as h}from"./CIMSymbolHelper.js";import{C as y,J as g,A as d}from"./enums2.js";import{p as S}from"./floatRGBA.js";import{isExtent as v,isPolyline as N,isPolygon as b}from"../geometry/support/jsonUtils.js";import{f as C,h as k,_ as O,d as M,e as x,j as P,k as w}from"./utils7.js";import{c as L}from"./callExpressionWithFeature.js";function I(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?I(t[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||1!==o.length)return null;const i=o[0];if(!i)return null;const r=i.geometry;if(!r)return null;const n=i.symbol;return!n||"CIMPolygonSymbol"!==n.type&&"CIMLineSymbol"!==n.type||null!=(t=n.symbolLayers)&&t.some((e=>!!e.effects))?null:{geom:r,asFill:"CIMPolygonSymbol"===n.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function X(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return[t,i,o,r]}function z(e){return e?e.rings?X(e.rings):e.paths?X(e.paths):v(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function J(e,t,o,i,r){const[n,a,l,s]=e;if(l<n||s<a)return[0,0,0];const c=l-n,f=s-a,m=Math.floor(31.5),u=(128-2*(m+1))/Math.max(c,f),p=Math.round(c*u)+2*m,h=Math.round(f*u)+2*m;let y=1;if(t){y=h/u/(t.ymax-t.ymin)}let g=0,d=0;if(i)if(r){if(t&&o&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);g=i.x/(o*e),d=i.y/o}}else g=i.x,d=i.y;g=.5*(t.xmax+t.xmin)+g*(t.xmax-t.xmin),d=.5*(t.ymax+t.ymin)+d*(t.ymax-t.ymin),g-=n,d-=a,g*=u,d*=u,g+=m,d+=m;return[y,g/p-.5,-(d/h-.5)]}function A(e){const t=(o=e.geom)?o.rings?o.rings:o.paths?o.paths:void 0!==o.xmin&&void 0!==o.ymin&&void 0!==o.xmax&&void 0!==o.ymax?[[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]]]:null:null;var o;const i=function(e){let t=1/0,o=-1/0,i=1/0,r=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>o&&(o=e[0]),e[1]<i&&(i=e[1]),e[1]>r&&(r=e[1]);return new s(t,i,o-t,r-i)}(t),r=Math.floor(31.5),n=(128-2*(r+1))/Math.max(i.width,i.height),a=Math.round(i.width*n)+2*r,l=Math.round(i.height*n)+2*r,c=[];for(const o of t)if(o&&o.length>1){const t=[];for(const a of o){let[o,l]=a;o-=i.x,l-=i.y,o*=n,l*=n,o+=r-.5,l+=r-.5,e.asFill?t.push([o,l]):t.push([Math.round(o),Math.round(l)])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}c.push(t)}const f=function(e,t,o,i){const r=t*o,n=new Array(r),a=i*i+1;for(let e=0;e<r;++e)n[e]=a;for(const r of e){const e=r.length;for(let a=1;a<e;++a){const e=r[a-1],l=r[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s)-i,p=Math.floor(c)+i,h=Math.floor(f)-i,y=Math.floor(m)+i;u<0&&(u=0),p>t&&(p=t),h<0&&(h=0),y>o&&(y=o);const g=l[0]-e[0],d=l[1]-e[1],S=g*g+d*d;for(let i=u;i<p;i++)for(let r=h;r<y;r++){let a,s,c=(i-e[0])*g+(r-e[1])*d;c<0?(a=e[0],s=e[1]):c>S?(a=l[0],s=l[1]):(c/=S,a=e[0]+c*g,s=e[1]+c*d);const f=(i-a)*(i-a)+(r-s)*(r-s),m=(o-r-1)*t+i;f<n[m]&&(n[m]=f)}}}for(let e=0;e<r;++e)n[e]=Math.sqrt(n[e]);return n}(c,a,l,r);return e.asFill&&function(e,t,o,i,r){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],l=n[a];let s,c,f,m;e[0]<l[0]?(s=e[0],c=l[0]):(s=l[0],c=e[0]),e[1]<l[1]?(f=e[1],m=l[1]):(f=l[1],m=e[1]);let u=Math.floor(s),p=Math.floor(c)+1,h=Math.floor(f),y=Math.floor(m)+1;u<i&&(u=i),p>t-i&&(p=t-i),h<i&&(h=i),y>o-i&&(y=o-i);for(let n=h;n<y;++n){if(e[1]>n==l[1]>n)continue;const a=(o-n-1)*t;for(let t=u;t<p;++t)t<(l[0]-e[0])*(n-e[1])/(l[1]-e[1])+e[0]&&(r[a+t]=-r[a+t]);for(let e=i;e<u;++e)r[a+e]=-r[a+e]}}}}(c,a,l,r,f),[R(f,r),a,l]}function R(e,t){const o=2*t,i=e.length,r=new Uint8Array(4*i);for(let t=0;t<i;++t){const i=.5-e[t]/o;S(i,r,4*t)}return r}class H{static executeEffects(e,t,o){const i=c(t);let r=new f(i);for(const t of e){const e=m(t);e&&(r=e.execute(r,t,1.3333333333333333,o))}return r}static next(e){const t=e.next();return u(t),t}static applyEffects(e,t,o){if(!e)return t;let i=new f(t);for(const t of e){const e=m(t);e&&(i=e.execute(i,t,1,o))}let r,n=null;for(;r=i.next();)n?N(n)?N(r)&&n.paths.push(...r.paths):b(n)&&b(r)&&n.rings.push(...r.rings):n=r;return n}}function Y(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function E(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}(e);return Y(e.family)+(t.length>0?t:"-regular")}const F=i.getLogger("esri.symbols.cim.cimAnalyzer");function $(e){switch(e){case"Butt":return y.BUTT;case"Square":return y.SQUARE;default:return y.ROUND}}function j(e){switch(e){case"Bevel":return g.BEVEL;case"Miter":return g.MITER;default:return g.ROUND}}function T(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function W(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function U(e,t,o,i){let r;e[t]?r=e[t]:(r={},e[t]=r),r[o]=i}function D(e){const t=e.markerPlacement;return t&&t.angleToLine?d.MAP:d.SCREEN}async function G(e,t,o,i,r){const n=null!=i?i:[];if(!e)return n;let l,s;const c={};if("CIMSymbolReference"!==e.type)return F.error("Expect cim type to be 'CIMSymbolReference'"),n;if(l=e.symbol,s=e.primitiveOverrides,s){const e=[];for(const o of s){const i=o.valueExpressionInfo;if(i&&t){const r=i.expression,n=a(r,t.spatialReference,t.fields).then((e=>{e&&U(c,o.primitiveName,o.propertyName,e)}));e.push(n)}else null!=o.value&&U(c,o.primitiveName,o.propertyName,o.value)}e.length>0&&await Promise.all(e)}const f=[];switch(he(l,o,f),f.length>0&&await Promise.all(f),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,o,i,r,n,a){if(!e)return;const l=e.symbolLayers;if(!l)return;const s=e.effects;let c;const f=h.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(c=d.MAP);let m=l.length;for(;m--;){const u=l[m];if(!u||!1===u.enable)continue;let h;s&&s.length&&(h=[...s]);const y=u.effects;y&&y.length&&(s?h.push(...y):h=[...y]);const g=[];let d;p.findEffectOverrides(h,t,g),d=g.length>0?ce(h,g,o,i):h;const S=[];switch(p.findApplicableOverrides(u,t,S),u.type){case"CIMSolidFill":B(u,d,o,S,i,r);break;case"CIMPictureFill":q(u,d,o,S,i,n,r);break;case"CIMHatchFill":V(u,d,o,S,i,r);break;case"CIMGradientFill":_(u,d,o,S,i,r);break;case"CIMSolidStroke":K(u,d,o,S,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMPictureStroke":Q(u,d,o,S,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMGradientStroke":Z(u,d,o,S,i,r,"CIMPolygonSymbol"===e.type,f);break;case"CIMCharacterMarker":if(ee(u,d,o,S,i,r))break;break;case"CIMPictureMarker":if(ee(u,d,o,S,i,r))break;"CIMLineSymbol"===e.type&&(c=D(u)),te(u,d,o,S,i,n,r,c,f);break;case"CIMVectorMarker":if(ee(u,d,o,S,i,r))break;"CIMLineSymbol"===e.type&&(c=D(u)),oe(u,d,o,S,i,r,n,c,f,a);break;default:F.error("Cannot analyze CIM layer",u.type)}}}(l,s,c,t,n,o,r)}return n}function B(e,t,o,i,r,a){const l=e.primitiveName,s=C(e.color),[c,f]=pe(i,l,t,null),m=n(JSON.stringify(e)+f).toString();a.push({type:"fill",templateHash:m,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:se(l,o,"Color",r,s,le),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function q(e,t,i,r,a,l,s){const c=e.primitiveName,f=e.tintColor?C(e.tintColor):{r:255,g:255,b:255,a:1},[m,u]=pe(r,c,t,null),p=n(JSON.stringify(e)+u).toString(),h=n(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let y=k(e.scaleX);if("width"in e){const t=e.width;let i=1;const r=l.getResource(e.url);o(r)&&(i=r.width/r.height),y/=i*(e.height/t)}s.push({type:"fill",templateHash:p,materialHash:m?()=>h:h,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:se(c,i,"TintColor",a,f,le),height:se(c,i,"Height",a,e.height),scaleX:se(c,i,"ScaleX",a,y),angle:se(c,i,"Rotation",a,k(e.rotation)),offsetX:se(c,i,"OffsetX",a,k(e.offsetX)),offsetY:se(c,i,"OffsetY",a,k(e.offsetY)),url:e.url})}function V(e,t,o,i,r,a){const l=["Rotation","OffsetX","OffsetY"],s=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===l.indexOf(t.propertyName))),c=e.primitiveName,[f,m]=pe(i,c,t,null),u=n(JSON.stringify(e)+m).toString(),p=n(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();a.push({type:"fill",templateHash:u,materialHash:f?me(p,o,s,r):p,cim:e,materialOverrides:s,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:se(c,o,"Separation",r,e.separation),scaleX:1,angle:se(c,o,"Rotation",r,k(e.rotation)),offsetX:se(c,o,"OffsetX",r,k(e.offsetX)),offsetY:se(c,o,"OffsetY",r,k(e.offsetY))})}function _(e,t,o,i,r,a){const l=e.primitiveName,[s,c]=pe(i,l,t,null),f=n(JSON.stringify(e)+c).toString();a.push({type:"fill",templateHash:f,materialHash:s?me(f,o,i,r):f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function K(e,t,o,i,r,a,l,s){const c=e.primitiveName,f=C(e.color),m=void 0!==e.width?e.width:4,u=$(e.capStyle),p=j(e.joinStyle),h=e.miterLimit,[y,g]=pe(i,c,t,null),d=n(JSON.stringify(e)+g).toString();let S,v;if(t&&t instanceof Array&&t.length>0){const e=t[t.length-1];if("CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&null===e.offsetAlongLine){const e=(t=[...t]).pop();S=e.dashTemplate,v=e.scaleDash}}a.push({type:"line",templateHash:d,materialHash:y?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:se(c,o,"Color",r,f,le),width:se(c,o,"Width",r,m),cap:se(c,o,"CapStyle",r,u),join:se(c,o,"JoinStyle",r,p),miterLimit:se(c,o,"MiterLimit",r,h),referenceWidth:s,zOrder:ae(e.name),dashTemplate:S,scaleDash:v})}function Q(e,t,o,i,r,a,l,s){const c=n(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),f=e.primitiveName,m=C(e.tintColor),u=void 0!==e.width?e.width:4,p=$(e.capStyle),h=j(e.joinStyle),y=e.miterLimit,[g,d]=pe(i,f,t,null),S=n(JSON.stringify(e)+d).toString();a.push({type:"line",templateHash:S,materialHash:g?()=>c:c,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:se(f,o,"TintColor",r,m,le),width:se(f,o,"Width",r,u),cap:se(f,o,"CapStyle",r,p),join:se(f,o,"JoinStyle",r,h),miterLimit:se(f,o,"MiterLimit",r,y),referenceWidth:s,zOrder:ae(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function Z(e,t,o,i,r,a,l,s){const c=e.primitiveName,f=void 0!==e.width?e.width:4,m=$(e.capStyle),u=j(e.joinStyle),p=e.miterLimit,[h,y]=pe(i,c,t,null),g=n(JSON.stringify(e)+y).toString();a.push({type:"line",templateHash:g,materialHash:h?me(g,o,i,r):g,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:se(c,o,"Width",r,f),cap:se(c,o,"CapStyle",r,m),join:se(c,o,"JoinStyle",r,u),miterLimit:se(c,o,"MiterLimit",r,p),referenceWidth:s,zOrder:ae(e.name),dashTemplate:null,scaleDash:!1})}function ee(e,t,o,i,r,a){const l=e.markerPlacement;if(!l||"CIMMarkerPlacementInsidePolygon"!==l.type)return!1;const s=l,c=["Rotation","OffsetX","OffsetY"],f=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===c.indexOf(t.propertyName))),m="url"in e?e.url:null,[u,p]=pe(i,s.primitiveName,t,null),h=n(JSON.stringify(e)+p).toString();let y=s.stepY,g=null,d=1;return l.shiftOddRows&&(y*=2,g=function(e){return e?2*e:0},d=.5),a.push({type:"fill",templateHash:h,materialHash:u?me(h,o,f,r):h,cim:e,materialOverrides:f,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:se(s.primitiveName,o,"StepY",r,y,g),scaleX:d,angle:se(s.primitiveName,o,"GridAngle",r,s.gridAngle),offsetX:se(s.primitiveName,o,"OffsetX",r,k(s.offsetX)),offsetY:se(s.primitiveName,o,"OffsetY",r,k(s.offsetY)),url:m}),!0}function te(e,t,i,r,a,l,s,c,f){var m;const u=e.primitiveName,p=k(e.size);let h=k(e.scaleX);const y=k(e.rotation),g=k(e.offsetX),d=k(e.offsetY),S=e.tintColor?C(e.tintColor):{r:255,g:255,b:255,a:1},v=n(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),N=fe(e.markerPlacement,r,i,a),[b,O]=pe(r,u,t,N),M=n(JSON.stringify(e)+O).toString(),x=null!=(m=e.anchorPoint)?m:{x:0,y:0};if("width"in e){const t=e.width;let i=1;const r=l.getResource(e.url);o(r)&&(i=r.width/r.height),h/=i*(p/t)}s.push({type:"marker",templateHash:M,materialHash:b?()=>v:v,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:c,size:se(u,i,"Size",a,p),scaleX:se(u,i,"ScaleX",a,h),rotation:se(u,i,"Rotation",a,y),offsetX:se(u,i,"OffsetX",a,g),offsetY:se(u,i,"OffsetY",a,d),color:se(u,i,"TintColor",a,S,le),anchorPoint:{x:x.x,y:-x.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:f,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function oe(e,t,o,i,r,n,a,l,s,c){const f=e.markerGraphics;if(!f)return;let m=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(m=t.ymax-t.ymin)}const u=fe(e.markerPlacement,i,o,r);for(const p of f)if(p){const f=p.symbol;if(!f)continue;switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":re(e,t,u,p,i,o,r,n,a,l,s,m,c);break;case"CIMTextSymbol":ie(e,t,u,p,o,i,r,n,l,s,m)}}}function ie(e,t,o,i,r,a,l,s,c,f,m){p.findApplicableOverrides(i,a,[]);const u=i.geometry;if(!("x"in u)||!("y"in u))return;const y=i.symbol,g=(d=y).underline?"underline":d.strikethrough?"line-through":"none";var d;const S=function(e){let t="",o="";if(e){const i=e.toLowerCase();-1!==i.indexOf("italic")?t="italic":-1!==i.indexOf("oblique")&&(t="oblique"),-1!==i.indexOf("bold")?o="bold":-1!==i.indexOf("light")&&(o="lighter")}return{style:t,weight:o}}(y.fontStyleName),v=Y(y.fontFamilyName);y.font={family:v,decoration:g,...S};const N=e.frame,b=u.x-.5*(N.xmin+N.xmax),P=u.y-.5*(N.ymin+N.ymax),w=e.size/m,L=e.primitiveName,I=k(y.height)*w,X=k(y.angle),z=k(e.offsetX)+(k(y.offsetX)+b)*w,J=k(e.offsetY)+(k(y.offsetY)+P)*w,A=C(h.getFillColor(y));let R=C(h.getStrokeColor(y)),H=h.getStrokeWidth(y);H||(R=C(h.getFillColor(y.haloSymbol)),H=y.haloSize*w);const[E,F]=pe(a,L,t,o),$=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),j=n(JSON.stringify(i)+$+F).toString();let U=se(i.primitiveName,r,"TextString",l,i.textString,O,y.textCase);if(null==U)return;const{fontStyleName:D}=y,G=v+(D?"-"+D.toLowerCase():"-regular"),B=G;"string"==typeof U&&U.indexOf("[")>-1&&y.fieldMap&&(U=M(y.fieldMap,U,y.textCase)),s.push({type:"text",templateHash:j,materialHash:E||"function"==typeof U||U.match(/\[(.*?)\]/)?(e,t,o)=>B+"-"+x(U,e,t,o):B+"-"+n(U),cim:y,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:c,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:G,decoration:g,weight:se(L,r,"Weight",l,S.weight),style:se(L,r,"Size",l,S.style),size:se(L,r,"Size",l,I),angle:se(L,r,"Rotation",l,X),offsetX:se(L,r,"OffsetX",l,z),offsetY:se(L,r,"OffsetY",l,J),horizontalAlignment:T(y.horizontalAlignment),verticalAlignment:W(y.verticalAlignment),text:U,color:A,outlineColor:R,outlineSize:H,referenceSize:f,sizeRatio:1,markerPlacement:o})}function re(e,t,i,r,a,l,s,c,f,m,u,p,y){const g=r.symbol,d=g.symbolLayers;if(!d)return;if(y)return void ne(e,t,i,r,l,a,s,c,f,m,u,p);let S=d.length;if(ye(d))return void function(e,t,o,i,r,a,l,s,c,f,m,u){const p=i.geometry,y=r[0],g=r[1],d=z(p);if(!d)return;const[S,v,N]=J(d,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),b={type:"sdf",geom:p,asFill:!0},O=e.primitiveName,M=k(e.size),x=k(e.rotation),P=k(e.offsetX),w=k(e.offsetY),L=g.path,I=g.primitiveName,X=y.primitiveName,A=C(h.getFillColor(g)),R=C(h.getStrokeColor(y)),H=h.getStrokeWidth(y);let Y=!1,E="";for(const e of a)e.primitiveName!==I&&e.primitiveName!==X&&e.primitiveName!==O||(void 0!==e.value?E+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(Y=!0));const F=JSON.stringify({...e,markerGraphics:null}),$=n(JSON.stringify(b)+L).toString(),j={type:"marker",templateHash:n(JSON.stringify(i)+JSON.stringify(g)+JSON.stringify(y)+F+E).toString(),materialHash:Y?()=>$:$,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:v,y:N},isAbsoluteAnchorPoint:!1,size:se(e.primitiveName,l,"Size",s,M),rotation:se(e.primitiveName,l,"Rotation",s,x),offsetX:se(e.primitiveName,l,"OffsetX",s,P),offsetY:se(e.primitiveName,l,"OffsetY",s,w),scaleX:1,frameHeight:u,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:S,color:se(I,l,"Color",s,A,le),outlineColor:se(X,l,"Color",s,R,le),outlineWidth:se(X,l,"Width",s,H),markerPlacement:o,path:L};c.push(j)}(e,t,i,r,d,a,l,s,c,m,u,p);const v=H.applyEffects(g.effects,r.geometry,f.geometryEngine);if(v)for(;S--;){const y=d[S];if(y&&!1!==y.enable)switch(y.type){case"CIMSolidFill":case"CIMSolidStroke":{var N;const g=H.applyEffects(y.effects,v,f.geometryEngine),d=z(g);if(!d)continue;const[S,b,O]=J(d,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),M="CIMSolidFill"===y.type,x={type:"sdf",geom:g,asFill:M},P=e.primitiveName,w=null!=(N=k(e.size))?N:10,L=k(e.rotation),I=k(e.offsetX),X=k(e.offsetY),A=y.path,R=y.primitiveName,Y=C(M?h.getFillColor(y):h.getStrokeColor(y)),E=M?{r:0,g:0,b:0,a:0}:C(h.getStrokeColor(y)),F=h.getStrokeWidth(y);if(!M&&!F)break;let $=!1,j="";for(const e of a)e.primitiveName!==R&&e.primitiveName!==P||(void 0!==e.value?j+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&($=!0));o(t)&&"function"==typeof t&&($=!0);const T=JSON.stringify({...e,markerGraphics:null}),W=n(JSON.stringify(x)+A).toString(),U={type:"marker",templateHash:n(JSON.stringify(r)+JSON.stringify(y)+T+j).toString(),materialHash:$?()=>W:W,cim:x,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:m,anchorPoint:{x:b,y:O},isAbsoluteAnchorPoint:!1,size:se(e.primitiveName,l,"Size",s,w),rotation:se(e.primitiveName,l,"Rotation",s,L),offsetX:se(e.primitiveName,l,"OffsetX",s,I),offsetY:se(e.primitiveName,l,"OffsetY",s,X),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:u,sizeRatio:S,color:se(R,l,"Color",s,Y,le),outlineColor:se(R,l,"Color",s,E,le),outlineWidth:se(R,l,"Width",s,F),markerPlacement:i,path:A};c.push(U);break}default:ne(e,t,i,r,l,a,s,c,f,m,u,p)}}}function ne(e,t,i,a,l,s,c,f,m,u,p,y){const g=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}(e,a);let d=[];const S=["Rotation","OffsetX","OffsetY"];d=s.filter((t=>t.primitiveName!==e.primitiveName||-1===S.indexOf(t.propertyName)));let v="";for(const e of s)void 0!==e.value&&(v+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[N,b,C]=h.getTextureAnchor(g,m),O=e.primitiveName,M=k(e.rotation),x=k(e.offsetX),P=k(e.offsetY),w=n(JSON.stringify(g)+v).toString(),L={type:"marker",templateHash:w,materialHash:d.length>0||o(t)&&"function"==typeof t?me(w,l,d,c):w,cim:g,materialOverrides:d,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:N,y:b},isAbsoluteAnchorPoint:!1,size:e.size,rotation:se(O,l,"Rotation",c,M),offsetX:se(O,l,"OffsetX",c,x),offsetY:se(O,l,"OffsetY",c,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:y,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:C/r(e.size),markerPlacement:i};f.push(L)}function ae(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function le(t){if(!t||0===t.length)return null;const o=new e(t).toRgba();return{r:o[0],g:o[1],b:o[2],a:o[3]}}function se(e,t,o,i,r,n,a){const s=t[e];if(s){const e=s[o];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,a):e;if(null!=e&&e instanceof l)return(t,o,l)=>{let s=L(e,t,{$view:l},i.geometryType,o);return null!==s&&n&&(s=n.call(null,s,a)),null!==s?s:r}}return r}function ce(e,o,i,r){for(const e of o){if(e.valueExpressionInfo){const t=i[e.primitiveName]&&i[e.primitiveName][e.propertyName];t instanceof l&&(e.fn=(e,o,i)=>L(t,e,{$view:i},r.geometryType,o))}}return(i,r,n)=>{for(const e of o)e.fn&&(e.value=e.fn(i,r,n));const a=[];for(let i of e){var l;const e=null==(l=i)?void 0:l.primitiveName;if(e){let r=!1;for(const n of o)if(n.primitiveName===e){const e=(s=n.propertyName)?s.charAt(0).toLowerCase()+s.substr(1):s;null!=n.value&&n.value!==i[e]&&(r||(i=t(i),r=!0),i[e]=n.value)}}a.push(i)}var s;return a}}function fe(e,o,i,r){const n=[];if(p.findApplicableOverrides(e,o,n),0===n.length)return e;for(const e of n){if(e.valueExpressionInfo){const t=i[e.primitiveName]&&i[e.primitiveName][e.propertyName];t instanceof l&&(e.fn=(e,o,i)=>L(t,e,{$view:i},r.geometryType,o))}}return(o,i,r)=>{for(const e of n)e.fn&&(e.value=e.fn(o,i,r));const a=t(e),l=e.primitiveName;for(const e of n)if(e.primitiveName===l){const t=(s=e.propertyName)?s.charAt(0).toLowerCase()+s.substr(1):s;null!=e.value&&e.value!==a[t]&&(a[t]=e.value)}var s;return a}}function me(e,t,o,i){for(const e of o){if(e.valueExpressionInfo){const o=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];o instanceof l&&(e.fn=(e,t,r)=>L(o,e,{$view:r},i.geometryType,t))}}return(t,i,r)=>{for(const e of o)e.fn&&(e.value=e.fn(t,i,r));return n(e+p.buildOverrideKey(o)).toString()}}function ue(e,t){if(!t||0===t.length)return e;const o=JSON.parse(JSON.stringify(e));return p.applyOverrides(o,t),o}function pe(e,t,i,r){let n=!1,a="";for(const o of e)o.primitiveName===t&&(void 0!==o.value?a+=`-${o.primitiveName}-${o.propertyName}-${JSON.stringify(o.value)}`:o.valueExpressionInfo&&(n=!0));return o(i)&&"function"==typeof i&&(n=!0),o(r)&&"function"==typeof r&&(n=!0),[n,a]}function he(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const i=e.symbolLayers;if(!i)return;for(const e of i)switch(de(e,t,o),e.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in e&&e.url&&o.push(t.fetchResource(e.url,null));break;case"CIMVectorMarker":{const i=e.markerGraphics;if(!i)continue;for(const e of i)if(e){const i=e.symbol;i&&he(i,t,o)}}}}}}const ye=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&!e[0].effects&&!e[1].effects;let ge;function de(e,t,i){if(!e.effects||o(t.geometryEngine))return;if(ge)return void i.push(ge);P(e.effects)&&(ge=w(),i.push(ge),ge.then((e=>t.geometryEngine=e)))}export{H as C,G as a,ue as b,A as c,E as d,I as g};
