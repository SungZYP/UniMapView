/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{r as t,I as s,x as n,i as r,d as i,clone as o,b as a,o as l}from"../core/lang.js";import{f as u,h as c,l as h,b as f}from"../geometry/SpatialReference.js";import{i as m,g as p}from"./layerUtils.js";import{V as d}from"./ViewingMode.js";import{_ as g}from"./tslib.es6.js";import _ from"../request.js";import k from"../core/Accessor.js";import y from"../core/Error.js";import{createResolver as b,onAbort as T,createAbortError as L,throwIfAborted as w,isAbortError as E}from"../core/promiseUtils.js";import{property as v}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as I}from"../core/accessorSupport/decorators/subclass.js";import{a as W}from"./Util.js";import{T as x}from"./Scheduler.js";import{b as D,j as S,h as C,d as O,f as Q,e as j}from"./mathUtils.js";import{canProjectToWGS84ComparableLonLat as N}from"../geometry/projection.js";import{k as A,l as R,m as M,b as q}from"./aaBoundingRect.js";import{g as z,T as U,M as F}from"./TerrainConst.js";class G{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new B}}class B{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class V{constructor(e,t,s,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=n.map((e=>new G(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,W(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}let P=class extends k{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new V(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(x.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=t(this._frameTask),this._tasks.forEach((e=>s(e.abortController))),this._loadQueue=n(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,n={}){const i=b();i.__signal=r(n)?n.signal:null;const o=this._createOrUpdateTask(e,t,s,n,i);return T(n,(()=>this._cancelRequest(o,i))),i.promise}_createTask(e,t,s,n,r,i){const o=new J(e,t,s,n,r);return this._updateTask(o,i),this._tasks.set(r,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){i(e.resolvers,t),t.reject(L()),0===e.resolvers.length&&(e.status===K.DOWNLOADING&&(e.status=K.CANCELLED,this._loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=K.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,n,i){const o=function(e,t,s){return`${e}:${t}:${s}`}(r(n)&&n.uid||e,t,s),a=this._tasks.get(o);return a?(this._updateTask(a,i),a):this._createTask(e,n,t,s,o,i)}_doneLoadingCB(e,t){this._loadQueue&&(W(e.status===K.DOWNLOADING),e.status=K.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();w(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==K.DOWNLOADED&&(t.err=t.err||L()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!E(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const n of e.resolvers)if(t)E(t)?n.reject(t):n.reject(new y("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:o(e.result);n.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===K.CANCELLED)return!1;let s,n;switch(e.startTime=performance.now(),e.status=K.DOWNLOADING,e.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=_(e.url,{...e.options,responseType:n,timeout:s,signal:r});let i=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=s=>{e.status===K.DOWNLOADING&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),a),!0):(e.request.then((t=>{const l=t.data,u=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(l);if(n="image",e.size=l.byteLength,"unknown"===u)return e.request=_(e.url,{responseType:n,timeout:s,signal:r}),void e.request.then((e=>o(e.data)),a);const c=new Blob([l],{type:u}),h=window.URL.createObjectURL(c);i=()=>window.URL.revokeObjectURL(h),e.request=_(h,{responseType:n,timeout:s,signal:r}),e.request.then((e=>o(new H(e.data,u,i))),a)}),a),!0)}get test(){return{loadQueue:this._loadQueue}}};g([v({readOnly:!0})],P.prototype,"updating",void 0),P=g([I("esri.views.3d.support.StreamDataLoader")],P);const $=0;class H{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}class J extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,s,n,r){super(n),this.url=e,this.options=t,this.docType=s,this.key=r,this.result=null,this.status=K.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=$}}var K;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(K||(K={}));const X=D(),Y=D(),Z=D(),ee=D();function te(e,t,s,n){S(X,s),X[n]=t[n];const r=C(X,X,t),i=C(Y,e,t),o=O(i,r),a=O(r,r);let l;l=o<=0?t:a<=o?s:Q(X,t,j(r,r,o/a));const u=C(X,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const se=Object.freeze({__proto__:null,isInsideExtent:function(e,t,s=0){const n=e.extent;if(a(n))return!1;if(0===s)return A(n,t);const r=Math.min(n[2]-n[0],n[3]-n[1]);return R(n,t,s*r)},tiltToExtentEdge:function(e,t,s){const n=e.extent;if(a(n))return 0;Z[0]=n[0],Z[1]=n[1],Z[2]=s,ee[0]=n[2],ee[1]=n[3],ee[2]=s;let r=1/0,i=1/0;return t[0]<Z[0]?r=te(t,Z,ee,0):t[0]>ee[0]&&(r=te(t,ee,Z,0)),t[1]<Z[1]?i=te(t,Z,ee,1):t[1]>ee[1]&&(i=te(t,ee,Z,1)),Math.min(r,i)},checkIfTileInfoSupportedForViewSR:function(e,t,s){if(a(e))return z();if(e.spatialReference.isGeographic&&!N(e.spatialReference))return new y("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=U.checkUnsupported(e);if(r(n))return n;const i=function(e,t){const s=e.lods,n=s[0].resolution*2**s[0].level,r=[n*e.size[0],n*e.size[1]],i=[e.origin.x,e.origin.y],o=M(t),a=q();U.computeRowColExtent(o,r,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>F){const t=s[0].scale*2**s[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/n;const i=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**i)*10**i,new y("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:l,allowedNumRootTiles:F})}return null}(e,s);if(i)return i;const o=e.spatialReference;return t&&!(o.equals(t)||t.isWGS84&&o.isWebMercator)?new y("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}});const ne=Object.freeze({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){if(a(e))return z();const s=e.lods.length-1,n=e.spatialReference,r=N(n)||u(n)||c(n);if(n.isWebMercator){if(!U.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new y("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!r)return new y("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!U.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new y("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new y("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return t&&!e.spatialReference.equals(t)?new y("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}}),re={[d.Global]:ne,[d.Local]:se};function ie(e,t){e||console.warn("Terrain: "+t)}const oe=80/180*Math.PI,ae=110/180*Math.PI;function le(e,t,s){const n=re[e.viewingMode];let i;if(n.isInsideExtent(e,t))i=l(e.getElevation(t[0],t[1],t[1],e.spatialReference),0);else{if(!n.isInsideExtent(e,t,1.2))return 0;const s=e.getTileWithElevation(t[0],t[1],t[1],e.spatialReference);i=.5*((r(s)?s.elevationBounds[0]:e.elevationBounds.min)+(r(s)?s.elevationBounds[1]:e.elevationBounds.max));const o=n.tiltToExtentEdge(e,t,i);if(o>oe&&o<ae)return 0}const o=t[2]-i;return Math.abs(o)<s?0:o<0?-1:1}function ue(e){return fe(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function ce(e){return"vector-tile"===(null==e?void 0:e.type)}function he(e){return"imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function fe(e){return"imagery-tile-3d"===(null==e?void 0:e.type)}function me(e){return"tile-3d"===(null==e?void 0:e.type)}function pe(e){return"vector-tile-3d"===(null==e?void 0:e.type)}function de(e){return"elevation-3d"===(null==e?void 0:e.type)}function ge(e){return e&&(me(e)||fe(e)||de(e)||pe(e)||function(e){return"wmts-3d"===(null==e?void 0:e.type)}(e))}function _e(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return r(s)&&"type"in s&&"raster-tile"===s.type}function ke(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return r(s)&&"type"in s&&"vector-tile"===s.type}function ye(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return r(s)&&"type"in s&&"tile-texture"===s.type}function be(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return s instanceof HTMLImageElement||s instanceof H||s instanceof HTMLCanvasElement||s instanceof ImageData}function Te(e){return r(e)&&"release"in e&&e.release(),null}function Le(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function we(e,t,s,n){return re[n].checkIfTileInfoSupportedForViewSR(e,s,t)}function Ee(e,t,s){let n=null,i=null;if(m(e)){const r=ve(e,t,s);n=r.tileInfo,i=r.fullExtent}else{i=he(e)?e.getCompatibleFullExtent(t):e.fullExtent;const r=s===d.Local;if(he(e))n=e.getCompatibleTileInfo(t,i,r);else if(ce(e)){const s=r&&!Ie(t)||We.force512VTL,i=e.tileInfo.spatialReference.isGeographic;n=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,i?1:2)}else n=e.tileInfo}return r(n)&&r(i)&&null==we(n,i,t,s)?{tileInfo:n,fullExtent:i}:null}function ve(t,s,n){const i=p(t);if(r(i)){if(!e.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const e=i.find((e=>null==we(e.tileInfo,e.fullExtent,s,n)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Ie(e){return e.isWGS84||e.isWebMercator||h(e)||!f(e)}const We={force512VTL:!1};export{H as I,P as S,he as a,ue as b,we as c,pe as d,ke as e,_e as f,Ee as g,be as h,ge as i,ye as j,ce as k,le as l,de as m,fe as n,me as o,ve as p,Te as r,We as t,Le as u,Ie as v,ie as w};
