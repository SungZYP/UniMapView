/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{i as t,h as i,u as r,b as l,o as n,clone as s}from"../core/lang.js";import{L as o}from"./Logger.js";import{t as a,e as u}from"./screenUtils.js";import{x as d}from"./Utils16.js";import{b as f}from"./enums4.js";import{g as p}from"./visualVariablesUtils2.js";import{createSymbolSchema as c}from"./createSymbolSchema.js";import{R as m}from"./CIMSymbolHelper.js";import{I as y}from"./definitions.js";import"./shapingUtils.js";import"../geometry/Polygon.js";import"./mathUtils.js";import"../geometry/Extent.js";import"./normalizeUtilsCommon.js";import"./alignmentUtils.js";import"./vec2f32.js";import"./number2.js";import"./cimAnalyzer.js";import"./ExpandedCIM.js";import"../core/urlUtils.js";import"../portal/Portal.js";import"./persistableUrlUtils.js";import"../request.js";import"../portal/PortalQueryParams.js";import{c as g}from"./clusterUtils2.js";import{t as b}from"./util2.js";function x(e,t){return Math.max(e,t)}y.metrics,new m(0,0,24,24);const v=o.getLogger("esri.renderers.visualVariables.support.utils"),h=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),i=t.visualVariables.map((e=>E(e)?V(e):e));return t.visualVariables=i,t};function w(e){return e.map((e=>E(e)?V(e.clone()):e))}function E(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function V(e){return e.stops=function(e,t){if(t.length<=8)return t;if(v.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16)return function(e,t){const[i,...r]=t,l=r.pop(),n=r[0].value,s=r[r.length-1].value,o=(s-n)/6,u=[];for(let i=n;i<s;i+=o){let l=0;for(;i>=r[l].value;)l++;const n=r[l],s=t[l-1],o=i-s.value,d=n.value===s.value?1:o/(n.value-s.value);if("color"===e){const e=r[l],n=t[l-1],s=e.color.clone();s.r=z(n.color.r,s.r,d),s.g=z(n.color.g,s.g,d),s.b=z(n.color.b,s.b,d),s.a=z(n.color.a,s.a,d),u.push({value:i,color:s,label:e.label})}else if("size"===e){const e=r[l],n=t[l-1],s=a(e.size),o=z(a(n.size),s,d);u.push({value:i,size:o,label:e.label})}else{const e=r[l],n=z(t[l-1].opacity,e.opacity,d);u.push({value:i,opacity:n,label:e.label})}}return[i,...u,l]}(e,t);return function(e){const[t,...i]=e,r=i.pop();for(;i.length>6;){let e=0,t=0;for(let r=1;r<i.length;r++){const l=i[r-1],n=i[r],s=Math.abs(n.value-l.value);s>t&&(t=s,e=r)}i.splice(e,1)}return[t,...i,r]}(t)}(e.type,e.stops),e}function z(e,t,i){return(1-i)*e+i*t}const I=o.getLogger("esri.views.2d.layers.features.schemaUtils"),S={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function F(e){let i=0,r=0,l=!1,n=!0,s=!0;if(t(e)){if(r=function(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const i=t[0];if("outline"===i.target)return 0;if("stops"===i.transformationType)return i.stops.map((e=>e.size)).reduce(x,0);if("clamped-linear"===i.transformationType){let e=-1/0,t=-1/0;return e="number"==typeof i.maxSize?i.maxSize:i.maxSize.stops.map((e=>e.size)).reduce(x,0),t="number"==typeof i.minSize?i.minSize:i.minSize.stops.map((e=>e.size)).reduce(x,0),Math.max(e,t)}return"real-world-size"===i.transformationType?30:void 0}(e),"visualVariables"in e&&(i=function(e){if(!e)return f.NONE;let t=0;for(const i of e)if("size"===i.type){const e=p(i);t|=e,"outline"===i.target&&(t|=e<<4)}else"color"===i.type?t|=f.COLOR:"opacity"===i.type?t|=f.OPACITY:"rotation"===i.type&&(t|=f.ROTATION);return t}(e.visualVariables||[]),l="dot-density"===e.type),"dictionary"===e.type)return{maxVVSize:r,supportsOutlineFills:!1,vvFlags:i,stride:{fill:"default"}};if(!l){const t=e.getSymbols();"backgroundFillSymbol"in e&&e.backgroundFillSymbol&&t.push(e.backgroundFillSymbol);for(const e of t)if("cim"===e.type&&(n=!1),"simple-fill"===e.type||"picture-fill"===e.type){const t=e.outline;t&&"none"!==t.style&&"solid"!==t.style&&(s=!1);const i=t&&"none"!==t.style&&"solid"!==t.style,r="simple-fill"===e.type&&"none"!==e.style&&"solid"!==e.style;("picture-fill"===e.type||r||i)&&(n=!1)}}}return l&&(s=!1),{vvFlags:i,maxVVSize:r,supportsOutlineFills:s,stride:{fill:l?"dot-density":n?"simple":"default"}}}function T(t,i){const r=s(t),l=r.some((t=>function(t,i){const r=t.labelPlacement,l=S[i];if(!t.symbol)return I.warn("No ILabelClass symbol specified."),!0;if(!l)return I.error(new e("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${i} is not supported`)),!0;if(!l.some((e=>e===r))){const e=l[0];r&&I.warn(`Found invalid label placement type ${r} for ${i}. Defaulting to ${e}`),t.labelPlacement=e}return!1}(t,i)));return l?[]:r}function j(e){return i("esri-2d-update-debug")&&console.debug("Created new schema",M(e,!0)),M(e)}function M(i,r=!1){try{var n,s;const o=function(i,r=!1){const n=new Array;return n.push(function(i,r,n=!1){const s={indexCount:0,fields:{}},o="featureReduction"in i&&i.featureReduction,a=o?"aggregate":"feature";if("sublayers"in i){const r={type:"subtype",subtypeField:i.subtypeField,renderers:{},stride:{fill:"default"}},l={type:"subtype",mapping:{},target:"feature"},o={type:"subtype",classes:{}},u={type:"symbol",target:"feature",aggregateFields:[],attributes:s,storage:l,mesh:{matcher:r,aggregateMatcher:null,labels:o,sortKey:null}},d=new Set;let f=0;for(const{renderer:u,subtypeCode:p,labelingInfo:c,labelsVisible:m}of i.sublayers){const i=B(s,a,u,n),y=k(s,a,u),g=m&&c;if("visualVariables"in u&&u.visualVariables&&u.visualVariables.length)throw new e("ValidationError","Visual variables are currently not supported for subtype layers");if("dictionary"===i.type)throw new e("ValidationError","Dictionary renderer is not supported in subtype layers");if("subtype"===i.type)throw new e("ValidationError","Nested subtype renderers is not supported");if(t(y)&&"subtype"===y.type)throw new e("ValidationError","Nested subtype storage is not supported");if(t(y)&&"dot-density"===y.type)throw new e("ValidationError","Dot density attributes are not supported in subtype layers");if(d.has(p))throw new e("ValidationError","Subtype codes for sublayers must be unique");d.add(p),r.renderers[p]=i,l.mapping[p]=y,g&&(o.classes[p]=g.map((e=>U(u,s,e,"feature",f++,n))))}return u}if("heatmap"===i.renderer.type){const{blurRadius:e,fieldOffset:t,field:r}=i.renderer;return{type:"heatmap",aggregateFields:[],attributes:s,target:a,storage:null,mesh:{blurRadius:e,fieldOffset:t,field:P(s,{target:a,field:r,resultType:"numeric"}).field}}}{const t=[],r="aggregate"===a?g(t,i.renderer,o,null):i.renderer;!function(e,t){const i={mesh:!0,storage:!0};for(const r of t){const{name:t,outStatistic:l}=r,{statisticType:n,onStatisticField:s}=l;let o=null,a=null,u=null;const d="numeric",f="feature";if("onStatisticValueExpression"in l){a=C(e,{type:"expression",target:f,valueExpression:l.onStatisticValueExpression,resultType:d}).fieldIndex}else if("onStatisticNormalizationField"in l){o=C(e,{type:"field",target:f,field:s,resultType:d}).field,u=l.onStatisticNormalizationField}else{o=C(e,{type:"field",target:f,field:s,resultType:d}).field}C(e,{type:"statistic",target:"aggregate",name:t,context:i,inField:o,inNormalizationField:u,inFieldIndex:a,statisticType:n})}}(s,t);const u=B(s,a,r,n);let d=null;const f=k(s,a,r),p=b(i.geometryType);let m=i.labelsVisible&&i.labelingInfo||[],y=[];if(o){if("selection"===o.type)throw new e("ValidationError","Mapview does not support `selection` reduction type",o);if(o.symbol){const e=F(r);d={type:"simple",symbol:c(o.symbol,e,n),stride:e.stride}}y=o&&o.labelsVisible&&o.labelingInfo||[]}m=T(m,p),y=T(y,p);let x=0;const v=[...m.map((e=>U(r,s,e,"feature",x++,n))),...y.map((e=>U(r,s,e,"aggregate",x++,n)))],h=function(t,i){if(l(i)||!i.length)return null;i.length>1&&I.warn(`Layer rendering currently only supports ordering by 1 orderByInfo, but found ${i.length}. All but the first will be discarded`);const r=i[0],n="ascending"===r.order?"asc":"desc";if(r.field)return{field:r.field,order:n};if(r.valueExpression){return{fieldIndex:C(t,{type:"expression",target:"feature",valueExpression:r.valueExpression,resultType:"numeric"}).fieldIndex,order:n}}return I.error(new e("ValidationError","Expected to find a field or valueExpression for OrderByInfo",r)),null}(s,i.orderBy);return{type:"symbol",target:a,attributes:s,aggregateFields:t,storage:f,mesh:{matcher:u,labels:{type:"simple",classes:v},aggregateMatcher:d,sortKey:h}}}}(i,r)),n}(i,r),a={};o.map((t=>function(t,i,r){switch(r.target){case"feature":return void R(t,O(i),r);case"aggregate":{if(!("featureReduction"in i))return;const l=i.featureReduction;if("selection"===l.type)throw new e("ValidationError","Mapview does not support `selection` reduction type",l);return R(t,O(i),r),void function(e,t,i){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:u(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(u(t.clusterMaxSize)/64),fields:i.aggregateFields}});N(e.aggregate,i.attributes.fields)}(t,l,r)}}}(a,i,t)));return{source:{definitionExpression:i.definitionExpression,fields:i.fields.map((e=>e.toJSON())),gdbVersion:i.gdbVersion,historicMoment:null==(n=i.historicMoment)?void 0:n.getTime(),outFields:i.availableFields,pixelBuffer:i.pixelBuffer,spatialReference:i.spatialReference.toJSON(),timeExtent:null==(s=i.timeExtent)?void 0:s.toJSON(),customParameters:i.customParameters},attributes:{fields:{},indexCount:0},processors:o,targets:a}}catch(e){if("ValidationError"===e.fieldName)return I.error(e),null;throw e}}function N(e,t){for(const i in t){const r=t[i];if(r.target!==e.name)continue;const l=e.attributes[i];l?(l.context.mesh=l.context.mesh||r.context.mesh,l.context.storage=l.context.storage||r.context.storage):e.attributes[i]=r}return e}function O(e){var t,i,l,n,s;return[null!=(t=null==(i=r(e.filter))?void 0:i.toJSON())?t:null,null!=(l=null==(n=r(null==(s=r(e.featureEffect))?void 0:s.filter))?void 0:n.toJSON())?l:null]}function R(e,t,i){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),N(e.feature,i.attributes.fields),e}function P(e,t){return t.field?C(e,{...t,type:"field",field:t.field}):t.valueExpression?C(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function C(e,t){switch(t.type){case"expression":{const i=t.valueExpression;if(!e.fields[i]){const r=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:r}}return{fieldIndex:e.fields[i].fieldIndex}}case"label-expression":{const i=JSON.stringify(t.label);if(!e.fields[i]){const r=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:r}}return{fieldIndex:e.fields[i].fieldIndex}}case"field":{const i=t.field;return"aggregate"===t.target&&e.fields[i]||(e.fields[i]={...t,name:i}),{field:i}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function U(e,t,i,r,l,n=!1){const s=C(t,{type:"label-expression",target:r,context:{mesh:!0},resultType:"string",label:{labelExpression:i.labelExpression,labelExpressionInfo:i.labelExpressionInfo?{expression:i.labelExpressionInfo.expression}:null,symbol:!!i.symbol,where:i.where}}),{fieldIndex:o}=s,a=F(e);return{...c(i,a,n),fieldIndex:o,target:r,index:l}}function k(e,t,i){switch(i.type){case"dot-density":return function(e,t,i){if(!i||!i.length)return{type:"dot-density",mapping:[],target:t};return{type:"dot-density",mapping:i.map(((i,r)=>{const{field:l,fieldIndex:n}=P(e,{valueExpression:i.valueExpression,field:i.field,resultType:"numeric",target:t});return{binding:r,field:l,fieldIndex:n}})),target:t}}(e,t,i.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return function(e,t,i){if(!i||!i.length)return{type:"visual-variable",mapping:[],target:t};const r={storage:!0},l="numeric";return{type:"visual-variable",mapping:w(i).map((i=>{var n;const s=d(i.type),{field:o,fieldIndex:a}=P(e,{target:t,valueExpression:i.valueExpression,field:i.field,context:r,resultType:l});switch(i.type){case"size":return"$view.scale"===i.valueExpression?null:{type:"size",binding:s,field:o,fieldIndex:a,normalizationField:P(e,{target:t,field:i.normalizationField,context:r,resultType:l}).field,valueRepresentation:null!=(n=i.valueRepresentation)?n:null};case"color":return{type:"color",binding:s,field:o,fieldIndex:a,normalizationField:P(e,{target:t,field:i.normalizationField,context:r,resultType:l}).field};case"opacity":return{type:"opacity",binding:s,field:o,fieldIndex:a,normalizationField:P(e,{target:t,field:i.normalizationField,context:r,resultType:l}).field};case"rotation":return{type:"rotation",binding:s,field:o,fieldIndex:a}}})).filter((e=>e)),target:t}}(e,t,i.visualVariables);case"heatmap":return null}}function B(t,i,r,l=!1){const s=n(t,{indexCount:0,fields:{}});switch(r.type){case"simple":case"dot-density":return function(e,t,i=!1){const r=t.getSymbols(),l=r.length?r[0]:null,n=F(t);return{type:"simple",symbol:c(l,n,i),stride:n.stride}}(0,r,l);case"class-breaks":return function(e,t,i,r=!1){const l={mesh:!0,use:"renderer.field"},n=i.backgroundFillSymbol,{field:s,fieldIndex:o}=P(e,{target:t,field:i.field,valueExpression:i.valueExpression,resultType:"numeric",context:l}),a=i.normalizationType,u="log"===a?"esriNormalizeByLog":"percent-of-total"===a?"esriNormalizeByPercentOfTotal":"field"===a?"esriNormalizeByField":null,d=F(i),f=i.classBreakInfos.map((e=>({symbol:c(e.symbol,d,r),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:s,fieldIndex:o,backgroundFillSymbol:c(n,d,r),defaultSymbol:c(i.defaultSymbol,d,r),intervals:f,normalizationField:i.normalizationField,normalizationTotal:i.normalizationTotal,normalizationType:u,isMaxInclusive:i.isMaxInclusive,stride:d.stride}}(s,i,r,l);case"unique-value":return function(t,i,r,l=!1){const n=[],s=r.backgroundFillSymbol,o={target:i,context:{mesh:!0},resultType:"string"};if(r.field&&"string"!=typeof r.field)throw new e("ValidationError","Expected renderer.field to be a string",r);const{field:a,fieldIndex:u}=P(t,{...o,field:r.field,valueExpression:r.valueExpression}),d=F(r);for(const e of r.uniqueValueInfos)n.push({value:""+e.value,symbol:c(e.symbol,d,l)});return{type:"map",attributes:t.fields,field:a,fieldIndex:u,field2:P(t,{...o,field:r.field2}).field,field3:P(t,{...o,field:r.field3}).field,fieldDelimiter:r.fieldDelimiter,backgroundFillSymbol:c(s,d),defaultSymbol:c(r.defaultSymbol,d),map:n,stride:d.stride}}(s,i,r,l);case"dictionary":return function(e,t,i=!1){const r=F(t);return{type:"dictionary",config:t.config,fieldMap:t.fieldMap,scaleExpression:t.scaleExpression,url:t.url,symbolOptions:r,stride:r.stride}}(0,r,l)}}export{F as a,j as b,B as c,h as s};
