/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../Color.js";import{t,a as s}from"./colorUtils2.js";import{d as r}from"./vec4f64.js";import{i,u as o,b as a,o as n}from"../core/lang.js";import l from"../core/Handles.js";import{b as h,q as c,j as d,h as u,y as _,z as p,m as f,J as m,s as g,f as y,e as w,K as O}from"./mathUtils.js";import{f as v,a as R}from"./vec4f32.js";import{l as C,m as b,n as E,o as A,q as P}from"./frustum.js";import{c as x,f as D,g as G}from"./lineSegment.js";import{c as S,e as j}from"./ray.js";import{L as T}from"./LaserlineVisualElement.js";import{O as W}from"./Object3DVisualElement.js";import{G as F}from"./GeometryUtil.js";import{R as M,b as V}from"./Material.js";import{V as I}from"./VertexAttribute.js";import{R as U,ac as z,n as L,a6 as N,a as H,c as B,a5 as Y}from"./lineUtils.js";import{c as q}from"./lineStippleUtils.js";import{E as k}from"./Evented.js";import{projectBuffer as K}from"../geometry/projection.js";import{a as J,e as X,q as Q}from"./aaBoundingBox.js";import{m as Z}from"./dehydratedFeatures.js";import{f as $}from"./elevationInfoUtils.js";import{E as ee}from"./ElevationInfo.js";import{_ as te}from"./tslib.es6.js";import se from"../core/Accessor.js";import{I as re}from"./Identifiable.js";import{property as ie}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as oe}from"../core/accessorSupport/decorators/subclass.js";import{U as ae}from"./basicInterfaces.js";import{init as ne}from"../core/watchUtils.js";import{W as le,O as he}from"./DefaultBufferWriter.js";import{R as ce,E as de}from"./RenderGeometry.js";import{b as ue}from"./geometryDataUtils.js";class _e extends W{constructor(e){super(e),this._ray=S(),this._externalResources=null,this._handles=new l,this._isWorldDown=!1,this._start=h(),this._end=c(1,0,0),this._width=1,this._color=v(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=v(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=ye.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=M.OccludeAndTransparent,this._fadedExtensions=we,this.applyProps(e)}createExternalResources(){const e=new U(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this._updateGeometry()})));const t=new T({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){i(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){i(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[h(),h()],s=this.extensionType===ye.FADED;s&&t.push(h(),h());const r=s?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,i=F.createPolylineGeometry(t,null,r);e.addGeometry(i,o(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),i(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,d(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),u(this._end,e,this._end),j(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,_(this._start,e)||(d(this._start,e),j(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,_(this._end,e)||(d(this._end,e),j(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){p(e,this._color)||(f(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){p(e,this._innerColor)||(f(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=i(e)!==i(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(a(e)||a(this._stippleOffColor)||!p(e,this._stippleOffColor))&&(this._stippleOffColor=i(e)?R(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&i(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,i(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,i(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,i(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=n(e,we),this.recreateGeometry()}_updateMaterial(){if(a(this._externalResources))return;this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){i(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const t=this._extensionType===ye.FADED?this._updateLineSegmentFinite(ge):this._updateLineSegmentInfinite(this._extensionType,ge);this._updateVertexAttributes(e,t),i(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}_updateLineSegmentFinite(e){return D(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const s=this.view.state.camera;switch(b(this._ray,pe),e){case ye.LINE:pe.c0=-Number.MAX_VALUE;break;case ye.RAY:case ye.GROUND_RAY:{const e=this._ray.origin,t=n(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),s=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&s<t&&m(pe.ray.direction,pe.ray.direction),this._extensionType===ye.GROUND_RAY&&null!=t&&(pe.c1=Math.abs(s-t));break}}if(!E(s.frustum,pe))return D(this._start,this._end,t);const r=A(pe,fe),i=P(pe,me);return D(r,i,t)}_updateVertexAttributes(e,t){const s=e.geometries[0].getMutableAttribute(I.POSITION).data;if(this.extensionType===ye.FADED){const e=G(t,-this.fadedExtensions.start,fe);s[0]=e[0],s[1]=e[1],s[2]=e[2];const r=G(t,0,fe);s[3]=r[0],s[4]=r[1],s[5]=r[2];const i=G(t,1,fe);s[6]=i[0],s[7]=i[1],s[8]=i[2];const o=G(t,1+this.fadedExtensions.end,fe);s[9]=o[0],s[10]=o[1],s[11]=o[2]}else{const e=G(t,0,fe);s[0]=e[0],s[1]=e[1],s[2]=e[2];const r=G(t,1,fe);s[3]=r[0],s[4]=r[1],s[5]=r[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const pe=C(),fe=h(),me=h(),ge=x();var ye;!function(e){e[e.LINE=0]="LINE",e[e.RAY=1]="RAY",e[e.GROUND_RAY=2]="GROUND_RAY",e[e.FADED=3]="FADED"}(ye||(ye={}));const we={start:.3333333333333333,end:.3333333333333333};class Oe{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return i(this._resources)?this._resources.object:null}get resources(){return i(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(a(this._resources)||!e)return;const t=this._resources.object;this._resources.external.forEach((t=>{t.type===V.Geometry&&e.remove(t)})),t.removeAllGeometries();const s=this.resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer);e.addMany(s)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const t=new le({isPickable:!1,updatePolicy:ae.SYNC});e.add(t);const s=new he({castShadow:!1}),r=this.resourceFactory.createResources(s,t);r.forEach((t=>e.add(t))),e.add(s),t.add(s);const i=this.resourceFactory.cameraChanged?ne(this.resourceFactory.view.state,"camera",(e=>this.resourceFactory.cameraChanged(e))):null;this._resources={layer:t,object:s,external:r,cameraHandle:i},this._syncVisible()}_destroyResources(){if(a(this._resources))return;const e=this.resourceFactory.view._stage;null==e||e.remove(this._resources.object),null==e||e.remove(this._resources.layer),this._resources.external.forEach((t=>{null==e||e.remove(t),"dispose"in t&&t.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){a(this._resources)||this._resources.object.setVisible(this._visible)}}const ve={main:new e([255,127,0]),selected:new e([255,255,255]),staged:new e([12,207,255]),outline:new e([0,0,0,.5]),selectedOutline:new e([255,255,255])};function Re(e,t){const s=e.clone();return s.a*=t,s}function Ce(e,r){const i=e.clone(),o=t(i);o.s*=r;const a=s(o);return i.r=a.r,i.g=a.g,i.b=a.b,i}function be(e,t){if(t)for(const s in t)e[s]=t[s]}class Ee{constructor(e){this.color=ve.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=M.Opaque,be(this,e)}}class Ae{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=ve.main,this.outlineColor=ve.outline,this.renderOccluded=M.Opaque,this.hoverOutlineColor=ve.selectedOutline,be(this,e)}apply(e,t){const s=this[e];t.setParameters({color:Me(s),transparent:"color"!==e||s.a<1,renderOccluded:this.renderOccluded})}}class Pe{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=Re(ve.main,.5),this.hoverColor=ve.main,this.renderOccluded=M.Transparent,this.minSquaredEdgeLength=900,be(this,e)}apply(e,t){const s=this[e];t.setParameters({color:Me(s),transparent:s.a<1,renderOccluded:this.renderOccluded})}}class xe{constructor(e){this.vertex=new Ae({color:ve.main,outlineColor:ve.outline}),this.edge=new Ae({color:Ce(Re(ve.main,2/3),.5),outlineColor:Re(ve.outline,.5),size:8,collisionPadding:8}),this.selected=new Ae({color:ve.selected,outlineColor:ve.outline}),this.edgeOffset=new Pe,be(this,e)}}class De{constructor(e){this.color=ve.selected,this.width=1.5,this.stipplePattern=q(5),this.stippleOffColor=ve.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=ve.selected,this.renderOccluded=M.OccludeAndTransparent,be(this,e)}apply(e){e.color=Me(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Me(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Me(this.innerColor),e.renderOccluded=this.renderOccluded}}class Ge{constructor(e){this.color=ve.selected,this.size=4,this.outlineSize=1,this.outlineColor=ve.outline,this.shape="square",be(this,e)}apply(e){e.color=Me(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Me(this.outlineColor),e.primitive=this.shape}}class Se{constructor(e){this.innerColor=ve.selected,this.innerWidth=1,this.glowColor=ve.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=ve.main,be(this,e)}apply(t,s=1){const r={glowColor:e.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:e.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*s,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=r:t.laserlineStyle=r}}class je{constructor(e){this.outline=new De({color:ve.outline,renderOccluded:M.OccludeAndTransparentStencil,stippleOffColor:ve.selected,stipplePattern:q(5),width:1.5,innerWidth:0}),this.staged=new De({color:ve.selected,renderOccluded:M.OccludeAndTransparentStencil,innerColor:ve.staged,stippleOffColor:ve.outline,stipplePattern:q(5),width:1.5}),this.shadowStyle=new Se({globalAlpha:.3,glowColor:ve.main,glowFalloff:8,glowWidth:8,innerColor:ve.selected,innerWidth:1}),be(this,e)}}class Te{constructor(e){this.outline=new Ge({color:ve.selected,outlineColor:ve.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Se({globalAlpha:.3,glowColor:ve.main,glowFalloff:1.5,glowWidth:6,innerColor:ve.selected,innerWidth:1,radius:2}),be(this,e)}}class We extends De{constructor(e){super(),this.extensionType=ye.GROUND_RAY,be(this,e)}}class Fe{constructor(e){this.lineGraphics=new je,this.pointGraphics=new Te,this.heightPlane=new Se({globalAlpha:.3,glowColor:ve.main,glowFalloff:8,glowWidth:8,innerColor:ve.selected,innerWidth:1}),this.heightBox=new Se({globalAlpha:.3,glowColor:ve.main,glowFalloff:8,glowWidth:8,innerColor:ve.selected,innerWidth:0,heightFillColor:ve.main}),this.zVerticalLine=new We({color:Re(ve.main,.5),falloff:2,innerColor:Re(ve.selected,0),renderOccluded:M.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:ye.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,be(this,e)}}function Me(t){return r(e.toUnitRGBA(t))}const Ve=new class{constructor(e){this.visualElements=new Fe,this.reshapeManipulators=new xe,this.zManipulator=new Ee,be(this,e)}colorToVec4(e){return Me(e)}};class Ie{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return i(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?a(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?a(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const t=this.resourceFactory.createResources();this._resources={layerView:new Ue({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();const s=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;s&&s.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if(a(this._resources))return;this._ensureRenderGeometriesRemoved();const t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;if(a(this._resources)||null==(e=this.resourceFactory.view)||!e.basemapTerrain)return;if(!this._resources.geometriesAdded)return;this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,L.Geometry.UPDATE),this._resources.geometriesAdded=!1}_ensureRenderGeometriesAdded(){if(a(this._resources))return;if(this._resources.geometriesAdded)return;this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,L.Geometry.UPDATE),this._resources.geometriesAdded=!0}}let Ue=class extends(re(se)){constructor(e){super(e),this.drapeSourceType=z.Features,this.updatePolicy=ae.SYNC}};te([ie({constructOnly:!0})],Ue.prototype,"view",void 0),te([ie({readOnly:!0})],Ue.prototype,"drapeSourceType",void 0),Ue=te([oe("DrapedVisualElementLayerView")],Ue);class ze{constructor(e){this.view=null,this._attachmentOrigin=Z(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new k,this._isDraped=!1,this._geometry=null,this._width=1,this._color=v(1,0,1,1),this._innerWidth=0,this._innerColor=v(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=M.OccludeAndTransparentStencil,this.resources=new Oe({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this._recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new Ie({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:e=>{e.geometries=this._createRenderGeometriesDraped(e.material),this._attachmentOriginChanged()}});let t=!0;this._laserline=new T({view:e.view});for(const s in e)s in this?"attached"===s?t=e[s]:this[s]=e[s]:console.error("Cannot set unknown property",s);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&i(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){p(e,this._color)||(f(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){p(e,this._innerColor)||(f(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=i(e)!==i(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&p(e,this._stippleOffColor)||(this._stippleOffColor=e?R(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,i(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=i(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;g(He,0,0,0);let t=0;for(const s of e){const e=s.vertexAttributes.get(I.POSITION),r=s.indices.get(I.POSITION),i=o(this.resources.resources).material.isClosed(e.data,r);ue(e,r,i,Ne)&&(y(He,He,Ne),t++)}return 0===t?null:(w(He,He,1/t),this.view.renderCoordsHelper.fromRenderCoords(He,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){i(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),i(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return i(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===M.OccludeAndTransparentStencil?M.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,t,s){const r=this._createRenderGeometries();for(const i of r)e.addGeometry(i,t),s.push(i);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const t=new U(this.materialParameters),s=[];return this._recreateGeometry(e,t,s),{material:t,geometries:s,forEach:e=>{e(t),s.forEach(e)}}}_createDrapedResources(){const e=new U(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const t=this.geometry;if(a(t))return[];const s=N(t,this.view.basemapTerrain.spatialReference),r=[];for(const{position:t}of s.lines){const s={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:t},removeDuplicateStartEnd:this.isClosed?H.REMOVE:H.KEEP},i=new ce(B(s),e),o=X(Le);Q(o,t),O(i.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),r.push(i)}return r}calculateMapBounds(e){if(a(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const s of this.resources.resources.geometries){const r=s.vertexAttributes.get(I.POSITION),i=new Float64Array(r.data.length);K(r.data,t.spatialReference,0,i,this.view.spatialReference,0,r.data.length/3),Q(e,i)}return!0}_createRenderGeometries(){var e;const t=this.geometry;if(a(t))return[];const s=Y(t,this.view.elevationProvider,this.view.renderCoordsHelper,de.fromElevationInfo(null!=(e=this.elevationInfo)?e:new ee({mode:$(t,null)}))),r=[],i=[];for(const{position:e,mapPosition:t}of s.lines){const s={overlayInfo:null,attributeData:{position:e,mapPosition:t},removeDuplicateStartEnd:this.isClosed?H.REMOVE:H.KEEP};r.push(B(s)),i.push(e)}return this._laserline.pathVerticalPlane=i,r}}const Le=J(),Ne=h(),He=h();export{_e as E,ze as O,Oe as V,ye as a,ve as c,Ve as s};
