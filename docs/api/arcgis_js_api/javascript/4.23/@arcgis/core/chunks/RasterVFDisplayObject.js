/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../Graphic.js";import{HandleOwner as s}from"../core/HandleOwner.js";import{watch as i}from"../core/reactiveUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{i as a,b as n}from"../core/lang.js";import"./ensureType.js";import{subclass as o}from"../core/accessorSupport/decorators/subclass.js";import{l}from"./dataUtils.js";import{c as h}from"./brushes.js";import{W as d}from"./enums4.js";import{W as c}from"./WGLContainer.js";import"../geometry.js";import m from"../core/Accessor.js";import{L as u}from"./Logger.js";import{k as p}from"./mathUtils.js";import{isAbortError as g,throwIfAborted as y}from"../core/promiseUtils.js";import _ from"../geometry/Point.js";import{k as f,g as x,c as v,r as S,b as w,s as D,m as b}from"./mat3.js";import{c as R}from"./mat3f32.js";import{D as V}from"./DisplayObject.js";import A from"../geometry/Extent.js";import{B as j,V as O}from"./VertexArrayObject.js";import{D as z,U as T}from"./enums.js";import{V as C}from"./VertexElementDescriptor.js";import{e as F}from"./screenUtils.js";import{f as L}from"./vec2f32.js";import{e as P,f as I}from"./vectorFieldUtils.js";import{c as k}from"./Utils16.js";class W extends c{constructor(){super(...arguments),this.flowStyle=null}get requiresDedicatedFBO(){return!1}doRender(e){super.doRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"flow",brushes:[h],target:()=>this.children,drawPhase:d.MAP});return[...super.prepareRenderPasses(e),t]}}const M=u.getLogger("esri.views.2d.engine.flow.FlowDisplayData");class E{constructor(e,t,s,i){this.state={name:"created"},this.flowStyle=e,this.extent=t,this.size=s,this.pixelRatio=i}async load(){const e=new AbortController;this.state={name:"loading",abortController:e};const t=await this.flowStyle.loadResources({extent:this.extent,size:this.size,pixelRatio:this.pixelRatio},e.signal);this.state={name:"loaded",resources:t}}prepareForRendering(e){if("loaded"!==this.state.name)return void M.error("Only loaded resources can be attached.");const t=this.state.resources;t.prepareForRendering(e),this.state={name:"attached",resources:t}}destroy(){if("loading"===this.state.name)return this.state.abortController.abort(),void(this.state={name:"detached"});"attached"===this.state.name&&(this.state.resources.detach(),this.state={name:"detached"})}update(e){if(!this.flowStyle.areResourcesCompatible(e.flowStyle))return!1;return!(!this.extent.equals(e.extent)||this.size[0]!==e.size[0]||this.size[1]!==e.size[1]||this.pixelRatio!==e.pixelRatio)&&(this.flowStyle=e.flowStyle,!0)}}class U extends V{constructor(){super(...arguments),this._displayData=null}get displayData(){return this._displayData}set displayData(e){this._displayData=e,this.requestRender()}clear(){a(this._displayData)&&(this._displayData.destroy(),this._displayData=null,this.requestRender())}setTransform(e){const{displayData:t}=this;if(n(t))return;const s=t.extent.xmin,i=t.extent.ymax,r=[0,0];e.toScreen(r,[s,i]);const a=(t.extent.xmax-t.extent.xmin)/t.size[0]/e.resolution,o=p(e.rotation),{dvs:l}=this.transforms;f(l,[-1,1,0]),x(l,l,[2/(e.size[0]*e.pixelRatio),-2/(e.size[1]*e.pixelRatio),1]),v(l,l,[r[0],r[1],0]),S(l,l,o),x(l,l,[a*e.pixelRatio,a*e.pixelRatio,1])}_createTransforms(){return{dvs:R()}}}const q=u.getLogger("esri.views.2d.engine.flow.FlowStrategy");let B=class extends m{constructor(e){super(e),this._flowDisplayObject=new U,this._loading=null}initialize(){this.flowContainer.addChild(this._flowDisplayObject)}destroy(){this._clear(),this.flowContainer.removeAllChildren()}get updating(){return null!=this._loading}update(e){const{flowStyle:t}=this.flowContainer;if(n(t))return void this._clear();const{extent:s,rotation:i,resolution:r,pixelRatio:o}=e.state,l=function(e,t){const s=new _({x:(e.xmax+e.xmin)/2,y:(e.ymax+e.ymin)/2,spatialReference:e.spatialReference}),i=e.xmax-e.xmin,r=e.ymax-e.ymin,a=Math.abs(Math.cos(p(t))),n=Math.abs(Math.sin(p(t))),o=a*i+n*r,l=n*i+a*r,h=new A({xmin:s.x-o/2,ymin:s.y-l/2,xmax:s.x+o/2,ymax:s.y+l/2,spatialReference:e.spatialReference});return h.centerAt(s),h}(s,i);l.expand(1.15);const h=[Math.round((l.xmax-l.xmin)/r),Math.round((l.ymax-l.ymin)/r)],d=new E(t,l,h,o);if(a(this._loading)){if(this._loading.update(d))return;this._loading.destroy(),this._loading=null}!n(this._flowDisplayObject.displayData)&&this._flowDisplayObject.displayData.update(d)||(d.load().then((()=>{this._flowDisplayObject.clear(),this._flowDisplayObject.displayData=this._loading,this._loading=null}),(e=>{g(e)||(q.error("A resource failed to load.",e),this._loading=null)})),this._loading=d)}_clear(){this._flowDisplayObject.clear(),a(this._loading)&&(this._loading.destroy(),this._loading=null)}};e([r()],B.prototype,"_loading",void 0),e([r()],B.prototype,"flowContainer",void 0),e([r()],B.prototype,"updating",null),B=e([o("esri.views.2d.engine.flow.FlowStrategy")],B);const N=B;const G=new Map;G.set("a_positionAndSide",0),G.set("a_timeInfo",1),G.set("a_extrude",2),G.set("a_speed",3);const J={geometry:[new C("a_positionAndSide",3,z.FLOAT,0,36),new C("a_timeInfo",3,z.FLOAT,12,36),new C("a_extrude",2,z.FLOAT,24,36),new C("a_speed",1,z.FLOAT,32,36)]};class H{constructor(e,t,s){this.values=s,this._vertexData=e,this._indexData=t}prepareForRendering(e){const t=j.createVertex(e,T.STATIC_DRAW,this._vertexData),s=j.createIndex(e,T.STATIC_DRAW,this._indexData),i=new O(e,G,J,{geometry:t},s);this.vertexBuffer=t,this.indexBuffer=s,this.vertexArray=i,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose(),this.vertexBuffer.dispose(),this.indexBuffer.dispose()}get locations(){return G}}function K(e){const t=function(e){if(!e.hasVisualVariables("size"))return{kind:"constant",value:[F(e.trailWidth)]};const t=e.getVisualVariablesForType("size")[0],s=[],i=[];let r;if(t.stops){for(const e of t.stops)s.push(e.value),i.push(e.size);r=t.stops.length}else s.push(t.minDataValue,t.maxDataValue),i.push(t.minSize,t.maxSize),r=2;return{kind:"ramp",stops:s,values:i,count:r}}(e),s=function(e){if("constant"===e.kind)return e.value[0];return e.values[e.values.length-1]}(t),i=2*s,r=Math.round(F(e.maxPathLength)/i)+1,a=s,n=function(e){if(!e.hasVisualVariables("color"))return{kind:"constant",value:Q(e.color)};const t=e.getVisualVariablesForType("color")[0],s=[],i=[];for(const e of t.stops)s.push(e.value),Array.prototype.push.apply(i,Q(e.color));return{kind:"ramp",stops:s,values:i,count:t.stops.length}}(e),o=function(e){if(!e.hasVisualVariables("opacity"))return{kind:"constant",value:[1]};const t=e.getVisualVariablesForType("opacity")[0],s=[],i=[];for(const e of t.stops)s.push(e.value),i.push(e.opacity);return{kind:"ramp",stops:s,values:i,count:t.stops.length}}(e),{flowSpeed:l,trailLength:h,density:d}=e;return{lineRenderWidth:t,segmentLength:i,verticesPerLine:r,lineCollisionWidth:a,lineSpacing:10,lineColor:n,lineOpacity:o,lineSpeed:l,fadeDuration:h,density:d,smoothing:F(e.smoothing),velocityScale:"flow-from"===e.flowRepresentation?1:-1,minWeightThreshold:.001,minSpeedThreshold:.001,maxTurnAngle:1,mergeLines:!0,interpolate:!0,profile:!1}}function Q(e){const t=e.toRgba();return[t[0]/255,t[1]/255,t[2]/255,t[3]]}class X{constructor(e,t,s,i){this._loadImagery=e,this._createStreamlinesMesh=t,this._timeExtent=i,this._rendererSettings=K(s)}get animated(){return this._rendererSettings.lineSpeed>0}get renderSettings(){return this._rendererSettings}areResourcesCompatible(e){let t=!0;return t=t&&e._loadImagery===this._loadImagery,t=t&&e._createStreamlinesMesh===this._createStreamlinesMesh,t=t&&e._rendererSettings.verticesPerLine===this._rendererSettings.verticesPerLine,t=t&&e._rendererSettings.segmentLength===this._rendererSettings.segmentLength,t=t&&e._rendererSettings.lineSpacing===this._rendererSettings.lineSpacing,t=t&&e._rendererSettings.density===this._rendererSettings.density,t=t&&e._rendererSettings.smoothing===this._rendererSettings.smoothing,t=t&&e._rendererSettings.velocityScale===this._rendererSettings.velocityScale,t=t&&e._rendererSettings.minWeightThreshold===this._rendererSettings.minWeightThreshold,t=t&&e._rendererSettings.minSpeedThreshold===this._rendererSettings.minSpeedThreshold,t=t&&e._rendererSettings.mergeLines===this._rendererSettings.mergeLines,t=t&&e._rendererSettings.velocityScale===this._rendererSettings.velocityScale,t=t&&e._rendererSettings.interpolate===this._rendererSettings.interpolate,t=t&&e._rendererSettings.lineColor.kind===this._rendererSettings.lineColor.kind,t=t&&e._rendererSettings.lineOpacity.kind===this._rendererSettings.lineOpacity.kind,t=t&&e._rendererSettings.lineRenderWidth.kind===this._rendererSettings.lineRenderWidth.kind,t&&this._rendererSettings.mergeLines&&(t=e._rendererSettings.lineCollisionWidth===this._rendererSettings.lineCollisionWidth),t&&e._timeExtent!==this._timeExtent&&(t=!(!a(e._timeExtent)||!a(this._timeExtent))&&e._timeExtent.equals(this._timeExtent)),t}async loadResources(e,t){const{extent:s,size:i}=e;y(t);const r=await this._loadImagery(s,i[0],i[1],this._timeExtent,t),{vertexData:a,indexData:n}=await this._createStreamlinesMesh(this._rendererSettings,r,t);return new H(a,n,{lineColor:this._rendererSettings.lineColor,lineOpacity:this._rendererSettings.lineOpacity,lineRenderWidth:this._rendererSettings.lineRenderWidth})}}let Y=class extends s{constructor(){super(...arguments),this._loadImagery=(e,t,s,i,r)=>l(this.layer,e,t,s,i,r),this._createStreamlinesMesh=(e,t,s)=>this.layer.createStreamlinesMesh({flowData:t,rendererSettings:e},{signal:s}),this.attached=!1,this.container=null,this.layer=null,this.type="flow",this.timeExtent=null,this.redrawOrRefetch=async()=>{this._updateVisualization()}}get updating(){return!this._strategy||this._strategy.updating}attach(){const{layer:e}=this,t=()=>{this._loadImagery=(t,s,i,r,a)=>l(e,t,s,i,r,a),this._updateVisualization()};"multidimensionalDefinition"in e?this.handles.add(i((()=>e.multidimensionalDefinition),t)):this.handles.add([i((()=>e.mosaicRule),t),i((()=>e.renderingRule),t),i((()=>e.definitionExpression),t)]),this.container=new W,this._strategy=new N({flowContainer:this.container}),this._updateVisualization()}detach(){this._strategy.destroy(),this.container.removeAllChildren(),this.container=null,this.handles.removeAll()}update(e){e.stationary?this._strategy.update(e):this.layerView.requestUpdate()}hitTest(e){return new t({attributes:{},geometry:e.clone(),layer:this.layer})}moveEnd(){}async doRefresh(){}_updateVisualization(){if("flow"!==this.layer.renderer.type)return;const e=new X(this._loadImagery,this._createStreamlinesMesh,this.layer.renderer,this.timeExtent);this.container.flowStyle=e,this.layerView.requestUpdate()}};e([r()],Y.prototype,"_strategy",void 0),e([r()],Y.prototype,"attached",void 0),e([r()],Y.prototype,"container",void 0),e([r()],Y.prototype,"layer",void 0),e([r()],Y.prototype,"layerView",void 0),e([r()],Y.prototype,"type",void 0),e([r()],Y.prototype,"updating",null),e([r()],Y.prototype,"timeExtent",void 0),Y=e([o("esri.views.2d.engine.flow.FlowView2D")],Y);const Z=Y;class $ extends V{constructor(e=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.width=null,this.source=e}destroy(){var e,t;a(this.vaoData)&&(null==(e=this.vaoData.magdir)||e.vao.dispose(),null==(t=this.vaoData.scalar)||t.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}get source(){return this._source}set source(e){this._source=e,this.invalidateVAO()}invalidateVAO(){var e,t;!this._vaoInvalidated&&a(this.vaoData)&&(null==(e=this.vaoData.magdir)||e.vao.dispose(),null==(t=this.vaoData.scalar)||t.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,a(this.source)&&!a(this.vaoData)){const{style:t}=this.symbolizerParameters;switch(t){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const t=P(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t);this.vaoData={magdir:s}}break;case"simple_scalar":{const t=I(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t);this.vaoData={scalar:s}}break;case"wind_speed":{const t=P(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t),i=I(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(e.context,i);this.vaoData={magdir:s,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:R()}}setTransform(e){const t=w(this.transforms.dvs),[s,i]=e.toScreenNoRotation([0,0],[this.x,this.y]),r=this.resolution/this.pixelRatio/e.resolution,a=r*this.width,n=r*this.height,o=Math.PI*this.rotation/180;v(t,t,L(s,i)),v(t,t,L(a/2,n/2)),S(t,t,-o),v(t,t,L(-a/2,-n/2)),D(t,t,L(a,n)),b(this.transforms.dvs,e.displayViewMat3,t)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(e,t){const{vertexData:s,indexData:i}=t,r=j.createVertex(e,T.STATIC_DRAW,new Float32Array(s)),a=j.createIndex(e,T.STATIC_DRAW,new Uint32Array(i)),n=k("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:z.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:z.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:z.FLOAT,normalized:!1}]});return{vao:new O(e,n.attributes,n.bufferLayouts,{geometry:r},a),elementCount:i.length}}}export{Z as F,$ as R};
