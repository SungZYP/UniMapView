/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{k as e,c as n,B as s,a as o,g as r,i as a,l as i,d as c,e as f,f as l,h as u,j as g,m as d,r as m,u as p,b as h,n as A,x as N,v as I,s as w,t as S,w as E,y as O,z as y,o as v,p as T,A as V,C as D,D as L,q as b,E as R,F as M,G as P,H as U,I as F,J as x}from"./BufferView.js";import{n as j}from"./InterleavedLayout.js";import{g as B}from"./glUtil.js";import{V as W}from"./VertexAttribute.js";import{R as k,O as C,Q as H}from"../core/lang.js";import{f as X,n as _,b as z,k as G,s as K,j as q,d as $,i as J,x as Q,a as Y,h as Z,u as tt}from"./mathUtils.js";const et=j().vec3f(W.POSITION).u16(W.COMPONENTINDEX).u16(W.U16PADDING),nt=j().vec2u8(W.SIDENESS),st=B(nt),ot=j().vec3f(W.POSITION0).vec3f(W.POSITION1).u16(W.COMPONENTINDEX).u8(W.VARIANTOFFSET,{glNormalized:!0}).u8(W.VARIANTSTROKE).u8(W.VARIANTEXTENSION,{glNormalized:!0}).u8(W.U8PADDING,{glPadding:!0}).u16(W.U16PADDING,{glPadding:!0}),rt=ot.clone().vec3f(W.NORMAL),at=ot.clone().vec3f(W.NORMALA).vec3f(W.NORMALB),it=new Map([[W.POSITION0,0],[W.POSITION1,1],[W.COMPONENTINDEX,2],[W.VARIANTOFFSET,3],[W.VARIANTSTROKE,4],[W.VARIANTEXTENSION,5],[W.NORMAL,6],[W.NORMALA,6],[W.NORMALB,7],[W.SIDENESS,8]]);class ct{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?dt:gt}write(t,e,n){const s=this.edgeHashFunction(n);Nt.seed=s;const o=Nt.getIntRange(0,255),r=Nt.getIntRange(0,this.settings.variants-1),a=Nt.getFloat(),i=255*(.5*function(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),1.2)+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,o),t.variantStroke.set(e,r),t.variantExtension.set(e,i)}trim(t,e){return t.slice(0,e)}}const ft=new Float32Array(6),lt=new Uint32Array(ft.buffer),ut=new Uint32Array(1);function gt(t){const e=ft;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],ut[0]=5381;for(let t=0;t<lt.length;t++)ut[0]=31*ut[0]+lt[t];return ut[0]}function dt(t){const e=ft;e[0]=mt(t.position0[0]),e[1]=mt(t.position0[1]),e[2]=mt(t.position0[2]),e[3]=mt(t.position1[0]),e[4]=mt(t.position1[1]),e[5]=mt(t.position1[2]),ut[0]=5381;for(let t=0;t<lt.length;t++)ut[0]=31*ut[0]+lt[t];return ut[0]}function mt(t){return Math.round(1e4*t)/1e4}class pt{constructor(){this.commonWriter=new ct}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return rt.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),X(At,n.faceNormal0,n.faceNormal1),_(At,At),t.normal.setVec(e,At)}trim(t,e){return this.commonWriter.trim(t,e)}}pt.Layout=rt,pt.glLayout=B(rt,1);class ht{constructor(){this.commonWriter=new ct}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return at.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),t.normalA.setVec(e,n.faceNormal0),t.normalB.setVec(e,n.faceNormal1)}trim(t,e){return this.commonWriter.trim(t,e)}}ht.Layout=at,ht.glLayout=B(at,1);const At=z(),Nt=new k;var It;function wt(t,e,n,s=Tt){const o=t.vertices.position,r=t.vertices.componentIndex,a=G(s.anglePlanar),i=G(s.angleSignificantEdge),c=Math.cos(i),f=Math.cos(a),l=yt.edge,u=l.position0,g=l.position1,d=l.faceNormal0,m=l.faceNormal1,p=function(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,o=vt.v0,r=vt.v1,a=vt.v2,i=new Float32Array(3*e);for(let t=0;t<e;t++){const e=s[3*t+0],c=s[3*t+1],f=s[3*t+2];n.getVec(e,o),n.getVec(c,r),n.getVec(f,a),Z(r,r,o),Z(a,a,o),Y(o,r,a),_(o,o),i[3*t+0]=o[0],i[3*t+1]=o[1],i[3*t+2]=o[2]}return i}(t),h=function(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let o=0;for(let t=0;t<e;t++){const e=s[3*t+0],r=s[3*t+1],a=s[3*t+2],i=n[3*t+0],c=n[3*t+1],f=n[3*t+2];o+=-1===e||i<c?1:0,o+=-1===r||c<f?1:0,o+=-1===a||f<i?1:0}const r=new Int32Array(4*o);let a=0;for(let t=0;t<e;t++){const e=s[3*t+0],o=s[3*t+1],i=s[3*t+2],c=n[3*t+0],f=n[3*t+1],l=n[3*t+2];(-1===e||c<f)&&(r[a++]=c,r[a++]=f,r[a++]=t,r[a++]=e),(-1===o||f<l)&&(r[a++]=f,r[a++]=l,r[a++]=t,r[a++]=o),(-1===i||l<c)&&(r[a++]=l,r[a++]=c,r[a++]=t,r[a++]=i)}return r}(t),A=h.length/4,N=e.allocate(A);let I=0;const w=A,S=n.allocate(w);let E=0,O=0,y=0;const v=C(0,A),T=new Float32Array(A);H(T,((t,e,n)=>{o.getVec(h[4*e+0],u),o.getVec(h[4*e+1],g),n[e]=tt(u,g)})),v.sort(((t,e)=>T[e]-T[t]));const V=new Array,D=new Array;for(let t=0;t<A;t++){const s=v[t],i=T[s],A=h[4*s+0],w=h[4*s+1],L=h[4*s+2],b=h[4*s+3],R=-1===b;if(o.getVec(A,u),o.getVec(w,g),R)K(d,p[3*L+0],p[3*L+1],p[3*L+2]),q(m,d),l.componentIndex=r.get(A),l.cosAngle=$(d,m);else{if(K(d,p[3*L+0],p[3*L+1],p[3*L+2]),K(m,p[3*b+0],p[3*b+1],p[3*b+2]),l.componentIndex=r.get(A),l.cosAngle=$(d,m),Et(l,f))continue;l.cosAngle<-.9999&&q(m,d)}O+=i,y++,R||St(l,c)?(e.write(N,I++,l),V.push(i)):Ot(l,a)&&(n.write(S,E++,l),D.push(i))}const L=new Float32Array(V.reverse()),b=new Float32Array(D.reverse());return{regular:{instancesData:e.trim(N,I),lodInfo:{lengths:L}},silhouette:{instancesData:n.trim(S,E),lodInfo:{lengths:b}},averageEdgeLength:O/y}}function St(t,e){return t.cosAngle<e}function Et(t,e){return t.cosAngle>e}function Ot(t,e){const n=J(t.cosAngle),s=yt.fwd,o=yt.ortho;Q(s,t.position1,t.position0);return n*($(Y(o,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}!function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"}(It||(It={}));const yt={edge:{position0:z(),position1:z(),faceNormal0:z(),faceNormal1:z(),componentIndex:0,cosAngle:0},ortho:z(),fwd:z()},vt={v0:z(),v1:z(),v2:z()},Tt={anglePlanar:4,angleSignificantEdge:35};function Vt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:Lt(t.layout)}}function Dt(t){const e=function(t){const e=j();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach((t=>e.fields.set(t[0],{...t[1],constructor:Mt(t[1].constructor)}))),e}(t.layout);return e.createView(t.buffer)}function Lt(t){const e=new Array;return t.fields.forEach(((t,n)=>{const s={...t,constructor:Rt(t.constructor)};e.push([n,s])})),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const bt=[e,n,s,o,r,a,i,c,f,l,u,g,d,m,p,h,A,N,I,w,S,E,O,y,v,T,V,D,L,b,R,M,P,U,F,x];function Rt(t){return`${t.ElementType}_${t.ElementCount}`}function Mt(t){return Pt.get(t)}const Pt=new Map;function Ut(t,e,n){const s=e/3,o=new Uint32Array(n+1),r=new Uint32Array(n+1),a=(t,e)=>{t<e?o[t+1]++:r[e+1]++};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];a(n,s),a(s,o),a(o,n)}let i=0,c=0;for(let t=0;t<n;t++){const e=o[t+1],n=r[t+1];o[t+1]=i,r[t+1]=c,i+=e,c+=n}const f=new Uint32Array(6*s),l=o[n],u=(t,e,n)=>{if(t<e){const s=o[t+1]++;f[2*s]=e,f[2*s+1]=n}else{const s=r[e+1]++;f[2*l+2*s]=t,f[2*l+2*s+1]=n}};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];u(n,s,e),u(s,o,e),u(o,n,e)}const g=(t,e)=>{const n=2*t,s=e-t;for(let t=1;t<s;t++){const e=f[n+2*t],s=f[n+2*t+1];let o=t-1;for(;o>=0&&f[n+2*o]>e;o--)f[n+2*o+2]=f[n+2*o],f[n+2*o+3]=f[n+2*o+1];f[n+2*o+2]=e,f[n+2*o+3]=s}};for(let t=0;t<n;t++)g(o[t],o[t+1]),g(l+r[t],l+r[t+1]);const d=new Int32Array(3*s),m=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,p=(t,e)=>{const n=m(t,e);d[3*e+n]=-1},h=(t,e,n,s)=>{const o=m(t,e);d[3*e+o]=s;const r=m(n,s);d[3*s+r]=e};for(let t=0;t<n;t++){let e=o[t];const n=o[t+1];let s=r[t];const a=r[t+1];for(;e<n&&s<a;){const n=f[2*e],o=f[2*l+2*s];n===o?(h(t,f[2*e+1],o,f[2*l+2*s+1]),e++,s++):n<o?(p(t,f[2*e+1]),e++):(p(o,f[2*l+2*s+1]),s++)}for(;e<n;)p(t,f[2*e+1]),e++;for(;s<a;){p(f[2*l+2*s],f[2*l+2*s+1]),s++}}return d}function Ft(e){const n=function(e,n,s,o){if(n){return{faces:s,facesLength:o,neighbors:Ut(s,o,e.count),vertices:e}}const r=t(e.buffer,e.stride/4,{originalIndices:s,originalIndicesLength:o}),a=Ut(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:et.createView(r.buffer)}}(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return xt.updateSettings(e.writerSettings),jt.updateSettings(e.writerSettings),wt(n,xt,jt)}bt.forEach((t=>Pt.set(Rt(t),t)));const xt=new pt,jt=new ht,Bt=Object.freeze({__proto__:null,wrappedWork:async function(t){const e=function(t){return{data:et.createView(t.dataBuffer),indices:"Uint32Array"===t.indicesType?new Uint32Array(t.indicesBuffer):"Uint16Array"===t.indicesType?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}(t),n=Ft(e),s=[e.data.buffer],o=function(t,e){e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer);return{regular:{instancesData:Vt(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:Vt(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}(n,s);return{result:o,transferList:s}},work:Ft});export{it as E,pt as R,ht as S,nt as V,It as a,et as b,Bt as c,st as g,Dt as u,Ft as w};
