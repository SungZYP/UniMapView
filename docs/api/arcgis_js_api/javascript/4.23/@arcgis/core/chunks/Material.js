/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{b as e,i as t}from"../core/lang.js";import{g as a}from"./watch.js";import{V as i}from"./VertexAttribute.js";import{G as r,k as n,c as s,s as l,a as o,n as c,b as u}from"./mathUtils.js";import{a as d,b as f,d as m}from"./aaBoundingBox.js";import{P as h}from"./basicInterfaces.js";import{V as p}from"./ViewingMode.js";import{a as g}from"./Util.js";import{i as v}from"./utils2.js";class O{constructor(){this.id=a()}unload(){}}var x;!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"}(x||(x={}));const P=new Map([[i.POSITION,0],[i.NORMAL,1],[i.UV0,2],[i.COLOR,3],[i.SIZE,4],[i.TANGENT,4],[i.AUXPOS1,5],[i.SYMBOLCOLOR,5],[i.AUXPOS2,6],[i.FEATUREATTRIBUTE,6],[i.INSTANCEFEATUREATTRIBUTE,6],[i.INSTANCECOLOR,7],[i.MODEL,8],[i.MODELNORMAL,12],[i.MODELORIGINHI,11],[i.MODELORIGINLO,15]]);function M(e,t){return new _(e,I,t)}function A(e,t){const{curvatureDependent:a,scaleStart:i,scaleFallOffRange:r}=I;return new _(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:L.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:L.curvatureDependent.max.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:r,minPixelSize:L.minPixelSize},t)}function b(e,t,a){const i=a.parameters,r=a.paddingPixelsOverride;return y.scale=Math.min(i.divisor/(t-i.offset),1),y.factor=function(e){return Math.abs(e*e*e)}(e),y.minPixelSize=i.minPixelSize,y.paddingPixels=r,y}function F(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function T(e,t){return Math.max(r(e*t.scale,e,t.factor),F(e,t))}function S(e,t,a,i){i.scale=function(e,t,a){const i=b(e,t,a);return i.minPixelSize=0,i.paddingPixels=0,T(1,i)}(e,t,a),i.factor=0,i.minPixelSize=a.parameters.minPixelSize,i.paddingPixels=a.paddingPixelsOverride}function C(e,t,a=[0,0]){const i=Math.min(Math.max(t.scale,F(e[1],t)/Math.max(1e-5,e[1])),1);return a[0]=e[0]*i,a[1]=e[1]*i,a}class _{constructor(e,t,a,i={camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0},r){this.viewingMode=e,this.description=t,this.ellipsoidRadius=a,this.parameters=i,this._paddingPixelsOverride=r,this.viewingMode===p.Local?(this.coverageCompensation=this._surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this._surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this.ellipsoidRadius,this.parameters),!0)}overridePadding(e){return e!==this.paddingPixelsOverride?new _(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:i,scaleFallOffRange:r,minPixelSize:n}=this.description,{fovY:s,distance:l}=e,o=this.calculateCurvatureDependentParameters(e,t),c=this.coverageCompensation(e,t,o),{tiltAngle:u,scaleFallOffFactor:d}=o,f=Math.sin(u)*l,m=.5*Math.PI-u-s*(.5-i*c),h=f/Math.cos(m),p=m+s*r*c,g=(h-d*(f/Math.cos(p)))/(1-d);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=g,a.divisor=h-g,a.minPixelSize=n,a}_calculateCurvatureDependentParametersLocal(e,t,a=R){return a.tiltAngle=this.description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,t,a=R){const i=this.description.curvatureDependent,n=1+e.distance/t,l=Math.sqrt(n*n-1),[o,c]=[i.min.curvature,i.max.curvature],u=s((l-o)/(c-o),0,1),[d,f]=[i.min,i.max];return a.tiltAngle=r(d.tiltAngle,f.tiltAngle,u),a.scaleFallOffFactor=r(d.scaleFallOffFactor,f.scaleFallOffFactor,u),a}_surfaceCoverageCompensationLocal(e,t,a){return(e.fovY-a.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,a){const i=t*t,r=a.tiltAngle+.5*Math.PI,{fovY:n,distance:s}=e,l=s*s+i-2*Math.cos(r)*s*t,o=Math.sqrt(l),c=Math.sqrt(l-i);return(Math.acos(c/o)-Math.asin(t/(o/Math.sin(r)))+.5*n)/n}}const I={curvatureDependent:{min:{curvature:n(10),tiltAngle:n(12),scaleFallOffFactor:.5},max:{curvature:n(70),tiltAngle:n(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},L={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};const y={scale:0,factor:0,minPixelSize:0,paddingPixels:0},R={tiltAngle:0,scaleFallOffFactor:0},D=d();function E(e,t,a,r,n,s,l){if(!v(t))if(e.boundingInfo){g(e.primitiveType===h.Triangle);const t=a.tolerance;z(e.boundingInfo,r,n,t,s,l)}else{const t=e.indices.get(i.POSITION),a=e.vertexAttributes.get(i.POSITION);U(r,n,0,t.length/3,t,a,void 0,s,l)}}const N=u();function z(a,i,r,n,s,l){if(e(a))return;const o=w(i,r,N);if(f(D,a.getBBMin()),m(D,a.getBBMax()),t(s)&&s.applyToAabb(D),B(D,i,o,n)){const{primitiveIndices:e,indices:t,position:o}=a,c=e?e.length:t.length/3;if(c>Q){const e=a.getChildren();if(void 0!==e){for(let t=0;t<8;++t)void 0!==e[t]&&z(e[t],i,r,n,s,l);return}}U(i,r,0,c,t,o,e,s,l)}}const V=u();function U(e,a,i,r,n,s,l,o,c){if(l)return function(e,a,i,r,n,s,l,o,c){const u=s.data,d=s.stride||s.size,f=e[0],m=e[1],h=e[2],p=a[0],g=a[1],v=a[2],O=p-f,x=g-m,P=v-h;for(let e=i;e<r;++e){const a=l[e];let i=3*a,r=d*n[i++],s=u[r++],p=u[r++],g=u[r];r=d*n[i++];let v=u[r++],M=u[r++],A=u[r];r=d*n[i];let b=u[r++],F=u[r++],T=u[r];t(o)&&([s,p,g]=o.applyToVertex(s,p,g,e),[v,M,A]=o.applyToVertex(v,M,A,e),[b,F,T]=o.applyToVertex(b,F,T,e));const S=v-s,C=M-p,_=A-g,I=b-s,L=F-p,y=T-g,R=x*y-L*P,D=P*I-y*O,E=O*L-I*x,N=S*R+C*D+_*E;if(Math.abs(N)<=Number.EPSILON)continue;const z=f-s,U=m-p,j=h-g,Y=z*R+U*D+j*E;if(N>0){if(Y<0||Y>N)continue}else if(Y>0||Y<N)continue;const w=U*_-C*j,B=j*S-_*z,q=z*C-S*U,W=O*w+x*B+P*q;if(N>0){if(W<0||Y+W>N)continue}else if(W>0||Y+W<N)continue;const k=(I*w+L*B+y*q)/N;if(k>=0){c(k,G(S,C,_,I,L,y,V),a,!1)}}}(e,a,i,r,n,s,l,o,c);const u=s.data,d=s.stride||s.size,f=e[0],m=e[1],h=e[2],p=a[0]-f,g=a[1]-m,v=a[2]-h;for(let e=i,a=3*i;e<r;++e){let i=d*n[a++],r=u[i++],s=u[i++],l=u[i];i=d*n[a++];let O=u[i++],x=u[i++],P=u[i];i=d*n[a++];let M=u[i++],A=u[i++],b=u[i];t(o)&&([r,s,l]=o.applyToVertex(r,s,l,e),[O,x,P]=o.applyToVertex(O,x,P,e),[M,A,b]=o.applyToVertex(M,A,b,e));const F=O-r,T=x-s,S=P-l,C=M-r,_=A-s,I=b-l,L=g*I-_*v,y=v*C-I*p,R=p*_-C*g,D=F*L+T*y+S*R;if(Math.abs(D)<=Number.EPSILON)continue;const E=f-r,N=m-s,z=h-l,U=E*L+N*y+z*R;if(D>0){if(U<0||U>D)continue}else if(U>0||U<D)continue;const j=N*S-T*z,Y=z*F-S*E,w=E*T-F*N,B=p*j+g*Y+v*w;if(D>0){if(B<0||U+B>D)continue}else if(B>0||U+B<D)continue;const q=(C*j+_*Y+I*w)/D;if(q>=0){c(q,G(F,T,S,C,_,I,V),e,!1)}}}const j=u(),Y=u();function G(e,t,a,i,r,n,s){return l(j,e,t,a),l(Y,i,r,n),o(s,j,Y),c(s,s),s}function w(e,t,a){return l(a,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function B(e,t,a,i){return q(e,t,a,i,1/0)}function q(e,t,a,i,r){const n=(e[0]-i-t[0])*a[0],s=(e[3]+i-t[0])*a[0];let l=Math.min(n,s),o=Math.max(n,s);const c=(e[1]-i-t[1])*a[1],u=(e[4]+i-t[1])*a[1];if(o=Math.min(o,Math.max(c,u)),o<0)return!1;if(l=Math.max(l,Math.min(c,u)),l>o)return!1;const d=(e[2]-i-t[2])*a[2],f=(e[5]+i-t[2])*a[2];return o=Math.min(o,Math.max(d,f)),!(o<0)&&(l=Math.max(l,Math.min(d,f)),!(l>o)&&l<r)}function W(e,t,a,i,r){let n=(a.screenLength||0)*e.pixelRatio;r&&(n=function(e,t,a,i){return T(e,b(t,a,i))}(n,i,t,r));const l=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return s(l*t,a.minWorldLength||0,null!=a.maxWorldLength?a.maxWorldLength:1/0)}function k(e,t,a){if(!e)return;const i=e.parameters,r=e.paddingPixelsOverride;t.setUniform4f(a,i.divisor,i.offset,i.minPixelSize,r)}function X(e,t){const a=t?X(t):{};for(const t in e){let i=e[t];i&&i.forEach&&(i=J(i)),null==i&&t in a||(a[t]=i)}return a}function H(e,t){let a=!1;for(const i in t){const r=t[i];void 0!==r&&(a=!0,Array.isArray(r)?e[i]=r.slice():e[i]=r)}return a}function Z(e,t,a,r,n,l){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(i.POSITION).data,c=e.vertexAttributes.get(i.SIZE),u=c&&c.data[0],d=r[0],f=r[1],m=((u+n)/2+4)*e.screenToWorldRatio;let h=Number.MAX_VALUE,p=0;for(let e=0;e<o.length-5;e+=3){const t=o[e],a=o[e+1],i=d-t,r=f-a,n=o[e+3]-t,l=o[e+4]-a,c=s((n*i+l*r)/(n*n+l*l),0,1),u=n*c-i,m=l*c-r,g=u*u+m*m;g<h&&(h=g,p=e/3)}h<m*m&&l(a.dist,a.normal,p,!1)}function J(e){const t=[];return e.forEach((e=>t.push(e))),t}const K={multiply:1,ignore:2,replace:3,tint:4},Q=1e3;class $ extends O{constructor(e,t){super(),this.type=x.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=P,this._parameters=X(e,t),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e){H(this._parameters,e)&&(this.validateParameters(this._parameters),this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleInPass(e.pass)&&0!=(this.renderOccluded&e.renderOccludedMask)}isVisibleInPass(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){t(this.repository)&&this.repository.materialChanged(this)}}var ee;!function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(ee||(ee={}));const te={renderOccluded:ee.Occlude};export{O as C,P as D,$ as M,ee as R,te as a,x as b,Z as c,C as d,A as e,G as f,M as g,q as h,E as i,k as j,U as k,w as l,B as m,K as n,T as o,S as p,X as q,H as u,W as v};
