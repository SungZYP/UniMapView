/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{i as e,b as t,L as l}from"../core/lang.js";import{_ as s}from"./tslib.es6.js";import n from"../core/Accessor.js";import o from"../core/Collection.js";import{r as a}from"./collectionUtils.js";import r from"../core/Handles.js";import{throwIfAborted as i,isAbortError as u}from"../core/promiseUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import{g as f}from"./uuid.js";import{B as c,a as p,b as m}from"./BuildingFilterBlock.js";const y=e=>t=>{var l;const s=e.toLowerCase();return null!=(l=t.sublayers.find((e=>{var t;return(null==(t=e.modelName)?void 0:t.toLowerCase())===s})))?l:null},g=y("fullmodel"),v=y("overview");function w(t){const l=g(t);e(l)&&(l.visible=!0);const s=v(t);e(s)&&(s.visible=!1)}function _(l,s){const n=function(e,t){var l,s,n;const o=null!=(l=null==(s=e.summaryStatistics)?void 0:s.fields)?l:[],a=t.toLowerCase();return null!=(n=o.find((e=>{var t;return(null==(t=e.modelName)?void 0:t.toLowerCase())===a})))?n:null}(l,s);if(t(n))return null;const o=n.fieldName;if(t(o)||!o)return null;const a=function(e,t){for(const l of e.allSublayers.items){const e="building-component"===l.type?l.getFieldDomain(t):null;if(e&&"coded-value"===e.type)return e}return null}(l,o),r=new Map;for(const t of null!=(i=n.mostFrequentValues)?i:[]){var i;"number"==typeof t&&r.set(t,e(a)?a.getName(t):String(t))}return{fieldName:o,fieldValueMap:r}}function b(){let e=new AbortController;return async t=>{e.abort(),e=new AbortController;const l={signal:e.signal},s=t.toArray().map((e=>async function(e,t){await e.load(t),await e.loadAll(),i(t),e.summaryStatistics&&await e.summaryStatistics.load(t)}(e,l)));await Promise.all(s),i(l)}}function V(e){const t={fieldValueMap:new Map,allowedValues:[]};for(const l of e){const e=l.fieldValueMap,s=t.fieldValueMap;e.forEach(((e,l)=>{s.has(l)||(s.set(l,e),t.allowedValues.push(l))}))}return t.allowedValues.sort(((e,t)=>e-t)),t}function x(e,t){return t.allowedValues.length>0?function(e,t){if(0===t.length)return e;if(e===1/0)return t[t.length-1];if(e===-1/0)return t[0];let l=t[0],s=Math.abs(l-e);for(const n of t){const t=Math.abs(n-e);t<s&&(l=n,s=t)}return l}(e,t.allowedValues):null}let I=class extends n{constructor(e){super(e),this.state="disabled",this._handles=new r,this._domainInfo=V([]),this._loadLayers=b(),this.layers=new o}initialize(){this._handles.add(this.layers.on("change",(()=>this._onLayersChange()))),this._onLayersChange()}destroy(){this._set("state","disabled"),this._handles.destroy()}get enabled(){return this.allowedValues.length>0&&this._get("enabled")}set enabled(e){e!==this.enabled&&this.allowedValues.length>0&&this._set("enabled",e)}set value(e){if(e===this.value)return;const l=x(e,this);t(l)||this._set("value",l)}get min(){return function(t){let l=null;for(const s of t)l=e(l)?Math.min(l,s):s;return l}(this.allowedValues)}get max(){return function(t){let l=null;for(const s of t)l=e(l)?Math.max(l,s):s;return l}(this.allowedValues)}get allowedValues(){return this._domainInfo.allowedValues}get hasNext(){if(!this.enabled)return!0;const e=this._valueIndex;return e>=0&&e<this.allowedValues.length-1}get hasPrevious(){return!this.enabled||this._valueIndex>0}set layers(e){const t=this._get("layers");this._set("layers",a(e,t))}get filterExpressions(){return{solid:null,xRay:null}}get _valueIndex(){return l(this.allowedValues,this.value)}select(t){const l=x(t,this);e(l)&&(this.enabled=!0,this.value=t)}clear(){this.enabled=!1}next(){if(0!==this.allowedValues.length)return this.enabled?void(this.hasNext&&(this.value=this.allowedValues[this._valueIndex+1])):(this.enabled=!0,void(this.value=this.allowedValues[0]))}previous(){if(0!==this.allowedValues.length)return this.enabled?void(this.hasPrevious&&(this.value=this.allowedValues[this._valueIndex-1])):(this.enabled=!0,void(this.value=this.allowedValues[this.allowedValues.length-1]))}getValueLabel(e){var t;return 0===this.layers.length?null:null!=(t=this._domainInfo.fieldValueMap.get(e))?t:null}async _onLayersChange(){if(this._set("state","loading"),this._domainInfo=V([]),0!==this.layers.length)try{await this._loadLayers(this.layers),this._setup(),this._set("state","ready")}catch(e){u(e)||this._set("state","failed")}}};s([d({value:!1,nonNullable:!0})],I.prototype,"enabled",null),s([d({value:0,nonNullable:!0})],I.prototype,"value",null),s([d({readOnly:!0})],I.prototype,"min",null),s([d({readOnly:!0})],I.prototype,"max",null),s([d({readOnly:!0})],I.prototype,"allowedValues",null),s([d({readOnly:!0})],I.prototype,"hasNext",null),s([d({readOnly:!0})],I.prototype,"hasPrevious",null),s([d({type:o,nonNullable:!0})],I.prototype,"layers",null),s([d({nonNullable:!0})],I.prototype,"state",void 0),s([d({readOnly:!0})],I.prototype,"_valueIndex",null),s([d()],I.prototype,"_domainInfo",void 0),I=s([h("esri.widgets.BuildingExplorer.BuildingNumericFilterViewModel")],I);const N=I;function L(){return`${f()}__BUILDING_EXPLORER_FILTER__`}function M(e){const t="string"==typeof e?e:e.id;return!!t&&-1!==t.indexOf("__BUILDING_EXPLORER_FILTER__")}function j(t,l){for(const s of t.items)for(const t of s.filters.items){if(!M(t))continue;const s=l(t);if(e(s))return s}return null}function O(l,s){l.forEach((l=>{const n=l.filters.filter((e=>!M(e)));e(s)&&n.push(s),function(e,l){const s=l.length;if(t(e)||e.length!==s)return!1;for(let t=0;t<s;++t){const s=l.getItemAt(t).toJSON(),n=e.getItemAt(t).toJSON();if(s.id="",n.id="",JSON.stringify(s)!==JSON.stringify(n))return!1}return!0}(l.filters,n)||(l.filters=n);const o=l.filters.find((e=>M(e)));l.activeFilterId=e(o)?o.id:null}))}function E(e){const t=C(e);return t?new c({filterExpression:t,filterMode:new p}):null}function S(e){const t=C(e);return t?new c({filterExpression:t,filterMode:new m}):null}function C(e){return e.filter((e=>!!e)).map((e=>`(${e})`)).join(" AND ")}export{N as B,E as a,L as b,b as c,w as d,_ as e,g as f,S as g,V as h,j as i,O as s};
