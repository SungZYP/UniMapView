/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{A as t}from"./ArrayPool.js";import i from"../core/Handles.js";import{x as s,i as n,h as a,r}from"../core/lang.js";import{watch as o,initial as l}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import{s as u}from"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{eachAlwaysValues as d,c as p}from"../core/promiseUtils.js";import"./Logger.js";import{e as m}from"./mathUtils.js";import{e as g,I as v}from"./InputManager.js";import{addFrameTask as _,M as b}from"../core/scheduling.js";import w from"../views/input/gamepad/GamepadInputDevice.js";import{b as f}from"./screenUtils2.js";import{f as y}from"./screenUtils.js";import P from"../core/Error.js";import{a as D}from"./capabilities2.js";import{C as x,g as k}from"./context-util.js";const T={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,s=this.values;return t<=i.xsmall?s.xsmall:t<=i.small?s.small:t<=i.medium?s.medium:t<=i.large?s.large:s.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,s=this.values;return t<=i.xsmall?s.xsmall:t<=i.small?s.small:t<=i.medium?s.medium:t<=i.large?s.large:s.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],s=t[1],n=this.values;return s>=i?n.portrait:n.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},E={xsmall:544,small:768,medium:992,large:1200};function C(e,t){return t?T[e].valueToClassName[t].split(" "):[]}const S=n=>{let a=class extends n{constructor(...e){super(...e),this._breakpointsHandles=new i,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=E}initialize(){this._breakpointsHandles.add(o((()=>[this.breakpoints,this.size]),(()=>this._updateClassNames()),l))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=s(this._breakpointsHandles))}set breakpoints(e){if(e===this._get("breakpoints"))return;const t=function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e);if(!t){const e=JSON.stringify(E,null,2);console.warn("provided breakpoints are not valid, using defaults:"+e)}e=t?e:E,this._set("breakpoints",{...e})}_updateClassNames(){if(!this.container)return;const e=t.acquire(),i=t.acquire();let s,n=!1;for(s in T){const t=this[s],a=T[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});t!==a&&(n=!0,this[s]=a,C(s,t).forEach((e=>i.push(e))),C(s,a).forEach((t=>e.push(t))))}n&&(this._applyClassNameChanges(e,i),t.release(e),t.release(i))}_applyClassNameChanges(e,t){const i=this.container;i&&(t.forEach((e=>i.classList.remove(e))),e.forEach((e=>i.classList.add(e))))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in T)C(t,this[t]).forEach((t=>e.classList.remove(t)))}};return e([h()],a.prototype,"breakpoints",null),e([h()],a.prototype,"orientation",void 0),e([h()],a.prototype,"widthBreakpoint",void 0),e([h()],a.prototype,"heightBreakpoint",void 0),a=e([c("esri.views.BreakpointsOwner")],a),a},I=t=>{let i=class extends t{async fetchPopupFeatures(e,t){await this.when();const{location:i,queryArea:s,layerViewsAndGraphics:n,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(e,t),r=Promise.resolve(a),o=this._queryLayerPopupFeatures(s,n,t),l=o.map((e=>e.promise));return{location:i,clientOnlyGraphics:a,allGraphicsPromise:d([r,...l]).then((e=>Array.from(new Set(e.flat())))),promisesPerLayerView:o}}_queryLayerPopupFeatures(e,t,i){return t.map((({layerView:t,graphics:s})=>{const a={clientGraphics:s,event:n(i)?i.event:null,signal:n(i)?i.signal:null,defaultPopupTemplateEnabled:!!n(i)&&!!i.defaultPopupTemplateEnabled},r=t.fetchPopupFeatures(e,a);return{layerView:t,promise:r}}))}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(n(t)&&t.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(e,t){const{clientGraphics:i,queryArea:s,location:n}=await this._popupHitTestGraphics(e,t),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:r,clientOnlyGraphics:o}=this._graphicsPerFetchPopupLayerView(i,a);return{clientOnlyGraphics:o,layerViewsAndGraphics:r,queryArea:s,location:n}}async _popupHitTestGraphics(e,t){const{results:i,mapPoint:s}=await this.popupHitTest(e),n=i.filter((e=>this._isValidPopupGraphic(e.graphic,t))),a=n.length?n[0].mapPoint:null;return{clientGraphics:n.map((e=>e.graphic)),queryArea:s,location:s||a}}_getFetchPopupLayerViews(){const e=[];return this.allLayerViews.forEach((t=>{this._isValidPopupLayerView(t)&&e.push(t)})),n(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()}_isValidPopupLayerView(e){return n(e)&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e}_graphicsPerFetchPopupLayerView(e,t){const i=[],s=new Map,n=t.map((e=>{const t=[];return"layer"in e?s.set(e.layer,t):s.set(e.graphics,t),{layerView:e,graphics:t}}));for(const t of e){const e=s.get(t.layer)||s.get(t.sourceLayer)||null;e?e.push(t):i.push(t)}return{layerViewsAndGraphics:n,clientOnlyGraphics:i}}};return i=e([c("esri.views.PopupView")],i),i};function L(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}function M(e,t){if("touch"===e.pointerType)return!1;switch(t){case"primary":return 0===e.button;case"secondary":return 2===e.button;case"tertiary":return 1===e.button}}class G{constructor(e){this.callbacks=e,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this.currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this.previousEvent),this.currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this.startEvent&&this._emitEnd(this.previousEvent),this.currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this.currentCount=0}this.previousEvent=e}_emitStart(e){this.startEvent=e,this.callbacks.condition(this.currentCount,e)&&this.callbacks.start(this.currentCount,e,this.startEvent)}_emitUpdate(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.update(this.currentCount,e,this.startEvent)}_emitEnd(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.end(this.currentCount,e,this.startEvent),this.startEvent=null}}function A(e){let t=e*e;return e<0&&(t*=-1),t}function U(e){return e.translation[0]=0,e.translation[1]=0,e.translation[2]=0,e.heading=0,e.tilt=0,e}function V(e,t,i){const s=i,n=e.state,a=e.device,r="forward-down"===t.tiltDirection?1:-1;return"standard"===a.deviceType?(s.translation[0]=A(n.axes[0]),s.translation[1]=A(n.axes[1]),s.translation[2]=A(n.buttons[7])-A(n.buttons[6]),s.heading=A(n.axes[2]),s.tilt=A(n.axes[3])):"spacemouse"===a.deviceType&&(s.translation[0]=1.2*A(n.axes[0]),s.translation[1]=1.2*A(n.axes[1]),s.translation[2]=2*-A(n.axes[2]),s.heading=1.2*A(n.axes[5]),s.tilt=1.2*A(n.axes[3])),s.tilt*=r,m(s.translation,s.translation,1),s}function H(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function q(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom}function j(e){const t=e.native;return t?{buttons:t.buttons.map((e=>e.pressed?e.value?e.value:1:0)),axes:t.axes.map((t=>function(e,t){const i=Math.abs(e);if(i<t)return 0;return Math.sign(e)*(i-t)/(1-t)}(t,e.axisThreshold)))}:{buttons:[],axes:[]}}class z{constructor(e,t){this.element=e,this.input=t,this._hasEventListeners=!1,this._onConnectGamepad=e=>{this._connectGamepad(e.gamepad)},this._onDisconnectGamepad=e=>{const t=e.gamepad,i=t.index,s=this.inputDevices[i];s&&(this._emitGamepadEvent(t,j(s),!1),this.inputDevices.splice(i,1),this.latestUpdate.splice(i,1),this.input.gamepad.devices.remove(s),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null;const i="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=i&&s,this.supported&&(this._forEachGamepad((e=>this._connectGamepad(e))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this.callback=e}_connectGamepad(e){const t=new w(e);"unknown"!==t.deviceType&&(this.inputDevices[e.index]=t,this.input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this.frameTask&&(this.frameTask=_({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this.frameTask&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this.element.contains(document.activeElement),i="document"===this.input.gamepad.enabledFocusMode&&!e||"view"===this.input.gamepad.enabledFocusMode&&!t;this._forEachGamepad((e=>{const t=this.inputDevices[e.index];if(!t)return;const s=this.latestUpdate[e.index],n=j(t),a=i||function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0}(n);if(s){if(s.timestamp===e.timestamp)return;if(!s.active&&a)return;if(function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}(s.state,n))return}this._emitGamepadEvent(e,n,!a)}))}_forEachGamepad(e){const t=window.navigator.getGamepads();for(let i=0;i<t.length;i++){const s=t[i];this._validate(s)&&e(s)}}_emitGamepadEvent(e,t,i){const s=this.latestUpdate[e.index],n=s&&s.active;if(!n&&!i)return;const a=!n&&i?"start":n&&i?"update":"end";this.latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this.callback&&this.callback({device:this.inputDevices[e.index],state:t,action:a})}_validate(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}}const F=a("trident"),B=a("edge"),N=a("chrome"),O=a("ff"),W=a("safari"),K="esri-view-surface--touch-none",$="esri-view-surface--touch-pan";class R{constructor(e,t){this.input=t,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new z(e,this.input),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach((e=>{this._releasePointerCaptureSafe(e)})),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(Y[t],e),delete this._active[t]}e&&e.forEach((e=>{if(!this._active[e]&&Y[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(Y[e],t),this._active[e]=t}})),this._gamepadSource.hasEventListeners=e&&e.has("gamepad")}setPointerCapture(e,t){t?(this._element.setPointerCapture(e.pointerId),this._activePointerCaptures.add(e.pointerId)):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?K:$),this._element.classList.add(this._browserTouchPanningEnabled?$:K)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(K),this._element.classList.remove($),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const i=f(this._element,e);return R.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),t.x=i.x,t.y=i.y,t}_handleKey(e,t){const i=g(t);i&&"key-up"===e&&this._keyDownState.delete(i);const s={native:t,key:i,repeat:i&&this._keyDownState.has(i)};i&&"key-down"===e&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,i)}_handleMouseWheel(e,t){let i=t.deltaY;switch(t.deltaMode){case 0:(F||B)&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}F||B?i*=.7:N||W?i*=.6:O&&(i*=1.375);const s=Math.abs(i);if(s>100){const e=.02;i=i/s*200/(1+Math.exp(-e*(s-100)))}const n=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:i});this._callback(e,n)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const i={native:t};t.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}R.test={disableSubpixelCoordinates:!1};const Y={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class J extends v{constructor(){super(!0),this.registerIncoming("context-menu",(e=>{e.data.native.preventDefault()}))}}function Q(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}const X={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class Z extends v{constructor(e=X.maximumDoubleClickDelay,t=X.maximumDoubleClickDistance,i=X.maximumDoubleTouchDelay,s=X.maximumDoubleTouchDistance,n=p){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=t,this.maximumDoubleTouchDelay=i,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach((e=>e.doubleClickTimeout=r(e.doubleClickTimeout)))}get hasPendingInputs(){return u(this._pointerState,(e=>null!=e.doubleClickTimeout))}_pointerId(e){const t=e.native;return"mouse"===t.pointerType?`${t.pointerId}:${t.button}`:`${t.pointerType}`}_handleImmediateClick(e){const t=e.data,i=this._pointerId(t),s=this._pointerState.get(i);if(s){const n="touch"===t.native.pointerType?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;Q(s.event.data,t)>n?(this._clearDoubleClickTimeout(i,!0),this._startClick(e)):(this._clearDoubleClickTimeout(i,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(e)}_startClick(e){const t=this._pointerId(e.data),i="touch"===e.data.native.pointerType?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(t,{event:e,doubleClickTimeout:this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(t)),i)}),this.refreshHasPendingInputs()}_handlePointerDrag(e){const t=this._pointerId(e.data.currentEvent);this._clearDoubleClickTimeout(t,!0)}_handleDrag(e){const t=this._pointerId(e.data.pointer);this._clearDoubleClickTimeout(t,!0)}_clearDoubleClickTimeout(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimeout.remove(),i.doubleClickTimeout=null,t&&this._doubleClickTimeoutExceeded(e),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimeout=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}}class ee extends v{constructor(e){super(!1),this.navigationTouch=e,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,i,s){return{action:e,pointerType:this.pointerType,button:this.mouseButton,buttons:t.buttons,timestamp:s,pointers:se(this.activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const t=e.native.pointerId,i=ie(this.activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this.activePointerMap.set(t,s);const n=ne(s,te(this.activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,i=this.activePointerMap.get(t);i?i.event=e:this._addPointer(e)}_removePointer(e){const t=ie(this.activePointerMap).angle;this.activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=ie(this.activePointerMap);this.activePointerMap.forEach((i=>{i.initialAngle=ne(i,t)-e,i.lastAngle=ne(i,t)-e}))}_emitEvent(e,t,i){const s=ie(this.activePointerMap);this.drag.emit(this._createPayload(e,t,s,i),void 0,this.startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=b(e.timestamp);this.activePointerMap.get(t)&&(1===this.activePointerMap.size?(this._updatePointer(e.data),!this.isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,b(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,s=b(e.timestamp);switch(t.action){case"start":case"update":this.isDragging?this.activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this.isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this.isCurrentDragSuppressed=this.isSuppressed):(this._updatePointer(i),this.pointerType=e.data.startEvent.pointerType,this.mouseButton=e.data.startEvent.button,this.startStateModifiers=e.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&"touch"===this.pointerType&&1===this.activePointerMap.size}}function te(e){const t=[];return e.forEach((e=>{t.push(y(e.event.x,e.event.y))})),function(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:y()},0===e.length)return t;if(1===e.length)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(2===e.length){const[i,s]=e,[n,a]=[s.x-i.x,s.y-i.y];return t.radius=Math.sqrt(n*n+a*a)/2,t.center.x=(i.x+s.x)/2,t.center.y=(i.y+s.y)/2,t}let i=0,s=0;for(let t=0;t<e.length;t++)i+=e[t].x,s+=e[t].y;i/=e.length,s/=e.length;const n=e.map((e=>e.x-i)),a=e.map((e=>e.y-s));let r=0,o=0,l=0,h=0,u=0,c=0,d=0;for(let e=0;e<n.length;e++){const t=n[e],i=a[e],s=t*t,p=i*i;r+=s,o+=p,l+=t*i,h+=s*t,u+=p*i,c+=t*p,d+=i*s}const p=.5*(h+c),m=.5*(u+d),g=r*o-l*l,v=(p*o-m*l)/g,_=(r*m-l*p)/g,b=y(v+i,_+s);return{radius:Math.sqrt(v*v+_*_+(r+o)/e.length),center:b}}(t)}function ie(e){const t=te(e);let i=0;return e.forEach((e=>{let s=ne(e,t),n=s-e.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=e.lastAngle+n,e.lastAngle=s;const a=s-e.initialAngle;i+=a})),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function se(e){const t=new Map;return e.forEach(((e,i)=>t.set(i,e.event))),t}function ne(e,t){const i=e.event,s=i.x-t.center.x,n=i.y-t.center.y;return Math.atan2(n,s)}var ae;!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"}(ae||(ae={}));class re extends v{constructor(e=X.maximumDoubleClickDelay,t=X.maximumDoubleClickDistance,i=X.maximumDoubleTouchDelay,s=X.maximumDoubleTouchDistance,n=p){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=t,this.maximumDoubleTouchDelay=i,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",(e=>{this._handlePointerLoss(e,"pointer-up")})),this.registerIncoming("pointer-capture-lost",(e=>{this._handlePointerLoss(e,"pointer-capture-lost")})),this.registerIncoming("pointer-cancel",(e=>{this._handlePointerLoss(e,"pointer-cancel")}))}onUninstall(){this._pointerState.forEach((e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=this._pointerId(t);if(!this._pointerState.has(i)){const e={downButton:t.native.button,immediateDoubleClick:null};this._pointerState.set(i,e),this.startCapturingPointer(t.native)}}_handlePointerLoss(e,t){const i=e.data,s=this._pointerId(i),n=this._pointerState.get(s);if(n&&"pointer-up"===t&&n.downButton===i.native.button){const t=n.immediateDoubleClick;if(t){t.timeoutHandle.remove();const s="touch"===e.data.native.pointerType?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;Q(t,e.data)>s?this._startImmediateDoubleClick(e,n):(this._immediateDoubleClick.emit(e.data,void 0,t.modifiers),this._removeState(i))}else this._startImmediateDoubleClick(e,n)}}_startImmediateDoubleClick(e,t){const i="touch"===e.data.native.pointerType?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(e.data)),i)}}_pointerId(e){const t=e.native;return"mouse"===t.pointerType?`${t.pointerId}:${t.button}`:`${t.pointerType}`}_removeState(e){const t=this._pointerId(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}const oe=300,le=1.5,he=6,ue=6,ce=500;class de extends v{constructor(e=oe,t=le,i=he,s=ue,n=ce,a=p){super(!1),this.maximumClickDelay=e,this.movementUntilMouseDrag=t,this.movementUntilPenDrag=i,this.movementUntilTouchDrag=s,this.holdDelay=n,this._clock=a,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",(e=>{this._handlePointerLoss(e,"pointer-up")})),this.registerIncoming("pointer-capture-lost",(e=>{this._handlePointerLoss(e,"pointer-capture-lost")})),this.registerIncoming("pointer-cancel",(e=>{this._handlePointerLoss(e,"pointer-cancel")})),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((e=>{null!=e.holdTimeout&&(e.holdTimeout.remove(),e.holdTimeout=null)})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=t.native.pointerId;let s=null;0===this._pointerState.size&&(s=this._clock.setTimeout((()=>{const t=this._pointerState.get(i);if(t){if(!t.isDragging){const i=t.previousEvent;this._pointerHold.emit(i,void 0,e.modifiers),t.holdEmitted=!0}t.holdTimeout=null}}),this.holdDelay));const n={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_createPointerDragData(e,t,i){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:i}}_handlePointerMove(e){const t=e.data,i=t.native.pointerId,s=this._pointerState.get(i);if(s){if(s.isDragging)this._pointerDrag.emit(this._createPointerDragData("update",s,t),void 0,s.modifiers);else{(function(e,t){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)})(t,s.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e)}s.previousEvent=t}}_getDragThreshold(e){switch(e){case"touch":return this.movementUntilTouchDrag;case"pen":return this.movementUntilPenDrag;default:return this.movementUntilMouseDrag}}_startDragging(e){const t=e.data,i=t.native.pointerId;this._pointerState.forEach((s=>{null!=s.holdTimeout&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=e.modifiers,s.isDragging=!0,i===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,t)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),e.timestamp))}))}_handlePointerLoss(e,t){const i=e.data,s=i.native.pointerId,n=this._pointerState.get(s);if(n){if(null!=n.holdTimeout&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging)this._pointerDrag.emit(this._createPointerDragData("end",n,"pointer-up"===t?i:n.previousEvent),void 0,n.modifiers);else if("pointer-up"===t&&n.downButton===i.native.button){e.timestamp-n.startTimestamp<=this.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i)}this._pointerState.delete(s),this.stopCapturingPointer(i.native),0===this._pointerState.size&&this._moveHandle.pause()}}}function pe(e){const t=function(e){const t=k(e);for(;t.length>1;){const e=D(t.shift());if(e.available)return e}return D(t.shift())}(e);if(!t.available)return new P("webgl:required","WebGL is required but not supported.");if("3d"===e&&t.majorPerformanceCaveat)return new P("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!t.supportsHighPrecisionFragment)return new P("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!t.supportsVertexShaderSamplers)return new P("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(t.type===x.WEBGL1){if(!t.supportsElementIndexUint)return new P("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!t.supportsStandardDerivatives)return new P("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!t.supportsInstancedArrays)return new P("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}export{R as B,G as D,re as I,de as P,Z as S,V as a,X as b,ee as c,J as d,L as e,S as f,I as g,pe as h,q as i,M as j,H as k,Q as m,U as r};
