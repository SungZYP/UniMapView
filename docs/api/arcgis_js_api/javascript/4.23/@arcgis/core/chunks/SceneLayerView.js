/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{clone as e,i as t,b as r,o as n}from"../core/lang.js";import{a as s}from"./attributeUtils.js";import{fixFields as i,unpackFieldNames as o,collectLabelingFields as a,collectFilterFields as l}from"../layers/support/fieldUtils.js";import{_ as d}from"./tslib.es6.js";import u from"../core/Accessor.js";import{L as c}from"./Logger.js";import{r as p}from"./tracking.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{S as y}from"./watch.js";import{HandleOwner as h}from"../core/HandleOwner.js";import"./ensureType.js";import g from"../views/layers/LayerView.js";const b={setAttribute(){},rollback(){},commit(){}};var w;function I(t,n){const s=n.attributes[t.objectIdField],i=t.sessions.get(s);if(i)return i;const o=e(n.attributes),a=new Set;if(null==s)return b;const l=t.attributeOverrides.createInteractiveEditSession(s),d=new Map;let u=w.EDITING;const c={setAttribute(e,i){if(u!==w.EDITING)return;const o=t.fieldsIndex.get(e);if(r(o))return;const c=t.attributeStorageInfo.findIndex((e=>e.name===o.name));if(c<0)return;l.set(c,i);const p=t.attributeStorageInfo[c];let f=!1;a.add(e),t.forEachNode(((e,r)=>{const o=((e,t)=>{const r=d.get(e);if(null==r){const r=t.indexOf(s);return d.set(e,r),r}return r})(e,r);if(-1===o)return;const a=t.getAttributeData(e.index);if(a){const r=a[p.name];r&&(r[o]=i,t.setAttributeData(e.index,a,n),f=!0)}})),f&&t.clearMemCache()},rollback(){if(u===w.EDITING){for(const e of a)this.setAttribute(e,o[e]);l.rollback(),u=w.ROLLED_BACK,t.sessions.delete(s)}},commit(){u===w.EDITING&&(l.commit(),u=w.COMMITTED,t.sessions.delete(s))}};return t.sessions.set(s,c),c}function F(e,r){const n=function(e,t){const r=t.edits.updateFeatures;if(!r||0===r.length)return new U;const n=function(e){const t=new Set;if(!e.updatedFeatures)return t;for(const r of e.updatedFeatures)null!=r.objectId&&null==r.error&&t.add(r.objectId);return t}(t),i=new U,o=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)o.set(e.attributeStorageInfo[t].name,t);const a=e.fieldsIndex,l=e.objectIdField,d=r.filter((e=>{const t=s(a,e.attributes,l);return n.has(t)}));return e.forEachNode(((t,r)=>{const n=new Set(r);for(const o of d){const d=s(a,o.attributes,l);if(!n.has(d))continue;const u=r.indexOf(d);for(const r in o.attributes){const n=e.fieldsIndex.normalizeFieldName(r),s=v(i,t.index,n),a=o.attributes[r];s.push({featureIndex:u,featureId:d,value:a})}}})),i}(e,r);if(0===n.size)return;const i=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)i.set(e.attributeStorageInfo[t].name,t);let o=!1;n.forEach(((r,n)=>{const s=e.getAttributeData(n);let a=!1;r.forEach(((r,n)=>{const l=t(s)?s[n]:null,d=i.get(n);for(const{featureIndex:t,value:n,featureId:s}of r)l&&(l[t]=n,a=!0,o=!0),e.attributeOverrides.updateValue(s,d,n)})),a&&e.setAttributeData(n,s,null)})),o&&e.clearMemCache()}function v(e,t,r){const n=function(e,t){const r=e.get(t);if(r)return r;const n=new x;return e.set(t,n),n}(e,t),s=n.get(r);if(s)return s;const i=new Array;return n.set(r,i),i}!function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"}(w||(w={}));const x=Map,U=Map;function A(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return e.outFields?i(t,[...o(t,e.outFields),...r]):i(t,r)}}}}const E=e=>{let t=class extends e{constructor(){super(...arguments),this._numUpdating=0,this.asyncUpdateState=new Map}get updating(){return this._numUpdating>0}autoUpdateAsync(e,t){return function(e,t){const r=()=>{i&&!o&&e(n)},n=()=>{if(!i||o)return t();i.clear(),o=!0;const e=p(i,t);return o=!1,e},s=()=>{i&&(i.destroy(),i=null)};let i=new y(r),o=!1;return e(n),{remove:s}}((t=>this._updateAsync(e,t)),t)}async _updateAsync(e,t){if(!this._startAsyncUpdate(e)){try{const r=await t();this._set(e,r)}catch(t){c.getLogger(this.declaredClass).warn(`Async update of "${e}" failed. Async update functions should not throw exceptions.`)}this._endAsyncUpdate(e)&&this._updateAsync(e,t)}}_startAsyncUpdate(e){var t;const r=null!=(t=this.asyncUpdateState.get(e))?t:S.None;return r&S.Updating?(this.asyncUpdateState.set(e,r|S.Invalidated),!0):(++this._numUpdating,this.asyncUpdateState.set(e,r|S.Updating),!1)}_endAsyncUpdate(e){var t;--this._numUpdating;const r=(null!=(t=this.asyncUpdateState.get(e))?t:S.None)&~S.Updating;return r&S.Invalidated?(this.asyncUpdateState.set(e,r&~S.Invalidated),!0):(this.asyncUpdateState.set(e,r),!1)}};return d([f({readOnly:!0})],t.prototype,"updating",null),d([f()],t.prototype,"_numUpdating",void 0),t=d([m("esri.core.AsyncUpdate")],t),t};var S;!function(e){e[e.None=0]="None",e[e.Updating=1]="Updating",e[e.Invalidated=2]="Invalidated"}(S||(S={}));let N=class extends(E(u)){};N=d([m("esri.core.AsyncUpdate")],N);const O=c.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields");let j=class extends(E(h)){constructor(e){super(e)}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:s,viewFilterFields:o}=this;return i(e,[...n(t,[]),...n(r,[]),...n(s,[]),...n(o,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",(()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?_((r=>t.collectRequiredFields(r,e))):null})),this.autoUpdateAsync("labelingFields",(()=>{const{layer:e}=this;return e.labelsVisible?_((t=>a(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:t}=this.layerView;return _((r=>l(r,e,t)))}))])}};async function _(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return O.error(e),null}}d([f()],j.prototype,"layerView",void 0),d([f()],j.prototype,"layer",void 0),d([f()],j.prototype,"requiredFields",null),d([f()],j.prototype,"rendererFields",void 0),d([f()],j.prototype,"labelingFields",void 0),d([f()],j.prototype,"viewFilterFields",void 0),j=d([m("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],j);class D extends g{constructor(){super(...arguments),this.layer=null,this.filter=null}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}}d([f()],D.prototype,"layer",void 0),d([f()],D.prototype,"availableFields",null),d([f()],D.prototype,"maximumNumberOfFeatures",null),d([f({readOnly:!0})],D.prototype,"maximumNumberOfFeaturesExceeded",null),d([f()],D.prototype,"filter",void 0);export{D as S,j as a,I as c,A as d,F as p};
