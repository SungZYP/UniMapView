/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Accessor.js";import{E as s}from"./Evented.js";import i from"../core/Handles.js";import{i as r}from"../core/lang.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{P as h}from"../core/scheduling.js";import{b as o,c,z as d,e as l,h as p,k as u}from"./aaBoundingRect.js";import{n as g,T as m}from"./Scheduler.js";import{U as y,O as S}from"./basicInterfaces.js";import{init as v}from"../core/watchUtils.js";import{g as _}from"./projectionEllipsoid.js";import{F as f}from"./LayerView3D.js";import{m as b}from"./handleUtils.js";class x{constructor(){this._extents=new h({allocator:e=>e||o()}),this._tmpExtent=o(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),c(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=g){const t=this._extents,s=new Set;let i=0;for(;i!==t.length;){t.sort(((e,t)=>e[0]-t[0])),i=t.length,s.clear();for(let i=0;i<t.length;++i){if(e.done)return;const r=t.getItemAt(i);for(let e=i+1;e<t.length;++e){const i=t.getItemAt(e);if(i[0]>=r[2])break;s.add(i)}s.forEach((i=>{if(r===i)return;if(i[2]<=r[0])return void s.delete(i);const a=d(r),n=d(i),h=this._tmpExtent;l(r,i,h);const o=a+n;(d(h)-o)/o<.05&&(c(r,h),s.delete(i),t.remove(i),e.madeProgress())})),s.add(r)}}this._dirty=!1}_contains(e){return this._extents.some((t=>p(t,e)))}_removeContained(e){this._extents.filterInPlace((t=>!p(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>u(e,t)))}}}let j=class extends t{constructor(){super(...arguments),this.dirtyExtents=new x,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new i,this.updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new s}setup(e,t,s,i){this.graphicsCoreOwner=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=s,this.elevationProvider=i;const r=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add([i.on("elevation-change",(e=>this._elevationChanged(e))),this.graphicsCoreOwner.watch("suspended",(()=>this._suspendedChange())),r.registerTask(m.ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this.updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this._markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,s=this.graphicsCore.effectiveUpdatePolicy===y.ASYNC;for(const i of this.dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(i);if(this.dirtyGraphicsSet.delete(i),r(a)&&(a.alignWithElevation(this.elevationProvider,t,s),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),s=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:s});const i=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,s,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);r(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-i)+.9*this.averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:s}=e;if(this.graphicsCoreOwner.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:s})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}};e([a({readOnly:!0})],j.prototype,"updating",null),e([a({readOnly:!0})],j.prototype,"updatingRemaining",null),j=e([n("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],j);const w=j;let C=class extends t{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new i,this.graphicsCoreOwner=null,this.updating=!0}setup(e){this.graphicsCoreOwner=e,this.extentIntersection=new f({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,s=t.basemapTerrain,i=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this._viewChange())),t.state.watch("camera",(()=>this._viewChange()),!0),i.registerTask(m.FRUSTUM_VISIBILITY,this),s.on("elevation-bounds-change",(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([v(s,["opacity","wireframe"],(()=>this._updateIsVisibleBelowSurface())),v(t,"map.ground.navigationConstraint.type",(()=>this._updateIsVisibleBelowSurface()))])}destroy(){this.graphicsCoreOwner=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,s="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=s||!t.opaque||i}_updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurface)t=-.3*_(e.spatialReference).radius;else{const{min:s,max:i}=e.basemapTerrain.elevationBounds;t=s-Math.max(1,(i-s)*(1.2-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,t=_(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}};e([a({readOnly:!0})],C.prototype,"suspended",void 0),e([a({readOnly:!0})],C.prototype,"updating",void 0),C=e([n("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],C);const I=C;var E;!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(E||(E={}));class O{constructor(){this.items=[]}addObject(e,t){this.items.push({type:E.Object,objectStateId:t,object:e})}addRenderGeometry(e,t,s){this.items.push({type:E.RenderGeometry,objectStateId:t,renderGeometry:e,owner:s})}addExternal(e,t){this.items.push({type:E.External,objectStateId:t,remove:e})}remove(e){for(let t=this.items.length-1;t>=0;--t){const s=this.items[t];s.objectStateId===e&&(this._removeObjectStateItem(s),this.items.splice(t,1))}}removeObject(e){for(let t=this.items.length-1;t>=0;--t){const s=this.items[t];s.type===E.Object&&s.object===e&&(this._removeObjectStateItem(s),this.items.splice(t,1))}}removeRenderGeometry(e){for(let t=this.items.length-1;t>=0;--t){const s=this.items[t];s.type===E.RenderGeometry&&s.renderGeometry===e&&(this._removeObjectStateItem(s),this.items.splice(t,1))}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e)})),this.items=[]}_removeObjectStateItem(e){switch(e.type){case E.Object:e.objectStateId.channel===S.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===S.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case E.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case E.External:e.remove(e.objectStateId)}}}class G{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new O,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class D{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets=null}acquireSet(e,t){const s=new G(e,t);this._stateSets.push(s);const i=b((()=>this.releaseSet(s)));return{set:s,handle:i}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const s=this._graphicsCore.graphics3DGraphics.get(t);s&&this._addObjectStateSet(s,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((s=>{const i=t.get(s);i&&this._addObjectStateSet(i,e)}))}get test(){return{states:this._stateSets}}}export{w as G,I as a,D as b};
