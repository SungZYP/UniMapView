/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{i as e}from"../core/lang.js";import{urlToObject as n}from"../core/urlUtils.js";import{g as i}from"./scaleUtils.js";import{g as t,c as s}from"./floorFilterUtils.js";function r(e,n){return n?{...n,query:{...e,...n.query}}:{query:e}}function l(e){return"string"==typeof e?n(e):e}function o(e,n,i){const t={};for(const s in e){if("declaredClass"===s)continue;const r=e[s];if(null!=r&&"function"!=typeof r)if(Array.isArray(r)){t[s]=[];for(let e=0;e<r.length;e++)t[s][e]=o(r[e])}else if("object"==typeof r)if(r.toJSON){const e=r.toJSON(i&&i[s]);t[s]=n?e:JSON.stringify(e)}else t[s]=n?r:JSON.stringify(r);else t[s]=r}return t}function a({mapExtent:n,floors:r,width:l,sublayers:o,layerIds:a}){const f={},c={extent:n,width:l,spatialReference:null==n?void 0:n.spatialReference};let u=o;null!=a&&a.length&&o&&(u=o.filter((e=>a.includes(e.id))));const y=i(c),d=[],p=e=>{const n=0===y,i=0===e.minScale||y<=e.minScale,t=0===e.maxScale||y>=e.maxScale;e.visible&&(n||i&&t)&&(e.sublayers?e.sublayers.forEach(p):d.unshift(e))};if(u&&u.forEach(p),u&&u.length){const n=d.map((e=>{const n=t(r,e);return e.toExportImageJSON(n)})),i=n.some((e=>"mapLayer"===e.source.type?e.source.mapLayerId!==e.id:"dataLayer"===e.source.type));if(i){let e=JSON.stringify(n);"[]"===e&&(e="[{}]"),f.dynamicLayers=e}else if(!i){if(null!=a&&a.length)f.layerIds=a;else{const e=u.map((({id:e})=>e));e.length&&(f.layerIds=e)}const n=function({floors:n,visibleSublayers:i}){const r=!(null==n||!n.length),l=i.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));if(!l.length)return null;return l.map((i=>{const r=t(n,i),l=e(r)?s(r,i):i.definitionExpression,o={id:i.id,definitionExpression:null};return l&&(o.definitionExpression=l),o}))}({floors:r,visibleSublayers:d});if(n&&n.length){const e=n.reduce(((e,n)=>(n.definitionExpression&&(e[n.id]=n.definitionExpression),e)),{});Object.keys(e).length&&(f.layerDefs=JSON.stringify(e))}}}else null!=a&&a.length&&(f.layerIds=a);return f}export{r as a,o as e,l as p,a as t};
