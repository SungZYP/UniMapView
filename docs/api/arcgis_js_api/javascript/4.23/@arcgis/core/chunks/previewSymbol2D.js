/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../Color.js";import o from"../core/Error.js";import{e as s,p as e}from"./screenUtils.js";import{i as l,h as r,m as i}from"./utils6.js";import{S as m,k as a,s as p}from"../symbols/support/symbolUtils.js";import{h as n}from"./renderUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"../core/lang.js";import"./ensureType.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"./Evented.js";import"./shared.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"./Loadable.js";import"./Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./assets.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const c=m.size,u=m.maxSize,j=m.maxOutlineSize,y=m.lineWidth,d=document.createElement("canvas");function b(t){const o=null==t?void 0:t.size;return{width:null!=o&&"object"==typeof o&&"width"in o?s(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?s(o.height):null}}function h(m,h){var f,g;const S="number"==typeof(null==h?void 0:h.size)?null==h?void 0:h.size:null,v=null!=S?s(S):null,L=null!=(null==h?void 0:h.maxSize)?s(h.maxSize):null,M=null!=(null==h?void 0:h.opacity)?h.opacity:null,w=null!=(null==h?void 0:h.rotation)?h.rotation:"angle"in m?m.angle:null,k=l(m);let x=r(m);if(k&&!x){const o="type"in k?null:new t(k);"#ffffff"===(o?o.toHex():null)&&(x={color:"#bdc3c7",width:.75})}const D={shape:null,fill:null,stroke:x,offset:[0,0]};null!=(f=x)&&f.width&&(x.width=Math.min(x.width,j));const U=(null==(g=x)?void 0:g.width)||0;let P=null!=(null==h?void 0:h.size)&&(null==(null==h?void 0:h.scale)||(null==h?void 0:h.scale)),z=0,C=0,F=!1;switch(m.type){case"simple-marker":{const t=m.style,o=Math.min(null!=v?v:s(m.size),L||u);switch(z=o,C=o,t){case"circle":D.shape={type:"circle",cx:0,cy:0,r:.5*o},P||(z+=U,C+=U);break;case"cross":D.shape={type:"path",path:[{command:"M",values:[0,.5*C]},{command:"L",values:[z,.5*C]},{command:"M",values:[.5*z,0]},{command:"L",values:[.5*z,C]}]};break;case"diamond":D.shape={type:"path",path:[{command:"M",values:[0,.5*C]},{command:"L",values:[.5*z,0]},{command:"L",values:[z,.5*C]},{command:"L",values:[.5*z,C]},{command:"Z",values:[]}]},P||(z+=U,C+=U);break;case"square":D.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"Z",values:[]}]},P||(z+=U,C+=U),w&&(F=!0);break;case"triangle":D.shape={type:"path",path:[{command:"M",values:[.5*z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"Z",values:[]}]},P||(z+=U,C+=U),w&&(F=!0);break;case"x":D.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,C]},{command:"M",values:[z,0]},{command:"L",values:[0,C]}]},w&&(F=!0);break;case"path":D.shape={type:"path",path:m.path||""},P||(z+=U,C+=U),w&&(F=!0),P=!0}break}case"simple-line":{var E;const{width:t,height:o}=b(h),s=null!=o?o:Math.min(null!=v?v:U,L||j),e=null!=t?t:y;x.width=s,z=e,C=s;const l=(null==D||null==(E=D.stroke)?void 0:E.cap)||"butt",r="round"===l;P=!0,D.stroke.cap="butt"===l?"square":l,D.shape={type:"path",path:[{command:"M",values:[r?s/2:0,C/2]},{command:"L",values:[r?z-s/2:z,C/2]}]};break}case"picture-fill":case"simple-fill":{const t="object"==typeof(null==h?void 0:h.symbolConfig)&&(null==h?void 0:h.symbolConfig.isSquareFill),{width:o,height:s}=b(h);z=t&&null!=o?o:null!=v?v:c,C=t&&null!=s?s:z,P||(z+=U,C+=U),P=!0,D.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:p.fill[0];break}case"picture-marker":{let t=s(m.width),o=s(m.height);const e=null!=v?v:Math.max(t,o),l=t/o;t=l<=1?Math.ceil(e*l):e,o=l<=1?e:Math.ceil(e/l),z=Math.min(t,L||u),C=Math.min(o,L||u),D.shape={type:"image",x:-Math.round(z/2),y:-Math.round(C/2),width:z,height:C,src:m.url||""},w&&(F=!0);break}case"text":{const t=m,o=t.text||"Aa",l=t.font,r=Math.min(null!=v?v:s(l.size),L||u),i=function(t,o){const s=d.getContext("2d"),e=[];return o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" "),s.measureText(t).width}(o,{weight:l.weight,size:r,family:l.family}),a=/[\uE600-\uE6FF]/.test(o);z=a?r:i,C=r;let p=.25*function(t){if(0===t.length)return 0;if(t.length>2){const o=e(1),s=parseFloat(t);switch(t.slice(-2)){case"px":return s;case"pt":return s*o;case"in":return 72*s*o;case"pc":return 12*s*o;case"mm":return 2.8346456692913384*s*o;case"cm":return 28.346456692913385*s*o}}return parseFloat(t)}((l?r:0).toString());a&&(p+=5),D.shape={type:"text",text:o,x:0,y:p,align:"middle",decoration:l&&l.decoration,rotated:t.rotated,kerning:t.kerning},D.font=l&&{size:r,style:l.style,decoration:l.decoration,weight:l.weight,family:l.family};break}}if(!D.shape)return Promise.reject(new o("symbolPreview: renderPreviewHTML2D","symbol not supported."));const T=k,O=m.color;let q=null;return T&&"pattern"===T.type&&O&&"picture-fill"!==m.type?q=i(T.src,O.toCss(!0)).then((t=>(T.src=t,D.fill=T,D))):(D.fill=k,q=Promise.resolve(D)),q.then((t=>{const o=[[t]];if("object"==typeof(null==h?void 0:h.symbolConfig)&&null!=h&&h.symbolConfig.applyColorModulation){const s=.6*z;o.unshift([{...t,offset:[-s,0],fill:a(k,-.3)}]),o.push([{...t,offset:[s,0],fill:a(k,.3)}]),z+=2*s,P=!1}return n(o,[z,C],{node:h&&h.node,scale:P,opacity:M,rotation:w,useRotationSize:F,effectView:null==h?void 0:h.effectView})}))}export{h as previewSymbol2D};
