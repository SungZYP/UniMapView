/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../rasterRenderers.js";import{i as t,u as n}from"../core/lang.js";import{g as r}from"./unitUtils.js";import a from"../layers/support/Field.js";import l from"../layers/support/RasterInfo.js";import s from"../renderers/FlowRenderer.js";import i from"../renderers/support/AuthoringInfo.js";import o from"../renderers/support/ClassBreakInfo.js";import{P as u,c as m}from"./colorRampUtils.js";import c from"../renderers/support/UniqueValueInfo.js";import"../rest/support/AlgorithmicColorRamp.js";import{c as f,C as d}from"./generateRendererUtils.js";import p from"../rest/support/MultipartColorRamp.js";import b from"../renderers/RasterStretchRenderer.js";import h from"../renderers/UniqueValueRenderer.js";import v from"../renderers/RasterColormapRenderer.js";import g from"../renderers/RasterShadedReliefRenderer.js";import y from"../renderers/ClassBreaksRenderer.js";import x from"../renderers/VectorFieldRenderer.js";const C=p.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),M=p.fromJSON(u[0]),w=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function T(e,n){const{attributeTable:r,colormap:a}=e;if(U(e)){const n=D(e);if(t(n))return n}if(t(a)){const n=q(e);if(t(n))return n}if(t(r)){const n=S(e);if(t(n))return n}return V(e,n)}function R(e){const t=["raster-stretch"];return O(e)&&t.push("raster-colormap"),E(e)&&t.push("unique-value"),N(e)&&t.push("class-breaks"),F(e)&&t.push("raster-shaded-relief"),U(e)&&t.push("vector-field"),J(e)&&t.push("flow"),t}function j(e,t,n){const r=["nearest","bilinear","cubic","majority"].find((e=>e===(null==n?void 0:n.toLowerCase())));if("Map"===t)return null!=r?r:"bilinear";if("standard-time"===e.dataType)return null!=r?r:"nearest";return"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===r||"majority"===r?r:"nearest":null!=r?r:"bilinear"}function V(e,r){var a,l,s,i;e=k(e,null==r?void 0:r.variableName);const{bandCount:o}=e;let{bandIds:u,stretchType:m}=r||{};null!=(a=u)&&a.some((e=>e>=o))&&(u=null);let c=n(e.statistics),f=n(e.histograms);var d;o>1?(u=null!=(d=u)&&d.length?u:I(e),c=null==c?null:u.map((e=>c[e])),f=null==f?null:u.map((e=>f[e]))):u=[0];null==m&&(m=function(e){let n="percent-clip";const{pixelType:r,dataType:a,histograms:l,statistics:s}=e;"u8"!==r||"processed"!==a&&t(l)&&t(s)?"u8"===r||"elevation"===a||w.has(a)?n="min-max":t(l)?n="percent-clip":t(s)&&(n="min-max",n="min-max"):n="none";return n}(e));let p=!1;switch(m){case"none":p=!1;break;case"percent-clip":p=!(null!=(l=f)&&l.length);break;default:p=!(null!=(s=c)&&s.length)}const{dataType:h}=e,v=1===(null==(i=u)?void 0:i.length)&&w.has(h)?C:null,g=new b({stretchType:m,dynamicRangeAdjustment:p,colorRamp:v,outputMin:0,outputMax:255,gamma:1===u.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===m?g.maxPercent=g.minPercent=.25:"standard-deviation"===m&&(g.numberOfStandardDeviations=2),!p&&(t(e.multidimensionalInfo)||null!=r&&r.includeStatisticsInStretch)&&("percent-clip"===m?g.histograms=f:"min-max"!==m&&"standard-deviation"!==m||(g.statistics=c)),g}function k(e,r){if(null==r)return e;let a=n(e.statistics),s=n(e.histograms);const{multidimensionalInfo:i}=e;if(r&&t(i)){const{statistics:e,histograms:t}=i.variables.find((e=>e.name===r));null!=e&&e.length&&(a=e),null!=t&&t.length&&(s=t)}return l.fromJSON({...e.toJSON(),statistics:a,histograms:s})}function I(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const n=e.keyProperties&&e.keyProperties.BandProperties;let r;if(n&&n.length===t){const{red:e,green:t,blue:a,nir:l}=function(e){const t={};for(let r=0;r<e.length;r++){var n;const a=e[r],l=null==(n=a.BandName)?void 0:n.toLowerCase();if("red"===l)t.red=r;else if("green"===l)t.green=r;else if("blue"===l)t.blue=r;else if("nearinfrared"===l||"nearinfrared_1"===l||"nir"===l)t.nir=r;else if(a.WavelengthMax&&a.WavelengthMin){const e=a.WavelengthMin,n=a.WavelengthMax;null==t.blue&&e>=410&&e<=480&&n>=480&&n<=540?t.blue=r:null==t.green&&e>=490&&e<=560&&n>=560&&n<=610?t.green=r:null==t.red&&e>=595&&e<=670&&n>=660&&n<=730?t.red=r:null==t.nir&&e>=700&&e<=860&&n>=800&&n<=950&&(t.nir=r)}}return t}(n);null!=e&&null!=t&&null!=a?r=[e,t,a]:null!=l&&null!=e&&null!=t&&(r=[l,e,t])}return!r&&t>=3&&(r=[0,1,2]),r}function S(n,r,a,l){if(!E(n,r))return null;const{attributeTable:s,statistics:o}=n,u=L(s,r),f=B(s,"red"),d=B(s,"green"),p=B(s,"blue"),b=new i,v=[],g=new Set,y=!!(f&&d&&p);if(t(s))s.features.forEach((t=>{const n=t.attributes[u.name];if(!g.has(t.attributes[u.name])&&null!=n){g.add(n);const r=y&&("single"===f.type||"double"===f.type)&&("single"===d.type||"double"===d.type)&&("single"===p.type||"double"===p.type)&&!s.features.some((e=>e.attributes[f.name]>1||e.attributes[d.name]>1||e.attributes[p.name]>1)),a=r?255:1;v.push(new c({value:t.attributes[u.name],label:t.attributes[u.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new e(y?[t.attributes[f.name]*a,t.attributes[d.name]*a,t.attributes[p.name]*a,1]:[0,0,0,0])}}))}}));else if(null!=o&&o[0])for(let t=o[0].min;t<=o[0].max;t++)v.push(new c({value:t,label:t.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new e([0,0,0,0])}}));if(v.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!y){const t=m(M,v.length);v.forEach(((n,r)=>n.symbol.color=new e(t[r].slice(1,4)))),b.colorRamp=M}if(a||l){const t=a||m(l,v.length).map((e=>e.slice(1)));v.forEach(((n,r)=>n.symbol.color=new e(t[r]))),b.colorRamp=l}return new h({field:u.name,uniqueValueInfos:v,authoringInfo:b})}function L(e,n,r){let l;return t(e)?(l=n?e.fields.find((e=>n.toLowerCase()===e.name.toLowerCase())):function(e){let t;for(let n=0;n<e.length;n++){const r=e[n].name.toLowerCase();if("string"===e[n].type){if(r.startsWith("class")){t=e[n];break}null==t&&(r.endsWith("name")||r.endsWith("type"))&&(t=e[n])}}return t}(e.fields),l||(r||(l=e.fields.find((e=>"string"===e.type))),l||(l=B(e,"value")))):l=new a({name:"value"}),l}function B(e,n){return t(e)?e.fields.find((e=>e.name.toLowerCase()===n)):null}function E(e,n){const{attributeTable:r,bandCount:a}=e;if(!t(r)&&P(e))return!0;if(!t(r)||a>1)return!1;if(n){if(null==r.fields.find((e=>e.name.toLowerCase()===n.toLowerCase())))return!1}return!0}function O(e){const{bandCount:n,colormap:r}=e;return t(r)&&r.length&&1===n}function q(e){if(!O(e))return null;let r;const{attributeTable:a,colormap:l}=e;if(t(a)){const e=B(a,"value"),t=L(a,null,!0);"string"===t.type&&(r={},a.features.forEach((n=>{const a=n.attributes;r[a[e.name]]=t?a[t.name]:a[e.name]})))}return v.createFromColormap(n(l),r)}function F(e){return"elevation"===e.dataType}function z(e,t){var n;if(!F(e))return null;const{extent:a}=e,l=a.width*r(a.spatialReference);return t=null!=(n=t)?n:"multi-directional",new g({hillshadeType:t,scalingType:l>5e6?"adjusted":"none"})}function N(e){const{attributeTable:n,bandCount:r}=e;return 1===r&&(t(n)||t(e.histograms))}function W(e,n){e=k(e,null==n?void 0:n.variableName);const{attributeTable:r}=e;if(!N(e))return null;const a=t(e.histograms)?e.histograms[0]:null,l=isFinite(null==n?void 0:n.numClasses)?n.numClasses:5,s=new i({classificationMethod:null==n?void 0:n.classificationMethod,colorRamp:null==n?void 0:n.colorRamp});let u=(null==n?void 0:n.field)||"value";const c=[],p=[],b=t(r),h=b&&r.fields.find((e=>"count"===e.name.toLowerCase())),v=b&&r.fields.find((e=>e.name.toLowerCase()===u.toLowerCase()));if(v){u=v.name;const e=r.features.length;let t=0;r.features.forEach((n=>t+=(h?n.attributes[h.name]:50)/e)),r.features.forEach((n=>{const r=n.attributes[v.name],a=h?n.attributes[h.name]:50;if(a>0){p.push(a);const n=Math.max(1,Math.round(a/e/t*1e3));for(let e=0;e<n;e++)c.push(r)}}))}else{const{pixelType:t}=e,n=(a.max-a.min)/a.size,l=t.indexOf("s")>-1||t.indexOf("u")>-1,s=l&&1===n?Math.floor(a.min+.5):a.min,i=l&&1===n?Math.floor(a.max-.5):a.max,o=a.size;let u,m=0;a.counts.forEach((e=>m+=e/o)),a.counts.forEach(((e,t)=>{if(e>0){p.push(e);const l=Math.max(1,Math.round(e/o/m*1e3));u=b?r.features[t].attributes[v.name]:0===t?s:t===o-1?i:a.min+n*(t+.5);for(let e=0;e<l;e++)c.push(u)}}))}const g=(null==n?void 0:n.classificationMethod)||"natural-breaks";let x=null==n?void 0:n.definedInterval;"defined-interval"!==g||x||(x=function(e,n,r){let a=0,l=0;if(t(e.attributeTable)){const t=e.attributeTable;a=l=t.features[0].attributes[n.name],t.features.forEach((e=>{const t=e.attributes[n.name];t<a&&(a=t),t>l&&(l=t)}))}else if(t(e.histograms)){const t=e.histograms;a=t[0].min,l=t[0].max}return(l-a)/r}(e,v,l));const M=f({values:c,valueFrequency:p,normalizationTotal:null,definition:new d({classificationMethod:g,breakCount:l,definedInterval:x})});let w=null==n?void 0:n.colors;if(!w){const e=(null==n?void 0:n.colorRamp)||C;s.colorRamp=e;const t=m(e,M.classBreaks.length,!0);w=t.map((e=>e.slice(1)))}const T=M.classBreaks.map(((e,t)=>new o({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:w[t]}})));return new y({field:u,classBreakInfos:T,authoringInfo:s})}function P(e){var t,n,r;return["u8","s8"].indexOf(e.pixelType)>-1&&null!=(null==(t=e.statistics)||null==(n=t[0])?void 0:n.min)&&null!=(null==(r=e.statistics[0])?void 0:r.max)&&1===e.bandCount}function U(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}function J(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}const A=new Map([["m/s","meter-per-second"],["km/h","kilometer-per-hour"],["knots","knots"],["ft/s","feet-per-second"],["mph","mile-per-hour"]]);function D(e){if(!U(e))return null;let n;if(t(e.statistics)&&e.statistics.length&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:t,maxMagnitude:r}=K(e.dataType,e.statistics);n=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:t,maxDataValue:r}]}const r=t(e.multidimensionalInfo)?A.get(e.multidimensionalInfo.variables[0].unit):null,a=new x({visualVariables:n,inputUnit:r,rotationType:"geographic"});return a.visualVariables=[...a.sizeVariables,...a.rotationVariables],a}function G(e){var t;return{color:null==(t=e.symbolLayers[0].material)?void 0:t.color,type:"esriSFS",style:"esriSFSSolid"}}function _(e){if("uniqueValue"===e.type){var t;const n=e.uniqueValueInfos,r=n[0].symbol;return null!=r&&null!=(t=r.symbolLayers)&&t.length&&(e.uniqueValueInfos=n.map((e=>({value:e.value,label:e.label,symbol:e.symbol?G(e.symbol):null})))),e}if("classBreaks"===e.type){var n;const t=e.classBreakInfos,r=t[0].symbol;return null!=r&&null!=(n=r.symbolLayers)&&n.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?G(e.symbol):null})))),e}return e}function H(e){if(!J(e))return null;let n;if(t(e.statistics)&&e.statistics.length>0&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:t,maxMagnitude:r}=K(e.dataType,e.statistics);n=[{type:"color",field:"Magnitude",stops:[{value:t,color:"#1020C0"},{value:r,color:"#C02010"}]}]}return new s({visualVariables:n})}function K(e,t){let n,r;if("vector-magdir"===e)n=t[0].min,r=t[0].max;else{const e=t[0].min,a=t[0].max,l=t[1].min,s=t[1].max;n=0,r=Math.max(Math.abs(e),Math.abs(l),Math.abs(a),Math.abs(s))}return{minMagnitude:n,maxMagnitude:r}}export{I as a,j as b,T as c,W as d,B as e,q as f,R as g,H as h,K as i,V as j,z as k,S as l,P as m,_ as n,L as o,D as p};
