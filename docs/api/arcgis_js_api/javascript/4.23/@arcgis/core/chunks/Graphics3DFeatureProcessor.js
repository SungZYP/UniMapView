/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../Graphic.js";import{n as i}from"./compilerUtils.js";import{HandleOwner as r}from"../core/HandleOwner.js";import{b as s,i as n,x as a,u as l}from"../core/lang.js";import{isAbortError as o,logOnError as u}from"../core/promiseUtils.js";import{watch as h,initial as p,when as d}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as y}from"../core/accessorSupport/decorators/subclass.js";import{d as g}from"./diffUtils.js";import{canProject as m,project as f}from"../geometry/support/webMercatorUtils.js";import{a as b,V as E,i as v,j as _}from"./LayerView3D.js";import w from"../rest/support/Query.js";import{ad as x}from"./lineUtils.js";import{G as C,a as S}from"./Graphics3DScaleVisibility.js";import{a as V,G as O,b as I}from"./Graphics3DObjectStates.js";import R from"../core/Accessor.js";import j from"../core/Handles.js";import{L as F}from"./Logger.js";import{O as Q}from"../core/Collection.js";import{on as G}from"../core/watchUtils.js";import q from"../layers/support/FeatureFilter.js";import"../geometry.js";import A from"../geometry/Extent.js";import{Q as T}from"./QueryEngine.js";import P from"../rest/support/FeatureSet.js";import{f as N}from"./typeUtils.js";import{a as M}from"./floorFilterUtils.js";import{T as U}from"./Scheduler.js";import{r as L}from"./DefaultBufferWriter.js";import{a as D}from"./attributeUtils.js";import{U as H,O as J}from"./basicInterfaces.js";const B=T;let k=class extends R{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new w({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:A.fromJSON(r)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=P.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=P.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}_ensureQueryJSON(e){return s(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=N.toJSON(this.queryGeometryType),r=this.layer.fields.map((e=>e.toJSON())),s=this.layerView.view.resourceController.scheduler,n=this.priority,a=this.spatialReference.toJSON(),l=this.layerView.processor.featureStore,{hasZ:o,hasM:u}=this.layerView;return this._dataQueryEngineInstance=new B({hasZ:o,hasM:u,geometryType:i,fields:r,timeInfo:e,spatialReference:a,objectIdField:t,featureStore:l,scheduler:s,priority:n}),this._dataQueryEngineInstance}};e([c({constructOnly:!0})],k.prototype,"layerView",void 0),e([c({constructOnly:!0})],k.prototype,"priority",void 0),e([c({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],k.prototype,"spatialReference",void 0),e([c({readOnly:!0,aliasOf:"layerView.layer"})],k.prototype,"layer",void 0),e([c({readOnly:!0})],k.prototype,"queryGeometryType",null),e([c({readOnly:!0})],k.prototype,"defaultQueryJSON",null),k=e([y("esri.views.3d.layers.graphics.QueryEngine")],k);const z=k,Z=F.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let Y=class extends R{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new j}get updating(){return this._dirty||this._querying||n(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new z({layerView:this._layerView,priority:U.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(U.FILTER_VISIBILITY,this)),this._handles.add(G(t.owner,"loadedGraphics","after-changes",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(b.FILTER))),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&0==(e.type&Q.ADD)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(b.FILTER,E.GRAPHIC)||e.setVisibilityFlag(b.FILTER,!1,E.GRAPHIC),this.dirty=!0)}filterChanged(){const e=this._recomputeFilter();e!==this._filter&&(this._filter=e,this.dirty=!0)}get active(){return this._filter&&this._core.graphics3DGraphics.size>0}_recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=M(this._layerView);if(s(t)&&s(i))return e;const r=n(e)?e.clone():new q;if(n(t)&&(r.timeExtent=n(r.timeExtent)?r.timeExtent.intersection(t):t),n(i)){const e=null==r.where||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}get running(){return this._dirty&&!this._querying||n(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{if(!o(e)){Z.warn("FeatureFilter query failed: "+e,{error:e});const t=new Set;this._core.graphics3DGraphics.forEach((e=>t.add(this._getFeatureId(e.graphic)))),this._queryResult=t,this._querying=!1}})),e.madeProgress());const t=this._queryResult;n(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((i=>{if(e.done)return!1;const r=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(b.FILTER,r,E.GRAPHIC)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null))}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};e([c({readOnly:!0})],Y.prototype,"updating",null),e([c({readOnly:!0})],Y.prototype,"running",null),e([c()],Y.prototype,"_dirty",void 0),e([c()],Y.prototype,"_querying",void 0),e([c()],Y.prototype,"_queryResult",void 0),Y=e([y("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],Y);let $=class extends r{constructor(e){super(e),this.type="graphics-3d",this.elevationFeatureExpressionEnabled=!1,this.dataExtent=null,this.preferredUpdatePolicy=H.ASYNC,this.suspendResumeExtent=null}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new V:null,i=e.scaleVisibilityEnabled?new C:null,r=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.owner.layer.geometryType?new Y:null,s=e.elevationAlignmentEnabled?new O:null,{owner:n,updateClippingExtent:a,dataExtent:l,elevationFeatureExpressionEnabled:o,preferredUpdatePolicy:u}=e;return{owner:n,updateClippingExtent:a,dataExtent:l,frustumVisibility:t,scaleVisibility:i,filterVisibility:r,elevationAlignment:s,elevationFeatureExpressionEnabled:o,preferredUpdatePolicy:u}}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:void 0}initialize(){const e=new S({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.filterVisibility&&(this.updatingHandles.add((()=>"filter"in this.owner&&this.owner.filter),(()=>this.filterVisibility.filterChanged())),this.updatingHandles.add((()=>"timeExtent"in this.owner&&this.owner.timeExtent),(()=>this.filterVisibility.filterChanged()))),this.elevationAlignment&&this.updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{g(e,t)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this.updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this.updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{g(e,t)&&this.graphicsCore.updateLabelingInfo()})),this.updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",(()=>this.notifyChange("displayFeatureLimit"))))}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",a(this.frustumVisibility)),this._set("scaleVisibility",a(this.scaleVisibility)),this._set("filterVisibility",a(this.filterVisibility)),this._set("elevationAlignment",a(this.elevationAlignment)),this._set("objectStates",a(this.objectStates)),this._set("graphicsCore",a(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){var e;return null==(e=this.scaleVisibility)?void 0:e.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return!this.frustumVisibility.suspended}get suspendInfo(){var e,t;const i={};return null!=(e=this.scaleVisibility)&&e.suspended&&(i.outsideScaleRange=!0),null!=(t=this.frustumVisibility)&&t.suspended&&(i.outsideOfView=!0),i}get updating(){var e,t,i;return!!(null!=(e=this.graphicsCore)&&e.updating||null!=(t=this.frustumVisibility)&&t.updating||null!=(i=this.updatingHandles)&&i.updating)}get updatingRemaining(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.updatingRemaining)?e:0}get featureStore(){var e;return null==(e=this.graphicsCore)?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get drapeSourceType(){return this.owner.drapeSourceType}get updatePolicy(){return this.owner.updatePolicy}get graphics3DGraphics(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return null==(e=this.graphicsCore)?void 0:e.symbolUpdateType}get displayFeatureLimit(){var e;const t=this.view.resourceController.memoryController.memoryFactor,i=null==(e=this.graphicsCore)?void 0:e.displayFeatureLimit;if(1===t)return i;const r=Math.ceil(i.maximumNumberOfFeatures*t),s=Math.ceil(i.maximumTotalNumberOfFeatures*t),n=Math.ceil(i.minimumTotalNumberOfFeatures*t);return{...i,maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:n}}get usedMemory(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.usedMemory)?e:0}get usedMemoryPerFeature(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.usedMemoryPerGraphic)?e:0}get unprocessedMemoryEstimate(){var e,t;return null!=(e=null==(t=this.graphicsCore)?void 0:t.unprocessedMemoryEstimate)?e:0}get performanceInfo(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this);const e=this.owner,t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const t=e.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,t)}this._set("objectStates",new I(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await u(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this.updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await u(this.graphicsCore.updateLabelingInfo())}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(J.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,i){if(e instanceof w){const{set:t,handle:r}=this.objectStates.acquireSet(J.Highlight,i);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(t,e))),r}if("number"==typeof e||"string"==typeof e)return this.highlight([e],i);if(e instanceof t)return this.highlight([e],i);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof t){const t=e;if(null==D(this.layer.fieldsIndex,t[0].attributes,i)){const e=t.map((e=>e.uid)),{set:i,handle:r}=this.objectStates.acquireSet(J.Highlight,null);return this.objectStates.setUids(i,e),r}e=t.map((e=>D(this.layer.fieldsIndex,e.attributes,i)))}if("number"==typeof e[0]||"string"==typeof e[0]){const t=e,{set:r,handle:s}=this.objectStates.acquireSet(J.Highlight,i);return this.objectStates.setObjectIds(r,t),s}}return X}whenGraphicBounds(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const r=v(e,{renderer:t,arcade:i});if(n(r)&&r.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return r}getRenderingInfoAsync(e,t,i,r){return _(e,{renderer:t,arcade:i,...r})}getSymbolLayerSize(e,t){var i;return null==(i=this.graphicsCore)?void 0:i.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var i;null==(i=this.graphicsCore)||i.setObjectIdVisibility(e,t)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(h((()=>this.suspendResumeExtentMode),(()=>{switch(this.handles.remove(K),this.suspendResumeExtentMode){case"computed":this.handles.add([h((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),p),h((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],K);break;case"data":this.handles.add([d((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),p),h((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(l(this.dataExtent))))],K);break;default:i(this.suspendResumeExtentMode)}}),p))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!m(e,i))return;e=f(e,i)}return L(e,t,x,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};e([c()],$.prototype,"type",void 0),e([c({constructOnly:!0})],$.prototype,"owner",void 0),e([c()],$.prototype,"layer",null),e([c({constructOnly:!0})],$.prototype,"updateClippingExtent",void 0),e([c({constructOnly:!0})],$.prototype,"elevationFeatureExpressionEnabled",void 0),e([c({constructOnly:!0})],$.prototype,"graphicsCore",void 0),e([c({constructOnly:!0})],$.prototype,"scaleVisibility",void 0),e([c({constructOnly:!0})],$.prototype,"filterVisibility",void 0),e([c({constructOnly:!0})],$.prototype,"elevationAlignment",void 0),e([c({constructOnly:!0})],$.prototype,"frustumVisibility",void 0),e([c({readOnly:!0})],$.prototype,"deconfliction",void 0),e([c({readOnly:!0})],$.prototype,"labeling",void 0),e([c({readOnly:!0})],$.prototype,"objectStates",void 0),e([c()],$.prototype,"suspendResumeExtentMode",null),e([c()],$.prototype,"dataExtent",void 0),e([c()],$.prototype,"scaleVisibilitySuspended",null),e([c()],$.prototype,"suspended",null),e([c()],$.prototype,"legendEnabled",null),e([c()],$.prototype,"suspendInfo",null),e([c()],$.prototype,"updating",null),e([c()],$.prototype,"updatingRemaining",null),e([c()],$.prototype,"featureStore",null),e([c()],$.prototype,"view",null),e([c()],$.prototype,"loadedGraphics",null),e([c()],$.prototype,"fullOpacity",null),e([c()],$.prototype,"filter",null),e([c()],$.prototype,"slicePlaneEnabled",null),e([c()],$.prototype,"drapeSourceType",null),e([c()],$.prototype,"updatePolicy",null),e([c()],$.prototype,"preferredUpdatePolicy",void 0),e([c()],$.prototype,"displayFeatureLimit",null),$=e([y("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],$);const W=$,K="suspendResumeExtentMode",X={remove(){},pause(){},resume(){}};export{W as G,z as Q};
