/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{d as t,h as i,m as a,r as s}from"./handleUtils.js";import{u as r,i as o,b as n,x as l,h as p,r as h,J as c,o as u}from"../core/lang.js";import{init as d}from"../core/watchUtils.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{e as y,d as _,a as v,g as f}from"./elevationInfoUtils.js";import{E as M}from"./ElevationInfo.js";import b from"../Color.js";import{b as S,q as j,y as E,j as x,n as w,h as O,z as A,m as G,f as R,c as D,H as T,s as I,g as P,k as V,e as C,R as L,d as z,a as U,x as H,o as k,l as F,p as N,r as B,F as Z,af as Y,Z as X,ac as q}from"./mathUtils.js";import{V as W,E as Q,a as J,s as K,O as $,c as ee}from"./OutlineVisualElement.js";import te from"../core/Handles.js";import{a as ie,b as ae,s as se}from"./screenUtils.js";import{n as re,f as oe,j as ne,a as le,m as pe,p as he,h as ce,w as ue,x as de}from"./vec2.js";import{f as me}from"./vec4f32.js";import{O as ge}from"./Object3DVisualElement.js";import{G as ye}from"./GeometryUtil.js";import{R as _e}from"./Material.js";import{V as ve}from"./VertexAttribute.js";import{R as fe,a7 as Me}from"./lineUtils.js";import{f as be}from"./vec4f64.js";import{projectVectorToVector as Se,projectPointToVector as je}from"../geometry/projection.js";import{q as Ee,a as xe,e as we,F as Oe}from"./aaBoundingBox.js";import{s as Ae,a as Ge,d as Re}from"./vectorStacks.js";import{E as De}from"./RenderGeometry.js";import{h as Te,H as Ie,i as Pe,j as Ve}from"./pointUtils.js";import{R as Ce}from"./RightAngleQuadVisualElement.js";import{d as Le}from"./Settings2.js";import{b as ze,e as Ue,a as He}from"./RightAngleSnappingHint.js";import{a as ke,S as Fe}from"./SnappingContext.js";import{C as Ne}from"./basicInterfaces.js";import{S as Be,M as Ze,b as Ye,g as Xe,e as qe,p as We,d as Qe}from"./manipulatorUtils.js";import{G as Je}from"./GraphicState.js";import{D as Ke,g as $e}from"./DrawGraphicTool.js";import{D as et,S as tt,E as it,b as at}from"./drawSurfaces.js";import st from"../core/Collection.js";import{E as rt}from"./Evented.js";import{HandleOwnerMixin as ot,HandleOwner as nt}from"../core/HandleOwner.js";import{m as lt}from"./dehydratedFeatures.js";import{i as pt,S as ht,g as ct,a as ut}from"../widgets/Sketch/SketchViewModel.js";import{c as dt}from"./manipulatorUtils2.js";import{L as mt}from"./LaserlineVisualElement.js";import{B as gt}from"./aaBoundingRect.js";import{j as yt,f as _t,m as vt,e as ft,u as Mt,t as bt,r as St,a as jt,l as Et,b as xt}from"./mat4.js";import{c as wt,f as Ot,I as At}from"./mat4f64.js";import{b as Gt,c as Rt,d as Dt,e as Tt,f as It,g as Pt,a as Vt}from"./dragEventPipeline3D.js";import{d as Ct,a as Lt,c as zt,b as Ut,e as Ht,f as kt,E as Ft,g as Nt,I as Bt,h as Zt,i as Yt}from"./InteractiveToolBase.js";import{C as Xt}from"./ColorMaterial.js";import{a as qt,M as Wt}from"./interfaces.js";import{d as Qt}from"./colorUtils2.js";import{G as Jt}from"./GraphicManipulator.js";import{E as Kt,O as $t,P as ei,A as ti,U as ii,M as ai,R as si,S as ri,b as oi}from"./EditGeometryOperations.js";import ni from"../geometry/Polyline.js";import{j as li}from"./utils6.js";import{n as pi,f as hi,c as ci,i as ui}from"./plane.js";import{M as di}from"./IViewEvents.js";import mi from"../geometry/Point.js";import{V as gi}from"./ViewingMode.js";import{addFrameTask as yi}from"../core/scheduling.js";import{w as _i,d as vi,c as fi}from"./ray.js";import{f as Mi}from"./mathUtils2.js";import{watch as bi,sync as Si}from"../core/reactiveUtils.js";import{b as ji,e as Ei}from"./axisAngleDegrees.js";import{g as xi}from"./unitUtils.js";import{a as wi}from"./vec2f64.js";import{c as Oi,u as Ai,a as Gi}from"./boundedPlane.js";import{E as Ri,k as Di,O as Ti,F as Ii,m as Pi,l as Vi,H as Ci,J as Li,K as zi,q as Ui,R as Hi,f as ki,y as Fi,A as Ni}from"./sliceToolUtils.js";import{g as Bi}from"./Factory.js";import{a as Zi}from"./ray2.js";import"../core/promiseUtils.js";import"../core/Error.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./get.js";import"./utils.js";import"./metadata.js";import"./tracking.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./Ellipsoid.js";import"./jsonMap.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./watch.js";import"./nextTick.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./colorUtils.js";import"./common.js";import"./frustum.js";import"./lineSegment.js";import"./lineStippleUtils.js";import"./Identifiable.js";import"./DefaultBufferWriter.js";import"./sphere.js";import"./Util.js";import"./utils2.js";import"./doublePrecisionUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"./chartMediaInfoUtils.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"./shared.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./glUtil3D.js";import"./geometryDataUtils.js";import"./triangle.js";import"./BufferView.js";import"./ShaderBuilder.js";import"./mat4f32.js";import"./enums.js";import"./Texture.js";import"./context-util.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject.js";import"./RenderSlot.js";import"./InterleavedLayout.js";import"./types.js";import"./VisualElement.js";import"./vec3f32.js";import"./projectionEllipsoid.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./compilerUtils.js";import"./ElevationProvider.js";import"./vec2f32.js";import"./FramebufferObject.js";import"./NestedMap.js";import"./Camera.js";import"./glUtil.js";import"./OrderIndependentTransparency.js";import"./VisualVariables.glsl.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./ReadShadowMap.glsl.js";import"./MemCache.js";import"./heatmapUtils.js";import"./ScreenSpacePass.js";import"./quatf64.js";import"./Intersector.js";import"./verticalOffsetUtils.js";import"./mat3.js";import"./quat.js";import"./floatRGBA.js";import"./Scheduler.js";import"./debugFlags.js";import"./pe.js";import"./assets.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./byteSizeEstimations.js";import"./VerticalOffset.glsl.js";import"./GLMaterialTexture.js";import"./Texture2.js";import"./requestImageUtils.js";import"./PointSnappingHint.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"./BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./_commonjsHelpers.js";import"./ScaleRangeLayer.js";import"../geometry/Circle.js";import"../geometry/support/geodesicUtils.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./hydrated.js";import"./surfaceCoordinateSystems.js";import"./mat2d.js";import"./mat2df64.js";import"./dehydratedFeatureComparison.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./DOMContainer.js";import"./domUtils.js";import"./projector.js";import"./widgetUtils.js";import"../widgets/Popup.js";import"../intl.js";import"./messages.js";import"./throttle.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"./widgetThemeUtils.js";import"../widgets/Attachments.js";import"./unitFormatUtils.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./messageBundle.js";import"./jsxFactory.js";import"../widgets/Feature/FeatureViewModel.js";import"./languageUtils.js";import"./datetime.js";import"./number3.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"./DataLayerSource.js";import"../rest/support/StatisticDefinition.js";import"../rest/support/RelationshipQuery.js";import"../tasks/QueryTask.js";import"./executeForTopCount.js";import"./utils5.js";import"./scaleUtils.js";import"./floorFilterUtils.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./queryZScale.js";import"./featureConversionUtils.js";import"../rest/support/FeatureSet.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"./executeQueryJSON.js";import"../tasks/Task.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"./VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"./DictionaryLoader.js";import"./LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/support/elements.js";import"../geometry/HeightModelInfo.js";import"./FeatureIndex.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"./APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"./CustomParametersMixin.js";import"./FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"./OperationalLayer.js";import"./commonProperties.js";import"../support/timeUtils.js";import"./OrderedLayer.js";import"./PortalLayer.js";import"./asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./RefreshableLayer.js";import"./TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"./featureReductionUtils.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"./defaultsJSON.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"./fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"./labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./versionUtils.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./Heading.js";import"../widgets/support/widget.js";import"./accessibleHandler.js";import"./vmEvent.js";import"../widgets/Spinner/SpinnerViewModel.js";import"./AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"./ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./InputManager.js";import"./Queue.js";import"./layerViewUtils.js";import"./actions.js";import"./GoTo.js";import"./keybindings.js";import"./QueryEngineResult.js";import"../core/sql/WhereClause.js";import"./utils11.js";import"./generateRendererUtils.js";import"./projectionSupport.js";import"./json.js";import"./utils17.js";import"./geometry2dUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./screenUtils2.js";import"./CameraSpace.glsl.js";import"./drawUtils.js";import"./VertexColor.glsl.js";import"./drapedUtils.js";import"../analysis/SlicePlane.js";import"./persistable.js";import"./multiOriginJSONSupportUtils.js";import"./LineVisualElement.js";import"./RenderCoordsHelper.js";import"./spatialReferenceSupport.js";import"./ImageMaterial.js";import"./NativeLineMaterial.js";class Yi extends ge{constructor(e){super(e),this._handles=new te,this._location=S(),this._direction=j(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=me(1,0,1,1),this._renderOccluded=_e.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){E(this._location,e)||(x(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){E(this._direction,e)||(x(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){w(this._direction,O(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){A(e,this._color)||(G(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new fe(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this._updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=ye.createPolylineGeometry([S(),S()]),i=ye.createPolylineGeometry([S(),S()]),a=r(this._externalResources).material;e.addGeometry(t,a),e.addGeometry(i,a),this._updateVertices(e)}forEachExternalMaterial(e){o(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){if(n(this._externalResources))return;this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;n(e)||this._updateVertices(e)}_updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,qi),R(Xi,this.location,this.direction),t.projectToScreen(Xi,Wi),re(Wi,oe(Wi,Wi,qi)),this._updateVertexAttributes(t,e,0,qi,Wi,1),this._updateVertexAttributes(t,e,1,qi,Wi,-1)}_updateVertexAttributes(e,t,i,a,s,r){const o=t.geometryRecords[i],n=o.geometry.getMutableAttribute(ve.POSITION).data,l=ne(Qi,le(Qi,s[1]*r,s[0]*-r),this.offset+this.width/2),p=pe(Ji,pe(Ji,pe(Ji,a,ne(Ji,s,this.length/2)),l),l),h=pe(Ki,p,ne(Ki,s,-this.length));e.unprojectFromScreen(p,Xi),n[0]=Xi[0],n[1]=Xi[1],n[2]=Xi[2],e.unprojectFromScreen(h,Xi),n[3]=Xi[0],n[4]=Xi[1],n[5]=Xi[2],t.geometryVertexAttrsUpdated(o)}}const Xi=S(),qi=ie(),Wi=ie(),Qi=ie(),Ji=ie(),Ki=ie();class $i{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=be(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=be(1,1,1,1),this._elevationInfo=null,this.resources=new W({view:e.view,createResources:e=>this._createResources(e),recreateGeometry:(e,t)=>(e.geometry=this._recreateGeometry(t,e.material),o(e.geometry)?[e.geometry]:[])});let t=!0;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this.preferredTextureSize;this._size=e,t<this.preferredTextureSize?o(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){A(e,this._color)||(G(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,o(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){A(e,this._outlineColor)||(G(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;n(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,t=this.resources.object;if(n(e)||n(t))return;const i=e.geometry;if(n(i))return;const a=i.getMutableAttribute(ve.SIZE).data,s=this.geometrySize;a[0]=s,a[1]=s,t.geometryVertexAttrsUpdated(t.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:ta,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/ea}_recreateGeometry(e,t){const i=this._createRenderGeometry();return o(i)&&e.addGeometry(i,t),i}_createResources(e){const t=Te(this._primitive,this.preferredTextureSize),i=new Ie(this._materialParameters(t.id)),a=this._recreateGeometry(e,i);return{material:i,texture:t,geometry:a,forEach(e){e(t),e(i),o(this.geometry)&&e(this.geometry)}}}get preferredTextureSize(){return D(T(2*this.geometrySize),16,128)}calculateMapBounds(e){if(n(this.resources.resources)||n(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.vertexAttributes.get(ve.POSITION);return Se(t.data,this.view.renderCoordsHelper.spatialReference,ia,this.view.spatialReference),Ee(e,ia),!0}_createRenderGeometry(){const e=this.geometry;if(n(e))return null;const{renderCoordsHelper:t,elevationProvider:i}=this.view,a=Me(e,i,De.fromElevationInfo(this.elevationInfo),t),s=I(Ae.get(),e.x,e.y,a),r=Ae.get();Se(s,e.spatialReference,r,t.spatialReference);const o=this.geometrySize;return ye.createPointGeometry(null,r,null,[o,o],[0,0,0,1])}}const ea=Pe,ta=[ea/2,ea/2,1-ea/2,1-ea/2],ia=S();class aa extends ke{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new $i({view:r,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:b.toUnitRGBA(Le.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new $i({view:r,primitive:"circle",geometry:a.vectorToPoint(e.point),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:b.toUnitRGBA(Le.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,a,s,r,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i,o=ze(e.lineStart,a,s,i.view),n=ze(e.lineEnd,a,s,i.view),l=P(n,o,n,.5),p=new Yi({view:r,attached:!1,offset:Le.parallelLineHintOffset,length:Le.parallelLineHintLength,width:Le.parallelLineHintWidth,color:b.toUnitRGBA(Le.orange),location:l,renderOccluded:_e.Opaque});return p.setDirectionFromPoints(o,l),p.attached=!0,t(p)}visualizeRightAngleQuad(e,i){const{coordinateHelper:a,elevationInfo:s,view:r}=i;return t(new Ce({view:r,attached:!0,color:b.toUnitRGBA(Le.orange),renderOccluded:_e.Transparent,outlineRenderOccluded:_e.Opaque,outlineColor:b.toUnitRGBA(Le.orange),outlineSize:Le.rightAngleHintOutlineSize,size:Le.rightAngleHintSize,geometry:{previous:ze(e.previousVertex,a,s,r),center:ze(e.centerVertex,a,s,r),next:ze(e.nextVertex,a,s,r)}}))}_createLineSegmentHintFromMap(e,t,i,a,s,r,o=!0,n=!0){const l=S(),p=S();return Ue(t,i,a,s,r,l,p),this._createLineSegmentHint(e,r,l,p,o,n)}_createLineSegmentHint(e,t,i,a,s=!0,r=!0){const o=new Q({view:t,extensionType:J.FADED,start:i,end:a,color:b.toUnitRGBA(Le.orange),renderOccluded:_e.Opaque});switch(e){case He.TARGET:o.width=Le.lineHintWidthTarget,o.fadedExtensions={start:0,end:Le.lineHintFadedExtensions};break;case He.REFERENCE_EXTENSION:o.width=Le.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case He.REFERENCE:o.width=Le.lineHintWidthReference,o.fadedExtensions={start:s?Le.lineHintFadedExtensions:0,end:r?Le.lineHintFadedExtensions:0}}return o.attached=!0,o}}class sa extends ge{constructor(e){super(e),this.view=null,this._renderOccluded=_e.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=K.colorToVec4(K.reshapeManipulators.vertex.color),this._size=K.reshapeManipulators.vertex.size,this._outlineColor=K.colorToVec4(K.reshapeManipulators.vertex.outlineColor),this._outlineSize=K.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){A(e,this._color)||(G(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){A(e,this._outlineColor)||(G(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(n(e)||0===e.length)return[];const t=Ve(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,De.fromElevationInfo(this.elevationInfo)),i=[],a=t.numVertices,s=t.position;for(let e=0;e<a;++e){const t=I(ra,s[3*e+0],s[3*e+1],s[3*e+2]),a=oa(.5,t),r=oa(.5,t);i.push({vertexGeometry:a,vertexOutlineGeometry:r})}return i}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new Be({...this.vertexMaterialParameters,writeDepth:!0,cullFace:Ne.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new Be({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:Ne.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const ra=S();function oa(e,t){return ye.createSphereGeometry(e,16,16,{offset:t})}let na=class extends Ke{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new M({mode:e,offset:t})}normalizeCtorArgs(e){if(!e.elevationInfo){var t;const i=null==(t=e.hasZ)||t;return{...e,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return e}initializeGraphic(e){return this._createGraphicState=new Je({graphic:e}),i([this.view.maskOccludee(e),this.view.trackGraphicState(this._createGraphicState),d(this._createGraphicState,"isDraped",(e=>{o(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))])}makeDrawOperation(){return new et({view:this.view,manipulators:this.manipulators,geometryType:$e(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new tt(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new it(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new aa})}onActiveVertexChanged(e){return o(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[e],null):(this._activeVertexVisualElement=new sa({view:this.view,spatialReference:this.view.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:K.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=K.colorToVec4(K.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,a((()=>{this._activeVertexVisualElement=l(this._activeVertexVisualElement)})))}onOutlineChanged(e){if(o(this._outlineVisualElement))return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new $({view:this.view,geometry:e,elevationInfo:t,isDraped:o(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===y(this.hasZ,t),attached:!1}),K.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),K.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,a((()=>{this._outlineVisualElement=l(this._outlineVisualElement)}))}onRegularVerticesChanged(e){return o(this._verticesVisualElement)?(this._verticesVisualElement.vertices=e,null):(this._verticesVisualElement=new sa({view:this.view,spatialReference:this.view.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:K.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,a((()=>{this._verticesVisualElement=l(this._verticesVisualElement)})))}};var la,pa;e([m({constructOnly:!0})],na.prototype,"elevationInfo",void 0),e([m({constructOnly:!0})],na.prototype,"geometryType",void 0),e([m({readOnly:!0})],na.prototype,"type",void 0),e([m({constructOnly:!0,nonNullable:!0})],na.prototype,"view",void 0),na=e([g("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],na),function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"}(la||(la={})),function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"}(pa||(pa={}));class ha{constructor(){this.grabbingState=la.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=la.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(t===pa.TRANSLATE_Z&&(this.zManipulator=e),e instanceof Ze&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),n(this.firstGrabbedXY)&&e.grabbing&&t===pa.TRANSLATE_XY&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=la.ANY,t){case pa.TRANSLATE_Z:this.grabbingState|=la.Z;break;case pa.TRANSLATE_XY:this.grabbingState|=la.XY}}))}}function ca(e){const{view:a,graphic:r}=e,n=new Je({graphic:r}),l=function(e,a){const{view:s,graphic:r}=e,o=new $({view:s,geometry:ua(r)?r.geometry:null,elevationInfo:_(r),attached:!1});K.visualElements.lineGraphics.shadowStyle.apply(o);const n=()=>{o.attached=a.displaying};K.visualElements.lineGraphics.outline.apply(o);const l=[a.watch("displaying",n),a.watch("isDraped",(e=>o.isDraped=e)),a.on("changed",(()=>o.geometry=ua(r)?r.geometry:null)),t(o)];return n(),{visualElement:o,remove:()=>i(l).remove()}}(e,n),p=function(e,a,r){const{graphic:n,view:l}=e,p=[],h=_(n),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,u=new ha,d=new Q({view:l,extensionType:K.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:_e.OccludeAndTransparent});K.visualElements.pointGraphics.shadowStyle.apply(d);const m=V(K.visualElements.heightPlaneAngleCutoff),g=new mt({view:l,attached:!1,angleCutoff:m});K.visualElements.heightPlane.apply(g);let y=1,v=1;const f=()=>{if(u.update(e),!r.displaying||c&&(r.isDraped||!ua(n)||!n.geometry.hasZ))return a.laserlineEnabled=!1,d.attached=!1,void(g.attached=!1);a.laserlineEnabled=!0;{const e=u.grabbingState&la.XY?K.visualElements.laserlineAlphaMultiplier:1;e!==y&&(y=e,K.visualElements.lineGraphics.shadowStyle.apply(a,e),K.visualElements.pointGraphics.shadowStyle.apply(d,e))}{const e=u.grabbingState&la.Z?K.visualElements.laserlineAlphaMultiplier:1;e!==v&&(v=e,K.visualElements.heightPlane.apply(g,e))}!function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&o(t.firstGrabbedXY)?t.firstGrabbedXY:null;o(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(d,u),function(e,t,i,a){if(a.numSelected>0){I(da,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{i===pa.TRANSLATE_XY&&e.selected&&e instanceof Ze&&(R(da,da,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=C(da,da,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;o(a)&&e.view.renderCoordsHelper.toRenderCoords(a,da)?(i.heightManifoldTarget=da,i.attached=!0):i.attached=!1}}(e,a,g,u)};K.visualElements.zVerticalLine.apply(d),p.push(r.on("changed",f),r.watch("displaying",f),a.events.on("attachment-origin-changed",f),t(d),t(g));const M=[],b=()=>{i(M).remove(),M.length=0,e.forEachManipulator((e=>M.push(e.events.on("grab-changed",f)))),e.forEachManipulator((e=>M.push(e.events.on("select-changed",f)))),f()};return b(),p.push(e.onManipulatorsChanged(b),s((()=>i(M)))),i(p)}(e,l.visualElement,n),h=[l,p,a.maskOccludee(r),a.trackGraphicState(n)];return{visualElement:l.visualElement,remove:()=>i(h).remove()}}function ua(e){return o(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const da=S();function ma(e){const{view:a,graphic:r}=e,l=new Je({graphic:r}),p=[],h=function(e,i,a){const{view:r,graphic:n}=e,l=new $i({view:r,geometry:ga(n),elevationInfo:_(n),attached:!1});return function(e,t,i,a){const r=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:r,graphic:n}=e;let l=null;const p=e=>{o(l)&&(l.remove(),l=null),i.isDraped&&o(e)&&(l=function(e,t,i){const a=e.elevationProvider.spatialReference;je(t,ya,a);const s=ya[0],r=ya[1];return e.elevationProvider.on("elevation-change",(e=>{gt(e.extent,s,r)&&i()}))}(r,e,(()=>{t.geometry=e})))},h=()=>{const e=ga(n);p(e),t.geometry=e};a.push(i.on("changed",h),s((()=>l))),h()})(e,t,i,a),K.visualElements.pointGraphics.outline.apply(t),a.push(d(i,"displaying",r))}(e,l,i,a),a.push(t(l)),l}(e,l,p);return function(e,i,a,s){const{view:r,graphic:l}=e,p=new Q({view:r,extensionType:K.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:_e.OccludeAndTransparent});K.visualElements.zVerticalLine.apply(p);const h=new mt({view:r,intersectsLineInfinite:!0,attached:!1});K.visualElements.pointGraphics.shadowStyle.apply(h);const c=V(K.visualElements.heightPlaneAngleCutoff),u=new mt({view:r,attached:!1,angleCutoff:c});K.visualElements.heightPlane.apply(u);const d=_(e.graphic),m=De.fromElevationInfo(d),g="on-the-ground"===d.mode||!d.offset&&"absolute-height"!==d.mode,y=new ha;let v=1,f=1;const M=()=>{y.update(e);const t=ga(l),a=g&&(i.isDraped||n(t)||!t.hasZ);let c=!0;if(!a&&o(t)){const e=Me(t,r.elevationProvider,m,r.renderCoordsHelper);I(ya,t.x,t.y,e),Se(ya,t.spatialReference,ya,r.renderCoordsHelper.spatialReference),p.setStartEndFromWorldDownAtLocation(ya),h.intersectsWorldUpAtLocation=ya}else c=!1;const d=y.grabbingState&la.Z?K.visualElements.laserlineAlphaMultiplier:1;d!==v&&(v=d,K.visualElements.heightPlane.apply(u,d));const _=we(_a);!a&&i.displaying&&s.calculateMapBounds(_)&&Se(Oe(_,ya),r.spatialReference,ya,r.renderCoordsHelper.spatialReference)?(u.heightManifoldTarget=ya,u.attached=!0):u.attached=!1;const M=y.grabbingState&la.XY?K.visualElements.laserlineAlphaMultiplier:1;M!==f&&(f=M,K.visualElements.pointGraphics.shadowStyle.apply(h,M));const b=c&&i.displaying&&!a;h.attached=b,p.attached=b};a.push(i.watch(["displaying","isDraped"],M),i.on("changed",M)),e.forEachManipulator((e=>{a.push(e.events.on("grab-changed",M))})),a.push(t(h)),a.push(t(p)),a.push(t(u)),M()}(e,l,p,h),p.push(a.trackGraphicState(l)),{visualElement:h,remove(){i(p).remove()}}}function ga(e){const t=e.geometry;return n(t)?null:"point"===t.type?t:"mesh"===t.type?t.anchor.clone():null}const ya=S(),_a=xe();function va(e){switch(r(e.graphic.geometry).type){case"point":case"mesh":return ma(e);case"polygon":case"polyline":return ca(e);default:return null}}const fa=[1,.5,0],Ma=Math.ceil(70/3*2),ba=5*Math.PI/12,Sa=1*Math.PI/3;class ja{constructor(){this._available=!0}set location(e){this._forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this._forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this._forEachManipulator3D((t=>t.elevationInfo=e))}get renderLocation(){let e;return this._forEachManipulator3D((t=>{e||(e=t.renderLocation)})),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}_forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof Ze&&e(t,i)}))}}function Ea(e,t,i,a){const s=e.graphic,r=(e,i)=>t({action:e,graphic:s,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{const o=t.next((e=>("start"===e.action&&r("start",e),e))).next(Ct(s,a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&r("update",e);break;case"end":r("end",e)}return e}));return i.next(Lt(s)).next((()=>{r("end",{screenDeltaX:0,screenDeltaY:0})})),o}))}function xa(e){if(n(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=("polyline"===e.type?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class wa extends ja{constructor(e){super(),this._handles=new te,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new rt,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles=l(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:t}of this._arrowManipulatorInfos)e(t,pa.TRANSLATE_XY)}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=_(a),o=r(a.geometry).spatialReference;return Ea(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),s,o,a)),this._view.state.viewingMode)}createDragPipeline(e,t,a,s){return i(this._arrowManipulatorInfos.map((({manipulator:i},r)=>zt(i,((i,o,n,l,p)=>{const h=o.next((e=>({...e,manipulatorType:pa.TRANSLATE_XY}))).next(Ut(this._view,i.elevationAlignedLocation)).next(Gt(this._view,i.elevationAlignedLocation,t,a,s)).next(Ht(i.location,this.angle+(r+1)*Math.PI*.5)).next(kt());e(i,h,n,l,p)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const a=this._radius/70,s=54*a,r=s*Math.sqrt(3)/2,o=ye.createExtrudedTriangle(r,s/2,s/2,.02);ye.transformInPlace(o,yt(Ge.get(),I(Ae.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:qt.Focused},{geometry:o,material:this._transparentMaterial,stateMask:qt.Unfocused}],e.radius=r/3*2*1.2;const n=_t(Ge.get(),i*Math.PI/2),l=yt(Ge.get(),I(Ae.get(),0,100*a,0));vt(t,n,l)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=ft(Ge.get(),e,j(0,0,1)),i=Mt(Ge.get(),I(Ae.get(),this.displayScale,this.displayScale,this.displayScale)),a=vt(Ge.get(),i,t);for(const e of this._arrowManipulatorInfos){const t=vt(Ge.get(),a,e.transform);e.manipulator.modelTransform=t}}_createArrowManipulator(e){const t=new Ze({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)}}),i={manipulator:t,transform:wt()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(e=1){const t=b.toUnitRGBA(ee.main);return t[3]*=e,new Xt({color:t,transparent:1!==e,cullFace:Ne.Back,renderOccluded:_e.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class Oa{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Ft,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&o(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this._snap(this.lastDragEvent.screenEnd);if(o(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}_snap(e){const t=o(this.view)?this.view.toMap(e,{exclude:[]}):null;return o(t)&&o(this.view)&&(t.z=v(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this._snap(e.screenEnd);return o(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class Aa extends ja{constructor(e){super(),this._handles=new te,this._snapToScene=new Oa,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=70,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,pa.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=_(a),o=r(a.geometry).spatialReference;return Ea(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),s,o,a)),this._view.state.viewingMode)}createDragPipeline(e,t,i,a){const s=this._view;return zt(this._manipulator,((r,o,n,l,p)=>{const h=o.next(Ut(s,r.elevationAlignedLocation)).next(Gt(s,r.elevationAlignedLocation,t,i,a)).next(this._snapToScene.createDragEventPipelineStep(s,t),this._snapToScene.next).next((e=>({...e,manipulatorType:pa.TRANSLATE_XY}))).next(kt());e(r,h,n,l,p)}))}_updateManipulatorTransform(){const e=Mt(Ge.get(),I(Ae.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new Ze({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=ye.createCylinderGeometry(.02,1,128,j(0,0,1),j(0,0,0)),t=Mt(wt(),j(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:qt.Focused},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:qt.Unfocused}],this._manipulator.radius=this._radius/70*80}_createMaterial(e=1){const t=b.toUnitRGBA(ee.main);return t[3]*=e,new Xt({color:t,transparent:1!==e,cullFace:Ne.Back,renderOccluded:_e.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Ga extends ja{constructor(e){super(),this._handles=new te,this._radius=70,this.events=new rt,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,pa.TRANSLATE_Z)}createGraphicDragPipeline(e,t,i){const a=r(t.graphic.geometry).spatialReference;return Ea(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),a)),this._view.state.viewingMode)}createDragPipeline(e,t){const i=this._view;return zt(this._manipulator,((a,s,r,o,n)=>{const l=s.next((e=>({...e,manipulatorType:pa.TRANSLATE_Z}))).next(Rt(i,a.renderLocation,t)).next(kt());e(a,l,r,o,n)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/70,t=K.zManipulator.height*e,i=K.zManipulator.coneHeight*e,a=K.zManipulator.coneWidth*e,s=K.zManipulator.width*e,r=[j(0,0,0),j(0,0,t)],o=ye.createTubeGeometry(r,s/2,16,!1),n=ye.createConeGeometry(i,a/2,16,!1),l=[j(0,0,0),j(0,0,t+i)],p=(e=>{const i=wt();if(bt(i,i,[0,0,t]),St(i,i,Math.PI/2),e){const t=1+2*e/a;jt(i,i,[t,t,t])}return i})(0),h=(e,t)=>{const i=Qt(K.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,K.zManipulator.color.a*e]},c=Ye(h(1,.25),_e.Occlude),u=Ye(h(1,0),_e.Occlude),d=Ye(h(.7,0),K.zManipulator.renderOccluded),m=Ye(h(.85,0),K.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:n,transform:p,material:c,stateMask:qt.Unfocused},{geometry:o,material:c,stateMask:qt.Unfocused},{geometry:n,transform:p,material:u,stateMask:qt.Focused},{geometry:o,material:u,stateMask:qt.Focused},{geometry:n,transform:p,material:d,stateMask:qt.Unfocused},{geometry:o,material:d,stateMask:qt.Unfocused},{geometry:n,transform:p,material:m,stateMask:qt.Focused},{geometry:o,material:m,stateMask:qt.Focused}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const e=new Ze({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=Ra;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=L(t.eye,i),s=t.computeRenderPixelSizeAtDist(a),r=O(Da,i,t.eye);w(r,r);const o=Ta;this._view.renderCoordsHelper.worldUpAtPosition(Ra,o);const n=Math.abs(z(r,o)),l=U(Da,r,o),p=U(Da,l,o),h=D(n,.01,1),c=1-Math.sqrt(1-h*h)/h/t.fullWidth,u=this._radius/70,d=K.zManipulator.width*u;C(p,w(p,p),(1/c-1)*a+s*d),e[12]-=Da[0],e[13]-=Da[1],e[14]-=Da[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Ra=S(),Da=S(),Ta=S();class Ia extends ja{constructor(e){super(),this._handles=new te,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:s}=e;this._view=i,this.xyManipulation=new Aa({tool:t,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new wa({tool:t,view:i,radius:s}),this.zManipulation=new Ga({tool:t,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t,a){return i([this.xyManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(Va.XY,t,i,a,s,r)),t,a),this.xyAxisManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(Va.XY_AXIS,t,i,a,s,r)),t,a),this.zManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(Va.Z,t,i,a,s,r)),t,a)])}createDragPipeline(e,t,a,s){return i([this.xyManipulation.createDragPipeline(((t,i,a,s,r)=>e(Va.XY,t,i,a,s,r)),t,a,s),this.xyAxisManipulation.createDragPipeline(((t,i,a,s,r)=>e(Va.XY_AXIS,t,i,a,s,r)),t,a,s),this.zManipulation.createDragPipeline(((t,i,a,s,r)=>e(Va.Z,t,i,a,s,r)),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,pa.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((t=>e(t,pa.TRANSLATE_XY))),this.zManipulation.forEachManipulator((t=>e(t,pa.TRANSLATE_Z)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,t=this.xyManipulation;if(p("esri-mobile"))return;const i=[];t.forEachManipulator((e=>i.push(e))),e.forEachManipulator((e=>i.push(e)));const a=()=>{const t=[];this.xyAxisVisible?o(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(Pa),this._handles.add(t,Pa)};for(const e of i)this._handles.add(e.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",a)),a()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=o(e)&&"point-3d"===e.type&&e.symbolLayers;return!!t&&t.length>0&&t.some((e=>"icon"===e.type))?Ma:70}}const Pa="disable-xy-axis-display";var Va;!function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"}(Va||(Va={}));class Ca extends ja{constructor(e){super(),this._handles=new te,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,pa.TRANSLATE_XY)}createGraphicDragPipeline(e){return Ea(this._graphicState,e,(e=>this.createDragPipeline(e)),this._view.state.viewingMode)}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=o(i.geometry)?i.geometry.spatialReference:null;return zt(this._manipulator,((s,r,o,n,l)=>{const p=r.next(Dt(l,t,i,a)).next(Nt()).next(kt());e(s,p,o,n,l)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new Jt({graphic:t,view:e,selectable:!0,cursor:"move"})}}class La{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class za{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class Ua{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let Ha=class extends(ot(rt.EventedMixin(Bt))){constructor(e){super(e),this.graphics=new st,this.enableZ=!0,this.type="move-3d",this._toolHandles=new te,this.snappingPipeline=new at}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>pt(e)===ht.SUPPORTED)).map((e=>new ka(e)));e.length&&(this._createManipulators(e),this._createVisualElements(e),this.handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this._updateMoveManipulation(e))}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ca({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this.handles.add(t.manipulationXY.createDragPipeline(((t,i,a,s)=>this._buildDragEventPipeline(e,Va.XY,t,i,a,s))))}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new Ia({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Ia.radiusForSymbol(e[0].graphic.symbol):70});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this.handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this._updateMoveManipulation(e);for(const t of e)this.handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const a=e[e.length-1];this.handles.add(a.state.on("changed",(()=>this._updateMoveManipulationAngle(a)))),this.handles.add(t.createDragPipeline(((t,i,a,s,r)=>this._buildDragEventPipeline(e,t,i,a,s,r)),_(a.graphic),r(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(e){for(const t of e){const i=t.graphic,s=va({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>a()});n(s)||(t.geometryRepresentation=s.visualElement,t.geometryRepresentation instanceof $&&this.handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this._updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this._updateMoveManipulation(e)))]),this.handles.add(s))}}_updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>xa(e.graphic.geometry)}_updateMoveManipulation(e){const t=lt(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const s of e){if(!s.state.displaying)continue;const e=s.state.graphic;this.enableZ&&dt(e)&&(a=!0);const r=s.geometryRepresentation instanceof $&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:Xe(this.view,e);o(r)&&(t.x+=r.x,t.y+=r.y,t.z+=r.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,s.location=t,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(e,t,i,a,s,r){const o=[],n=[];let l=null,p=null;const h=()=>{for(const e of o)e.dragging=!1;o.length=0,n.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&t===Va.XY){const t=e[0].graphic;a=this._buildSnappingPipelineSteps(t,_(t),a,s,r)}const c=a.next((t=>{if("start"===t.action){o.length=0,n.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(o.push(t),n.push(t.graphic),t.dragging=!0);if(0!==n.length&&(this._moveManipulation.interactive=!1,l=Zt(n,this.view.state.viewingMode),p=Yt(n),this.emit("graphic-move-start",new La(n)),this.destroyed))return null}return 0!==n.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,s=i.y-t.y;if(this.emit("graphic-move",new za(a,s,n)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Ua(n)),this.destroyed)return null;h()}}));return s.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new Ua(n)),this.destroyed)return null;h()})),c}_buildSnappingPipelineSteps(e,t,i,a,s){const r=e.geometry;if(n(r)||"point"!==r.type&&"mesh"!==r.type)return i;const o=("point"===r.type?r:r.anchor).clone(),l=new Fe({elevationInfo:t,pointer:s,editGeometryOperations:Kt.fromGeometry(o,this.view.state.viewingMode),visualizer:new aa,excludeFeature:e}),p=this.snappingManager;return i.next((t=>{o.z=f(this.view,o,_(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:l.coordinateHelper.pointToVector(o)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:l,snappingManager:p,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};e([m({constructOnly:!0,nonNullable:!0})],Ha.prototype,"view",void 0),e([m({readOnly:!0})],Ha.prototype,"graphics",void 0),e([m({constructOnly:!0,nonNullable:!0})],Ha.prototype,"enableZ",void 0),e([m({constructOnly:!0})],Ha.prototype,"snappingManager",void 0),e([m({readOnly:!0})],Ha.prototype,"type",void 0),e([m({readOnly:!0})],Ha.prototype,"updating",null),Ha=e([g("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Ha);class ka{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Je({graphic:e})}get graphic(){return this.state.graphic}}function Fa(e,t,i){const a="on-the-ground"===i.mode?ei.XY:ei.XYZ;return new $t(e,a,t,0)}function Na(e,t,i){const a=S();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const s=Ba(e,t,pi(i.plane)),r=Ba(e,t,i.edgeDirection);if(n(s)||n(r))return null;const o=U(S(),s,r);return hi(a,o,ci())}function Ba(e,t,i){const a=lt(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),s=S(),r=S();return e.renderCoordsHelper.toRenderCoords(t,s)&&e.renderCoordsHelper.toRenderCoords(a,r)?H(r,s,r):null}let Za=class extends(rt.EventedMixin(nt)){constructor(e){super(e),this._vertexManipulatorMaterial=Ye(K.colorToVec4(K.reshapeManipulators.vertex.color),K.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=qe(K.colorToVec4(K.reshapeManipulators.vertex.outlineColor),K.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=qe(K.colorToVec4(K.reshapeManipulators.vertex.hoverOutlineColor),K.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Ye(K.colorToVec4(K.reshapeManipulators.edge.color),K.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=qe(K.colorToVec4(K.reshapeManipulators.edge.outlineColor),K.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=Ye(K.colorToVec4(K.reshapeManipulators.edgeOffset.color),K.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Ye(K.colorToVec4(K.reshapeManipulators.edgeOffset.hoverColor),K.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=Ye(K.colorToVec4(K.reshapeManipulators.selected.color),K.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=qe(K.colorToVec4(K.reshapeManipulators.selected.outlineColor),K.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=qe(K.colorToVec4(K.reshapeManipulators.selected.hoverOutlineColor),K.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new te,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=Ka.NONE,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new at,this._snappingPipelineHandle=new at,this._vertexLaserLineVisualElement=null}initialize(){const e=new Je({graphic:this.graphic});this._graphicState=e,this.handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._editGeometryOperations=l(this._editGeometryOperations),this._moveManipulation=l(this._moveManipulation),this._graphicMoveManipulation=l(this._graphicMoveManipulation),this._manipulatorHandles=l(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return o(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=l(this._moveManipulation),this._graphicMoveManipulation=l(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(n(this._editGeometryOperations))return;const e=_(this.graphic);for(const t of this._editGeometryOperations.data.components){for(const i of t.vertices)this._createVertexOrEdgeManipulator(i,e);for(const i of t.edges)this._createVertexOrEdgeManipulator(i,e)}this._createGraphicMoveManipulators(e)}get canRedo(){return o(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return o(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(n(this._editGeometryOperations))return null;const e=this._editGeometryOperations.redo();return o(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(n(this._editGeometryOperations))return null;this.emit("undo");const e=this._editGeometryOperations.undo();return o(e)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(e=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),n(e)||(l(this._editGeometryOperations),this._editGeometryOperations=Kt.fromGeometry(e,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;let i=0;const a=[],s=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),r=e===$a.SELECTED_OR_ALL&&s;for(const e of this._manipulatorInfos)Xa(e)&&(e.manipulator.grabbing||r&&!e.manipulator.selected||a.push(e),i++);if(0===a.length)return;this._moveVertices(a,t);if(a.length===i){if(this._updateEventState(Ka.MOVING),this.destroyed)return;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(Ka.RESHAPING),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)Xa(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(Ka.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const s=[];for(const t of this._manipulatorInfos)Xa(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&s.push(t);this._moveVertices(s,e,ti.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case Ka.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case Ka.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case Ka.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case Ka.MOVING:switch(this._reshapeEventState){case Ka.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case Ka.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case Ka.RESHAPING:switch(this._reshapeEventState){case Ka.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case Ka.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){if(this._graphicMoveManipulation=new Ca({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let e=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((t,i,a)=>{i.next((e=>this._trackNumDragging(e))).next((t=>("start"===t.action&&(e=r(this._editGeometryOperations).createUndoGroup()),t))).next((t=>{this._perGraphicManipulatorDragAction($a.ALL,t),"end"===t.action&&(e=h(e))})),a.next(this._cancelDragOperation((()=>e=h(e))))})))}else this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null}));this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new Ia({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&dt(this.graphic),snapToScene:!1,radius:Ia.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this.handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=r(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((t,i,a,s,o)=>{const n=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>Xa(e)&&e.manipulator.selected));return e.manipulatorType===pa.TRANSLATE_XY&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:s,snappingManager:this.tool.snappingManager,snappingContext:new Fe({editGeometryOperations:r(this._editGeometryOperations),elevationInfo:e,pointer:o,excludeFeature:this.graphic,visualizer:new aa}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Nt()).next((e=>(this._perGraphicManipulatorDragAction($a.SELECTED_OR_ALL,e),e)));return s.next(this._cancelDragOperation()),n}),e,t,this.graphic),d(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),d(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=va({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){o(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,pa.TRANSLATE_XY);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});o(i)&&(this._outlineVisualElement=i.visualElement instanceof $?i.visualElement:null),o(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=_(this.graphic)){const a=K.reshapeManipulators.edgeOffset,s=a.size/2,r=s+a.collisionPadding;if(n(this._edgeOffsetManipulatorGeometryInside)||n(this._edgeOffsetManipulatorGeometryOutside)){const e=s/r,t=e*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=ye.createExtrudedTriangle(t,e/2,e/2,a.height,a.offset),this._edgeOffsetManipulatorGeometryOutside=ye.createExtrudedTriangle(-t,e/2,e/2,a.height,-a.offset)}const l=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:qt.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:qt.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:qt.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:qt.Focused}],p=new Ze({view:this.view,renderObjects:l,elevationInfo:"on-the-ground"!==t.mode||li(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:r,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:j(0,0,1)},collisionPriority:1}),h=new Ze({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),c={manipulator:p,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const u=this._getManipulatorInfoFromHandle(c.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))),d=this._getManipulatorInfoFromHandle(c.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c)));c.locationUpdateHandle=i([u,d]),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(zt(p,this._createEdgeOffsetPipeline(c,t)),p),this._manipulatorHandles.add(zt(h,((e,i,a,s)=>{if("touch"===s){this._createEdgeOffsetPipeline(c,t)(e,i,a)}else if(this.enableMoveGraphic){const s=this.graphic,r=o(s.geometry)?s.geometry.spatialReference:null;i.next((e=>this._trackNumDragging(e))).next(Ut(this.view,e.elevationAlignedLocation)).next(Gt(this.view,e.elevationAlignedLocation,t,r,s)).next(kt()).next(Nt()).next((e=>this._perGraphicManipulatorDragAction($a.ALL,e))),a.next(this._cancelDragOperation())}})),p);const m=e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",m),h.events.on("immediate-click",m)],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(e,t){const a=e.manipulator,s=e.edgeManipulator,r=()=>{h(e.visibilityHandle);const r=function(e,t,i){const a=i.projectToRenderScreen(e,ae()),s=i.projectToRenderScreen(t,ae());return o(a)&&o(s)?k(O(a,a,s)):0}(this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<t;(!a.focused&&!s.focused||r)&&(a.grabbable=!r,s.grabbable=!r,e.visibilityHandle=i([a.disableDisplay(),{remove:()=>{a.grabbable=!0,s.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",r),s.events.on("focus-changed",r),{remove:()=>{h(e.visibilityHandle),this.manipulators.remove(s)}}],a),r()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const t=r(this._editGeometryOperations).data.coordinateHelper,i=Na(this.view,e.manipulator.elevationAlignedLocation,Fa(t,e.handle,r(e.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator.renderLocation,n=o(i)?function(e,t,i){const a=pi(e),s=H(S(),t,i),r=U(S(),s,a),o=U(S(),s,r);return Ot(s[0],s[1],s[2],0,r[0],r[1],r[2],0,o[0],o[1],o[2],0,0,0,0,1)}(i,a,s):At;e.manipulator.modelTransform=n,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=n;const l=F(O(Qa,a,s))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,s)=>{this._clearSelection();const{step:o,cleanup:n}=this._initializeEdgeOffset(e,t);a.next((e=>this._trackNumDragging(e))).next(Ut(this.view,i.elevationAlignedLocation)).next(o).next(Tt(this.view)).next(It(this.view,r(this._editGeometryOperations).data.spatialReference)).next(Nt()).next(this._applyEdgeOffsetStep(e)).next((e=>{"end"===e.action&&n()})),s.next((e=>(n(),e))).next(this._cancelDragOperation())}}_initializeEdgeOffset(e,a){const s=r(this._editGeometryOperations),o=Fa(s.data.coordinateHelper,e.handle,a),l=s.createUndoGroup(),p=Na(this.view,e.manipulator.elevationAlignedLocation,o);o.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge),1),o.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge),0);const c=()=>new ni({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:r(this._editGeometryOperations).data.spatialReference}),u=new $({view:this.view,isDraped:this._graphicState.isDraped,geometry:c(),elevationInfo:e.elevationInfo,width:K.visualElements.lineGraphics.outline.width,color:K.colorToVec4(ee.main),attached:!0});let d;const m=()=>{this._cleanEdgeOffsetCollapsedEdges(e),d=h(d)},g=this.on("undo",m);return d=i([t(u),this._graphicState.watch("isDraped",(e=>u.isDraped=e)),this._graphicState.on("changed",(()=>u.geometry=c())),l,g]),{step:e=>n(o)||n(p)?(m(),null):{...e,operation:o,plane:p},cleanup:m}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||n(t.operation))return t;this._updateEventState(Ka.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=t;return(i||a||s)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_cleanEdgeOffsetCollapsedEdges(e){var t,i;const a=null==(t=e.handle.leftVertex.leftEdge)?void 0:t.leftVertex,s=e.handle.leftVertex,o=null==(i=e.handle.rightVertex.rightEdge)?void 0:i.rightVertex,n=e.handle.rightVertex,l=r(this._editGeometryOperations).data.coordinateHelper,p=1e-6,h=[];a&&l.distance(a.pos,s.pos)<p&&h.push(this._getManipulatorInfoFromHandle(s)),(l.distance(s.pos,n.pos)<p||o&&l.distance(o.pos,n.pos)<p)&&h.push(this._getManipulatorInfoFromHandle(n)),h.length&&this._removeVertices(h)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=_(this.graphic)){if("edge"===e.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(n(this._vertexManipulatorGeometry)||n(this._vertexManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(K.reshapeManipulators.vertex);this._vertexManipulatorGeometry=ye.createSphereGeometry(e,16,16),this._vertexManipulatorOutlineGeometry=ye.createSphereGeometry(t,16,16)}if(n(this._edgeManipulatorGeometry)||n(this._edgeManipulatorOutlineGeometry)){const{size:e,outlineSize:t}=this._computeVertexManipulatorSizeAndOutline(K.reshapeManipulators.edge);this._edgeManipulatorGeometry=ye.createSphereGeometry(e,16,16),this._edgeManipulatorOutlineGeometry=ye.createSphereGeometry(t,16,16)}const a=o(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Ja.Vertex|qt.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:Ja.Vertex|qt.Unfocused|qt.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Ja.Vertex|qt.Focused|qt.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:qt.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:qt.Selected|qt.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:qt.Selected|qt.Focused}];this.enableMidpoints&&a.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Ja.Edge|qt.Focused|qt.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Ja.Edge|qt.Focused|qt.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:Ja.Edge|qt.Unfocused|qt.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:Ja.Edge|qt.Unfocused|qt.Unselected});const s=new Ze({view:this.view,renderObjects:a,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(s,e,t);const l="edge"===e.type?{manipulator:s,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:s,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(l),this.manipulators.add(s),this._updateManipulatorPosition(l),"edge"===l.type){const e=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(l))),t=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(l)));l.locationUpdateHandle=i([e,t]),this._manipulatorHandles.add(l.locationUpdateHandle,s)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!0),s);const p=zt(s,((e,i,a,s)=>{let o=null;i.next((e=>this._trackNumDragging(e))).next((e=>{if("start"===e.action&&(o=r(this._editGeometryOperations).createUndoGroup()),qa(l)){const t=this._splitEdgeManipulator(l);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:l,snapOrigin:l.handle.pos}})).next(Ut(this.view,e.elevationAlignedLocation)).next(Pt(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new Fe({editGeometryOperations:r(this._editGeometryOperations),elevationInfo:t,pointer:s,excludeFeature:this.graphic,visualizer:new aa}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Nt()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(o=h(o))})),a.next(this._cancelDragOperation((()=>o=h(o))))}));return this._manipulatorHandles.add(p,s),this._manipulatorHandles.add([s.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,l))),s.events.on("select-changed",(()=>{l.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],s),this.emit("manipulators-changed"),l}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(e){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=o(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,o(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case Ka.NONE:break;case Ka.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case Ka.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(Ka.NONE)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=Ja.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=K.reshapeManipulators.vertex.size/2+K.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i,e.interactive=o(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":e.state=Ja.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=K.reshapeManipulators.edge.size/2+K.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"!==i.mode||li(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(Ka.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==i.pointerType||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((e=>{e.manipulator.interactive=!this._numGrabbing&&o(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in e&&(e.edgeManipulator.interactive=!this._numGrabbing)})),r(this._graphicMoveManipulation).forEachManipulator((e=>e.interactive=!this._numGrabbing)))}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=r(this._editGeometryOperations);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,Wa),e.manipulator.grabbing&&o(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.rightVertex).manipulator;if(o(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const s=i.location,r=a.location,o=.5,n=s.x+o*(r.x-s.x),l=s.y+o*(r.y-s.y),p=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=lt(n,l,p,t.data.spatialReference)}else P(Qa,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=Qa}}_splitEdgeManipulator(e,t=.5){const i=r(this._editGeometryOperations),a=r(i.splitEdge(e.handle,t).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const s=_(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(e),o=this._createVertexOrEdgeManipulator(a)):(o=e,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this._updateSelection(e.manipulator);const n=this._updateEventState(Ka.RESHAPING),l=i.data.coordinateHelper.vectorToArray(o.handle.pos),p=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:p,vertexIndex:r(a.index)}],added:l}),n&&this._updateEventState(Ka.NONE),o}_updateMoveManipulationPosition(){const e=I(Qa,0,0,0);let t=0,i=!1,a=null,s=null;for(const r of this._manipulatorInfos)Xa(r)&&(r.manipulator.selected?(t++,R(e,e,r.manipulator.renderLocation),n(a)||r.selectedIndex>a.selectedIndex?(s=a,a=r):(n(s)||r.selectedIndex>s.selectedIndex)&&(s=r)):i=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&dt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&dt(this.graphic)}if(0!==t){let e=0;if(o(a)){const t=a.handle.pos,i=o(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,r=!o(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;i&&r?this._moveManipulation.xyAxisManipulation.available=!1:i?e=Ya(i,t):r&&(e=Ya(t,r))}this._moveManipulation.angle=e,this._moveManipulation.radius=Ma}else this._moveManipulation.angleDeferred=()=>xa(r(this.graphic.geometry)),this._moveManipulation.radius=Ia.radiusForSymbol(this.graphic.symbol);0!==t&&i?(C(e,e,1/t),Wa.spatialReference=r(this._editGeometryOperations).data.spatialReference,Wa.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,Wa),this._moveManipulation.elevationAlignedLocation=Wa):o(this._outlineVisualElement)&&!this._graphicState.isDraped&&o(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:We(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=r(this._editGeometryOperations);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const e=r(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createVertexOrEdgeManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.vectorToArray(e.pos),componentIndex:t,vertexIndex:r(e.index)}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(Ka.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(Ka.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=("start"===t.action?ti.NEW_STEP:ti.ACCUMULATE_STEPS)){const a=r(this._editGeometryOperations);a.moveVertices(e.map((e=>e.handle)),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const t of e)this._updateManipulatorPosition(t)}_offsetEdge(e,t){if(n(t.operation))return;const i=r(this._editGeometryOperations),a=t.operation.clone();a.distance=t.operation.signedDistanceToPoint(t.mapEnd),i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&e.button===di.Right&&this._removeVertices([t]),qa(t)&&e.button===di.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}};function Ya(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Xa(e){return"vertex"===e.handle.type}function qa(e){return"edge"===e.handle.type}e([m({constructOnly:!0})],Za.prototype,"tool",void 0),e([m()],Za.prototype,"inputGeometry",null),e([m()],Za.prototype,"outputGeometry",void 0),e([m({readOnly:!0})],Za.prototype,"updating",null),Za=e([g("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Za);const Wa=lt(0,0,null,null),Qa=S();var Ja,Ka,$a;!function(e){e.Vertex=Wt.Custom1,e.Edge=Wt.Custom2}(Ja||(Ja={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(Ka||(Ka={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}($a||($a={}));let es=class extends(rt.EventedMixin(Bt)){constructor(e){super(e),this._handles=new te,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=l(this._handles),this._reshapeOperation=l(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.updating)&&e}_updateGeometry(){const e=ct(this.graphic);this._reshapeOperation.inputGeometry=o(e)?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),ut(this.graphic)!==ht.SUPPORTED)return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0,this.graphic.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){n(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new Za({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(e=>this.emit("immediate-click",e))),this.view.on("pointer-down",["Shift"],(e=>{e.stopPropagation()})),d(this,"graphic",(()=>{this._updateGraphic()}),!0)]),this.finishToolCreation()}get canUndo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canUndo)&&e}undo(){o(this.snappingManager)&&this.snappingManager.doneSnapping(),o(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var e,t;return null!=(e=null==(t=this._reshapeOperation)?void 0:t.canRedo)&&e}redo(){o(this.snappingManager)&&this.snappingManager.doneSnapping(),o(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};var ts,is;e([m()],es.prototype,"_reshapeOperation",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"view",void 0),e([m({constructOnly:!0})],es.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"enableZShape",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"enableZVertex",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"enableMoveGraphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"enableMidpoints",void 0),e([m({constructOnly:!0,nonNullable:!0})],es.prototype,"enableEdgeOffset",void 0),e([m({readOnly:!0})],es.prototype,"type",void 0),e([m({constructOnly:!0})],es.prototype,"snappingManager",void 0),e([m({readOnly:!0})],es.prototype,"updating",null),e([m()],es.prototype,"automaticManipulatorSelection",void 0),es=e([g("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],es),function(e){e.ScaleIn=Wt.Custom2,e.ScaleOut=Wt.Custom3,e.RotateLeft=Wt.Custom4,e.RotateRight=Wt.Custom5,e.Unlocked=Wt.Custom7,e.DelayedFocused=Wt.Custom8,e.TouchInput=Wt.Custom12}(ts||(ts={}));class as{constructor(e){this.mode=null,this._handles=new te,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new rt,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>o(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){o(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=l(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=yi({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){o(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=l(this._activeAnimation))}forEachManipulator(e){e(this.ringManipulator,pa.SCALE_ROTATE)}_createManipulator(){this.ringManipulator=this._createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,i=zt(e,((e,i,a)=>{this._scaleRotateDragData=null,this.adapter.restart();const s={mode:"none",origin:N(e.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=s,this._updateDragState();const r=Ae.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,r),i.next(Vt(this.tool.view,hi(e.renderLocation,r,ci()))).next((e=>{const i=pi(e.plane),a=Qe(e.renderStart,e.renderEnd,s.origin,i),r=Mi.shortestSignedDiff(s.angle,a);s.angleDir=D(s.angleDir+r,-.3,.3),s.angle=a;const n=function(e,t){const i=O(Ae.get(),t.renderStart,e.origin),a=O(Ae.get(),t.renderEnd,e.origin),s=F(i),r=F(a);if(0===s)return 0;return r/s}(s,e),l=n-this.adapter.scale;if(s.scaleDir=D(s.scaleDir+l,-.2,.2),this._onScaleChanged(),"none"===s.mode){const i=this.mode||function(e,t,i,a){const{renderStart:s,renderEnd:r}=e,o=ss(s,a,Ae.get()),n=ss(r,a,Ae.get());if(Z(o,n)<100)return null;const l=O(Ae.get(),s,i),p=U(Ae.get(),l,pi(t)),h=s,c=R(Ae.get(),h,p),u=ss(i,a,Ae.get()),d=o,m=ss(c,a,Ae.get()),g=O(Ae.get(),m,d),y=O(Ae.get(),o,u),_=_i(d,g),v=_i(u,y);if(vi(_,n)<vi(v,n))return"rotate";return"scale"}(e,e.plane,s.origin,this.tool.view.state.camera);if(o(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}s.mode=i}}switch(s.mode){case"rotate":this.adapter.angle=s.initialAngle+a;break;case"scale":this.adapter.scale=n,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),e.action){case"start":case"update":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:B(s.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:n,yScale:n})}break;case"end":switch(s.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:B(s.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:n,yScale:n})}}"end"===e.action&&(this.startAnimation(rs(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState())})),a.next((()=>{if(this.adapter.cancel(),o(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(rs(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:e=>(i+=e,!a()||i>200?is.STOP:is.CONTINUE),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this._updateDelayedFocusedState()))):this._updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),d(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e))])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(ts.DelayedFocused,this.getFocused())}_updateDragState(){if(this.ringManipulator.updateStateEnabled(ts.Unlocked,!(o(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),o(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(ts.ScaleIn|ts.ScaleOut,!1),this.ringManipulator.updateStateEnabled(ts.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(ts.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(ts.RotateLeft|ts.RotateRight,!1),this.ringManipulator.updateStateEnabled(ts.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(ts.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(ts.ScaleIn|ts.ScaleOut|ts.RotateLeft|ts.RotateRight,!1)}_updateManipulatorTransform(){const e=ft(Ge.get(),this.adapter.angle,j(0,0,1)),t=this.getScale(),i=Mt(Ge.get(),I(Ae.get(),t,t,t));this.ringManipulator.modelTransform=vt(Ge.get(),i,e)}_createRingManipulator(){const e=(e,t,i)=>{const a=[],s=Math.ceil(128*(t-e)/(2*Math.PI));for(let r=0;r<s+1;r++){const o=e+r*(t-e)/s;a.push(j(i*Math.cos(o),i*Math.sin(o),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>ye.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),a=t(160),s=i(a,24),r={left:[],right:[]},o=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-ba,n=a+s,l=a+Math.PI/2-s,p=e(n,l,190),h=i(p,9);o.push(p),o.push(e(n,l,201)),r.left.push(h),r.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=wt();if(t){jt(i,i,[1,-1,1]),Et(i,i,-n,[0,0,1]);const e=Math.round(.2*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}else{Et(i,i,l,[0,0,1]);const e=Math.round(.8*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}const a=ye.createExtrudedTriangle(60,0,23,.5);ye.transformInPlace(a,i),(t?r.left:r.right).push(a)}}const n=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-Sa,r=a+s,o=a+Math.PI/2-s,l=e(r,o,213);n.push(i(l,9))}const l=t(190),p=t(213),h=i(l,9),c=i(p,9),u=t(130),d=t(107),m=i(u,9),g=i(d,9),y=this._createMaterial(),v=this._createMaterial(.66),f=this._createMaterial(.5),M=this._createMaterial(.33);let b=[{geometry:s,material:y,stateMask:ts.DelayedFocused},{geometry:s,material:f,stateMask:qt.None}];this.mode&&"scale"!==this.mode||(b=b.concat([{geometry:n,material:y,stateMask:ts.DelayedFocused|ts.Unlocked},{geometry:h,material:v,stateMask:ts.DelayedFocused|ts.ScaleIn},{geometry:c,material:M,stateMask:ts.DelayedFocused|ts.ScaleIn},{geometry:m,material:v,stateMask:ts.DelayedFocused|ts.ScaleOut},{geometry:g,material:M,stateMask:ts.DelayedFocused|ts.ScaleOut}])),this.mode&&"rotate"!==this.mode||(b=b.concat([{geometry:r.right,material:y,stateMask:ts.DelayedFocused|ts.Unlocked},{geometry:r.left,material:y,stateMask:ts.DelayedFocused|ts.RotateLeft},{geometry:r.right,material:y,stateMask:ts.DelayedFocused|ts.RotateRight}]));const S=[a,...o];return new Ze({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:_(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:S,direction:j(0,0,1)}})}_createMaterial(e=1){const t=[...fa,e];return new Xt({color:t,transparent:1!==e,cullFace:Ne.Back,renderOccluded:_e.Transparent})}get test(){return{ringManipulator:this.ringManipulator}}}function ss(e,t,i){return t.projectToScreen(e,os),I(i,os[0],os[1],0)}function rs(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?is.STOP:is.CONTINUE),destroy:()=>{e.getScale=i,t()}}}!function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"}(is||(is={}));const os=ie();function ns(e){return o(e.geometry)&&"mesh"===e.geometry.type?(t=e.geometry,o(t.transform)?function(e,t){let i=t.clone(),a=null;return{undo:t=>{a=o(e.transform)?e.transform.clone():null,e.transform=i,t.notifyGeometryChanged()},redo:t=>{i=o(e.transform)?e.transform.clone():null,e.transform=a,t.notifyGeometryChanged()}}}(t,t.transform):function(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}(t)):function(e){let t=e.geometry,i=c;return{undo(e){i=e.geometry,e.geometry=t},redo(e){t=e.geometry,e.geometry=i}}}(e);var t}let ls=class extends nt{constructor(e){super(e),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(ps);const e=this.geometry.transform;if(this.scale=1,o(e)){const t=ji(e.rotation)[2];Math.abs(t)>.999999&&(this.angle=V(Ei(e.rotation))*Math.sign(t))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add(bi((()=>({angle:this.angle,scale:this.scale})),(e=>this._update(e)),Si),ps)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return ns(this.graphic)}_update({scale:e,angle:t}){const i=this.geometry.anchor,a=this.viewingMode===gi.Global;e!==this.previousScale&&(this.geometry.scale(e/this.previousScale,{origin:i,geographic:a}),this.previousScale=e,o(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()),t!==this.previousAngle&&(this.geometry.rotate(0,0,B(t-this.previousAngle),{origin:i,geographic:a}),this.previousAngle=t,o(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged())}};e([m({constructOnly:!0})],ls.prototype,"graphic",void 0),e([m({constructOnly:!0})],ls.prototype,"geometry",void 0),e([m({constructOnly:!0})],ls.prototype,"viewingMode",void 0),e([m()],ls.prototype,"angle",void 0),e([m()],ls.prototype,"scale",void 0),ls=e([g("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],ls);const ps="scale-heading-update-key";let hs=class extends nt{constructor(e){super(e),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(cs);const e=o(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:c;if(this.symbol=o(e)?e.clone():null,this.initialSizes=[],o(e)){const t=this.findLayerView();o(t)&&(this.initialSizes=e.symbolLayers.map((i=>"object"===i.type?t.getSymbolLayerSize(e,i):null)).toArray())}this.angle=0,o(e)&&e.symbolLayers.some((e=>!("object"!==e.type||!o(e.heading))&&(this.angle=-V(e.heading),!0))),this.initialAngle=this.angle,this.scale=1,this.handles.add(bi((()=>({angle:this.angle,scale:this.scale})),(e=>this._updateSymbol(e)),Si),cs)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e,this.restart()},redo:i=>{e=i.symbol,i.symbol=t,this.restart()}}}_updateSymbol({scale:e,angle:t}){const i=this.graphic.symbol;if(n(this.symbol)||n(i)||"point-3d"!==i.type)return;const a=i.clone(),s=-B(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(this.symbol,a,((t,i,a)=>{const n=u(t.heading,0)+s;i.heading!==n&&(i.heading=n,r=!0);const l=this.initialSizes[a];if(o(l)&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const t=l.width*e;i.width!==t&&(i.width=t,r=!0);const a=l.depth*e;i.depth!==a&&(i.depth=a,r=!0);const s=l.height*e;i.height!==s&&(i.height=s,r=!0)}})),r&&(this.graphic.symbol=a)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach(((e,a)=>{const s=t.symbolLayers.getItemAt(a);"object"===e.type&&"object"===s.type&&i(e,s,a)}))}};e([m()],hs.prototype,"angle",void 0),e([m()],hs.prototype,"scale",void 0),e([m({constructOnly:!0})],hs.prototype,"graphic",void 0),e([m()],hs.prototype,"symbol",void 0),e([m({constructOnly:!0})],hs.prototype,"findLayerView",void 0),e([m({constructOnly:!0})],hs.prototype,"sizeFilter",void 0),hs=e([g("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],hs);const cs="scale-heading-update-key";let us=class extends(ot(rt.EventedMixin(Bt))){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new at}initialize(){this.graphicState=new Je({graphic:this.graphic}),this.moveManipulation=new Ia({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&dt(this.graphic),radius:Ia.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:this.graphicState.graphic}),e.stopPropagation()}))))),this.moveManipulation.elevationInfo=_(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>(o(e)&&t===Va.XY&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new Fe({elevationInfo:_(this.graphic),pointer:r,editGeometryOperations:Kt.fromGeometry(new mi({spatialReference:e.spatialReference}),this.view.state.viewingMode),visualizer:new aa,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:s}),this.snappingPipeline.next)),a)),this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:s}=e,r={graphic:i,dxScreen:a,dyScreen:s};switch(t){case"start":this.emit("graphic-translate-start",r),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}})),this.moveManipulation.angle=o(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new as({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([va({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>a()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((e=>{e instanceof Ze&&this.handles.add(e.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}_updateManipulatorsInteractive(){n(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}_createScaleRotateAdapter(){return o(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new ls({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new hs({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find((e=>e.layer===this.graphic.layer))})}_forEachManipulator(e){this.moveManipulation.forEachManipulator(e),o(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this._forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&dt(this.graphic)}))}_createGeometryUndoRecord(){return ns(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=l(this.scaleRotate),this.scaleRotateAdapter=l(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this.moveManipulation.location=e,o(this.scaleRotate)&&(this.scaleRotate.location=e)}set elevationAlignedLocation(e){this.moveManipulation.elevationAlignedLocation=e,o(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){o(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(n(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}_updateMoveAngle(){this.view.state.viewingMode===gi.Local||this.view.scale<1e6?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}_onGeometryChanged(){We(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:o(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};e([m({constructOnly:!0,nonNullable:!0})],us.prototype,"view",void 0),e([m({constructOnly:!0,nonNullable:!0})],us.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],us.prototype,"enableZ",void 0),e([m()],us.prototype,"enableRotation",void 0),e([m()],us.prototype,"enableScaling",void 0),e([m({value:!1})],us.prototype,"snapToScene",null),e([m({constructOnly:!0})],us.prototype,"snappingManager",void 0),e([m({readOnly:!0})],us.prototype,"type",void 0),e([m({readOnly:!0})],us.prototype,"updating",null),us=e([g("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],us);class ds{constructor(){this.lastDragEvent=null,this.next=new Ft,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&o(this.lastDragEvent)){const t={...this.lastDragEvent,action:"update"};e&&this._adjustScaleFactors(t),this.next.execute(t)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const t=Ri(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):0===e.handle.direction[0]?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-t:t,e.factor2=e.factor2<0?-t:t}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function ms(e,t){return ys(e,t,!1)}function gs(e,t){return ys(e,t,!0)}function ys(e,t,i){if(e instanceof ii){if(e.operation instanceof ai)return function(e,t,i=!1){const a=i?-1:1,s=j(a*e.dx,a*e.dy,a*e.dz);R(t.origin,t.origin,s)}(e.operation,t,i),!0;if(e.operation instanceof si)return function(e,t,i=!1){const a=i?-e.angle:e.angle;Y(t.basis1,t.basis1,X,a),Y(t.basis2,t.basis2,X,a)}(e.operation,t,i),!0;if(e.operation instanceof ri)return function(e,t,i=!1){const a=i?1/e.factor1:e.factor1,s=i?1/e.factor2:e.factor2;C(t.basis1,t.basis1,a),C(t.basis2,t.basis2,s),he(t.origin,t.origin,e.origin,e.axis1,a),he(t.origin,t.origin,e.origin,e.axis2,s)}(e.operation,t,i),!0}return!1}let _s=class extends(rt.EventedMixin(Bt)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new ds,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new te,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=Oi(),this.mapBoundsStart=Oi(),this.displayBounds=Oi(),this.displayBoundsStart=Oi(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new Je({graphic:this.graphic});const e=this.graphic.geometry;this.editGeometryOperations=Kt.fromGeometry(e,this.view.state.viewingMode),this.graphicMoveManipulation=new Ca({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=Di(this.view,Ti.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Ii,this.handles.add(this.watch("enableZ",(()=>this._updateManipulatorAvailability(this.moveZManipulator,pa.TRANSLATE_Z)))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const t=Pi(this.view,e);return this.handles.add(this.watch("enableScaling",(()=>this._updateManipulatorAvailability(t,pa.SCALE)))),t.events.on("grab-changed",(e=>this._onResizeGrab(e))),this.handles.add(this._createResizeDragPipeline(t,e)),t})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=Bi(this.view.toolViewManager.textures),this.rotateManipulator=Vi(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",(()=>this._updateManipulatorAvailability(this.rotateManipulator,pa.ROTATE)))),this.rotateManipulator.events.on("grab-changed",(e=>{this._onRotateGrab(e)})),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const t=va({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>a()});o(t)&&(this.outlineVisualElement=t.visualElement instanceof $?t.visualElement:null),o(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this._updateDisplayBounds()))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this._onGeometryChanged())),this.graphicState.watch("displaying",(()=>this._updateAllManipulatorAvailability())),d(this.graphicState,"isDraped",(()=>this._graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.centerOnSurfaceFrequent.watch("location",(()=>this._updateDisplayBounds())));this._forEachManipulator((e=>{this.handles.add(e.events.on("grab-changed",(()=>{this.grabbing=e.grabbing,this._updateAllManipulatorAvailability()})))}));this._forEachManipulator(((e,t)=>{this.handles.add(e.events.on("immediate-click",(e=>{t===pa.TRANSLATE_XY&&this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))})),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this.finishToolCreation()}_graphicDrapedChanged(){this.handles.remove(vs),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(e=>{o(this.attachmentOrigin)&&gt(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()})),vs)}_updateAllManipulatorAvailability(){this._forEachManipulator(((e,t)=>this._updateManipulatorAvailability(e,t)))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof Ze){const a=this.graphicState.displaying,s=this.enableZ&&dt(this.graphic);switch(t){case pa.ROTATE:e.available=a&&this.enableRotation;break;case pa.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||s),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?Ci:Li;break;case pa.TRANSLATE_Z:e.available=a&&s;break;default:e.available=a}}}_forEachManipulator(e){this.graphicMoveManipulation.forEachManipulator(e),this.resizeManipulators.forEach((t=>e(t,pa.SCALE))),e(this.rotateManipulator,pa.ROTATE),e(this.moveZManipulator,pa.TRANSLATE_Z)}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const e=this.graphic.geometry,t=this.editGeometryOperations.data,i=t.components[0].edges[0],a=oe(Re.get(),i.leftVertex.pos,i.rightVertex.pos);re(a,a);const s=u(Xe(this.view,this.graphic),e.extent.center);let r=Ms*this.view.pixelSizeAt(s);const o=this.view.spatialReference;o!==e.spatialReference&&(r*=xi(o)/xi(e.spatialReference)),function(e,t,i,a){a||(a=Oi());const s=le(Re.get(),e[1],-e[0]),r=le(Re.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=le(Re.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n=Re.get();t.components.forEach((t=>t.vertices.forEach((t=>{const i=t.pos;le(n,ce(e,i),ce(s,i)),ue(r,r,n),de(o,o,n)}))));const l=1e-6,p=le(Re.get(),o[0]-r[0]<l?i/2:0,o[1]-r[1]<l?i/2:0);oe(r,r,p),pe(o,o,p),ne(a.basis1,e,(o[0]-r[0])/2),ne(a.basis2,s,(o[1]-r[1])/2),le(a.origin,r[0]*e[0]+r[1]*s[0],r[0]*e[1]+r[1]*s[1]),pe(a.origin,a.origin,a.basis1),pe(a.origin,a.origin,a.basis2)}(a,t,r,this.mapBounds)}_updateDisplayBounds(){const e=this.graphic.geometry;if(n(e))return;const t=o(this.outlineVisualElement)&&!this.graphicState.isDraped&&o(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Xe(this.view,this.graphic);this.attachmentOrigin=u(t,e.extent.center);const i=o(t)?t.z:Me(this.mapBounds.origin,this.view.elevationProvider,De.fromElevationInfo(_(this.graphic)),this.view.renderCoordsHelper),a=Gi(this.mapBounds);a.origin[2]=i,function(e,t,i,a=0,s){s||(s=Oi()),t.toRenderCoords(e.origin,i,s.origin);const r=Ae.get();R(r,e.origin,e.basis1),R(r,r,e.basis2),t.toRenderCoords(r,i,r);const o=Ae.get();R(o,e.origin,e.basis1),O(o,o,e.basis2),t.toRenderCoords(o,i,o);const n=Ae.get();O(n,e.origin,e.basis1),O(n,n,e.basis2),t.toRenderCoords(n,i,n);const l=Ae.get();O(l,e.origin,e.basis1),R(l,l,e.basis2),t.toRenderCoords(l,i,l);const p=P(Ae.get(),r,o,.5);O(p,p,s.origin);const h=P(Ae.get(),n,l,.5);O(h,s.origin,h),P(s.basis1,p,h,.5);const c=P(Ae.get(),l,r,.5);O(c,c,s.origin);const u=P(Ae.get(),o,n,.5);O(u,s.origin,u),P(s.basis2,c,u,.5);const d=U(Ae.get(),s.basis1,s.basis2),m=U(d,d,s.basis1);w(m,m),C(s.basis2,m,z(s.basis2,m)),C(s.basis1,s.basis1,1+a/F(s.basis1)),C(s.basis2,s.basis2,1+a/F(s.basis2)),Ai(s)}(a,this.view.renderCoordsHelper,e.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return fs*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((e,t,i)=>this._applyGraphicMoveSteps(t,i)))}_createMoveZDragPipeline(){const e=this.view,t=this.editGeometryOperations.data.spatialReference;return zt(this.moveZManipulator,((i,a,s)=>{const r=N(i.renderLocation),o=a.next(Rt(e,r,t)).next(kt());this._applyGraphicMoveSteps(o,s)}))}_applyGraphicMoveSteps(e,t){const i=e.next((e=>("start"===e.action&&(this.inputState={type:"move"},Gi(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY})),e))).next(Nt()).next(this._moveDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY};switch(e.action){case"start":case"update":(e.mapEnd.x-e.mapStart.x||e.mapEnd.y-e.mapStart.y||e.mapEnd.z-e.mapStart.z)&&this.emit("graphic-translate",t);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",t)}return e}));return t.next((()=>{o(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()})),i}_moveDragUpdateGeometry(){return e=>{if(n(this.inputState)||"move"!==this.inputState.type)return e;const t=[];for(const e of this.editGeometryOperations.data.components)t.push(...e.vertices);const i="start"===e.action?ti.NEW_STEP:ti.ACCUMULATE_STEPS;return ms(this.editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_onResizeGrab(e){if("start"!==e.action)return;const t=this._calculatePickRay(e.screenPoint);ui(this.displayBounds.plane,t,Ae.get())&&(Gi(this.displayBounds,this.displayBoundsStart),Gi(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return zt(e,((e,i,a)=>{n(this.inputState)||(i.next((e=>("start"===e.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),e))).next(Vt(this.view,this.displayBoundsStart.plane)).next((e=>({...e,handle:t}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,xScale:e.factor1,yScale:e.factor2};switch(e.action){case"start":case"update":this.emit("graphic-scale",t);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",t)}return e})),a.next((()=>{o(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()})))}))}_resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,r=x(Ae.get(),t.origin);q(r,r,t.basis1,-i[0]),q(r,r,t.basis2,-i[1]);const o=O(Ae.get(),e.renderEnd,r),n=O(Ae.get(),e.renderStart,r),l=Ri(e.handle),p=zi(t),h=zi(this.displayBounds)/p,c=(e,t)=>{if(0===e)return 1;let i=F(t),r=.5*e*z(t,o)/i;const p=r<0?-1:1;if(l){r+=(i-.5*e*z(t,n)/i)*p*h}const c=i<1.5*s?1:bs;return i=Math.max(i-s,bs),p>0&&(r-=a),p*Math.max(p*(r/i),c)};return{...e,factor1:c(i[0],t.basis1),factor2:c(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=x(S(),this.mapBoundsStart.origin);q(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),q(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=le(wi(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);re(i,i);const a=[];for(const e of this.editGeometryOperations.data.components)a.push(...e.vertices);const s="start"===e.action?ti.NEW_STEP:ti.ACCUMULATE_STEPS,r=this.editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,s,oi.REPLACE);return Gi(this.mapBoundsStart,this.mapBounds),ms(r,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_onRotateGrab(e){if("start"!==e.action)return;const t=Ui(this.displayBounds,this.view.renderCoordsHelper,Hi.HEADING,ci()),i=this._calculatePickRay(e.screenPoint);ui(t,i,Ae.get())&&(Gi(this.displayBounds,this.displayBoundsStart),Gi(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return zt(e,((e,t,i)=>{const a=this.inputState;n(a)||(t.next((e=>("start"===e.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),e))).next(Vt(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,angle:B(e.rotateAngle)};switch(e.action){case"start":case"update":this.emit("graphic-rotate",t);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",t)}return e})),i.next((()=>{o(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()})))}))}_rotateDragRenderPlaneToRotate(e){return t=>{const i=pi(e.rotatePlane),a=Qe(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=x(S(),this.mapBoundsStart.origin),i=[];for(const e of this.editGeometryOperations.data.components)i.push(...e.vertices);const a="start"===e.action?ti.NEW_STEP:ti.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,oi.REPLACE);return Gi(this.mapBoundsStart,this.mapBounds),ms(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=fi(),i=se(e);return Zi(this.view.state.camera,i,t),w(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=ki(this.displayBounds,Ge.get());Fi(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach(((t,i)=>{Ni(t,this.resizeHandles[i],e,this.displayBounds)}))}_updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:O(Ae.get(),i.origin,i.basis1),edge:2},s=Ge.get();xt(s,t,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}_cancel(){const e=this.editGeometryOperations.lastOperation;n(e)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,gs(e,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(o(this.inputState))this.view.activeTool=null;else if(this.canUndo){const e=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,gs(r(e),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,ms(r(e),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};e([m({constructOnly:!0,nonNullable:!0})],_s.prototype,"view",void 0),e([m({constructOnly:!0,nonNullable:!0})],_s.prototype,"graphic",void 0),e([m({constructOnly:!0,nonNullable:!0})],_s.prototype,"enableZ",void 0),e([m()],_s.prototype,"enableRotation",void 0),e([m()],_s.prototype,"enableScaling",void 0),e([m()],_s.prototype,"preserveAspectRatio",null),e([m()],_s.prototype,"grabbing",void 0),e([m()],_s.prototype,"inputState",void 0),e([m({readOnly:!0})],_s.prototype,"type",void 0),_s=e([g("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],_s);const vs="draped-elevation-changes",fs=10,Ms=80,bs=1e-6;export{na as DrawGraphicTool3D,_s as ExtentTransformTool,Ha as GraphicMoveTool,es as GraphicReshapeTool,us as GraphicTransformTool};
