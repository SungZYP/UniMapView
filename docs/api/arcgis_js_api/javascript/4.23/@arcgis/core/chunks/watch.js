/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{O as e,A as t}from"./ArrayPool.js";import{n,i as s,equals as r}from"../core/lang.js";import{schedule as o}from"../core/scheduling.js";import{v as i}from"./get.js";import{r as l}from"./tracking.js";import{o as u,a as c}from"./utils.js";class a extends e{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=n(this._set)}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}function d(e,t){for(const n of e.entries())if(t(n[0]))return!0;return!1}function h(e,t){const n=new Set;return s(e)&&e.forEach((e=>n.add(e))),s(t)&&t.forEach((e=>n.add(e))),n}let f=0;const _=0;function m(){return++f}class v{constructor(e){this._notify=e,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const e=this._invalidCount;if(1===e)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}onObservableAccessed(e){this._accessed.includes(e)||this._accessed.push(e)}onTrackingEnd(){const e=this._handles,t=this._accessed;for(let n=0;n<t.length;++n)e.push(t[n].observe(this));t.length=0}clear(){const e=this._handles;for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}let p=!1;const g=[];function k(e,t){let n=new v((function o(){if(!n||r)return;if(p)return void w(o);const i=s;n.clear(),p=!0,r=!0,s=l(n,e),r=!1,p=!1,t(s,i),V()})),s=null,r=!1;return r=!0,s=l(n,e),r=!1,{remove:function(){n&&(n.destroy(),n=null,s=null)}}}function y(e,t){let n=new v((function(){t(s,r)})),s=null;function r(){return n?(n.clear(),s=l(n,e),s):null}return r(),{remove:function(){n&&(n.destroy(),n=null),s=null}}}function q(e){let t=new v((function s(){if(!t||n)return;if(p)return void w(s);t.clear(),p=!0,n=!0,l(t,e),n=!1,p=!1,V()})),n=!1;return n=!0,l(t,e),n=!1,{remove:function(){t&&(t.destroy(),t=null)}}}function w(e){g.includes(e)||g.unshift(e)}function V(){for(;g.length;)g.pop()()}var b;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(b||(b={}));class j{constructor(){this.uid=m(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,n,s,o){return this.pool.acquire(b.Untracked,e,t,n,s,o,r)}static acquireTracked(e,t,n,s){return this.pool.acquire(b.Tracked,e,t,n,null,null,s)}notify(e,t){this.type===b.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)}acquire(e,t,n,s,r,o,i){this.uid=m(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=n,this.getValue=s,this.target=r,this.path=o,this.equals=i}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=m(),this.removed=!0}}j.pool=new a(j);const C=new t,T=new Set;let U;function S(e){T.delete(e),T.add(e),U||(U=o(x))}function E(e){if(e.removed)return;const t=e.oldValue,n=e.getValue();e.equals(t,n)||(e.oldValue=n,e.notify(n,t))}function A(e){for(const t of T.values())t.target===e&&(t.removed=!0)}function x(){let e=10;for(;U&&e--;){U=null;const e=O(),t=C.acquire();for(const n of e){const e=n.uid;E(n),e===n.uid&&n.removed&&t.push(n)}for(const e of T)e.removed&&(t.push(e),T.delete(e));for(const e of t)j.pool.release(e);C.release(t),C.release(e),z.forEach((e=>e()))}}function O(){const e=C.acquire();e.length=T.size;let t=0;for(const n of T)e[t]=n,++t;return T.clear(),e}const z=new Set;function I(e){return z.add(e),{remove(){z.delete(e)}}}function N(e,t,n,s=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:s?function(e,t,n){const s=c(e,t,n,((e,t,n)=>{let o=!1;return k((()=>i(e,t)),((i,l)=>{e.__accessor__.destroyed?s.remove():o||(o=!0,r(l,i)||n.call(e,i,l,t,e),o=!1)}))}));return s}(e,t,n):function(e,t,n){let s=c(e,t,n,((e,t,n)=>{let r,o,l=y((()=>i(e,t)),((i,l)=>{e.__accessor__.destroyed||r&&r.uid!==o?s.remove():(r||(r=j.acquireUntracked(i,n,l,e,t),o=r.uid),S(r))}));return{remove:u((()=>{l.remove(),r&&(r.uid!==o||r.removed||(r.removed=!0,S(r)),r=null),s=l=null}))}}));return s}(e,t,n)}function P(e,t,n=!1,s=r){return n?function(e,t,n){let s=!1;return k(e,((e,r)=>{s||(s=!0,n(r,e)||t(e,r),s=!1)}))}(e,t,s):function(e,t,n){let s,r,o=y(e,((e,i)=>{s&&s.uid!==r?o.remove():(s||(s=j.acquireTracked(e,t,i,n),r=s.uid),S(s))}));return{remove:u((()=>{o.remove(),s&&(s.uid!==r||s.removed||(s.removed=!0,S(s)),s=null),o=null}))}}(e,t,s)}function R(e){return d(T,(t=>t.oldValue===e))}export{_ as N,a as R,v as S,P as a,q as b,I as c,m as g,R as i,A as r,d as s,h as u,N as w};
