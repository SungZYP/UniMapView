/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{r as e,a as t,b as r,c as n,d as o,e as a,A as s,f as i,v as c,g as l,h as u,i as p,n as f,F as h,j as m,k as d,l as g}from"./arcadeUtils.js";import{p as y,i as E,q as w,N as v,_ as N,$ as I,v as b,X as S,Y as T,F as j,a0 as R,h as O,l as U,b as A,o as C,J as F,R as M,a as x,A as D,f as k,U as P,V as L,x as _,w as V,Z as Y,j as B,T as G}from"./languageUtils.js";import{registerFunctions as z}from"./geomasync.js";import{create as q,all as Z,reject as H,resolve as J}from"../core/promiseUtils.js";import W from"../geometry/Extent.js";import X from"../geometry/Geometry.js";import K from"../geometry/Multipoint.js";import $ from"../geometry/Point.js";import Q from"../geometry/Polygon.js";import ee from"../geometry/Polyline.js";import te from"../geometry/SpatialReference.js";import"../geometry/support/jsonUtils.js";import"../core/lang.js";import"./tslib.es6.js";import"./string.js";import"./object.js";import"../core/accessorSupport/decorators/property.js";import"./Logger.js";import"../config.js";import"./ensureType.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./writer.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"./reader.js";import"../core/accessorSupport/decorators/cast.js";import"./zmUtils.js";import"./extentUtils.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./locale.js";import"./datetime.js";import"../kernel.js";import"../core/urlUtils.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"./number3.js";import"./sizeVariableUtils.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../geometry/geometryEngineAsync.js";import"../geometry.js";import"./typeUtils.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"./assets.js";import"../request.js";import"../intl.js";import"./number.js";import"./messages.js";function re(e){return e&&"function"==typeof e.then}function ne(e){return e instanceof Error?H(e):H(new Error(e))}function oe(e){return J(e)}function ae(e,t){const r=[];for(let n=0;n<t.arguments.length;n++)r.push(ce(e,t.arguments[n]));return Z(r)}function se(e,t,r){return q(((n,o)=>{if(!0===t.preparsed)return n(r(e,null,t.arguments));ae(e,t).then((a=>{try{n(r(e,t,a))}catch(e){o(e)}}),o)}))}function ie(e,t,r){try{if(!0===t.preparsed){const n=r(e,null,t.arguments);return re(n)?n:J(n)}return ae(e,t).then((n=>{try{const o=r(e,t,n);return re(o)?o:J(o)}catch(e){return ne(e)}}))}catch(e){return ne(e)}}function ce(e,t,r){try{if(t.breakpoint&&!0!==r){return t.breakpoint().then((()=>ce(e,t,!0)))}switch(t.type){case"VariableDeclarator":return function(e,t){try{let r=null;return r=null===t.init?J(null):ce(e,t.init),null!==e.localScope?r.then((r=>q((n=>{if(r===b&&(r=null),"Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const o=t.id.name.toLowerCase();e.localScope[o]={value:r,valueset:!0,node:t.init},n(b)})))):r.then((r=>q((n=>{if("Identifier"!==t.id.type)throw new Error("Can only assign a regular variable");const o=t.id.name.toLowerCase();r===b&&(r=null),e.globalScope[o]={value:r,valueset:!0,node:t.init},n(b)}))))}catch(e){return ne(e)}}(e,t);case"VariableDeclaration":return ye(e,t,0);case"BlockStatement":return function(e,t){try{return ge(e,t,0)}catch(e){return ne(e)}}(e,t);case"FunctionDeclaration":return function(e,t){try{const r=t.id.name.toLowerCase();return e.globalScope[r]={valueset:!0,node:null,value:new j(t,e)},J(b)}catch(e){return ne(e)}}(e,t);case"ReturnStatement":return function(e,t){return q(((r,n)=>{null===t.argument?r(new N(b)):ce(e,t.argument).then((e=>{try{r(new N(e))}catch(e){n(e)}}),n)}))}(e,t);case"IfStatement":return function(e,t){return q(((r,n)=>{"AssignmentExpression"!==t.test.type&&"UpdateExpression"!==t.test.type?ce(e,t.test).then((o=>{try{!0===o?ce(e,t.consequent).then(r,n):!1===o?null!==t.alternate?ce(e,t.alternate).then(r,n):r(b):n(new Error(f(t.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))}catch(e){n(e)}}),n):n(new Error(f(t.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}(e,t);case"ExpressionStatement":return function(e,t){try{return"AssignmentExpression"===t.expression.type?ce(e,t.expression):(t.expression.type,ce(e,t.expression).then((e=>q((t=>{t(e===b?b:new I(e))})))))}catch(e){return H(e)}}(e,t);case"UpdateExpression":return function(e,t){try{const r=t.argument;if("MemberExpression"===r.type){const n={t:null};return ce(e,r.object).then((t=>{let o=null;return n.t=t,!0===r.computed?o=ce(e,r.property):"Identifier"===r.property.type&&(o=J(r.property.name)),o})).then((e=>q((r=>{const o=n.t;let a;if(U(o)){if(!x(e))throw new Error("Invalid Parameter");if(e<0&&(e=o.length+e),e<0||e>=o.length)throw new Error("Assignment outside of array bounds");a=k(o[e]),o[e]="++"===t.operator?a+1:a-1}else if(o instanceof h){if(!1===A(e))throw new Error("Dictionary accessor must be a string");if(!0!==o.hasField(e))throw new Error("Invalid Parameter");a=k(o.field(e)),o.setField(e,"++"===t.operator?a+1:a-1)}else{if(!F(o))throw C(o)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===A(e))throw new Error("Feature accessor must be a string");if(!0!==o.hasField(e))throw new Error("Invalid Parameter");a=k(o.field(e)),o.setField(e,"++"===t.operator?a+1:a-1)}!1===t.prefix?r(a):r("++"===t.operator?a+1:a-1)}))))}return q(((r,n)=>{const o="Identifier"===t.argument.type?t.argument.name.toLowerCase():"";if(!o)throw new Error("Invalid identifier");let a;return null!==e.localScope&&void 0!==e.localScope[o]?(a=k(e.localScope[o].value),e.localScope[o]={value:"++"===t.operator?a+1:a-1,valueset:!0,node:t},void(!1===t.prefix?r(a):r("++"===t.operator?a+1:a-1))):void 0!==e.globalScope[o]?(a=k(e.globalScope[o].value),e.globalScope[o]={value:"++"===t.operator?a+1:a-1,valueset:!0,node:t},void(!1===t.prefix?r(a):r("++"===t.operator?a+1:a-1))):void n(new Error("Variable not recognised"))}))}catch(e){return H(e)}}(e,t);case"AssignmentExpression":return function(e,t){return q(((r,n)=>{const o=t.left;if("MemberExpression"===o.type)ce(e,t.right).then((a=>{try{ce(e,o.object).then((s=>{try{let i=null;if(!0===o.computed)i=ce(e,o.property);else{if("Identifier"!==o.property.type)throw new Error("Expected computed or identifier for assignemnt target");i=J(o.property.name)}i.then((e=>{try{if(U(s)){if(!x(e))throw new Error("Invalid Parameter");if(e<0&&(e=s.length+e),e<0||e>s.length)throw new Error("Assignment outside of array bounds");if(e===s.length){if("="!==t.operator)throw new Error("Invalid Parameter");s[e]=de(a,t.operator,s[e],t)}else s[e]=de(a,t.operator,s[e],t)}else if(s instanceof h){if(!1===A(e))throw new Error("Dictionary accessor must be a string");if(!0===s.hasField(e))s.setField(e,de(a,t.operator,s.field(e),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");s.setField(e,de(a,t.operator,null,t))}}else{if(!F(s))throw C(s)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===A(e))throw new Error("Feature accessor must be a string");if(!0===s.hasField(e))s.setField(e,de(a,t.operator,s.field(e),t));else{if("="!==t.operator)throw new Error("Invalid Parameter");s.setField(e,de(a,t.operator,null,t))}}r(b)}catch(e){n(e)}}),n)}catch(e){n(e)}}),n)}catch(e){n(e)}}),n);else{const a=o.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[a])return void ce(e,t.right).then((o=>{try{e.localScope[a]={value:de(o,t.operator,e.localScope[a].value,t),valueset:!0,node:t.right},r(b)}catch(e){n(e)}}),n);void 0!==e.globalScope[a]?ce(e,t.right).then((o=>{try{e.globalScope[a]={value:de(o,t.operator,e.globalScope[a].value,t),valueset:!0,node:t.right},r(b)}catch(e){n(e)}}),n):n(new Error("Cannot assign undeclared variable"))}}))}(e,t);case"ForStatement":return function(e,t){try{return null!==t.init?ce(e,t.init).then((()=>q(((r,n)=>{ue(e,t,{testResult:!0,lastAction:b},(e=>{r(e)}),(e=>{n(e)}),0)})))):q(((r,n)=>{ue(e,t,{testResult:!0,lastAction:b},(e=>{r(e)}),(e=>{n(e)}),0)}))}catch(e){return H(e)}}(e,t);case"ForInStatement":return function(e,t){return q(((r,n)=>{ce(e,t.right).then((o=>{try{let a=null;a="VariableDeclaration"===t.left.type?ce(e,t.left):J(),a.then((()=>{try{let a="";if("VariableDeclaration"===t.left.type){const e=t.left.declarations[0].id;"Identifier"===e.type&&(a=e.name)}else"Identifier"===t.left.type&&(a=t.left.name);if(!a)throw new Error(f(t,"RUNTIME","INVALIDVARIABLE"));a=a.toLowerCase();let s=null;if(null!==e.localScope&&void 0!==e.localScope[a]&&(s=e.localScope[a]),null===s&&void 0!==e.globalScope[a]&&(s=e.globalScope[a]),null===s)return void n(new Error(f(t,"RUNTIME","VARIABLENOTDECLARED")));U(o)||A(o)?he(e,t,o,{reject:n,resolve:r},s):C(o)?function(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(b);fe(e,t,r,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}(e,t,o,{reject:n,resolve:r},s):o instanceof h||F(o)?function(e,t,r,n,o){try{he(e,t,r.keys(),n,o,"k")}catch(e){n.reject(e)}}(e,t,o,{reject:n,resolve:r},s):M(o)?me(o.iterator(e.abortSignal),e,t,o,s,(e=>{r(e)}),(e=>{n(e)}),0):he(e,t,[],{reject:n,resolve:r},s)}catch(e){n(e)}}),n)}catch(e){n(e)}}),n)}))}(e,t);case"BreakStatement":return J(S);case"EmptyStatement":return J(b);case"ContinueStatement":return J(T);case"TemplateElement":return function(e,t){return J(t.value?t.value.cooked:"")}(0,t);case"TemplateLiteral":return function(e,t){return q((r=>{const n=[];R(t.expressions,((t,r,o,a)=>ce(e,r).then((e=>{n[o]=O(e)})))).then((()=>{let e="",o=0;for(const r of t.quasis)if(e+=r.value?r.value.cooked:"",!1===r.tail){e+=n[o]?n[o]:"",o++}r(e)}))}))}(e,t);case"Identifier":return ve(e,t);case"MemberExpression":return function(e,t){try{return ce(e,t.object).then((r=>{try{return null===r?H(new Error(f(t,"RUNTIME","NOTFOUND"))):!1===t.computed?"Identifier"===t.property.type?r instanceof h||F(r)?J(r.field(t.property.name)):r instanceof X?J(we(r,t.property.name,e,t)):H(new Error(f(t,"RUNTIME","INVALIDTYPE"))):H(new Error(f(t,"RUNTIME","INVALIDTYPE"))):ce(e,t.property).then((n=>q(((o,a)=>{if(r instanceof h||F(r))A(n)?o(r.field(n)):a(new Error(f(t,"RUNTIME","INVALIDTYPE")));else if(r instanceof X)A(n)?o(we(r,n,e,t)):a(new Error(f(t,"RUNTIME","INVALIDTYPE")));else if(U(r))if(x(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new Error(f(t,"RUNTIME","OUTOFBOUNDS"));o(r[n])}else a(new Error(f(t,"RUNTIME","INVALIDTYPE")));else if(C(r))if(x(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length()+n),n>=r.length()||n<0)throw new Error(f(t,"RUNTIME","OUTOFBOUNDS"));o(r.get(n))}else a(new Error(f(t,"RUNTIME","INVALIDTYPE")));else if(A(r))if(x(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=r.length+n),n>=r.length||n<0)throw new Error(f(t,"RUNTIME","OUTOFBOUNDS"));o(r[n])}else a(new Error(f(t,"RUNTIME","INVALIDTYPE")));else a(new Error(f(t,"RUNTIME","INVALIDTYPE")))}))))}catch(e){return ne(e)}}))}catch(e){return ne(e)}}(e,t);case"Literal":return oe(t.value);case"CallExpression":return function(e,t){try{if("Identifier"!==t.callee.type)return ne(f(t,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[t.callee.name.toLowerCase()]){const r=e.localScope[t.callee.name.toLowerCase()];return r.value instanceof v?r.value.fn(e,t):r.value instanceof j?Ue(e,t,r.value.definition):ne(f(t,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[t.callee.name.toLowerCase()]){const r=e.globalScope[t.callee.name.toLowerCase()];return r.value instanceof v?r.value.fn(e,t):r.value instanceof j?Ue(e,t,r.value.definition):ne(f(t,"RUNTIME","NOTAFUNCTION"))}return ne(f(t,"RUNTIME","NOTFOUND"))}catch(e){return ne(e)}}(e,t);case"UnaryExpression":return function(e,t){try{return ce(e,t.argument).then((e=>q(((r,n)=>{E(e)&&"!"===t.operator?r(!e):"-"===t.operator?r(-1*k(e)):"+"===t.operator?r(1*k(e)):"~"===t.operator?r(~k(e)):n(new Error(f(t,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))}))))}catch(e){return ne(e)}}(e,t);case"BinaryExpression":return function(e,t){try{return Z([ce(e,t.left),ce(e,t.right)]).then((e=>q(((r,n)=>{const o=e[0],a=e[1];switch(t.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":r(L(k(o),k(a),t.operator));case"==":r(w(o,a));break;case"!=":r(!w(o,a));break;case"<":case">":case"<=":case">=":r(P(o,a,t.operator));break;case"+":A(o)||A(a)?r(O(o)+O(a)):r(k(o)+k(a));break;case"-":r(k(o)-k(a));break;case"*":r(k(o)*k(a));break;case"/":r(k(o)/k(a));break;case"%":r(k(o)%k(a));break;default:n(new Error(f(t,"RUNTIME","OPERATORNOTRECOGNISED")))}}))))}catch(e){return ne(e)}}(e,t);case"LogicalExpression":return function(e,t){return q(((r,n)=>{"AssignmentExpression"!==t.left.type&&"UpdateExpression"!==t.left.type?"AssignmentExpression"!==t.right.type&&"UpdateExpression"!==t.right.type?ce(e,t.left).then((o=>{try{if(!E(o))throw new Error(f(t,"RUNTIME","ONLYBOOLEAN"));switch(t.operator){case"||":!0===o?r(o):ce(e,t.right).then((e=>{try{if(!E(e))throw new Error(f(t,"RUNTIME","ONLYORORAND"));r(e)}catch(e){n(e)}}),n);break;case"&&":!1===o?r(o):ce(e,t.right).then((e=>{try{if(!E(e))throw new Error(f(t,"RUNTIME","ONLYORORAND"));r(e)}catch(e){n(e)}}),n);break;default:throw new Error(f(t,"RUNTIME","ONLYORORAND"))}}catch(e){n(e)}}),n):n(new Error(f(t.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))):n(new Error(f(t.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}(e,t);case"ArrayExpression":return function(e,t){try{const r=[];for(let n=0;n<t.elements.length;n++)r.push(ce(e,t.elements[n]));return Z(r).then((e=>q(((r,n)=>{for(let r=0;r<e.length;r++){if(D(e[r]))return void n(new Error(f(t,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[r]===b&&(e[r]=null)}r(e)}))))}catch(e){return ne(e)}}(e,t);case"ObjectExpression":return function(e,t){try{const r=[];for(let n=0;n<t.properties.length;n++)r.push(ce(e,t.properties[n]));return Z(r).then((e=>q((t=>{const r={};for(let t=0;t<e.length;t++){const n=e[t];if(D(n.value))throw new Error("Illegal Argument");if(!1===A(n.key))throw new Error("Illegal Argument");n.value===b?r[n.key.toString()]=null:r[n.key.toString()]=n.value}const n=new h(r);n.immutable=!1,t(n)}))))}catch(e){return ne(e)}}(e,t);case"Property":return function(e,t){try{return ce(e,t.value).then((r=>q((n=>{"Identifier"===t.key.type?n({key:t.key.name,value:r}):ce(e,t.key).then((e=>{n({key:e,value:r})}))}))))}catch(e){return H(e)}}(e,t);default:return ne(f(t,"RUNTIME","UNREOGNISED"))}}catch(e){return ne(e)}}function le(e,t,r){try{return ce(e,t.body).then((n=>{try{return r.lastAction=n,r.lastAction===S||r.lastAction instanceof N?(r.testResult=!1,J(r)):null!==t.update?ce(e,t.update).then((()=>J(r))):J(r)}catch(e){return H(e)}}))}catch(e){return H(e)}}function ue(e,t,r,n,o,a){try{(function(e,t,r){try{return null!==t.test?ce(e,t.test).then((n=>{try{return!0===e.abortSignal.aborted?H(new Error("Cancelled")):(r.testResult=n,!1===r.testResult?J(r):!0!==r.testResult?H(new Error(f(t,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):le(e,t,r))}catch(e){return H(e)}})):le(e,t,r)}catch(e){return H(e)}})(e,t,r).then((()=>{try{!0===r.testResult?++a>100?(a=0,setTimeout((()=>{ue(e,t,r,n,o,a)}),0)):ue(e,t,r,n,o,a):r.lastAction instanceof N?n(r.lastAction):n(b)}catch(e){o(e)}}),(e=>{o(e)}))}catch(e){o(e)}}function pe(e,t,r,n,o,a,s,i,c,l){try{if(n<=a)return void i(b);o.value="k"===s?r[a]:a,ce(e,t.body).then((u=>{try{u instanceof N?i(u):u===S?i(b):++l>100?(l=0,setTimeout((()=>{pe(e,t,r,n,o,a+1,s,i,c,l)}),0)):pe(e,t,r,n,o,a+1,s,i,c,l)}catch(e){c(e)}}),(e=>{c(e)}))}catch(e){c(e)}}function fe(e,t,r,n,o,a,s,i,c){try{if(r.length()<=o)return void s(b);n.value="k"===a?r.get(o):o,ce(e,t.body).then((l=>{l instanceof N?s(l):l===S?s(b):++c>100?(c=0,setTimeout((()=>{fe(e,t,r,n,o+1,a,s,i,c)}),0)):fe(e,t,r,n,o+1,a,s,i,c)}),(e=>{i(e)}))}catch(e){i(e)}}function he(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(b);pe(e,t,r,r.length,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}function me(e,t,r,n,o,a,s,i){try{e.next().then((c=>{try{if(null===c)a(b);else{const l=m.createFromGraphicLikeObject(c.geometry,c.attributes,n);l._underlyingGraphic=c,o.value=l;ce(t,r.body).then((c=>{try{c===S?a(b):c instanceof N?a(c):++i>100?(i=0,setTimeout((()=>{me(e,t,r,n,o,a,s,i)}),0)):me(e,t,r,n,o,a,s,i)}catch(e){s(e)}}),(e=>{s(e)}))}}catch(e){s(e)}}),(e=>{s(e)}))}catch(e){s(e)}}function de(e,t,r,n){switch(t){case"=":return e===b?null:e;case"/=":return k(r)/k(e);case"*=":return k(r)*k(e);case"-=":return k(r)-k(e);case"+=":return A(r)||A(e)?O(r)+O(e):k(r)+k(e);case"%=":return k(r)%k(e);default:throw new Error(f(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}function ge(e,t,r){try{return r>=t.body.length?J(b):q(((n,o)=>{ce(e,t.body[r]).then((a=>{try{a instanceof N||a===S||a===T||r===t.body.length-1?n(a):ge(e,t,r+1).then(n,o)}catch(e){o(e)}}),o)}))}catch(e){return ne(e)}}function ye(e,t,r){return q(((n,o)=>{r>=t.declarations.length?n(b):ce(e,t.declarations[r]).then((()=>{r===t.declarations.length-1?n(b):ye(e,t,r+1).then((()=>{n(b)}),o)}),o)}))}let Ee=0;function we(e,t,r,n){let o;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(Ee++,e.spatialReference._arcadeCacheId=Ee,t=Ee)}const r=new h({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":o=e.cache._arcadeCacheId,void 0===o&&(Ee++,o=Ee,e.cache._arcadeCacheId=o);return new Y(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":o=e.cache._arcadeCacheId,void 0===o&&(Ee++,o=Ee,e.cache._arcadeCacheId=o);return new Y(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":o=e.cache._arcadeCacheId,void 0===o&&(Ee++,o=Ee,e.cache._arcadeCacheId=o);return new V(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,o,1);case"type":return"Multipoint"}}throw new Error(f(n,"RUNTIME","PROPERTYNOTFOUND"))}function ve(e,t){return q(((r,n)=>{const o=t.name.toLowerCase();if(null===e.localScope||void 0===e.localScope[o])if(void 0===e.globalScope[o])n(new Error(f(t,"RUNTIME","VARIABLENOTFOUND")));else{const t=e.globalScope[o];!0===t.valueset?r(t.value):null!==t.d?t.d.then(r,n):(t.d=ce(e,t.node),t.d.then((e=>{try{t.value=e,t.valueset=!0,r(e)}catch(e){n(e)}}),n))}else{const t=e.localScope[o];!0===t.valueset?r(t.value):null!==t.d?t.d.then(r,n):(t.d=ce(e,t.node),t.d.then((e=>{try{t.value=e,t.valueset=!0,r(e)}catch(e){n(e)}}),n))}}))}const Ne={};function Ie(e){return null===e?"":U(e)||C(e)?"Array":B(e)?"Date":A(e)?"String":E(e)?"Boolean":x(e)?"Number":e instanceof d?"Attachment":e instanceof g?"Portal":e instanceof h?"Dictionary":F(e)?"Feature":e instanceof $?"Point":e instanceof Q?"Polygon":e instanceof ee?"Polyline":e instanceof K?"Multipoint":e instanceof W?"Extent":D(e)?"Function":M(e)?"FeatureSet":G(e)?"FeatureSetCollection":e===b?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function be(e,t,r,n){return q(((o,a)=>{ce(e,t.arguments[r]).then((s=>{try{if(w(s,n))return void ce(e,t.arguments[r+1]).then(o,a);{const s=t.arguments.length-r;return 1===s?void ce(e,t.arguments[r]).then(o,a):(2===s&&o(null),3===s?void ce(e,t.arguments[r+2]).then(o,a):void be(e,t,r+2,n).then(o,a))}}catch(e){a(e)}}),a)}))}function Se(e,t,r,n){return q(((o,a)=>{if(!0===n)ce(e,t.arguments[r+1]).then(o,a);else{3===t.arguments.length-r?ce(e,t.arguments[r+2]).then(o,a):ce(e,t.arguments[r+2]).then((n=>{try{if(!1===E(n))return void a(new Error("WHEN needs boolean test conditions"));Se(e,t,r+2,n).then(o,a)}catch(e){a(e)}}))}}))}function Te(e,t){try{const r=e.length,n=Math.floor(r/2);return 0===r?J([]):1===r?J([e[0]]):q(((o,a)=>{const s=[Te(e.slice(0,n),t),Te(e.slice(n,r),t)];Z(s).then((e=>{try{je(e[0],e[1],t,[]).then(o,a)}catch(e){a(e)}}),a)}))}catch(e){return ne(e)}}function je(e,t,r,n){return q(((o,a)=>{const s=n;e.length>0||t.length>0?e.length>0&&t.length>0?r(e[0],t[0]).then((i=>{try{isNaN(i)&&(i=1),i<=0?(s.push(e[0]),e=e.slice(1)):(s.push(t[0]),t=t.slice(1)),je(e,t,r,n).then(o,a)}catch(e){a(e)}}),a):e.length>0?(s.push(e[0]),je(e=e.slice(1),t,r,n).then(o,a)):t.length>0&&(s.push(t[0]),t=t.slice(1),je(e,t,r,n).then(o,a)):o(n)}))}function Re(e,t){const r=e.length,n=Math.floor(r/2);return t||(t=function(e,t){return e<t?-1:e===t?0:1}),0===r?[]:1===r?[e[0]]:function(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=1),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}(Re(e.slice(0,n),t),Re(e.slice(n,r),t),t)}function Oe(e,t,r){try{const n=e.body;if(r.length!==e.params.length)return ne(new Error("Invalid Parameter calls to function."));for(let n=0;n<r.length;n++){const o=e.params[n];"Identifier"===o.type&&(t.localScope[o.name.toLowerCase()]={d:null,value:r[n],valueset:!0,node:null})}return ce(t,n).then((e=>q(((t,r)=>{e instanceof N?t(e.value):e!==S?e!==T?t(e instanceof I?e.value:e):r(new Error("Cannot Continue from a Function")):r(new Error("Cannot Break from a Function"))}))))}catch(e){return H(e)}}function Ue(e,t,r){return ie(e,t,(function(t,n,o){const a={spatialReference:e.spatialReference,services:e.services,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return Oe(r,a,o)}))}function Ae(e){return function(){const t={abortSignal:e.context.abortSignal,spatialReference:e.context.spatialReference,console:e.context.console,lrucache:e.context.lrucache,interceptor:e.context.interceptor,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(t.depthCounter>64)throw new Error("Exceeded maximum function depth");return Oe(e.definition,t,arguments)}}e(Ne,se),t(Ne,se),r(Ne,se),n(Ne,se),o(Ne,se),z({functions:Ne,compiled:!1,signatures:null,failDefferred:null,evaluateIdentifier:null,arcadeCustomFunctionHandler:null,mode:"async",standardFunction:se,standardFunctionAsync:ie}),Ne.typeof=function(e,t){return se(e,t,(function(e,t,r){y(r,1,1);const n=Ie(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},Ne.iif=function(e,t){return q(((r,n)=>{y(null===t.arguments?[]:t.arguments,3,3),ce(e,t.arguments[0]).then((o=>{try{if(!1===E(o))return void n(new Error("IF Function must have a boolean test condition"));Z([ce(e,t.arguments[1]),ce(e,t.arguments[2])]).then((e=>{r(o?e[0]:e[1])}),n)}catch(e){n(e)}}),n)}))},Ne.decode=function(e,t){return q(((r,n)=>{t.arguments.length<2?n(new Error("Missing Parameters")):2!==t.arguments.length?(t.arguments.length-1)%2!=0?ce(e,t.arguments[0]).then((o=>{try{be(e,t,1,o).then(r,n)}catch(e){n(e)}}),n):n(new Error("Must have a default value result.")):ce(e,t.arguments[1]).then(r,n)}))},Ne.when=function(e,t){try{return t.arguments.length<3?ne("Missing Parameters"):t.arguments.length%2==0?ne("Must have a default value result."):ce(e,t.arguments[0]).then((r=>q(((n,o)=>{if(!1===E(r))return void o(new Error("WHEN needs boolean test conditions"));Se(e,t,0,r).then(n,o)}))))}catch(e){return ne(e)}},Ne.sort=function(e,t){return ie(e,t,(function(e,t,r){y(r,1,2);let n=r[0];if(C(n)&&(n=n.toArray()),!1===U(n))return ne(Error("Illegal Argument"));if(r.length>1){if(!1===D(r[1]))return ne(Error("Illegal Argument"));return Te(n,Ae(r[1]))}{let e=n;if(0===e.length)return J([]);const t={};for(let r=0;r<e.length;r++){const n=Ie(e[r]);""!==n&&(t[n]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return J(e.slice(0));let r=0,o="";for(const e in t)r++,o=e;return r>1||"String"===o?e=Re(e,(function(e,t){if(null==e||e===b)return null==t||t===b?0:1;if(null==t||t===b)return-1;const r=O(e),n=O(t);return r<n?-1:r===n?0:1})):"Number"===o?e=Re(e,(function(e,t){return e-t})):"Boolean"===o?e=Re(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===o&&(e=Re(e,(function(e,t){return t-e}))),J(e)}}))};const Ce={failDefferred:ne,resolveDeffered:oe,fixSpatialReference:_,parseArguments:ae,standardFunction:se,standardFunctionAsync:ie,evaluateIdentifier:ve,arcadeCustomFunction:Ae};for(const e in Ne)Ne[e]={value:new v(Ne[e]),valueset:!0,node:null};const Fe=function(){};function Me(e){console.log(e)}(Fe.prototype=Ne).infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},Fe.prototype.pi={value:Math.PI,valueset:!0,node:null};const xe=Ce;function De(e){const t={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:se,standardFunctionAsync:ie,failDefferred:ne,evaluateIdentifier:ve,arcadeCustomFunctionHandler:Ae};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const e in t.functions)Ne[e]={value:new v(t.functions[e]),valueset:!0,node:null},Fe.prototype[e]=Ne[e];for(let e=0;e<t.signatures.length;e++)a(t.signatures[e],"async")}function ke(e,t){let r=t.spatialReference;null==r&&(r=new te({wkid:102100}));const n=function(e,t){const r=new Fe;null==e&&(e={}),null==t&&(t={});const n=new h({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});n.immutable=!1,r.textformatting={value:n,valueset:!0,node:null};for(const e in t)r[e]={value:new v(t[e]),native:!0,valueset:!0,node:null};for(const t in e)e[t]&&"esri.Graphic"===e[t].declaredClass?r[t]={value:m.createFromGraphic(e[t]),valueset:!0,node:null}:r[t]={value:e[t],valueset:!0,node:null};return r}(t.vars,t.customfunctions);return ce({spatialReference:r,services:t.services,abortSignal:void 0===t.abortSignal||null===t.abortSignal?{aborted:!1}:t.abortSignal,globalScope:n,console:t.console?t.console:Me,lrucache:t.lrucache,interceptor:t.interceptor,localScope:null,depthCounter:1},e.body[0].body).then((e=>q(((t,r)=>{e instanceof N&&(e=e.value),e instanceof I&&(e=e.value),e===b&&(e=null),e!==S?e!==T?e instanceof v||e instanceof j?r(new Error("Cannot return FUNCTION")):t(e):r(new Error("Cannot return CONTINUE")):r(new Error("Cannot return BREAK"))}))))}function Pe(e,t){return i(e)}function Le(e,t){return c(e,t,"full")}function _e(e,t){return l(e,t)}function Ve(e,t){return u(e,t)}function Ye(e){return p(e)}De([s]);export{ke as executeScript,De as extend,Pe as extractFieldLiterals,Ye as findFunctionCalls,xe as functionHelper,Ve as referencesFunction,_e as referencesMember,Le as validateScript};
