/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{i as t,b as r,j as e}from"../core/lang.js";import{i}from"./multiOriginJSONSupportUtils.js";import{getPathExtension as o,isAbsolute as n,isBlobProtocol as s,join as p}from"../core/urlUtils.js";import{g as a}from"./uuid.js";import{g as u}from"./metadata.js";import{n as c}from"../core/Accessor.js";import{propertyJSONMeta as l}from"../core/accessorSupport/decorators/property.js";import{r as f,t as m,M as g,i as y,p as d}from"./persistableUrlUtils.js";function h(t){return j[function(t){if(t instanceof Blob)return t.type;return function(t){const r=o(t);return U[r]||v}(t.url)}(t)]||w}const j={},v="text/plain",w=j[v],U={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const t in U)j[U[t]]=t;function b(e){const p=t(e)&&e.origins?e.origins:[void 0];return(a,j)=>{const v=function(e,p,a){if(t(e)&&"resource"===e.type)return function(e,p,a){const l=u(p,a);return{type:String,read:(t,r,e)=>{const i=f(t,r,e);return l.type===String?i:"function"==typeof l.type?new l.type({url:i}):void 0},write:{writer(p,u,f,d){if(!d||!d.resources)return"string"==typeof p?void(u[f]=m(p,d)):void(u[f]=p.write({},d));const j=function(t){if(r(t))return null;if("string"==typeof t)return t;return t.url}(p),v=j?m(j,{...d,verifyItemRelativeUrls:d&&d.verifyItemRelativeUrls?{writtenUrls:d.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},g.NO):null,w=l.type!==String&&(!i(this)||d&&d.origin&&this.originIdOf(a)>c(d.origin));d&&d.portalItem&&t(v)&&!n(v)?w?function(t,r,e,i,n,s,p,a){const u=p.portalItem.resourceFromPath(i),c=S(e,i,p),l=h(c),f=o(u.path);if(l!==f)return void x(t,r,e,i,n,s,p,a);I(t,r,u,c,p.resources.toUpdate),n[s]=i}(this,a,p,v,u,f,d,e):function(t,r,e,i){i.resources.toKeep.push({resource:i.portalItem.resourceFromPath(t)}),r[e]=t}(v,u,f,d):d&&d.portalItem&&(r(v)||t(y(v))||s(v)||w)?x(this,a,p,v,u,f,d,e):u[f]=v}}}}(e,p,a);switch(t(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=d;return{read:t,write:r}}}}(e,a,j);for(const t of p){const r=l(a,t,j);for(const t in v)r[t]=v[t]}}}function x(t,r,i,o,n,u,c,l){const f=a(),m=S(i,o,c),g=p(e(l,"prefix"),f),y=`${g}.${h(m)}`,d=c.portalItem.resourceFromPath(y);s(o)&&c.resources.pendingOperations.push(async function(t){const r=(await import("../request.js").then((t=>t.r))).default,{data:e}=await r(t,{responseType:"blob"});return e}(o).then((t=>{d.path=`${g}.${h(t)}`,n[u]=d.itemRelativeUrl})).catch((()=>{}))),I(t,r,d,m,c.resources.toAdd),n[u]=d.itemRelativeUrl}function I(t,r,e,i,o){o.push({resource:e,content:i,finish:e=>{!function(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}(t,r,e)}})}function S(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}export{b as p};
