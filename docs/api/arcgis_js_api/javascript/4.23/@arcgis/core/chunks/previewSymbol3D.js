/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{g as t}from"./assets.js";import{t as s,a as e}from"./colorUtils2.js";import{b as o,i as r}from"../core/lang.js";import l from"../core/Error.js";import{L as i}from"./Logger.js";import{eachAlways as a}from"../core/promiseUtils.js";import{e as m}from"./screenUtils.js";import{l as p,m as n,j as c,n as u,f as y}from"./utils6.js";import{d as h}from"../symbols/IconSymbol3DLayer.js";import{d as j}from"../symbols/ObjectSymbol3DLayer.js";import{S as b,a as f,g as d,b as g,c as S,d as v,e as k,f as M,h as L,i as x,s as w,j as U}from"../symbols/support/symbolUtils.js";import{h as D,t as P}from"./renderUtils.js";import{resolveWebStyleSymbol as z}from"./webStyleSymbolUtils.js";import"../config.js";import"./object.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./string.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"./ensureType.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils3.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils4.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"./Evented.js";import"./shared.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"./Loadable.js";import"./Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./persistableUrlUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./Clonable.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"./styleUtils.js";const C=b.size,E=b.maxSize,O=b.maxOutlineSize,F=b.lineWidth,I=b.tallSymbolWidth,T=i.getLogger("esri.symbols.support.previewSymbol3D");function R(t){const s=t.outline,e=r(t.material)?t.material.color:null,l=r(e)?e.toHex():null;if(o(s)||"pattern"in s&&r(s.pattern)&&"style"===s.pattern.type&&"none"===s.pattern.style)return"fill"===t.type&&"#ffffff"===l?{color:"#bdc3c7",width:.75}:null;const i=m(s.size)||0;return{color:"rgba("+(r(s.color)?s.color.toRgba():"255,255,255,1")+")",width:Math.min(i,O),style:"pattern"in s&&r(s.pattern)&&"style"===s.pattern.type?u(s.pattern.style):null,join:"butt",cap:"patternCap"in s?s.patternCap:"butt"}}function W(t,o=1){const r=t.a,l=s(t),i=l.h,a=l.s/o,m=100-(100-l.v)/o,{r:p,g:n,b:c}=e({h:i,s:a,v:m});return[p,n,c,r]}function A(t){return"water"===t.type?o(t.color)?null:t.color:o(t.material)||o(t.material.color)?null:t.material.color}function q(t,s=0){const e=A(t);if(!e){if("fill"===t.type)return null;const e=p.r,o=f(e,s);return[o,o,o,100]}const o=e.toRgba();for(let t=0;t<3;t++)o[t]=f(o[t],s);return o}async function B(s,e){const o=s.style;if("none"===o)return null;return{type:"pattern",x:0,y:0,src:await n(t(`esri/symbols/patterns/${o}.png`),e.toCss(!0)),width:5,height:5}}function H(t){return t.outline?R(t):{color:"rgba(0, 0, 0, 1)",width:1.5}}function N(t,s){const e=A(t);if(!e)return null;let o="rgba(";return o+=f(e.r,s)+",",o+=f(e.g,s)+",",o+=f(e.b,s)+",",o+e.a+");"}function Z(t,s){const e=N(t,s);if(!e)return{};if("pattern"in t&&r(t.pattern)&&"style"===t.pattern.type&&"none"===t.pattern.style)return null;return{color:e,width:Math.min(t.size?m(t.size):.75,O),style:"pattern"in t&&r(t.pattern)&&"style"===t.pattern.type?u(t.pattern.style):null,cap:"cap"in t?t.cap:null,join:"join"in t?"miter"===t.join?m(2):t.join:null}}function G(t,s,e){const o=.75*e;return{type:"linear",x1:o?.25*o:0,y1:o?.5*o:0,x2:o||4,y2:o?.5*o:4,colors:[{color:t,offset:0},{color:s,offset:1}]}}function Q(t){const s="number"==typeof(null==t?void 0:t.size)?null==t?void 0:t.size:null;return s?m(s):null}function J(s,e){const o=Q(e),r=e&&e.maxSize?m(e.maxSize):null,l=e&&e.disableUpsampling,i=s.symbolLayers,p=[];let n=0,c=0;const u=i.getItemAt(i.length-1);let b;return u&&"icon"===u.type&&(b=u.size&&m(u.size)),i.forEach((i=>{if("icon"!==i.type&&"object"!==i.type)return;const a="icon"===i.type?i.size&&m(i.size):0,u=o||a?Math.ceil(Math.min(o||a,r||E)):C;if(i&&i.resource&&i.resource.href){const e=function(s,e){const o=e&&e.resource,r=o&&o.href;if(s.thumbnail&&s.thumbnail.url)return Promise.resolve(s.thumbnail.url);if(r&&"object"!==e.type)return Promise.resolve(y(s,e));const l=t("esri/images/Legend/legend3dsymboldefault.png");return s.styleOrigin&&(s.styleOrigin.styleName||s.styleOrigin.styleUrl)?z(s.styleOrigin,{portal:s.styleOrigin.portal},"webRef").catch((t=>t)).then((t=>{var s;return(null==t||null==(s=t.thumbnail)?void 0:s.url)||l})):Promise.resolve(l)}(s,i).then((function(t){const s=i.get("material.color"),e=function(t){return"icon"===t.type?"multiply":"tint"}(i);return P(t,u,s,e,l)})).then((function(t){const s=t.width,e=t.height;return n=Math.max(n,s),c=Math.max(c,e),[{shape:{type:"image",x:0,y:0,width:s,height:e,src:t.url},fill:null,stroke:null}]}));p.push(e)}else{var f;let t=u;"icon"===i.type&&b&&o&&(t=u*(a/b));const s="tall"===(null==e?void 0:e.symbolConfig)||(null==e||null==(f=e.symbolConfig)?void 0:f.isTall)||"object"===i.type&&function(t){const s=t.depth,e=t.height,o=t.width;return o&&s&&e&&o===s&&o<e}(i);n=Math.max(n,s?I:t),c=Math.max(c,t),p.push(Promise.resolve(function(t,s,e){const o=[];if(!t)return o;switch(t.type){case"icon":{const e=0,r=0,l=s,i=s;switch(t.resource&&t.resource.primitive||h){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*s},fill:q(t,0),stroke:R(t)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[e,r]},{command:"L",values:[l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:q(t,0),stroke:R(t)});break;case"triangle":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:q(t,0),stroke:R(t)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*l,r]},{command:"L",values:[.5*l,i]},{command:"M",values:[e,.5*i]},{command:"L",values:[l,.5*i]}]},stroke:H(t)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[e,r]},{command:"L",values:[l,i]},{command:"M",values:[l,r]},{command:"L",values:[e,i]}]},stroke:H(t)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[e,.5*i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:q(t,0),stroke:R(t)})}break}case"object":switch(t.resource&&t.resource.primitive||j){case"cone":{const r=G(q(t,0),q(t,-.6),e?I:s),l=x(s,e);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:r});break}case"inverted-cone":{const e=q(t,0),r=G(e,q(t,-.6),s),l=L(s);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:e});break}case"cube":{const r=M(s,e);o.push({shape:r[0],fill:q(t,0)}),o.push({shape:r[1],fill:q(t,-.3)}),o.push({shape:r[2],fill:q(t,-.5)});break}case"cylinder":{const r=G(q(t,0),q(t,-.6),e?I:s),l=k(s,e);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:r}),o.push({shape:l[2],fill:q(t,0)});break}case"diamond":{const e=v(s);o.push({shape:e[0],fill:q(t,-.3)}),o.push({shape:e[1],fill:q(t,0)}),o.push({shape:e[2],fill:q(t,-.3)}),o.push({shape:e[3],fill:q(t,-.7)});break}case"sphere":{const e=G(q(t,0),q(t,-.6));e.x1=0,e.y1=0,e.x2=.25*s,e.y2=.25*s,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*s},fill:e});break}case"tetrahedron":{const e=S(s);o.push({shape:e[0],fill:q(t,-.3)}),o.push({shape:e[1],fill:q(t,0)}),o.push({shape:e[2],fill:q(t,-.6)});break}}}return o}(i,t,s)))}})),a(p).then((function(t){const s=[];return t.forEach((function(t){t.value?s.push(t.value):t.error&&T.warn("error while building swatchInfo!",t.error)})),D(s,[n,c],{node:e&&e.node,scale:!1,opacity:e&&e.opacity})}))}function V(t,s){if(0===t.symbolLayers.length)return Promise.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(t.type){case"point-3d":return J(t,s);case"line-3d":return function(t,s){const e=t.symbolLayers,r=[],l=c(t),i=Q(s),a=(s&&s.maxSize?m(s.maxSize):null)||O;let p,n=0,u=0;return e.forEach(((t,s)=>{if(!t)return;if("line"!==t.type&&"path"!==t.type)return;const e=[];switch(t.type){case"line":{const r=Z(t,0);if(o(r))break;const l=r&&r.width||0;0===s&&(p=l);const m=Math.min(i||l,a),c=0===s?m:i?m*(l/p):m,y=c>F/2?2*c:F;u=Math.max(u,c),n=Math.max(n,y),r.width=c,e.push({shape:{type:"path",path:[{command:"M",values:[0,.5*u]},{command:"L",values:[n,.5*u]}]},stroke:r});break}case"path":{const s=Math.min(i||C,a),o=q(t,0),r=q(t,-.2),l=N(t,-.4),m=l?{color:l,width:1}:{};if("quad"===t.profile){const s=t.width,l=t.height,i=d(s&&l?s/l:1,0===l,0===s),a={...m,join:"bevel"};e.push({shape:i[0],fill:r,stroke:a}),e.push({shape:i[1],fill:r,stroke:a}),e.push({shape:i[2],fill:o,stroke:a})}else e.push({shape:w.pathSymbol3DLayer[0],fill:r,stroke:m}),e.push({shape:w.pathSymbol3DLayer[1],fill:o,stroke:m});u=Math.max(u,s),n=u}}r.push(e)})),Promise.resolve(D(r,[n,u],{node:s&&s.node,scale:l,opacity:s&&s.opacity}))}(t,s);case"polygon-3d":case"mesh-3d":return async function(t,s){const e="mesh-3d"===t.type,l=t.symbolLayers,i=Q(s),a=s&&s.maxSize?m(s.maxSize):null,p=i||C,n=[];let c=0,u=0,y=!1;for(let t=0;t<l.length;t++){const s=l.getItemAt(t),i=[];if(e&&"fill"!==s.type)continue;const m=w.fill[0];switch(s.type){case"fill":{const t=R(s),o=Math.min(p,a||E);c=Math.max(c,o),u=Math.max(u,o),y=!0;let l=q(s,0);const n="pattern"in s&&s.pattern,h=A(s);!e&&r(n)&&"style"===n.type&&"solid"!==n.style&&h&&(l=await B(n,h)),i.push({shape:m,fill:l,stroke:t});break}case"line":{const t=Z(s,0);if(o(t))break;const e={stroke:t,shape:m};c=Math.max(c,C),u=Math.max(u,C),i.push(e);break}case"extrude":{const t={join:"round",width:1,...Z(s,-.4)},e=q(s,0),o=q(s,-.2),r=Math.min(p,a||E),l=g(r);t.width=1,i.push({shape:l[0],fill:o,stroke:t}),i.push({shape:l[1],fill:o,stroke:t}),i.push({shape:l[2],fill:e,stroke:t});const m=C,n=.7*C+.5*r;c=Math.max(c,m),u=Math.max(u,n);break}case"water":{const t=A(s),e=W(t),o=W(t,2),r=W(t,3),l=U();y=!0,i.push({shape:l[0],fill:e}),i.push({shape:l[1],fill:o}),i.push({shape:l[2],fill:r});const m=Math.min(p,a||E);c=Math.max(c,m),u=Math.max(u,m);break}}n.push(i)}return Promise.resolve(D(n,[c,u],{node:s&&s.node,scale:y,opacity:s&&s.opacity}))}(t,s)}return Promise.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}export{B as getPatternDescriptor,Q as getSizeFromOptions,q as getSymbolLayerFill,V as previewSymbol3D};
