/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import{b as t,i as n}from"../core/lang.js";import{g as i}from"./unitUtils.js";import{e as o,f as s,g as r,h as a,j as l}from"./pe.js";import{isLoaded as c,load as f,project as u,canProjectWithoutEngine as m,getTransformation as x}from"../geometry/projection.js";import p from"../geometry/Extent.js";import h from"../geometry/Point.js";import g from"../geometry/SpatialReference.js";function y(e,t,n){return!m(e,t,n)}function d(t,n,i){const o=y(t,n,i);if(o&&!c())throw new e("rasterprojectionhelper-project","projection engine is not loaded");return o}const M=function(e,t,n,i=0){if(1===n[0])return[0,0];let o=1,s=-1,r=1,a=-1;for(let t=0;t<e.length;t+=2)isNaN(e[t])||(o=o>e[t]?e[t]:o,s=s>e[t]?s:e[t],r=r>e[t+1]?e[t+1]:r,a=a>e[t+1]?a:e[t+1]);const{cols:l,rows:c}=t,f=(s-o)/l/n[0],u=(a-r)/c/n[1],m=2*i;let x=0,p=!1,h=[0,0];for(let t=0;t<l-3;t++){for(let n=0;n<c-3;n++){const i=t*c*2+2*n,o=(e[i]+e[i+4]+e[i+4*c]+e[i+4*c+4])/4,s=(e[i+1]+e[i+5]+e[i+4*c+1]+e[i+4*c+5])/4,r=Math.abs((o-e[i+2*c+2])/f),a=Math.abs((s-e[i+2*c+3])/u);if(r+a>x&&(x=r+a,h=[r,a]),m&&x>m){p=!0;break}}if(p)break}return h},w={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244},R=new Map,P=new Map;async function S(){if(c())return null;await f()}function b(e,t,n){if(!d(e.spatialReference,t))return null;return n?x(t,e.spatialReference,e):x(e.spatialReference,t,e)}function E(e,o,s,r=null){const a=e.spatialReference;if(a.equals(o))return e;d(a,o,r);const l=s.center,c=new p({xmin:l.x-e.x/2,xmax:l.x+e.x/2,ymin:l.y-e.y/2,ymax:l.y+e.y/2,spatialReference:a}),f=u(c,o,r);if(t(f))return null;const m={x:f.xmax-f.xmin,y:f.ymax-f.ymin},x=O(o);if(n(x)&&m.x>=x){const t=i(a)/i(o);m.x=e.x*t,m.y=e.y*t}return m}function G(e,t=.01){return i(e)?t/i(e):0}function k(e,t,i=null,o=!0){const s=e.spatialReference;if(s.equals(t))return e;d(s,t,i);const r=u(e,t,i);if(!o||!r)return r;const a=A(s,!0),l=A(t,!0),c=G(s);return c&&n(a)&&n(l)&&(r.x>0&&Math.abs(e.x-a[0])<c?r.x-=l[1]-l[0]:r.x<0&&Math.abs(e.x-a[1])<c&&(r.x+=l[1]-l[0])),r}function N(e){const{inSR:t,outSR:i,datumTransformation:o,preferPE:s}=e;if(t.equals(i)){const{points:t}=_(e,null);return t}if(t.isWebMercator&&i.isWGS84||t.isWGS84&&i.isWebMercator)return function(e){const{cols:t,rows:n,xres:i,yres:o,usePixelCenter:s,inSR:r,outSR:a}=e;let{xmin:l,ymax:c}=e;s&&(l+=i/2,c-=o/2);const f=[],m=[],x=Math.max(t,n);for(let e=0;e<x;e++){const s=l+i*Math.min(t,e),x=c-o*Math.min(n,e),p=u(new h({x:s,y:x,spatialReference:r}),a);e<=t&&f.push(p.x),e<=n&&m.push(p.y)}const p=[];for(let e=0;e<t;e++)for(let t=0;t<n;t++)p.push([f[e],m[t]]);return p}(e);if(d(t,i,o)&&s){if(t.isGeographic)return v(e);const i=T(t);if(n(i))return v(e)}return function(e){const{points:t}=_(e,null),n=t.map((t=>new h(t[0],t[1],e.inSR)));return u(n,e.outSR,e.datumTransformation).map((e=>e?[e.x,e.y]:[NaN,NaN]))}(e)}function v(e){const{inSR:t,outSR:i,datumTransformation:l}=e,c=T(t),{points:f,mask:u}=_(e,c);if(!t.isGeographic){const e=t.wkid?o.coordsys(t.wkid):o.fromString(t.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,t.wkt);r.projToGeog(e,f.length,f)}if(n(l)&&l.steps.length&&l.steps.forEach((e=>{const t=e.wkid?o.geogtran(e.wkid):o.fromString(s.PE_TYPE_GEOGTRAN,e.wkt);a.geogToGeog(t,f.length,f,null,e.isInverse?s.PE_TRANSFORM_2_TO_1:s.PE_TRANSFORM_1_TO_2)})),!i.isGeographic){const e=T(i,!0),t=n(e)&&e.isEnvelope?[e.bbox[1],e.bbox[3]]:[-90,90];!function(e,t){const[n,i]=t;for(let t=0;t<e.length;t++){const o=e[t][1];(o<n||o>i)&&(e[t]=[NaN,NaN])}}(f,t);const a=i.wkid?o.coordsys(i.wkid):o.fromString(i.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,i.wkt);r.geogToProj(a,f.length,f)}let m=f;if(u&&f.length!==u.length){m=[];for(let e=0,t=0;e<u.length;e++)u[e]?m.push(f[t++]):m.push([NaN,NaN])}return m}function T(e,t=!1){let n=e.wkid||e.wkt;if(!n||e.isGeographic)return null;if(n=String(n),R.has(n)){const e=R.get(n);return t?null==e?void 0:e.gcs:null==e?void 0:e.pcs}const i=e.wkid?o.coordsys(e.wkid):o.fromString(e.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,e.wkt),r=C(i,G(e,1e-4)),a=C(i,0,!0);return R.set(n,{pcs:r,gcs:a}),t?a:r}function C(e,t=0,n=!1){const i=l.generate(e),o=n?e.horizonGcsGenerate():e.horizonPcsGenerate();if(null==o||!o.length)return null;let s=!1,r=o.find((e=>1===e.getInclusive()&&1===e.getKind()));if(!r){if(r=o.find((e=>1===e.getInclusive()&&0===e.getKind())),!r)return null;s=!0}const a=i.isPannableRectangle(),c=r.getCoord();if(s)return{isEnvelope:s,isPannable:a,vertices:c,coef:null,bbox:[c[0][0]-t,c[0][1]-t,c[1][0]+t,c[1][1]+t]};let f=0;const u=[];let[m,x]=c[0],[p,h]=c[0];for(let e=0,t=c.length;e<t;e++){f++,f===t&&(f=0);const[n,i]=c[e],[o,s]=c[f];if(s===i)u.push([n,o,i,s,2]);else{const e=(o-n)/(s-i||1e-4),t=n-e*i;i<s?u.push([e,t,i,s,0]):u.push([e,t,s,i,1])}m=m<n?m:n,x=x<i?x:i,p=p>n?p:n,h=h>i?h:i}return{isEnvelope:!1,isPannable:a,vertices:c,coef:u,bbox:[m,x,p,h]}}function _(e,t){const i=[],{cols:o,rows:s,xres:r,yres:a,usePixelCenter:l}=e;let{xmin:c,ymax:f}=e;if(l&&(c+=r/2,f-=a/2),!n(t)){for(let e=0;e<o;e++)for(let t=0;t<s;t++)i.push([c+r*e,f-a*t]);return{points:i}}const u=new Uint8Array(o*s);if(t.isEnvelope){const{bbox:[e,n,l,m]}=t;for(let x=0,p=0;x<o;x++){const o=c+r*x,h=t.isPannable||o>=e&&o<=l;for(let e=0;e<s;e++,p++){const t=f-a*e;h&&t>=n&&t<=m&&(i.push([o,t]),u[p]=1)}}return{points:i,mask:u}}const{coef:m}=t,x=[];for(let e=0;e<s;e++){const t=f-a*e,n=[],i=[];for(let e=0;e<m.length;e++){const[o,s,r,a,l]=m[e];if(t===r&&r===a)n.push(o),n.push(s),i.push(2),i.push(2);else if(t>=r&&t<=a){const e=o*t+s;n.push(e),i.push(l)}}let o=n;if(n.length>2){let e=2===i[0]?0:i[0],t=n[0];o=[];for(let s=1;s<i.length;s++)2===i[s]&&s!==i.length-1||(i[s]!==e&&(o.push(0===e?Math.min(t,n[s-1]):Math.max(t,n[s-1])),e=i[s],t=n[s]),s===i.length-1&&o.push(0===i[s]?Math.min(t,n[s]):Math.max(t,n[s])));o.sort(((e,t)=>e-t))}else n[0]>n[1]&&(o=[n[1],n[0]]);x.push(o)}for(let e=0,t=0;e<o;e++){const n=c+r*e;for(let e=0;e<s;e++,t++){const o=f-a*e,s=x[e];if(2===s.length)n>=s[0]&&n<=s[1]&&(i.push([n,o]),u[t]=1);else if(s.length>2){let e=!1;for(let t=0;t<s.length;t+=2)if(n>=s[t]&&n<=s[t+1]){e=!0;break}e&&(i.push([n,o]),u[t]=1)}}}return{points:i,mask:u}}function j(e){const t=O(e[0].spatialReference);if(e.length<2||!n(t))return e[0];let{xmin:i,xmax:o,ymin:s,ymax:r}=e[0];for(let n=1;n<e.length;n++){const i=e[n];o=i.xmax+t*n,s=Math.min(s,i.ymin),r=Math.max(r,i.ymax)}return new p({xmin:i,xmax:o,ymin:s,ymax:r,spatialReference:e[0].spatialReference})}function z(e,n,i=null,o=!0){if(e.spatialReference.equals(n))return e;const s=Y(e),r=O(e.spatialReference,!0),a=O(n);if(0===s||t(r)||t(a))return W(e,n,i,o);const l=e.clone().normalize();if(1===l.length&&e.xmax<r&&e.xmax-r/2>G(e.spatialReference)){const{xmin:t,xmax:n}=e;for(let i=0;i<=s;i++){const o=0===i?t:-r/2,a=i===s?n-r*i:r/2;l[i]=new p({xmin:o,xmax:a,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference})}}return j(l.map((e=>W(e,n,i,o))).filter((e=>!!e)))}function W(e,n,i=null,o=!0,s=!0){const r=e.spatialReference;if(r.equals(n))return e;d(r,n,i);const a=u(e,n,i);if(s&&n.isWebMercator&&a&&(a.ymax=Math.min(20037508.342787,a.ymax),a.ymin=Math.max(-20037508.342787,a.ymin),a.ymin>=a.ymax))return null;if(!o||!a)return a;const l=A(r,!0),c=A(n,!0);if(t(l)||t(c))return a;const f=G(r,.001),m=G(r,500),x=G(n,.001);if(Math.abs(a.xmin-c[0])<x&&Math.abs(a.xmax-c[1])<x){const t=Math.abs(e.xmin-l[0]),o=Math.abs(l[1]-e.xmax);if(t<f&&o>m){a.xmin=c[0];const t=[];t.push(new h(e.xmax,e.ymin,r)),t.push(new h(e.xmax,(e.ymin+e.ymax)/2,r)),t.push(new h(e.xmax,e.ymax,r));const o=t.map((e=>k(e,n,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));a.xmax=Math.max.apply(null,o)}if(o<f&&t>m){a.xmax=c[1];const t=[];t.push(new h(e.xmin,e.ymin,r)),t.push(new h(e.xmin,(e.ymin+e.ymax)/2,r)),t.push(new h(e.xmin,e.ymax,r));const o=t.map((e=>k(e,n,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));a.xmin=Math.min.apply(null,o)}}else{const e=G(n,.001);Math.abs(a.xmin-c[0])<e&&(a.xmin=c[0]),Math.abs(a.xmax-c[1])<e&&(a.xmax=c[1])}return a}function O(e,t=!1){const n=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*n:e.wkid&&e.isGeographic?360:2*w[e.wkid]||null}function A(e,t=!1){if(e.isGeographic)return[-180,180];const i=O(e,t);return n(i)?[-i/2,i/2]:null}function I(e,t,n,i){let o=(e-t)/n;return o-Math.floor(o)!=0?o=Math.floor(o):i&&(o-=1),o}function Y(e,t=!1){const i=O(e.spatialReference);if(!n(i))return 0;const o=t?0:-(i/2),s=G(e.spatialReference),r=!t&&Math.abs(e.xmax-i/2)<s?i/2:e.xmax,a=!t&&Math.abs(e.xmin+i/2)<s?-i/2:e.xmin;return I(r,o,i,!0)-I(a,o,i,!1)}function B(e){const t=e.storageInfo.origin.x,i=O(e.spatialReference,!0);if(!n(i))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const o=i/2,{nativePixelSize:s,storageInfo:r,extent:a}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:f}=r;let u=s.x;const m=[],x=n(e.transform)&&"gcs-shift"===e.transform.type,p=t+(x?0:o),h=x?i-t:o-t;for(let e=0;e<=l;e++){const e=(a.xmax-t)/u/c,n=e-Math.floor(e)==0?e:Math.ceil(e),i=h/u/c,o=i-Math.floor(i)==0?i:Math.ceil(i),s=Math.floor(p/u/c),r=Math.round(p/u)%c,l=(c-Math.round(h/u)%c)%c;m.push({resolutionX:u,blockWidth:c,datsetColumnCount:n,worldColumnCountFromOrigin:o,leftMargin:r,rightPadding:l,originColumnOffset:s}),u*=f}return{originX:t,halfWorldWidth:o,pyramidsInfo:m,hasGCSSShiftTransform:x}}function F(e){const t=e.isAdaptive&&null==e.spacing;let i=e.spacing||[32,32],r=L(e),a={cols:r.size[0]+1,rows:r.size[1]+1};const l=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let c=r.outofBoundPointCount===r.offsets.length/2||t&&l?[0,0]:M(r.offsets,a,i,4);const f=(c[0]+c[1])/2,u=e.projectedExtent.spatialReference,m=e.srcBufferExtent.spatialReference;if(t&&(l||f>4)){y(u,m,e.datumTransformation)&&(u.isGeographic||n(T(u))),i=[4,4],r=L({...e,spacing:i}),a={cols:r.size[0]+1,rows:r.size[1]+1},c=M(r.offsets,a,i,4)}if(r.error=c,i[0]>1&&(r.coefficients=q(r.offsets,a,l)),e.includeGCSGrid&&!u.isGeographic&&!u.isWebMercator)if(m.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:i};else{const t=T(u);if(n(t)&&!t.isEnvelope){const t=function(e){if(!e||e.isGeographic)return e;const t=String(e.wkid||e.wkt);let n;P.has(t)?n=P.get(t):(n=(e.wkid?o.coordsys(e.wkid):o.fromString(s.PE_TYPE_PROJCS,e.wkt)).getGeogcs().getCode(),P.set(t,n));return new g({wkid:n})}(u),n=z(e.projectedExtent,t),{offsets:c}=L({...e,srcBufferExtent:n,spacing:i}),f=q(c,a,l);r.gcsGrid={offsets:c,coefficients:f,spacing:i}}}return r}function L(e){const{projectedExtent:t,srcBufferExtent:i,pixelSize:o,datumTransformation:s,rasterTransform:r}=e,a=t.spatialReference,l=i.spatialReference;d(a,l);const{xmin:c,ymin:f,xmax:u,ymax:m}=t,x=O(l),p=n(x)&&(e.hasWrapAround||"gcs-shift"===(null==r?void 0:r.type)),g=e.spacing||[32,32],y=g[0]*o.x,M=g[1]*o.y,w=1===g[0],R=Math.ceil((u-c)/y-.1/g[0])+(w?0:1),P=Math.ceil((m-f)/M-.1/g[1])+(w?0:1),S=N({cols:R,rows:P,xmin:c,ymax:m,xres:y,yres:M,inSR:a,outSR:l,datumTransformation:s,preferPE:g[0]<=4,usePixelCenter:w}),b=[];let E,k=0;const v=w?-1:NaN,{xmin:T,xmax:C,ymax:_,width:j,height:z}=i,W=G(l,500);for(let e=0;e<R;e++){const t=[];for(let n=0;n<P;n++){let i=S[e*P+n];if(p&&i[0]>C&&i[0]>x/2-W&&(i[0]-=x),!i||isNaN(i[0])||isNaN(i[1]))b.push(v),b.push(v),t.push(null),k++;else{if(r){const e=r.inverseTransform(new h({x:i[0],y:i[1],spatialReference:l}));i=[e.x,e.y]}t.push(i),e>0&&p&&E[n]&&i[0]<E[n][0]&&(i[0]+=x),b.push((i[0]-T)/j),b.push((_-i[1])/z)}}E=t}return{offsets:b,error:null,coefficients:null,outofBoundPointCount:k,spacing:g,size:w?[R,P]:[R-1,P-1]}}function q(e,t,n){const{cols:i,rows:o}=t,s=new Float32Array((i-1)*(o-1)*2*6),r=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),a=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let t=0;t<i-1;t++){for(let n=0;n<o-1;n++){let l=t*o*2+2*n;const c=e[l],f=e[l+1],u=e[l+2],m=e[l+3];l+=2*o;const x=e[l],p=e[l+1],h=e[l+2],g=e[l+3];let y=0,d=12*(n*(i-1)+t);for(let e=0;e<3;e++)s[d++]=r[y++]*c+r[y++]*u+r[y++]*h;y=0;for(let e=0;e<3;e++)s[d++]=r[y++]*f+r[y++]*m+r[y++]*g;y=0;for(let e=0;e<3;e++)s[d++]=a[y++]*c+a[y++]*x+a[y++]*h;y=0;for(let e=0;e<3;e++)s[d++]=a[y++]*f+a[y++]*p+a[y++]*g}if(n)for(let e=0;e<s.length;e++)isNaN(s[e])&&(s[e]=-1)}return s}function J(e){const t=e.clone().normalize();return 1===t.length?t[0]:j(t)}function X(e,t,i){const{storageInfo:o,pixelSize:s}=t;let r,a=!1;const{pyramidResolutions:l}=o;if(n(l)&&l.length){const n=(e.x+e.y)/2,o=l[l.length-1],c=(o.x+o.y)/2,f=(s.x+s.y)/2;if(n<=f)r=0;else if(n>=c)r=l.length,a=n/c>8;else{let e,t=f;for(let o=1;o<=l.length;o++){if(e=(l[o-1].x+l[o-1].y)/2,n<=e){n===e?r=o:"down"===i?(r=o-1,a=n/t>8):r="up"===i||n-t>e-n||n/t>2?o:o-1;break}t=e}}const u=0===r?s:l[r-1];return{pyramidLevel:r,pyramidResolution:new h({x:u.x,y:u.y,spatialReference:t.spatialReference}),excessiveReading:a}}const c=Math.log(e.x/s.x)/Math.LN2,f=Math.log(e.y/s.y)/Math.LN2,u=t.storageInfo.maximumPyramidLevel||0;r="down"===i?Math.floor(Math.min(c,f)):"up"===i?Math.ceil(Math.max(c,f)):Math.round((c+f)/2),r<0?r=0:r>u&&(a=r>u+3,r=u);const m=2**r;return{pyramidLevel:r,pyramidResolution:new h({x:m*t.nativePixelSize.x,y:m*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:a}}function K(e,t,n=512,o=!0){const{extent:s,spatialReference:r,pixelSize:a}=e,l=E(new h({x:a.x,y:a.y,spatialReference:r}),t,s);if(null==l)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const c=(l.x+l.y)/2,f=i(t),u=c*f*96*39.37,m=t.isGeographic?256/n*295828763.7958547:256/n*591657527.591555;let x="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const p=z(s,t);x||o&&(t.isGeographic||t.isWebMercator)&&(x=p.xmin*p.xmax<0);let g,y=u;const d=1.001;if(x){y=m;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,n=e*(96*f*39.37),i=t.isGeographic?4326:3857;g=E(new h({x:e,y:e,spatialReference:{wkid:i}}),r,p),g.x*=y/n,g.y*=y/n}else{g={x:a.x,y:a.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;y<.5005*m&&n<t;)n++,y*=2,g.x*=2,g.y*=2;Math.max(y,m)/Math.min(y,m)<=d&&(y=m)}const M=[y],w=[{x:g.x,y:g.y}],R=Math.min(70.5310735,u)/d;for(;y>=R;)y/=2,g.x/=2,g.y/=2,M.push(y),w.push({x:g.x,y:g.y});return{projectedPixelSize:l,scales:M,srcResolutions:w,isCustomTilingScheme:!x}}export{J as a,Y as b,z as c,F as d,B as e,E as f,O as g,K as h,b as i,S as l,k as p,y as r,X as s};
