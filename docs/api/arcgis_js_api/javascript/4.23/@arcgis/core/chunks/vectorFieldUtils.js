/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{b as e,u as n,i as r}from"../core/lang.js";import o from"../layers/support/PixelBlock.js";import{i as a}from"./pixelUtils.js";const s=new Map;s.set("meter-per-second",1),s.set("kilometer-per-hour",.277778),s.set("knots",.514444),s.set("feet-per-second",.3048),s.set("mile-per-hour",.44704);const i=180/Math.PI,h=new t({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function l(t,e){return s.get(t)/s.get(e)||1}function c(t){return(450-t)%360}function u(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let a=Math.atan2(r,n)*i;return a=(360+a)%360,"geographic"===e&&(a=c(a)),[o,a]}function f(t,e="geographic"){let n=t[1];"geographic"===e&&(n=c(n)),n%=360;const r=t[0];return[r*Math.cos(n/i),r*Math.sin(n/i)]}function p(t,r,o,s="geographic"){if(!a(t)||e(o))return t;const i="vector-magdir"===r?t.clone():n(m(t,r)),h=i.pixels[1];for(let t=0;t<h.length;t++)h[t]="geographic"===s?(h[t]+o[t]+270)%360:(h[t]+360-o[t])%360;return"vector-magdir"===r?i:m(i,"vector-magdir")}function m(t,e,n="geographic",r=1){if(!a(t))return t;const{pixels:s,width:i,height:h}=t,l=i*h,c=s[0],p=s[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=o.createEmptyBand(m,l),g=o.createEmptyBand(m,l);let M=0;for(let t=0;t<h;t++)for(let t=0;t<i;t++)"vector-uv"===e?([d[M],g[M]]=u([c[M],p[M]],n),d[M]*=r):([d[M],g[M]]=f([c[M],p[M]],n),d[M]*=r,g[M]*=r),M++;const x=new o({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,g]});return x.updateStatistics(),x}function d(t,e,n=1){if(1===n||!a(t))return t;const r=t.clone(),{pixels:o,width:s,height:i}=r,h=o[0],l=o[1];let c=0;for(let t=0;t<i;t++)for(let t=0;t<s;t++)"vector-uv"===e?(h[c]*=n,l[c]*=n):h[c]*=n,c++;return r.updateStatistics(),r}function g(t,e,n,o,a){if(!r(a)||!a.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/o),height:Math.round(n/o),resolution:t.width/e};const s=a.xmin,i=a.ymax,h=(t.xmax-t.xmin)/e*o,l=(t.ymax-t.ymin)/n*o,c=(h+l)/2;return t.xmin=s+Math.floor((t.xmin-s)/h)*h,t.xmax=s+Math.ceil((t.xmax-s)/h)*h,t.ymin=i+Math.floor((t.ymin-i)/l)*l,t.ymax=i+Math.ceil((t.ymax-i)/l)*l,{extent:t,width:Math.round(t.width/h),height:Math.round(t.height/l),resolution:c}}const M=function(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,a=13*o,s=-7*o,i=-2*o,h=-16*o,l=21.75,[c,u]=k(0,e+a,n,l),[f,p]=k(t-5.5,e+s,n,l),[m,d]=k(t+5.5,e+s,n,l),[g,M]=k(t-1.5,e+i,n,l),[x,w]=k(t+1.5,e+i,n,l),[y,P]=k(t-1.5,e+h,n,l),[b,I]=k(t+1.5,e+h,n,l);return[c,u,f,p,g,M,x,w,m,d,y,P,b,I]}(0,0,0);function x(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=n?-1:1,o=5*r,a=20*r,s=25*r,i=45,h=2*r;let[l,c]=[5,0-a],[u,f]=[l+2,c],[p,m]=[u-0,f+h],[d,g]=[-5,0-s],[M,x]=[d+0,g-h],w=Math.ceil(t/5),y=Math.floor(w/10);w-=8*y;const P=[],b=[];for(let t=0;t<w/2;t++,y--){y<=0&&w%2==1&&t===(w-1)/2&&(d=0,M=d+0,g=(g+c)/2,x=g-h);const[n,r]=k(d,g,e,i);if(y>0){const[t,o]=k(u,g,e,i),[a,s]=k(l,c,e,i);P.push(t),P.push(o),P.push(n),P.push(r),P.push(a),P.push(s)}else{const[t,o]=k(u,f,e,i),[a,s]=k(p,m,e,i),[h,l]=k(M,x,e,i);b.push(n),b.push(r),b.push(h),b.push(l),b.push(a),b.push(s),b.push(t),b.push(o)}g+=o,c+=o,f+=o,m+=o,x+=o}const[I,v]=k(5,0+a,e,i),[A,_]=k(7,0+a,e,i),[U,S]=k(5,0-s,e,i),[D,F]=k(7,0-s,e,i);return{pennants:P,barbs:b,shaft:[I,v,A,_,U,S,D,F]}}function k(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,a=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+a-n)%(2*Math.PI)]}const w=[0,1,3,6,10,16,21,27,33,40,47,55,63],y=[0,.5,1,1.5,2],P=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function b(t,e,n,r){const o=l(r||"knots",n);let a;for(a=1;a<e.length;a++)if(a===e.length-1){if(t<e[a]*o)break}else if(t<=e[a]*o)break;return Math.min(a-1,e.length-2)}function I(t,e,n,r,o){let a=0;switch(e){case"beaufort_kn":a=b(t,w,"knots",n);break;case"beaufort_km":a=b(t,w,"kilometer-per-hour",n);break;case"beaufort_ft":a=b(t,w,"feet-per-second",n);break;case"beaufort_m":a=b(t,w,"meter-per-second",n);break;case"classified_arrow":a=b(t,o,r,n);break;case"ocean_current_m":a=b(t,y,"meter-per-second",n);break;case"ocean_current_kn":a=b(t,P,"knots",n)}return a}const v=[];function A(t,e){let n=0,r=0;const{width:o,height:a,mask:s}=t,i=t.pixels[0],c=[],u=[],f=l(h.fromJSON(e.inputUnit),"knots"),p="wind_speed"===e.style?5:Number.MAX_VALUE;for(let t=0;t<a;t++)for(let e=0;e<o;e++){const h=i[t*o+e]*f;if((!s||s[t*o+e])&&h<p){for(let r=0;r<4;r++)c[n++]=(e+.5)/o,c[n++]=(t+.5)/a,c[n++]=r<2?-.5:.5,c[n++]=r%2==0?-.5:.5,c[n++]=0,c[n++]=h;const s=4*(n/24-1);u[r++]=s,u[r++]=s+1,u[r++]=s+2,u[r++]=s+1,u[r++]=s+2,u[r++]=s+3}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}function _(t,e){return"simple_scalar"===e.style?A(t,e):"wind_speed"===e.style?function(t,e){if(0===v.length)for(let t=0;t<30;t++)v.push(x(5*t,0));const n=l(h.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:a}=t,s=t.pixels[0],i=t.pixels[1],c=[],u=[];let f=0,p=0;for(let t=0;t<o;t++)for(let e=0;e<r;e++){const h=t*r+e,l=s[h]*n;if((!a||a[t*r+e])&&l>=5){var m;const n=null!=(m=(i[h]+360)%360/180*Math.PI)?m:2*Math.PI*Math.random(),{pennants:a,barbs:s,shaft:d}=v[Math.min(Math.floor(l/5),29)];if(a.length+s.length===0)continue;let g=c.length/6;const M=(e+.5)/r,x=(t+.5)/o;for(let t=0;t<a.length;t+=2)c[f++]=M,c[f++]=x,c[f++]=a[t],c[f++]=a[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<s.length;t+=2)c[f++]=M,c[f++]=x,c[f++]=s[t],c[f++]=s[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<d.length;t+=2)c[f++]=M,c[f++]=x,c[f++]=d[t],c[f++]=d[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<a.length/6;t++)u[p++]=g,u[p++]=g+1,u[p++]=g+2,g+=3;for(let t=0;t<s.length/8;t++)u[p++]=g,u[p++]=g+1,u[p++]=g+2,u[p++]=g+1,u[p++]=g+2,u[p++]=g+3,g+=4;u[p++]=g+0,u[p++]=g+1,u[p++]=g+2,u[p++]=g+1,u[p++]=g+3,u[p++]=g+2,g+=4}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}(t,e):function(t,e){const{style:n,inputUnit:r,outputUnit:o,breakValues:a}=e,s=h.fromJSON(r),i=h.fromJSON(o);let l=0,c=0;const{width:u,height:f,mask:p}=t,m=t.pixels[0],d=t.pixels[1],g=p?p.filter((t=>t>0)).length:u*f,x=new Float32Array(42*g),k=new Uint32Array(15*g);for(let t=0;t<f;t++)for(let e=0;e<u;e++){const r=t*u+e;if(!p||p[t*u+e]){var w;const o=null!=(w=(d[r]+360)%360/180*Math.PI)?w:2*Math.PI*Math.random(),h=I(m[r],n,s,i,a);for(let n=0;n<M.length;n+=2)x[l++]=(e+.5)/u,x[l++]=(t+.5)/f,x[l++]=M[n],x[l++]=M[n+1]+o,x[l++]=h,x[l++]=m[r];const p=7*(l/42-1);k[c++]=p,k[c++]=p+1,k[c++]=p+2,k[c++]=p+0,k[c++]=p+4,k[c++]=p+3,k[c++]=p+0,k[c++]=p+2,k[c++]=p+3,k[c++]=p+2,k[c++]=p+5,k[c++]=p+3,k[c++]=p+5,k[c++]=p+6,k[c++]=p+3}}return{vertexData:x,indexData:k}}(t,e)}function U(t,e,n,r=[0,0],a=.5){const{width:s,height:i,mask:h}=t,[l,c]=t.pixels,[p,m]=r,d=Math.round((s-p)/n),g=Math.round((i-m)/n),M=d*g,x=new Float32Array(M),k=new Float32Array(M),w=new Uint8Array(M),y="vector-uv"===e;for(let t=0;t<g;t++)for(let e=0;e<d;e++){let r=0;const o=t*d+e,g=Math.max(0,t*n+m),M=Math.max(0,e*n+p),P=Math.min(i,g+n),b=Math.min(s,M+n);for(let t=g;t<P;t++)for(let e=M;e<b;e++){const n=t*s+e;if(!h||h[n]){r++;const t=y?[l[n],c[n]]:[l[n],(360+c[n])%360],[e,a]=y?t:f(t);x[o]+=e,k[o]+=a}}if(r>=(P-g)*(b-M)*(1-a)){w[o]=1;const[t,e]=u([x[o]/r,k[o]/r]);x[o]=t,k[o]=e}else w[o]=0,x[o]=0,k[o]=0}const P=new o({width:d,height:g,pixels:[x,k],mask:w});return P.updateStatistics(),P}export{h as a,d as b,m as c,p as d,_ as e,A as f,l as g,U as h,g as s,u};
