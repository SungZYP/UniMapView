/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../geometry.js";import{i as t,b as e,u as a,clone as i}from"../core/lang.js";import{c as n,q as r}from"./mathUtils.js";import{f as o}from"./screenUtils.js";import{project as s}from"../geometry/projection.js";import{V as l}from"./ViewingMode.js";import{m as c}from"./drawUtils.js";import u from"../geometry/Point.js";import{_ as h}from"./tslib.es6.js";import p from"../core/Accessor.js";import{L as d}from"./Logger.js";import{createResolver as m}from"../core/promiseUtils.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as y}from"../core/accessorSupport/decorators/subclass.js";import{i as g}from"./DOMContainer.js";import{E as v}from"./interfaces.js";import _ from"../core/Collection.js";function E(a,i){return a.events.on("drag",function(a,i){let n=null,r=null;return o=>{if("cancel"===o.action)return void(t(r)&&(r.execute({action:"cancel"}),n=null,r=null));const s={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};"start"===o.action&&e(n)&&(n=new F,r=new F,i(a,n,r,o.pointerType,s)),t(n)&&n.execute(s),"end"===o.action&&t(n)&&(n=null,r=null)}}(a,i))}function b(t,e){const a=[t.x,t.y,t.z],i=e,n=[Math.cos(i),Math.sin(i)],r=Math.sqrt(n[0]*n[0]+n[1]*n[1]);if(0===r)return null;n[0]/=r,n[1]/=r;const o=t=>{const e=(t.x-a[0])*n[0]+(t.y-a[1])*n[1];t.x=a[0]+e*n[0],t.y=a[1]+e*n[1]};return t=>(o(t.mapStart),o(t.mapEnd),t)}function S(a,i){let n=null;return o=>{if("start"===o.action&&(n=function(a,i,n){const o=a.geometry;if(e(o))return null;if("mesh"===o.type)return function(a,i,n,o){if(t(i.transform))return function(a,i,n,o){const l=x(n.getOriginPoint(i.spatialReference),o),u=i.spatialReference;if(e(l))return null;return{move:(e,i,o)=>{const h=c(l.clone(),e,i,o);if(h.spatialReference.equals(u))n.origin=r(h.x,h.y,h.z);else{const e=s(h,u);t(e)&&(n.origin=r(e.x,e.y,e.z))}a.notifyMeshTransformChanged(),a.notifyGeometryChanged()}}}(a,i,i.transform,n);if(!i.spatialReference.equals(n))return null;let h=0,p=0,d=0;return{move:(t,e,n)=>{const r=t-h,s=e-p,c=n-d;if(r||s||c){const m=new u(i.origin.x+r,i.origin.y+s,i.origin.z+c,i.origin.spatialReference);i.centerAt(m,{geographic:o===l.Global}),a.notifyGeometryChanged(),h=t,p=e,d=n}}}}(a,o,i,n);const h=x(o,i),p=o.spatialReference;if(e(h))return null;return{move:(t,e,i)=>{const n=c(h.clone(),t,e,i);n.spatialReference.equals(p)?a.geometry=n:a.geometry=s(n,p)}}}(a,o.mapStart.spatialReference,i)),e(n))return null;const h=o.mapEnd.x-o.mapStart.x,p=o.mapEnd.y-o.mapStart.y,d=o.mapEnd.z-o.mapStart.z;return n.move(h,p,d),{...o,translationX:h,translationY:p,translationZ:d}}}function x(t,a){return e(t)?null:t.spatialReference.equals(a)?t.clone():s(t,a)}function w(a,i=null,n){let r=null;const o=t(i)&&!a.spatialReference.equals(i)?e=>t(e)?s(e,i):e:t=>t,l={exclude:[],...n};return i=>{if("start"===i.action&&(r=o(a.toMap(i.screenStart,l))),e(r))return null;const n=o(a.toMap(i.screenEnd,l));return t(n)?{...i,mapStart:r,mapEnd:n}:null}}function M(e,i){const n=e.map((t=>a(S(t,i)))).filter((e=>t(e)));return t=>{const e=t.mapEnd.x-t.mapStart.x,a=t.mapEnd.y-t.mapStart.y,i=t.mapEnd.z-t.mapStart.z;return n.forEach((e=>e(t))),{...t,translationX:e,translationY:a,translationZ:i}}}function A(t,e){const a=new Map;for(const n of e)a.set(n,i(t[n]));return e=>(a.forEach(((e,a)=>{t[a]=e})),e)}function R(e){return t(e.geometry)&&"mesh"===e.geometry.type?function(e,a){const i=t(a.transform)?a.transform.clone():null,n=a.vertexAttributes.clonePositional();return t=>(a.transform=i,a.vertexAttributes=n,e.notifyGeometryChanged(),t)}(e,e.geometry):A(e,["geometry"])}function T(e){const i=e.map((t=>a(R(t)))).filter((e=>t(e)));return t=>(i.forEach((e=>e(t))),t)}function j(){let t=0,e=0,a=0;return i=>{"start"===i.action&&(t=i.mapStart.x,e=i.mapStart.y,a=i.mapStart.z);const n=i.mapEnd.x-t,r=i.mapEnd.y-e,o=i.mapEnd.z-a;return t=i.mapEnd.x,e=i.mapEnd.y,a=i.mapEnd.z,{...i,mapDeltaX:n,mapDeltaY:r,mapDeltaZ:o,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function C(){let t=0,e=0;return a=>{"start"===a.action&&(t=a.screenStart.x,e=a.screenStart.y);const i=a.screenEnd.x-t,n=a.screenEnd.y-e;return t=a.screenEnd.x,e=a.screenEnd.y,{...a,screenDeltaX:i,screenDeltaY:n}}}function I(t,e){let a=null,i=0,r=0;return s=>{if("start"===s.action&&(a=t.toScreen(e),a.x<0||a.x>t.width||a.y<0||a.y>t.height?a=null:(i=s.screenStart.x-a.x,r=s.screenStart.y-a.y)),null==a)return null;const l=n(s.screenEnd.x-i,0,t.width),c=n(s.screenEnd.y-r,0,t.height),u=o(l,c);return s.screenStart=a,s.screenEnd=u,s}}class F{constructor(){this.execute=()=>{}}next(e,a=new F){return t(e)&&(this.execute=i=>{const n=e(i);t(n)&&a.execute(n)}),a}}var z;!function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"}(z||(z={}));class U{constructor(){this._isToolEditable=!0,this._manipulators=new _,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=z.WhenToolEditable){return this.addMany([t],e)[0]}addMany(t,e=z.WhenToolEditable){return t.map((t=>{const a=this._nextManipulatorId++,i={id:a,manipulator:t,visibilityPredicate:e,attached:!1};return this._manipulators.add(i),this._attached&&this._updateManipulatorAttachment(i),a}))}remove(t){if("number"==typeof t){const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(e,a){let i=null,n=Number.MAX_VALUE;return this._manipulators.forEach((({id:r,manipulator:o,attached:s})=>{if(!s||!o.interactive)return;const l=o.intersectionDistance(e,a);t(l)&&l<n&&(n=l,i={id:r,manipulator:o})})),i}findById(t){if(e(t))return null;for(const e of this._manipulators.items)if(t===e.id)return e.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===z.Always||(this._isToolEditable?t.visibilityPredicate===z.WhenToolEditable:t.visibilityPredicate===z.WhenToolNotEditable)}}const D=d.getLogger("esri.views.interactive.InteractiveToolBase");let V=class extends p{constructor(t){super(t),this.manipulators=new U,this.updating=!1,this.automaticManipulatorSelection=!0,this._editableFlags=new Map([[v.MANAGER,!0],[v.USER,!0]]),this._creationStartedResolver=m(),this._creationFinishedResolver=m()}set toolState(t){this._set("toolState",t),this._syncVisible()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(v.USER)}set editable(t){this.setEditableFlag(v.USER,t)}get created(){return"created"===this.toolState}get cursor(){return null}initialize(){this._syncVisible()}destroy(){this.manipulators.destroy(),this._set("view",null)}activate(){e(this.view)?D.error("Can't activate tool if view is not defined."):(g(this.view)&&this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===v.USER&&this.notifyChange("editable"),this.onEditableChange()}getEditableFlag(t){return this._editableFlags.get(t)}whenCreationStarted(){return this._creationStartedResolver.promise}whenCreated(){return this._creationFinishedResolver.promise}rejectCreation(t){"pending"!==this.toolState&&"creating"!==this.toolState||this._creationStartedResolver.resolve(this),this._creationFinishedResolver.reject(t)}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(v.USER)&&this.getEditableFlag(v.MANAGER)}startToolCreation(){if("pending"===this.toolState)return this._creationStartedResolver.resolve(this),void(this.toolState="creating");throw new Error(`Unexpected tool state ${this.toolState}`)}finishToolCreation(){switch(this.toolState){case"pending":this.startToolCreation();case"creating":this.created||this._creationFinishedResolver.resolve(this),this.toolState="created";break;case"created":break;default:throw new Error(`Unexpected tool state ${this.toolState}`)}}_syncVisible(){if("pending"!==this.toolState)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};h([f({value:"pending"})],V.prototype,"toolState",null),h([f({constructOnly:!0})],V.prototype,"view",void 0),h([f({readOnly:!0})],V.prototype,"active",null),h([f({value:!0})],V.prototype,"visible",null),h([f({value:!0})],V.prototype,"editable",null),h([f({readOnly:!0})],V.prototype,"created",null),h([f({readOnly:!0})],V.prototype,"manipulators",void 0),h([f({readOnly:!0})],V.prototype,"updating",void 0),h([f()],V.prototype,"cursor",null),h([f()],V.prototype,"automaticManipulatorSelection",void 0),V=h([y("esri.views.interactive.InteractiveToolBase")],V);export{F as E,V as I,U as M,R as a,I as b,E as c,S as d,b as e,C as f,j as g,M as h,T as i,A as r,w as s};
