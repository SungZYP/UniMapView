/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{i as t,o as r}from"../core/lang.js";import{c as s}from"./mat4.js";import{I as i,c as e}from"./mat4f64.js";import{g as a,b as n,f as o,v as h,e as d,l as c,j as l,Q as u,n as f,U as m}from"./mathUtils.js";import{c as y}from"./vec4f64.js";import{c as _,e as g,b as p}from"./ray.js";import{V as O}from"./ViewingMode.js";import{e as L}from"./boundedPlane.js";import{I as E,g as T}from"./verticalOffsetUtils.js";import{i as A}from"./utils2.js";var b,j;!function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"}(b||(b={}));class I{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=j.ALL}}function v(r){return t(r)&&t(r.dist)}function N(t){return(r,s,i)=>(a(w,r,s,i),!L(t,w))}function M(t){return v(t)&&t.intersector===b.OBJECT&&!!t.target}function R(r){return v(r)&&r.intersector===b.HUD&&!!r.target&&t(r.target.center)}!function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"}(j||(j={}));const w=n(),B=1e-5;class U{constructor(t){this.options=new I,this._results=new x,this.transform=new E,this.tolerance=1e-5,this.verticalOffset=null,this._ray=_(),this._rayEnd=n(),this._rayBeginTransformed=n(),this._rayEndTransformed=n(),this.viewingMode=null==t?O.Global:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(g(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&p(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===O.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,o(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(r=null,s,i,e,a){this.point=s,this.filterPredicate=e,this.tolerance=null==i?1e-5:i;const n=T(this.verticalOffset);if(t(r)&&r.length>0){const s=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of r){const r=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();t(r)?(t(n)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):i.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(r){const s=r.geometryRecords;if(!s)return;const e=r.transformation,a=T(this.verticalOffset);for(const n of s){const{geometry:s,material:o,instanceParameters:d}=n;if(A(d))continue;const c=s.id;this.transform.setAndInvalidateLazyTransforms(e,n.getShaderTransformation()),h(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),h(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;t(a)&&(a.objectTransform=this.transform),o.intersect(s,d,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((s,e,a,n,o,h)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,s))return;if(n){if(null==this._results.hud.dist||s<this._results.hud.dist){const t={object:r,geometryId:c,triangleNr:a,center:h};this._results.hud.set(b.HUD,t,s,e,i,o)}return}const d=t=>t.set(b.OBJECT,{object:r,geometryId:c,triangleNr:a},s,e,l,o);if((null==this._results.min.drapedLayerOrder||o>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||s<this._results.min.dist)&&d(this._results.min),this.options.store!==j.MIN&&(null==this._results.max.drapedLayerOrder||o<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||s>this._results.max.dist)&&d(this._results.max),this.options.store===j.ALL){const t=D(this._ray);t.set(b.OBJECT,{object:r,geometryId:c,triangleNr:a},s,e,l),this._results.all.push(t)}}}),n.shaderTransformation)}}sortResults(){this._results.all.sort(((t,s)=>t.dist!==s.dist?r(t.dist,0)-r(s.dist,0):t.drapedLayerOrder!==s.drapedLayerOrder?r(t.drapedLayerOrder,Number.MAX_VALUE)-r(s.drapedLayerOrder,Number.MAX_VALUE):r(s.drapedLayerGraphicOrder,Number.MIN_VALUE)-r(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function V(t){return new U(t)}class x{constructor(){this._min=new C(_()),this._max=new C(_()),this._hud=new C(_()),this._ground=new C(_())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(t){this._min.init(t),this._max.init(t),this._hud.init(t),this._ground.init(t),this.all=[]}}class C{constructor(t){this.intersector=b.OBJECT,this.normal=n(),this.transformation=e(),this._ray=_(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return t(this.dist)?(d(P,this.ray.direction,this.dist),c(P)):null}getIntersectionPoint(t){return!!v(this)&&(d(P,this.ray.direction,this.dist),o(t,this.ray.origin,P),!0)}getTransformedNormal(t){return l(G,this.normal),G[3]=0,u(G,G,this.transformation),l(t,G),f(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=b.OBJECT,p(t,this._ray)}set(t,e,a,n,o,h,d){this.intersector=t,this.dist=a,l(this.normal,r(n,m)),s(this.transformation,r(o,i)),this.target=e,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=d}copy(t){p(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,l(this.normal,t.normal),s(this.transformation,t.transformation)}}function D(t){return new C(t)}const P=n(),G=y();export{B as D,b as I,j as S,V as a,M as b,R as c,v as i,D as n,N as s};
