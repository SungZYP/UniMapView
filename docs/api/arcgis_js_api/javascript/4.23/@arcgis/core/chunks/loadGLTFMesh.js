/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{o as r}from"./ensureType.js";import{u as o,m as s,i,b as n}from"../core/lang.js";import{a}from"./mat3.js";import{b as m}from"./quatf64.js";import{q as p}from"./mathUtils.js";import{f as c}from"./vec4f64.js";import l,{M as u}from"../geometry/support/MeshComponent.js";import f from"../geometry/support/MeshMaterialMetallicRoughness.js";import j from"../geometry/support/MeshTexture.js";import{e as g,B as d,a as y,b as x,c as h,s as b,u as v,v as w}from"./BufferView.js";import{t as M,a as A,f as C,s as E,c as T,b as S}from"./vec3.js";import{D as R,l as U,c as B,C as P,t as $,f as G,n as I,g as L,s as N,a as O,h as D,b as F,d as _,e as q}from"./DefaultMaterial_COLOR_GAMMA.js";import{a as k}from"./georeference.js";import{d as z}from"./geometryDataUtils.js";import{P as V,f as J}from"./enums.js";import"./colorUtils.js";import"./common.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./tracking.js";import"./ArrayPool.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"./screenshotUtils.js";import"./vec2.js";import"./types.js";import"./asyncUtils.js";import"./mat4f64.js";import"./compilerUtils.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"../geometry/SpatialReference.js";import"./Ellipsoid.js";import"../geometry/projection.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./axisAngleDegrees.js";import"./projection.js";import"./triangle.js";import"./vectorStacks.js";import"./byteSizeEstimations.js";import"./vec2f64.js";import"./lineSegment.js";async function K(n,a,m){const l=new R(function(t){if(null==t||!t.resolveFile)return null;return{busy:!1,request:async(r,o,s)=>{const n=t.resolveFile(r),a="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(n,{responseType:a,signal:i(s)?s.signal:null})).data}}}(m)),b=(await U(l,a,m,!0)).model,v=b.lods.shift(),w=new Map,M=new Map;b.textures.forEach(((t,e)=>{return w.set(e,new j({data:(r=t).data,wrap:Y(r.parameters.wrap)}));var r})),b.materials.forEach(((e,r)=>M.set(r,function(e,r){const i=new t((a=e.color,m=e.opacity,c(tt(a[0]),tt(a[1]),tt(a[2]),m))),n=e.emissiveFactor?new t(function(t){return p(tt(t[0]),tt(t[1]),tt(t[2]))}(e.emissiveFactor)):null;var a,m;return new f({color:i,colorTexture:o(s(e.textureColor,(t=>r.get(t)))),normalTexture:o(s(e.textureNormal,(t=>r.get(t)))),emissiveColor:n,emissiveTexture:o(s(e.textureEmissive,(t=>r.get(t)))),occlusionTexture:o(s(e.textureOcclusion,(t=>r.get(t)))),alphaMode:X(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:o(s(e.textureMetallicRoughness,(t=>r.get(t))))})}(e,w))));const A=function(t){let e=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,i=new Map,n=[];for(const a of t.parts){const{attributes:{position:t,normal:m,color:p,tangent:c,texCoord0:l}}=a,u=`\n      ${Q(t,s)}/\n      ${Q(m,s)}/\n      ${Q(p,s)}/\n      ${Q(c,s)}/\n      ${Q(l,s)}/\n      ${H(a.transform)}\n    `;let f=!1;const j=r(i,u,(()=>(f=!0,{start:e,length:t.count})));f&&(e+=t.count),m&&(o.normal=!0),p&&(o.color=!0),c&&(o.tangent=!0),l&&(o.texCoord0=!0),n.push({gltf:a,writeVertices:f,region:j})}return{vertexAttributes:{position:B(g,e),normal:o.normal?B(d,e):null,tangent:o.tangent?B(y,e):null,color:o.color?B(x,e):null,texCoord0:o.texCoord0?B(h,e):null},parts:n,components:[]}}(v);for(const t of A.parts)W(A,t,M);const{position:C,normal:E,tangent:T,color:S,texCoord0:P}=A.vertexAttributes,$={position:C.typedBuffer,normal:i(E)?E.typedBuffer:null,tangent:i(T)?T.typedBuffer:null,uv:i(P)?P.typedBuffer:null,color:i(S)?S.typedBuffer:null},G=k($,n,m);return{transform:G.transform,components:A.components,spatialReference:n.spatialReference,vertexAttributes:new u({position:G.vertexAttributes.position,normal:G.vertexAttributes.normal,tangent:G.vertexAttributes.tangent,color:$.color,uv:$.uv})}}function Q(t,e){if(n(t))return"-";const o=t.typedBuffer;return`${r(e,o.buffer,(()=>e.size))}/${o.byteOffset}/${o.byteLength}`}function H(t){return i(t)?t.toString():"-"}function W(t,e,r){e.writeVertices&&function(t,e){const{position:r,normal:o,tangent:s,color:n,texCoord0:p}=t.vertexAttributes,c=e.region.start,{attributes:l,transform:u}=e.gltf,f=l.position.count;if(M(r.slice(c,f),l.position,u),i(l.normal)&&i(o)){const t=a(m(),u);A(o.slice(c,f),l.normal,t)}else i(o)&&C(o,0,0,1,{dstIndex:c,count:f});if(i(l.tangent)&&i(s)){const t=a(m(),u);$(s.slice(c,f),l.tangent,t)}else i(s)&&G(s,0,0,1,1,{dstIndex:c,count:f});i(l.texCoord0)&&i(p)?I(p.slice(c,f),l.texCoord0):i(p)&&L(p,0,0,{dstIndex:c,count:f});if(i(l.color)&&i(n)){const t=l.color,e=n.slice(c,f);if(4===t.elementCount)t instanceof y?N(e,t,255):t instanceof x?O(e,t):t instanceof b&&D(e,t,8);else{G(e,255,255,255,255);const r=v.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof d?E(r,t,255):t instanceof v?T(r,t):t instanceof w&&S(r,t,8)}}else i(n)&&G(n.slice(c,f),255,255,255,255)}(t,e);const o=e.gltf,s=function(t,e){switch(e){case V.TRIANGLES:return q(t,z);case V.TRIANGLE_STRIP:return _(t);case V.TRIANGLE_FAN:return F(t)}}(o.indices||o.attributes.position.count,o.primitiveType),n=e.region.start;if(n)for(let t=0;t<s.length;t++)s[t]+=n;t.components.push(new l({faces:s,material:r.get(o.material),trustSourceNormals:!0}))}function X(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Y(t){return{horizontal:Z(t.s),vertical:Z(t.t)}}function Z(t){switch(t){case J.CLAMP_TO_EDGE:return"clamp";case J.MIRRORED_REPEAT:return"mirror";case J.REPEAT:return"repeat"}}function tt(t){return t**(1/P)*255}export{K as loadGLTFMesh};
