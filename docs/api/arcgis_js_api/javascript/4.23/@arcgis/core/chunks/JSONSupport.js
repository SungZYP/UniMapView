/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import r,{a as t,n as i,i as s}from"../core/Accessor.js";import{clone as n,e as o,a}from"../core/lang.js";import{v as l,e as u}from"./get.js";import{g as c,m as f}from"./utils.js";import{o as g,a as d,b as p,subclass as m}from"../core/accessorSupport/decorators/subclass.js";import O from"../core/Error.js";import{L as h}from"./Logger.js";class v{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new v;return this._values.forEach(((t,i)=>{e&&e.has(i)||r.set(i,n(t.value),t.origin)})),r}get(e,r){r=this._normalizeOrigin(r);const t=this._values.get(e);return null==r||(null==t?void 0:t.origin)===r?null==t?void 0:t.value:void 0}originOf(e){var r,i;return null!=(r=null==(i=this._values.get(e))?void 0:i.origin)?r:t.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return null==e?r:r.filter((r=>{var t;return(null==(t=this._values.get(r))?void 0:t.origin)===e}))}set(e,r,i){if((i=this._normalizeOrigin(i))===t.DEFAULTS){const r=this._values.get(e);if(r&&null!=r.origin&&r.origin>i)return}this._values.set(e,new w(r,i))}delete(e,r){var t;null!=(r=this._normalizeOrigin(r))&&(null==(t=this._values.get(e))?void 0:t.origin)!==r||this._values.delete(e)}has(e,r){var t;return null!=(r=this._normalizeOrigin(r))?(null==(t=this._values.get(e))?void 0:t.origin)===r:this._values.has(e)}forEach(e){this._values.forEach((({value:r},t)=>e(r,t)))}_normalizeOrigin(e){if(null!=e)return e===t.DEFAULTS?e:t.USER}}class w{constructor(e,r){this.value=e,this.origin=r}}function y(e,r,i){r.keys().forEach((e=>{i.set(e,r.get(e),t.DEFAULTS)}));const s=e.metadatas;Object.keys(s).forEach((r=>{e.internalGet(r)&&i.set(r,e.internalGet(r),t.DEFAULTS)}))}function S(e,r,t){if(!e||!e.read||!1===e.read.enabled||!e.read.source)return!1;const i=e.read.source;if("string"==typeof i){if(i===r)return!0;if(i.indexOf(".")>-1&&0===i.indexOf(r)&&u(i,t))return!0}else for(const e of i){if(e===r)return!0;if(e.indexOf(".")>-1&&0===e.indexOf(r)&&u(e,t))return!0}return!1}function N(e,r,t,i,s){let n=g(r[t],s);(function(e){return e&&(!e.read||!1!==e.read.enabled&&!e.read.source)})(n)&&(e[t]=!0);for(const o of Object.getOwnPropertyNames(r))n=g(r[o],s),S(n,t,i)&&(e[o]=!0)}function _(e,r,t,i){const s=t.metadatas,n=d(s[r],"any",i),o=n&&n.default;if(void 0===o)return;const a="function"==typeof o?o.call(e,r,i):o;void 0!==a&&t.set(r,a)}const E={origin:"service"};function b(e,r,t=E){if(!r||"object"!=typeof r)return;const i=c(e),s=i.metadatas,n={};for(const e of Object.getOwnPropertyNames(r))N(n,s,e,r,t);i.setDefaultOrigin(t.origin);for(const o of Object.getOwnPropertyNames(n)){const n=g(s[o],t).read,a=n&&n.source;let u;u=a&&"string"==typeof a?l(r,a):r[o],n&&n.reader&&(u=n.reader.call(e,u,r,t)),void 0!==u&&i.set(o,u)}if(!t||!t.ignoreDefaults){i.setDefaultOrigin("defaults");for(const r of Object.getOwnPropertyNames(s))n[r]||_(e,r,i,t)}i.setDefaultOrigin("user")}function j(e,r,t,i=E){var s;const n={...i,messages:[]};t(n),null==(s=n.messages)||s.forEach((r=>{"warning"!==r.type||e.loaded?i&&i.messages&&i.messages.push(r):e.loadWarnings.push(r)}))}const J=h.getLogger("esri.core.accessorSupport.write");function D(e,r,t,i,s){var n,o;const a={};return null==(n=r.write)||null==(o=n.writer)||o.call(e,i,a,t,s),a}function P(e,r,s,n,a,l){if(!n||!n.write)return!1;const u=e.get(s);if(!a&&n.write.overridePolicy){const r=n.write.overridePolicy.call(e,u,s,l);void 0!==r&&(a=r)}if(a||(a=n.write),!a||!1===a.enabled)return!1;if((null===u&&!a.allowNull&&!a.writerEnsuresNonNull||void 0===u)&&a.isRequired){const r=new O("web-document-write:property-required",`Missing value for required property '${s}' on '${e.declaredClass}'`,{propertyName:s,target:e});return r&&l&&l.messages?l.messages.push(r):r&&!l&&J.error(r.name,r.message),!1}if(void 0===u)return!1;if(null===u&&!a.allowNull&&!a.writerEnsuresNonNull)return!1;if((!r.store.multipleOriginsSupported||r.store.originOf(s)===t.DEFAULTS)&&function(e,r,t,i,s){const n=i.default;if(void 0===n)return!1;if(null!=i.defaultEquals)return i.defaultEquals(s);if("function"==typeof n){if(Array.isArray(s)){const i=n.call(e,r,t);return o(i,s)}return!1}return n===s}(e,s,l,n,u))return!1;if(!a.ignoreOrigin&&l&&l.origin&&r.store.multipleOriginsSupported){if(r.store.originOf(s)<i(l.origin))return!1}return!0}function A(e,r,t,i){const s=c(e),n=s.metadatas,o=p(n[r],i);return!!o&&P(e,s,r,o,t,i)}function L(e,r,t){if(e&&"function"==typeof e.toJSON&&(!e.toJSON.isDefaultToJSON||!e.write))return f(r,e.toJSON());const i=c(e),n=i.metadatas;for(const l in n){const u=p(n[l],t);if(!P(e,i,l,u,void 0,t))continue;const c=e.get(l),g=D(e,u,u.write&&"string"==typeof u.write.target?u.write.target:l,c,t);var o,a;if(Object.keys(g).length>0)r=f(r,g),null!=t&&null!=(o=t.resources)&&null!=(a=o.pendingOperations)&&a.length&&Promise.all(t.resources.pendingOperations).then((()=>f(r,g))),t&&t.writtenProperties&&t.writtenProperties.push({target:e,propName:l,oldOrigin:s(i.store.originOf(l)),newOrigin:t.origin})}return r}const x=r=>{let t=class extends r{constructor(...e){super(...e);const r=a(c(this)),t=r.store,i=new v;r.store=i,y(r,t,i)}read(e,r){b(this,e,r)}write(e={},r){return L(this,e,r)}toJSON(e){return this.write({},e)}static fromJSON(e,r){return T.call(this,e,r)}};return t=e([m("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function T(e,r){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(e,r),t}let U=class extends(x(r)){};U=e([m("esri.core.JSONSupport")],U);export{x as J,U as a,A as b,j as c,b as r,y as s,L as w};
