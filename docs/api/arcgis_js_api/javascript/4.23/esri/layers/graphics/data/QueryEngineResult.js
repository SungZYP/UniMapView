// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/centroid ../../../geometry/support/extentUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils ../../support/fieldUtils ../../../statistics/utils ../../../support/arcadeOnDemand".split(" "),function(Y,G,B,K,T,Q,U,O,Z,P,aa,R,ba,F,V,z,ca){function da(t,
n,b,a,c,d){c-=b;d-=a;t=Math.min(1,Math.max(0,((t-b)*c+(n-a)*d)/(c*c+d*d)));return{x:b+c*t,y:a+d*t}}function ea(t,n){return t?n?4:3:n?3:2}let ia=function(){function t(b,a,c){this.items=b;this.queryGeometry=a;this.definitionExpression=c.definitionExpression;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.fieldsIndex=c.fieldsIndex;this.timeInfo=c.timeInfo;this.featureAdapter=c.featureAdapter;this.aggregateAdapter=
c.aggregateAdapter}var n=t.prototype;n.createQueryResponseForCount=function(b){const a=new P(b,this.featureAdapter,this.fieldsIndex);if(!b.outStatistics)return a.countDistinctValues(this.items);const {groupByFieldsForStatistics:c,having:d}=b;if(null==c||!c.length)return 1;const e=new Map,f=new Map,h=new Set;b=b.outStatistics;for(const k of b){({statisticType:b}=k);b="exceedslimit"!==b?k.onStatisticField:void 0;if(!f.has(b)){var g=[];for(const l of c){const m=this._getAttributeValues(a,l,e);g.push(m)}f.set(b,
this._calculateUniqueValues(g,a.returnDistinctValues))}b=f.get(b);for(const l in b){const {data:m,items:p}=b[l];g=m.join(",");d&&!a.validateItems(p,d)||h.add(g)}}return h.size};n.createQueryResponse=function(){var b=B._asyncToGenerator(function*(a){let c;c=a.outStatistics?a.outStatistics.some(d=>"exceedslimit"===d.statisticType)?this._createExceedsLimitQueryResponse(a):yield this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(O.isValid(a.outSR)&&!O.equals(this.queryGeometry.spatialReference,
a.outSR)?c.queryGeometry=F.cleanFromGeometryEngine({spatialReference:a.outSR,...R.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR)}):c.queryGeometry=F.cleanFromGeometryEngine({spatialReference:a.outSR,...this.queryGeometry}));return c});return function(a){return b.apply(this,arguments)}}();n.createSnappingResponse=function(b,a){const c=this.featureAdapter,d=ea(this.hasZ,this.hasM),{x:e,y:f}=b.point,h="number"===typeof b.distance?b.distance:b.distance.x,g="number"===typeof b.distance?
b.distance:b.distance.y,k={candidates:[]},l="esriGeometryPolygon"===this.geometryType;a=this._getPointCreator(b.point,this.spatialReference,a);for(const w of this.items){var m=c.getGeometry(w);if(K.isNone(m))continue;const {coords:v,lengths:x}=m;if(b.types&G.SnappingTypes.EDGE){m=0;for(var p=0;p<x.length;p++){var u=x[p];for(var q=0;q<u;q++,m+=d){var y=v[m],A=v[m+1];if(q!==u-1){const D=v[m+d],C=v[m+d+1],{x:E,y:L}=da(e,f,y,A,D,C);var r=(e-E)/h;const M=(f-L)/g;r=r*r+M*M;1>=r&&k.candidates.push({type:"edge",
objectId:c.getObjectId(w),distance:Math.sqrt(r),target:a(E,L),start:a(y,A),end:a(D,C)})}}}}if(b.types&G.SnappingTypes.VERTEX)for(m=l?v.length-d:v.length,p=0;p<m;p+=d)u=v[p],q=v[p+1],y=(e-u)/h,A=(f-q)/g,y=y*y+A*A,1>=y&&k.candidates.push({type:"vertex",objectId:c.getObjectId(w),distance:Math.sqrt(y),target:a(u,q)})}k.candidates.sort((w,v)=>w.distance-v.distance);return k};n._getPointCreator=function(b,a,c){const d=K.isSome(c)&&!O.equals(a,c)?e=>R.project(e,a,c):e=>e;return null!=b.z&&null!=b.m?(e,f)=>
d({x:e,y:f,z:b.z,m:b.m}):null!=b.z?(e,f)=>d({x:e,y:f,z:b.z}):null!=b.m?(e,f)=>d({x:e,y:f,m:b.m}):(e,f)=>d({x:e,y:f})};n.executeAttributesQuery=function(b){var a=aa.getWhereClause(b.where,this.fieldsIndex);if(!a)return Promise.resolve(this);if(a.isStandardized){let c=0;const d=[];for(const e of this.items)a.testFeature(e,this.featureAdapter)&&(d[c++]=e);a=new t(d,this.queryGeometry,this);a.definitionExpression=b.where;return Promise.resolve(a)}return Promise.reject(new TypeError("Where clause is not standardized"))};
n.executeAggregateIdsQuery=function(b){if(!b.aggregateIds||!b.aggregateIds.length||K.isNone(this.aggregateAdapter))return Promise.resolve(this);const a=new Set;for(const d of b.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>a.add(e));const c=this.featureAdapter.getObjectId;return Promise.resolve(new t(this.items.filter(d=>a.has(c(d))),this.queryGeometry,this))};n.executeObjectIdsQuery=function(b){if(!b.objectIds||!b.objectIds.length)return Promise.resolve(this);const a=new Set(b.objectIds),
c=this.featureAdapter.getObjectId;return Promise.resolve(new t(this.items.filter(d=>a.has(c(d))),this.queryGeometry,this))};n.executeTimeQuery=function(b){b=ba.getTimeOperator(this.timeInfo,b.timeExtent,this.featureAdapter);if(!K.isSome(b))return Promise.resolve(this);b=this.items.filter(b);return Promise.resolve(new t(b,this.queryGeometry,this))};n.filterLatest=function(){const {trackIdField:b,startTimeField:a,endTimeField:c}=this.timeInfo;var d=c||a;const e=new Map,f=this.featureAdapter.getAttribute;
for(const h of this.items){const g=f(h,b),k=f(h,d),l=e.get(g);(!l||k>f(l,d))&&e.set(g,h)}d=Array.from(e.values());return Promise.resolve(new t(d,this.queryGeometry,this))};n.project=function(){var b=B._asyncToGenerator(function*(a){if(!a||O.equals(this.spatialReference,a))return this;const c=this.featureAdapter,d=(yield R.projectMany(this.items.map(e=>F.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(e))),this.spatialReference,a)).map((e,f)=>c.cloneWithGeometry(this.items[f],Z.convertFromGeometry(e,
this.hasZ,this.hasM)));return new t(d,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})});return function(a){return b.apply(this,arguments)}}();n.createSummaryStatisticsResponse=function(){var b=B._asyncToGenerator(function*(a,c){const {field:d,valueExpression:e,normalizationField:f,
normalizationType:h,normalizationTotal:g,minValue:k,maxValue:l,scale:m}=c;c=this.fieldsIndex.isDateField(d);a=yield this._getDataValues(a,{field:d,valueExpression:e,normalizationField:f,normalizationType:h,normalizationTotal:g,scale:m});const p=z.isNullCountSupported({normalizationType:h,normalizationField:f,minValue:k,maxValue:l}),u=this.fieldsIndex.get(d),q={value:.5,fieldType:null==u?void 0:u.type};a=V.isStringField(u)?z.calculateStringStatistics({values:a,supportsNullCount:p,percentileParams:q}):
z.calculateStatistics({values:a,minValue:k,maxValue:l,useSampleStdDev:!h,supportsNullCount:p,percentileParams:q});return z.processSummaryStatisticsResult(a,c)});return function(a,c){return b.apply(this,arguments)}}();n.createUniqueValuesResponse=function(){var b=B._asyncToGenerator(function*(a,c){const {field:d,valueExpression:e,domain:f,returnAllCodedValues:h,scale:g}=c;a=yield this._getDataValues(a,{field:d,valueExpression:e,scale:g});a=z.calculateUniqueValuesCount(a);return z.createUVResult(a,
f,h)});return function(a,c){return b.apply(this,arguments)}}();n.createClassBreaksResponse=function(){var b=B._asyncToGenerator(function*(a,c){const {field:d,valueExpression:e,normalizationField:f,normalizationType:h,normalizationTotal:g,classificationMethod:k,standardDeviationInterval:l,minValue:m,maxValue:p,numClasses:u,scale:q}=c;a=yield this._getDataValues(a,{field:d,valueExpression:e,normalizationField:f,normalizationType:h,normalizationTotal:g,scale:q});a=z.calculateClassBreaks(a,{field:d,normalizationField:f,
normalizationType:h,normalizationTotal:g,classificationMethod:k,standardDeviationInterval:l,minValue:m,maxValue:p,numClasses:u});return z.resolveCBResult(a,k)});return function(a,c){return b.apply(this,arguments)}}();n.createHistogramResponse=function(){var b=B._asyncToGenerator(function*(a,c){const {field:d,valueExpression:e,normalizationField:f,normalizationType:h,normalizationTotal:g,classificationMethod:k,standardDeviationInterval:l,minValue:m,maxValue:p,numBins:u,scale:q}=c;a=yield this._getDataValues(a,
{field:d,valueExpression:e,normalizationField:f,normalizationType:h,normalizationTotal:g,scale:q});return z.calculateHistogram(a,{field:d,normalizationField:f,normalizationType:h,normalizationTotal:g,classificationMethod:k,standardDeviationInterval:l,minValue:m,maxValue:p,numBins:u})});return function(a,c){return b.apply(this,arguments)}}();n._sortFeatures=function(b,a,c){if(1<b.length&&a&&a.length)for(const d of a.reverse()){a=d.split(" ");const e=a[0],f=this.fieldsIndex.get(e);a=a[1]&&"desc"===
a[1].toLowerCase();const h=z.getAttributeComparator(null==f?void 0:f.type,a);b.sort((g,k)=>{g=c(g,e,f);k=c(k,e,f);return h(g,k)})}};n._createFeatureQueryResponse=function(b){const a=this.items,{geometryType:c,hasM:d,hasZ:e,objectIdField:f,spatialReference:h}=this,{outFields:g,outSR:k,quantizationParameters:l,resultRecordCount:m,resultOffset:p,returnZ:u,returnM:q}=b,y=null!=m?a.length>(p||0)+m:!1,A=g&&(g.includes("*")?[...this.fieldsIndex.fields]:g.map(r=>this.fieldsIndex.get(r)));return{exceededTransferLimit:y,
features:this._createFeatures(b,a),fields:A,geometryType:c,hasM:d&&q,hasZ:e&&u,objectIdFieldName:f,spatialReference:F.cleanFromGeometryEngine(k?k:h),transform:l&&U.toQuantizationTransform(l)||null}};n._createFeatures=function(b,a){const c=new P(b,this.featureAdapter,this.fieldsIndex),{hasM:d,hasZ:e}=this,{orderByFields:f,quantizationParameters:h,returnGeometry:g,returnCentroid:k,maxAllowableOffset:l,resultOffset:m,resultRecordCount:p,returnZ:u=!1,returnM:q=!1}=b,y=e&&u,A=d&&q;b=[];var r=0;a=[...a];
this._sortFeatures(a,f,(x,D,C)=>c.getFieldValue(x,D,C));if(g||k){var w=U.toQuantizationTransform(h);if(g&&!k)for(var v of a)b[r++]={attributes:c.getAttributes(v),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(v),l,w,y,A)};else if(!g&&k)for(const x of a)b[r++]={attributes:c.getAttributes(x),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(x,this),w)};else for(const x of a)b[r++]={attributes:c.getAttributes(x),centroid:F.transformCentroid(this,
this.featureAdapter.getCentroid(x,this),w),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(x),l,w,y,A)}}else for(w of a)(v=c.getAttributes(w))&&(b[r++]={attributes:v});r=m||0;null!=p&&(b=b.slice(r,Math.min(b.length,r+p)));return b};n._createExceedsLimitQueryResponse=function(b){var a=!1;let c=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY;a=Number.POSITIVE_INFINITY;for(const e of b.outStatistics)if("exceedslimit"===e.statisticType){c=null!=e.maxPointCount?
e.maxPointCount:Number.POSITIVE_INFINITY;d=null!=e.maxRecordCount?e.maxRecordCount:Number.POSITIVE_INFINITY;a=null!=e.maxVertexCount?e.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)a=this.items.length>c;else if(this.items.length>d)a=!0;else{b=this.hasZ?this.hasM?4:3:this.hasM?3:2;const e=this.featureAdapter;a=this.items.reduce((f,h)=>{h=e.getGeometry(h);return f+(K.isSome(h)&&h.coords.length||0)},0)/b>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",
alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(a)}}]}};n._createStatisticsQueryResponse=function(){var b=B._asyncToGenerator(function*(a){var c={attributes:{}};const d=[],e=new Map,f=new Map,h=new Map,g=new Map,k=new P(a,this.featureAdapter,this.fieldsIndex);var l=a.outStatistics;const {groupByFieldsForStatistics:m,having:p,orderByFields:u}=a;a=m&&m.length;const q=!!a,y=q&&m[0],A=q&&!this.fieldsIndex.get(y);for(const D of l){const {outStatisticFieldName:C,
statisticType:E}=D;l=D;var r="exceedslimit"!==E?D.onStatisticField:void 0;const L="percentile_disc"===E||"percentile_cont"===E,M="EnvelopeAggregate"===E||"CentroidAggregate"===E||"ConvexHullAggregate"===E,fa=q&&1===a&&(r===y||A)&&"count"===E;if(q){if(!h.has(r)){var w=[];for(const N of m){var v=this._getAttributeValues(k,N,e);w.push(v)}h.set(r,this._calculateUniqueValues(w,k.returnDistinctValues))}w=h.get(r);for(const N in w){const {count:S,data:W,items:X,itemPositions:ha}=w[N];v=W.join(",");if(!p||
k.validateItems(X,p)){const H=g.get(v)||{attributes:{}};if(M){H.aggregateGeometries||(H.aggregateGeometries={});const {aggregateGeometries:I,outStatisticFieldName:J}=yield this._getAggregateGeometry(l,X);H.aggregateGeometries[J]=I}else{var x=null;if(fa)x=S;else{const I=this._getAttributeValues(k,r,e);x=ha.map(J=>I[J]);x=L&&"statisticParameters"in l?this._getPercentileValue(l,x):this._getStatisticValue(l,x,null,k.returnDistinctValues)}H.attributes[C]=x}m.forEach((I,J)=>H.attributes[this.fieldsIndex.get(I)?
I:`EXPR_${J+1}`]=W[J]);g.set(v,H)}}}else if(M){c.aggregateGeometries||(c.aggregateGeometries={});const {aggregateGeometries:N,outStatisticFieldName:S}=yield this._getAggregateGeometry(l,this.items);c.aggregateGeometries[S]=N}else r=this._getAttributeValues(k,r,e),c.attributes[C]=L&&"statisticParameters"in l?this._getPercentileValue(l,r):this._getStatisticValue(l,r,f,k.returnDistinctValues);d.push({name:C,alias:C,type:"esriFieldTypeDouble"})}c=q?Array.from(g.values()):[c];this._sortFeatures(c,u,(D,
C)=>D.attributes[C]);return{fields:d,features:c}});return function(a){return b.apply(this,arguments)}}();n._getAggregateGeometry=function(){var b=B._asyncToGenerator(function*(a,c){var d=yield new Promise((u,q)=>Y(["../../../geometry/geometryEngineJSON"],u,q));const {statisticType:e,outStatisticFieldName:f}=a,{featureAdapter:h,spatialReference:g,geometryType:k,hasZ:l,hasM:m}=this;c=c.map(u=>F.getGeometry(k,l,m,h.getGeometry(u)));const p=d.convexHull(g,c,!0)[0];a={aggregateGeometries:null,outStatisticFieldName:null};
"EnvelopeAggregate"===e?(d=p?Q.getPolygonExtent(p):Q.getGeometryExtent(d.union(g,c)),a.aggregateGeometries={...d,spatialReference:g},a.outStatisticFieldName=f||"extent"):"CentroidAggregate"===e?(d=p?T.polygonCentroid(p):T.extentCentroid(Q.getGeometryExtent(d.union(g,c))),a.aggregateGeometries={x:d[0],y:d[1],spatialReference:g},a.outStatisticFieldName=f||"centroid"):"ConvexHullAggregate"===e&&(a.aggregateGeometries=p,a.outStatisticFieldName=f||"convexHull");return a});return function(a,c){return b.apply(this,
arguments)}}();n._getStatisticValue=function(b,a,c,d){const {onStatisticField:e,statisticType:f}=b;b=null;b=null!=c&&c.has(e)?c.get(e):V.isStringField(this.fieldsIndex.get(e))?z.calculateStringStatistics({values:a,returnDistinct:d}):z.calculateStatistics({values:a,minValue:null,maxValue:null,useSampleStdDev:!0});c&&c.set(e,b);return b["var"===f?"variance":f]};n._getPercentileValue=function(b,a){const {onStatisticField:c,statisticParameters:d,statisticType:e}=b,{value:f,orderBy:h}=d;b=this.fieldsIndex.get(c);
return z.calculatePercentile(a,{value:f,orderBy:h,fieldType:null==b?void 0:b.type,isDiscrete:"percentile_disc"===e})};n._getAttributeValues=function(b,a,c){if(c.has(a))return c.get(a);const d=this.fieldsIndex.get(a),e=this.items.map(f=>b.getFieldValue(f,a,d));c.set(a,e);return e};n._getAttributeNormalizedValues=function(b,a){return this.items.map(c=>b.getNormalizedValue(c,{field:a.field,fieldInfo:this.fieldsIndex.get(a.field),normalizationField:a.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(a.normalizationField),
normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal}))};n._getAttributeExpressionValues=function(){var b=B._asyncToGenerator(function*(a,c,d){const {arcadeUtils:e}=yield ca.loadArcade(),f=e.createFunction(c),h=d&&e.getViewInfo(d);return this.items.map(g=>a.getExpressionValue(g,{compiledFunc:f,viewInfo:h},e))});return function(a,c,d){return b.apply(this,arguments)}}();n._calculateUniqueValues=function(b,a){const c={},d=this.items,e=d.length;for(let f=0;f<e;f++){const h=d[f],
g=[];for(const l of b)g.push(l[f]);const k=g.join(",");a?null==c[k]&&(c[k]={count:1,data:g,items:[h],itemPositions:[f]}):null==c[k]?c[k]={count:1,data:g,items:[h],itemPositions:[f]}:(c[k].count++,c[k].items.push(h),c[k].itemPositions.push(f))}return c};n._getDataValues=function(){var b=B._asyncToGenerator(function*(a,c){const d=new P(a,this.featureAdapter,this.fieldsIndex),{valueExpression:e,field:f,normalizationField:h,normalizationType:g,normalizationTotal:k,scale:l}=c;a=e?{viewingMode:"map",scale:l,
spatialReference:a.outSR||this.spatialReference}:null;return e?this._getAttributeExpressionValues(d,e,a):this._getAttributeNormalizedValues(d,{field:f,normalizationField:h,normalizationType:g,normalizationTotal:k})});return function(a,c){return b.apply(this,arguments)}}();B._createClass(t,[{key:"size",get:function(){return this.items.length}}]);return t}();G.SnappingTypes=void 0;(function(t){t[t.NONE=0]="NONE";t[t.EDGE=1]="EDGE";t[t.VERTEX=2]="VERTEX"})(G.SnappingTypes||(G.SnappingTypes={}));G.default=
ia;Object.defineProperty(G,"__esModule",{value:!0})});