// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/JSONSupport ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(u,B,z,x,L,D,C,O,P,Q,M,E,G,H,t,N,F,I){var y;
x=y=function(J){function A(c){c=J.call(this,c)||this;c.request=z;c.fieldGroups=null;c.fieldGroupDefinitions=null;return c}u._inheritsLoose(A,J);var k=A.prototype;k.initialize=function(){};A.createLoadedLayerContingentValuesCache=function(){var c=u._asyncToGenerator(function*(b){yield b.load();var a=b.sourceJSON.hasContingentValuesDefinition;if(a)return(new y({layer:b})).load();if(void 0===a){a=E.parse(b.url);if(D.isNone(a))return null;a=a.url.path;if((yield y._staticFetchEnterpriseFeatureRoot(a)).supportsQueryDataElements&&
(a=yield y._staticFetchEnterpriseFieldGroup(a,b.layerId.toString())))return a=a.map(d=>({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fieldNames.names})),(new y({layer:b,fieldGroupDefinitions:a})).load()}return null});return function(b){return c.apply(this,arguments)}}();k.load=function(){var c=u._asyncToGenerator(function*(b){const a=this.layer.load(b).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,b));this.addResolvingPromise(a);return this});return function(b){return c.apply(this,
arguments)}}();k.validateContingencyConstraints=function(c,b){const a=this.layer.typeIdField,d=Object.keys(c),e=[],f=[];for(const g of this.fieldGroups){const r=g.isEditingRestrictive?"error":"warning";if(b&&!g.fields.some(p=>b.includes(p)))continue;if(!g.fields.every(p=>d.includes(p))){f.push(new H({fieldGroup:g,type:r}));continue}let m=!1;const l=c[a];var n=g.contingencies.filter(p=>!p.isRetired&&p.subtype?p.subtype.code===l:!0);for(const p of n){n=!0;for(const q in p.values){const h=p.values[q];
if("any"!==h.objectType)if("null"===h.objectType){if(null!=c[q]){n=!1;break}}else if("code"===h.objectType){if(c[q]!==h.codedValue.code){n=!1;break}}else if("range"===h.objectType){const v=c[q];if(v<h.minValue||v>h.maxValue){n=!1;break}}}if(n){m=!0;break}}m||e.push(new H({fieldGroup:g,type:r}))}return{invalid:e,incomplete:f}};k.getContingentValues=function(c,b,a=!1){const d=c[this.layer.typeIdField],e={};let f=[];const n=this.fieldGroups.filter(r=>r.fields.includes(b));f.push(new t({objectType:"any"}));
for(const r of n){let m=[];var g=r.contingencies.filter(q=>!q.isRetired&&q.subtype?q.subtype.code===d:!0);let l=!1;const p={};for(const q of g){let h;g=!0;for(const v in q.values){const w=q.values[v];if(b===v)h=w,l=l||"range"===w.objectType;else if(void 0!==c[v]&&"any"!==w.objectType)if("null"===w.objectType)null!==c[v]&&(g=!1);else if("code"===w.objectType)c[v]!==w.codedValue.code&&(g=!1);else if("range"===w.objectType){const K=c[v];if(K<w.minValue||K>w.maxValue)g=!1}}if(h&&g){if("any"===h.objectType){m.length=
0;m.push(h);break}g=this._generateKey(h);p[g]||m.push(h);p[g]=!0}}l&&(m=this._joinRange(m));e[r.name]=m;f=a?this._filterIntersection(f,m):null}1===n.length&&(f=[]);return new N({contingentValuesAllGroups:f,contingentValuesByFieldGroup:e})};k._generateKey=function(c){switch(c.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return c.codedValue.name+c.codedValue.code.toString();case "range":return c.minValue.toString()+"-"+c.maxValue.toString()}};k._joinRange=function(c){c.sort((e,
f)=>"null"===e.objectType?-1:"null"===f.objectType?1:e.minValue-f.minValue);let b,a;const d=[];for(const e of c)"null"===e.objectType?d.push(e):void 0===b?(b=e.minValue,a=e.maxValue):a<e.minValue?(d.push(new t({objectType:"range",minValue:b,maxValue:a})),b=e.minValue,a=e.maxValue):a<e.maxValue&&(a=e.maxValue);d.push(new t({objectType:"range",minValue:b,maxValue:a}));return d};k._filterIntersection=function(c,b){var a,d;if(0===c.length||0===b.length)return[];if("any"===c[0].objectType)return b;if("any"===
b[0].objectType)return c;const e="range"===c[0].objectType||"range"===(null==(a=c[1])?void 0:a.objectType);a="range"===b[0].objectType||"range"===(null==(d=b[1])?void 0:d.objectType);return e||a?this._intersectRanges(c,b):this._intersectValues(c,b)};k._intersectRanges=function(c,b){const a=[];let d=0;for(const e of c)for(;d<b.length;d++){const f=b[d];if("null"===e.objectType&&"null"===f.objectType)a.push(new t({objectType:"null"}));else if("null"===e.objectType)break;else if("null"===f.objectType)continue;
if(e.maxValue<f.minValue)break;if(e.maxValue===f.minValue){a.push(new t({objectType:"range",minValue:e.maxValue,maxValue:f.minValue}));break}if(!(e.minValue>f.maxValue))if(e.minValue===f.maxValue)a.push(new t({objectType:"range",minValue:e.minValue,maxValue:f.maxValue}));else{c=e.minValue>f.minValue?e.minValue:f.minValue;if(e.maxValue<f.maxValue){a.push(new t({objectType:"range",minValue:c,maxValue:e.maxValue}));break}a.push(new t({objectType:"range",minValue:c,maxValue:f.maxValue}))}}return a};k._intersectValues=
function(c,b){const a=[];for(const d of c)b.some(e=>{if(d.objectType===e.objectType)switch(d.objectType){case "any":case "null":return!0;case "code":return d.codedValue.code===e.codedValue.code&&d.codedValue.name===e.codedValue.name}return!1})&&a.push(d);return a};A._staticFetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(b,a){return z(b,{responseType:"json",query:{f:"json"},...a}).then(d=>d.data)});return function(b,a){return c.apply(this,arguments)}}();A._staticFetchEnterpriseFieldGroup=
function(){var c=u._asyncToGenerator(function*(b,a,d){return z(`${b}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([a]),f:"json"},...d}).then(e=>{var f;return null==(f=e.data.layerDataElements)?void 0:f[0].dataElement.fieldGroups})});return function(b,a,d){return c.apply(this,arguments)}}();k._initializeContingentValues=function(){var c=u._asyncToGenerator(function*(b,a){b=b?b:yield this._fetchFieldGroupDefs(a);this.fieldGroups=0===b.length?[]:yield this._fetchContingentValues(b,
a)});return function(b,a){return c.apply(this,arguments)}}();k._fetchFieldGroupDefs=function(){var c=u._asyncToGenerator(function*(b){var a=this;const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=D.unwrap(E.parse(this.layer.url)).url.path;return d.hasContingentValuesDefinition?(yield this._fetchAGOLFieldGroup(f,e,b)).map(n=>({name:n.name,isEditingRestrictive:n.restrictive,fields:n.fields.map(g=>this.layer.fieldsIndex.normalizeFieldName(g))})):void 0!==d.hasContingentValuesDefinition?
[]:this._fetchEnterpriseFeatureRoot(f,b).then(function(){var n=u._asyncToGenerator(function*(g){return g.supportsQueryDataElements?(yield a._fetchEnterpriseFieldGroup(f,e,b)).map(r=>({name:r.name,isEditingRestrictive:r.isEditingRestrictive,fields:r.fieldNames.names.map(m=>a.layer.fieldsIndex.normalizeFieldName(m))})):[]});return function(g){return n.apply(this,arguments)}}())});return function(b){return c.apply(this,arguments)}}();k._fetchAGOLFieldGroup=function(){var c=u._asyncToGenerator(function*(b,
a,d){return z(`${b}/${a}/fieldgroups`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data.fieldGroups)});return function(b,a,d){return c.apply(this,arguments)}}();k._fetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(b,a,d){return y._staticFetchEnterpriseFieldGroup(b,a,d)});return function(b,a,d){return c.apply(this,arguments)}}();k._fetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(b,a){return y._staticFetchEnterpriseFeatureRoot(b,a)});return function(b,
a){return c.apply(this,arguments)}}();k._fetchContingentValues=function(){var c=u._asyncToGenerator(function*(b,a){const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=D.unwrap(E.parse(this.layer.url)).url.path;if(d.hasContingentValuesDefinition)return a=yield this._fetchAGOLContingentValues(f,e,a),this._constructFieldGroupsAGOL(b,a);a=yield this._fetchEnterpriseContingentValues(f,e,a);return this._constructFieldGroupsEnterprise(b,a)});return function(b,a){return c.apply(this,arguments)}}();
k._constructFieldGroupsAGOL=function(c,b){return c.map(a=>{const d=b.contingentValuesDefinition.fieldGroups.find(e=>e.name===a.name);if(d){let e=[];e=b.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(a,b,d.subTypes):this._parseAGOLFieldGroup(a,b,d.contingentValues);return new F({name:a.name,isEditingRestrictive:a.isEditingRestrictive,fields:a.fields,contingencies:e})}return null}).filter(a=>null!==a)};k._parseAGOLFieldGroupSubtype=function(c,b,a){let d=[];a.forEach(e=>{const f=
this._getSubtypeAGOL(e.name);d=d.concat(this._parseAGOLFieldGroup(c,b,e.contingentValues,f))});return d};k._parseAGOLFieldGroup=function(c,b,a,d=null){const e=[];for(const f of a)a=this._parseAGOLContingency(f,c,b,d),e.push(a);return e};k._parseAGOLContingency=function(c,b,a,d){const e=c.id,f=c.retired?1===c.retired:!1,n={};for(let r=0,m=0;r<b.fields.length;r++){const l=b.fields[r];var g=a.typeCodes[c.types[r]];if("Code"===g){let p=c.values[m];m++;const q=this._getDomain(d,l);"string"===this.layer.getField(l).type&&
(g=a.stringDicts.find(h=>h.domain===q.name))&&(p=g.entries[p]);g=q.codedValues.find(h=>h.code===p);g=new t({codedValue:g,objectType:"code"});n[l]=g}else"Range"===g?(g=c.values[m],m++,g=new t({minValue:g.range[0],maxValue:g.range[1],objectType:"range"}),n[l]=g):"Any"===g?(g=new t({objectType:"any"}),n[l]=g):(g=new t({objectType:"null"}),n[l]=g)}return new G({id:e,isRetired:f,subtype:d,values:n})};k._constructFieldGroupsEnterprise=function(c,b){const a=b.fieldGroups;return c.map(d=>{var e=a.find(f=>
f.name===d.name);return e?(e=e.contingencies.map(f=>{const n=f.id,g=f.isRetired||!1,r=this._getSubtypeEnterprise(f.subtypeCode),m={};for(let p=0;p<d.fields.length;p++){const q=d.fields[p];let h=f.values[p];if("number"===typeof h||"string"===typeof h){var l=this._getDomain(r,q);const v=this.layer.getField(q);"string"===v.type?h=b.stringDictionary[h]:"date"===v.type&&(h=(new Date(`${h}+00:00`)).getTime());l=l.codedValues.find(w=>w.code===h);l=new t({codedValue:l,objectType:"code"});m[q]=l}else"object"===
typeof h?(l=new t({minValue:h.minValue,maxValue:h.maxValue,objectType:"range"}),m[q]=l):h?(l=new t({objectType:"any"}),m[q]=l):(l=new t({objectType:"null"}),m[q]=l)}return new G({id:n,isRetired:g,subtype:r,values:m})}),new F({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fields,contingencies:e})):null}).filter(d=>null!==d)};k._fetchEnterpriseContingentValues=function(){var c=u._asyncToGenerator(function*(b,a,d){return z(`${b}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([a]),
f:"json"},...d}).then(e=>{var f;return null==(f=e.data.contingentValueSets)?void 0:f[0]})});return function(b,a,d){return c.apply(this,arguments)}}();k._fetchAGOLContingentValues=function(){var c=u._asyncToGenerator(function*(b,a,d){return z(`${b}/${a}/contingentValues`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data)});return function(b,a,d){return c.apply(this,arguments)}}();k._getSubtypeEnterprise=function(c){var b=this.layer.sourceJSON;let a;b.subtypes&&(b=b.subtypes.find(d=>d.code===
c),a=I.fromJSON(b));return a?a:null};k._getSubtypeAGOL=function(c){var b=this.layer.sourceJSON;let a;b.subtypes&&(b=b.subtypes.find(d=>d.name===c),a=I.fromJSON(b));return a?a:null};k._getDomain=function(c,b){c=c?c.domains[b]:this.layer.getFieldDomain(b);return"inherited"===c.type?this.layer.getFieldDomain(b):c};return A}(x.JSONSupportMixin(L));B.__decorate([C.property({constructOnly:!0})],x.prototype,"layer",void 0);B.__decorate([C.property({constructOnly:!0})],x.prototype,"request",void 0);B.__decorate([C.property({type:[F]})],
x.prototype,"fieldGroups",void 0);B.__decorate([C.property()],x.prototype,"fieldGroupDefinitions",void 0);return x=y=B.__decorate([M.subclass("esri.layers.support.LayerContingentValuesCache")],x)});