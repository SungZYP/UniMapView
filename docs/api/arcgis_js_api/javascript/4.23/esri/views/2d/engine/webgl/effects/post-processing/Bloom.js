// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define(["exports","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject"],function(u,w,b,m){const x=[1,0],y=[0,1],z=[1,.8,.6,.4,.2],A=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];let F=function(){function v(){this._compositeFBO=this._intensityFBO=null;this._mipsFBOs=Array(5);this._nMips=5;this._kernelSizeArray=[3,5,7,9,11];this._size=[0,0];this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",
0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}var r=v.prototype;r.dispose=function(){this._quad&&(this._quad.dispose(),this._quad=null);this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=
null);this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null);if(this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}};r.draw=function(e,f,g){const {width:d,height:t}=f,{context:a,painter:B}=e,{materialManager:n}=B;var k=a.gl;const p=this._programDesc,{strength:C,radius:D,threshold:E}=g;this._quad||(this._quad=new w(a,[-1,-1,1,-1,-1,1,1,1]));this._createOrResizeResources(e,
d,t);a.setStencilTestEnabled(!1);a.setBlendingEnabled(!0);a.setBlendFunction(b.BlendFactor.ONE,b.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setStencilWriteMask(0);g=this._quad;g.bind();a.bindFramebuffer(this._intensityFBO);var c=n.getProgram(e,p.luminosityHighPass);a.useProgram(c);a.bindTexture(f.colorTexture,0);c.setUniform1i("u_texture",0);c.setUniform3fv("u_defaultColor",[0,0,0]);c.setUniform1f("u_defaultOpacity",0);c.setUniform1f("u_luminosityThreshold",E);c.setUniform1f("u_smoothWidth",.01);c=[Math.round(d/
2),Math.round(t/2)];a.setViewport(0,0,c[0],c[1]);a.setClearColor(0,0,0,0);a.clear(k.COLOR_BUFFER_BIT);g.draw();a.setBlendingEnabled(!1);k=this._intensityFBO.colorTexture;for(let h=0;h<this._nMips;h++){const l=n.getProgram(e,p.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[h]}]);a.useProgram(l);a.bindTexture(k,h+1);l.setUniform1i("u_colorTexture",h+1);l.setUniform2fv("u_texSize",c);l.setUniform2fv("u_direction",x);a.setViewport(0,0,c[0],c[1]);const q=this._mipsFBOs[h];a.bindFramebuffer(q.horizontal);
g.draw();k=q.horizontal.colorTexture;a.bindFramebuffer(q.vertical);a.bindTexture(k,h+1);l.setUniform2fv("u_direction",y);g.draw();k=q.vertical.colorTexture;c[0]=Math.round(c[0]/2);c[1]=Math.round(c[1]/2)}a.setViewport(0,0,d,t);c=n.getProgram(e,p.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO);a.useProgram(c);c.setUniform1f("u_bloomStrength",C);c.setUniform1f("u_bloomRadius",D);c.setUniform1fv("u_bloomFactors",z);c.setUniform3fv("u_bloomTintColors",A);a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,
1);c.setUniform1i("u_blurTexture1",1);a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2);c.setUniform1i("u_blurTexture2",2);a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3);c.setUniform1i("u_blurTexture3",3);a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4);c.setUniform1i("u_blurTexture4",4);a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5);c.setUniform1i("u_blurTexture5",5);g.draw();a.bindFramebuffer(f);a.setBlendingEnabled(!0);e=n.getProgram(e,p.blit);a.useProgram(e);
a.bindTexture(this._compositeFBO.colorTexture,6);e.setUniform1i("u_texture",6);a.setBlendFunction(b.BlendFactor.ONE,b.BlendFactor.ONE);g.draw();g.unbind();a.setBlendFunction(b.BlendFactor.ONE,b.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setStencilTestEnabled(!0)};r._createOrResizeResources=function(e,f,g){({context:e}=e);if(!this._compositeFBO||this._size[0]!==f||this._size[1]!==g){this._size[0]=f;this._size[1]=g;var d=[Math.round(f/2),Math.round(g/2)];this._compositeFBO?this._compositeFBO.resize(f,g):this._compositeFBO=
new m.FramebufferObject(e,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE,width:f,height:g});this._intensityFBO?this._intensityFBO.resize(d[0],d[1]):this._intensityFBO=new m.FramebufferObject(e,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE,width:d[0],height:d[1]},{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,internalFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,
samplingMode:b.TextureSamplingMode.LINEAR,flipped:!1,width:d[0],height:d[1]});for(f=0;f<this._nMips;f++)this._mipsFBOs[f]?(this._mipsFBOs[f].horizontal.resize(d[0],d[1]),this._mipsFBOs[f].vertical.resize(d[0],d[1])):this._mipsFBOs[f]={horizontal:new m.FramebufferObject(e,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE,width:d[0],height:d[1]},{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,internalFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,
wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:b.TextureSamplingMode.LINEAR,flipped:!1,width:d[0],height:d[1]}),vertical:new m.FramebufferObject(e,{colorTarget:b.TargetType.TEXTURE,depthStencilTarget:b.DepthStencilTargetType.NONE,width:d[0],height:d[1]},{target:b.TextureType.TEXTURE_2D,pixelFormat:b.PixelFormat.RGBA,internalFormat:b.PixelFormat.RGBA,dataType:b.PixelType.UNSIGNED_BYTE,wrapMode:b.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:b.TextureSamplingMode.LINEAR,flipped:!1,width:d[0],height:d[1]})},
d[0]=Math.round(d[0]/2),d[1]=Math.round(d[1]/2)}};return v}();u.Bloom=F;Object.defineProperty(u,"__esModule",{value:!0})});