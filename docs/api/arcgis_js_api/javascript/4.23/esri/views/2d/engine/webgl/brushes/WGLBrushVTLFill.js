// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../vectorTiles/style/StyleDefinition ../definitions ../enums ../number ./WGLBrush ../../../../webgl/enums".split(" "),function(G,N,z,H,B,D,O,E,q){const I=1/65536;E=function(J){function F(){var c=J.apply(this,arguments)||this;c._fillProgramOptions={id:!1,pattern:!1};c._outlineProgramOptions={id:!1};return c}N._inheritsLoose(F,J);var C=F.prototype;C.dispose=function(){};C.drawMany=function(c,v){const {displayLevel:k,
drawPhase:b,renderPass:h,spriteMosaic:e,styleLayerUID:n}=c;var a=!1;for(var l of v)if(l.layerData.has(n)){var r=l.layerData.get(n);if(0<r.fillIndexCount||0<r.outlineIndexCount){a=!0;break}}if(a){a=c.styleLayer;var f=a.getPaintProperty("fill-pattern");r=(l=void 0!==f)&&f.isDataDriven;if(l&&!r){var t=f.getValue(k);t=e.getMosaicItemPosition(t,!0)}f=!l&&a.getPaintValue("fill-antialias",k);var y=!0,w=1;if(!l){var d=a.getPaintProperty("fill-color"),x=a.getPaintProperty("fill-opacity");null!=d&&d.isDataDriven||
null!=x&&x.isDataDriven||(w=a.getPaintValue("fill-color",k),w=a.getPaintValue("fill-opacity",k)*w[3],1<=w&&(y=!1))}if(!y||"opaque"!==h){var m;b===D.WGLDrawPhase.HITTEST&&(m=O.u32to4Xu8(n+1));d=a.getPaintValue("fill-translate",k);x=a.getPaintValue("fill-translate-anchor",k);(y||"translucent"!==h)&&this._drawFill(c,n,a,v,d,x,l,t,r,m);t=!a.hasDataDrivenOutlineColor&&a.outlineUsesFillColor&&1>w;f&&"opaque"!==h&&!t&&this._drawOutline(c,n,a,v,d,x,m)}}};C._drawFill=function(c,v,k,b,h,e,n,a,l,r){if(!n||l||
!z.isNone(a)){var {context:f,displayLevel:t,state:y,drawPhase:w,painter:d,pixelRatio:x,spriteMosaic:m}=c;c=k.fillMaterial;var g=d.vectorTilesMaterialManager,u=x>B.VTL_HIGH_RES_CUTOFF?2:1,K=w===D.WGLDrawPhase.HITTEST,A=this._fillProgramOptions;A.id=K;A.pattern=n;g=g.getMaterialProgram(f,c,A);f.useProgram(g);z.isSome(a)&&({page:a}=a,A=m.getPageSize(a),z.isSome(A)&&(m.bind(f,q.TextureSamplingMode.LINEAR,a,B.VTL_TEXTURE_BINDING_UNIT_SPRITES),g.setUniform2fv("u_mosaicSize",A),g.setUniform1i("u_texture",
B.VTL_TEXTURE_BINDING_UNIT_SPRITES)));g.setUniformMatrix3fv("u_displayMat3",e===H.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3);g.setUniform2fv("u_fillTranslation",h);g.setUniform1f("u_depth",k.z+I);K&&g.setUniform4fv("u_id",r);h=-1;for(const p of b)if(p.layerData.has(v)&&(p.key.level!==h&&(h=p.key.level,c.setDataUniforms(g,t,k,h,m)),b=p.layerData.get(v),b.fillIndexCount&&(b.prepareForRendering(f),e=b.fillVertexArrayObject,!z.isNone(e)))){f.bindVAO(e);g.setUniformMatrix3fv("u_dvsMat3",
p.transforms.dvs);f.setStencilFunction(q.CompareFunction.EQUAL,p.stencilRef,255);n&&g.setUniform1f("u_patternFactor",p.rangeX/(u*p.width*Math.max(2**(Math.round(t)-p.key.level),1)));if(l){e=b.patternMap;if(!e)continue;for(const [L,M]of e)e=m.getPageSize(L),z.isSome(e)&&(m.bind(f,q.TextureSamplingMode.LINEAR,L,B.VTL_TEXTURE_BINDING_UNIT_SPRITES),g.setUniform2fv("u_mosaicSize",e),g.setUniform1i("u_texture",B.VTL_TEXTURE_BINDING_UNIT_SPRITES),f.drawElements(q.PrimitiveType.TRIANGLES,M[1],q.DataType.UNSIGNED_INT,
Uint32Array.BYTES_PER_ELEMENT*M[0]))}else f.drawElements(q.PrimitiveType.TRIANGLES,b.fillIndexCount,q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*b.fillIndexStart);p.triangleCount+=b.fillIndexCount/3}}};C._drawOutline=function(c,v,k,b,h,e,n){const {context:a,displayLevel:l,state:r,drawPhase:f,painter:t,pixelRatio:y,spriteMosaic:w}=c;c=k.outlineMaterial;var d=t.vectorTilesMaterialManager;const x=.75/y,m=f===D.WGLDrawPhase.HITTEST,g=this._outlineProgramOptions;g.id=m;d=d.getMaterialProgram(a,
c,g);a.useProgram(d);d.setUniformMatrix3fv("u_displayMat3",e===H.TranslateAnchor.VIEWPORT?r.displayMat3:r.displayViewMat3);d.setUniform2fv("u_fillTranslation",h);d.setUniform1f("u_depth",k.z+I);d.setUniform1f("u_outline_width",x);m&&d.setUniform4fv("u_id",n);h=-1;for(const u of b)u.layerData.has(v)&&(u.key.level!==h&&(h=u.key.level,c.setDataUniforms(d,l,k,h,w)),b=u.layerData.get(v),b.prepareForRendering(a),b.outlineIndexCount&&(e=b.outlineVertexArrayObject,z.isNone(e)||(a.bindVAO(e),d.setUniformMatrix3fv("u_dvsMat3",
u.transforms.dvs),a.setStencilFunction(q.CompareFunction.EQUAL,u.stencilRef,255),a.drawElements(q.PrimitiveType.TRIANGLES,b.outlineIndexCount,q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*b.outlineIndexStart),u.triangleCount+=b.outlineIndexCount/3)))};return F}(E);G.WGLBrushVTLFill=E;Object.defineProperty(G,"__esModule",{value:!0})});