// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./effects/AnimationEffect ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/HittestEffectVTL ./effects/post-processing/EffectManager ./painter/RenderPass ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer".split(" "),function(w,
n,m,x,y,h,z,A,B,C,u,D,E,F,G,H,e,r,I){function v(p,f,a,c){return p!==h.WGLDrawPhase.HIGHLIGHT&&(1!==c||n.isSome(f)&&"normal"!==f||n.isSome(a)&&0<a.length)}const J={[h.WGLGeometryType.FILL]:m.brushes.fill,[h.WGLGeometryType.LINE]:m.brushes.line,[h.WGLGeometryType.MARKER]:m.brushes.marker,[h.WGLGeometryType.TEXT]:m.brushes.text};return function(){function p(a,c,b){this.context=a;this._blitRenderer=new y.BitBlitRenderer;this._brushCache=new Map;this._vtlMaterialManager=new x;this._blendEffect=new C.BlendEffect;
this._fboPool=[];this.effects={highlight:new D,hittest:new E.HittestEffect,hittestVTL:new F.HittestEffectVTL,integrate:new B.AnimationEffect,insideEffect:new u.FeatureEffect("inside"),outsideEffect:new u.FeatureEffect("outside")};this.materialManager=new z(a);this.textureManager=new A(c,b);this._effectsManager=new G.EffectManager(c)}var f=p.prototype;f.getRenderTarget=function(){return this._renderTarget};f.setRenderTarget=function(a){this._renderTarget=a};f.getFbos=function(a,c){if(a!==this._lastWidth||
c!==this._lastHeight){this._lastWidth=a;this._lastHeight=c;if(this._fbos){for(var b in this._fbos)this._fbos[b].resize(a,c);return this._fbos}b={target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.NEAREST,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:a,height:c};const d={colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER};this._stencilBuf=a=new I.Renderbuffer(this.context,
{width:a,height:c,internalFormat:e.RenderbufferFormat.DEPTH_STENCIL});this._fbos={output:new r.FramebufferObject(this.context,d,b,a),blend:new r.FramebufferObject(this.context,d,b,a),effect0:new r.FramebufferObject(this.context,d,b,a)}}return this._fbos};f.acquireFbo=function(a,c){let b;b=0<this._fboPool.length?this._fboPool.pop():new r.FramebufferObject(this.context,{colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},{target:e.TextureType.TEXTURE_2D,
pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.NEAREST,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:a,height:c},this._stencilBuf);const d=b.descriptor;d.width===a&&d.height===c||b.resize(a,c);return b};f.releaseFbo=function(a){this._fboPool.push(a)};f.getSharedStencilBuffer=function(){return this._stencilBuf};f.beforeRenderLayers=function(a,c=null){const {width:b,height:d}=a.getViewport();this._prevFBO=a.getBoundFramebufferObject();const g=this.getFbos(b,
d);a.bindFramebuffer(g.output);a.setColorMask(!0,!0,!0,!0);a.setDepthWriteEnabled(!0);if(n.isSome(c)){const {r:q,g:k,b:l,a:t}=c.color;a.setClearColor(t*q/255,t*k/255,t*l/255,t)}else a.setClearColor(0,0,0,0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};f.beforeRenderLayer=function(a,c,b){const {context:d,blendMode:g,effects:q,requireFBO:k,drawPhase:l}=a;k||v(l,g,q,b)?(d.bindFramebuffer(this._fbos.blend),d.setColorMask(!0,!0,!0,!0),d.setClearColor(0,
0,0,0),d.setDepthWriteEnabled(!0),d.setClearDepth(1),d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.DEPTH_BUFFER_BIT),d.setDepthWriteEnabled(!1)):(a=this._getOutputFBO(),d.bindFramebuffer(a));d.setDepthWriteEnabled(!1);d.setDepthTestEnabled(!1);d.setStencilTestEnabled(!0);d.setClearStencil(c);d.setStencilWriteMask(255);d.clear(d.gl.STENCIL_BUFFER_BIT)};f.compositeLayer=function(a,c){const {context:b,blendMode:d,effects:g,requireFBO:q,drawPhase:k}=a;if(q||v(k,d,g,c)){n.isSome(g)&&0<g.length&&k===h.WGLDrawPhase.MAP&&
this._applyEffects(a,g);var l=this._getOutputFBO();b.bindFramebuffer(l);b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setColorMask(!0,!0,!0,!0);l=n.isNone(d)||k===h.WGLDrawPhase.HIGHLIGHT?"normal":d;this._blendEffect.draw(a,this._fbos.blend.colorTexture,e.TextureSamplingMode.NEAREST,l,c)}};f.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);
if(this._fbos){var c=this._getOutputFBO();a.setStencilTestEnabled(!1);a.setStencilWriteMask(0);this.blitTexture(a,c.colorTexture,e.TextureSamplingMode.NEAREST)}};f.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=null);if(this._fbos)for(const a in this._fbos)this._fbos[a]&&this._fbos[a].dispose();
for(const a of this._fboPool)a.dispose();this._fboPool.length=0;if(this.effects)for(const a in this.effects)this.effects[a]&&this.effects[a].dispose();this._effectsManager.dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null);this._prevFBO=null};f.getGeometryBrush=function(a){a=J[a];let c=this._brushCache.get(a);void 0===c&&(c=new a,this._brushCache.set(a,c));return this._brushCache.get(a)};f.renderObject=function(a,c,b,d){b=m.brushes[b];if(!b)return null;
let g=this._brushCache.get(b);void 0===g&&(g=new b,this._brushCache.set(b,g));g.prepareState(a,c,d);g.draw(a,c,d)};f.renderObjects=function(a,c,b,d){b=m.brushes[b];if(!b)return null;let g=this._brushCache.get(b);void 0===g&&(g=new b,this._brushCache.set(b,g));g.drawMany(a,c,d)};f.registerRenderPass=function(a){const c=a.brushes.map(b=>{this._brushCache.has(b)||this._brushCache.set(b,new b);return this._brushCache.get(b)});return new H(c,a)};f.setHighlightOptions=function(a){this.effects.highlight.setHighlightOptions(a)};
f.blitTexture=function(a,c,b,d=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,c,b,d)};f.getPostProcessingEffects=function(a){return this._effectsManager.getPostProcessingEffects(a)};f._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output};f._applyEffects=function(a,c){const {context:b}=a;c=this._effectsManager.getPostProcessingEffects(c);
for(const {postProcessingEffect:d,effect:g}of c)b.bindFramebuffer(this._fbos.blend),d.draw(a,this._fbos.blend,g)};w._createClass(p,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]);return p}()});