// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/RandomLCG ../definitions ../enums ../Utils ./WGLGeometryBrush ../materialKey/MaterialKey ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/Renderbuffer ../../../../webgl/Texture ../../../../webgl/VertexArrayObject".split(" "),function(z,q,A,t,B,C,D,E,F,e,G,H,I,J){return function(y){function w(){var a=y.apply(this,arguments)||this;a._dotTextureSize=
0;a._dotTextures=null;a._dotSamplers=new Int32Array([t.TEXTURE_BINDING_RENDERER_0,t.TEXTURE_BINDING_RENDERER_1]);a._dotVAO=null;a._dotDesc={vsPath:"dot/dot",fsPath:"dot/dot",attributes:new Map([["a_pos",0]])};return a}z._inheritsLoose(w,y);var m=w.prototype;m.dispose=function(){this._disposeTextures();this._dotFBO=q.disposeMaybe(this._dotFBO);this._dotVAO=q.disposeMaybe(this._dotVAO)};m.getGeometryType=function(){return B.WGLGeometryType.FILL};m.drawGeometry=function(a,c,b,d){const {context:g,painter:f,
rendererInfo:h,requiredLevel:u,passOptions:p}=a;var k=E.FillMaterialKey.load(b.materialKey),n=f.materialManager;let r=e.PrimitiveType.TRIANGLES;var l={geometry:[{location:0,name:"a_pos",count:2,type:e.DataType.SHORT},{location:1,name:"a_id",count:3,type:e.DataType.UNSIGNED_BYTE},{location:2,name:"a_bitset",count:1,type:e.DataType.UNSIGNED_BYTE}]};k.dotDensity?l.geometry.push({location:3,name:"a_inverseArea",count:1,type:e.DataType.FLOAT}):(l.geometry.push({location:3,name:"a_color",count:4,type:e.DataType.UNSIGNED_BYTE,
normalized:!0}),k.simple||l.geometry.push({location:4,name:"a_aux1",count:4,type:e.DataType.UNSIGNED_SHORT}),l.geometry.push({location:5,name:"a_aux2",count:4,type:e.DataType.UNSIGNED_BYTE},{location:6,name:"a_aux3",count:4,type:e.DataType.UNSIGNED_BYTE}),k.simple||l.geometry.push({location:7,name:"a_zoomRange",count:2,type:e.DataType.UNSIGNED_SHORT}));l=C.createProgramDescriptor(k.data,l);q.isSome(p)&&"hittest"===p.type&&(l=this._getTriangleDesc(b.materialKey,l),r=e.PrimitiveType.POINTS);const {attributes:v,
bufferLayouts:K}=l;d=n.getMaterialProgram(a,k,"materials/fill",v,d);g.useProgram(d);this._setSharedUniforms(d,a,c);d.setUniform2f("u_tileOffset",512*c.key.col,512*c.key.row);k.textureBinding&&(f.textureManager.bindTextures(g,d,k),d.setUniform1f("u_zoomFactor",1/2**(u-c.key.level)/a.pixelRatio));n=1/a.pixelRatio;d.setUniform1f("u_blur",n);d.setUniform1f("u_antialiasing",n);this._setSizeVVUniforms(k,d,h,c);this._setColorAndOpacityVVUniforms(k,d,h);n=q.isSome(p)&&"hittest"===p.type;l=b.target.getVAO(g,
K,v,n);let x=b.indexCount;b=b.indexFrom*Uint32Array.BYTES_PER_ELEMENT;n&&(x/=3,b/=3);g.bindVAO(l);k.dotDensity&&!n?(k=this._drawDotLocations(a,c,d,x,b),this._drawDotDensity(a,c,k)):g.drawElements(r,x,e.DataType.UNSIGNED_INT,b)};m._drawDotDensity=function(a,c,b){const {context:d,painter:g,rendererInfo:f}=a,h=g.materialManager.getProgram(a,this._dotDesc),u=this._createDotDensityMesh(d,this._dotDesc.attributes,{geometry:[{name:"a_pos",count:2,type:e.DataType.SHORT,divisor:0,normalized:!1,offset:0,stride:4}]});
d.setStencilTestEnabled(!0);d.useProgram(h);h.setUniform1f("u_tileZoomFactor",1);h.setUniform1i("u_texture",this._dotSamplers[0]);h.setUniform1f("u_dotSize",Math.max(f.ddDotSize,1));h.setUniform1f("u_pixelRatio",window.devicePixelRatio);this._setSharedUniforms(h,a,c);d.bindTexture(b,this._dotSamplers[0]);d.bindVAO(u);d.drawArrays(e.PrimitiveType.POINTS,0,262144)};m._drawDotLocations=function(a,c,b,d,g){const {context:f,rendererInfo:h,requiredLevel:u}=a,p=f.getViewport();f.setViewport(0,0,512,512);
const k=f.getBoundFramebufferObject(),n=this._createFBO(f);f.bindFramebuffer(n);f.setClearColor(0,0,0,0);f.clear(f.gl.COLOR_BUFFER_BIT|f.gl.STENCIL_BUFFER_BIT);f.setStencilTestEnabled(!1);c=1/2**(u-c.key.level);const r=t.TILE_SIZE,l=r*window.devicePixelRatio*r*window.devicePixelRatio,v=1/c*(1/c);a=h.ddDotScale?a.state.scale/h.ddDotScale:1;b.setUniform1f("u_tileZoomFactor",c);b.setUniform1f("u_tileDotsOverArea",l/(t.TILE_SIZE*window.devicePixelRatio*t.TILE_SIZE*window.devicePixelRatio));b.setUniformMatrix4fv("u_dotColors",
h.ddColors);b.setUniform4fv("u_isActive",h.ddActiveDots);b.setUniform4fv("u_dotBackgroundColor",h.ddBackgroundColor);b.setUniform1f("u_dotValue",Math.max(1,h.ddDotValue*a*v));this._bindDotDensityTextures(f,b,h,r);f.drawElements(e.PrimitiveType.TRIANGLES,d,e.DataType.UNSIGNED_INT,g);f.setViewport(p.x,p.y,p.width,p.height);f.bindFramebuffer(k);return n.colorTexture};m._createFBO=function(a){if(q.isNone(this._dotFBO)){const c={target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,
samplingMode:e.TextureSamplingMode.NEAREST,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:512,height:512},b={colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},d=new H.Renderbuffer(a,{width:512,height:512,internalFormat:e.RenderbufferFormat.DEPTH_STENCIL});this._dotFBO=new G.FramebufferObject(a,b,c,d)}return this._dotFBO};m._disposeTextures=function(){if(this._dotTextures){for(let a=0;a<this._dotTextures.length;a++)this._dotTextures[a].dispose();
this._dotTextures=null}};m._bindDotDensityTextures=function(a,c,b,d){b=this._createDotDensityTextures(a,d,b.ddSeed);c.setUniform1iv("u_dotTextures",this._dotSamplers);for(c=0;c<b.length;c++)a.bindTexture(b[c],this._dotSamplers[c])};m._createDotDensityMesh=function(a,c,b){if(q.isNone(this._dotVAO)){var d=new Int16Array(524288);for(let g=0;512>g;g++)for(let f=0;512>f;f++)d[2*(f+512*g)]=f,d[2*(f+512*g)+1]=g;d=F.BufferObject.createVertex(a,e.Usage.STATIC_DRAW,d);this._dotVAO=new J.VertexArrayObject(a,
c,b,{geometry:d},null)}return this._dotVAO};m._createDotDensityTextures=function(a,c,b){if(this._dotTextureSize!==c||this._seed!==b)this._disposeTextures(),this._dotTextureSize=c,this._seed=b;null===this._dotTextures&&(b=new A(b),this._dotTextures=[this._allocDotDensityTexture(a,c,b),this._allocDotDensityTexture(a,c,b)]);return this._dotTextures};m._allocDotDensityTexture=function(a,c,b){const d=new Float32Array(c*c*4);for(let g=0;g<d.length;g++)d[g]=b.getFloat();return new I.Texture(a,{wrapMode:e.TextureWrapMode.REPEAT,
pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.FLOAT,samplingMode:e.TextureSamplingMode.NEAREST,width:c,height:c},d)};return w}(D)});