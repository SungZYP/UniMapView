// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/vec2f32 ../../vectorTiles/decluttering/config ../../vectorTiles/style/StyleDefinition ../definitions ../enums ../GeometryUtils ../number ./WGLBrush ../../../../webgl/enums".split(" "),function(K,Q,L,M,N,m,C,F,O,R,G,n){const S=1/65536;G=function(P){function H(){var d=P.apply(this,arguments)||this;d._iconProgramOptions={id:!1,sdf:!1};d._sdfProgramOptions={id:!1};d._spritesTextureSize=M.create();
return d}Q._inheritsLoose(H,P);var w=H.prototype;w.dispose=function(){};w.drawMany=function(d,a){const {drawPhase:h,styleLayerUID:k}=d,f=d.styleLayer;let b;h===F.WGLDrawPhase.HITTEST&&(b=R.u32to4Xu8(k+1));this._drawIcons(d,f,a,b);this._drawText(d,f,a,b)};w._drawIcons=function(d,a,h,k){const {context:f,displayLevel:b,drawPhase:r,painter:p,spriteMosaic:I,state:v,styleLayerUID:x}=d,t=a.iconMaterial;var g=p.vectorTilesMaterialManager,y=!1;for(var q of h)if(q.layerData.has(x)){var e=q.layerData.get(x);
if(0<e.iconPerPageElementsMap.size){y=!0;break}}if(y){y=a.getPaintValue("icon-translate",b);q=a.getPaintValue("icon-translate-anchor",b);var c=a.getLayoutValue("icon-rotation-alignment",b);c===m.RotationAlignment.AUTO&&(c=a.getLayoutValue("symbol-placement",b)===m.SymbolPlacement.POINT?m.RotationAlignment.VIEWPORT:m.RotationAlignment.MAP);var z=c===m.RotationAlignment.MAP;z=a.getLayoutValue("icon-keep-upright",b)&&z;var D=e.isIconSDF;e=r===F.WGLDrawPhase.HITTEST;var B=this._iconProgramOptions;B.id=
e;B.sdf=D;g=g.getMaterialProgram(f,t,B);f.useProgram(g);g.setUniformMatrix3fv("u_displayViewMat3",c===m.RotationAlignment.MAP?v.displayViewMat3:v.displayMat3);g.setUniformMatrix3fv("u_displayMat3",q===m.TranslateAnchor.VIEWPORT?v.displayMat3:v.displayViewMat3);g.setUniform2fv("u_iconTranslation",y);g.setUniform1f("u_depth",a.z);g.setUniform1f("u_mapRotation",O.degToByte(v.rotation));g.setUniform1f("u_keepUpright",z?1:0);g.setUniform1f("u_level",10*b);g.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_SPRITES);
g.setUniform1f("u_fadeDuration",N.FADE_DURATION/1E3);e&&g.setUniform4fv("u_id",k);k=-1;for(const u of h)if(u.layerData.has(x)&&(u.key.level!==k&&(k=u.key.level,t.setDataUniforms(g,b,a,k,I)),e=u.layerData.get(x),0!==e.iconPerPageElementsMap.size&&(e.prepareForRendering(f),e.updateOpacityInfo(),h=e.iconVertexArrayObject,!L.isNone(h)))){f.bindVAO(h);g.setUniformMatrix3fv("u_dvsMat3",u.transforms.dvs);g.setUniform1f("u_time",(performance.now()-e.lastOpacityUpdate)/1E3);for(const [J,E]of e.iconPerPageElementsMap)this._renderIconRange(d,
g,E,J,u)}}};w._renderIconRange=function(d,a,h,k,f){const {context:b,spriteMosaic:r}=d;this._spritesTextureSize[0]=r.getWidth(k)/4;this._spritesTextureSize[1]=r.getHeight(k)/4;a.setUniform2fv("u_mosaicSize",this._spritesTextureSize);r.bind(b,n.TextureSamplingMode.LINEAR,k,C.VTL_TEXTURE_BINDING_UNIT_SPRITES);b.setStencilTestEnabled(!0);b.setStencilFunction(n.CompareFunction.GREATER,255,255);b.setStencilWriteMask(0);b.drawElements(n.PrimitiveType.TRIANGLES,h[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*
h[0]);f.triangleCount+=h[1]/3};w._drawText=function(d,a,h,k){const {context:f,displayLevel:b,drawPhase:r,glyphMosaic:p,painter:I,pixelRatio:v,spriteMosaic:x,state:t,styleLayerUID:g}=d;d=a.textMaterial;const y=I.vectorTilesMaterialManager;var q=!1;for(var e of h)if(e.layerData.has(g)){var c=e.layerData.get(g);if(0<c.glyphPerPageElementsMap.size){q=!0;break}}if(q&&(c=a.getPaintProperty("text-opacity"),!c||c.isDataDriven||0!==c.getValue(b))){c=a.getPaintProperty("text-color");var z=!c||c.isDataDriven||
0<c.getValue(b)[3];c=a.getPaintProperty("text-halo-width");e=a.getPaintProperty("text-halo-color");var D=(!c||c.isDataDriven||0<c.getValue(b))&&(!e||e.isDataDriven||0<e.getValue(b)[3]);if(z||D){c=a.getLayoutValue("text-rotation-alignment",b);c===m.RotationAlignment.AUTO&&(c=a.getLayoutValue("symbol-placement",b)===m.SymbolPlacement.POINT?m.RotationAlignment.VIEWPORT:m.RotationAlignment.MAP);e=c===m.RotationAlignment.MAP;e=a.getLayoutValue("text-keep-upright",b)&&e;q=r===F.WGLDrawPhase.HITTEST;var B=
.8*3/v;this._glyphTextureSize||(this._glyphTextureSize=M.fromValues(p.width/4,p.height/4));var u=a.getPaintValue("text-translate",b),J=a.getPaintValue("text-translate-anchor",b),E=this._sdfProgramOptions;E.id=q;var l=y.getMaterialProgram(f,d,E);f.useProgram(l);l.setUniformMatrix3fv("u_displayViewMat3",c===m.RotationAlignment.MAP?t.displayViewMat3:t.displayMat3);l.setUniformMatrix3fv("u_displayMat3",J===m.TranslateAnchor.VIEWPORT?t.displayMat3:t.displayViewMat3);l.setUniform2fv("u_textTranslation",
u);l.setUniform1f("u_depth",a.z+S);l.setUniform2fv("u_mosaicSize",this._glyphTextureSize);l.setUniform1f("u_mapRotation",O.degToByte(t.rotation));l.setUniform1f("u_keepUpright",e?1:0);l.setUniform1f("u_level",10*b);l.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_GLYPHS);l.setUniform1f("u_antialiasingWidth",B);l.setUniform1f("u_fadeDuration",N.FADE_DURATION/1E3);q&&l.setUniform4fv("u_id",k);k=-1;for(const A of h)A.layerData.has(g)&&(A.key.level!==k&&(k=A.key.level,d.setDataUniforms(l,b,a,k,x)),
c=A.layerData.get(g),0!==c.glyphPerPageElementsMap.size&&(c.prepareForRendering(f),c.updateOpacityInfo(),h=c.textVertexArrayObject,L.isNone(h)||(f.bindVAO(h),l.setUniformMatrix3fv("u_dvsMat3",A.transforms.dvs),f.setStencilTestEnabled(!0),f.setStencilFunction(n.CompareFunction.GREATER,255,255),f.setStencilWriteMask(0),h=(performance.now()-c.lastOpacityUpdate)/1E3,l.setUniform1f("u_time",h),c.glyphPerPageElementsMap.forEach((T,U)=>{this._renderGlyphRange(f,T,U,p,l,D,z,A)}))))}}};w._renderGlyphRange=
function(d,a,h,k,f,b,r,p){k.bind(d,n.TextureSamplingMode.LINEAR,h,C.VTL_TEXTURE_BINDING_UNIT_GLYPHS);b&&(f.setUniform1f("u_halo",1),d.drawElements(n.PrimitiveType.TRIANGLES,a[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3);r&&(f.setUniform1f("u_halo",0),d.drawElements(n.PrimitiveType.TRIANGLES,a[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3)};return H}(G);K.WGLBrushVTLSymbol=G;Object.defineProperty(K,"__esModule",{value:!0})});