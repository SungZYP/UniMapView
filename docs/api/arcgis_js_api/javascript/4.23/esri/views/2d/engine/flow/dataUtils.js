// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/RandomLCG ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/Extent".split(" "),function(C,F,Y,O,P,D,Q,K,R,S){function G(){G=F._asyncToGenerator(function*(a,c,f){const b=performance.now();var d=T(a,c);const h=performance.now();d=U(a,d,c.width,c.height);c=performance.now();var g=
L(d,!0);d=performance.now();g=M(g);const e=performance.now();a.profile&&V.info("createStreamlinesMesh profile",{"_createFlowFieldFromData()":Math.round(h-b),"_getStreamlines()":Math.round(c-h),"createAnimatedLinesData()":Math.round(d-c),"createLinesMesh()":Math.round(e-d),"Total elapsed time":Math.round(e-b)});yield Promise.resolve();Q.throwIfAborted(f);return g});return G.apply(this,arguments)}function T(a,c){const f=W(c.data,c.width,c.height,a.smoothing);return a.interpolate?(b,d)=>{const h=Math.floor(b),
g=Math.floor(d);if(0>h||h>=c.width||0>g||g>=c.height)return[0,0];b-=h;d-=g;const e=h<c.width-1?h+1:h,l=g<c.height-1?g+1:g;return[(f[2*(g*c.width+h)]*(1-d)+f[2*(l*c.width+h)]*d)*(1-b)+(f[2*(g*c.width+e)]*(1-d)+f[2*(l*c.width+e)]*d)*b,(f[2*(g*c.width+h)+1]*(1-d)+f[2*(l*c.width+h)+1]*d)*(1-b)+(f[2*(g*c.width+e)+1]*(1-d)+f[2*(l*c.width+e)+1]*d)*b]}:(b,d)=>{b=Math.round(b);d=Math.round(d);return 0>b||b>=c.width||0>d||d>=c.height?[0,0]:[f[2*(d*c.width+b)],f[2*(d*c.width+b)+1]]}}function X(a,c,f,b,d,h,g,
e,l){const t=[];let k=0,[m,n]=c(f,b);m*=a.velocityScale;n*=a.velocityScale;t.push({x:f,y:b,t:k,speed:Math.sqrt(m*m+n*n)});for(let z=0;z<a.verticesPerLine;z++){let [w,x]=c(f,b);w*=a.velocityScale;x*=a.velocityScale;const u=Math.sqrt(w*w+x*x);if(u<a.minSpeedThreshold)break;const y=w/u,A=x/u;f+=y*a.segmentLength;b+=A*a.segmentLength;k+=a.segmentLength/u;if(Math.acos(y*p+A*v)>a.maxTurnAngle)break;if(a.mergeLines){var p=Math.round(f*l);var v=Math.round(b*l);if(0>p||p>g-1||0>v||v>e-1)break;const r=h[v*
g+p];if(-1!==r&&r!==d)break;h[v*g+p]=d}t.push({x:f,y:b,t:k,speed:u});p=y;v=A}return t}function U(a,c,f,b){const d=[],h=new K,g=1/Math.max(a.lineCollisionWidth,1),e=Math.round(f*g),l=Math.round(b*g),t=new Int32Array(e*l);for(var k=0;k<t.length;k++)t[k]=-1;k=[];for(let m=0;m<b;m+=a.lineSpacing)for(let n=0;n<f;n+=a.lineSpacing)k.push({x:n,y:m,sort:h.getFloat()});k.sort((m,n)=>m.sort-n.sort);for(const {x:m,y:n}of k)h.getFloat()<a.density&&(f=X(a,c,m,n,d.length,t,e,l,g),2>f.length||d.push(f));return d}
function W(a,c,f,b){if(0===b)return a;const d=Math.round(3*b),h=Array(2*d+1);var g=0;for(var e=-d;e<=d;e++){var l=Math.exp(-e*e/(b*b));h[e+d]=l;g+=l}for(b=-d;b<=d;b++)h[b+d]/=g;g=new Float32Array(a.length);for(b=0;b<f;b++)for(e=0;e<c;e++){var t=l=0;for(var k=-d;k<=d;k++)if(!(0>e+k||e+k>=c)){var m=h[k+d];l+=m*a[2*(b*c+(e+k))];t+=m*a[2*(b*c+(e+k))+1]}g[2*(b*c+e)]=l;g[2*(b*c+e)+1]=t}a=new Float32Array(a.length);for(b=0;b<c;b++)for(e=0;e<f;e++){t=l=0;for(k=-d;k<=d;k++)0>e+k||e+k>=f||(m=h[k+d],l+=m*g[2*
((e+k)*c+b)],t+=m*g[2*((e+k)*c+b)+1]);a[2*(e*c+b)]=l;a[2*(e*c+b)+1]=t}return a}function L(a,c){const f=new K;var b=a.reduce((e,l)=>e+l.length,0);b=new Float32Array(4*b);const d=Array(a.length);let h=0,g=0;for(const e of a){a=h;for(const l of e)b[4*h]=l.x,b[4*h+1]=l.y,b[4*h+2]=l.t,b[4*h+3]=l.speed,h++;d[g++]={startVertex:a,numberOfVertices:e.length,totalTime:e[e.length-1].t,timeSeed:c?f.getFloat():0}}return{lineVertices:b,lineDescriptors:d}}function M(a,c=10){function f(p,v,z,w,x,u,y,A){const r=9*
l;let q=0;e[r+q++]=p;e[r+q++]=v;e[r+q++]=1;e[r+q++]=z;e[r+q++]=u;e[r+q++]=y;e[r+q++]=w/2;e[r+q++]=x/2;e[r+q++]=A;l++;e[r+q++]=p;e[r+q++]=v;e[r+q++]=-1;e[r+q++]=z;e[r+q++]=u;e[r+q++]=y;e[r+q++]=-w/2;e[r+q++]=-x/2;e[r+q++]=A;l++}const {lineVertices:b,lineDescriptors:d}=a;var h=a=0;for(var g of d)a+=2*g.numberOfVertices,h+=6*(g.numberOfVertices-1);const e=new Float32Array(9*a);g=new Uint32Array(h);let l=0;a=0;for(const p of d){const {totalTime:v,timeSeed:z}=p;let w=h=null,x=null;var t=null,k=null,m=
null;for(let u=0;u<p.numberOfVertices;u++){t=b[4*(p.startVertex+u)];const y=b[4*(p.startVertex+u)+1],A=b[4*(p.startVertex+u)+2],r=b[4*(p.startVertex+u)+3];let q=null,B=null;var n=null;let E=null;0<u&&(q=t-h,B=y-w,n=Math.sqrt(q*q+B*B),q/=n,B/=n,1<u?(k=q+k,m=B+m,n=Math.sqrt(k*k+m*m),k/=n,m/=n,n=Math.min(1/(k*q+m*B),c),k*=n,m*=n,n=-m,E=k):(n=-B,E=q),null!==n&&null!==E&&(f(h,w,x,n,E,v,z,r),g[a++]=l-2,g[a++]=l,g[a++]=l-1,g[a++]=l,g[a++]=l+1,g[a++]=l-1));h=t;w=y;x=A;k=q;m=B;t=r}f(h,w,x,-m,k,v,z,t)}return{vertexData:e,
indexData:g}}function N(a,c){const f=c.pixels,{width:b,height:d}=c;c=new Float32Array(b*d*2);if("vector-uv"===a)for(a=0;a<b*d;a++)c[2*a]=f[0][a],c[2*a+1]=-f[1][a];else if("vector-magdir"===a)for(a=0;a<b*d;a++){const h=f[0][a],g=P.deg2rad(f[1][a]),e=Math.sin(g-Math.PI/2);c[2*a]=Math.cos(g-Math.PI/2)*h;c[2*a+1]=e*h}return{data:c,width:b,height:d}}function H(){H=F._asyncToGenerator(function*(a,c,f,b,d,h){var g=R.getInfo(c.spatialReference);if(!g)return I(a,c,f,b,d,h);const [e,l]=g.valid;g=Math.ceil(c.width/
(l-e));const t=c.width/g,k=Math.round(f/g);let m=c.xmin;const n=[];for(let p=0;p<g;p++){const v=new S({xmin:m,xmax:m+t,ymin:c.ymin,ymax:c.ymax,spatialReference:c.spatialReference});n.push(I(a,v,k,b,d,h));m+=t}c=yield Promise.all(n);b={data:new Float32Array(f*b*2),width:f,height:b};a=0;for(const p of c){for(c=0;c<p.height;c++)for(d=0;d<p.width;d++)a+d>=f||(b.data[2*(c*f+a+d)]=p.data[2*(c*p.width+d)],b.data[2*(c*f+a+d)+1]=p.data[2*(c*p.width+d)+1]);a+=p.width}return b});return H.apply(this,arguments)}
function I(a,c,f,b,d,h){return J.apply(this,arguments)}function J(){J=F._asyncToGenerator(function*(a,c,f,b,d,h){const g={requestProjectedLocalDirections:!0,signal:h};D.isSome(d)&&(g.timeExtent=d);if("imagery"===a.type)return yield a.load({signal:h}),d=a.rasterInfo.dataType,a=yield a.fetchImage(c,f,b,g),!a||D.isNone(a.pixelData)||D.isNone(a.pixelData.pixelBlock)?{data:new Float32Array(f*b*2),width:f,height:b}:N(d,a.pixelData.pixelBlock);yield a.load({signal:h});d=a.rasterInfo.dataType;a=yield a.fetchPixels(c,
f,b,g);return!a||D.isNone(a.pixelBlock)?{data:new Float32Array(f*b*2),width:f,height:b}:N(d,a.pixelBlock)});return J.apply(this,arguments)}const V=O.getLogger("esri.views.2d.engine.flow.dataUtils");C.createAnimatedLinesData=L;C.createLinesMesh=M;C.createStreamlinesMesh=function(a,c,f){return G.apply(this,arguments)};C.fetchPart=I;C.loadImagery=function(a,c,f,b,d,h){return H.apply(this,arguments)};Object.defineProperty(C,"__esModule",{value:!0})});