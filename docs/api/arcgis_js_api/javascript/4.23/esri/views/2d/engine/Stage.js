// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/events ../../../core/has ../../../core/maybe ../../../core/scheduling ../../../core/watchUtils ../../../chunks/common ../../../chunks/mat2d ../../../chunks/mat2df64 ../../../chunks/mat3f32 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../symbols/cim/CIMResourceManager ./Container ./webgl/enums ./webgl/Painter ./webgl/Profiler ./webgl/shaders/StencilPrograms ../support/Timeline ../../support/screenshotUtils ../../webgl/BufferObject ../../webgl/context-util ../../webgl/enums ../../webgl/FramebufferObject ../../webgl/ProgramTemplate ../../webgl/RenderingContext ../../webgl/VertexArrayObject ../../webgl/VertexElementDescriptor".split(" "),
function(A,r,J,K,D,L,M,N,O,E,P,Q,n,u,R,F,v,S,T,G,U,B,H,V,h,I,W,X,Y,Z){let ea=function(C){function w(a,b){var c=C.call(this)||this;c._trash=new Set;c._clipData=new Float32Array(8);c._upperLeft=u.create();c._upperRight=u.create();c._lowerLeft=u.create();c._lowerRight=u.create();c._mat2=P.create();c._clipRendererInitialized=!1;c._renderRemainingTime=0;c._lastFrameRenderTime=0;c.renderRequested=!1;c.stage=r._assertThisInitialized(c);c._stationary=!0;const {canvas:d=document.createElement("canvas"),alpha:e=
!0,stencil:g=!0,contextOptions:f={}}=b;c._canvas=d;const l=V.createContextOrErrorHTML("2d",d,{alpha:e,antialias:!1,depth:!0,stencil:g});c.context=new X.RenderingContext(L.isSome(l)?l:null,f);c.resourceManager=new R;c.painter=new S(c.context,r._assertThisInitialized(c),c.resourceManager);D("esri-2d-profiler")&&(c._debugOutput=document.createElement("div"),c._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(c._debugOutput));c._renderParameters={drawPhase:0,
state:c.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:c.context,painter:c.painter,timeline:b.timeline||new U.Timeline,renderingOptions:b.renderingOptions,requireFBO:!1,profiler:new T.Profiler(c.context,c._debugOutput),dataUploadCounter:0};c._taskHandle=M.addFrameTask({render:m=>c.renderFrame(m)});c._taskHandle.pause();c._lostWebGLContextHandle=K.on(d,"webglcontextlost",()=>{c.emit("webgl-error",{error:new J("webgl-context-lost")})});
d.setAttribute("style","width: 100%; height:100%; display:block;");a.appendChild(d);return c}r._inheritsLoose(w,C);var k=w.prototype;k.destroy=function(){this.removeAllChildren();this._emptyTrash();this._taskHandle.remove();this._boundFBO=this._taskHandle=null;this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null);this._clipVAO&&(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null);this._lostWebGLContextHandle&&
(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null);this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas);this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput);this.highlightOptions=null;this.resourceManager.destroy();this.painter.dispose();this.context.dispose();this._canvas=null};k.trashDisplayObject=function(a){this._trash.add(a);this.requestRender()};k.untrashDisplayObject=function(a){return this._trash.delete(a)};
k.requestRender=function(){this._renderRemainingTime=2E3;this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())};k.renderFrame=function(a){this._renderRemainingTime-=this._lastFrameRenderTime?a.time-this._lastFrameRenderTime:0;0>=this._renderRemainingTime&&this._taskHandle.pause();this._lastFrameRenderTime=a.time;this.renderRequested=!1;this._renderParameters.state=this._state;this._renderParameters.stationary=this.stationary;this._renderParameters.pixelRatio=
window.devicePixelRatio;this._renderParameters.globalOpacity=1;this._renderParameters.time=a.time;this._renderParameters.deltaTime=a.deltaTime;this._renderParameters.effects=null;this.processRender(this._renderParameters);this._emptyTrash();this.emit("post-render")};k._createTransforms=function(){return{dvs:Q.create()}};k.renderChildren=function(a){for(const b of this.children)b.beforeRender(a);this._renderChildren(this.children,a);for(const b of this.children)b.afterRender(a)};k._renderChildren=
function(a,b){const c=this.context;b.profiler.recordStart("drawLayers");b.dataUploadCounter=0;this._beforeRenderChildren(b);b.drawPhase=v.WGLDrawPhase.MAP;this.painter.beforeRenderLayers(c,this.background);for(const d of a)d.processRender(b);this.painter.renderLayers(c);b.drawPhase=v.WGLDrawPhase.HIGHLIGHT;this.painter.beforeRenderLayers(c);for(const d of a)d.processRender(b);this.painter.renderLayers(c);if(this._isLabelDrawPhaseRequired(a)){b.drawPhase=v.WGLDrawPhase.LABEL;this.painter.beforeRenderLayers(c);
for(const d of a)d.processRender(b);this.painter.renderLayers(c)}if(D("esri-tiles-debug")){b.drawPhase=v.WGLDrawPhase.DEBUG;this.painter.beforeRenderLayers(c);for(const d of a)d.processRender(b);this.painter.renderLayers(c)}b.profiler.recordEnd("drawLayers");this._afterRenderChildren()};k._beforeRenderChildren=function(a){const {context:b}=this,{state:c,pixelRatio:d}=a;b.setClearDepth(1);b.setClearColor(0,0,0,0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT);const {size:e,rotation:g}=c;var f=
Math.round(e[0]*d);a=Math.round(e[1]*d);this._boundFBO=b.getBoundFramebufferObject();if(c.spatialReference.isWrappable){var l=O.toRadian(g),m=Math.abs(Math.cos(l)),p=Math.abs(Math.sin(l)),q=Math.round(c.worldScreenWidth);if(Math.round(f*m+a*p)<=q)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===f&&this._clipFBO.height===a||(this._clipFBO=new I.FramebufferObject(b,{colorTarget:h.TargetType.TEXTURE,depthStencilTarget:h.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:f,height:a}));
var aa=(this.state.padding.left-this.state.padding.right)/2,ba=(this.state.padding.bottom-this.state.padding.top)/2,ca=.5*f,da=.5*a,x=1/f,y=1/a;q=.5*q*d;var z=.5*(f*p+a*m);f=this._upperLeft;m=this._upperRight;p=this._lowerLeft;var t=this._lowerRight;n.set(f,-q,-z);n.set(m,q,-z);n.set(p,-q,z);n.set(t,q,z);E.fromTranslation(this._mat2,[ca+aa,da-ba]);0!==g&&E.rotate(this._mat2,this._mat2,l);n.transformMat2d(f,f,this._mat2);n.transformMat2d(m,m,this._mat2);n.transformMat2d(p,p,this._mat2);n.transformMat2d(t,
t,this._mat2);l=this._clipData;l.set([2*p[0]*x-1,2*(a-p[1])*y-1,2*t[0]*x-1,2*(a-t[1])*y-1,2*f[0]*x-1,2*(a-f[1])*y-1,2*m[0]*x-1,2*(a-m[1])*y-1]);this._clipRendererInitialized||this._initializeClipRenderer(b);this._clipVBO.setData(l);this._boundFBO=b.getBoundFramebufferObject();b.bindFramebuffer(this._clipFBO);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT|b.gl.STENCIL_BUFFER_BIT);
b.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1};k._afterRenderChildren=function(){const a=this.context;a.logIno();if(this._clipFrame&&this._clipRendererInitialized){a.bindFramebuffer(this._boundFBO);this._boundFBO=null;a.bindVAO(this._clipVAO);a.useProgram(this._clipStencilProgram);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);a.setStencilTestEnabled(!0);a.setBlendingEnabled(!1);a.setColorMask(!1,!1,!1,!1);a.setStencilOp(h.StencilOperation.KEEP,h.StencilOperation.KEEP,
h.StencilOperation.REPLACE);a.setStencilWriteMask(255);a.setStencilFunction(h.CompareFunction.ALWAYS,1,255);a.drawElements(h.PrimitiveType.TRIANGLES,6,h.DataType.UNSIGNED_SHORT,0);a.bindVAO();a.setColorMask(!0,!0,!0,!0);if(null!=this.background){const {r:b,g:c,b:d,a:e}=this.background.color;a.setClearColor(e*b/255,e*c/255,e*d/255,e)}else a.setClearColor(0,0,0,0);a.clear(a.gl.COLOR_BUFFER_BIT);a.setBlendingEnabled(!0);a.setStencilFunction(h.CompareFunction.EQUAL,1,255);this.painter.blitTexture(a,this._clipFBO.colorTexture,
h.TextureSamplingMode.NEAREST,1);a.setStencilTestEnabled(!1)}};k.doRender=function(a){const b=this.context,{state:c,pixelRatio:d}=a;this._resizeCanvas(a);b.setViewport(0,0,d*c.size[0],d*c.size[1]);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);C.prototype.doRender.call(this,a)};k.takeScreenshot=function(){var a=r._asyncToGenerator(function*(b){const {framebufferWidth:c,framebufferHeight:d}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*b.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*
b.resolutionScale)};var e=this.context,g=this._state.clone();if(null!=b.rotation){var f=g.viewpoint;g.viewpoint.rotation=b.rotation;g.viewpoint=f}var l={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:g,pixelRatio:1,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};const m=new I.FramebufferObject(e,{colorTarget:h.TargetType.TEXTURE,depthStencilTarget:h.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:c,height:d});g=e.getBoundFramebufferObject();
f=e.getViewport();e.bindFramebuffer(m);e.setViewport(0,0,c,d);this._renderChildren(b.children,l);l=this._readbackScreenshot(m,{...b.cropArea,y:d-(b.cropArea.y+b.cropArea.height)});e.bindFramebuffer(g);e.setViewport(f.x,f.y,f.width,f.height);this.requestRender();e=yield l;1===b.outputScale?g=e:(g=new ImageData(Math.round(e.width*b.outputScale),Math.round(e.height*b.outputScale)),B.resampleHermite(e,g,!0));return B.encodeResult(g,{format:b.format,quality:b.quality,rotation:0,disableDecorations:!1},
document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})});return function(b){return a.apply(this,arguments)}}();k._readbackScreenshot=function(){var a=r._asyncToGenerator(function*(b,c){const d=B.createEmptyImageData(c.width,c.height,document.createElement("canvas"));yield b.readPixelsAsync(c.x,c.y,c.width,c.height,h.PixelFormat.RGBA,h.PixelType.UNSIGNED_BYTE,new Uint8Array(d.data.buffer));return d});return function(b,c){return a.apply(this,arguments)}}();k._resizeCanvas=function(a){const b=
this._canvas,c=b.style,{state:{size:d},pixelRatio:e}=a;a=d[0];const g=d[1],f=Math.round(a*e),l=Math.round(g*e);if(b.width!==f||b.height!==l)b.width=f,b.height=l;c.width=a+"px";c.height=g+"px"};k._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;const b=W.createProgram(a,G.stencil);if(!b)return!1;const c=H.BufferObject.createVertex(a,h.Usage.STREAM_DRAW,this._clipData);var d=new Uint16Array([0,1,2,2,1,3]);d=H.BufferObject.createIndex(a,h.Usage.STATIC_DRAW,d);const e=G.stencil.attributes,
g={geometry:[new Z.VertexElementDescriptor("a_pos",2,h.DataType.FLOAT,0,8)]};a=new Y.VertexArrayObject(a,e,g,{geometry:c},d);this._clipStencilProgram=b;this._clipVBO=c;this._clipVAO=a;return this._clipRendererInitialized=!0};k._emptyTrash=function(){for(;0<this._trash.size;){const a=Array.from(this._trash);this._trash.clear();for(const b of a)b.processDetach()}};k._isLabelDrawPhaseRequired=function(a){let b=!1;for(const c of a){if(!(c instanceof F.Container)){b=b||!1;break}if(c.hasLabels)return!0;
b=b||this._isLabelDrawPhaseRequired(c.children)}return b};r._createClass(w,[{key:"background",get:function(){return this._background},set:function(a){this._background=a;this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(a){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null);if(this._highlightOptions=a)this._highlightOptionsHandle=N.init(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(a);
this.requestRender()})}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(a){this._renderingOptions=a;this.requestRender()}},{key:"state",get:function(){return this._state},set:function(a){this._state=a;this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())}}]);return w}(F.Container);A.EXTRA_RENDER_TIME=2E3;A.Stage=ea;Object.defineProperty(A,"__esModule",{value:!0})});