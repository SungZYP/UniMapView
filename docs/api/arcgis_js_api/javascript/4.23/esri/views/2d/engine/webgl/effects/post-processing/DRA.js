// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/Logger ../../VertexStream ../../../../../webgl/enums ../../../../../webgl/FramebufferObject ../../../../../webgl/Texture".split(" "),function(z,v,E,c,F,G){const H=v.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA");v=function(){function A(){this._fbos=null;this._colorAttachmentsPoints=[c.ColorAttachment.COLOR_ATTACHMENT0,c.ColorAttachment.COLOR_ATTACHMENT1];this._size=[0,0];this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",
attributes:new Map([["a_position",0]])},dra:{vsPath:"post-processing/pp",fsPath:"post-processing/dra",attributes:new Map([["a_position",0]])}}}var q=A.prototype;q.dispose=function(){this._disposeFBOs();this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)};q.draw=function(b,g,l){this._createOrResizeResources(b);const {context:a,state:e,painter:f,pixelRatio:h}=b;({materialManager:l}=f);const B=this._programDesc;var {size:m}=e;const C=this._fbos,k=[h*m[0],h*m[1]],D=a.capabilities.drawBuffers;
if(D){this._quad||(this._quad=new E(a,[-1,-1,1,-1,-1,1,1,1]));m=this._layerTexture;g.copyToTexture(0,0,k[0],k[1],0,0,m);var r=this._quad;r.bind();var n=l.getProgram(b,B["min-max"]);a.useProgram(n);a.setBlendingEnabled(!1);var w=g.colorTexture,x=g.colorTexture,y=[k[0],k[1]],p=[0,0];for(let t=0;t<C.length;t++){const u=C[t];var d=u.descriptor;p[0]=d.width;p[1]=d.height;a.bindFramebuffer(u);D.drawBuffers(this._colorAttachmentsPoints);a.setViewport(0,0,d.width,d.height);d=t;6<d&&(d=6);a.bindTexture(w,
d);a.bindTexture(x,d+1);n.setUniform1i("u_minTexture",d);n.setUniform1i("u_maxTexture",d+1);n.setUniform2fv("u_srcResolution",y);n.setUniform2fv("u_dstResolution",p);r.draw();w=u.getColorTexture(c.ColorAttachment.COLOR_ATTACHMENT0);x=u.getColorTexture(c.ColorAttachment.COLOR_ATTACHMENT1);y[0]=p[0];y[1]=p[1]}a.setViewport(0,0,k[0],k[1]);a.bindFramebuffer(g);b=l.getProgram(b,B.dra);a.useProgram(b);a.bindTexture(w,5);a.bindTexture(x,6);a.bindTexture(m,7);b.setUniform1i("u_minColor",5);b.setUniform1i("u_maxColor",
6);b.setUniform1i("u_texture",7);a.setStencilWriteMask(0);a.setStencilTestEnabled(!1);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);r.draw();a.setBlendingEnabled(!0);a.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setStencilTestEnabled(!0);r.unbind()}else H.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!")};q._createOrResizeResources=function(b){const {context:g,state:l,pixelRatio:a}=b;({size:b}=l);let e=Math.round(a*b[0]),f=Math.round(a*b[1]);
if(this._size[0]!==e||this._size[1]!==f){this._size[0]=e;this._size[1]=f;this._disposeFBOs();for(this._fbos=[];1<e||1<f;){e=Math.max(1,Math.floor((e+2-1)/2)|0);f=Math.max(1,Math.floor((f+2-1)/2)|0);var h={pixelFormat:c.PixelFormat.RGBA,internalFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.NEAREST,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,flipped:!1,width:e,height:f};h=new F.FramebufferObject(g,{depthStencilTarget:c.DepthStencilTargetType.NONE,width:e,
height:f},[h,h]);this._fbos.push(h)}this._layerTexture?this._layerTexture.resize(Math.round(a*b[0]),Math.round(a*b[1])):this._layerTexture=new G.Texture(g,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,internalFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c.TextureSamplingMode.LINEAR,flipped:!1,width:Math.round(a*b[0]),height:Math.round(a*b[1])})}};q._disposeFBOs=function(){if(this._fbos){for(const b of this._fbos)b.dispose();
this._fbos.length=0;this._fbos=null}};return A}();z.DRA=v;Object.defineProperty(z,"__esModule",{value:!0})});