// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Accessor ../../../core/maybe ../../../core/ObjectPool ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferView ../../../support/requestImageUtils ../../ViewingMode ./interfaces ./LayerClass ./Overlay ./OverlayRenderer ./PatchGeometryFactory ./PatchRenderData ./RenderOrder ./ScaleRangeQueries ./TerrainConst ./TileRenderer ./TileUpdate ./tileUtils ../webgl-engine/collections/Component/ComponentIntersectionData ../webgl-engine/core/shaderLibrary/ShaderOutputOptions ../webgl-engine/core/shaderLibrary/Slice.glsl ../webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl ../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl ../webgl-engine/core/shaderLibrary/util/View.glsl ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Material ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/VertexAttribute ../webgl-engine/lib/verticalOffsetUtils ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainTechnique ../../webgl/enums".split(" "),
function(ka,p,va,n,h,wa,t,Ta,Ua,Va,xa,ya,la,L,H,ma,fa,za,Aa,Ba,S,Ca,u,na,X,Da,oa,Ea,Fa,Ga,Y,ha,Z,M,Ha,Ia,N,Ja,Ka,La,Ma,aa,pa,q,E,Na,Oa,qa,ia,ra,ba){function sa(I,x,d){d[0]=I[0]*x[2]+x[0];d[1]=I[1]*x[3]+x[1];d[2]=I[2]*x[2];d[3]=I[3]*x[3]}const ca=fa.create(),da=ma.create();n=function(I){function x(a){a=I.call(this,a)||this;a.type=aa.IntersectorType.TERRAIN;a.isGround=!0;a.tileSize=256;a.rctx=null;a._isTransparent=!1;a._scaleRangeQueries=new Ea.ScaleRangeQueries;a.renderDataPool=new wa(Da.PatchRenderData);
a._patchGroups=new Map;a.patchGroupsDirty=!0;a.tileIterator=new ha.IteratorPreorder;a.highestVisibleLODTile=null;a.visible=!0;a._opaque=!0;a._skirtScale=1;a._velvetOverground=!0;a.castShadows=!0;a._ssrEnabled=!1;a.emptyTex=null;a.tileRenderer=null;a.tileBackgroundInitialized=!1;a.tileBackgroundUpdating=!1;a.stencilEnabledLayerExtents=[];a.numTilesRendered=0;a.numTilesCulled=0;a.numOriginsRendered=0;a.overlayOpacity=1;a.needsHighlight=!1;a.renderOccludedFlags=pa.RenderOccludedFlag.Occlude;return a}
ka._inheritsLoose(x,I);var d=x.prototype;d.initialize=function(){this.stage.addRenderPlugin([E.RenderSlot.OPAQUE_TERRAIN,E.RenderSlot.TRANSPARENT_TERRAIN,E.RenderSlot.OCCLUDED_TERRAIN],this)};d.destroy=function(){this.stage.removeRenderPlugin(this);X.clearCaches()};d.setDebugScreenSizePerspective=function(a){this.shaderTechniqueConfig.screenSizePerspective!==a&&(this.shaderTechniqueConfig.screenSizePerspective=a,this.setNeedsRender())};d.setRootTiles=function(a){this._rootTiles=a;this.setNeedsRender()};
d.setNeedsHighlight=function(a){this.needsHighlight=a;this.setNeedsRender()};d.setRenderOccludedOverlay=function(a){this.renderOccludedFlags=a?na.overlayRenderOccludedFlag:pa.RenderOccludedFlag.Occlude;this.setNeedsRender()};d.setStencilEnabledLayerExtents=function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};d.setTileSize=function(a){this.tileSize=a;this.tileRenderer&&(this.tileRenderer.tileSize=a);this.setNeedsRender()};d.loadTile=function(a){a.renderData||(a.renderData=this.renderDataPool.acquire(),
a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a));this.updateTileGeometry(a);this.updateTileTexture(a,Y.TileUpdate.TEXTURE_FADING)};d.queryVisibleLevelRange=function(a,b,c,f){this._scaleRangeQueries.queryVisibleLevelRange(a,b,c,f);this.setNeedsRender()};d.updateTileTexture=function(a,b){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(a,b===Y.TileUpdate.TEXTURE_FADING?S.TextureUpdate.FADING:S.TextureUpdate.UNFADED),this.setNeedsRender(),
a.resetPendingUpdate(b))};d.updateTileGeometry=function(a){for(const b of a.layerInfo[Ca.LayerClass.ELEVATION])b.pendingUpdates&=~Y.TileUpdate.GEOMETRY;a.resetPendingUpdate(Y.TileUpdate.GEOMETRY);a.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()};d.unloadTile=function(a){a.renderData&&(a.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(a.renderData),a.renderData.clear(),a.renderData=null,a.setMemoryDirty(),this.setNeedsRender())};d._getLocalOriginOfTile=
function(a){const b=Math.max(0,7*Math.floor((a.level-3)/7));if(this.isGlobal&&0===b)return H.ZEROS;for(;a.parent&&a.level>b;)a=a.parent;return a.centerAtSeaLevel};d.setVisibility=function(a){this.visible=a;this.setNeedsRender()};d.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}};d.setNeedsRender=function(a=Ka.RenderRequestType.UPDATE){this.patchGroupsDirty=!0;this.context.requestRender(a)};d.setTileBackground=
function(a){this.tileBackground=a;this._updateTileBackground()};d.initializeRenderContext=function(a){this.context=a;this.rctx=a.renderContext.rctx;this.shaderTechniques=a.shaderTechniqueRepository;this.shaderTechniqueConfig=new ra.TerrainTechniqueConfiguration;this.tileRenderer=new Ga.TileRenderer(this.rctx,this.tileSize,this.shaderTechniques);this.tileBackground&&this._updateTileBackground();this.emptyTex=La.createEmptyTexture(this.rctx)};d.uninitializeRenderContext=function(){null!=this.emptyTex&&
(this.emptyTex.dispose(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};d.intersect=function(a,b,c,f){if(this._rootTiles&&(!a.options.selectOpaqueTerrainOnly||!a.options.selectionMode||this._opaque)){var g=Pa,k=Qa;L.subtract(g,f,c);L.set(k,1/g[0],1/g[1],1/g[2]);var e=a.results.min,F=a.results.max,T=a.results.ground,O=a.options.store===aa.StoreResults.MIN,ja=!!a.results.ground.target,v=qa.getVerticalOffsetTerrain(a.verticalOffset),z=this._skirtScale,w=
a.tolerance,y,J=O&&h.isSome(e.dist)?e.dist:Infinity,R=A=>{var r=A.renderData;if(null!=r){var l=r.geometryInfo;fa.set(ca,l.boundingBox);r=r.localOrigin;h.isSome(v)&&(v.localOrigin=r,v.applyToAabb(ca));var G=-z*l.skirtLength;if(0!==G){var B=A.up;fa.expandWithOffset(ca,G*B[0],G*B[1],G*B[2])}C[0]=c[0]-r[0];C[1]=c[1]-r[1];C[2]=c[2]-r[2];if(ia.intersectAabbInvDirBefore(ca,C,k,w,J)){var U=(m,D,Ra)=>{m.set(this.type,A,D,Ra,la.IDENTITY);J=O&&h.isSome(e.dist)?e.dist:Infinity};B=(m,D)=>{h.isSome(D)&&0<=m&&(a.options.backfacesTerrain||
0>L.dot(D,g))&&(a.options.invisibleTerrain||!a.options.selectionMode||null==b||b(c,f,m))&&((null==T.dist||m<T.dist)&&U(T,m,D),a.options.isFiltered||(a.options.store===aa.StoreResults.ALL&&(h.isNone(y)?(y=Ma.newIntersectorResult(a.ray),U(y,m,D),a.results.all.push(y)):m<y.dist&&U(y,m,D)),(null==e.dist||m<e.dist)&&U(e,m,D),a.options.store!==aa.StoreResults.MIN&&(null==F.dist||m>F.dist)&&U(F,m,D)))};var P=Sa;L.subtract(P,f,r);var Q=l.indices,V=l.vertexAttributes,W={data:V.getField(Oa.VertexAttribute.POSITION,
za.BufferViewVec3f).typedBuffer,size:3,stride:V.stride/4};l=l.numWithoutSkirtIndices/3;if(!h.isSome(v)&&l>Z.componentMinimalSizeForIntersectionData){var K=A.renderData;h.isSome(K.intersectionData)||(K.intersectionData=new Z.ComponentIntersectionData(Q,0,l,W));K.intersectionData.intersectRay({r0:C,r1:P},B)}else ia.intersectTriangles(C,P,0,l,Q,W,null,v,B);if(0!==G){const m=Q.length/3;this.isGlobal?(W=m-l,!h.isSome(v)&&W>Z.componentMinimalSizeForIntersectionData?(K=A.renderData,h.isSome(K.skirtIntersectionData)||
(r=X.getGlobalSkirtGeometry(Q,l,m,V,G,r),K.skirtIntersectionData=new Z.ComponentIntersectionData(r.indices,0,W,{data:r.vertices,stride:3})),K.skirtIntersectionData.intersectRay({r0:C,r1:P},B)):X.intersectSkirtsGlobal(C,P,l,m,Q,V,G,r,v,B)):X.intersectSkirtsLocal(C,P,l,m,Q,V,G,v,B)}}}},ta=this._rootTiles;h.isSome(ta)&&(()=>{const A=this.tileIterator;A.reset(ta);const r=a.options.invisibleTerrain;for(;!A.done;){const l=A.next();!(l.visible||r&&l.intersectsClippingArea)||!h.isSome(v)&&!l.intersectsRay(c,
g,w,J,z)||ja&&this._useStencilForTile(l)?A.skipSubtree():R(l)}})()}};d.prepareTechnique=function(a){if(a.slot===E.RenderSlot.OCCLUDED_TERRAIN){if(0===(a.renderOccludedMask&na.overlayRenderOccludedFlag))return null}else if(a.slot!==(this.opaque?E.RenderSlot.OPAQUE_TERRAIN:E.RenderSlot.TRANSPARENT_TERRAIN))return null;switch(a.pass){case q.RenderPass.MATERIAL:var b=a.shadowMap&&a.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==b&&(this.shaderTechniqueConfig.receiveShadows=b);b=this.overlayRenderer.isEmpty()?
N.OverlayMode.Disabled:this.overlayRenderer.hasWater?N.OverlayMode.EnabledWithWater:N.OverlayMode.Enabled;this.shaderTechniqueConfig.overlayMode!==b&&(this.shaderTechniqueConfig.overlayMode=b);return this._updateTechnique(M.ShaderOutput.Color,(a.slot===E.RenderSlot.OCCLUDED_TERRAIN?u.OverlaySource.Occluded:u.OverlaySource.ColorAndWater)===u.OverlaySource.Occluded);case q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL:case q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:if(this.castShadows&&1===a.scenelightingData.globalFactor)return this._updateTechnique(M.ShaderOutput.Shadow,
!1);break;case q.RenderPass.MATERIAL_DEPTH:if(!this.isTransparent||!this.overlayRenderer.isEmpty())return this._updateTechnique(M.ShaderOutput.Depth,!1);break;case q.RenderPass.MATERIAL_NORMAL:return this._updateTechnique(M.ShaderOutput.Normal,!1);case q.RenderPass.MATERIAL_HIGHLIGHT:if(this.needsHighlight)return this._updateTechnique(M.ShaderOutput.Highlight,!1)}return null};d.render=function(a,b){const c=a.pass,f=1===a.scenelightingData.globalFactor;this._updatePatchGroups();b.useStencil=!1;switch(c){case q.RenderPass.MATERIAL:this._renderMaterialPass(a,
b,a.slot===E.RenderSlot.OCCLUDED_TERRAIN?u.OverlaySource.Occluded:u.OverlaySource.ColorAndWater);break;case q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL:case q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this.castShadows&&f&&this._renderAuxiliaryPass(a,b,u.OverlaySource.None);break;case q.RenderPass.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(a,b,u.OverlaySource.None);break;case q.RenderPass.MATERIAL_NORMAL:this._renderAuxiliaryPass(a,b,u.OverlaySource.None);
break;case q.RenderPass.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(a,b,u.OverlaySource.Highlight),a.rctx.clearSafe(ba.ClearBufferBit.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()};d._renderMaterialPass=function(a,b,c){const {rctx:f,camera:g}=a;this._ssrEnabled=a.ssrParams.ssrEnabled;const k=f.useTechnique(b,a.slot);this.shaderTechniqueConfig.overlayMode!==N.OverlayMode.Disabled&&c===u.OverlaySource.ColorAndWater&&a.ssrParams&&Ia.bindSSRUniforms(k,
a.ssrParams);a.shadowMap.bind(k);a.ssaoHelper.bind(k,a.camera);this._bindOverlayData(k,c);k.setUniformMatrix4fv("viewNormal",g.viewInverseTransposeMatrix);Ja.bindProjectionMatrix(k,g.projectionMatrix);a.scenelightingData.setUniforms(k,!0,!1);const e=g.viewMatrix;L.set(ea,e[12],e[13],e[14]);L.normalize(ea,ea);k.setUniform3fv("viewDirection",ea);this.numOriginsRendered=this.numTilesCulled=this.numTilesRendered=0;this._scaleRangeQueries.prepareQueries();this.opaque?this._renderPatchGroups(a,b,c):a.offscreenRenderingHelper.renderToTargets(()=>
this._renderPatchGroups(a,b,c),a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,0,0,0]);this._scaleRangeQueries.processQueries()};d._renderAuxiliaryPass=function(a,b,c){const f=a.rctx.useTechnique(b,a.slot);if(a.pass===q.RenderPass.MATERIAL_HIGHLIGHT){const g=a.offscreenRenderingHelper;f.bindTexture(g.depthTexture,"depthTex");f.setUniform4f("highlightViewportPixelSz",0,0,1/g.width,1/g.height)}else f.setUniformMatrix4fv("viewNormal",a.camera.viewInverseTransposeMatrix),a.pass!==
q.RenderPass.MATERIAL_DEPTH&&a.pass!==q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL&&a.pass!==q.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT||f.setUniform2fv("nearFar",a.camera.nearFar);this._renderPatchGroupsAuxiliary(a,b,c)};d._updateTileBackground=function(){if(this.tileRenderer){this.tileBackgroundUpdating=!0;var a=()=>{this.tileBackgroundInitialized=!0;this.tileBackgroundUpdating=!1;this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid;this.shaderTechniqueConfig.hasBackgroundColor=
!this.tileRenderer.backgroundIsGrid&&!!h.isSome(this.tileRenderer.backgroundColor);this.allTiles.forAll(b=>this.tileRenderer.updateTileTexture(b,S.TextureUpdate.FADING));this.setNeedsRender()};if("string"===typeof this.tileBackground){const b=this.tileBackground;Aa.requestImage(b).then(c=>{b===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(c,this.tileBackground===Fa.DEFAULT_TILE_BACKGROUND),a())})}else{const b=this.tileBackground?va.toUnitRGBA(this.tileBackground):[0,0,0,
0];this.tileRenderer.setBackground(b,!1);a()}}};d._updatePatchGroups=function(){if(this.patchGroupsDirty){this.highestVisibleLODTile=null;this._rebuildPatchGroups();if(this.renderOrder!==oa.RenderOrder.NONE){const a=Array.from(this._patchGroups.values());a.forEach(b=>ha.sortTiles(this.renderOrder,b));a.sort((b,c)=>ha.compareTiles(b[0],c[0],this.renderOrder));this._patchGroups=new Map(a.map(b=>[b[0].renderData.localOrigin,b]))}this.patchGroupsDirty=!1}};d._rebuildPatchGroups=function(){const a=this._rootTiles;
if(!h.isNone(a)){this._patchGroups.clear();for(const b of a)this._rebuildPatchGroupsForRootTile(b)}};d._rebuildPatchGroupsForRootTile=function(a){const b=this.tileIterator;for(b.resetOne(a);!b.done;){a=b.next();const c=a.renderData;if(c&&!a.visible)this.numTilesCulled++,b.skipSubtree();else if(!a.rendered)this.numTilesCulled++;else if(c){const f=this._patchGroups.get(c.localOrigin)||[];this._patchGroups.set(c.localOrigin,f);f.push(a);if(!this.highestVisibleLODTile||a.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=
a;b.skipSubtree()}}};d._useStencilForTile=function(a){for(const b of this.stencilEnabledLayerExtents)if(a.intersectsExtent(b))return!0;return!1};d._renderPatchGroupsAuxiliary=function(a,b,c){b.program.setUniformMatrix4fv("proj",a.camera.projectionMatrix);b.program.setUniform1f("skirtScale",this._skirtScale);c!==u.OverlaySource.None&&this._bindOverlayData(b.program,c);const f=0<this.stencilEnabledLayerExtents.length;this._patchGroups.forEach(g=>{this._bindPatchGroupData(b.program,g[0].renderData.localOrigin,
a.camera.eye,a.camera.viewMatrix);for(let k=0;k<g.length;k++)this._renderPatch(a,b,g[k],ba.PrimitiveType.TRIANGLES,f,c)});a.rctx.bindVAO(null)};d._renderPatchGroups=function(a,b,c){const f=a.rctx,g=a.camera,k=g.viewMatrix,e=b.program;if(this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){var F=Na.getSettings(this.stage.viewingMode,this.ellipsoidRadius);F.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:g.fovY});ia.bindScreenSizePerspective(F,e,"screenSizePerspective")}const T=
0<this.stencilEnabledLayerExtents.length,O=c===u.OverlaySource.Occluded;O&&(e.bindTexture(this.emptyTex,"tex"),e.setUniform1f("blend",1),e.setUniform4fv("texOffsetAndScale",ma.ZEROS));F=h.isSome(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:H.ZEROS;this.shaderTechniqueConfig.hasBackgroundColor&&e.setUniform3fv("backgroundColor",F);e.setUniform1f("skirtScale",O?0:this._skirtScale);const ja=this.wireframe?ba.PrimitiveType.LINES:ba.PrimitiveType.TRIANGLES;this.shaderTechniqueConfig.textureFadingEnabled&&
e.bindTexture(this.emptyTex,"texNext");this._patchGroups.forEach(v=>{var z=v[0].renderData.localOrigin;this._bindPatchGroupData(e,z,g.eye,k);Ha.bindSliceUniforms(e,b.configuration,a.sliceHelper&&a.sliceHelper.plane,{origin:z});a.shadowMap&&a.shadowMap.bindView(e,z);this.numOriginsRendered++;for(z=0;z<v.length;z++){const w=v[z],y=w.renderData.textureReference;if(!h.isNone(y)){if(!O){this._scaleRangeQueries.scaleQueriesForTile(w);sa(w.renderData.geometryInfo.uvOffsetAndScale,y.offsetAndScale,da);e.setUniform4fv("texOffsetAndScale",
da);e.bindTexture(y.texture.texture,"tex");const J=w.renderData.textureFadeFactor,R=1>J?w.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&h.isSome(R)&&1>J?(sa(w.renderData.geometryInfo.uvOffsetAndScale,R.offsetAndScale,da),e.setUniform1f("fadeFactor",J),e.setUniform4fv("nextTexOffsetAndScale",da),e.setUniform3fv("nextTexOpacities",R.opacities),e.bindTexture(R.texture.texture,"texNext")):e.setUniform1f("fadeFactor",1);w.renderData.textureIsFading&&this.setNeedsRender();
e.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(a,b,w,ja,T,c);w.renderOrder=this.numTilesRendered;this.numTilesRendered++}}});f.bindVAO(null)};d._renderPatch=function(a,b,c,f,g,k){if(!h.isNone(c.renderData.vao.indexBuffer)){var e=b.program;k!==u.OverlaySource.None&&this._bindOverlayPatchData(e,c.renderData.overlay);g&&(b.useStencil=this._useStencilForTile(c),b.bindPipelineState(a.rctx,a.slot));b=0===this._skirtScale?c.renderData.geometryInfo.numWithoutSkirtIndices:c.renderData.vao.indexBuffer.size;
a.rctx.bindVAO(c.renderData.vao);e.assertCompatibleVertexAttributeLocations(c.renderData.vao);a.rctx.drawElements(f,b,c.renderData.vao.indexBuffer.indexType,0)}};d._bindPatchGroupData=function(a,b,c,f){a.setUniform3fv("origin",b);ya.translate(ua,f,b);a.setUniformMatrix4fv("view",ua);a.setUniform3f("cameraPosition",c[0]-b[0],c[1]-b[1],c[2]-b[2])};d._bindOverlayData=function(a,b){if(this.shaderTechniqueConfig.overlayMode!==N.OverlayMode.Disabled){a.setUniform1f("overlayOpacity",this.overlayOpacity);
var c=this.overlayRenderer.overlays;if(c.length>S.OverlayIndex.INNER){c=c[S.OverlayIndex.INNER];const f=c.getColorTexture(b);a.bindTexture(h.isSome(f)?f:this.emptyTex,"ovColorTex");this.shaderTechniqueConfig.overlayMode===N.OverlayMode.EnabledWithWater&&(b=c.getNormalTexture(b),a.bindTexture(h.isSome(b)?b:this.emptyTex,"ovWaterTex"))}}};d._bindOverlayPatchData=function(a,b){a.setUniform4fv("overlayTexOffset",b.offsets);a.setUniform4fv("overlayTexScale",b.scales)};d._updateTechnique=function(a,b){this.shaderTechniqueConfig.output=
a;a===M.ShaderOutput.Color&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled);this.shaderTechniqueConfig.renderOccluded=b;this.shaderTechniqueConfig.stencilEnabled=!1;return this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(ra.TerrainTechnique,this.shaderTechniqueConfig,this._shaderTechnique)};ka._createClass(x,[{key:"isGlobal",get:function(){return this.stage.viewingMode===Ba.ViewingMode.Global}},{key:"updating",
get:function(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}},{key:"canRender",get:function(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}},{key:"renderingDisabled",set:function(a){this._set("renderingDisabled",!!a);this.setNeedsRender()}},{key:"opaque",get:function(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled},set:function(a){this._opaque!==a&&(this._opaque=a,this.setNeedsRender())}},{key:"needsLinearDepth",
get:function(){return this.overlayRenderer.hasWater}},{key:"isTransparent",get:function(){return this._isTransparent},set:function(a){this._isTransparent!==a&&(this._isTransparent=a,this.setNeedsRender())}},{key:"skirtScale",get:function(){return this._skirtScale},set:function(a){a!==this._skirtScale&&(this._skirtScale=a,this.setNeedsRender())}},{key:"renderPatchBorders",get:function(){return!!this.shaderTechniqueConfig.tileBorders},set:function(a){this.shaderTechniqueConfig.tileBorders!==a&&(this.shaderTechniqueConfig.tileBorders=
a,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}},{key:"cullBackFaces",get:function(){return this.shaderTechniqueConfig.backfaceCullingEnabled},set:function(a){this.shaderTechniqueConfig.backfaceCullingEnabled!==a&&(this.shaderTechniqueConfig.backfaceCullingEnabled=a,this.notifyChange("cullBackFaces"),this.setNeedsRender())}},{key:"renderOrder",set:function(a){this._set("renderOrder",a);this.setNeedsRender()}},{key:"velvetOverground",set:function(a){this._velvetOverground!==a&&(this._velvetOverground=
a,this.setNeedsRender())}},{key:"layerUid",get:function(){return qa.TERRAIN_ID}},{key:"slicePlaneEnabled",get:function(){return this.shaderTechniqueConfig.slicePlaneEnabled},set:function(a){this.shaderTechniqueConfig.slicePlaneEnabled!==a&&(this.shaderTechniqueConfig.slicePlaneEnabled=a,this.setNeedsRender())}},{key:"textureFadingEnabled",set:function(a){this.shaderTechniqueConfig.textureFadingEnabled!==a&&(this.shaderTechniqueConfig.textureFadingEnabled=a,this.setNeedsRender())}},{key:"wireframe",
set:function(a){this._get("wireframe")!==a&&(this._set("wireframe",a),this.allTiles.forAll(b=>{var c;return null==(c=b.renderData)?void 0:c.updateGeometry(this.rctx,a)}),this.setNeedsRender())}},{key:"test",get:function(){return{tileRenderer:this.tileRenderer}}}]);return x}(n);p.__decorate([t.property()],n.prototype,"tileBackgroundInitialized",void 0);p.__decorate([t.property()],n.prototype,"tileBackgroundUpdating",void 0);p.__decorate([t.property({constructOnly:!0})],n.prototype,"overlayRenderer",
void 0);p.__decorate([t.property({constructOnly:!0})],n.prototype,"stage",void 0);p.__decorate([t.property({readOnly:!0})],n.prototype,"isGlobal",null);p.__decorate([t.property({constructOnly:!0})],n.prototype,"allTiles",void 0);p.__decorate([t.property({constructOnly:!0})],n.prototype,"ellipsoidRadius",void 0);p.__decorate([t.property({readOnly:!0})],n.prototype,"updating",null);p.__decorate([t.property({value:!1})],n.prototype,"renderingDisabled",null);p.__decorate([t.property()],n.prototype,"renderPatchBorders",
null);p.__decorate([t.property()],n.prototype,"cullBackFaces",null);p.__decorate([t.property({value:oa.RenderOrder.FRONT_TO_BACK})],n.prototype,"renderOrder",null);p.__decorate([t.property()],n.prototype,"wireframe",null);p=n=p.__decorate([xa.subclass("esri.views.3d.terrain.TerrainRenderer")],n);const ua=la.create(),ea=H.create(),Pa=H.create(),Qa=H.create(),C=H.create(),Sa=H.create();return p});