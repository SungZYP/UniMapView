// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../geometry ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/screenUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec3f64 ../../../../../layers/graphics/hydratedFeatures ../../../analysis/support/measurementUtils ../../editingTools/dragEventPipeline3D ./DirectLineMeasurement3DView ./PickRequest ../../../support/ElevationProvider ../../../webgl-engine/lib/Intersector ../../../webgl-engine/lib/IntersectorInterfaces ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../support/screenUtils ../../../../../geometry/Point".split(" "),
function(v,f,d,C,c,w,D,g,R,S,T,E,F,G,H,p,I,x,J,K,L,q,M,y,N){d=function(z){function n(a){a=z.call(this,a)||this;a._handles=new C;a._cachedPickRequest=null;a._isAnyPointerDown=!1;a.lineState="initial";a.analysisView=null;a.startPointSurfaceLocation=null;a.endPointSurfaceLocation=null;a.startManipulator=null;a.endManipulator=null;return a}v._inheritsLoose(n,z);var e=n.prototype;e.initialize=function(){this.measurementView=new I.DirectLineMeasurement3DView({toolState:this,view:this.view,analysis:this.analysis,
analysisView:this.analysisView,cursorPoint:this.cursorPoint,visible:this.visible});this._intersector=K.newIntersector(this.view.state.viewingMode);this._intersector.options.store=L.StoreResults.MIN;const {start:a,end:b}=this.measurementView.createManipulators(),m=(k,r,A)=>q.createManipulatorDragEventPipeline(k,(t,O,P)=>{const B=p.hideManipulatorWhileDragging(t);O.next(B).next(p.screenToMap3D(this.view)).next(l=>"start"!==l.action?l:null).next(l=>{const u=G.clonePoint(l.mapEnd,new N);this.analysis[r]=
u;t.location=u;this[A]=this._surfaceLocation(u,l.surfaceType)});P.next(B).next(q.resetProperties(this.analysis,[r])).next(q.resetProperties(this,[A])).next(()=>{t.location=c.unwrap(this.analysis[r])})}),h=k=>k.events.on("grab-changed",()=>{this.lineState=a.grabbing||b.grabbing?"editing":"measured"});this._handles.add([m(a,"startPoint","startPointSurfaceLocation"),m(b,"endPoint","endPointSurfaceLocation"),h(a),h(b)]);this.manipulators.add(a);this.manipulators.add(b);this.startManipulator=a;this.endManipulator=
b;this.startToolCreation();this._handles.add(w.watch(()=>this.state,k=>{"measured"===k&&this.finishToolCreation()},w.syncAndInitial))};e.destroy=function(){this.measurementView=c.destroyMaybe(this.measurementView);this._handles=c.destroyMaybe(this._handles)};e.onShow=function(){this.measurementView.show();this._updateManipulatorAvailability()};e.onHide=function(){this.measurementView.hide()};e.onInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);
break;case "pointer-down":this._handlePointerDown();break;case "pointer-up":this._handlePointerUp()}this._updateManipulatorAvailability()};e._handlePointerMove=function(a){this._clearCachedPickRequest();const b=y.createScreenPointFromEvent(a);"mouse"===a.pointerType&&(this._hoverAt(b),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),a.stopPropagation()))};e._handlePointerDown=function(){this._isAnyPointerDown=!0};e._handlePointerUp=function(){this._isAnyPointerDown=
!1};e._handleImmediateClick=function(a){this._clearCachedPickRequest();if(H.isPrimaryPointerAction(a)){var b=y.createScreenPointFromEvent(a),m=a.pointerType,h=!1;if(this.active)switch(this.lineState){case "initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:m,start:b,screenPoint:b});this.startManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b});c.isSome(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState=
"drawing",this.endManipulator.events.emit("drag",{action:"start",pointerType:m,start:b,screenPoint:b}),h=!0);break;case "drawing":this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),c.isSome(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.lineState="measured",h=!0)}h&&a.stopPropagation();"mouse"===a.pointerType&&this._hoverAt(b)}};e._hoverAt=
function(a){const b=this._isAnyPointerDown&&"drawing"!==this.lineState&&"editing"!==this.lineState;(c.isNone(this.analysis.startPoint)||c.isNone(this.analysis.endPoint))&&this.active&&!b?(a=this._pick(a),c.isSome(a)&&(this.cursorPoint=a)):this.cursorPoint=null};e._pick=function(a){if(c.isSome(this._cachedPickRequest)&&c.isSome(this._cachedPickRequest.result)){var b=this._cachedPickRequest.screenPoint;if(b.x===a.x&&b.y===a.y)return this._cachedPickRequest.result.mapPoint}else this._cachedPickRequest=
new x.PickRequest(a);a=D.screenPointObjectToArray(a);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector);a=Q;if(!this._intersector.results.min.getIntersectionPoint(a))return null;b=this.view.renderCoordsHelper.fromRenderCoords(a,this.view.spatialReference);this._cachedPickRequest.result=new x.PickResult(a,b);return b};e._clearCachedPickRequest=function(){this._cachedPickRequest=null};e._surfaceLocation=function(a,b){return b===p.SurfaceType.GROUND?"on-the-surface":
a.z>=this._getElevation(a)?"above-the-surface":"below-the-surface"};e._updateManipulatorAvailability=function(){this.startManipulator.available=c.isSome(this.analysis.startPoint);this.endManipulator.available=c.isSome(this.analysis.endPoint)};e._getElevation=function(a){return this.view.basemapTerrain.ready?c.unwrapOr(J.getElevationAtPoint(this.view.elevationProvider,a),0):0};v._createClass(n,[{key:"state",get:function(){return c.isNone(this.analysis.startPoint)&&c.isNone(this.analysis.endPoint)?
"ready":this.validMeasurement&&"editing"!==this.lineState&&"drawing"!==this.lineState?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}},{key:"cursorPoint",set:function(a){this._set("cursorPoint",a);this.measurementView.cursorPoint=a}},{key:"validMeasurement",get:function(){return c.isSome(this.analysis.startPoint)&&c.isSome(this.analysis.endPoint)}}]);return n}(M.InteractiveToolBase);f.__decorate([g.property({readOnly:!0})],
d.prototype,"state",null);f.__decorate([g.property()],d.prototype,"lineState",void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"cursor",null);f.__decorate([g.property()],d.prototype,"cursorPoint",null);f.__decorate([g.property({constructOnly:!0})],d.prototype,"analysis",void 0);f.__decorate([g.property({constructOnly:!0})],d.prototype,"analysisView",void 0);f.__decorate([g.property()],d.prototype,"measurementView",void 0);f.__decorate([g.property({constructOnly:!0})],d.prototype,"view",
void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"validMeasurement",null);f.__decorate([g.property({value:null})],d.prototype,"startPointSurfaceLocation",void 0);f.__decorate([g.property({value:null})],d.prototype,"endPointSurfaceLocation",void 0);d=f.__decorate([E.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],d);const Q=F.create();return d});