// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./Loadable ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(V,y,R,f,W,H,X,t,n,A,Y,u,da,I,ea,J,fa,ha,S,E,K,ia,Z,ja,L,aa,ka,B,M,la,ma,z,na){S=function(N){function O(b,a,c,d){b=N.call(this,b,a,c,d)||this;b._resources=null;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;b.hasLoadedPBRTextures=!1;b.ensureDrapedStatus(!1);b.hasLoadedPBRTextures=c.physicalBasedRenderingEnabled;return b}y._inheritsLoose(O,N);var h=O.prototype;h.getCachedSize=function(){const [b,a,c]=f.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:b,depth:a,
height:c}};h.doLoad=function(){var b=y._asyncToGenerator(function*(a){if(!this._drivenProperties.size&&E.validateSymbolLayerSize(this.symbolLayer))throw Error();const c=this.symbolLayer;this._resources=this.isPrimitive?yield this._createResourcesForPrimitive(c.resource?c.resource.primitive:da.defaultPrimitive,a):yield this._createResourcesForUrl(c.resource.href,a);this.layerOpacityChanged();this.slicePlaneEnabledChanged();this.physicalBasedRenderingChanged();this.complexity=this.computeComplexity()});
return function(a){return b.apply(this,arguments)}}();h._setMaterialTransparencyParams=function(b,a=f.get(this.symbolLayer,"material","color")){a=this._getCombinedOpacity(a);const c=1>a||this.needsDrivenTransparentPass;b.transparent=c;b.opacity=a;b.cullFace=c?M.CullFaceOptions.None:M.CullFaceOptions.Back;return b};h._createResourcesForPrimitive=function(){var b=y._asyncToGenerator(function*(a,c){if(!aa.isValidPrimitive(a))throw Error(`Unknown object symbol primitive: ${a}`);var d=this.symbolLayer;
const e=u.create(I.objectSymbolLayerPrimitiveBoundingBox(a)),g=n.fromArray(u.size(e)),l=n.fromArray(I.objectSymbolLayerSizeWithResourceSize(g,d)),m=t.length(l);var k={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:n.ONES,diffuse:n.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const p=k.usePBR;this._setMaterialTransparencyParams(k);
const w=this.symbol;if("point-3d"===w.type&&w.verticalOffset){const {screenLength:v,minWorldLength:x,maxWorldLength:q}=w.verticalOffset;k.verticalOffset={screenLength:W.pt2px(v),minWorldLength:x||0,maxWorldLength:null!=q?q:Infinity};k.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(k.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?k.externalColor=A.ONES:(d=f.isSome(d.material)&&d.material.color,d=f.isSome(d)?R.toUnitRGBA(d):
A.ONES,k.externalColor=d);this._fastUpdates=B.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(e,l,g,f.none));this._fastUpdates.enabled?(Object.assign(k,this._fastUpdates.materialParameters),k.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(k.instanced.push("color"),this._optionalFields.push("color"));k=new na.DefaultMaterial(k);k=aa.primitiveLodResources(a,k);if(!k)throw Error(`Unknown object symbol primitive: ${a}`);
a=z.materialsFromLodResources(k).map(v=>({opacity:1,transparent:v.parameters.transparent}));d=yield this._createStageResources(k,p);c=yield this._createLodRenderer(k,c);return{lodResources:k,lodRenderer:c,stageResources:d,symbolSize:l,extentPadding:m,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:a,physicalBasedRenderingEnabled:p,resourceBoundingBox:e,resourceSize:g,dispose:f.none,pivotOffset:f.none}});return function(a,c){return b.apply(this,arguments)}}();h._createResourcesForUrl=
function(){var b=y._asyncToGenerator(function*(a,c){var d=["transformation"],e={materialParamsMixin:{instanced:d,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=B.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(f.none,f.none,f.none,f.none));this._fastUpdates.enabled?(Object.assign(e.materialParamsMixin,
this._fastUpdates.materialParameters),d.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(d.push("color"),this._optionalFields.push("color"));d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const {screenLength:r,minWorldLength:C,maxWorldLength:F}=d.verticalOffset;e.materialParamsMixin.verticalOffset={screenLength:W.pt2px(r),minWorldLength:C||0,maxWorldLength:null!=F?F:Infinity};e.materialParamsMixin.castShadows=!1}e.signal=c;e.usePBR=this._context.physicalBasedRenderingEnabled;
d=e.usePBR;var g=yield ja.fetch(a,e);a=g.isEsriSymbolResource;e=g.isWosr;const l=g.remove,m=Z.makeLodResources(g.lods);Z.fillEstimatedMinScreenSpaceRadius(m);m.levels.sort((r,C)=>r.minScreenSpaceRadius-C.minScreenSpaceRadius);m.levels[0].minScreenSpaceRadius=Math.min(2,m.levels[0].minScreenSpaceRadius);const k=this._context,p=this._getExternalColorParameters(this.symbolLayer.material);var w=f.get(this.symbolLayer,"material","color");const v=this._getCombinedOpacity(w,{hasIntrinsicColor:!0}),x=this.needsDrivenTransparentPass;
var q=z.materialsFromLodResources(m);w=z.materialsFromLodResources(m).map(r=>({opacity:r.parameters.opacity||1,transparent:r.parameters.transparent}));q.forEach(r=>{const C=r.parameters;r.setParameters(p);const F=C.opacity*v;r.setParameters({opacity:F,transparent:1>F||x||C.transparent});k.screenSizePerspectiveEnabled&&r.setParameters({screenSizePerspective:k.sharedResources.screenSizePerspectiveSettings})});g=g.referenceBoundingBox;const G=n.fromArray(u.size(g)),ba=n.fromArray(m.levels[0].pivotOffset),
T=n.fromArray(I.objectSymbolLayerSizeWithResourceSize(G,this.symbolLayer)),oa=t.length(T);B.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(g,T,G,ba))&&q.forEach(r=>r.setParameters(this._fastUpdates.materialParameters));q=yield this._createStageResources(m,d);c=yield this._createLodRenderer(m,c);return{lodResources:m,lodRenderer:c,stageResources:q,symbolSize:T,extentPadding:oa,isEsriSymbolResource:a,isWosr:e,originalMaterialParameters:w,
physicalBasedRenderingEnabled:d,resourceBoundingBox:g,resourceSize:G,dispose:l,pivotOffset:ba}});return function(a,c){return b.apply(this,arguments)}}();h._createStageResources=function(){var b=y._asyncToGenerator(function*(a,c){const d=this._context.stage,e=z.materialsFromLodResources(a);c!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();d.addMany(e);c=z.texturesFromLodResources(a);d.addMany(c);yield d.load(c);a=z.geometriesFromLodResources(a);d.addMany(a);return{materials:e,
textures:c,geometries:a}});return function(a,c){return b.apply(this,arguments)}}();h._createLodRenderer=function(){var b=y._asyncToGenerator(function*(a,c){const d=this._context.stage;a=new ma.LodRenderer(a,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},
this._fastUpdates.enabled?{applyTransform:(e,g,l)=>{e.getFeatureAttribute(g,P);H.copy(l,B.evaluateModelTransform(this._fastUpdates.materialParameters,P,l))},scaleFactor:(e,g,l)=>{g.getFeatureAttribute(l,P);return B.evaluateModelTransformScale(e,this._fastUpdates.materialParameters,P)}}:null);a.slicePlaneEnabled=this._context.slicePlaneEnabled;yield d.addRenderPlugin(a.slots,a,c);return a});return function(a,c){return b.apply(this,arguments)}}();h._getExternalColorParameters=function(b){const a={};
this._drivenProperties.color?a.externalColor=A.ONES:f.isSome(b)&&f.isSome(b.color)?a.externalColor=R.toUnitRGBA(b.color):(a.externalColor=A.ONES,a.colorMixMode="ignore");return a};h.destroy=function(){N.prototype.destroy.call(this);if(f.isSome(this._resources)){const b=this._context.stage;b.removeRenderPlugin(this._resources.lodRenderer);const a=this._resources.stageResources;b.removeMany(a.materials);b.removeMany(a.textures);b.removeMany(a.geometries);f.isSome(this._resources.dispose)&&this._resources.dispose();
this._resources=null}};h.createGraphics3DGraphic=function(b){const a=b.graphic;if(!this._validateGeometry(a.geometry))return null;const c=L.placePointOnGeometry(a.geometry);if(f.isNone(c))return this.logger.warn(`unsupported geometry type for icon symbol: ${a.geometry.type}`),null;const d=this.setGraphicElevationContext(a,new fa.ElevationContext);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid)};h.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};
h.graphicLayerToGraphicId=function(){return 0};h.layerOpacityChanged=function(){if(f.isNone(this._resources))return!0;const b=this._drivenProperties.opacity,a=!this.isPrimitive,c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let l=0;l<c.length;l++){const m=c[l];var e=f.get(this.symbolLayer,"material","color"),g=d[l];e=this._getCombinedOpacity(e,{hasIntrinsicColor:a})*g.opacity;g=1>e||b||g.transparent;m.setParameters({opacity:e,transparent:g});this.isPrimitive&&
m.setParameters({cullFace:g?M.CullFaceOptions.None:M.CullFaceOptions.Back})}return!0};h.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,J.needsElevationUpdates3D)};h.slicePlaneEnabledChanged=function(){if(f.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const b of this._resources.stageResources.materials)b.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};h.physicalBasedRenderingChanged=
function(){if(f.isNone(this._resources))return!0;const {stageResources:b,isWosr:a}=this._resources;for(const c of b.materials)this.isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1===this.hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this.hasLoadedPBRTextures=!0,!1):!0};h.pixelRatioChanged=function(){return!0};h.applyRendererDiff=
function(b,a){if(f.isNone(this._resources))return K.ApplyRendererDiffResult.Recreate_Symbol;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:e,symbolSize:g,resourceSize:l,pivotOffset:m}=this._resources;for(const k in b.diff)switch(k){case "visualVariables":if(B.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(e,g,l,m))){for(const p of c)p.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return K.ApplyRendererDiffResult.Recreate_Symbol;
break;default:return K.ApplyRendererDiffResult.Recreate_Symbol}return K.ApplyRendererDiffResult.Fast_Update};h.computeComplexity=function(){if(f.isNone(this._resources))return N.prototype.computeComplexity.call(this);const b=z.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce((c,d)=>c+d.indices.get(la.VertexAttribute.POSITION).length,0)/3,a=ka.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,drawCallsPerFeature:0,
estimated:!1,memory:a}};h._hasLodRenderer=function(){return f.isSome(this._resources)};h._createAs3DShape=function(b,a,c,d,e){if(!this._hasLodRenderer()||f.isNone(this._resources))return null;b=this.getFastUpdateAttrValues(b);const g=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?E.mixinColorAndOpacity(c.color,c.opacity):null;var l=this._context.clippingExtent;Y.projectPointToVector(a,D,this._context.elevationProvider.spatialReference);if(f.isSome(l)&&!u.containsPoint(l,D))return null;l=
this._requiresTerrainElevation(d);const m=this._computeGlobalTransform(a,d,U,Q);c=this._computeLocalTransform(this._resources,this.symbolLayer,c,ca);const k=this._resources.lodRenderer.instanceData,p=k.addInstance();this._instanceIndexToGraphicUid.set(p,e);k.setLocalTransform(p,c,!1);k.setGlobalTransform(p,m);b&&k.setFeatureAttribute(p,b);g&&k.setColor(p,g);e=new ha(this,p,ea.perLodInstanceElevationAligner,d);l&&(e.alignedSampledElevation=Q.sampledElevation);e.needsElevationUpdates=J.needsElevationUpdates3D(d.mode);
L.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e};h._computeGlobalTransform=function(b,a,c,d){J.evaluateElevationInfoAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,d);D[0]=b.x;D[1]=b.y;D[2]=d.z;Y.computeTranslationToOriginAndRotation(b.spatialReference,D,c,this._context.renderCoordsHelper.spatialReference);return c};h._computeLocalTransform=function(b,a,c,d){H.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,
!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,a,d);return d};h._applyObjectScale=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=E.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||H.scale(c,c,b))};h.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);
this._preparePatchColor(b,a)}};h.updateGeometry=function(b,a){if(f.isNone(this._resources))return!0;const c=a&&L.placePointOnGeometry(a);if(f.isNone(c))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;this._computeGlobalTransform(c,b.elevationContext,U,Q);this._requiresTerrainElevation(b.elevationContext)&&(b.alignedSampledElevation=Q.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,U,!0);L.extendPointGraphicElevationContext(b,
c,this._context.elevationProvider);return!0};h._preparePatchTransform=function(b,a){if((a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition)&&!f.isNone(this._resources)){var c=(x,q,G)=>f.unwrapOr(null!=x&&"complete"===x.type?x.newValue:q,G),d=c(a.heading,this.symbolLayer.heading,0),e=c(a.tilt,this.symbolLayer.tilt,0),g=c(a.roll,this.symbolLayer.roll,0),l=c(a.width,this.symbolLayer.width,void 0),m=c(a.height,this.symbolLayer.height,void 0),k=c(a.depth,this.symbolLayer.depth,
void 0),p=c(a.anchor,this.symbolLayer.anchor,void 0);c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var w={heading:d,tilt:e,roll:g,anchor:p,anchorPosition:c},v=this._resources;this.loadStatus===ia.LoadStatus.LOADED&&b.symbolLayerStatePatches.push(()=>{v.symbolSize=n.fromArray(I.objectSymbolLayerSizeWithResourceSize(v.resourceSize,{width:l,height:m,depth:k,
isPrimitive:this.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push((x,q)=>{q=this._computeLocalTransform(v,w,q,ca);v.lodRenderer.instanceData.setLocalTransform(x.instanceIndex,q,!0)})}};h._preparePatchColor=function(b,a){if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var c=a.color.newValue,d=f.isSome(c)?R.toUnitRGBA(c):A.ONES;delete a.color;var e=this._resources;f.isNone(e)||b.graphics3DGraphicPatches.push(g=>
{this._hasPerInstanceColor()?(e.lodRenderer.instanceData.setColor(g.instanceIndex,d),g=this._setMaterialTransparencyParams({},c)):g=this._setMaterialTransparencyParams({externalColor:d},c);for(const l of e.stageResources.materials)l.setParameters(g)})}};h._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};h._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return E.computeObjectRotation(b.heading,b.tilt,b.roll,
c)};h._computeAnchor=function(b,a,c){const d=n.create();switch(c.anchor){case "center":t.copy(d,u.center(b));t.negate(d,d);break;case "top":a=u.center(b);t.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=u.center(b);t.set(d,-a[0],-a[1],-b[2]);break;case "relative":a=u.center(b);b=u.size(b);c=(c=c.anchorPosition)?n.fromValues(c.x,c.y,c.z):n.ZEROS;t.multiply(d,b,c);t.add(d,d,a);t.negate(d,d);break;default:f.isSome(a)?t.negate(d,a):t.copy(d,n.ZEROS)}return d};h._applyAnchor=function(b,a,c){this._fastUpdates.enabled&&
this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b.resourceBoundingBox,b.pivotOffset,a))&&H.translate(c,c,b)};h._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};h._fastVisualVariableConvertOptions=function(b,a,c,d){const e=f.isSome(b)?n.fromArray(u.size(b)):n.ONES;b=f.isSome(b)?this._computeAnchor(b,d,this.symbolLayer):n.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=E.computeObjectScale(f.isSome(a)?a:void 0,a,c,d);
const g=n.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:e,symbolSize:f.isSome(a)?a:n.ONES,unitInMeters:d,transformation:{anchor:b,scale:c,rotation:g}}};y._createClass(O,[{key:"extentPadding",get:function(){return f.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return f.get(this._resources,"lodRenderer")}}]);
return O}(S.Graphics3DSymbolLayer);const D=n.create(),ca=X.create(),U=X.create(),P=A.create(),Q=new J.SampleElevationInfo;V.Graphics3DObjectSymbolLayer=S;Object.defineProperty(V,"__esModule",{value:!0})});