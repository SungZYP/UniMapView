// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../core/PooledArray ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../ViewingMode ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtils".split(" "),function(D,l,I,x,p,J,K,m,L,F,y,r,z){function G(q){A&&A.viewingMode===q||(A=y.newIntersector(q));
return A}let M=function(){function q(a,b,c){this.viewingMode=a;this._forEachLayer=b;this.view=c;this.externalIntersectionHandlers=new I;this.tolerance=y.DEFAULT_TOLERANCE;this.tmpRay=K.create();this.validateHUDIntersector=y.newIntersector(this.viewingMode);this.validateHUDIntersector.options.hud=!1}var h=q.prototype;h.intersectScreen=function(a,b){return this.intersectRay(this._getPickRay(a,this.tmpRay),G(this.viewingMode),b)};h.intersectScreenFreePointFallback=function(a,b){return this.intersectRayFreePointFallback(this._getPickRay(a,
this.tmpRay),b)};h.intersectRayFreePointFallback=function(a,b){return this.intersectRay(a,G(this.viewingMode),b)||this._intersectRayFreePointLocal(a,b)};h.intersectRay=function(a,b,c,d){b.options.selectionMode=!1;b.options.store=r.StoreResults.MIN;this.computeIntersection(a,b,d);return b.results.min?b.results.min.getIntersectionPoint(c):!1};h.getCenterRayWithSubpixelOffset=function(a,b,c=.5,d=.5){a.getRenderCenter(w,c,d);w[0]+=.0466;w[1]-=.0123;return F.fromRenderAtEye(a,w,b)};h.intersectIntersectorScreen=
function(a,b,c){this.computeIntersection(this._getPickRay(a,this.tmpRay),b,c)};h.intersectToolIntersectorScreen=function(a,b,c){a=this._getPickRay(a,this.tmpRay);this.intersectToolIntersectorRay(a,b,c)};h.intersectToolIntersectorRay=function(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const d=b.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||z.isValidIntersectorResult(d)&&d.intersector!==r.IntersectorType.TERRAIN||(b.options.selectionMode=!1,this.computeIntersection(a,
b,c))};h.setTolerance=function(a=y.DEFAULT_TOLERANCE){this.tolerance=a};h.addIntersectionHandler=function(a){this.externalIntersectionHandlers.push(a);this.externalIntersectionHandlers.sort((b,c)=>b.type===r.IntersectorType.TERRAIN?1:c.type===r.IntersectorType.TERRAIN?-1:0)};h.removeIntersectionHandler=function(a){this.externalIntersectionHandlers.removeUnordered(a);this.externalIntersectionHandlers.sort((b,c)=>b.type===r.IntersectorType.TERRAIN?1:c.type===r.IntersectorType.TERRAIN?-1:0)};h._getPickRay=
function(a,b){return F.fromScreen(this.view.state.camera,a,b)};h._intersectRayFreePointLocal=function(a,b){if(this.viewingMode!==L.ViewingMode.Local||l.isNone(a))return!1;var c=this.view.renderDataExtent;if(l.isNone(c))return p.add(b,a.origin,p.normalize(m.sv3d.get(),a.direction)),!0;var d=Math.max(c.xmax-c.xmin,c.ymax-c.ymin,8*Math.max(c.xmax-c.xmin,c.ymax-c.ymin));if(0===d)return p.add(b,a.origin,p.normalize(m.sv3d.get(),a.direction)),!0;var e=this.view.state.camera;const k=Math.max(0,c.xmin-e.eye[0],
e.eye[0]-c.xmax);c=Math.max(0,c.ymin-e.eye[1],e.eye[1]-c.ymax);e=d/Math.max(1,Math.max(0,Math.log(d/(Math.abs(e.relativeElevation)+Number.MIN_VALUE)))**2);e=Math.max(e,Math.min(Math.sqrt(k*k+c*c),d));d=p.scale(m.sv3d.get(),a.direction,e/p.length(a.direction));p.add(b,a.origin,d);return!0};h.intersectElevationFromScreen=function(a,b,c=0,d=null){return this._intersectElevation(this._getPickRay(a,this.tmpRay),b,c,d)};h._intersectElevation=function(a,b,c=0,d=null){if(l.isNone(a))return null;var e=l.isSome(b)?
b.mode:"absolute-height",k=l.isSome(b)?l.unwrapOr(b.offset,0):0,u="on-the-ground"!==e?k+c:0;b=u/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===e)return this.view.renderCoordsHelper.intersectInfiniteManifold(a,u,B)?(c=this.view.computeMapPointFromVec3d(B),c.z-=k,c):null;k=this.view.state.camera;const t=x.castRenderScreenPointArray3(m.sv3d.get());k.projectToRenderScreen(a.origin,t);u=new H(null,this._forEachLayer);const v=this.view.slicePlane,C=l.isSome(v)?z.sliceFilterPredicate(v):
null,f=y.newIntersector(this.viewingMode);f.options.store=r.StoreResults.MIN;f.options.verticalOffset=b;b=a.origin;a=p.add(m.sv3d.get(),b,a.direction);f.reset(b,a,k);f.point=t;const n=l.isSome(d)?"type"in d&&"graphics"===d.type?g=>g.metadata.layerUid!==d.uid:g=>g.metadata.graphicUid!==d.uid:null;switch(e){case "relative-to-scene":f.intersect(u.layers,t,this.tolerance,null,g=>(l.isNone(n)||n(g))&&g.metadata&&g.metadata.isElevationSource);this.externalIntersectionHandlers.forAll(g=>{g.type!==r.IntersectorType.I3S&&
g.type!==r.IntersectorType.TERRAIN||g.intersect(f,g.slicePlaneEnabled?C:null,f.rayBegin,f.rayEnd,t)});break;case "on-the-ground":case "relative-to-ground":this.externalIntersectionHandlers.forAll(g=>{g.isGround&&g.intersect(f,g.slicePlaneEnabled?C:null,f.rayBegin,f.rayEnd,t)})}return f.results.min.getIntersectionPoint(B)?(e=this.view.computeMapPointFromVec3d(B),e.z=c,e):null};h.computeIntersection=function(a,b,c){if(!l.isNone(a)){var d=this.view.state.camera,e=x.castRenderScreenPointArray3(m.sv3d.get());
d.projectToRenderScreen(a.origin,e);var k=new H(c,this._forEachLayer);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var u=a.origin,t=p.add(m.sv3d.get(),a.origin,a.direction);b.reset(u,t,d);b.intersect(k.layers,e,this.tolerance);a=this.view.slicePlane;var v=l.isSome(a)?z.sliceFilterPredicate(a):null;b.intersect(k.sliceableLayers,e,this.tolerance,v);var C=c&&(c.requiresGroundFeedback||c.enableDraped);this.externalIntersectionHandlers.forAll(f=>{b.options.isFiltered=!k.filterLayerUid(f.layerUid);
(f.isGround&&C||!b.options.isFiltered)&&f.intersect(b,f.slicePlaneEnabled?v:null,u,t,e)});a=m.sv3d.get();if(c&&c.enableDraped&&b.results.ground.getIntersectionPoint(a)){c=this.view.basemapTerrain.overlayManager.renderer;const f=this.view.renderCoordsHelper.spatialReference,n=m.sv3d.get();this.view.renderCoordsHelper.fromRenderCoords(a,n,this.view.spatialReference);n[2]=l.unwrapOr(this.view.elevationProvider.getElevation(a[0],a[1],a[2],f,"ground"),0);c.intersect(b,n,b.results.ground,g=>k.filterRenderGeometry(g))}b.sortResults();
a=b.results.hud;if(z.isHudIntersectorResult(a)){const f=x.castRenderScreenPointArray3(m.sv3d.get()),n=m.sv3d.get(),g=m.sv3d.get();this._unprojectHUDResultRay(a.target.center,f,n,g);c=p.distance(a.target.center,n)/p.distance(n,g)*.99;this.validateHUDIntersector.reset(n,g,d);this.validateHUDIntersector.intersect(k.layers,f,this.tolerance);this.validateHUDIntersector.intersect(k.sliceableLayers,f,this.tolerance,v);this.externalIntersectionHandlers.forAll(E=>{k.filterLayerUid(E.layerUid)&&E.intersect(this.validateHUDIntersector,
E.slicePlaneEnabled?v:null,n,g,f)});d=this.validateHUDIntersector.results.min;if(null==d.dist||c<=d.dist)b.results.min.copy(a),b.results.all.splice(0,0,a)}}};h._unprojectHUDResultRay=function(a,b,c,d){const e=this.view.state.camera;e.projectToRenderScreen(a,b);a=x.castRenderScreenPointArray3(m.sv3d.get());a[0]=b[0];a[1]=b[1];a[2]=0;e.unprojectFromRenderScreen(a,c);a[2]=1;e.unprojectFromRenderScreen(a,d)};return q}(),A,H=function(){function q(a,b){this.layers=[];this.sliceableLayers=[];this.include=
null==a?void 0:a.include;this.exclude=null==a?void 0:a.exclude;b(c=>{c.isPickable&&this.filterLayerUid(c.apiLayerUid)&&(c.isSliceable?this.sliceableLayers:this.layers).push(c)})}var h=q.prototype;h.filterLayerUid=function(a){const {include:b,exclude:c}=this;return l.isNone(a)?null==b&&null==c:(null==b||b.has(a))&&(null==c||!c.has(a))};h.filterRenderGeometry=function(a){return this.filterLayerUid(a.layerUid)};return q}();const B=J.create(),w=x.createRenderScreenPointArray3();D.SceneIntersectionHelper=
M;D.isIntersectionHandler=function(q){return"object"===typeof q&&"intersect"in q};Object.defineProperty(D,"__esModule",{value:!0})});