// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f32 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./PointHighlights ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/ShaderOutputOptions ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/RenderPass ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/enums ../../../webgl/VertexArrayObject ../../../webgl/VertexElementDescriptor".split(" "),
function(T,ha,p,ia,Z,ja,r,ka,J,la,t,ma,na,oa,N,U,pa,qa,ra,sa,K,F,O,aa,ba,C,ta,ca){function L(f,g,a,c,b){if(a.drawScreenSpace)return a.fixedSize*g*c;b=(b?256:64)*g*c;return a.drawFixedSize?Math.min(a.fixedSize/2,b):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*g*c,f/2),b):Math.min(f/2,b)}function da(f){return p.isSome(f.component)?f.component:-1}function ua(f,g){if(p.isNone(f))return f;f=f.filter(a=>a.id!==g);return 0===f.length?null:f}function ea(f){return p.isSome(f.dist)&&p.isSome(f.point)&&
p.isSome(f.pointId)&&p.isSome(f.node)}const va={positions:[new ca.VertexElementDescriptor(O.VertexAttribute.POSITION,3,C.DataType.FLOAT,0,12)],colors:[new ca.VertexElementDescriptor(O.VertexAttribute.COLOR,3,C.DataType.UNSIGNED_BYTE,0,3,!0)]};O=function(){function f(a){this._params=a;this.type=K.IntersectorType.PCL;this.isGround=!1;this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null};this._highlights=new oa.PointHighlights({forEachNode:c=>this.forEachNode(c),addHighlight:(c,b,d)=>
this._addHighlight(c,b,d),removeHighlight:(c,b)=>this._removeHighlight(c,b)});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=t.create(t.POSITIVE_INFINITY);this._techniqueConfig=new aa.PointRendererTechniqueConfiguration;this.tempMatrix4=ja.create();this.tempVec3=ka.create();this.nodes=new ia}var g=f.prototype;g.initializeRenderContext=function(a){this._context=
a;this._techniqueRep=this._context.shaderTechniqueRepository;a.requestRender()};g.uninitializeRenderContext=function(){};g.intersect=function(a,c,b,d){const h=J.create(),k=J.create(),D=J.create(),v=J.create(),M=ma.create(),l=a.camera.perScreenPixelRatio/2,m=a.camera.near,y=this._getSizeParams();r.subtract(k,d,b);const P=1/r.length(k);r.scale(k,k,P);r.negate(D,k);la.set(M,k[0],k[1],k[2],-r.dot(k,b));const z=new V,A=new V,fa=[],Q=t.create(),R=t.create(this._clipBox);t.offset(R,-b[0],-b[1],-b[2],R);
this.nodes.forAll(e=>{const n=e.splatSize*this._scaleFactor;var u=N.minimumDistancePlane(e.obb,M),q=N.maximumDistancePlane(e.obb,M);u-=y.drawScreenSpace?0:L(n,u+m,y,l,e.isLeaf);q-=y.drawScreenSpace?0:L(n,q+m,y,l,e.isLeaf);u=null!=z.dist&&null!=A.dist&&z.dist<u*P&&A.dist>q*P;if(!(0>q||u)&&(q=L(n,q+m,y,l,e.isLeaf),N.intersectLine(e.obb,b,k,q))){q*=q;N.toAaBoundingBox(e.obb,Q);t.offset(Q,-b[0],-b[1],-b[2],Q);u=!t.contains(R,Q);r.subtract(v,e.origin,b);var wa=e.coordinates.length/3;for(let E=0;E<wa;E++){h[0]=
v[0]+e.coordinates[3*E];h[1]=v[1]+e.coordinates[3*E+1];h[2]=v[2]+e.coordinates[3*E+2];if(u&&!t.containsPoint(R,h))continue;var w=r.dot(h,k),S=r.squaredLength(h)-w*w;if(S>q)continue;var G=w+m;const W=y.drawScreenSpace?0:L(n,G,y,l,e.isLeaf);if(0>w-W)continue;G-=W;G=L(n,G,y,l,e.isLeaf);if(S>G*G)continue;const H=(w-W)*P;w=B=>{var X=E,I=B.point;p.isNone(I)&&(I=J.create());I[0]=e.origin[0]+e.coordinates[3*X];I[1]=e.origin[1]+e.coordinates[3*X+1];I[2]=e.origin[2]+e.coordinates[3*X+2];B.point=I;B.dist=H;
B.normal=D;B.node=e;B.pointId=E;B.layerUid=this.layerUid;return B};(null==z.dist||H<z.dist)&&(null==c||c(b,d,H))&&w(z);a.options.store!==K.StoreResults.MIN&&(null==A.dist||H>A.dist)&&(null==c||c(b,d,H))&&w(A);a.options.store!==K.StoreResults.ALL||null!=c&&!c(b,d,H)||(S=new V,fa.push(w(S)))}}});const xa=e=>{const {layerUid:n,node:u,pointId:q}=e;return{point:e.point,layerUid:n,graphicUid:q,createGraphic:()=>this._params.createGraphic(u,q,e.point)}},Y=(e,n)=>{const u=xa(n);e.set(this.type,u,n.dist,n.normal)};
if(ea(z)){var x=a.results.min;(null==x.dist||z.dist<x.dist)&&Y(x,z)}ea(A)&&a.options.store!==K.StoreResults.MIN&&(x=a.results.max,(null==x.dist||A.dist>x.dist)&&Y(x,A));if(a.options.store===K.StoreResults.ALL){x=na.fromPoints(b,d);for(const e of fa){const n=sa.newIntersectorResult(x);Y(n,e);a.results.all.push(n)}}};g.prepareTechnique=function(a){if(0===this.nodes.length||a.pass!==F.RenderPass.MATERIAL&&a.pass!==F.RenderPass.MATERIAL_DEPTH&&a.pass!==F.RenderPass.MATERIAL_HIGHLIGHT)return null;this.nodes.forAll(b=>
{null==b.vao&&this._initNode(a,b)});const c=this._getSizeParams();this._techniqueConfig.drawScreenSize=c.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=a.pass===F.RenderPass.MATERIAL_DEPTH?U.ShaderOutput.Depth:a.pass===F.RenderPass.MATERIAL_HIGHLIGHT?U.ShaderOutput.Highlight:U.ShaderOutput.Color;return this._techniqueRep.releaseAndAcquire(aa.PointRendererTechnique,this._techniqueConfig,
this._technique)};g.render=function(a,c){const b=a.rctx,d=b.useTechnique(c),h=this._clipBox,k=!t.equals(h,t.POSITIVE_INFINITY,(l,m)=>l===m);k||(r.set(this.tempVec3,-Infinity,-Infinity,-Infinity),d.setUniform3fv("clipMin",this.tempVec3),r.set(this.tempVec3,Infinity,Infinity,Infinity),d.setUniform3fv("clipMax",this.tempVec3));d.setUniformMatrix4fv("proj",a.camera.projectionMatrix);a.pass===F.RenderPass.MATERIAL_DEPTH&&d.setUniform2fv("nearFar",a.camera.nearFar);a.isHighlightPass&&(this._bindParameters.inverseViewport[0]=
1/a.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=a.highlightDepthTexture,qa.bindOutputHighlight(d,this._bindParameters));const D=this._getSizeParams(),v=a.camera.pixelRatio;D.drawFixedSize&&d.setUniform2f("pointScale",D.fixedSize*v,a.camera.fullHeight);const M=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null;this.nodes.forAll(l=>{if(0!==l.coordinates.length&&(!a.isHighlightPass||l.highlights)){d.setUniform2f("screenMinMaxSize",
D.screenMinSize*v,(l.isLeaf?256:64)*v);D.drawFixedSize||d.setUniform2f("pointScale",l.splatSize*this._scaleFactor*v,a.camera.fullHeight/v);var m=l.origin;k&&(r.set(this.tempVec3,h[0]-m[0],h[1]-m[1],h[2]-m[2]),d.setUniform3fv("clipMin",this.tempVec3),r.set(this.tempVec3,h[3]-m[0],h[4]-m[1],h[5]-m[2]),d.setUniform3fv("clipMax",this.tempVec3));Z.fromTranslation(this.tempMatrix4,m);Z.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);d.setUniformMatrix4fv("modelView",this.tempMatrix4);pa.bindSliceUniforms(d,
c.configuration,M,{origin:m});b.bindVAO(l.vao);a.isHighlightPass?this._renderHighlightFragments(b,l):b.drawArrays(C.PrimitiveType.POINTS,0,l.coordinates.length/3)}})};g._renderHighlightFragments=function(a,c){var b=c.highlights;if(!p.isNone(b)){c=p.unwrap(b[0].component);var d=c+1;for(let h=1;h<b.length;h++){const k=p.unwrap(b[h].component);k!==d&&(d-=c,0<d&&a.drawArrays(C.PrimitiveType.POINTS,c,d),c=k);d=k+1}b=d-c;0<b&&a.drawArrays(C.PrimitiveType.POINTS,c,b)}};g.addNode=function(a){this.nodes.push(a);
this._highlights.nodeAdded(a);this._requestRender()};g.removeNode=function(a){let c=null;this.nodes.filterInPlace(b=>b.id===a?(c=b,b.vao=p.disposeMaybe(b.vao),this._highlights.nodeRemoved(b),!1):!0);this._requestRender();return c};g.forEachNode=function(a){this.nodes.forAll(a)};g.removeAll=function(){this.nodes.forAll(a=>a.vao=p.disposeMaybe(a.vao));this._highlights.removeAll();this.nodes.clear();this._requestRender()};g.highlight=function(a){return this._highlights.add(a)};g._addHighlight=function(a,
c,b){var d=a.highlights;p.isNone(d)&&(d=[]);c={component:c,id:b};d.push(c);c=da(c);for(b=d.length-1;0<b&&c<da(d[b-1]);)[d[b-1],d[b]]=[d[b],d[b-1]],--b;a.highlights=d;this._requestRender()};g._removeHighlight=function(a,c){a.highlights=ua(a.highlights,c);this._requestRender()};g._initNode=function(a,c){a=a.rctx;c.vao=new ta.VertexArrayObject(a,ra.Default3D,va,{positions:ba.BufferObject.createVertex(a,C.Usage.STATIC_DRAW,c.coordinates),colors:ba.BufferObject.createVertex(a,C.Usage.STATIC_DRAW,c.rgb)})};
g._requestRender=function(){this._context&&this._context.requestRender()};g._getSizeParams=function(){const a=this._useFixedSizes,c=a&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:c,drawFixedSize:a,fixedSize:c?this._sizePx:this._size,screenMinSize:a?0:this._minSizePx}};ha._createClass(f,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=
a,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())}},
{key:"size",get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())}},{key:"clippingBox",set:function(a){t.set(this._clipBox,a||t.POSITIVE_INFINITY)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}}]);return f}();
let V=function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""};T.PointRenderer=O;T.isInstanceOfNode=function(f){return f.hasOwnProperty("splatSize")};Object.defineProperty(T,"__esModule",{value:!0})});