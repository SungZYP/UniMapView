// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec4f64 ../../../../support/requestImageUtils ./glUtil3D ./SSAOTechnique ./Util ../../../../chunks/SSAO.glsl ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(A,w,B,b,C,D,E,F,G,r,H,x,e,t,I,u){let J=function(){function v(a,d,g){this._techniqueRep=a;this._rctx=d;this._requestRender=
g;this._enabled=!1;this._ssaoTechniqueConfig=new r.SSAOTechniqueConfiguration;this.quadVAO=null;this._blurSizePx=2;this._attenuation=.5}var k=v.prototype;k.dispose=function(){this.quadVAO=b.disposeMaybe(this.quadVAO)};k.disposeOffscreenBuffers=function(){b.applySome(this._ssaoFBO,a=>a.resize(0,0));b.applySome(this._blur0FBO,a=>a.resize(0,0));b.applySome(this._blur1FBO,a=>a.resize(0,0))};k.computeSSAO=function(a,d,g){if(!(!this.enabled||b.isNone(d)||b.isNone(g)||b.isNone(this._noiseTexture)||b.isNone(this._ssaoFBO)||
b.isNone(this._blur0FBO)||b.isNone(this._blur1FBO))){var f=this._rctx,p=a.fullViewport,h=p[2],l=p[3],m=h/this._blurSizePx,n=l/this._blurSizePx;this._ssaoFBO.resize(h,l);this._blur0FBO.resize(m,n);this._blur1FBO.resize(m,n);m=1*h;n=1*l;f.bindFramebuffer(this._ssaoFBO);f.setViewport(0,0,h,l);var c=f.useTechnique(this._ssaoTechnique);c.setUniform2f("rnmScale",h/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height);H.inverseProjectionInfo(a.projectionMatrix,a.fullWidth,a.fullHeight,
y,z);c.setUniform4fv("projInfo",y);c.setUniform2fv("zScale",z);c.setUniform2fv("nearFar",a.nearFar);h=1/a.computeRenderPixelSizeAtDist(1);c.setUniform1f("projScale",1*h);c.setUniform2f("screenDimensions",m,n);l=D.distance(a.eye,a.center);var q=20*a.computeRenderPixelSizeAtDist(l);q=Math.max(.1,q);c.setUniform1f("radius",q);c.setUniform1f("intensity",4*this._attenuation/q**6);c.bindTexture(this._noiseTexture,"rnm");c.bindTexture(g,"normalMap");c.bindTexture(d,"depthMap");b.isNone(this.quadVAO)&&(this.quadVAO=
G.createQuadVAO(this._rctx));f.bindVAO(this.quadVAO);f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));c=f.useTechnique(this._blurTechnique);c.bindTexture(this._ssaoFBO.colorTexture,"tex");c.bindTexture(g,"normalMap");c.bindTexture(d,"depthMap");f.setViewport(0,0,m/this._blurSizePx,n/this._blurSizePx);f.bindFramebuffer(this._blur0FBO);c.setUniform2f("screenDimensions",m,n);c.setUniform2f("blurSize",0,1*this._blurSizePx/n);c.setUniform2fv("nearFar",a.nearFar);5E4<
l&&(h=Math.max(0,h-(l-5E4)));c.setUniform1f("projScale",h);f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));c.setUniform2f("blurSize",1*this._blurSizePx/m,0);f.bindFramebuffer(this._blur1FBO);c.bindTexture(this._blur0FBO.colorTexture,"tex");f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,0,u.vertexCount(this.quadVAO,"geometry"));f.setViewport(p[0],p[1],p[2],p[3])}};k.bind=function(a,d){this.enabled&&b.isSome(this._blur1FBO)&&b.isSome(this._ssaoFBO)?(a.bindTexture(this._blur1FBO.colorTexture,
"ssaoTex"),a.setUniform4f("viewportPixelSz",d.fullViewport[0],d.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):a.setUniform4f("viewportPixelSz",-1,-1,-1,-1)};k._selectPrograms=function(){this._ssaoTechniqueConfig.output=x.SSAOOutput.SSAO;this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(r.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique);this._ssaoTechniqueConfig.output=x.SSAOOutput.Blur;this._blurTechnique=this._techniqueRep.releaseAndAcquire(r.SSAOTechnique,this._ssaoTechniqueConfig,
this._blurTechnique)};k._enable=function(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))};k._loadResources=function(a){this._data?a():(new Promise((d,g)=>A(["./SSAOHelperData"],d,g))).then(d=>{this._data=d;a()})};k._initialize=function(){const a={target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.LINEAR,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0},d={colorTarget:e.TargetType.TEXTURE,
depthStencilTarget:e.DepthStencilTargetType.NONE};F.requestImage(this._data.noiseTexture).then(g=>{this._enabled&&(this._ssaoFBO=new t.FramebufferObject(this._rctx,d,a),this._blur0FBO=new t.FramebufferObject(this._rctx,d,a),this._blur1FBO=new t.FramebufferObject(this._rctx,d,a),this._noiseTexture=new I.Texture(this._rctx,{target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,hasMipmap:!0,width:g.width,height:g.height},g),this._requestRender())});this._selectPrograms()};
k._disable=function(){this._enabled=!1;this._noiseTexture=b.disposeMaybe(this._noiseTexture);this._blur1FBO=b.disposeMaybe(this._blur1FBO);this._blur0FBO=b.disposeMaybe(this._blur0FBO);this._ssaoFBO=b.disposeMaybe(this._ssaoFBO)};B._createClass(v,[{key:"enabled",get:function(){return this._enabled},set:function(a){a?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&b.isSome(this._noiseTexture)&&b.isSome(this._ssaoFBO)&&b.isSome(this._blur0FBO)&&b.isSome(this._blur1FBO)}},
{key:"gpuMemoryUsage",get:function(){return(b.isSome(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(b.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(b.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]);return v}();const z=C.create(),y=E.create();w.SSAOHelper=J;Object.defineProperty(w,"__esModule",{value:!0})});