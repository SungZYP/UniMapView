// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../symbols ../../../../core/Accessor ../../../../core/has ../../../../core/Error ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/scheduling ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(l,y,m,Fa,Ga,Ha,Ia,Ja,Ka,La,S,Ma,Na,aa,Oa,F,ba,ca,T,e,U,A,da,D,p,Pa,Qa,ea,N,G,J,C,H,fa,ha,O,P,V,ia,ja,W,ka,K,L,la,ma,na,oa,pa,qa,ra,X,sa,ta,Y,ua,va,wa,v,xa,ya,I,za,Aa,Z,Ba,Ca){var Q;const R=J.create(),q=H.create(),u=ca.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");l.Graphics3DCore=Q=function(w){function M(b){var a=w.call(this,b)||this;a.propertiesPool=new wa.PropertiesPool({computedExtent:za},y._assertThisInitialized(a));a.computedExtent=null;a.currentRenderer=null;a.rendererHasGeometryOperations=
!1;a.graphicStateTracking=null;a.symbolCreationContext=new na.Graphics3DSymbolCreationContext((c,d)=>a._frameTask.schedule(c,d));a.graphics3DGraphics=new Map;a.stageLayer=null;a.stage=null;a.graphicsDrapedUids=new Set;a.graphicsBySymbol=new Map;a.symbolConversionCache=new Map;a.symbols=new Map;a.graphicsWithoutSymbol=new Map;a.graphicsWaitingForSymbol=new Map;a.graphicsUpdateId=0;a._handles=new ba;a._frameTask=I.ImmediateTask;a.suspendSymbolCleanup=!1;a._spatialReference=null;a.arcadeOnDemand=null;
a.rendererChangeAbortController=null;a.elevationInfoChangeAbortController=null;a.setupAbortController=null;a.elevationAlignment=null;a.scaleVisibility=null;a.filterVisibility=null;a._spatialIndex=null;a.extentPadding=0;a._updatingPendingLoadedGraphicsChange=null;a.featureStore=null;a.deconflictor=null;a.labeler=null;a.objectStates=null;a.viewElevationProvider=null;a.stageLayerElevationProvider=null;a.sharedSymbolResourcesOwnerHandle=null;a.whenGraphics3DGraphicRequests={};a.pendingUpdates=new Map;
a.numberOfGraphics=0;a.numberOfGraphicsProvidingElevation=0;a.pendingAdds=0;a.pendingRemoves=0;a.pendingUpdatesPool=new U({allocator:c=>c||new Da,deallocator:c=>{c.clear();return c}});a.symbolWarningLogged=!1;a.geometryWarningLogged=!1;a.objectIdInvisibleSet=new Set;a._whenSymbolRemoved=new U;a.preferredUpdatePolicy=v.UpdatePolicy.SYNC;a.forcedUpdatePolicy=null;a.elevationFeatureExpressionEnabled=!0;a.owner=null;a.layer=null;a.graphicSymbolSupported=!0;a.getRenderingInfoWithoutRenderer=!1;a.hasZ=
null;a.hasM=null;a._usedMemory=0;a._visible=void 0;a._startCreateGraphics=!1;return a}y._inheritsLoose(M,w);var f=M.prototype;f._getConvertedSymbol=function(b){if("web-style"===b.type)return b.clone();var a=this.symbolConversionCache.get(b.id);if(e.isSome(a))return a;a=W.to3D(b,{retainId:!0,hasLabelingContext:this._hasLabelingContext(b)});const c=a.symbol||null;e.isNone(c)&&a.error&&u.error(a.error.message);this.symbolConversionCache.set(b.id,c);return c};f._getSymbolComplexitiesUsedOrRenderer=function(b){if(e.isNone(b))return[];
var a=b.getSymbols(),c="backgroundFillSymbol"in b&&b.backgroundFillSymbol;if(!(c||a&&a.length))return[];b=[];c=this._getSymbolComplexityUsedOrRenderer(c);e.isSome(c)&&b.push(c);for(const d of a)a=this._getSymbolComplexityUsedOrRenderer(d),e.isSome(a)&&b.push(a);return b};f._getSymbolComplexityUsedOrRenderer=function(b){if(e.isNone(b))return null;const a=this.symbols.get(b.id);if(e.isSome(a))return a.complexity;b=this._getConvertedSymbol(b);return e.isSome(b)?Y.defaultSymbolComplexity(b):null};f._getSymbolComplexitiesUsed=
function(){const b=[];this.symbols.forEach(a=>{e.isSome(a)&&b.push(a.complexity)});return b};f.initialize=function(){this._spatialReference=this.owner.view.spatialReference;this._set("featureStore",new la.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:b=>this.graphics3DGraphics.forEach(b)}))};
f.setup=function(){var b=y._asyncToGenerator(function*(a){this.setupAbortController=new AbortController;const c=this.setupAbortController.signal;this._set("elevationAlignment",a.elevationAlignment);this._set("scaleVisibility",a.scaleVisibility);this._set("filterVisibility",a.filterVisibility);this._set("deconflictor",a.deconflictor);this._set("labeler",a.labeler);this._set("objectStates",a.objectStates);const d=this.owner.view;this.viewElevationProvider=new ka.ViewElevationProvider(this._spatialReference,
d);this._initializeStage(d,this.layer.uid);this.symbolCreationContext.sharedResources=d.sharedSymbolResources;this.sharedSymbolResourcesOwnerHandle=d.sharedSymbolResources.addGraphicsOwner(this.owner);e.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=d.sharedSymbolResources.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=d.renderCoordsHelper;this.symbolCreationContext.layer=
this.layer;this.symbolCreationContext.graphicsCoreOwner=this.owner;this.symbolCreationContext.localOriginFactory=new xa.GridLocalOriginFactory(d.renderSpatialReference);this.symbolCreationContext.elevationProvider=d.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=g=>this.notifyGraphicGeometryChanged(g);this.symbolCreationContext.notifyGraphicVisibilityChanged=g=>this.notifyGraphicVisibilityChanged(g);a=L.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);
this.symbolCreationContext.featureExpressionInfoContext=yield L.createContext(a,this._spatialReference,u);A.throwIfAborted(c);this.symbolCreationContext.screenSizePerspectiveEnabled=d.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;a="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:
"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",()=>this._frameTask.reschedule(()=>this._updateLayerVisibility())),this.owner.watch(a,()=>{const g=d.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;if(g!==this.symbolCreationContext.screenSizePerspectiveEnabled){var h;this.symbolCreationContext.screenSizePerspectiveEnabled=g;null==(h=this.labeler)?void 0:h.reset();this.recreateAllGraphicsAndSymbols()}}),this.owner.watch("slicePlaneEnabled",
g=>this._slicePlaneEnabledChange(!!g)),this.owner.view.watch("pixelRatio",()=>this._pixelRatioChange()),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",g=>this._physicalBasedRenderingChange(g)),D.when(d.basemapTerrain,"tilingScheme",g=>{g.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=d.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([D.on(this.owner,"loadedGraphics",
"change",h=>this._graphicsCollectionChanged(h),()=>this.recreateAllGraphics()),D.on(this.owner,"loadedGraphics","after-changes",()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange(),()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange())],"loaded-graphics")}),D.whenFalse(this,"asyncUpdates",()=>this.runTask(I.noBudget),!0),D.init(this,"effectiveUpdatePolicy",g=>{e.isSome(this.stageLayer)&&(this.stageLayer.updatePolicy=g);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC;
g===v.UpdatePolicy.SYNC&&this.runTask(I.noBudget)},!0)]);this._frameTask=d.resourceController.scheduler.registerTask(I.TaskPriority.GRAPHICS_CORE,this);this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",()=>this.deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");try{yield this.rendererChange(this.layer.renderer)}catch{}A.throwIfAborted(c);this.setupAbortController=null});return function(a){return b.apply(this,
arguments)}}();f._abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)};f.destroy=function(){this._abortSetup();this._abortRendererChange();this._abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._updatingPendingLoadedGraphicsChange=e.removeMaybe(this._updatingPendingLoadedGraphicsChange);this.clear();this.graphicStateTracking=e.destroyMaybe(this.graphicStateTracking);
this.stage&&(this.stage.remove(this.stageLayer),this.stage=this.stageLayer=null);this._handles=e.destroyMaybe(this._handles);this._frameTask.remove();this._frameTask=I.ImmediateTask;this._spatialReference=null;this._set("owner",null);for(const b in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[b].reject(new F("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle=e.removeMaybe(this.sharedSymbolResourcesOwnerHandle);
this.propertiesPool=e.destroyMaybe(this.propertiesPool);this.pendingUpdatesPool=null;this.symbolConversionCache.clear();this.objectIdInvisibleSet.clear();this._spatialIndex=e.destroyMaybe(this._spatialIndex);this._set("featureStore",e.destroyMaybe(this.featureStore))};f.clear=function(){var b,a;null==(b=this.objectStates)?void 0:b.allGraphicsDeleted();e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(c=>c.destroy());null==(a=this._spatialIndex)?
void 0:a.clear();this.graphics3DGraphics.clear();this._usedMemory=this.numberOfGraphics=0;this._updateLayerVisibility();this.symbols.forEach(e.destroyMaybe);this.symbols.clear();this.graphicsBySymbol.clear();this.graphicsWithoutSymbol.clear();this.graphicsWaitingForSymbol.clear();this.pendingUpdates.clear();this.pendingUpdatesPool.clear();this.pendingRemoves=this.pendingAdds=0;this.notifyChange("updating");this.notifyChange("running");this.notifyChange("updatingRemaining");this.featureStore.events.emit("changed")};
f._initializeStage=function(b,a){this.stage=b._stage;this.stageLayer=new ya.WebGLLayer({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},a);this.stage.add(this.stageLayer);b=this.stageLayer.events;b.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.metadata.graphicUid));b.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.metadata.graphicUid));b.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));
b.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));b.on("vertexAttrsUpdated",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid))};f.notifyGraphicGeometryChanged=function(b){e.isNone(this.graphicStateTracking)||e.isNone(b)||(b=this.graphics3DGraphics.get(b))&&this.graphicStateTracking.updateGraphicGeometry(b)};f.notifyGraphicVisibilityChanged=function(b){e.isNone(this.graphicStateTracking)||e.isNone(b)||(b=this.graphics3DGraphics.get(b))&&
this.graphicStateTracking.updateGraphicVisibility(b)};f._updateLayerVisibility=function(){var b=this.numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;b=!this.suspendedOrOutsideOfView&&!b;b!==this._visible&&((this._visible=b)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())};f._updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||
0<this.layer.opacity)};f.getGraphics3DGraphicById=function(b){return this.graphics3DGraphics.get(b)};f.getGraphics3DGraphicByObjectId=function(b){var a;return null!=(a=this.owner.layer)&&a.objectIdField?this._findGraphics3DGraphicByObjectId(b):null};f._getGraphicObjectID=function(b,a=this.owner.layer&&this.owner.layer.objectIdField){return O.getObjectId(b,a)};f.updateLabelingInfo=function(){var b=y._asyncToGenerator(function*(a){const c=this.deconflictor&&this.deconflictor.labelingInfoChange(a);a=
this.labeler&&this.labeler.labelingInfoChange(a);yield A.eachAlways([c,a])});return function(a){return b.apply(this,arguments)}}();f.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange();this.labeler&&this.labeler.visibilityInfoChange()};f.runTask=function(b){this._frameTask.processQueue(b);this._applyPendingUpdates(b);this.notifyChange("running");this.running||this.notifyChange("updating");this.notifyChange("updatingRemaining")};f.setObjectIdVisibility=function(b,
a){a?this.objectIdInvisibleSet.delete(b):this.objectIdInvisibleSet.add(b);b=this._findGraphics3DGraphicByObjectId(b);e.isSome(b)&&this._updateUserVisibility(b)};f._findGraphics3DGraphicByObjectId=function(b){return T.findInMap(this.graphics3DGraphics,a=>this._getGraphicObjectID(a.graphic)===b)};f._updateUserVisibility=function(b){if(e.isNone(b))return!1;var a=b.graphic;const c=this._getGraphicObjectID(a);a=a.visible&&!this.owner.suspended&&(e.isNone(c)||!this.objectIdInvisibleSet.has(c));return b.setVisibilityFlag(K.VisibilityFlag.USER_SETTING,
a,K.VisibilityGroup.GRAPHIC)};f._whenGraphics3DGraphic=function(b){var a=this.graphics3DGraphics.get(b.uid);if(a)return Promise.resolve(a);if(a=this.whenGraphics3DGraphicRequests[b.uid])return a.promise;a=A.createDeferred();this.whenGraphics3DGraphicRequests[b.uid]=a;return a.promise};f._boundsForGraphics3DGraphic=function(){var b=y._asyncToGenerator(function*(a,c){const d=this._spatialReference,g=this.owner.view.renderSpatialReference,h=this.owner.view.basemapTerrain.spatialReference;var k=this.viewElevationProvider?
{service:this.viewElevationProvider,useViewElevation:e.isSome(c)&&c.useViewElevation,minDemResolution:e.isSome(c)&&c.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null;a=yield a.getProjectedBoundingBox((n,r,z)=>C.projectBuffer(n,g,r,n,d,r,z),(n,r,z)=>C.projectBuffer(n,h,r,n,d,r,z),k,e.get(c,"signal"));if(!a)return null;c=a.boundingBox;a.requiresDrapedElevation&&(k=this.symbolCreationContext.elevationProvider)&&(H.center(c,R),k=e.unwrapOr(k.getElevation(R[0],R[1],0,d,"ground"),
0),c[2]=Math.min(c[2],k),c[5]=Math.max(c[5],k));return{boundingBox:c,screenSpaceObjects:a.screenSpaceObjects}});return function(a,c){return b.apply(this,arguments)}}();f.whenGraphicBounds=function(){var b=y._asyncToGenerator(function*(a,c){yield D.whenOnce(this.owner,"loadedGraphics");const d=this.owner.layer&&this.owner.layer.objectIdField;var g=this.owner.loadedGraphics.find(h=>h===a?!0:d&&h.attributes&&a.attributes&&h.attributes[d]===a.attributes[d]);if(!g)throw new F("internal:graphic-not-part-of-view",
"Graphic is not part of this view");g=yield this._whenGraphics3DGraphic(g);return this._boundsForGraphics3DGraphic(g,c)});return function(a,c){return b.apply(this,arguments)}}();f.computeAttachmentOrigin=function(b,a){b=this.graphics3DGraphics.get(b.uid);if(!b)return null;var c=b.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;G.set(B,0,0,0);b=0;if(0<c.render.num){if(!C.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,
E,a))return null;G.add(B,B,E);b++}if(0<c.draped.num){const [d,g]=c.draped.origin;c=e.unwrapOr(this.viewElevationProvider.getElevation(d,g,"ground"),0);G.set(E,d,g,c);if(!C.projectVectorToVector(E,this.viewElevationProvider.spatialReference,E,a))return null;G.add(B,B,E);b++}1<b&&G.scale(B,B,1/b);return new Aa({x:B[0],y:B[1],z:B[2],spatialReference:a})};f.getSymbolLayerSize=function(b,a){var c=this.symbols.get(b.id);if(e.isNone(c))throw new F("internal:symbol-not-part-of-view","Symbol is not part of this view");
b=b.symbolLayers.indexOf(a);if(-1===b)throw new F("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(b);if(null==c)throw new F("internal:missing-size","Symbol layer has no valid size");return c};f._graphicsCollectionChanged=function(b){this._startCreateGraphics&&(this.add(b.added),this.remove(b.removed))};f.graphicUpdateHandler=function(b){const a=b.graphic.uid,c=this.graphics3DGraphics.get(a);if(!e.isNone(c)||!e.isNone(this.graphicsWithoutSymbol.get(a)))switch(b.property){case "visible":this._graphicUpdateVisibleHandler(c);
break;case "geometry":this._graphicUpdateGeometryHandler(c,b);break;case "symbol":this._graphicUpdateSymbolHandler(c,b);break;case "transform":this._graphicUpdateTransformHandler(c,b)}};f._graphicUpdateGeometryHandler=function(b,a){const c=a.graphic.geometry;if(e.isNone(c))this._recreateGraphic(a.graphic);else if(e.isNone(b)){if(b=a.graphic.symbol&&a.graphic.symbol.id)if(b=this.symbols.get(b),e.isSome(b)&&b.loadStatus===sa.LoadStatus.LOADING)return;this._recreateGraphic(a.graphic)}else{var d=b.graphics3DSymbol;
!e.isNone(a.newValue)&&d.updateGeometry(b,a.newValue)||this._recreateGraphic(b.graphic);this._expandComputedExtent(c)}};f._graphicUpdateSymbolHandler=function(b,a){var c=a.graphic;const d=e.isSome(b)?b.graphics3DSymbol:e.isSome(a.oldValue)?this.symbols.get(a.oldValue.id):null;if(e.isNone(d)||e.isNone(a.newValue))this._recreateGraphic(c);else{var g=d.symbol;a=this._getConvertedSymbol(a.newValue);if(e.isSome(a)&&(a.type!==g.type||"web-style"===a.type)||"web-style"===g.type)this._recreateGraphic(c);
else{var h=this.graphicsBySymbol.get(g.id);if(h&&1!==h.size)this._recreateGraphic(c);else if(h=N.diff(g,a),e.isNone(h))this._updateSymbolMapping(g.id,a);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(h),N.isEmpty(h.diff)){var k=this._getRenderingInfo(c);if(e.isNone(k))this._recreateGraphic(c);else{c=d.extentPadding;for(const n of h.symbolStatePatches)n();c!==d.extentPadding&&this._recomputeExtentPadding();if(e.isSome(b))for(const n of h.graphics3DGraphicPatches)n(b,
k);this._updateSymbolMapping(g.id,a)}}else this._recreateGraphic(c)}}};f._graphicUpdateVisibleHandler=function(b){this._updateUserVisibility(b)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};f._graphicUpdateTransformHandler=function(b,a){};f.recreateGraphics=function(b){this.suspendSymbolCleanup=!0;this.remove(b);this.add(b);this.suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&this._cleanupSymbols()};f._recreateGraphic=function(b){this.recreateGraphics([b])};
f._beginGraphicUpdate=function(b){const a=this.graphicsUpdateId;this.graphicsUpdateId++;this.graphicsWaitingForSymbol.set(b.uid,a);1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating");return a};f._endGraphicUpdate=function(b){b&&(this.graphicsWaitingForSymbol.delete(b.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))};f._recomputeExtentPadding=function(){let b=0;this.symbols.forEach(a=>{e.isSome(a)&&(b=Math.max(b,a.extentPadding))});
this._set("extentPadding",b)};f._expandComputedExtent=function(b){var a=b.spatialReference;O.computeAABB(b,q);b=this._spatialReference;var c=Q.tmpVec;!a.equals(b)&&C.projectXYZToVector(q[0],q[1],0,a,c,b)&&(q[0]=c[0],q[1]=c[1],C.projectXYZToVector(q[3],q[4],0,a,c,b),q[3]=c[0],q[4]=c[1]);if(isFinite(q[0])&&isFinite(q[3])&&isFinite(q[1])&&isFinite(q[4])){a=this.computedExtent;c=null;var d=isFinite(q[2])&&isFinite(q[5]),g=d&&(!a||null==a.zmin||q[2]<a.zmin);d=d&&(!a||null==a.zmax||q[5]>a.zmax);if(a){if(q[0]<
a.xmin||q[1]<a.ymin||q[3]>a.xmax||q[4]>a.ymax||g||d)c=this.propertiesPool.get("computedExtent"),c.xmin=Math.min(q[0],a.xmin),c.ymin=Math.min(q[1],a.ymin),c.xmax=Math.max(q[3],a.xmax),c.ymax=Math.max(q[4],a.ymax),c.spatialReference=b}else c=this.propertiesPool.get("computedExtent"),c.xmin=q[0],c.ymin=q[1],c.xmax=q[3],c.ymax=q[4],c.spatialReference=b;c&&(g&&(c.zmin=q[2]),d&&(c.zmax=q[5]),this._set("computedExtent",c))}};f._abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&
(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)};f.elevationInfoChange=function(){var b=y._asyncToGenerator(function*(){var a,c;this._abortElevationInfoChange();const d=new AbortController;this.elevationInfoChangeAbortController=d;const g=L.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield L.createContext(g,this._spatialReference,u);A.throwIfAborted(d);
this.elevationInfoChangeAbortController=null;null==(a=this.labeler)?void 0:a.elevationInfoChange();this.forEachGraphics3DSymbol((h,k,n)=>{h.globalPropertyChanged("elevationInfo",k)?k.forEach(r=>{const z=r.graphic;r=r.labelGraphics;for(const x of r)x.graphics3DSymbolLayer.updateGraphicElevationContext(z,x)}):this._recreateSymbol(n)});this.updateStageLayerElevationProvider();null==(c=this.elevationAlignment)?void 0:c.elevationInfoChange()});return function(){return b.apply(this,arguments)}}();f.updateStageLayerElevationProvider=
function(){if(this.stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this.numberOfGraphicsProvidingElevation&&(this.stageLayerElevationProvider=
new ua.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))};f._clearSymbolsAndGraphics=function(){var b,a,c,d,g;this.clear();null==(b=this.filterVisibility)?void 0:b.clear();null==(a=this.labeler)?void 0:a.reset();null==(c=this.deconflictor)?void 0:c.clear();null==(d=this.elevationAlignment)?void 0:d.clear();null==(g=this.stageLayer)?void 0:g.invalidateSpatialQueryAccelerator();
this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)};f.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};f.recreateAllGraphics=function(){this._recreateAllGraphics(!1)};f.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)};f._recreateAllGraphics=function(b=!1){if(this._startCreateGraphics){var {loadedGraphics:a,
view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&a&&a.length?a.toArray():null;!b&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(b?this.add(d):this.recreateGraphics(d))}};f._recreateSymbol=function(b){var a=this.graphicsBySymbol.get(b);const c=[];a&&(a.forEach((d,
g)=>{var h;const k=d.usedMemory;this._conditionalRemove(d,g);null==(h=this._spatialIndex)?void 0:h.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(g,k);this._updateLayerVisibility();this.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(b,new Map));a=this.symbols.get(b);e.destroyMaybe(a);this.symbols.delete(b);this.add(c)};f._recreateGraphicsForSymbol=function(b){if(b=this.graphicsBySymbol.get(b)){const a=[];b.forEach(c=>a.push(c.graphic));this.recreateGraphics(a)}};
f._conditionalRemove=function(b,a){var c,d,g;this.graphicsDrapedUids.delete(a);null==(c=this.objectStates)?void 0:c.removeGraphic(b);null==(d=this.labeler)?void 0:d.removeGraphic(b);null==(g=this.deconflictor)?void 0:g.removeGraphic(b);e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(b)};f.add=function(b){b&&0!==b.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(b)===v.UpdatePolicy.ASYNC?this._addDelayed(b):
this._addImmediate(b),this.notifyChange("updating")):u.error("#add()","Cannot add graphics before terrain surface has been initialized"))};f._updatePolicyForGraphics=function(b){if(this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const a of b)if(e.isSome(a.geometry)&&"mesh"===a.geometry.type&&!a.geometry.loaded)return v.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy};f._addImmediate=function(b){this.symbolWarningLogged=this.geometryWarningLogged=
!1;for(const a of b)this._addGraphic(a,this._getRenderingInfo(a,u),v.UpdatePolicy.SYNC);this._cleanupSymbols();this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};f._addDelayed=function(b){for(const a of b){b=a.uid;let c=this.pendingUpdates.get(b);c?c.add?c.state!==t.NEW&&c.abortController.abort():this.pendingAdds++:(c=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(b,c));c.add=a}this.notifyChange("running");
this.notifyChange("updatingRemaining")};f.remove=function(b){this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?this._removeDelayed(b):this._removeImmediate(b);this.notifyChange("updating")};f._removeImmediate=function(b){for(const a of b)this._removeGraphic(a);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};f._removeDelayed=function(b){for(const c of b){b=c.uid;var a=this.pendingUpdates.get(b);a?a.add&&(a.remove?a.add=null:this.pendingUpdates.delete(b),
a.state===t.LOADING&&a.abortController.abort(),this.pendingAdds--):(a=this.pendingUpdatesPool.pushNew(),a.remove=c,this.pendingUpdates.set(b,a),this.pendingRemoves++)}0===this.pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining")};f._finishPendingUpdates=function(){this.pendingUpdatesPool.clear();this._cleanupSymbols();(this.pendingAdds||this.pendingRemoves)&&u.warn("pendingAdds/Removes in inconsistent state!");this.pendingRemoves=this.pendingAdds=
0};f._applyPendingUpdates=function(b){var a;this.symbolWarningLogged=this.geometryWarningLogged=!1;if(0===this.pendingUpdates.size&&null!=(a=this._spatialIndex)&&a.updating)this._spatialIndex.update();else{for(const [c,d]of this.pendingUpdates){if(b.done)break;d.add&&d.state===t.NEW&&this._processPendingUpdateNew(d);a=this.effectiveUpdatePolicy;!d.remove||d.add&&d.state!==t.READY||(this.pendingRemoves--,b.madeProgress(),this._removeGraphic(d.remove),d.remove=null,a=v.UpdatePolicy.SYNC);if(d.add)switch(d.state){case t.READY:this._addGraphic(d.add,
d.renderingInfo,a);d.add=null;this.pendingAdds--;b.madeProgress();break;case t.REJECTED:d.add=null,this.pendingAdds--}null==d.remove&&null==d.add&&this.pendingUpdates.delete(c)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}};f._processPendingUpdateNew=function(b){if(b.add){var a=b.add.geometry;e.isSome(a)&&"mesh"===a.type&&!a.loaded?this._processPendingUpdateNewMesh(b,a):this._processPendingUpdateNewRenderingInfo(b)}else b.state=t.READY};f._processPendingUpdateNewMesh=
function(){var b=y._asyncToGenerator(function*(a,c){a.state=t.LOADING;a.abortController=new AbortController;const d=a.abortController.signal;try{yield c.load({signal:d})}catch(g){return this._processPendingUpdateNewError(a,g)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)});return function(a,c){return b.apply(this,arguments)}}();f._processPendingUpdateNewError=function(b,a){b.abortController=null;A.isAbortError(a)?b.state=t.NEW:b.state=t.REJECTED};f._processPendingUpdateNewRenderingInfo=
function(){var b=y._asyncToGenerator(function*(a){if(e.isNone(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,u);else{a.state=t.LOADING;a.abortController=new AbortController;var c=null;try{c=yield this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(d){a.abortController=null;A.isAbortError(d)?a.state=t.NEW:a.state=t.REJECTED;return}e.isNone(c)||e.isNone(c.symbol)?(u&&!this.symbolWarningLogged&&(this.symbolWarningLogged=
!0,u.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=c}a.state=t.READY});return function(a){return b.apply(this,arguments)}}();f._addGraphic=function(b,a,c){this.graphicsWithoutSymbol.set(b.uid,b);if(!e.isNone(a)&&!e.isNone(a.symbol)&&O.hasGeometry(b)){var d=this.getOrCreateGraphics3DSymbol(a.symbol,a.renderer);if(!e.isNone(d)){this._expandComputedExtent(b.geometry);var g=this._beginGraphicUpdate(b),h=new ma(b,a,this.layer),k=!1,n=
x=>{x===d.symbol.id&&(k=!0)};this._whenSymbolRemoved.push(n);var r=()=>{if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(n);if(this.graphicsWaitingForSymbol.get(b.uid)!==g||k||d.destroyed||this.graphicSymbolSupported&&b.symbol&&b.symbol.id!==d.symbol.id)--d.referenced;else{const x=this._createGraphics3DGraphic(d,h);this._spatialIndex&&e.isSome(x)&&this._spatialIndex.add(x);--d.referenced;this._endGraphicUpdate(b)}this.featureStore.events.emit("changed");this.labeler&&this.owner.view.labeler.setDirty()}},
z=x=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(n),k||(A.isAbortError(x)?this.add([b]):d.destroyed||this._endGraphicUpdate(b)))};c===v.UpdatePolicy.ASYNC?d.load(()=>this._frameTask.schedule(r),x=>this._frameTask.schedule(()=>z(x))):d.load(r,z)}}};f._removeGraphic=function(b){b=b.uid;const a=this.graphics3DGraphics.get(b);if(a){var c;a.graphics3DSymbol.onRemoveGraphic(a);const d=a.usedMemory,g=a.isElevationSource;this._conditionalRemove(a,b);null==(c=this._spatialIndex)?void 0:c.remove(a);
this.graphicsBySymbol.get(a.graphics3DSymbol.symbol.id).delete(b);this.graphicsWithoutSymbol.delete(b);this._removeGraphics3DGraphic(b,d,g);a.destroy();this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(b),this.graphicsWaitingForSymbol.delete(b),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};f._hasLabelingContext=function(b){if(b instanceof Z||b instanceof Ba){const a=this.symbolCreationContext.layer;return a.labelingInfo?
a.labelingInfo.some(c=>c.symbol===b):!1}return!1};f._hasValidSymbolCreationContext=function(b){return b instanceof Z&&!this._hasLabelingContext(b)?(u.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};f._getRenderingInfo=function(b,a){const c=b.geometry;if(e.isNone(c))return a&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;
if(!C.canProjectWithoutEngine(c.spatialReference,this._spatialReference))return a&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(b.symbol))return a&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;b=this.rendererHasGeometryOperations?
P.hydrateGraphic(b,this.layer):b;b=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||e.isSome(this.currentRenderer))?this.owner.getRenderingInfo(b,this.currentRenderer,e.unwrap(this.arcadeOnDemand)):{symbol:b.symbol||ja.getDefaultSymbol3D(b.geometry)};return e.isNone(b)||e.isNone(b.symbol)?(a&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):b};f._getRenderingInfoAsync=function(b,a){if(e.isNone(b.geometry))return u&&
!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(b.symbol))return u&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;b=this.rendererHasGeometryOperations?P.hydrateGraphic(b,this.layer):b;return this.owner.getRenderingInfoAsync(b,e.unwrap(this.currentRenderer),
e.unwrap(this.arcadeOnDemand),a)};f._createGraphics3DSymbol=function(b,a){if(!this._hasValidSymbolCreationContext(b))return null;b=this._getConvertedSymbol(b);if(!b)return null;let c;e.isSome(a)&&"backgroundFillSymbol"in a&&a.backgroundFillSymbol&&(a=W.to3D(a.backgroundFillSymbol,{ignoreDrivers:!0}),e.isSome(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(c=a.symbol.symbolLayers));const d=oa.make(b,this.symbolCreationContext,c);d.load(()=>{const g=d.extentPadding;g>this.extentPadding&&
this._set("extentPadding",g);this.notifyChange("averageSymbolComplexity")},()=>{});return d};f.getOrCreateGraphics3DSymbol=function(b,a){let c=this.symbols.get(b.id);void 0===c&&(c=b instanceof Ca?new pa(b,d=>this._frameTask.schedule(d),d=>this._createGraphics3DSymbol(d,a)):this._createGraphics3DSymbol(b,a),this.symbols.set(b.id,c));e.isSome(c)&&++c.referenced;return c};f.trackGraphicState=function(b){e.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new qa.GraphicStateTracking(this));
return this.graphicStateTracking.add(b)};f._addGraphics3DGraphic=function(b){this._usedMemory+=b.usedMemory;this.graphics3DGraphics.set(b.graphic.uid,b);this.numberOfGraphics++;b.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};f._removeGraphics3DGraphic=function(b,a,c=!1){this._usedMemory-=a;this.graphics3DGraphics.delete(b);this.numberOfGraphics--;c&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());
this._updateLayerVisibility()};f._createGraphics3DGraphic=function(b,a){var c,d,g,h;const k=a.graphic;this.graphicsWithoutSymbol.delete(k.uid);if(!this.symbols.has(b.symbol.id))return this.add([k]),null;if(this.graphics3DGraphics.has(k.uid))return null;a=b.createGraphics3DGraphic(a);if(e.isNone(a))return null;this._addGraphics3DGraphic(a);b=b.symbol.id;this.graphicsBySymbol.has(b)||this.graphicsBySymbol.set(b,new Map);this.graphicsBySymbol.get(b).set(k.uid,a);a.isDraped&&this.graphicsDrapedUids.add(k.uid);
a.centroid=null;e.isSome(k.geometry)&&"point"!==k.geometry.type&&(a.centroid=ra.computeCentroid(k.geometry,this._spatialReference));this._updateUserVisibility(a);e.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(a);null==(c=this.filterVisibility)?void 0:c.updateVisibility(a);null==(d=this.deconflictor)?void 0:d.addGraphic(a);null==(g=this.labeler)?void 0:g.addGraphic(a);null==(h=this.objectStates)?void 0:h.addGraphic(a);this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,
a);a.initialize(this.stage,this.stageLayer,this.owner);e.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(a);if(c=this.whenGraphics3DGraphicRequests[k.uid])delete this.whenGraphics3DGraphicRequests[k.uid],c.resolve(a);return a};f._abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)};f.rendererChange=function(){var b=y._asyncToGenerator(function*(a){this._abortRendererChange();
if(a!==this.currentRenderer)if(this._validateRenderer(a),e.isNone(a)&&this._currentRendererChange(null,!1),V.isSupportedRenderer3D(a))if(e.isSome(a)&&a.arcadeRequired){var c=new AbortController;this.rendererChangeAbortController=c;const {arcadeUtils:d}=yield this._ensureArcade();A.throwIfAborted(c);d.hasGeometryOperations(a)&&(yield d.enableGeometryOperations(),A.throwIfAborted(c));this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?yield this._frameTask.schedule(()=>this._currentRendererChange(a,!0),
c.signal):this._currentRendererChange(a,!0);this.rendererChangeAbortController=null}else this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?(this.rendererChangeAbortController=c=new AbortController,yield this._frameTask.schedule(()=>this._currentRendererChange(a,!1),c.signal),this.rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,!1)});return function(a){return b.apply(this,arguments)}}();f._ensureArcade=function(){var b=y._asyncToGenerator(function*(){e.isNone(this.arcadeOnDemand)&&
(this.arcadeOnDemand=yield ia.loadArcade());return this.arcadeOnDemand});return function(){return b.apply(this,arguments)}}();f._currentRendererChange=function(b,a){this.currentRenderer=b;this.rendererHasGeometryOperations=a;this.symbolCreationContext.arcade=e.unwrap(this.arcadeOnDemand);a=this.symbolCreationContext.renderer;if(b!==a)if(this.symbolConversionCache.clear(),e.isNone(b))this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=N.diff(a,b);this._updateUnchangedSymbolMappings(c,
b,a);this.symbolCreationContext.renderer=b;e.isNone(c)||("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,b,a)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}};f._diffHasSymbolChange=function(b){for(const a in b.diff)switch(a){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete b.diff[a];break;default:return!0}return!1};
f._applySymbolSetDiff=function(b,a,c){b=b||[];a=a||[];const d=[];for(const g of a){const h=this.graphicsBySymbol.get(g.id);h&&h.forEach((k,n)=>{var r=k.graphic,z=this.layer instanceof ha?this.layer:null;const x=e.unwrap(this.arcadeOnDemand);if(g!==c.defaultSymbol||c.getSymbol(P.hydrateGraphic(r,z),{arcade:x})!==c.defaultSymbol)z=k.usedMemory,b.length||c.defaultSymbol?d.push(r):this.graphicsWithoutSymbol.set(n,r),r=this.graphics3DGraphics.get(n),this._conditionalRemove(r,n),k.destroy(),h.delete(n),
this._removeGraphics3DGraphic(n,z),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(k=>k(g.id))}if(b.length||d.length)this.graphicsWithoutSymbol.forEach(g=>d.push(g)),this.graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};f._applyUniqueValueRendererDiff=function(b,a,c){const d=b.diff.defaultSymbol,g=b.diff.uniqueValueInfos;if(d||g){const h=g?g.added.map(n=>n.symbol):[],k=g?g.removed.map(n=>
n.symbol):[];if(g)for(let n=0;n<g.changed.length;n++)h.push(g.changed[n].newValue.symbol),k.push(g.changed[n].oldValue.symbol);d?(c.defaultSymbol&&k.push(c.defaultSymbol),a.defaultSymbol&&h.push(a.defaultSymbol)):c.defaultSymbol&&h.length&&k.push(a.defaultSymbol);this._applySymbolSetDiff(h,k,a);delete b.diff.defaultSymbol;delete b.diff.uniqueValueInfos;return!0}return!1};f._calculateUnchangedSymbolMapping=function(b,a,c){if("unique-value"!==(null==a?void 0:a.type)||"unique-value"!==(null==c?void 0:
c.type)||e.isSome(b)&&"partial"!==b.type)return[];const d=h=>e.isSome(h)?h.id:null;var g=b&&b.diff;b=g&&g.defaultSymbol;if(g=g&&g.uniqueValueInfos)g=g.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)}));else{g=[];for(const h of c.uniqueValueInfos){const k=d(h.symbol),n=a.uniqueValueInfos.find(r=>r.value===h.value);n&&k!==d(n.symbol)&&g.push({oldId:k,newId:d(n.symbol)})}}!b&&c.defaultSymbol&&g.push({oldId:d(c.defaultSymbol),newId:d(a.defaultSymbol)});return g};f._updateSymbolMapping=
function(b,a){const c=e.isSome(a)&&a?"string"===typeof a?a:a.id:null;if(b&&b!==c){var d=this.graphicsBySymbol.get(b);this.graphicsBySymbol.delete(b);void 0!==d&&this.graphicsBySymbol.set(c,d);d=this.symbols.get(b);void 0!==d&&(this.symbols.delete(b),this.symbols.set(c,d),e.isSome(d)&&(b="string"===typeof a?null:a,e.isSome(b)?d.symbol=b:d.symbol.id=c))}};f._updateUnchangedSymbolMappings=function(b,a,c){b=this._calculateUnchangedSymbolMapping(b,a,c);for(const {oldId:d,newId:g}of b)this._updateSymbolMapping(d,
g)};f._applyRendererDiff=function(b,a,c){if(this._diffHasSymbolChange(b))return!1;if(a instanceof S&&c instanceof S&&this._applyUniqueValueRendererDiff(b,a,c)&&0===Object.keys(b.diff).length)return!0;for(const [d]of this.graphicsBySymbol)if(c=this.symbols.get(d),e.isSome(c))switch(c.applyRendererDiff(b,a)){case X.ApplyRendererDiffResult.Recreate_Symbol:this._recreateSymbol(d);break;case X.ApplyRendererDiffResult.Recreate_Graphics:this._recreateGraphicsForSymbol(d)}return!0};f.opacityChange=function(){this.forEachGraphics3DSymbol((b,
a)=>b.globalPropertyChanged("opacity",a));this._updateStageLayerVisibility()};f._slicePlaneEnabledChange=function(b){b!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=b,this.stageLayer.isSliceable=b,this.forEachGraphics3DSymbol((a,c)=>a.globalPropertyChanged("slicePlaneEnabled",c)),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())};f._physicalBasedRenderingChange=function(b){b!==this.symbolCreationContext.physicalBasedRenderingEnabled&&
(this.symbolCreationContext.physicalBasedRenderingEnabled=b,this.forEachGraphics3DSymbol((a,c,d)=>{a.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)}))};f._pixelRatioChange=function(){this.forEachGraphics3DSymbol((b,a,c)=>{b.globalPropertyChanged("pixelRatio",a)||this._recreateSymbol(c)})};f._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=
da.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};f.setClippingExtent=function(b,a){const c=this.symbolCreationContext.clippingExtent,d=fa.create();va.toBoundingRect(b,d,a)?this.symbolCreationContext.clippingExtent=H.fromRect(H.create(),d):this.symbolCreationContext.clippingExtent=null;return!H.equals(this.symbolCreationContext.clippingExtent,c)};f.modifyGraphics3DGraphicVisibilities=function(b){let a=!1;this.graphics3DGraphics.forEach(c=>{b(c)&&(a=!0)});a&&(this.labeler&&this.owner.view.labeler.setDirty(),
this.owner.view.deconflictor.setDirty())};f.forEachGraphics3DSymbol=function(b){for(const [a,c]of this.symbols){if(e.isNone(c))break;const d=this.graphicsBySymbol.get(a);b(c,d||Ea,a)}};f.updateAllGraphicsVisibility=function(){this.filterVisibility&&(this.filterVisibility.dirty=!0);this.modifyGraphics3DGraphicVisibilities(b=>{const a=this._updateUserVisibility(b);b=e.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(b);return a||b})};f._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(b=>
b.setVisibilityFlag(K.VisibilityFlag.USER_SETTING,!1,K.VisibilityGroup.GRAPHIC))};f._validateRenderer=function(b){(b=V.validateTo3D(b))&&u.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,b.message)};f._volatileGraphicsUpdated=function(){var b;null==(b=this.labeler)?void 0:b.reset();this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};f._cleanupSymbols=function(){if(!(0<this.graphicsWaitingForSymbol.size||
this.suspendSymbolCleanup)){var b=!1;this.symbols.forEach((a,c)=>{if(!(e.isNone(a)||0<a.referenced)){var d=this.graphicsBySymbol.get(c);d&&0!==d.size||(this.graphicsBySymbol.delete(c),this.symbols.delete(c),e.destroyMaybe(a),b=!0)}});b&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};y._createClass(M,[{key:"spatialIndex",get:function(){if(!this._spatialIndex){var b;this._spatialIndex=new ta.SpatialIndex2D({objectIdField:null==(b=this.owner.layer)?void 0:b.objectIdField,
spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))}this._spatialIndex.update();return this._spatialIndex}},{key:"effectiveUpdatePolicy",get:function(){return e.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?v.UpdatePolicy.ASYNC:e.unwrapOr(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"updating",get:function(){var b,a;return!!(0<this.graphicsWaitingForSymbol.size||this.running||
null!=(b=this.elevationAlignment)&&b.updating||e.isSome(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(a=this.filterVisibility)&&a.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}},{key:"running",get:function(){var b;return 0<this.pendingUpdates.size||!(null==(b=this._spatialIndex)||!b.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var b;return this.owner.suspended||
(null==(b=this.owner.suspendInfo)?void 0:b.outsideOfView)}},{key:"updatingRemaining",get:function(){var b,a;return this.updating?this.pendingUpdates.size+.1*((null==(b=this._spatialIndex)?void 0:b.updatingRemaining)||0)+.1*((null==(a=this.elevationAlignment)?void 0:a.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var b=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const a=b?b.graphics3D.minTotalNumberOfFeatures:0,c=b?b.graphics3D.maxTotalNumberOfFeatures:0;b=b?
b.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;var g=Math.max(1,e.isSome(d)?d.primitivesPerFeature:1),h=e.isSome(d)&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;g=Math.max(a,Math.min(c,Math.ceil(b/g),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===a&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===b&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===g?h:{minimumTotalNumberOfFeatures:a,maximumTotalNumberOfFeatures:c,
maximumTotalNumberOfPrimitives:b,averageSymbolComplexity:d,maximumNumberOfFeatures:g}}},{key:"averageSymbolComplexity",get:function(){const b=Y.averageSymbolComplexities(this.symbolComplexities),a=this._get("averageSymbolComplexity");return 0===b.numComplexities||e.isSome(a)&&(b.estimated&&(a.primitivesPerFeature>=b.primitivesPerFeature||a.primitivesPerCoordinate>=b.primitivesPerCoordinate||a.drawCallsPerFeature>=b.drawCallsPerFeature)||a.primitivesPerFeature===b.primitivesPerFeature&&a.primitivesPerCoordinate===
b.primitivesPerCoordinate&&a.drawCallsPerFeature===b.drawCallsPerFeature)?a:b}},{key:"spatialReference",get:function(){return this._spatialReference}},{key:"usedMemory",get:function(){const b=e.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+b}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this.numberOfGraphics?30<Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics?
0:this._usedMemory/this.numberOfGraphics:e.isSome(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},
{key:"graphics3DGraphicsByObjectID",get:function(){const b=this.owner.layer&&this.owner.layer.objectIdField;if(!b)return null;const a=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,b);e.isSome(d)&&a.set(d,c)}});return a}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<this.pendingUpdates.size)return"unknown";let b=0,a=0;return T.someMap(this.symbols,(c,d)=>{if(e.isSome(c)){c=
c.getFastUpdateStatus();if(0<c.loading)return!0;this.graphicsBySymbol.has(d)&&(a+=c.fast,b+=c.slow)}return!1})?"unknown":0<=a&&0===b?"fast":0<=b&&0===a?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map(b=>({symbolId:b,graphics:[...this.graphicsBySymbol.get(b).keys()].sort()})),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),
graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}),symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:b=>{this.forcedUpdatePolicy=b}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]);return M}(aa);l.Graphics3DCore.tmpVec=J.create();m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,
"computedExtent",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"currentRenderer",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"_frameTask",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"rendererChangeAbortController",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"elevationInfoChangeAbortController",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,
"setupAbortController",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"elevationAlignment",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"scaleVisibility",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"filterVisibility",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"_spatialIndex",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"extentPadding",void 0);m.__decorate([p.property()],
l.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"featureStore",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"deconflictor",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"labeler",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"objectStates",void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"preferredUpdatePolicy",
void 0);m.__decorate([p.property()],l.Graphics3DCore.prototype,"forcedUpdatePolicy",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"effectiveUpdatePolicy",null);m.__decorate([p.property({constructOnly:!0})],l.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);m.__decorate([p.property({constructOnly:!0})],l.Graphics3DCore.prototype,"owner",void 0);m.__decorate([p.property({constructOnly:!0})],l.Graphics3DCore.prototype,"layer",void 0);m.__decorate([p.property({constructOnly:!0})],
l.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);m.__decorate([p.property({constructOnly:!0})],l.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"updating",null);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"running",null);m.__decorate([p.property({readOnly:!0})],l.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);m.__decorate([p.property({readOnly:!0,dependsOn:[]})],l.Graphics3DCore.prototype,
"updatingRemaining",null);m.__decorate([p.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],l.Graphics3DCore.prototype,"displayFeatureLimit",null);m.__decorate([p.property({readOnly:!0,dependsOn:[]})],l.Graphics3DCore.prototype,"averageSymbolComplexity",null);m.__decorate([p.property({constructOnly:!0})],l.Graphics3DCore.prototype,"hasZ",void 0);m.__decorate([p.property({constructOnly:!0})],
l.Graphics3DCore.prototype,"hasM",void 0);l.Graphics3DCore=Q=m.__decorate([ea.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],l.Graphics3DCore);var t;(function(w){w[w.NEW=0]="NEW";w[w.LOADING=1]="LOADING";w[w.READY=2]="READY";w[w.REJECTED=3]="REJECTED"})(t||(t={}));let Da=function(){function w(){this.renderingInfo=this.add=null;this.state=t.NEW;this.remove=null}w.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=t.NEW;this.remove=this.abortController=null};return w}();
const B=J.create(),E=J.create(),Ea=new Map;Object.defineProperty(l,"__esModule",{value:!0})});