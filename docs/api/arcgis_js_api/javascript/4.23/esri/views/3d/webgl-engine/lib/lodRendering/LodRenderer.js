// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../chunks/mat4f64 ../../../../../chunks/vec2f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../support/debugFlags ../../../support/buffer/glUtil ../../core/shaderLibrary/output/OutputHighlight.glsl ../Camera ../DefaultVertexAttributeLocations ../IntersectorInterfaces ../Octree ../RenderPass ../RenderSlot ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./LodLevel ./RenderInstanceData ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../../../webgl/Util".split(" "),
function(y,z,Q,A,B,R,t,w,S,C,T,U,V,D,W,E,x,u,v,m,X,Y,Z,F,aa,ba,ca,G){function H(l,k,a){const b=l.allocateHead();l=l.view;ca.encodeDoubleVec3(k.modelOrigin,a,l.modelOriginHi,l.modelOriginLo,b);l.model.copyFrom(b,k.model,a);l.modelNormal.copyFrom(b,k.modelNormal,a);k.color&&l.color&&l.color.copyFrom(b,k.color,a);k.featureAttribute&&l.featureAttribute&&l.featureAttribute.copyFrom(b,k.featureAttribute,a)}let I=function(l){const k=l.baseBoundingSphere.radius;l=l.levels.map(a=>a.minScreenSpaceRadius);return new Y.LevelSelector(k,
l)},ea=function(){function l(a,b,c,e){this.type=W.IntersectorType.LOD;this.isGround=!1;this._inverseViewport=R.create();this._levels=[];this._defaultRenderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new V.default;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.slots=[u.RenderSlot.OPAQUE_PLUGIN,u.RenderSlot.TRANSPARENT_PLUGIN];this.canRender=!0;this._symbol=a;this._optionalFields=b;this._metadata=
c;this._instanceBufferLayout=aa.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._glInstanceBufferLayout=T.glLayout(this._instanceBufferLayout,1);this._instanceData=new m.InstanceData(this._optionalFields,e);this._instanceData.on("instance-added",()=>this._requestUpdateCycle());this._instanceData.on("instance-removed",()=>this._requestUpdateCycle());this._instanceData.on("instance-transform-changed",g=>{this._requestUpdateCycle();this._metadata.notifyGraphicGeometryChanged(g.index)});
this._instanceData.on("instance-visibility-changed",g=>{this._requestUpdateCycle(!0);this._metadata.notifyGraphicVisibilityChanged(g.index)});this._instanceData.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0));this._enableLevelSelection=1<this._symbol.levels.length}var k=l.prototype;k.initializeRenderContext=function(){var a=z._asyncToGenerator(function*(b,c){this._context=b;const e=b.renderContext.rctx,g=yield Promise.allSettled(this._symbol.levels.map(d=>{this._defaultRenderInstanceData.push(new F.RenderInstanceData(e,
this._instanceBufferLayout));this._highlightRenderInstanceData.push(new F.RenderInstanceData(e,this._instanceBufferLayout));return Z.LodLevel.create(b,d,c)})),h=g.map(d=>"fulfilled"===d.status?d.value:null).filter(d=>d);if(A.isAborted(c)||h.length!==g.length){h.forEach(d=>d.destroy());A.throwIfAborted(c);for(const d of g)if("rejected"===d.status)throw d.reason;}this._levels=h;this._levelSelector=I(this)});return function(b,c){return a.apply(this,arguments)}}();k.uninitializeRenderContext=function(){this._invalidateOctree();
this._levels.forEach(a=>a.destroy());this._defaultRenderInstanceData.forEach(a=>a.destroy());this._highlightRenderInstanceData.forEach(a=>a.destroy())};k.prepareRender=function(a,b){C.LOD_INSTANCE_RENDERER_DISABLE_UPDATES||(this._enableLevelSelection&&(a=b.equals(this._lastCamera),this._lastCamera.copyFrom(b),a||this._requestUpdateCycle()),a=this._needFullCycle?this._instanceData.size:2E3,this._needFullCycle=!1,this._updateInstances(b,a),this.needsUpdates&&this._context.requestRender())};k.render=
function(a){var b,c,e,g;const h=a.slot===u.RenderSlot.OPAQUE_PLUGIN?u.RenderSlot.OPAQUE_MATERIAL:a.slot===u.RenderSlot.TRANSPARENT_PLUGIN?u.RenderSlot.TRANSPARENT_MATERIAL:null;if(h&&this.baseMaterial.isVisible()&&this.baseMaterial.isVisibleInPass(a.pass)){var d=a.camera;this._inverseViewport[0]=1/d.fullViewport[2];this._inverseViewport[1]=1/d.fullViewport[3];d={slot:h,origin:[0,0,0],camera:d,inverseViewport:this._inverseViewport,shadowMap:a.shadowMap,shadowMappingEnabled:a.shadowMap.enabled,ssaoHelper:a.ssaoHelper,
ssaoEnabled:a.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:a.sliceHelper&&a.sliceHelper.plane,hudVisibilityTexture:null!=(b=null==(c=a.offscreenRenderingHelper)?void 0:c.hudVisibilityTexture)?b:null,highlightDepthTexture:null!=(e=null==(g=a.offscreenRenderingHelper)?void 0:g.depthTexture)?e:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:B.IDENTITY,ssrEnabled:!1,lighting:a.scenelightingData,transparencyPassType:a.transparencyPassType,
terrainLinearDepthTexture:a.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:a.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:a.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:a.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:a.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:a.hasFillLights};a.rctx.bindVAO();b=a.pass!==x.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;
a.pass!==x.RenderPass.MATERIAL_HIGHLIGHT&&a.pass!==x.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT&&this._renderComponents(a,h,d,this._defaultRenderInstanceData);b&&this._renderComponents(a,h,d,this._highlightRenderInstanceData)}};k.intersect=function(a,b,c,e){if(this.baseMaterial.isVisible()){var g=w.create();t.subtract(g,e,c);var h=d=>{this._instanceData.getCombinedModelTransform(d,J);a.transform.set(J);t.transformMat4(K,c,a.transform.inverse);t.transformMat4(L,e,a.transform.inverse);const p=this._instanceData.getState(d),
f=this._instanceData.getLodLevel(d);v.assert(p&m.StateFlags.ACTIVE,"invalid instance state");v.assert(0<=f&&f<this._levels.length,"invaid lod level");this._levels[f].intersect(a,b,K,L,d,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(h):this.octree.forEachAlongRay(c,g,h)}};k.queryDepthRange=function(a){return this._queryDepthRangeOctree(a)};k.notifyShaderTransformationChanged=function(){this._invalidateOctree()};k._requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=
-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._context.requestRender()};k._invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};k._buildOctree=function(){const a=new X.InstanceOctree(this._instanceData,this.baseBoundingSphere);var b=this._instanceData;b=b.view?b.view.state:null;for(let c=0;c<this._instanceData.capacity;++c)b.get(c)&m.StateFlags.ACTIVE&&a.addInstance(c);return a};k._queryDepthRangeOctree=function(a){var b=a.eye;const c=a.viewForward;var e=
this.octree.findClosest(c,E.DepthOrder.FRONT_TO_BACK,a.frustum);const g=this.octree.findClosest(c,E.DepthOrder.BACK_TO_FRONT,a.frustum);return null!=e&&null!=g?(this._instanceData.view.boundingSphere.getVec(e,r),t.subtract(r,r,b),e=t.dot(r,c)-r[3],this._instanceData.view.boundingSphere.getVec(g,r),t.subtract(r,r,b),b=t.dot(r,c)+r[3],{near:Math.max(a.near,e),far:Math.min(a.far,b)}):{near:Infinity,far:-Infinity}};k._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._defaultRenderInstanceData.forEach(a=>
{a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this.needsUpdates&&this._context.requestRender()};k._updateInstances=function(a,b){const c=this._enableLevelSelection,e=this._levelSelector;e.updateCamera(a);this._defaultRenderInstanceData.forEach(n=>{n.beginUpdate()});this._highlightRenderInstanceData.forEach(n=>{n.beginUpdate()});a=this._instanceData;const g=this._instanceData.view,h=a.capacity;let d=this._instanceIndex;b=Math.min(a.size,b);for(let n=0;n<
b;++n){0===d&&this._startUpdateCycle();const q=g.state.get(d);var p=0;if(q&m.StateFlags.ALLOCATED){var f=g.lodLevel.get(d);q&m.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[f].freeTail();q&m.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[f].freeTail();q&m.StateFlags.REMOVE?a.freeInstance(d):q&m.StateFlags.VISIBLE?(f=0,c&&(g.modelOrigin.getVec(d,M),f=e.selectLevel(M,a.getCombinedMedianScaleFactor(d))),p=q&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),0<=f&&(q&m.StateFlags.HIGHLIGHT?
(H(this._highlightRenderInstanceData[f],g,d),p|=m.StateFlags.HIGHLIGHT_ACTIVE):(H(this._defaultRenderInstanceData[f],g,d),p|=m.StateFlags.DEFAULT_ACTIVE)),g.state.set(d,p),g.lodLevel.set(d,f)):(p=q&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),g.state.set(d,p));this._octree&&(f=!!(q&m.StateFlags.ACTIVE),p=!!(p&m.StateFlags.ACTIVE),!f&&p?this._octree.addInstance(d):f&&!p?this._octree.removeInstance(d):f&&p&&q&m.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(d),this._octree.addInstance(d)));
d=(d+1)%h}else d=(d+1)%h,b++}this._instanceIndex=d;this._defaultRenderInstanceData.forEach(n=>{n.endUpdate()});this._highlightRenderInstanceData.forEach(n=>{n.endUpdate()})};k._renderComponents=function(a,b,c,e){this.levels.forEach((g,h)=>{g.components.forEach(d=>{this._renderComponent(a,b,c,e[h],d,h)})})};k._renderComponent=function(a,b,c,e,g,h){if(0!==e.size&&g.material.requiresSlot(b)){var {rctx:d,pass:p}=a,f=g.glMaterials.load(d,p);if(!Q.isNone(f)){var n=f.beginSlot(c);b=d.useTechnique(n,b);f.bind(c,
n);d.bindVAO(g.vao);n.ensureAttributeLocations(g.vao);a.isHighlightPass&&U.bindOutputHighlight(b,c);n.bindDraw(c);C.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&a.pass===x.RenderPass.MATERIAL&&(b.setUniform4fv("externalColor",N[Math.min(h,N.length-1)]),b.setUniform1i("colorMixMode",ba.colorMixModes.replace));var q=d.capabilities.instancing;a=e.capacity;c=e.headIndex;h=e.tailIndex;f=e.firstIndex;var O=this._glInstanceBufferLayout;b=(P,da)=>{G.bindVertexBufferLayout(d,D.Default3D,e.buffer,O,P);q.drawArraysInstanced(n.primitiveType,
0,g.vertexCount,da-P);G.unbindVertexBufferLayout(d,D.Default3D,e.buffer,O)};g.material.parameters.transparent&&null!=f?c>h?(v.assert(f>=h&&f<=c,"invalid firstIndex"),b(f,c),b(h,f)):c<h&&(f<=c?(v.assert(0<=f&&f<=c,"invalid firstIndex"),b(f,c),b(h,a),b(0,f)):(v.assert(f>=h&&f<=a,"invalid firstIndex"),b(f,a),b(0,c),b(h,f))):c>h?b(h,c):c<h&&(b(0,c),b(h,a));d.bindVAO(null)}}};z._createClass(l,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-
1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(a){this._slicePlane=a}},{key:"layerUid",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};
this._defaultRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a}},{key:"renderStats",get:function(){const a=this._instanceData.size,b=[];this._levels.forEach((c,e)=>{e=this._defaultRenderInstanceData[e].size+this._highlightRenderInstanceData[e].size;c=c.triangleCount;b.push({renderedInstances:e,renderedTriangles:e*c,trianglesPerInstance:c})});return{totalInstances:a,renderedInstances:b.reduce((c,
e)=>c+e.renderedInstances,0),renderedTriangles:b.reduce((c,e)=>c+e.renderedTriangles,0),levels:b}}},{key:"needsTransparentPass",get:function(){return this._levels.some(a=>a.components.some(b=>b.material.requiresSlot(u.RenderSlot.TRANSPARENT_MATERIAL)))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData.some(a=>0<a.size)}},{key:"needsUpdates",get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera}},{key:"octree",get:function(){this._octree||
(this._octree=this._buildOctree());return this._octree}}]);return l}();const M=w.create(),r=S.create(),J=B.create(),K=w.create(),L=w.create(),N=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];y.LodRenderer=ea;y.setLevelSelectorFactory=function(l){I=l};Object.defineProperty(y,"__esModule",{value:!0})});