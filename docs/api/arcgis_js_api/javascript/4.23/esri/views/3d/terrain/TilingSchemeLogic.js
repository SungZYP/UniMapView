// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/spatialReferenceUtils ../../../layers/support/layerUtils ../../ViewingMode ./terrainUtils ./TilingScheme".split(" "),
function(c,n,d,u,v,k,e,z,A,B,w,p,x,q,y,r,l,h){c.TilingSchemeLogic=function(t){function m(a){a=t.call(this,a)||this;a._handles=new v;return a}n._inheritsLoose(m,t);var f=m.prototype;f.initialize=function(){this._handles.add(this.layers.on("change",()=>this._update()));this._handles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme()));this._update();this.tilingSchemeLocked||this._setAdHocTilingScheme()};f.destroy=function(){this._handles=k.destroyMaybe(this._handles);this._waitTask=
null};f._update=function(){this._waitTask=null;if(!this.tilingSchemeLocked){var a;this.layers.some(g=>!y.isTiledLayer(g)||g.isRejected()?!1:!g.isFulfilled()||k.isSome(l.getTiledLayerInfo(g,this.viewSpatialReference,this.viewingMode))?(a=g,!l.isVectorTileLayer(g)&&!l.isProjectableRasterLayer(g)):!1);if(a)if(a.isResolved()){var b=l.getTiledLayerInfo(a,this.viewSpatialReference,this.viewingMode);k.isSome(b)&&(b=new h.default(b.tileInfo),this._lockTilingScheme(b))}else this._updateWhen(a)}};f._updateWhen=
function(a){const b=a.when().catch(()=>{}).then(()=>{b!==this._waitTask||this.destroyed||this._update()});this._waitTask=b};f._lockTilingScheme=function(a){if(this.viewingMode===r.ViewingMode.Global){const b=a.levels.length-1;a.spatialReference.isWebMercator?a=h.default.makeWebMercatorAuxiliarySphere(b):p.canProjectToWGS84ComparableLonLat(a.spatialReference)&&(a=h.default.makeGCSWithTileSize(a.spatialReference,a.pixelSize,b))}this.tilingSchemeLocked=!0;this.tilingScheme=a;this.extentHelper.tilingScheme=
this.tilingScheme;this._updateTiledLayerExtent();this._handles.removeAll();this._handles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))};f._updateTiledLayerExtent=function(){this._set("extent",this.extentHelper.tiledLayersExtent)};f._setAdHocTilingScheme=function(){if(this.viewingMode===r.ViewingMode.Global){var a=this.extentHelper.viewSpatialReference;const b=p.canProjectToWGS84ComparableLonLat(a)||q.isMars(a)||q.isMoon(a);a.isWebMercator?this.tilingScheme=h.default.WebMercatorAuxiliarySphere:
b&&(this.tilingScheme=h.default.makeGCSWithTileSize(a,256));this._set("extent",this.extentHelper.layerViewsExtent)}else a=this.extentHelper.layerViewsExtent,k.isSome(a)&&!x.equals(a,this.extent)&&(this.tilingScheme=h.default.fromExtent(a,this.extentHelper.viewSpatialReference),this._set("extent",a))};n._createClass(m,[{key:"test",get:function(){return{lockTilingScheme:a=>this._lockTilingScheme(a),done:!this._waitTask}}}]);return m}(u);d.__decorate([e.property()],c.TilingSchemeLogic.prototype,"tilingScheme",
void 0);d.__decorate([e.property({readOnly:!0})],c.TilingSchemeLogic.prototype,"extent",void 0);d.__decorate([e.property({value:!1})],c.TilingSchemeLogic.prototype,"tilingSchemeLocked",void 0);d.__decorate([e.property({constructOnly:!0})],c.TilingSchemeLogic.prototype,"viewSpatialReference",void 0);d.__decorate([e.property({constructOnly:!0})],c.TilingSchemeLogic.prototype,"layers",void 0);d.__decorate([e.property({constructOnly:!0})],c.TilingSchemeLogic.prototype,"extentHelper",void 0);d.__decorate([e.property({constructOnly:!0})],
c.TilingSchemeLogic.prototype,"viewingMode",void 0);c.TilingSchemeLogic=d.__decorate([w.subclass("esri.views.3d.terrain.TilingSchemeLogic")],c.TilingSchemeLogic);Object.defineProperty(c,"__esModule",{value:!0})});