// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../lib/GLMaterials ../../lib/Material ../../lib/ModelDirtyTypes ../../lib/RenderPass ../../lib/Util ../WaterMaterial ./Instance ./MergedGeometryBuffer ./MergedGeometryBufferPool ./utils".split(" "),function(F,I,J,u,A,B,C,K,L,M,w,D,z,N,t,O,P,Q){function R(m,k){const b=
new Map;for(const a of m)G(b,a,!0);for(const a of k)G(b,a,!1);return b}function G(m,k,b){const a=k.origin;if(!u.isNone(a)){var c=m.get(a.id);null==c&&(c=new S(a.vec3),m.set(a.id,c));b?c.toAdd.push(k):c.toRemove.push(k)}}function T(m,k){let b;if(!m.some(c=>{if(c.to-c.from<k)return!1;b=c;return!0}))return null;const a=b.from;b.from+=k;b.from>=b.to&&m.removeUnordered(b);return a}function H(m){const k=new Map;m.forAll(a=>k.set(a.from,a));let b=!0;for(;b;)b=!1,m.forEach(a=>{const c=k.get(a.to);c&&(a.to=
c.to,k.delete(c.from),m.removeUnordered(c),b=!0)})}let Y=function(){function m(b,a,c){this._rctx=b;this._materialRepository=a;this._material=c;this.type="MergedRenderer";this._dataByOrigin=new Map;this._renderCommandData=new A;this._hasOccludees=this._hasHighlights=!1;this._glMaterials=new L.GLMaterials(this._material,this._materialRepository);this._bufferWriter=c.createBufferWriter();this._bufferPool=new P.MergedGeometryBufferPool(b,c.vertexAttributeLocations,K.glLayout(this._bufferWriter.vertexBufferLayout))}
var k=m.prototype;k.dispose=function(){this._glMaterials.destroy();this._dataByOrigin.forEach(b=>b.buffer.dispose());this._dataByOrigin.clear();this._bufferPool.dispose()};k.modify=function(b){this._updateGeometries(b.updates);this._addAndRemoveGeometries(b.adds,b.removes);this._updateRenderCommands()};k._addAndRemoveGeometries=function(b,a){const c=this._bufferWriter,f=c.vertexBufferLayout.stride/4,n=this._dataByOrigin,h=R(b,a);h.forEach((d,e)=>{h.delete(e);var g=d.toAdd.reduce((r,v)=>r+c.elementCount(v.data),
0);let l=n.get(e);if(null==l)z.assert(0===d.toRemove.length),l=new U(d.origin,new O.MergedGeometryBuffer(this._bufferPool,g*f)),n.set(e,l);else if(0===d.toAdd.length&&l.instances.size===d.toRemove.length){l.buffer.dispose();n.delete(e);return}let q=0;l.instances.forEach(r=>q+=r.to-r.from);e=d.toRemove.reduce((r,v)=>r+c.elementCount(v.data),0);e=(q+g-e)*f;g=V;e<l.buffer.size/2?this._removeAndRebuild(l,d.toRemove,f,e,g):0<d.toRemove.length&&this._remove(l,d.toRemove,f,g);0<d.toAdd.length&&(e=W,z.setMatrixTranslation3(e,
-d.origin[0],-d.origin[1],-d.origin[2]),this._add(l,d.toAdd,f,e,g));const p=l.buffer.vao.vertexBuffers.geometry;H(g);g.forAll(({from:r,to:v})=>{r<v&&(r*=4,p.setSubData(l.buffer.array,r,r,4*v))});g.clear();l.drawCommandsDirty=!0})};k._updateGeometries=function(b){const a=this._bufferWriter,c=a.vertexBufferLayout.stride/4;for(const f of b){b=f.renderGeometry;const n=this._dataByOrigin.get(b.origin.id),h=n&&n.instances.get(b.id);if(!h)break;const d=f.updateType;d&w.ModelDirty.State.VISIBILITIES&&(h.isVisible=
b.instanceParameters.visible);if(d&(w.ModelDirty.State.HIGHLIGHTS|w.ModelDirty.State.VISIBILITIES)){const e=b.instanceParameters.visible;h.hasHighlights=!!b.instanceParameters.highlights&&e}d&w.ModelDirty.State.OCCLUDEES&&(h.hasOccludees=!!b.instanceParameters.occludees);if(d&(w.ModelDirty.State.VERTEXATTRS|w.ModelDirty.State.TRANSFORMATION)){const {array:e,vao:g}=n.buffer;Q.calculateTransformRelativeToOrigin(b,E,x);a.write({transformation:E,invTranspTransformation:x},b.data,a.vertexBufferLayout.createView(e.buffer),
h.from);z.assert(h.from+a.elementCount(b.data)===h.to,"material VBO layout has changed");g.vertexBuffers.geometry.setSubData(e,h.from*c*4,h.from*c*4,h.to*c*4)}n.drawCommandsDirty=!0}};k._updateRenderCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.hasHiddenInstances=!1;a.hasHighlights=!1;a.hasOccludees=!1;J.someMap(a.instances,c=>{c.isVisible?(c.hasHighlights&&(this._hasHighlights=!0,a.hasHighlights=!0),c.hasOccludees&&(this._hasOccludees=!0,a.hasOccludees=
!0)):a.hasHiddenInstances=!0;return a.hasHiddenInstances&&a.hasHighlights&&a.hasOccludees})});const b=a=>{a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.drawCommandsShadowHighlightRest=null;if(0!==a.instances.size)if(a.hasOccludees||a.hasHighlights||a.hasHiddenInstances){var c=t.sortInstancesByRange(a.instances);a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];a.drawCommandsShadowHighlightRest=[];for(const f of c)f.isVisible&&(f.hasOccludees?
t.addOrMerge(a.drawCommandsOccludees,f):t.addOrMerge(a.drawCommandsDefault,f),f.hasHighlights?t.addOrMerge(a.drawCommandsHighlight,f):t.addOrMerge(a.drawCommandsShadowHighlightRest,f))}else a.drawCommandsDefault=[{first:0,count:4*a.buffer.size/this._bufferWriter.vertexBufferLayout.stride}]};this._dataByOrigin.forEach(a=>{a.drawCommandsDirty&&(b(a),a.drawCommandsDirty=!1)})};k.updateAnimation=function(b){return this._material.update(b)};k.requiresSlot=function(b,a){return null==b||this._material.requiresSlot(b,
a)};k.render=function(b,a,c){if(!this.requiresSlot(b,a))return!1;const f=a===D.RenderPass.MATERIAL_HIGHLIGHT||a===D.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(f&&!this._hasHighlights)return!1;const n=a===D.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,h=!(f||n);this._dataByOrigin.forEach(g=>{if(!f||g.hasHighlights){var l=(f?g.drawCommandsHighlight:n&&(g.hasOccludees||g.hasHighlights||g.hasHiddenInstances)?g.drawCommandsShadowHighlightRest:g.drawCommandsDefault)||null,q=h&&g.drawCommandsOccludees||
null;(u.isSome(l)||u.isSome(q))&&this._renderCommandData.push(new X(g.origin,g.buffer,l,q))}});if(0===this._renderCommandData.length)return!1;const d=this._rctx;a=this._glMaterials.load(d,a);if(u.isNone(a))return this._renderCommandData.clear(),!1;const e=a.beginSlot(c);d.useTechnique(e,b,!1);a.bind(c,e);this._renderCommandData.forAll(({origin:g,buffer:l,renderCommands:q,occludeeCommands:p})=>{c.origin=g;e.bindDraw(c);e.ensureAttributeLocations(l.vao);d.bindVAO(l.vao);g=e.primitiveType;u.isSome(q)&&
this._renderCommands(d,g,q);u.isSome(p)&&(e.bindPipelineState(d,b,!0),this._renderCommands(d,g,p),e.bindPipelineState(d,b,!1))});this._renderCommandData.clear();return!0};k._renderCommands=function(b,a,c){for(let f=0;f<c.length;f++)b.drawArrays(a,c[f].first,c[f].count)};k._removeAndRebuild=function(b,a,c,f,n){for(var h of a)b.instances.delete(h.id);var d=t.sortInstancesByRange(b.instances);b.instances.clear();a=b.buffer.size;f=b.buffer.alloc(f);h=0;for(const e of d){d=e.from*c;const g=e.to*c;f.copy(h,
d,g);e.from=h/c;h+=g-d;e.to=h/c;b.instances.set(e.id,e)}n.push(new t.BufferRange(0,f.hasNewBuffer?b.buffer.array.length:a));f.dispose();b.buffer.erase(h,n.back().to);b.holes.clear()};k._remove=function(b,a,c,f){for(const n of a){a=n.id;const h=b.instances.get(a),d=h.from*c,e=h.to*c;b.buffer.erase(d,e);b.holes.push(new t.BufferRange(h.from,h.to));b.instances.delete(a);f.push(new t.BufferRange(d,e))}H(b.holes)};k._add=function(b,a,c,f,n){if(0!==a.length){var h=this._bufferWriter,d=h.vertexBufferLayout.createView(b.buffer.array.buffer),
e=0<b.holes.length,g=Number.MAX_SAFE_INTEGER,l=Number.MIN_SAFE_INTEGER;for(const p of a){var q=u.isSome(p.transformation)?B.multiply(E,f,p.transformation):f;B.invert(x,q);const r=B.transpose(x,x);a=h.elementCount(p.data);const v=a*c;let y=T(b.holes,a);u.isNone(y)&&(y=b.buffer.size/c,b.buffer.grow(v),d=h.vertexBufferLayout.createView(b.buffer.array.buffer));h.write({transformation:q,invTranspTransformation:r},p.data,d,y);q=p.instanceParameters.visible;a=new t.Instance(p.id,y,y+a,q,!!p.instanceParameters.highlights&&
q,!!p.instanceParameters.occludees);z.assert(null==b.instances.get(p.id));b.instances.set(p.id,a);e?n.push(new t.BufferRange(a.from*c,a.to*c)):(g=Math.min(a.from,g),l=Math.max(a.to,l))}e||n.push(new t.BufferRange(g*c,l*c))}};I._createClass(m,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof
N.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==M.RenderOccludedFlag.Occlude}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]);return m}(),S=function(m){this.origin=m;this.toAdd=[];this.toRemove=[]},U=function(m,k){this.origin=m;this.buffer=k;this.instances=new Map;this.holes=new A({deallocator:null});this.drawCommandsDirty=this.hasOccludees=this.hasHighlights=
this.hasHiddenInstances=!1},X=function(m,k,b,a){this.origin=m;this.buffer=k;this.renderCommands=b;this.occludeeCommands=a};const V=new A({deallocator:null}),W=C.create(),E=C.create(),x=C.create();F.MergedRenderer=Y;Object.defineProperty(F,"__esModule",{value:!0})});