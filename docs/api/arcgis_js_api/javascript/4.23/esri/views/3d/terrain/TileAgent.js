// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ./interfaces ./TerrainConst ./terrainUtils ./tileUtils".split(" "),function(p,q,k,u,A,B,C){let y=function(){function h(){}var b=h.prototype;b.init=function(a,g,d,e){this.tile=a;this._layerIdx=g;this._layerClass=d;this._suspended=e;this._tileLayerInfo=a.getLayerInfo(g,d);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.startLoading=function(){return this._requestNext()};b.dispose=function(){this._tileRequested&&
(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null);this._tileLayerInfo=this.tile=null};b.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())};b.update=function(){const a=this._findAncestorWithData();this._setUpsampleTile(a);return this._requestNext()};b.dataArrived=
function(a){this._setUpsampleTile(a);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING):this._requestNext()};b.dataMissing=function(){this._tileRequested=null;this._tileLayerInfo.data=null;this._requestNext()};b._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b._requestNext=function(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;
this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}k.isSome(a)?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested};b._findNextDownload=function(){const a=this._layerIdx,g=this._layerClass;var d=this.tile.surface.layerViewByIndex(a,g);const e=B.getLayerWithExtentRange(d),{minLevel:v,maxLevel:D}=d.dataLevelRange;d=this._desiredMinLevelDelta;const E=this._progressiveLevelModulo+
d,F=this._scaleRangeEnabled?C.fallsWithinLayer:()=>!0;let c=this.tile;const r=c.level;let f;var l=this._tileLayerInfo.upsampleInfo;l=l?l.tile.level:-1;const w=k.get(e,"tilemapCache");for(;c&&F(c,e,!1)&&c.level>=v;){const m=c.level,x=r-m,n=c.layerInfo[g][a];if(n.data&&x>=d){m>l&&this._setUpsampleTile(c);n.dataInvalidated&&(f=c);break}if((k.isNone(w)||"unavailable"!==w.getAvailability(c.lij[0],c.lij[1],c.lij[2]))&&m<=D&&!n.data&&!n.dataMissing){if(k.isNone(f)||c.level===v||0===m%A.PROGRESSIVE_LOADING_MODULO||
r-f.level<d)f=c;if(x>=E)break}c=c.parent}k.isSome(f)&&r-f.level<d&&this._tileLayerInfo.upsampleInfo&&(f=null);return f};b._findAncestorWithData=function(){const a=this.tile.vlevel,g=this._desiredMinLevelDelta;let d;for(let e=this.tile;e;e=e.parent)if(e.hasLayerData(this._layerIdx,this._layerClass)){if(a-e.level>=g)return e;d=e}return d};b._setUpsampleTile=function(a){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING)};q._createClass(h,
[{key:"updating",get:function(){return!!this._tileRequested}},{key:"test",get:function(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}]);return h}();var t=function(h){function b(){return h.apply(this,arguments)||this}q._inheritsLoose(b,h);b.prototype.dispose=function(){};q._createClass(b,[{key:"_desiredMinLevelDelta",get:function(){throw z;}},{key:"_progressiveLevelModulo",get:function(){throw z;}}]);return b}(y);const z=Error("Abstract method called on TileAgent");
t=new t;p.TILE_AGENT_DONE=t;p.TileAgent=y;Object.defineProperty(p,"__esModule",{value:!0})});