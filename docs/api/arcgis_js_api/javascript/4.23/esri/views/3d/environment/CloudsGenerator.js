// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3f32 ../../../geometry/projectionEllipsoid ./CloudsPresets ./CloudsTechnique ./NoiseTextureAtlas ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject".split(" "),
function(c,u,g,y,z,A,d,m,v,h,P,Q,B,C,D,E,F,l,G,H,w,I,J,K,n,L){c.CloudsGenerator=function(x){function r(a){a=x.call(this,a)||this;a._frameTask=null;a._handles=new z;a._cubeMapSize=A("esri-mobile")?1024:2048;a._techniques=[];a._techniqueConfiguration=new w.CloudsTechniqueConfiguration;a.coverage=d.lerp(e.coverage[0],e.coverage[1],.5);a.density=d.lerp(e.density[0],e.density[1],.5);a.absorption=d.lerp(e.absorption[0],e.absorption[1],.5);a.cloudSize=d.lerp(e.cloudSize[0],e.cloudSize[1],.5);a.detailSize=
d.lerp(e.detailSize[0],e.detailSize[1],.5);a.smoothness=d.lerp(e.smoothness[0],e.smoothness[1],.5);a.cloudHeight=d.lerp(e.cloudHeight[0],e.cloudHeight[1],.5);a.raymarchingStepType=e.raymarchingStepType;a._cloudRadius=0;a._viewMatrix=F.create();a._viewMatrix3=D.create();a.running=!1;return a}u._inheritsLoose(r,x);var p=r.prototype;p._getTechnique=function(a){const f=this._techniques[a];if(f)return f;this._techniqueConfiguration.steps=a;this._techniques[a]=new w.CloudsTechnique({rctx:this.rctx,viewingMode:this.view.state.viewingMode},
this._techniqueConfiguration);return this._techniques[a]};p.initialize=function(){this._vao=J.createQuadVAO(this.rctx);this._cloudRadius=.5*G.getReferenceEllipsoid(this.view.spatialReference).radius;this.setDirty();this._frameTask=this.view.resourceController.scheduler.registerTask(K.TaskPriority.CLOUDS_GENERATOR,this);this._handles.add(this._frameTask);this._handles.add(v.init(this,"coverage",()=>this.setDirty()));"coverage density absorption cloudSize detailSize smoothness cloudHeight raymarchingStepType".split(" ").forEach(a=>
this._handles.add(v.init(this,a,()=>this.setDirty())))};p.destroy=function(){this._handles.destroy();this._techniques.forEach(a=>m.releaseMaybe(a));this._techniques=null;this._frameBufferCube=m.disposeMaybe(this._frameBufferCube);this._vao=m.disposeMaybe(this._vao);this._noiseTexture=m.destroyMaybe(this._noiseTexture)};p._ensureNoiseTexture=function(){m.isNone(this._noiseTexture)&&(this._noiseTexture=new I.NoiseTextureAtlas(this.rctx,this.view),this._noiseTexture.render(this.rctx));return this._noiseTexture.textureAtlas};
p.applyPreset=function(a,f){const b=a.median,k=q=>{const t=d.lerp(q[0],q[1],b);return.5>f?d.lerp(q[0],t,2*f):d.lerp(t,q[1],2*(f-.5))};this.coverage=k(a.coverage);this.density=k(a.density);this.absorption=k(a.absorption);this.cloudSize=k(a.cloudSize);this.detailSize=k(a.detailSize);this.smoothness=k(a.smoothness);this.cloudHeight=k(a.cloudHeight);this.raymarchingStepType=a.raymarchingStepType};p.setDirty=function(){this.running=!0};p.runTask=function(a){if(0===this.coverage||m.isNone(this._vao))this.running=
!1;else{var f=this._ensureNoiseTexture();if(m.isNone(f))this.running=!1;else{var b=this._getTechnique(this.raymarchingStepType);if(this.rctx.isTechniqueCompiled(b)){var k=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize);this.rctx.bindFramebuffer(this.frameBufferCube);b=this.rctx.useTechnique(b);var q=1+this.absorption,t=d.lerp(35,120,this.absorption);b.bindTexture(f,"cloudShapeTexture");b.setUniform1f("cloudRadius",this._cloudRadius);b.setUniform1f("halfCubeMapSize",
.5*this._cubeMapSize);b.setUniform1f("power",t);b.setUniform1f("sigmaE",q);b.setUniform1f("density",d.lerp(0,.3,this.density));b.setUniform1f("cloudSize",d.lerp(0,.02,Math.max(.01,1-this.cloudSize)));b.setUniform1f("detailSize",d.lerp(0,.2,Math.max(.01,1-this.detailSize)));b.setUniform1f("smoothness",d.lerp(0,.5,1-this.smoothness));b.setUniform1f("cloudHeight",d.lerp(0,1500,this.cloudHeight));b.setUniform1f("coverage",this.coverage);this.rctx.bindVAO(this._vao);b.assertCompatibleVertexAttributeLocations(this._vao);
for(f=0;5>f;f++)E.targetTo(this._viewMatrix,M,N[f],O[f]),C.fromMat4(this._viewMatrix3,this._viewMatrix),b.setUniformMatrix3fv("view",this._viewMatrix3),this.frameBufferCube.setColorTextureTarget(n.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+f),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush();this.running=!1;this.rctx.setViewport(k.x,k.y,k.width,k.height);this.requestRender();a.madeProgress()}}}};u._createClass(r,[{key:"frameBufferCube",get:function(){m.isNone(this._frameBufferCube)&&
(this._frameBufferCube=new L.FramebufferObject(this.rctx,{colorTarget:n.TargetType.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},{target:n.TextureType.TEXTURE_CUBE_MAP,pixelFormat:n.PixelFormat.RGBA,dataType:n.PixelType.UNSIGNED_BYTE,wrapMode:n.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:n.TextureSamplingMode.LINEAR,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize}));return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}}]);return r}(y);
g.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"rctx",void 0);g.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"view",void 0);g.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"_frameTask",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"coverage",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"density",void 0);
g.__decorate([h.property()],c.CloudsGenerator.prototype,"absorption",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"detailSize",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"smoothness",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudHeight",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,"raymarchingStepType",void 0);g.__decorate([h.property()],c.CloudsGenerator.prototype,
"running",void 0);c.CloudsGenerator=g.__decorate([B.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const N=[l.fromValues(1,0,0),l.fromValues(-1,0,0),l.fromValues(0,1,0),l.fromValues(0,-1,0),l.fromValues(0,0,1)],O=[l.fromValues(0,1,0),l.fromValues(0,1,0),l.fromValues(0,0,-1),l.fromValues(0,0,1),l.fromValues(0,1,0)],M=l.zeros(),e=H.cloudPresets.sunny;Object.defineProperty(c,"__esModule",{value:!0})});