// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../core/shaderLibrary/attributes/VertexPosition.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../../../support/WatchUpdatingTracking ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/VertexArrayObject".split(" "),
function(w,t,z,V,W,X,N,u,A,oa,pa,Y,J,O,Z,P,E,K,Q,aa,ba,ca,da,ea,fa,ha,F,B,R,S,C,ia,H,ja,v,ka,la,L,M,T){function ma(D){let y=null,n=null;for(let a=0;a<D.geometries.length;a++){var b;const c=D.geometryRecords[a];if(c.material.supportsEdges){if(!y)y=c.transformation;else if(!W.equals(y,c.transformation))return!1;if(!n&&u.isSome(c.origin))n=c;else if(u.isSome(null==(b=n)?void 0:b.origin)&&u.isSome(c.origin)&&n.origin.id!==c.origin.id)return!1}}return!0}const na=X.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");
w.EdgeView=function(D){function y(b){var a=D.call(this,b)||this;a.updatingHandles=new la.WatchUpdatingTracking;a.perObjectData=new Map;a.perObjectDataEvictionCache=new Set;a.renderers=new Map;a.numberOfRenderedEdges={[H.Transparency.TRANSPARENT]:0,[H.Transparency.OPAQUE]:0};a.gpuMemoryUsage=0;a.workerAbort=new AbortController;a.tmpModelPosition=K.create();a.localOrigins=new fa.LocalOriginManager(new da.GridLocalOriginFactory(b.renderSR));return a}t._inheritsLoose(y,D);var n=y.prototype;n.initialize=
function(){this.worker=new ia(this.schedule);this.componentColorManager=new ka.BufferManager(this.rctx,2);const b=B.VertexLayout.createBuffer(4);for(let a=0;4>a;a++)b.sideness.set(a,0,0===a||3===a?0:1),b.sideness.set(a,1,0===a||1===a?0:1);this.verticesBufferObject=L.BufferObject.createVertex(this.rctx,M.Usage.STATIC_DRAW,b.buffer)};n.destroy=function(){this.destroyed||(this.perObjectData.forEach(b=>this._discardObjectEntry(b)),this.perObjectData.clear(),this.strokesTexture=u.disposeMaybe(this.strokesTexture),
this.componentColorManager=u.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=u.disposeMaybe(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())};n.shouldRender=function(){return 0<this.renderers.size};n.addComponentObject=function(){var b=t._asyncToGenerator(function*(a,c,d,e,g,h,f,m){if(this.hasObject(a))return this.getObjectMemoryUsage(a);let k;d=new U(new Promise(l=>k=l),d.center,d.radius);this.perObjectData.set(a,
d);a=yield this.updatingHandles.addPromise(this._addComponentGeometry(c,d,e,g,h,f,m));this.setNeedsRender();k();return a});return function(a,c,d,e,g,h,f,m){return b.apply(this,arguments)}}();n.addOrUpdateObject3D=function(){var b=t._asyncToGenerator(function*(a,c,d,e){if(this.destroyed)na.warn("Attempt to add an object to a destroyed instance");else{var g=this.perObjectData.get(a);0<(null==g?void 0:g.renderables.length)&&this.perObjectDataEvictionCache.add(g);var h,f=a.boundingVolumeWorldSpace.bounds;
f=new U(new Promise(k=>h=k),Q.getCenter(f),Q.getRadius(f));this.perObjectData.set(a,f);var m=[];if(d.mergeGeometries&&1<a.geometries.length&&ma(a))m.push(this._addObjectMergedGeometries(a,f,c,d,e));else for(let k=0;k<a.geometries.length;k++){const l=a.geometryRecords[k];l.material.supportsEdges&&m.push(this._addGeometry(a,f,a.geometries[k],l,c[0],d,e))}yield this.updatingHandles.addPromise(Promise.all(m));this.perObjectDataEvictionCache.delete(f);this._discardObjectEntry(g);this.setNeedsRender();
h()}});return function(a,c,d,e){return b.apply(this,arguments)}}();n._discardObjectEntry=function(b){b&&(b.renderables.length&&(b.renderables.forEach(a=>this._removeRenderable(a)),this.setNeedsRender()),b.loaded=null)};n.hasObject=function(b){return this.perObjectData.has(b)};n.updateAllComponentOpacities=function(){var b=t._asyncToGenerator(function*(a,c){const d=c instanceof Array?e=>c[e]:()=>c;(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(e=>{const g=e.components.meta.length;
for(let h=0;h<g;h++){const f=d(h),m=e.components.meta[h],k=m.index;m.material.opacity=f;e.components.buffer.textureBuffer.setDataElement(k,1,3,255*f)}this._updateTransparency(e)});this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();n.getObjectMemoryUsage=function(){var b=t._asyncToGenerator(function*(a){return(yield this._getObjectEntry(a)).renderables.reduce((c,d)=>c+d.statistics.gpuMemoryUsage,0)});return function(a){return b.apply(this,arguments)}}();n.updateAllComponentMaterials=
function(){var b=t._asyncToGenerator(function*(a,c,d,e){const g=a instanceof ha.Object3D,h=!!d.slicePlaneEnabled,f=v.determineRendererType(c),m=C.EdgeRenderer.getKey(f,h,g);(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(k=>{if(m!==k.rendererKey){var l=this.renderers.get(k.rendererKey);const p=this._acquireRenderer(f,h,g);l.removeRenderable(k);l.refCount.decrement();k.rendererKey=m;p.addRenderable(k)}for(l=0;l<c.length;l++)k.components.meta[l].material=c[l];e&&
this._updateComponentBuffer(k.components);this._updateTransparency(k)});this.setNeedsRender()});return function(a,c,d,e){return b.apply(this,arguments)}}();n.updateObjectVisibility=function(){var b=t._asyncToGenerator(function*(a,c){(yield this.updatingHandles.addPromise(this._getObjectEntry(a))).renderables.forEach(d=>d.visible=c);this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();n.removeObject=function(b){const a=this.perObjectData.get(b);a&&(this.perObjectData.delete(b),
this._discardObjectEntry(a))};n._getObjectEntry=function(){var b=t._asyncToGenerator(function*(a){a=this.perObjectData.get(a);if(!a)throw"no object";yield a.loaded;return a});return function(a){return b.apply(this,arguments)}}();n.removeAll=function(){this.perObjectData.forEach((b,a)=>this.removeObject(a))};n.render=function(b,a){this.numberOfRenderedEdges[a]=0;if(!u.isNone(this.componentColorManager)){this.localOrigins.updateViewMatrices(b.camera.viewMatrix);var c=b.camera.viewInverseTransposeMatrix,
d=K.create(),e=new ca.TwoVectorPosition,g=new ba.VertexPositionViewProjectionTransform,h=O.create();E.set(d,c[3],c[7],c[11]);e.set(d);E.copy(g.transformWorldFromViewTH,e.high);E.copy(g.transformWorldFromViewTL,e.low);J.fromMat4(g.transformViewFromCameraRelativeRS,b.camera.viewMatrix);Z.copy(g.transformProjFromView,b.camera.projectionMatrix);c=O.create();J.transpose(c,g.transformViewFromCameraRelativeRS);J.invert(h,c);var f=0,m=0;this.renderers.forEach(l=>{0===l.refCount.value?(this.renderers.delete(l.key),
l.dispose()):l.forEachRenderable(p=>{p.visible&&(f+=p.statistics.averageEdgeLength,m++)},a)});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();if(0!==m){var k={distanceFalloffFactor:40*f/m,minimumEdgeLength:b.camera.perScreenPixelRatio,transparency:a,viewProjectionTransform:g,transformNormalViewFromGlobal:h};this._updateObjectCameraDistances(b);this.renderers.forEach(l=>{this._renderRegularEdges(l,b,k);this._renderSilhouetteEdges(l,b,k)})}}};n._updateTransparency=
function(b){const a=v.determineEdgeTransparency(b.components.meta),c=v.determineObjectTransparency(b.components.meta);if(a!==b.edgeTransparency||c!==b.objectTransparency)b.edgeTransparency=a,b.objectTransparency=c,this.renderers.get(b.rendererKey).setRenderablesDirty()};n._computeModelTransformWithLocalOrigin=function(b,a,c){b.getCombinedStaticTransformation(a,c);u.isSome(a.origin)?this.localOrigins.register(a.origin):(b=E.set(this.tmpModelPosition,c[12],c[13],c[14]),a.origin=this.localOrigins.acquire(b));
ea.applyToModelMatrix(a.origin.vec3,c);return a.origin};n._updateComponentBuffer=function(b){const {meta:a,buffer:c}=b;for(b=0;b<a.length;b++){var d=a[b].material;const e=a[b].index,g=N.clamp(Math.round(d.size*C.LINE_WIDTH_FRACTION_FACTOR),0,255),h=N.clamp(d.extensionLength,-C.EXTENSION_LENGTH_OFFSET,255-C.EXTENSION_LENGTH_OFFSET)+C.EXTENSION_LENGTH_OFFSET,f="solid"===d.type?S.EdgeType.SOLID:S.EdgeType.SKETCH,m=255*d.opacity;d=d.color;c.textureBuffer.setData(e,0,255*d[0],255*d[1],255*d[2],255*d[3]);
c.textureBuffer.setData(e,1,g,h,f,m)}};n._createComponentBuffers=function(b){if(u.isNone(this.componentColorManager))return null;const a=[],c=this.componentColorManager.getBuffer(b.length);for(let d=0;d<b.length;d++){const e=b[d],g=c.acquireIndex();a.push({index:g,material:e})}b={meta:a,buffer:c};this._updateComponentBuffer(b);return b};n._extractEdges=function(b,a,c,d,e,g=e.length){return this.worker.process({data:a,indices:e,indicesLength:g,writerSettings:b,skipDeduplicate:c},this.workerAbort.signal,
d)};n._createEdgeResources=function(b){const a={};if(u.isNone(this.verticesBufferObject))return a;if(0<b.regular.lodInfo.lengths.length){var c=new T.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:R.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:L.BufferObject.createVertex(this.rctx,M.Usage.STATIC_DRAW,b.regular.instancesData.buffer)});a.regular={vao:c,lod:b.regular.lodInfo}}0<b.silhouette.lodInfo.lengths.length&&(c=
new T.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:R.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:L.BufferObject.createVertex(this.rctx,M.Usage.STATIC_DRAW,b.silhouette.instancesData.buffer)}),a.silhouette={vao:c,lod:b.silhouette.lodInfo});return a};n._addGeometry=function(){var b=t._asyncToGenerator(function*(a,c,d,e,g,h,f){const m=d.vertexAttributes.get(F.VertexAttribute.POSITION),k=d.indices.get(F.VertexAttribute.POSITION),
l=P.create();a=this._computeModelTransformWithLocalOrigin(a,e,l);return this._addPositionData(c,{position:m,indices:k,modelTransform:l,origin:a},d.edgeIndicesLength,g,h,f)});return function(a,c,d,e,g,h,f){return b.apply(this,arguments)}}();n._addPositionData=function(){var b=t._asyncToGenerator(function*(a,c,d,e,g,h=!1){if(null!=a.loaded){var f=this._createComponentBuffers([e]);if(!(u.isNone(f)||0>=d)){e=this._acquireRenderer(e.type,!!g.slicePlaneEnabled);var {modelTransform:m,origin:k}=c;g=c.indices;
c=c.position;var l=c.data.length/c.size,p=B.EdgeInputBufferLayout.createBuffer(l);for(let x=0;x<l;x++)p.position.set(x,0,c.data[x*c.size]),p.position.set(x,1,c.data[x*c.size+1]),p.position.set(x,2,c.data[x*c.size+2]);v.fillComponenBufferIndices(f.meta,[0,p.componentIndex.count],p.componentIndex);h=yield this.updatingHandles.addPromise(this._extractEdges(e.writerSettings,p,!1,h,g,d));if(null!=a.loaded){var {regular:r,silhouette:q}=this._createEdgeResources(h);d=(r?r.vao.size:0)+(q?q.vao.size:0);f=
{regular:r,silhouette:q,transform:{modelMatrix:m,origin:k},statistics:{gpuMemoryUsage:d,externalMemoryUsage:!1,averageEdgeLength:h.averageEdgeLength},components:f,visible:!0,edgeTransparency:v.determineEdgeTransparency(f.meta),objectTransparency:v.determineObjectTransparency(f.meta),distanceToCamera:0,rendererKey:e.key};a.renderables.push(f);e.addRenderable(f);this.gpuMemoryUsage+=d}}}});return function(a,c,d,e,g){return b.apply(this,arguments)}}();n._addComponentGeometry=function(){var b=t._asyncToGenerator(function*(a,
c,d,e,g,h,f){if(null==c.loaded)return 0;const m=this._createComponentBuffers(h);if(u.isNone(m))return 0;h=v.determineRendererType(h);f=this._acquireRenderer(h,f.slicePlaneEnabled||!1,!1);h=B.EdgeInputBufferLayout.createBuffer(d.count);aa.copy(h.position,d);v.fillComponenBufferIndices(m.meta,g,h.componentIndex,e);e=yield this.updatingHandles.addPromise(this._extractEdges(f.writerSettings,h,!0,!1,e));if(null==c.loaded)return 0;const {regular:k,silhouette:l}=this._createEdgeResources(e);d=(k?k.vao.size:
0)+(l?l.vao.size:0);a={regular:k,silhouette:l,transform:a,statistics:{gpuMemoryUsage:d,externalMemoryUsage:!0,averageEdgeLength:e.averageEdgeLength},components:m,visible:!0,edgeTransparency:v.determineEdgeTransparency(m.meta),objectTransparency:v.determineObjectTransparency(m.meta),distanceToCamera:0,rendererKey:f.key};c.renderables.push(a);f.addRenderable(a);return d});return function(a,c,d,e,g,h,f){return b.apply(this,arguments)}}();n._addObjectMergedGeometries=function(){var b=t._asyncToGenerator(function*(a,
c,d,e,g){var h=new Map,f=0,m=null,k=0;for(var l=0;l<a.geometries.length;l++){var p=a.geometries[l],r=a.geometryRecords[l];r.material.supportsEdges&&(!m&&r.origin&&(m=r),r=p.vertexAttributes.get(F.VertexAttribute.POSITION),k+=r.data.length/r.size,f+=p.edgeIndicesLength)}k=65536<=k?Uint32Array:Uint16Array;f=f?new k(f):null;k=[];l=0;for(p=0;p<a.geometries.length;p++){r=a.geometries[p];if(!a.geometryRecords[p].material.supportsEdges)continue;var q=r.vertexAttributes.get(F.VertexAttribute.POSITION);const x=
r.indices.get(F.VertexAttribute.POSITION);let I=h.get(q.data);if(null==I){I=k.length/3;for(let G=0;G<q.data.length;G+=q.size)k.push(q.data[G+0]),k.push(q.data[G+1]),k.push(q.data[G+2]);h.set(q.data,I)}if(x)for(q=0;q<r.edgeIndicesLength;q++)f[l++]=I+x[q]}m=m||a.geometryRecords[0];h=P.create();m=this._computeModelTransformWithLocalOrigin(a,m,h);for(l=0;l<a.geometryRecords.length;l++)a.geometryRecords[l].origin=m;yield this.updatingHandles.addPromise(this._addPositionData(c,{position:{data:k,size:3},
indices:f,modelTransform:h,origin:m},f.length,d[0],e,g))});return function(a,c,d,e,g){return b.apply(this,arguments)}}();n._acquireRenderer=function(b,a,c=!0){const d=C.EdgeRenderer.getKey(b,a,c);let e=this.renderers.get(d);u.isNone(this.strokesTexture)&&(this.strokesTexture=ja.generateStrokesTexture(this.rctx));e||(e=new C.EdgeRenderer(this.rctx,this.techniqueRepository,{type:b,slicePlaneEnabled:a,strokesTexture:this.strokesTexture,legacy:c}),this.renderers.set(d,e));e.refCount.increment();return e};
n._removeRenderable=function(b){b.regular&&(b.regular.vao.vertexBuffers.instances.dispose(),b.regular.vao.dispose(!1),b.regular.vao=null);b.silhouette&&(b.silhouette.vao.vertexBuffers.instances.dispose(),b.silhouette.vao.dispose(!1),b.silhouette.vao=null);const a=this.renderers.get(b.rendererKey);if(a){a.removeRenderable(b);a.refCount.decrement();"origin"in b.transform&&this.localOrigins.release(b.transform.origin);this.gpuMemoryUsage-=b.statistics.externalMemoryUsage?0:b.statistics.gpuMemoryUsage;
for(const c of b.components.meta)b.components.buffer.releaseIndex(c.index)}};n._updateObjectCameraDistances=function(b){const a=b.camera.eye,c=b.camera.viewForward,d=K.create();b=e=>{const {center:g,radius:h}=e;E.sub(d,g,a);const f=E.dot(d,c),m=f<-h?Infinity:f<h?0:f-h;e.renderables.forEach(k=>k.distanceToCamera=m)};this.perObjectData.forEach(b);this.perObjectDataEvictionCache.forEach(b)};n._renderRegularEdges=function(b,a,c){b.bindRegularEdges(a,c);const d=c.transparency;b.forEachRenderable(e=>{if(e.visible&&
e.regular){var g=v.computeEdgeCount(e.regular.lod.lengths,e.distanceToCamera,c);"origin"in e.transform&&(a.localViewMatrixForEdges=this.localOrigins.getViewMatrix(e.transform.origin));b.renderRegularEdges(e,a,g);this.numberOfRenderedEdges[d]+=g}},d)};n._renderSilhouetteEdges=function(b,a,c){b.bindSilhouetteEdges(a,c);const d=c.transparency;b.forEachRenderable(e=>{if(e.visible&&e.silhouette){var g=v.computeEdgeCount(e.silhouette.lod.lengths,e.distanceToCamera,c);"origin"in e.transform&&(a.localViewMatrixForEdges=
this.localOrigins.getViewMatrix(e.transform.origin));b.renderSilhouetteEdges(e,a,g);this.numberOfRenderedEdges[d]+=g}},d)};t._createClass(y,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"usedMemory",get:function(){return this.gpuMemoryUsage}},{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges[H.Transparency.TRANSPARENT]+this.numberOfRenderedEdges[H.Transparency.OPAQUE]}}]);return y}(V);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,
"rctx",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"renderSR",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"techniqueRepository",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"setNeedsRender",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"schedule",void 0);z.__decorate([A.property({readOnly:!0})],w.EdgeView.prototype,"updatingHandles",void 0);z.__decorate([A.property({readOnly:!0})],
w.EdgeView.prototype,"updating",null);w.EdgeView=z.__decorate([Y.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],w.EdgeView);let U=function(D,y,n){this.center=y;this.radius=n;this.renderables=[];this.loaded=D;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})};Object.defineProperty(w,"__esModule",{value:!0})});