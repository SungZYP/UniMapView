// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/mathUtils ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/support/axisAngle ./CloudsCompositionTechnique ./weather ../webgl-engine/lib/glUtil3D ../../webgl/enums".split(" "),
function(m,D,y,G,z,A,C,M,N,O,H,B,r,f,t,x,I,n,J,K){function E(a,u,d){a.bindTexture(d.clouds.cubeMap.colorTexture,"cubeMap");a.setUniform1f("cloudsHeight",d.parallax.cloudsHeight);a.setUniformMatrix4fv("rotationMatrixClouds",d.parallax.transform);a.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",d.parallaxNew.transform);a.setUniform3fv("anchorPosition",d.parallax.anchorPointClouds);a.setUniform3fv("anchorPositionCrossFade",d.parallaxNew.anchorPointClouds);d.fadeInOut.stage!==e.FINISHED?a.setUniform1f("totalFadeInOut",
d.fadeInOutHeight.factor+Math.max(z.clamp(d.fadeInOut.factor,0,1))):a.setUniform1f("totalFadeInOut",d.fadeInOutHeight.factor+Math.max(z.clamp(d.fadeIn.factor,0,1)));a.setUniform1f("radiusCurvatureCorrectionFactor",d.parallax.radiusCurvatureCorrectionFactor);a.setUniform1i("crossFade",d.crossFade.stage);a.setUniform1f("crossFadeAnchorFactor",z.clamp(d.crossFade.factor,0,1));a.setUniform1f("radius",d.parallax.radius);a.setUniform3fv("cameraPosition",u.eye)}m.CloudsComposition=function(a){function u(b){var c=
a.call(this,b)||this;c._inverseProjectionMatrix=r.create();c._inverseViewMatrix=r.create();c._technique=new I.CloudsCompositionTechnique(b);c._vao=J.createQuadVAO(b.rctx);c._setDefaultParallax(b.radius);return c}D._inheritsLoose(u,a);var d=u.prototype;d.destroy=function(){this._technique=A.releaseMaybe(this._technique);this._vao=A.disposeMaybe(this._vao)};d.render=function(b,c,g){this._parameters.clouds=c;c=b.camera;if(!A.isNone(this._vao)&&!A.isNone(c)){var v=b.rctx,p=v.useTechnique(this._technique);
b.scenelightingData.setLightDirectionUniform(p);b.scenelightingData.setUniforms(p,!1,!1);B.invert(this._inverseProjectionMatrix,c.projectionMatrix);B.invert(this._inverseViewMatrix,c.viewMatrix);p.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix);p.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix);p.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption);this._setParallaxParams(c.eye,g);b.cloudsCompositionParams=
this._parameters;E(p,c,this._parameters);v.bindVAO(this._vao);p.assertCompatibleVertexAttributeLocations(this._vao);v.drawArrays(K.PrimitiveType.TRIANGLE_STRIP,0,4)}};d._setDefaultParallax=function(b){this._parameters={parallax:{anchorPointClouds:t.create(),radius:b,cloudsHeight:1E5,radiusCurvatureCorrectionFactor:0,transform:r.create()},parallaxNew:{anchorPointClouds:t.create(),radius:b,cloudsHeight:1E5,radiusCurvatureCorrectionFactor:0,transform:r.create()},crossFade:{stage:h.FINISHED,factor:0,
distanceThresholdFactor:.3},fadeInOut:{stage:e.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:k.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:q.FINISHED,factor:-1},cameraPositionLastFrame:t.create(),startTime:0,startTimeHeightFade:0,clouds:null}};d._isCameraPositionFinal=function(b){return f.equals(this._parameters.cameraPositionLastFrame,b)};d._setFadeInStage=function(b){b=this._isCameraPositionFinal(b);this._parameters.fadeIn.stage===k.FINISHED&&(this._parameters.fadeIn.factor=
1,f.copy(this._parameters.parallax.anchorPointClouds,l),this._parameters.fadeIn.stage=k.CHANGE_ANCHOR,this._parameters.crossFade.stage=h.FINISHED,this._parameters.fadeInOut.stage=e.FINISHED);this._parameters.fadeIn.stage===k.CHANGE_ANCHOR&&b&&(f.copy(this._parameters.parallax.anchorPointClouds,l),this._parameters.fadeIn.stage=k.FADE_IN,this._parameters.startTime=performance.now());0<this._parameters.fadeIn.factor&&this._parameters.fadeIn.stage===k.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-
this._parameters.startTime)/500);0>=this._parameters.fadeIn.factor&&this._parameters.fadeIn.stage===k.FADE_IN&&(this._parameters.fadeIn.stage=k.FINISHED,this._parameters.fadeIn.factor=0)};d._setCrossFadingStage=function(){this._parameters.crossFade.stage===h.FINISHED&&(f.copy(this._parameters.parallaxNew.anchorPointClouds,l),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=h.CROSS_FADE);1>this._parameters.crossFade.factor&&this._parameters.crossFade.stage===
h.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500);1<=this._parameters.crossFade.factor&&this._parameters.crossFade.stage===h.CROSS_FADE&&(this._parameters.crossFade.stage=h.FINISHED,this._parameters.crossFade.factor=1,f.copy(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))};d._setFadeInOutStage=function(b){this._parameters.fadeInOut.stage===e.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=
0,this._parameters.fadeInOut.stage=e.FADE_OUT);1>this._parameters.fadeInOut.factor&&this._parameters.fadeInOut.stage===e.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250);1<=this._parameters.fadeInOut.factor&&this._parameters.fadeInOut.stage===e.FADE_OUT&&(this._parameters.fadeInOut.factor=1,f.copy(this._parameters.parallax.anchorPointClouds,l));1<=this._parameters.fadeInOut.factor&&this._parameters.fadeInOut.stage===e.FADE_OUT&&this._isCameraPositionFinal(b)&&
(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=e.FADE_IN,this._parameters.crossFade.stage=h.FINISHED,this._parameters.crossFade.factor=0);0<this._parameters.fadeInOut.factor&&this._parameters.fadeInOut.stage===e.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500);0>=this._parameters.fadeInOut.factor&&this._parameters.fadeInOut.stage===e.FADE_IN&&(this._parameters.fadeInOut.stage=e.FINISHED,
this._parameters.fadeInOut.factor=0)};d._setFadeInOutHeight=function(b){const c=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===q.FINISHED?c:this._parameters.startTimeHeightFade;this._parameters.fadeInOutHeight.factor=b?this._parameters.fadeInOutHeight.factor+(c-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-(c-this._parameters.startTimeHeightFade)/500;this._parameters.startTimeHeightFade=c;this._parameters.fadeInOutHeight.factor=
z.clamp(this._parameters.fadeInOutHeight.factor,0,1);this._parameters.fadeInOutHeight.stage=q.HEIGHT_FADE};d._setParallaxParams=function(b,c){0>this._parameters.fadeInOutHeight.factor&&(this._parameters.fadeInOutHeight.factor=f.length(b)-this._parameters.parallax.radius>n.weatherHeightLimit?1:0);f.normalize(l,b);f.scale(l,l,this._parameters.parallax.radius);0===this._parameters.parallax.anchorPointClouds[0]&&0===this._parameters.parallax.anchorPointClouds[1]&&0===this._parameters.parallax.anchorPointClouds[2]&&
f.copy(this._parameters.parallax.anchorPointClouds,l);var g=f.length(f.subtract(L,this._parameters.parallax.anchorPointClouds,l));let v=!0;g>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==k.FINISHED?this._setFadeInStage(b):g>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==e.FINISHED?this._setFadeInOutStage(b):g>this._parameters.crossFade.distanceThresholdFactor*
this._parameters.parallax.cloudsHeight&&!c||this._parameters.crossFade.stage!==h.FINISHED?this._setCrossFadingStage():v=!1;c=f.length(b);g=c-this._parameters.parallax.radius;(g>1.7*n.weatherHeightLimit||g<-n.weatherHeightLimit)&&1>this._parameters.fadeInOutHeight.factor?this._parameters.fadeInOutHeight.factor=1:(g>n.weatherHeightLimit||g<-.35*n.weatherHeightLimit)&&1>this._parameters.fadeInOutHeight.factor?this._setFadeInOutHeight(!0):g<n.weatherHeightLimit&&g>-.35*n.weatherHeightLimit&&0<this._parameters.fadeInOutHeight.factor?
this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=q.FINISHED;this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(c*c-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/c;x.fromPoints(F,this._parameters.parallax.anchorPointClouds,w);this._parameters.parallax.transform=r.create();B.rotate(this._parameters.parallax.transform,this._parameters.parallax.transform,w[3],x.axis(w));v&&(x.fromPoints(F,this._parameters.parallaxNew.anchorPointClouds,
w),this._parameters.parallaxNew.transform=r.create(),B.rotate(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,w[3],x.axis(w)));f.copy(this._parameters.cameraPositionLastFrame,b)};D._createClass(u,[{key:"isFading",get:function(){return this._parameters.crossFade.stage!==h.FINISHED||this._parameters.fadeInOut.stage!==e.FINISHED||this._parameters.fadeIn.stage!==k.FINISHED||this._parameters.fadeInOutHeight.stage!==q.FINISHED}}]);return u}(G);y.__decorate([C.property({constructOnly:!0})],
m.CloudsComposition.prototype,"rctx",void 0);y.__decorate([C.property({constructOnly:!0})],m.CloudsComposition.prototype,"viewingMode",void 0);y.__decorate([C.property({constructOnly:!0})],m.CloudsComposition.prototype,"radius",void 0);m.CloudsComposition=y.__decorate([H.subclass("esri.views.3d.environment.CloudsComposition")],m.CloudsComposition);var k;(function(a){a[a.FINISHED=0]="FINISHED";a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR";a[a.FADE_IN=2]="FADE_IN"})(k||(k={}));var e;(function(a){a[a.FINISHED=
0]="FINISHED";a[a.FADE_OUT=1]="FADE_OUT";a[a.FADE_IN=2]="FADE_IN"})(e||(e={}));var h;(function(a){a[a.FINISHED=0]="FINISHED";a[a.CROSS_FADE=1]="CROSS_FADE"})(h||(h={}));var q;(function(a){a[a.FINISHED=0]="FINISHED";a[a.HEIGHT_FADE=1]="HEIGHT_FADE"})(q||(q={}));const F=t.fromValues(0,0,1),w=x.create(),l=t.create(),L=t.create();m.bindCloudsComposition=E;Object.defineProperty(m,"__esModule",{value:!0})});