// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/unitUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat4 ../../../../../chunks/vec2 ../../../../../chunks/vec2f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/aaBoundingRect ../../../../../chunks/boundedPlane ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../../analysisTools/slice/sliceToolUtils ../../analysisTools/slice/images/Factory ../dragEventPipeline3D ../ManipulatorType ../manipulatorUtils ../visualElementUtils ../manipulations/MoveXYGraphicManipulation ./PreserveAspectRatio ../../visualElements/OutlineVisualElement ../../../layers/graphics/elevationAlignmentUtils ../../../layers/graphics/ElevationContext ../../../layers/graphics/GraphicState ../../../support/geometryUtils/ray ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/editGeometry/interfaces ../../../../interactive/editGeometry/operations/UpdateVertices ../../../../interactive/editGeometry/support/editPlaneUtils".split(" "),
function(l,J,p,N,O,P,Q,h,R,K,S,r,qa,ra,sa,T,U,z,V,m,F,W,n,A,X,t,Y,Z,G,k,aa,H,q,ba,ca,da,ea,fa,ha,ia,ja,ka,y,la,ma,x,L,u){l.ExtentTransformTool=function(M){function B(a){a=M.call(this,a)||this;a.enableZ=!0;a.enableRotation=!0;a.enableScaling=!0;a._preserveAspectRatio=new ea.PreserveAspectRatio;a.grabbing=!1;a.inputState=null;a.type="transform-3d";a.handles=new O;a.moveZManipulator=null;a.resizeManipulators=null;a.rotateManipulator=null;a.attachmentOrigin=null;a.outlineVisualElement=null;a.mapBounds=
n.create();a.mapBoundsStart=n.create();a.displayBounds=n.create();a.displayBoundsStart=n.create();a.displayBoundsMarginStart=0;a.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];return a}J._inheritsLoose(B,M);var e=B.prototype;e.initialize=function(){this.graphicState=new ja.GraphicState({graphic:this.graphic});this.editGeometryOperations=ma.EditGeometryOperations.fromGeometry(this.graphic.geometry,
this.view.state.viewingMode);this.graphicMoveManipulation=new da.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:this.graphicState});this.handles.add(this._createMoveXYGraphicDragPipeline());this.moveZManipulator=k.createShiftManipulator(this.view,k.OffsetMode.CENTER_ON_CALLOUT);this.moveZManipulator.state|=k.IsShiftEdgeOnScreenFlag;this.handles.add(this.watch("enableZ",()=>this._updateManipulatorAvailability(this.moveZManipulator,q.ManipulatorType.TRANSLATE_Z)));this.handles.add(this._createMoveZDragPipeline());
this.manipulators.add(this.moveZManipulator);this.resizeManipulators=this.resizeHandles.map(b=>{const c=k.createResizeManipulator(this.view,b);this.handles.add(this.watch("enableScaling",()=>this._updateManipulatorAvailability(c,q.ManipulatorType.SCALE)));c.events.on("grab-changed",d=>this._onResizeGrab(d));this.handles.add(this._createResizeDragPipeline(c,b));return c});this.manipulators.addMany(this.resizeManipulators);this.rotateManipulatorTexture=aa.getRotateHeadingTexture(this.view.toolViewManager.textures);
this.rotateManipulator=k.createRotateManipulator(this.view,this.rotateManipulatorTexture.texture);this.handles.add(this.watch("enableRotation",()=>this._updateManipulatorAvailability(this.rotateManipulator,q.ManipulatorType.ROTATE)));this.rotateManipulator.events.on("grab-changed",b=>{this._onRotateGrab(b)});this.handles.add(this._createRotateDragPipeline(this.rotateManipulator));this.manipulators.add(this.rotateManipulator);this._calculateMapBounds();this._updateDisplayBounds();var a=ca.createVisualElements({view:this.view,
graphic:this.graphic,forEachManipulator:b=>this._forEachManipulator(b),onManipulatorsChanged:()=>P.makeHandle()});h.isSome(a)&&(this.outlineVisualElement=a.visualElement instanceof fa.OutlineVisualElement?a.visualElement:null);h.isSome(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds()));this.handles.add(a);this.handles.add([this.graphicState.on("changed",()=>this._onGeometryChanged()),this.graphicState.watch("displaying",
()=>this._updateAllManipulatorAvailability()),S.init(this.graphicState,"isDraped",()=>this._graphicDrapedChanged()),this.view.trackGraphicState(this.graphicState)]);(a=this.view.pointsOfInterest)&&this.handles.add(a.centerOnSurfaceFrequent.watch("location",()=>this._updateDisplayBounds()));this._forEachManipulator(b=>{this.handles.add(b.events.on("grab-changed",()=>{this.grabbing=b.grabbing;this._updateAllManipulatorAvailability()}))});this._forEachManipulator((b,c)=>{this.handles.add(b.events.on("immediate-click",
d=>{c===q.ManipulatorType.TRANSLATE_XY&&this.emit("immediate-click",{...d,graphic:this.graphic});d.stopPropagation()}))});this._onGeometryChanged();this._updateAllManipulatorAvailability();this.finishToolCreation()};e._graphicDrapedChanged=function(){this.handles.remove("draped-elevation-changes");this._updateDisplayBounds();this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",a=>{h.isSome(this.attachmentOrigin)&&W.containsXY(a.extent,this.attachmentOrigin.x,
this.attachmentOrigin.y)&&this._updateDisplayBounds()}),"draped-elevation-changes")};e._updateAllManipulatorAvailability=function(){this._forEachManipulator((a,b)=>this._updateManipulatorAvailability(a,b))};e._updateManipulatorAvailability=function(a,b){const c=this.grabbing&&!a.grabbing;a.interactive=!c;if(a instanceof Z.Manipulator3D){const d=this.graphicState.displaying,g=this.enableZ&&ba.canMoveZ(this.graphic);switch(b){case q.ManipulatorType.ROTATE:a.available=d&&this.enableRotation;break;case q.ManipulatorType.SCALE:a.available=
d&&(this.enableScaling||this.enableRotation||g);a.interactive=!c&&this.enableScaling;a.state=this.enableScaling?k.resizeNormal:k.resizeOutlineOnly;break;case q.ManipulatorType.TRANSLATE_Z:a.available=d&&g;break;default:a.available=d}}};e._forEachManipulator=function(a){this.graphicMoveManipulation.forEachManipulator(a);this.resizeManipulators.forEach(b=>a(b,q.ManipulatorType.SCALE));a(this.rotateManipulator,q.ManipulatorType.ROTATE);a(this.moveZManipulator,q.ManipulatorType.TRANSLATE_Z)};e.destroy=
function(){this.displayBounds=this.mapBounds=null;this.rotateManipulatorTexture.release();this.handles.destroy();this.graphicMoveManipulation.destroy();this.editGeometryOperations.destroy();this._set("view",null);this._set("graphic",null)};e.reset=function(){};e._onGeometryChanged=function(){this._updateDisplayBounds()};e._calculateMapBounds=function(){const a=this.graphic.geometry,b=this.editGeometryOperations.data;var c=b.components[0].edges[0];c=z.subtract(t.sv2d.get(),c.leftVertex.pos,c.rightVertex.pos);
z.normalize(c,c);var d=h.unwrapOr(G.getGraphicAttachmentOrigin(this.view,this.graphic),a.extent.center);d=80*this.view.pixelSizeAt(d);const g=this.view.spatialReference;g!==a.spatialReference&&(d*=K.getMetersPerUnitForSR(g)/K.getMetersPerUnitForSR(a.spatialReference));u.calculateOrientedBounds(c,b,d,this.mapBounds)};e._updateDisplayBounds=function(){const a=this.graphic.geometry;if(!h.isNone(a)){var b=h.isSome(this.outlineVisualElement)&&!this.graphicState.isDraped&&h.isSome(this.outlineVisualElement.attachmentOrigin)?
this.outlineVisualElement.attachmentOrigin:G.getGraphicAttachmentOrigin(this.view,this.graphic);this.attachmentOrigin=h.unwrapOr(b,a.extent.center);b=h.isSome(b)?b.z:ha.evaluateElevationAlignmentAtPoint(this.mapBounds.origin,this.view.elevationProvider,ia.ElevationContext.fromElevationInfo(Y.getGraphicEffectiveElevationInfo(this.graphic)),this.view.renderCoordsHelper);var c=n.copy(this.mapBounds);c.origin[2]=b;u.mapPlaneToRenderPlane(c,this.view.renderCoordsHelper,a.spatialReference,this.displayBoundsMargin,
this.displayBounds);this._updateManipulators()}};e._createMoveXYGraphicDragPipeline=function(){return this.graphicMoveManipulation.createDragPipeline((a,b,c)=>this._applyGraphicMoveSteps(b,c))};e._createMoveZDragPipeline=function(){const a=this.view,b=this.editGeometryOperations.data.spatialReference;return y.createManipulatorDragEventPipeline(this.moveZManipulator,(c,d,g)=>{c=F.clone(c.renderLocation);d=d.next(H.screenToZConstrained(a,c,b)).next(y.addScreenDelta());this._applyGraphicMoveSteps(d,
g)})};e._applyGraphicMoveSteps=function(a,b){a=a.next(c=>{"start"===c.action&&(this.inputState={type:"move"},n.copy(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:c.screenDeltaX,dyScreen:c.screenDeltaY}));return c}).next(y.addMapDelta()).next(this._moveDragUpdateGeometry()).next(c=>{const d={graphic:this.graphic,dxScreen:c.screenDeltaX,dyScreen:c.screenDeltaY};switch(c.action){case "start":case "update":(c.mapEnd.x-c.mapStart.x||c.mapEnd.y-c.mapStart.y||
c.mapEnd.z-c.mapStart.z)&&this.emit("graphic-translate",d);break;case "end":this.inputState=null,this.emit("graphic-translate-stop",d)}return c});b.next(()=>{h.isSome(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0});this._cancel()});return a};e._moveDragUpdateGeometry=function(){return a=>{if(h.isNone(this.inputState)||"move"!==this.inputState.type)return a;var b=[];for(const c of this.editGeometryOperations.data.components)b.push(...c.vertices);b=
this.editGeometryOperations.moveVertices(b,a.mapDeltaX,a.mapDeltaY,a.mapDeltaZ,"start"===a.action?x.AccumulationBehaviour.NEW_STEP:x.AccumulationBehaviour.ACCUMULATE_STEPS);u.apply(b,this.mapBounds);this.graphic.geometry=this.editGeometryOperations.data.geometry;return a}};e._onResizeGrab=function(a){"start"===a.action&&(a=this._calculatePickRay(a.screenPoint),A.intersectRay(this.displayBounds.plane,a,t.sv3d.get())&&(n.copy(this.displayBounds,this.displayBoundsStart),n.copy(this.mapBounds,this.mapBoundsStart),
this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"}))};e._createResizeDragPipeline=function(a,b){return y.createManipulatorDragEventPipeline(a,(c,d,g)=>{h.isNone(this.inputState)||(d.next(f=>{"start"===f.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1});return f}).next(H.screenToRenderPlane(this.view,this.displayBoundsStart.plane)).next(f=>({...f,handle:b})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),
this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(f=>{const C={graphic:this.graphic,xScale:f.factor1,yScale:f.factor2};switch(f.action){case "start":case "update":this.emit("graphic-scale",C);break;case "end":this.inputState=null,this.emit("graphic-scale-stop",C)}return f}),g.next(()=>{h.isSome(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1});this._cancel()}))})};e._resizeDragRenderPlaneToFactors=function(){return a=>{const b=this.displayBoundsStart,
c=a.handle.direction,d=this.displayBoundsMargin,g=this.displayBoundsMarginStart;var f=m.copy(t.sv3d.get(),b.origin);m.scaleAndAdd(f,f,b.basis1,-c[0]);m.scaleAndAdd(f,f,b.basis2,-c[1]);const C=m.subtract(t.sv3d.get(),a.renderEnd,f),na=m.subtract(t.sv3d.get(),a.renderStart,f),oa=k.isDiagonalResizeHandle(a.handle);f=k.calculateDiagonalResizeHandleScale(b);const pa=k.calculateDiagonalResizeHandleScale(this.displayBounds)/f;f=(v,I)=>{if(0===v)return 1;let w=m.length(I),D=.5*v*m.dot(I,C)/w;const E=0>D?
-1:1;oa&&(v=w-.5*v*m.dot(I,na)/w,D+=v*E*pa);v=w<1.5*g?1:1E-6;w=Math.max(w-g,1E-6);0<E&&(D-=d);return E*Math.max(D/w*E,v)};return{...a,factor1:f(c[0],b.basis1),factor2:f(c[1],b.basis2)}}};e._resizeDragUpdateGeometry=function(){return a=>{var b=m.copy(F.create(),this.mapBoundsStart.origin);m.scaleAndAdd(b,b,this.mapBoundsStart.basis1,-a.handle.direction[0]);m.scaleAndAdd(b,b,this.mapBoundsStart.basis2,-a.handle.direction[1]);const c=z.set(V.create(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);
z.normalize(c,c);const d=[];for(const g of this.editGeometryOperations.data.components)d.push(...g.vertices);b=this.editGeometryOperations.scaleVertices(d,b,c,a.factor1,a.factor2,"start"===a.action?x.AccumulationBehaviour.NEW_STEP:x.AccumulationBehaviour.ACCUMULATE_STEPS,L.AccumulationType.REPLACE);n.copy(this.mapBoundsStart,this.mapBounds);u.apply(b,this.mapBounds);this.graphic.geometry=this.editGeometryOperations.data.geometry;return a}};e._onRotateGrab=function(a){if("start"===a.action){var b=
k.createRotatePlane(this.displayBounds,this.view.renderCoordsHelper,k.RotationAxis.HEADING,A.create());a=this._calculatePickRay(a.screenPoint);A.intersectRay(b,a,t.sv3d.get())&&(n.copy(this.displayBounds,this.displayBoundsStart),n.copy(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:b})}};e._createRotateDragPipeline=function(a){return y.createManipulatorDragEventPipeline(a,(b,c,d)=>{b=this.inputState;h.isNone(b)||(c.next(g=>{"start"===g.action&&this.emit("graphic-rotate-start",
{graphic:this.graphic,angle:0});return g}).next(H.screenToRenderPlane(this.view,b.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(b)).next(this._rotateDragUpdateGeometry()).next(g=>{const f={graphic:this.graphic,angle:Q.rad2deg(g.rotateAngle)};switch(g.action){case "start":case "update":this.emit("graphic-rotate",f);break;case "end":this.inputState=null,this.emit("graphic-rotate-stop",f)}return g}),d.next(()=>{h.isSome(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,
angle:0});this._cancel()}))})};e._rotateDragRenderPlaneToRotate=function(a){return b=>{const c=A.normal(a.rotatePlane),d=G.calculateInputRotationTransform(b.renderStart,b.renderEnd,this.displayBounds.origin,c);return{...b,rotateAxis:c,rotateAngle:d}}};e._rotateDragUpdateGeometry=function(){return a=>{var b=m.copy(F.create(),this.mapBoundsStart.origin);const c=[];for(const d of this.editGeometryOperations.data.components)c.push(...d.vertices);b=this.editGeometryOperations.rotateVertices(c,b,a.rotateAngle,
"start"===a.action?x.AccumulationBehaviour.NEW_STEP:x.AccumulationBehaviour.ACCUMULATE_STEPS,L.AccumulationType.REPLACE);n.copy(this.mapBoundsStart,this.mapBounds);u.apply(b,this.mapBounds);this.graphic.geometry=this.editGeometryOperations.data.geometry;return a}};e._calculatePickRay=function(a){const b=X.create();a=R.screenPointObjectToArray(a);ka.fromScreen(this.view.state.camera,a,b);m.normalize(b.direction,b.direction);return b};e._updateManipulators=function(){if(this.visible){var a=k.calculateBoundedPlaneTranslateRotate(this.displayBounds,
t.sm4d.get());k.updateRotateHeadingHandle(this.rotateManipulator,a,this.displayBounds,this.view.renderCoordsHelper);this._updateZMoveHandle(this.moveZManipulator,a);this.resizeManipulators.forEach((b,c)=>{k.updateResizeHandle(b,this.resizeHandles[c],a,this.displayBounds)})}};e._updateZMoveHandle=function(a,b){var c=this.displayBounds;c=m.subtract(t.sv3d.get(),c.origin,c.basis1);const d=t.sm4d.get();U.rotateZ(d,b,2*Math.PI/2);d[12]=0;d[13]=0;d[14]=0;a.modelTransform=d;a.renderLocation=c};e._cancel=
function(){const a=this.editGeometryOperations.lastOperation;h.isNone(a)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,u.unapply(a,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)};e.undo=function(){if(h.isSome(this.inputState))this.view.activeTool=null;else if(this.canUndo){const a=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry;u.unapply(h.unwrap(a),this.mapBounds);this._updateDisplayBounds()}};
e.redo=function(){if(this.canRedo){const a=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry;u.apply(h.unwrap(a),this.mapBounds);this._updateDisplayBounds()}};J._createClass(B,[{key:"preserveAspectRatio",get:function(){return this._preserveAspectRatio.enabled},set:function(a){this._preserveAspectRatio.enabled=a;this._set("preserveAspectRatio",a)}},{key:"displayBoundsMargin",get:function(){const a=this.view.pointsOfInterest;return 10*this.view.pixelSizeAt(a?
a.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center)}},{key:"canUndo",get:function(){return this.editGeometryOperations.canUndo}},{key:"canRedo",get:function(){return this.editGeometryOperations.canRedo}},{key:"test",get:function(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}}]);return B}(N.EventedMixin(la.InteractiveToolBase));p.__decorate([r.property({constructOnly:!0,nonNullable:!0})],
l.ExtentTransformTool.prototype,"view",void 0);p.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.ExtentTransformTool.prototype,"graphic",void 0);p.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.ExtentTransformTool.prototype,"enableZ",void 0);p.__decorate([r.property()],l.ExtentTransformTool.prototype,"enableRotation",void 0);p.__decorate([r.property()],l.ExtentTransformTool.prototype,"enableScaling",void 0);p.__decorate([r.property()],l.ExtentTransformTool.prototype,"preserveAspectRatio",
null);p.__decorate([r.property()],l.ExtentTransformTool.prototype,"grabbing",void 0);p.__decorate([r.property()],l.ExtentTransformTool.prototype,"inputState",void 0);p.__decorate([r.property({readOnly:!0})],l.ExtentTransformTool.prototype,"type",void 0);l.ExtentTransformTool=p.__decorate([T.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],l.ExtentTransformTool);l.EPSILON=1E-6;Object.defineProperty(l,"__esModule",{value:!0})});