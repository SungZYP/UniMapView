// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Graphic ../../../../core/compilerUtils ../../../../core/HandleOwner ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../geometry/support/webMercatorUtils ../../../../renderers/support/renderingInfoUtils ../../../../rest/support/Query ./constants ./Graphics3DCore ./Graphics3DElevationAlignment ./Graphics3DFilterVisibility ./Graphics3DFrustumVisibility ./Graphics3DObjectStates ./Graphics3DScaleVisibility ./graphicUtils ../support/attributeUtils ../../webgl-engine/lib/basicInterfaces".split(" "),
function(q,e,u,B,d,l,v,m,f,Q,R,S,C,w,x,y,D,E,F,G,H,I,J,K,L,z,n){d=function(A){function p(a){a=A.call(this,a)||this;a.type="graphics-3d";a.elevationFeatureExpressionEnabled=!1;a.dataExtent=null;a.preferredUpdatePolicy=n.UpdatePolicy.ASYNC;a.suspendResumeExtent=null;return a}q._inheritsLoose(p,A);var g=p.prototype;g.normalizeCtorArgs=function(a){const b=a.frustumVisibilityEnabled?new I:null,c=a.scaleVisibilityEnabled?new K:null,h=(a.filterVisibilityEnabled||a.timeExtentVisibilityEnabled)&&"multipatch"!==
a.owner.layer.geometryType?new H.Graphics3DFilterVisibility:null,k=a.elevationAlignmentEnabled?new G:null,{owner:r,updateClippingExtent:t,dataExtent:M,elevationFeatureExpressionEnabled:N,preferredUpdatePolicy:O}=a;return{owner:r,updateClippingExtent:t,dataExtent:M,frustumVisibility:b,scaleVisibility:c,filterVisibility:h,elevationAlignment:k,elevationFeatureExpressionEnabled:N,preferredUpdatePolicy:O}};g.initialize=function(){const a=new F.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,
elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",a);this.scaleVisibility&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.scaleVisibility.layerMinMaxScaleChangeHandler());this.filterVisibility&&(this.updatingHandles.add(()=>"filter"in this.owner&&this.owner.filter,()=>this.filterVisibility.filterChanged()),this.updatingHandles.add(()=>"timeExtent"in this.owner&&
this.owner.timeExtent,()=>this.filterVisibility.filterChanged()));this.elevationAlignment&&this.updatingHandles.add(()=>this.layer.elevationInfo,(b,c)=>{w.diff(b,c)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())});this.updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo());this.updatingHandles.add(()=>this.layer.labelingInfo,(b,c)=>{w.diff(b,c)&&this.graphicsCore.updateLabelingInfo()});this.updatingHandles.add(()=>this.preferredUpdatePolicy,
b=>this.graphicsCore.preferredUpdatePolicy=b);this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",()=>this.notifyChange("displayFeatureLimit")))};g.destroy=function(){this.handles.removeAll();this.updatingHandles.removeAll();this._set("frustumVisibility",l.destroyMaybe(this.frustumVisibility));this._set("scaleVisibility",l.destroyMaybe(this.scaleVisibility));this._set("filterVisibility",l.destroyMaybe(this.filterVisibility));this._set("elevationAlignment",l.destroyMaybe(this.elevationAlignment));
this._set("objectStates",l.destroyMaybe(this.objectStates));this._set("graphicsCore",l.destroyMaybe(this.graphicsCore));this._set("owner",null)};g.setup=function(){var a=q._asyncToGenerator(function*(){this.frustumVisibility&&this.frustumVisibility.setup(this);const b=this.owner,c=this.owner.view.basemapTerrain,h=(k,r,t)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(k,r,t);this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,h,this.graphicsCore,c);this.filterVisibility&&("filter"in
b||"timeExtent"in b)&&this.filterVisibility.setup(b,this.graphicsCore);this.elevationAlignment&&this.elevationAlignment.setup(this,h,this.graphicsCore,b.view.elevationProvider);this._set("objectStates",new J.Graphics3DObjectStates(this.graphicsCore));this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility));this._set("deconfliction",b.view.deconflictor.addGraphicsOwner(this.graphicsCore));yield v.logOnError(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,
scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates}));this.updatingHandles.add(()=>this.layer.renderer,k=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(k)));this.updatingHandles.add(()=>b.fullOpacity,()=>this.graphicsCore.opacityChange());this._setupSuspendResumeExtent();this.updateClippingExtent&&(this.updatingHandles.add(()=>b.view.clippingArea,()=>this._updateClippingExtent()),
this._updateClippingExtent());this.graphicsCore.startCreateGraphics();this.graphicsCore.labelsEnabled&&(yield v.logOnError(this.graphicsCore.updateLabelingInfo()))});return function(){return a.apply(this,arguments)}}();g.maskOccludee=function(a){const {set:b,handle:c}=this.objectStates.acquireSet(n.Object3DState.MaskOccludee,null);this.objectStates.setUid(b,a.uid);return c};g.highlight=function(a,b){if(a instanceof D){const {set:c,handle:h}=this.objectStates.acquireSet(n.Object3DState.Highlight,b);
this.owner.queryObjectIds(a).then(k=>this.objectStates.setObjectIds(c,k));return h}if("number"===typeof a||"string"===typeof a||a instanceof u)return this.highlight([a],b);"toArray"in a&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof u)if(null!=z.attributeLookup(this.layer.fieldsIndex,a[0].attributes,b))a=a.map(c=>z.attributeLookup(this.layer.fieldsIndex,c.attributes,b));else{a=a.map(k=>k.uid);const {set:c,handle:h}=this.objectStates.acquireSet(n.Object3DState.Highlight,null);
this.objectStates.setUids(c,a);return h}if("number"===typeof a[0]||"string"===typeof a[0]){const {set:c,handle:h}=this.objectStates.acquireSet(n.Object3DState.Highlight,b);this.objectStates.setObjectIds(c,a);return h}}return P};g.whenGraphicBounds=function(a,b){var c;return null==(c=this.graphicsCore)?void 0:c.whenGraphicBounds(a,b)};g.computeAttachmentOrigin=function(a,b){var c;return null==(c=this.graphicsCore)?void 0:c.computeAttachmentOrigin(a,b)};g.notifyGraphicGeometryChanged=function(a){this.graphicsCore.notifyGraphicGeometryChanged(a)};
g.notifyGraphicVisibilityChanged=function(a){this.graphicsCore.notifyGraphicVisibilityChanged(a)};g.getRenderingInfo=function(a,b,c){a=y.getRenderingInfo(a,{renderer:b,arcade:c});l.isSome(a)&&a.color&&(b=a.color,b[0]/=255,b[1]/=255,b[2]/=255);return a};g.getRenderingInfoAsync=function(a,b,c,h){return y.getRenderingInfoAsync(a,{renderer:b,arcade:c,...h})};g.getSymbolLayerSize=function(a,b){var c;return null==(c=this.graphicsCore)?void 0:c.getSymbolLayerSize(a,b)};g.setObjectIdVisibility=function(a,
b){var c;null==(c=this.graphicsCore)?void 0:c.setObjectIdVisibility(a,b)};g._updateClippingExtent=function(){const a=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(a,this.owner.view.spatialReference)&&(this.updateClippingExtent(a)||this.graphicsCore.recreateAllGraphics())};g._setupSuspendResumeExtent=function(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(m.watch(()=>this.suspendResumeExtentMode,()=>{this.handles.remove("suspendResumeExtentMode");switch(this.suspendResumeExtentMode){case "computed":this.handles.add([m.watch(()=>
this.graphicsCore.computedExtent,a=>this._updateSuspendResumeExtent(a),m.initial),m.watch(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],"suspendResumeExtentMode");break;case "data":this.handles.add([m.when(()=>this.dataExtent,a=>this._updateSuspendResumeExtent(a),m.initial),m.watch(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(l.unwrap(this.dataExtent)))],"suspendResumeExtentMode");break;default:B.neverReached(this.suspendResumeExtentMode)}},
m.initial))};g._updateSuspendResumeExtent=function(a){a?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(a,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null)};g._extentToSuspendResumeRect=function(a,b){const c=this.owner.view.spatialReference;if(!a.spatialReference.equals(c)){if(!x.canProject(a,c))return;a=x.project(a,c)}return L.enlargeExtent(a,b,E.SUSPEND_RESUME_EXTENT_OPTIMISM,this.graphicsCore.extentPadding)};g._suspendResumeExtentChanged=function(a){this.frustumVisibility&&
this.frustumVisibility.setExtent(a);this.scaleVisibility&&this.scaleVisibility.setExtent(a)};q._createClass(p,[{key:"featureSpatialReference",get:function(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:void 0}},{key:"layer",get:function(){return this.owner.layer}},{key:"suspendResumeExtentMode",get:function(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}},{key:"scaleVisibilitySuspended",get:function(){var a;return null==
(a=this.scaleVisibility)?void 0:a.suspended}},{key:"suspended",get:function(){return this.owner.suspended}},{key:"legendEnabled",get:function(){return!this.frustumVisibility.suspended}},{key:"suspendInfo",get:function(){var a,b;const c={};null!=(a=this.scaleVisibility)&&a.suspended&&(c.outsideScaleRange=!0);null!=(b=this.frustumVisibility)&&b.suspended&&(c.outsideOfView=!0);return c}},{key:"updating",get:function(){var a,b,c;return!!(null!=(a=this.graphicsCore)&&a.updating||null!=(b=this.frustumVisibility)&&
b.updating||null!=(c=this.updatingHandles)&&c.updating)}},{key:"updatingRemaining",get:function(){var a,b;return null!=(a=null==(b=this.graphicsCore)?void 0:b.updatingRemaining)?a:0}},{key:"featureStore",get:function(){var a;return null==(a=this.graphicsCore)?void 0:a.featureStore}},{key:"view",get:function(){return this.owner.view}},{key:"loadedGraphics",get:function(){return this.owner.loadedGraphics}},{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"filter",get:function(){return"filter"in
this.owner?this.owner.filter:null}},{key:"slicePlaneEnabled",get:function(){return this.owner.slicePlaneEnabled}},{key:"drapeSourceType",get:function(){return this.owner.drapeSourceType}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"graphics3DGraphics",get:function(){var a;return null==(a=this.graphicsCore)?void 0:a.graphics3DGraphics}},{key:"graphics3DGraphicsByObjectID",get:function(){var a;return null==(a=this.graphicsCore)?void 0:a.graphics3DGraphicsByObjectID}},{key:"symbolUpdateType",
get:function(){var a;return null==(a=this.graphicsCore)?void 0:a.symbolUpdateType}},{key:"displayFeatureLimit",get:function(){var a;const b=this.view.resourceController.memoryController.memoryFactor,c=null==(a=this.graphicsCore)?void 0:a.displayFeatureLimit;return 1===b?c:{...c,maximumNumberOfFeatures:Math.ceil(c.maximumNumberOfFeatures*b),maximumTotalNumberOfFeatures:Math.ceil(c.maximumTotalNumberOfFeatures*b),minimumTotalNumberOfFeatures:Math.ceil(c.minimumTotalNumberOfFeatures*b)}}},{key:"usedMemory",
get:function(){var a,b;return null!=(a=null==(b=this.graphicsCore)?void 0:b.usedMemory)?a:0}},{key:"usedMemoryPerFeature",get:function(){var a,b;return null!=(a=null==(b=this.graphicsCore)?void 0:b.usedMemoryPerGraphic)?a:0}},{key:"unprocessedMemoryEstimate",get:function(){var a,b;return null!=(a=null==(b=this.graphicsCore)?void 0:b.unprocessedMemoryEstimate)?a:0}},{key:"performanceInfo",get:function(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,
visibilityFrustum:!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}}]);return p}(d.HandleOwner);e.__decorate([f.property()],d.prototype,"type",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"owner",void 0);e.__decorate([f.property()],d.prototype,"layer",null);e.__decorate([f.property({constructOnly:!0})],d.prototype,"updateClippingExtent",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"elevationFeatureExpressionEnabled",void 0);
e.__decorate([f.property({constructOnly:!0})],d.prototype,"graphicsCore",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"scaleVisibility",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"filterVisibility",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"elevationAlignment",void 0);e.__decorate([f.property({constructOnly:!0})],d.prototype,"frustumVisibility",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"deconfliction",void 0);e.__decorate([f.property({readOnly:!0})],
d.prototype,"labeling",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"objectStates",void 0);e.__decorate([f.property()],d.prototype,"suspendResumeExtentMode",null);e.__decorate([f.property()],d.prototype,"dataExtent",void 0);e.__decorate([f.property()],d.prototype,"scaleVisibilitySuspended",null);e.__decorate([f.property()],d.prototype,"suspended",null);e.__decorate([f.property()],d.prototype,"legendEnabled",null);e.__decorate([f.property()],d.prototype,"suspendInfo",null);e.__decorate([f.property()],
d.prototype,"updating",null);e.__decorate([f.property()],d.prototype,"updatingRemaining",null);e.__decorate([f.property()],d.prototype,"featureStore",null);e.__decorate([f.property()],d.prototype,"view",null);e.__decorate([f.property()],d.prototype,"loadedGraphics",null);e.__decorate([f.property()],d.prototype,"fullOpacity",null);e.__decorate([f.property()],d.prototype,"filter",null);e.__decorate([f.property()],d.prototype,"slicePlaneEnabled",null);e.__decorate([f.property()],d.prototype,"drapeSourceType",
null);e.__decorate([f.property()],d.prototype,"updatePolicy",null);e.__decorate([f.property()],d.prototype,"preferredUpdatePolicy",void 0);e.__decorate([f.property()],d.prototype,"displayFeatureLimit",null);d=e.__decorate([C.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],d);const P={remove(){},pause(){},resume(){}};return d});