// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/TileHandler3D ../../2d/engine/vectorTiles/VTLPainter3D ../../2d/engine/vectorTiles/style/StyleRepository ./LayerView3D ./TiledLayerView3D ../terrain/terrainUtils ../../layers/LayerView".split(" "),
function(p,k,E,g,F,G,q,f,P,Q,H,I,t,u,v,J,K,w,L){f=function(x){function l(){var b=x.apply(this,arguments)||this;b.type="vector-tile-3d";return b}p._inheritsLoose(l,x);var r=l.prototype;r.initialize=function(){if(g.isNone(this.layer.fullExtent))this.addResolvingPromise(Promise.reject(new E("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));else{var {basemapTerrain:b,spatialReference:m,pixelRatio:h,viewingMode:n}=this.view,c="local"===n&&!w.vtlAssumes256PixelSizeAsDefault(m)||
w.test.force512VTL,e=this.layer.tileInfo.spatialReference.isGeographic;c=c?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,e?1:2);c=this._getTileInfoSupportError(c,this.layer.fullExtent);if(g.isSome(c))return this.addResolvingPromise(Promise.reject(c));c=G.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{var a=b.tilingScheme,d=a.pixelSize;this.schemaHelper=new I.SchemaHelper(d,b.spatialReference.isGeographic);d=256===d?this.layer.tileInfo.getOrCreateCompatible(256,
this.layer.tileInfo.spatialReference.isGeographic?1:2):this.view.spatialReference.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;if(a=this._getTileInfoCompatibilityError(d,a))throw a;this.tileInfo=d});this._tileHandlerController=new AbortController;var y=this.view.resourceController;this._memCache=y.memoryController.newCache(this.layer.uid,a=>{a.release()});({style:e}=this.layer.currentStyleInfo);e=new v(e);var z=b.mapTileRequester;this._tileHandler=new t(this.layer,
e,h,this._memCache,z);var A=this._tileHandlerController.signal,B=a=>y.schedule(a);e=this._tileHandler.start({signal:A,schedule:B});var C=this._tileHandler.spriteMosaic;C.then(a=>{!F.isAborted(A)&&this._tileHandler&&(this.painter=new u(a,this._tileHandler.glyphMosaic))});e.then(()=>this._tileHandlerController=null);this.updatingHandles.add(()=>[this.layer.currentStyleInfo,this.view.pixelRatio],()=>{this._tileHandlerController&&this._tileHandlerController.abort();this._tileHandlerController=new AbortController;
this._memCache.clear();var {style:a}=this.layer.currentStyleInfo;a=new v(a);const d=new t(this.layer,a,h,this._memCache,z);a=d.start({signal:this._tileHandlerController.signal,schedule:B});const M=d.spriteMosaic;a.then(()=>this._tileHandlerController=null);this.updatingHandles.addPromise(Promise.all([a,M]).then(([,N])=>{const O=this._tileHandler,D=this.painter;this.painter=new u(N,d.glyphMosaic);this._tileHandler=d;this.emit("data-changed");O.destroy();D&&D.dispose()}))});c=Promise.all([c,e,C]);this.addResolvingPromise(c)}};
r.destroy=function(){this.painter=g.disposeMaybe(this.painter);this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null);g.destroyMaybe(this._tileHandler);this._memCache=g.destroyMaybe(this._memCache);this._tileHandler=null};r.fetchTile=function(){var b=p._asyncToGenerator(function*(m,h,n,c){return this._tileHandler.getVectorTile(m,h,n,c)});return function(m,h,n,c){return b.apply(this,arguments)}}();p._createClass(l,[{key:"dataLevelRange",get:function(){var b=
this.tileInfo.lods;b=this.levelRangeFromScaleRange(b[0].scale,b[b.length-1].scale);1===b.minLevel&&256===this.tileInfo.size[0]&&(b.minLevel=0);return b}}]);return l}(K.TiledLayerView3D(J.LayerView3D(L)));k.__decorate([q.property()],f.prototype,"layer",void 0);k.__decorate([q.property()],f.prototype,"dataLevelRange",null);k.__decorate([q.property()],f.prototype,"updatingProgressValue",void 0);return f=k.__decorate([H.subclass("esri.views.3d.layers.VectorTileLayerView3D")],f)});