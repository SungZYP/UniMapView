// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/maybe ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f32 ../../../chunks/vec3f64 ../../../geometry/projectionEllipsoid ../../../chunks/Precipitation.glsl ./PrecipitationTechnique ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/core/shaderLibrary/util/View.glsl ../webgl-engine/lib/AnimationTimer ../webgl-engine/lib/VertexAttribute ../../support/WatchUpdatingTracking ../../webgl/BufferObject ../../webgl/enums ../../webgl/Util ../../webgl/VertexArrayObject".split(" "),
function(f,v,m,E,c,F,q,N,O,P,G,k,t,w,H,n,l,x,y,I,J,z,K,A,u,B,L){f.Precipitation=function(C){function r(a){var b=C.call(this,a)||this;b._numParticles=25E4;b._rainSpeed=.1;b._snowSpeed=.01;b._opacity=1;b._width=500;b._offset=w.create();b._tile=w.create();b._particleColor=t.create();b._particleColorAtNight=t.create();b._nightMultiplier=.7;b._cameraDirection=t.create();b._renderParameters={camera:null,time:0,radius:1};b._animation=new J.AnimationTimer;b._updatingTracking=new K.WatchUpdatingTracking;b._renderParameters.time=
0;b._renderParameters.radius=H.getReferenceEllipsoid(a.view.spatialReference).radius;b._shaderTechniqueRepository=a.context.shaderTechniqueRepository;return b}v._inheritsLoose(r,C);var h=r.prototype;h.destroy=function(){this._updatingTracking.destroy();this._numParticles=0;this._snowTechnique=c.releaseMaybe(this._snowTechnique);this._rainTechnique=c.releaseMaybe(this._rainTechnique);this._vao=c.disposeMaybe(this._vao);this._instanceIdBuffer=c.disposeMaybe(this._instanceIdBuffer)};h.update=function(a){return this._animation.advance(a)};
h.render=function(a,b,e){const {rctx:g,camera:d}=a;this._ensureResources(g);var p=e===n.PrecipitationType.RAIN?this.rainTechnique:this.snowTechnique;c.isNone(p)||c.isNone(this._vao)||c.isNone(this._instanceIdBuffer)||(c.isSome(a.cloudsCompositionParams)&&(this._opacity=1-a.cloudsCompositionParams.fadeInOutHeight.factor),0>=this._opacity||(p=g.useTechnique(p),this._renderParameters.camera=d,this._renderParameters.time=(e===n.PrecipitationType.RAIN?this._rainSpeed:this._snowSpeed)*F.secondsFromMilliseconds(this._animation.time),
this._update(p,d,e,a),g.bindVAO(this._vao),a=l.PrecipitationTechnique.attributeLocation,p.assertCompatibleVertexAttributeLocations(this._vao),B.bindVertexBufferLayout(g,a,this._instanceIdBuffer,D,0),g.capabilities.instancing.drawArraysInstanced(u.PrimitiveType.TRIANGLES,0,3,this._numParticles*b),B.unbindVertexBufferLayout(g,a,this._instanceIdBuffer,D)))};h._update=function(a,b,e,g){const d=b.eye;this._tile[0]=Math.floor((d[0]+.5*this._width)/this._width);this._tile[1]=Math.floor((d[1]+.5*this._width)/
this._width);this._tile[2]=Math.floor((d[2]+.5*this._width)/this._width);this._offset[0]=d[0]-this._tile[0]*this._width;this._offset[1]=d[1]-this._tile[1]*this._width;this._offset[2]=d[2]-this._tile[2]*this._width;a.setUniform1f("width",this._width);a.setUniform3fv("offset",this._offset);a.setUniformMatrix4fv("view",b.viewMatrix);a.setUniform3fv("cameraPosition",d);I.bindProjectionMatrix(a,b.projectionMatrix);a.setUniform1f("time",this._renderParameters.time);e===n.PrecipitationType.RAIN?k.set(this._particleColor,
.85,.85,.85):k.set(this._particleColor,1,1,1);k.scale(this._particleColorAtNight,this._particleColor,this._nightMultiplier);k.normalize(this._cameraDirection,d);b=Math.max(0,k.dot(this._cameraDirection,g.scenelightingData.lightingMainDirection));k.lerp(this._particleColor,this._particleColorAtNight,this._particleColor,b);a.setUniform3fv("particleColor",this._particleColor);a.setUniform1f("opacity",this._opacity)};h._ensureResources=function(a){c.isSome(this._vao)||(this._vao=this._createVertexArrayObject(a),
c.isSome(this._instanceIdBuffer)||(this._instanceIdBuffer=this._createInstanceIndices(a)))};h._createInstanceIndices=function(a){const b=[];for(let e=0;e<this._numParticles;e++)b.push(e);return A.BufferObject.createVertex(a,u.Usage.STATIC_DRAW,new Float32Array(b))};h._createVertexArrayObject=function(a){const b=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new L.VertexArrayObject(a,l.PrecipitationTechnique.attributeLocation,{geometry:x.glLayout(M)},{geometry:A.BufferObject.createVertex(a,u.Usage.STATIC_DRAW,
b)})};v._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"rainTechnique",get:function(){if(c.isNone(this._rainTechnique)){const a=new l.PrecipitationTechniqueConfiguration;a.type=n.PrecipitationType.RAIN;this._rainTechnique=this._shaderTechniqueRepository.acquire(l.PrecipitationTechnique,a)}return this._rainTechnique}},{key:"snowTechnique",get:function(){if(c.isNone(this._snowTechnique)){const a=new l.PrecipitationTechniqueConfiguration;a.type=n.PrecipitationType.SNOW;
this._snowTechnique=this._shaderTechniqueRepository.acquire(l.PrecipitationTechnique,a)}return this._snowTechnique}}]);return r}(E);m.__decorate([q.property({constructOnly:!0})],f.Precipitation.prototype,"context",void 0);m.__decorate([q.property({constructOnly:!0})],f.Precipitation.prototype,"view",void 0);m.__decorate([q.property({readOnly:!0})],f.Precipitation.prototype,"updating",null);m.__decorate([q.property()],f.Precipitation.prototype,"_updatingTracking",void 0);f.Precipitation=m.__decorate([G.subclass("esri.views.3d.environment.Precipitation")],
f.Precipitation);const M=y.newLayout().vec3f(z.VertexAttribute.POSITION),D=x.glLayout(y.newLayout().f32(z.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperty(f,"__esModule",{value:!0})});