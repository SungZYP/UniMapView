// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/byteSizeEstimations ../../../../core/Error ../../../../core/HandleOwner ../../../../core/handleUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/scaleUtils ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/OptimizedGeometry ../../../../layers/graphics/data/FeatureStore ../../../../layers/support/fieldUtils ../../../../renderers/support/heatmapUtils ../../terrain/OverlayRenderer ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/ModelDirtyTypes ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/HeatmapDensityMaterial".split(" "),
function(c,r,d,t,u,G,H,I,k,p,e,V,W,X,J,K,L,M,N,y,z,O,A,P,Q,R,S,B,T,w,U,C,D){const x=I.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor");c.HeatmapFeatureProcessor=function(E){function v(a){a=E.call(this,a)||this;a.type="heatmap";a.filterVisibility={filterChanged(){},dirty:!1};a.preferredUpdatePolicy=B.UpdatePolicy.ASYNC;a.dataExtent=null;a._renderGeometries=new Map;a._material=new D.HeatmapDensityMaterial({});a._materialWithField=new D.HeatmapDensityMaterial({isAttributeDriven:!0});
a._fieldTotal=0;a._memoryFactor=1;return a}r._inheritsLoose(v,E);var m=v.prototype;m.initialize=function(){this._featureStore=new P({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const {colorBufferFloat:a,textureFloat:f}=this._renderView.capabilities,{floatBufferBlendWorking:h}=this._renderView.renderingContext.driverTest;if(null==f||!f.textureFloat)throw new u("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(null==
a||!a.textureFloat)throw new u("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(null==a||!a.floatBlend)throw new u("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!h)throw new u("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");
this._memoryFactor=this.owner.view.resourceController.memoryController.memoryFactor;this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,b=>this._onLoadedFeaturesChange(b),p.initial);this.updatingHandles.addWhen(()=>this._materialParameters,b=>this._forEachMaterial(g=>g.setParameters(b)),p.initial);this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},p.sync);this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),
({fieldName:b,numeric:g})=>{if(k.isSome(b)&&g){let l=0;this._featureStore.forEach(n=>{var q;l+=null!=(q=n.attributes[b])?q:0});this._fieldTotal=l}else this._fieldTotal=this._featureStore.numFeatures},p.initial);this.handles.add([p.watch(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:b,field:g})=>{if(b&&!g){var l;x.warn(`Heatmap renderer field '${b}' for layer '${null!=(l=this.layer.title)?l:this.layer.id}' not found`)}}),p.watch(()=>({field:this._heatmapRendererField,
numeric:this._heatmapRendererFieldIsNumeric}),({field:b,numeric:g})=>{if(k.isSome(b)&&!g){var l;x.warn(`Heatmap renderer field '${b.name}' for layer '${null!=(l=this.layer.title)?l:this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}}),this.owner.view.resourceController.memoryController.events.on("quality-changed",()=>{var b,g,l,n,q;this._memoryFactor=null!=(b=null==(g=this.owner)?void 0:null==(l=g.view)?void 0:null==(n=l.resourceController)?void 0:null==
(q=n.memoryController)?void 0:q.memoryFactor)?b:1})])};m.destroy=function(){this._overlayRenderer.removeGeometries(Array.from(this._renderGeometries.values()),this.owner,w.ModelDirty.Geometry.REMOVE);this._renderGeometries.clear();this._material=k.disposeMaybe(this._material);this._materialWithField=k.disposeMaybe(this._materialWithField);this._featureStore.clear();this._featureStore=null};m.whenGraphicBounds=function(){var a=r._asyncToGenerator(function*(){return null});return function(){return a.apply(this,
arguments)}}();m.computeAttachmentOrigin=function(){return null};m.highlight=function(){return F};m.maskOccludee=function(){return F};m.setObjectIdVisibility=function(){};m.setup=function(){var a=r._asyncToGenerator(function*(){});return function(){return a.apply(this,arguments)}}();m._onLoadedFeaturesChange=function(a){if(this._featuresArePoints){var {objectIdField:f}=this.layer;this._featureStore.removeManyById(a.removed.map(b=>y.getObjectId(b,f)));this._featureStore.addMany(a.added.map(b=>new O.OptimizedFeature(z.convertFromPoint(new A,
b.geometry),b.attributes,k.applySome(b.centroid,g=>z.convertFromPoint(new A,g)),y.getObjectId(b,f))));var h=a.added;a=a.removed;this._fieldTotal+=this._computeFieldTotalChange(h,a);a=k.mapSome(a,({uid:b})=>{const g=this._renderGeometries.get(b);this._renderGeometries.delete(b);return g});h=h.map(b=>{const g=this._pointGraphicToRenderGeometry(b);this._renderGeometries.set(b.uid,g);return g});0<a.length&&this._overlayRenderer.removeGeometries(a,this.owner,w.ModelDirty.Geometry.REMOVE);0<h.length&&this._overlayRenderer.addGeometries(h,
this.owner,w.ModelDirty.Geometry.ADD,!0);(0<h.length||0<a.length)&&this._renderView.requestRender()}};m._recreate=function(){if(this._loadedPointGraphics){var a=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:a,removed:a})}};m._pointGraphicToRenderGeometry=function(a){const f=this._heatmapRendererFieldName,h=k.isSome(f)?this._materialWithField:this._material,b=L.create();M.projectPointToVector(a.geometry,b,this._overlaySpatialReference);b[2]=S.DRAPED_Z;const g=[[C.VertexAttribute.POSITION,
{data:b,size:b.length}]],l=this._heatmapRendererFieldIsNumeric;if(k.isSome(f)){var n;g.push([C.VertexAttribute.FEATUREATTRIBUTE,{data:[l?null!=(n=a.attributes[f])?n:0:0],size:1}])}a=new U.RenderGeometry(new T.Geometry(g,null,B.PrimitiveType.Point),h,{layerUid:this.layer.uid,graphicUid:a.uid});K.copy(a.boundingSphere,b);return a};m._forEachMaterial=function(a){a(this._material);a(this._materialWithField)};m._computeFieldTotalChange=function(a,f){if(k.isNone(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return a.length-
f.length;const h=this._heatmapRendererFieldName,b=(g,l)=>{var n;return g+(null!=(n=l.attributes[h])?n:0)};return a.reduce(b,0)-f.reduce(b,0)};m._clampSearchRadius=function(a){50<a&&x.warnOnce("SceneView supports a maximum blurRadius of 50 for HeatmapRenderer.");return Math.min(a,50)};r._createClass(v,[{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"updatingRemaining",
get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"displayFeatureLimit",get:function(){var a,f;const h=this._memoryFactor,b=null==(a=this.owner)?void 0:null==(f=a.view)?void 0:f.qualitySettings;a=b?Math.ceil(b.heatmap.maxTotalNumberOfFeatures*h):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:a,maximumTotalNumberOfPrimitives:2*a,maximumNumberOfFeatures:a}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&
this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"scaleVisibilitySuspended",get:function(){return!1}},{key:"usedMemory",get:function(){var a,f,h,b,g;const l=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:n}=null==(a=this._renderView)?void 0:null==(f=a.capabilities)?void 0:f.colorBufferFloat;a=null!=n?1:4;f=null!=(h=Math.ceil((null==(b=this._overlayRenderer)?NaN:null==(g=b.overlays[0])?NaN:g.resolution)*this._densityMapPixelRatio))?h:0;
h=f*f*a*4;b=k.isSome(this._heatmapRenderer)?3*Math.min(this._heatmapRenderer.blurRadius,50):0;return h+l+b*a*4}},{key:"usedMemoryPerFeature",get:function(){if(0===this._featureStore.numFeatures)return 0;let a=0;this._featureStore.forEach(g=>a+=t.estimateAttributesObjectSize(g.attributes));a/=this._featureStore.numFeatures;const f=t.estimateNumberByteSize(),h=6*t.estimateFixedArraySize([0,0,0],f),b=6*t.estimateFixedArraySize([0,0],f);return h+b+(this._heatmapRendererFieldIsNumeric?6*f:0)+a}},{key:"unprocessedMemoryEstimate",
get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"_overlayRenderer",get:function(){return this.owner.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return k.unwrap(this._overlayRenderer.spatialReference)}},{key:"_materialParameters",get:function(){return{...this._blurRadiusParameters,...this._densityParameters,
colorRampData:this._colorRampData,pixelRatio:this._densityMapPixelRatio}}},{key:"_densityParameters",get:function(){const a=this._heatmapRenderer;return k.isNone(a)?null:{minDensity:a.minPixelIntensity,maxDensity:a.maxPixelIntensity,fieldTotal:this._fieldTotal}}},{key:"_blurRadiusParameters",get:function(){return k.applySome(this._heatmapRenderer,({referenceScale:a,blurRadius:f})=>({searchRadius:this._clampSearchRadius(f),resolutionForScale:0===a?0:N.getResolutionForScale(a,this.owner.view.spatialReference)}))}},
{key:"_colorRampData",get:function(){return k.applySome(this._heatmapRenderer,a=>R.generateGradient(a.colorStops))}},{key:"_densityMapPixelRatio",get:function(){var a,f,h;const b=this._memoryFactor;return(null!=(a=null==(f=this.owner)?void 0:null==(h=f.view)?void 0:h.qualitySettings.heatmap.pixelRatio)?a:1)*Math.sqrt(b)}},{key:"_renderView",get:function(){return this.owner.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",
get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){const a=this.layer.renderer;return"heatmap"===(null==a?void 0:a.type)?a:null}},{key:"_heatmapRendererFieldName",get:function(){return k.applySome(this._heatmapRenderer,a=>a.field)}},{key:"_heatmapRendererField",get:function(){return k.applySome(this._heatmapRendererFieldName,a=>this.layer.fieldsIndex.get(a))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){const a=this._heatmapRendererField;return k.isNone(a)?
!1:Q.isNumericField(a)}}]);return v}(G.HandleOwner);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"type",void 0);d.__decorate([e.property({constructOnly:!0})],c.HeatmapFeatureProcessor.prototype,"owner",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"layer",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"featureStore",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"updating",null);d.__decorate([e.property()],
c.HeatmapFeatureProcessor.prototype,"updatingRemaining",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"suspendInfo",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"legendEnabled",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"filterVisibility",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"displayFeatureLimit",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"preferredUpdatePolicy",
void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"hasZ",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"hasM",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"dataExtent",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_featureStore",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_overlayRenderer",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_overlaySpatialReference",
null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_materialParameters",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_densityParameters",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_blurRadiusParameters",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_colorRampData",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_densityMapPixelRatio",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,
"_renderGeometries",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_material",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_materialWithField",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_renderView",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_featuresArePoints",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_loadedPointGraphics",null);d.__decorate([e.property()],
c.HeatmapFeatureProcessor.prototype,"_heatmapRenderer",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldName",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_heatmapRendererField",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldIsNumeric",null);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,"_fieldTotal",void 0);d.__decorate([e.property()],c.HeatmapFeatureProcessor.prototype,
"_memoryFactor",void 0);c.HeatmapFeatureProcessor=d.__decorate([J.subclass("esri.views.3d.layers.support.HeatmapFeatureProcessor")],c.HeatmapFeatureProcessor);const F=H.makeHandle();c.MAX_RADIUS=50;Object.defineProperty(c,"__esModule",{value:!0})});