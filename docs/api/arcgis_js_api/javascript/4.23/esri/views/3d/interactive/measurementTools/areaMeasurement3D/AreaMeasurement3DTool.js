// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../layers/graphics/hydratedFeatures ../../../analysis/support/measurementUtils ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DView ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../support/screenUtils".split(" "),
function(q,f,B,n,r,h,d,I,J,C,t,u,D,v,E,F,w){d=function(x){function k(a){a=x.call(this,a)||this;a._handles=new B;a._tempPickRequest=new v.PickRequest;a.polygonState="initial";a.analysisView=null;return a}q._inheritsLoose(k,x);var b=k.prototype;b.initialize=function(){this.measurementView=new v({view:this.view,analysis:this.analysis,analysisView:this.analysisView,toolState:this,manipulators:this.manipulators,visible:this.visible});this._setupManipulators();this.startToolCreation();this._handles.add(r.watch(()=>
this.state,a=>{"measured"===a&&this.finishToolCreation()},r.syncAndInitial))};b.destroy=function(){this.measurementView.destroy();this._set("measurementView",null);this._handles=n.destroyMaybe(this._handles)};b.finishMeasurement=function(){const a=this.analysisView.path;3>a.numVertices?(a.clear(),this.polygonState="initial"):(a.close(),this.polygonState="measured");this.analysisView.cursorPoint=null};b.onShow=function(){this.measurementView.show()};b.onHide=function(){this.measurementView.hide()};
b.onInputEvent=function(a){switch(a.type){case "immediate-double-click":this._handleImmediateDoubleClick(a);break;case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}};b._setupManipulators=function(){const a=c=>c.events.on("grab-changed",()=>{this.analysisView.validMeasurement&&(this.polygonState=this.manipulators.some(g=>g.manipulator.grabbing)?"editing":"measured")}),
e=(c,g)=>{this._handles.add([E.createManipulatorDragEventPipeline(g,(l,G,H)=>{const y=D.hideManipulatorWhileDragging(l),p=n.unwrap(this.measurementView.manipulatorToVertex(l));G.next(y).next(this.measurementView.screenToMap3D()).next(z=>{l.location=z.mapEnd;this.analysisView.path.setVertexPosition(p,t.clonePoint(z.mapEnd))});const A=t.clonePoint(this.analysisView.path.getVertexPositionAsPoint(p));H.next(y).next(()=>{this.analysisView.path.setVertexPosition(p,A);l.location=A})}),a(g)],`manipulator-${c}`)},
m=c=>{this._handles.remove(`manipulator-${c}`)};this.manipulators.forEach(({id:c,manipulator:g})=>{e(c,g)});this._handles.add([this.manipulators.on("after-add",({item:{id:c,manipulator:g}})=>{e(c,g)}),this.manipulators.on("after-remove",({item:{id:c}})=>{m(c)})])};b._handleImmediateDoubleClick=function(a){u.isPrimaryPointerAction(a)&&("drawing"===this.polygonState&&this.finishMeasurement(),a.stopPropagation())};b._handleDrag=function(a){"editing"===this.polygonState&&a.stopPropagation()};b._handleImmediateClick=
function(a){if(u.isPrimaryPointerAction(a)){var e=w.createScreenPointFromEvent(a);if(this.active)switch(this.polygonState){case "initial":if(this._addVertexAt(e)){this.measurementView.cursorPoint=null;this.polygonState="drawing";a.stopPropagation();return}break;case "drawing":{const m=this.measurementView.vertexHandleAt(e,a.pointerType);if(n.isNone(m)){if(this._addVertexAt(e)){this.measurementView.cursorPoint=null;a.stopPropagation();return}}else 0===m.index&&(this.finishMeasurement(),a.stopPropagation())}}"mouse"===
a.pointerType&&this._hoverAt(e)}};b._handlePointerMove=function(a){"mouse"===a.pointerType&&(a=w.createScreenPointFromEvent(a),this._hoverAt(a))};b._handleKeyDown=function(a){"Enter"===a.key&&"drawing"===this.polygonState&&(this.finishMeasurement(),a.stopPropagation())};b._hoverAt=function(a){this.measurementView.requiresCursorPoint?(a=this._pick(a),a.mapPoint&&(this.measurementView.cursorPoint=a.mapPoint)):this.measurementView.cursorPoint=null};b._addVertexAt=function(a){a=this._pick(a);return a.mapPoint?
(this.analysisView.path.add(a.mapPoint),!0):!1};b._pick=function(a){const e=this._tempPickRequest;e.screenPoint=a;return this.measurementView.pick(e)};q._createClass(k,[{key:"state",get:function(){return 0===this.analysisView.path.numVertices?"ready":this.analysisView.validMeasurement&&"editing"!==this.polygonState?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.polygonState?"crosshair":null}}]);return k}(F.InteractiveToolBase);f.__decorate([h.property({readOnly:!0})],
d.prototype,"state",null);f.__decorate([h.property()],d.prototype,"polygonState",void 0);f.__decorate([h.property({readOnly:!0})],d.prototype,"cursor",null);f.__decorate([h.property()],d.prototype,"measurementView",void 0);f.__decorate([h.property({constructOnly:!0})],d.prototype,"view",void 0);f.__decorate([h.property()],d.prototype,"analysis",void 0);f.__decorate([h.property({constructOnly:!0})],d.prototype,"analysisView",void 0);return d=f.__decorate([C.subclass("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],
d)});