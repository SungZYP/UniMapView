// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../dragEventPipeline3D ../ManipulatorType ../manipulations/config ../../../support/mathUtils ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces".split(" "),
function(N,T,U,V,F,x,W,X,Y,A,Z,t,G,H,I,m,aa,ba,ca,da,ea,c,fa,ha,K,ia,ja,ka,y){function la(d,g){var a=t.subtract(m.sv3d.get(),g.renderStart,d.origin);d=t.subtract(m.sv3d.get(),g.renderEnd,d.origin);a=t.length(a);d=t.length(d);return 0===a?0:d/a}function ma(d,g,a,b){const {renderStart:k,renderEnd:n}=d;var u=J(k,b,m.sv3d.get());d=J(n,b,m.sv3d.get());if(t.squaredDistance(u,d)<c.DRAG_THRESHOLD_PX*c.DRAG_THRESHOLD_PX)return null;const h=t.subtract(m.sv3d.get(),k,a);g=t.cross(m.sv3d.get(),h,H.normal(g));
g=t.add(m.sv3d.get(),k,g);a=J(a,b,m.sv3d.get());b=J(g,b,m.sv3d.get());g=t.subtract(m.sv3d.get(),b,u);b=t.subtract(m.sv3d.get(),u,a);u=I.wrap(u,g);b=I.wrap(a,b);return I.distance2(u,d)<I.distance2(b,d)?"rotate":"scale"}function J(d,g,a){g.projectToScreen(d,L);return t.set(a,L[0],L[1],0)}function O(d,g){let a=null,b=1;const k=()=>b;return{start:()=>{b=d.getScale();a=d.getScale;d.getScale=k;g()},update:n=>{b+=((b+1)/2-b)*Math.min(n*c.RING_RESET_ANIMATION_SPEED_FACTOR,1);g();return.01>Math.abs(b-1)?B.STOP:
B.CONTINUE},destroy:()=>{d.getScale=a;g()}}}function na(d,g){let a=0,b=null;const k=()=>!1;return{start:()=>{b=d.getFocused;d.getFocused=k;a=0;g()},update:n=>{a+=n;return!b()||a>c.RING_INDICATOR_DELAY_MS?B.STOP:B.CONTINUE},destroy:()=>{d.getFocused=b;g()}}}var e;(function(d){d.ScaleIn=y.ManipulatorStateCustomFlags.Custom2;d.ScaleOut=y.ManipulatorStateCustomFlags.Custom3;d.RotateLeft=y.ManipulatorStateCustomFlags.Custom4;d.RotateRight=y.ManipulatorStateCustomFlags.Custom5;d.Unlocked=y.ManipulatorStateCustomFlags.Custom7;
d.DelayedFocused=y.ManipulatorStateCustomFlags.Custom8;d.TouchInput=y.ManipulatorStateCustomFlags.Custom12})(e||(e={}));let oa=function(){function d(a){this.mode=null;this._handles=new V;this._activeAnimation=this._scaleRotateDragData=null;this.events=new U;this.getFocused=()=>this.ringManipulator.focused;this.getScale=()=>x.isSome(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1;this.tool=a.tool;this.mode=a.mode;this.adapter=a.adapter;this._createManipulator();
this._updateDragState();this._updateManipulatorTransform()}var g=d.prototype;g.destroy=function(){x.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null);this._handles=x.destroyMaybe(this._handles);this.tool.manipulators.remove(this.ringManipulator);this.ringManipulator=null};g.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=W.addFrameTask({update:({deltaTime:k})=>{a.update(k)&&this.cancelActiveAnimation()}});this._activeAnimation=
{...a,frameTask:b}};g.cancelActiveAnimation=function(){x.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=x.destroyMaybe(this._activeAnimation))};g.forEachManipulator=function(a){a(this.ringManipulator,ea.ManipulatorType.SCALE_ROTATE)};g._createManipulator=function(){this.ringManipulator=this._createRingManipulator();this.tool.manipulators.add(this.ringManipulator);const a=this.tool.graphicState.graphic,b=ka.createManipulatorDragEventPipeline(this.ringManipulator,
(k,n,u)=>{this._scaleRotateDragData=null;this.adapter.restart();const h={mode:"none",origin:G.clone(k.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=h;this._updateDragState();const C=m.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(k.renderLocation,C);n.next(da.screenToRenderPlane(this.tool.view,H.fromPositionAndNormal(k.renderLocation,C,H.create()))).next(p=>{var l=H.normal(p.plane);l=ca.calculateInputRotationTransform(p.renderStart,
p.renderEnd,h.origin,l);var f=fa.cyclicalPI.shortestSignedDiff(h.angle,l);h.angleDir=F.clamp(h.angleDir+f,-c.ROTATE_INDICATOR_DIRECTION_BUFFER,c.ROTATE_INDICATOR_DIRECTION_BUFFER);h.angle=l;f=la(h,p);h.scaleDir=F.clamp(h.scaleDir+(f-this.adapter.scale),-c.SCALE_INDICATOR_DIRECTION_BUFFER,c.SCALE_INDICATOR_DIRECTION_BUFFER);this._onScaleChanged();if("none"===h.mode){const q=this.mode||ma(p,p.plane,h.origin,this.tool.view.state.camera);if(x.isSome(q)){switch(q){case "rotate":this.tool.emit("graphic-rotate-start",
{graphic:a,angle:0});this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}h.mode=q}}switch(h.mode){case "rotate":this.adapter.angle=h.initialAngle+l;break;case "scale":this.adapter.scale=f,this._onScaleChanged()}this._updateDragState();this._updateManipulatorTransform();switch(p.action){case "start":case "update":switch(h.mode){case "rotate":this.tool.emit("graphic-rotate",
{graphic:a,angle:F.rad2deg(h.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:a,xScale:f,yScale:f})}break;case "end":switch(h.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:F.rad2deg(h.angle)});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:f,yScale:f})}}"end"===p.action&&(this.startAnimation(O(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState())});u.next(()=>{this.adapter.cancel();if(x.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",
{graphic:a,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1})}this.startAnimation(O(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}})});this._handles.add(b);this._handles.add([this.ringManipulator.events.on("focus-changed",k=>{"focus"===k.action?this.startAnimation(na(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",k=>{k.stopPropagation()}),
Y.init(this.tool.graphicState,"displaying",k=>this.ringManipulator.available=k)])};g._onScaleChanged=function(){this.events.emit("scale-changed");this._updateManipulatorTransform()};g._updateDelayedFocusedState=function(){this.ringManipulator.updateStateEnabled(e.DelayedFocused,this.getFocused())};g._updateDragState=function(){this.ringManipulator.updateStateEnabled(e.Unlocked,!(x.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode));if(x.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this.ringManipulator.updateStateEnabled(e.ScaleIn|
e.ScaleOut,!1);this.ringManipulator.updateStateEnabled(e.RotateLeft,0>this._scaleRotateDragData.angleDir);this.ringManipulator.updateStateEnabled(e.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this.ringManipulator.updateStateEnabled(e.RotateLeft|e.RotateRight,!1),this.ringManipulator.updateStateEnabled(e.ScaleIn,0>this._scaleRotateDragData.scaleDir),this.ringManipulator.updateStateEnabled(e.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this.ringManipulator.updateStateEnabled(e.ScaleIn|
e.ScaleOut|e.RotateLeft|e.RotateRight,!1)};g._updateManipulatorTransform=function(){const a=A.fromRotation(m.sm4d.get(),this.adapter.angle,G.fromValues(0,0,1));var b=this.getScale();b=A.fromScaling(m.sm4d.get(),t.set(m.sv3d.get(),b,b,b));this.ringManipulator.modelTransform=A.multiply(m.sm4d.get(),b,a)};g._createRingManipulator=function(){var a=(D,z,P)=>{const Q=[],R=Math.ceil(c.GEOMETRY_SEGMENTS*(z-D)/(2*Math.PI));for(let M=0;M<R+1;M++){const S=D+M*(z-D)/R;Q.push(G.fromValues(P*Math.cos(S),P*Math.sin(S),
0))}return Q},b=(D,z)=>K.createPathExtrusionGeometry([[-z/2,0],[z/2,0],[z/2,c.RING_HEIGHT/2],[-z/2,c.RING_HEIGHT/2]],D,[],[],!1),k=a(0,2*Math.PI,c.RING_RADIUS),n=b(k,c.RING_THICKNESS),u=[],h=[];const C=[];for(var p=0;2>p;p++){var l=p*Math.PI-Math.PI/4,f=Math.PI/2-c.ROTATE_INDICATOR_ARC_LENGTH,q=l+f;l=l+Math.PI/2-f;f=a(q,l,c.INNER_INDICATOR_RADIUS);var v=b(f,c.INDICATOR_THICKNESS);C.push(f);C.push(a(q,l,c.OUTER_INDICATOR_RADIUS-c.RING_THICKNESS/2));u.push(v);h.push(v);for(v=0;2>v;v++){var E=0===v,
r=Z.create();if(E){A.scale(r,r,[1,-1,1]);A.rotate(r,r,-q,[0,0,1]);var w=Math.round(c.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(f.length-1));r[12]=f[w][0];r[13]=f[w][1];r[14]=f[w][2]}else A.rotate(r,r,l,[0,0,1]),w=Math.round((1-c.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(f.length-1)),r[12]=f[w][0],r[13]=f[w][1],r[14]=f[w][2];w=K.createExtrudedTriangle(c.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,c.ROTATE_INDICATOR_ARROW_TIP_RADIUS,c.RING_HEIGHT);K.transformInPlace(w,r);(E?u:h).push(w)}}p=[];for(q=
0;2>q;q++)l=q*Math.PI-Math.PI/4,f=Math.PI/2-c.SCALE_INDICATOR_ARC_LENGTH,l=a(l+f,l+Math.PI/2-f,c.OUTER_INDICATOR_RADIUS),p.push(b(l,c.INDICATOR_THICKNESS));q=a(0,2*Math.PI,c.RING_RADIUS+c.SCALE_INDICATOR_OFFSET1);l=a(0,2*Math.PI,c.RING_RADIUS+c.SCALE_INDICATOR_OFFSET2);q=b(q,c.INDICATOR_THICKNESS);l=b(l,c.INDICATOR_THICKNESS);f=a(0,2*Math.PI,c.RING_RADIUS-c.SCALE_INDICATOR_OFFSET1);v=a(0,2*Math.PI,c.RING_RADIUS-c.SCALE_INDICATOR_OFFSET2);a=b(f,c.INDICATOR_THICKNESS);b=b(v,c.INDICATOR_THICKNESS);f=
this._createMaterial();v=this._createMaterial(.66);r=this._createMaterial(.5);E=this._createMaterial(.33);n=[{geometry:n,material:f,stateMask:e.DelayedFocused},{geometry:n,material:r,stateMask:y.ManipulatorStateFlags.None}];this.mode&&"scale"!==this.mode||(n=n.concat([{geometry:p,material:f,stateMask:e.DelayedFocused|e.Unlocked},{geometry:q,material:v,stateMask:e.DelayedFocused|e.ScaleIn},{geometry:l,material:E,stateMask:e.DelayedFocused|e.ScaleIn},{geometry:a,material:v,stateMask:e.DelayedFocused|
e.ScaleOut},{geometry:b,material:E,stateMask:e.DelayedFocused|e.ScaleOut}]));this.mode&&"rotate"!==this.mode||(n=n.concat([{geometry:h,material:f,stateMask:e.DelayedFocused|e.Unlocked},{geometry:u,material:f,stateMask:e.DelayedFocused|e.RotateLeft},{geometry:h,material:f,stateMask:e.DelayedFocused|e.RotateRight}]));k=[k,...C];return new ba.Manipulator3D({view:this.tool.view,renderObjects:n,autoScaleRenderObjects:!1,worldOriented:!0,radius:c.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:aa.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),
collisionType:{type:"ribbon",paths:k,direction:G.fromValues(0,0,1)}})};g._createMaterial=function(a=1){const b=[...c.HANDLE_COLOR,a];return new ja.ColorMaterial({color:b,transparent:1!==a,cullFace:ha.CullFaceOptions.Back,renderOccluded:ia.RenderOccludedFlag.Transparent})};T._createClass(d,[{key:"angle",get:function(){return this.adapter.angle}},{key:"scale",get:function(){return this.adapter.scale}},{key:"location",set:function(a){this.ringManipulator.location=a}},{key:"elevationAlignedLocation",
set:function(a){this.ringManipulator.elevationAlignedLocation=a}},{key:"grabbing",get:function(){return this.ringManipulator.grabbing}},{key:"interactive",set:function(a){this.ringManipulator.interactive=a}},{key:"test",get:function(){return{ringManipulator:this.ringManipulator}}}]);return d}();var B;(function(d){d[d.CONTINUE=0]="CONTINUE";d[d.STOP=1]="STOP"})(B||(B={}));const L=X.createScreenPointArray();N.GraphicScaleRotateTransform=oa;Object.defineProperty(N,"__esModule",{value:!0})});