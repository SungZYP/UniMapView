// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/handleUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../LineOfSightAnalysisResult ./LineOfSightComputation ./LineOfSightRayIntersector ../support/projectionUtils ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtilsConversions ../../../support/Scheduler ../../../support/WatchUpdatingTracking ../../../../geometry/Point".split(" "),
function(n,G,p,ha,U,V,M,u,W,d,N,l,q,ia,ja,ka,X,g,w,H,D,O,Y,Z,aa,I,ba,P,y,ca,J){function Q(B,x){return d.isNone(x)||d.isSome(B)&&B.equals(x.point)}const R=W.getLogger("esri.views.3d.analysis.LineOfSight.LineOfSightController");n.LineOfSightController=function(B){function x(a){a=B.call(this,a)||this;a.updateOnCameraChange=!0;a._updatingHandles=new ca.WatchUpdatingTracking;a._frameTask=y.ImmediateTask;a._handles=new M;a._computationHandles=new M;a._externalObserverUpdate=!0;return a}G._inheritsLoose(x,
B);var f=x.prototype;f.initialize=function(){var a;const b=null==(a=this.view.resourceController)?void 0:a.scheduler;this._frameTask=b?b.registerTask(y.TaskPriority.LINE_OF_SIGHT_TOOL):y.ImmediateTask;this._intersector=new aa.LineOfSightRayIntersector({view:this.view});this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])};f.destroy=function(){this._handles.destroy();this._computationHandles.destroy();this._computations.removeAll();this._updatingHandles.destroy()};
f.getLineOfSightComputationDependencies=function(a){({inputPoints:a}=a);return{inputPoints:a}};f._computeResult=function(a){const b=a.computation,{inputPoints:c,computationResult:e}=b,{observerAdjusted:h,targetAdjusted:m}=c,{start:k,end:r}=e;g.copy(k,h);g.copy(r,m);this._canCompute(b)?this._computeIntersection(a):this._interpolateIntersection(a);b.notifyResultChanged();this.emit("result-changed",{target:a.computation.target,result:b.result})};f._adjustStartEndPositions=function(a){var b=this._screenPixelSize;
const c=this.view;({inputPoints:a}=a);const {observer:e,observerSurfaceNormal:h,target:m,targetSurfaceNormal:k,observerAdjusted:r,targetAdjusted:t}=a;a=E;d.isSome(h)?g.copy(a,h):g.subtract(a,m,e);g.normalize(a,a);g.scale(a,a,Math.min(b,1));g.add(r,e,a);d.isSome(k)?g.copy(a,k):g.subtract(a,e,m);b=c.state.camera.computeScreenPixelSizeAt(m);g.normalize(a,a);g.scale(a,a,Math.min(b,1));g.add(t,m,a)};f._computeIntersection=function({computation:a,interpolationInfo:b}){const {view:c}=this,{sceneIntersectionHelper:e,
renderCoordsHelper:h}=c;if(!d.isNone(e)){var m=this._intersector.intersector,{computationResult:k,inputPoints:r}=a,{observer:t,target:z}=r,{start:K,end:L}=k,A=O.fromPoints(K,L,da);e.intersectToolIntersectorRay(A,m);A=k.intersection;var S=E,v=!0;m.results.min.getIntersectionPoint(A)&&(g.copy(b.originalIntersection,A),g.copy(b.originalObserver,K),g.copy(b.originalTarget,L),h.fromRenderCoords(A,S,c.spatialReference),b=1-g.dist(L,z)/g.dist(K,z),v=g.dist(t,A)>=b*g.dist(t,z));b=new J(S,c.spatialReference);
{const {result:C,target:T}=a;d.isSome(C)?(C.target=T,C.intersectedGraphic=v?null:P.toGraphic(m.results.min,c),C.intersectedLocation=v?null:b,C.visible=v):a.result=new Y.LineOfSightAnalysisResult({target:T,elevationAlignedTargetLocation:a.elevationAlignedTargetLocation,intersectedGraphic:v?null:P.toGraphic(m.results.min,c),intersectedLocation:v?null:b,visible:v})}k.isValid=r.isValid=!0;k.isTargetVisible=v}};f._interpolateIntersection=function({computation:a,interpolationInfo:b}){const {computationResult:c,
inputPoints:e}=a,{start:h,end:m,intersection:k}=c,{originalIntersection:r,originalObserver:t,originalTarget:z}=b;g.copy(k,r);e.isValid?(a=E,b=g.dist(t,r)/g.dist(t,z),g.sub(a,h,t),g.scale(a,a,1-b),g.add(k,k,a),g.sub(a,m,z),g.scale(a,a,b),g.add(k,k,a),c.isValid=!0):(a.result=null,c.isValid=!1,c.isTargetVisible=!1)};f._canCompute=function(a){var b=this.view.frustum;if(d.isNone(this.analysisViewData.elevationAlignedObserver)||d.isNone(a.elevationAlignedTargetLocation)||d.isNone(b))return!1;const {observerAdjusted:c,
targetAdjusted:e}=a.inputPoints;a=b.intersectsPoint(c);b=b.intersectsPoint(e);return a&&b};f._onObserverPositionChange=function(a,b,c){this._externalObserverUpdate=c;d.isNone(a)?this.analysisViewData.elevationAlignedObserver=null:(b=this._applyProjectionAndElevationAlignment(a,b),d.isNone(b)?(I.logFailedGeometryProjectionError(this.analysis,a.spatialReference,R),this.analysisViewData.elevationAlignedObserver=null):(a=w.create(),this.analysisViewData.elevationAlignedObserver=b,this.view.renderCoordsHelper.toRenderCoords(this.analysisViewData.elevationAlignedObserver,
a),this._observerEngineLocation=a,this.priority=y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))};f._applyProjectionAndElevationAlignment=function(a,b){b=d.isSome(b)&&b.type!==ba.IntersectorType.OBJECT;return I.applyProjectionAndElevationAlignment(a,this.view.spatialReference,this.view.elevationProvider,b)};f._onObserverRenderSpacePositionChangeForComputation=function(a,b,c){const {inputPoints:e}=a;g.copy(e.observer,b);d.isSome(c)?(b=this._intersector.updateFromIntersectionResult(c),d.isSome(b)&&this.view.renderCoordsHelper.toRenderCoords(b,
e.observer),e.observerSurfaceNormal=w.clone(c.normal)):e.observerSurfaceNormal=null;this._adjustStartEndPositions(a);a.notifyInputPointsChanged();this.priority=y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};f._onTargetPositionChange=function(a,b,c,e=!0){const h=a.inputPoints;e&&(h.isValid=!1);a.elevationAlignedTargetLocation=this._applyProjectionAndElevationAlignment(b,c);d.isNone(a.elevationAlignedTargetLocation)?I.logFailedGeometryProjectionError(this.analysis,b.spatialReference,R):(this.view.renderCoordsHelper.toRenderCoords(a.elevationAlignedTargetLocation,
h.target),d.isSome(c)?(b=this._intersector.updateFromIntersectionResult(c),d.isSome(b)&&this.view.renderCoordsHelper.toRenderCoords(b,h.target),h.targetSurfaceNormal=w.clone(c.normal)):h.targetSurfaceNormal=null,this._adjustStartEndPositions(a));a.notifyInputPointsChanged();this.priority=y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};f._connectComputationToTarget=function(a){return u.handlesGroup([l.watch(()=>a.target.position,b=>{Q(b,a.target.intersection)||(a.target.intersection=null)},l.initial),
l.watch(()=>({computation:a,targetPosition:a.target.position,targetIntersection:a.target.intersection}),({computation:b,targetPosition:c,targetIntersection:e})=>{d.isSome(c)&&this._onTargetPositionChange(b,c,e)},l.syncAndInitial)])};f._connectComputationToObserver=function(a){return l.watch(()=>({computation:a,observer:this.analysisViewData.elevationAlignedObserver}),({computation:b})=>{this._externalObserverUpdate&&(b.inputPoints.isValid=!1,b.notifyInputPointsChanged())},l.syncAndInitial)};f._connectComputationToRenderSpaceObserver=
function(a){return l.watch(()=>({computation:a,observer:this._observerEngineLocation,observerIntersection:d.isSome(this.analysis.observer)?this.analysis.observer.intersection:null}),({computation:b,observer:c,observerIntersection:e})=>{this._onObserverRenderSpacePositionChangeForComputation(b,c,e)},l.syncAndInitial)};f._connectComputationToCamera=function(a){return l.watch(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:b})=>{!this.updateOnCameraChange||a.inputPoints.isValid&&
!b||a.notifyInputPointsChanged()},l.sync)};f._connectComputationToSlicePlane=function(a){return l.watch(()=>this.view.slicePlane,()=>a.notifyInputPointsChanged())};f._connectComputationToElevation=function(a){return this.view.elevationProvider.on("elevation-change",b=>{const c=this.analysis.observer,e=a.target;let h=null,m=null,k=null,r=null;const t=d.isSome(c)&&d.isSome(c.position)?c.position.spatialReference:d.isSome(e.position)?e.position.spatialReference:b.spatialReference;d.isSome(c)&&d.isSome(c.position)&&
(h=ea,m=c.intersection,H.projectPoint(c.position,h,t));d.isSome(e.position)&&(k=fa,r=e.intersection,H.projectPoint(e.position,k,t));d.isNone(h)&&d.isNone(k)||(H.projectBoundingRect(b.extent,b.spatialReference,F,t),d.isSome(h)&&D.containsPointObject(F,h)&&this._onObserverPositionChange(h,m,!1),d.isSome(k)&&D.containsPointObject(F,k)&&this._onTargetPositionChange(a,k,r,!1),d.isSome(h)&&d.isSome(k)&&D.intersectsSegment(F,h,k)&&a.notifyInputPointsChanged())})};f._connectComputationToTask=function(a){var b=
this;let c=d.none;const e={computation:a,interpolationInfo:{originalIntersection:w.create(),originalObserver:w.create(),originalTarget:w.create()}};return u.handlesGroup([l.watch(()=>this.getLineOfSightComputationDependencies(a),()=>{c=d.abortMaybe(c);c=N.createTask(function(){var h=G._asyncToGenerator(function*(m){yield N.ignoreAbortErrors(b._frameTask.schedule(()=>b._computeResult(e),m))});return function(m){return h.apply(this,arguments)}}())},l.syncAndInitial),u.makeHandle(()=>c=d.abortMaybe(c))])};
f._connectComputation=function(a){const b=this._computationHandles;b.has(a)||b.add([this._connectComputationToTarget(a),this._connectComputationToObserver(a),this._connectComputationToRenderSpaceObserver(a),this._connectComputationToCamera(a),this._connectComputationToSlicePlane(a),this._connectComputationToElevation(a),this._connectComputationToTask(a)],a)};f._disconnectAnalysis=function(a){this._computationHandles.remove(a)};f._onComputationCollectionChange=function(a){a.added.forEach(b=>this._connectComputation(b));
a.removed.forEach(b=>this._disconnectAnalysis(b))};f._onTargetsChange=function(){this._computations.removeAll();this.analysis.targets.forEach(a=>this._addTarget(a));return this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,a=>this._onTargetCollectionChange(a))};f._onTargetCollectionChange=function(a){a.added.forEach(b=>this._addTarget(b));a.removed.forEach(b=>this._removeTarget(b))};f._onCursorTargetChange=function(a,b){d.isSome(b)&&this._removeTarget(b);d.isSome(a)&&this._addTarget(a)};
f._addTarget=function(a){this._computations.some(b=>b.target===a)||this._computations.add(new Z.LineOfSightComputation({target:a}))};f._removeTarget=function(a){const b=this._computations.find(c=>c.target===a);this._computations.remove(b)};f._connectObserver=function(){return u.handlesGroup([l.watch(()=>({observer:this.analysis.observer,observerPosition:d.isSome(this.analysis.observer)?this.analysis.observer.position:null,observerIntersection:d.isSome(this.analysis.observer)?this.analysis.observer.intersection:
null}),({observer:a,observerPosition:b,observerIntersection:c})=>{d.isSome(a)&&!Q(b,c)&&(a.intersection=null)},l.initial),l.watch(()=>({observerPosition:d.isSome(this.analysis.observer)?this.analysis.observer.position:null,observerIntersection:d.isSome(this.analysis.observer)?this.analysis.observer.intersection:null}),({observerPosition:a,observerIntersection:b})=>this._onObserverPositionChange(a,b,!0),l.syncAndInitial)])};f._connectComputations=function(){let a=null;return u.handlesGroup([l.watch(()=>
this._computations,()=>{d.removeMaybe(a);a=this._updatingHandles.addOnCollectionChange(()=>this._computations,b=>this._onComputationCollectionChange(b));this._computations.forEach(b=>this._connectComputation(b))},l.syncAndInitial),u.makeHandle(()=>a=d.removeMaybe(a))])};f._connectTargets=function(){let a=null;return u.handlesGroup([l.watch(()=>this.analysis.targets,()=>{a=d.removeMaybe(a);a=this._onTargetsChange()},l.syncAndInitial),l.watch(()=>this.analysisViewData.cursorTarget,(b,c)=>{this._onCursorTargetChange(b,
c)}),u.makeHandle(()=>{a=d.removeMaybe(a)})])};G._createClass(x,[{key:"updating",get:function(){return this._frameTask.updating||this._updatingHandles.updating}},{key:"priority",get:function(){return this._frameTask.priority},set:function(a){this._frameTask.priority=a}},{key:"_computations",get:function(){return this.analysisViewData.computations}},{key:"_observerEngineLocation",get:function(){return this.analysisViewData.observerEngineLocation},set:function(a){this.analysisViewData.observerEngineLocation=
a}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}},{key:"_isCameraDirty",get:function(){var a=this.analysisViewData.elevationAlignedObserver;const {view:b}=this,{renderCoordsHelper:c}=b;if(d.isNone(a)||d.isNone(c))return!1;const e=E;c.toRenderCoords(a,e);a=b.state.camera.computeScreenPixelSizeAt(e);return.1<Math.abs((a-this._screenPixelSize)/this._screenPixelSize)}}]);return x}(V.EventedMixin(U));p.__decorate([q.property({constructOnly:!0})],
n.LineOfSightController.prototype,"analysis",void 0);p.__decorate([q.property({constructOnly:!0})],n.LineOfSightController.prototype,"analysisViewData",void 0);p.__decorate([q.property({constructOnly:!0})],n.LineOfSightController.prototype,"view",void 0);p.__decorate([q.property()],n.LineOfSightController.prototype,"updating",null);p.__decorate([q.property()],n.LineOfSightController.prototype,"priority",null);p.__decorate([q.property()],n.LineOfSightController.prototype,"updateOnCameraChange",void 0);
p.__decorate([q.property()],n.LineOfSightController.prototype,"_computations",null);p.__decorate([q.property()],n.LineOfSightController.prototype,"_observerEngineLocation",null);p.__decorate([q.property()],n.LineOfSightController.prototype,"_screenPixelSize",null);p.__decorate([q.property({readOnly:!0})],n.LineOfSightController.prototype,"_updatingHandles",void 0);p.__decorate([q.property()],n.LineOfSightController.prototype,"_frameTask",void 0);p.__decorate([q.property()],n.LineOfSightController.prototype,
"_isCameraDirty",null);n.LineOfSightController=p.__decorate([X.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightController")],n.LineOfSightController);const E=w.create(),da=O.create(),F=D.empty(),ea=new J,fa=new J;Object.defineProperty(n,"__esModule",{value:!0})});