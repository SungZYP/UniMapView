// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/SetUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/vec2f64 ../../../chunks/vec3f64 ../../../chunks/mat4f64 ../../ViewingMode ../layers/interfaces ../support/debugFlags ./interfaces ./Overlay ./OverlayFramebufferObject ./OverlayRenderTarget ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Camera ../webgl-engine/lib/DrapedHeatmapRenderer ../webgl-engine/lib/GLMaterialRepository ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Material ../webgl-engine/lib/ModelDirtyTypes ../webgl-engine/lib/RenderContext ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/Lightsources ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/StippleTextureRepository ../../../chunks/Compositing.glsl ../webgl-engine/shaders/CompositingTechnique ../../support/Scheduler ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(h,F,p,X,Y,Z,aa,v,g,ba,ca,G,w,Da,Ea,Fa,da,O,ea,H,fa,ha,B,P,z,Q,ia,ja,ka,I,R,la,S,ma,T,na,oa,J,pa,x,qa,C,K,ra,U,sa,ta,ua,va,wa,L,r,xa,ya){function za(m,n,e,a,b,c,d){const f={layerUid:c,graphicUid:d,triangleNr:n};n=k=>{k.set(J.IntersectorType.OVERLAY,f,m.dist,m.normal,m.transformation,e,a)};(null==b.results.min.drapedLayerOrder||e>=b.results.min.drapedLayerOrder)&&(null==b.results.min.dist||b.results.ground.dist<=b.results.min.dist)&&n(b.results.min);b.options.store!==J.StoreResults.MIN&&(null==
b.results.max.drapedLayerOrder||e<b.results.max.drapedLayerOrder)&&(null==b.results.max.dist||b.results.ground.dist>b.results.max.dist)&&n(b.results.max);b.options.store===J.StoreResults.ALL&&(c=oa.newIntersectorResult(b.ray),n(c),b.results.all.push(c))}const V=aa.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");h.OverlayRenderer=function(m){function n(a){a=m.call(this,a)||this;a._overlays=null;a._overlayRenderTarget=null;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._lighting=
new ta.SceneLighting;a._handles=new Z;a._frameTask=L.ImmediateTask;a._layerRenderers=new Map;a._sortedLayerRenderersDirty=!1;a._sortedLayerRenderers=new ba;a._geometries=new Map;a.worldToPCSRatio=1;a.events=new Y;a.longitudeCyclical=null;return a}F._inheritsLoose(n,m);var e=n.prototype;e.initialize=function(){const a=this.view._stage.renderView;this._rctx=a.renderingContext;this._renderContext=new qa.OverlayRenderContext(this._rctx);const b=a.waterTextureRepository;this._stippleTextureRepository=
new ua.StippleTextureRepository(a.renderingContext);this._shaderTechniqueRepository=new ka.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:ha.ViewingMode.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:b});this._handles.add([G.init(b,"loadingState",()=>this.events.emit("content-changed")),G.init(this,"spatialReference",c=>this._localOrigins=new na.GridLocalOriginFactory(c))]);this._materialRepository=new ma.GLMaterialRepository(a.textureRepository,this._shaderTechniqueRepository,
c=>{0<(c.renderOccluded&M)!==this._rendersOccluded&&this._updateRendersOccluded();this.events.emit("content-changed");this.notifyChange("updating")},()=>this.events.emit("content-changed"));this._lighting.groundLightingFactor=1;this._lighting.globalFactor=0;this._lighting.set([new sa.AmbientLight(H.fromValues(1,1,1))]);this._bindParameters={slot:K.RenderSlot.DRAPED_MATERIAL,highlightDepthTexture:T.createEmptyDepthTexture(this._rctx),camera:t,inverseViewport:ea.create(),origin:null,screenToWorldRatio:null,
screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:fa.IDENTITY,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:R.TransparencyPassType.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0};this._frameTask=this.view.resourceController.scheduler.registerTask(L.TaskPriority.STAGE,
this);this._handles.add(this._frameTask)};e.dispose=function(){this._handles.destroy();this._layerRenderers.forEach(a=>a.destroy());this._layerRenderers.clear();this._debugTextureTechnique=g.releaseMaybe(this._debugTextureTechnique);this._debugPatternTexture=g.disposeMaybe(this._debugPatternTexture);this._bindParameters.highlightDepthTexture=g.disposeMaybe(this._bindParameters.highlightDepthTexture);this._shaderTechniqueRepository=g.disposeMaybe(this._shaderTechniqueRepository);this._temporaryFBO=
g.disposeMaybe(this._temporaryFBO);this._quadVAO=g.disposeMaybe(this._quadVAO);this.disposeOverlays()};e.collectUnusedRenderTargetMemory=function(a){let b=!1;if(g.isSome(this._overlayRenderTarget))for(const c of this._overlayRenderTarget.renderTargets)b=this._overlayRenderTarget.validateUsageForTarget(this.overlays[0].validTargets[c.type]||!this.overlays[1].validTargets[c.type],c,a)||b;return b};e.ensureDrapeTargets=function(a){g.isSome(this._overlays)&&this._overlays.forEach(b=>{b.hasTargetWithoutRasterImage=
ca.someSet(a,c=>c.drapeTargetType===B.DrapeTargetType.WithoutRasterImage)})};e.ensureDrapeSources=function(a){g.isSome(this._overlays)&&this._overlays.forEach(b=>{b.hasDrapedFeatureSource=v.someMap(a,(c,d)=>d.drapeSourceType===B.DrapeSourceType.Features);b.hasDrapedRasterSource=v.someMap(a,(c,d)=>d.drapeSourceType===B.DrapeSourceType.RasterImage)})};e.ensureOverlays=function(a,b){g.isNone(this._overlays)&&(this._overlayRenderTarget=new ja.OverlayRenderTarget(this._rctx),this._overlays=[new Q.Overlay(z.OverlayIndex.INNER,
this._overlayRenderTarget),new Q.Overlay(z.OverlayIndex.OUTER,this._overlayRenderTarget)]);this.ensureDrapeTargets(a);this.ensureDrapeSources(b)};e.disposeOverlays=function(){this._overlays=null;this._overlayRenderTarget=g.disposeMaybe(this._overlayRenderTarget);this.events.emit("textures-disposed")};e.runTask=function(a,b=()=>!0){this._frameTask.processQueue(a);a.done||this._processLayers(a,b)};e._processLayers=function(a,b){let c=!1;for(const [d,f]of this._layerRenderers){if(a.done)break;if(d.destroyed||
b(d))f.commitChanges()&&(c=!0,a.madeProgress()),f.isEmpty&&(this._sortedLayerRenderersDirty=c=!0,this._layerRenderers.delete(d),this._handles.remove(d),f.destroy())}this._updateSortedLayerRenderers();c&&(g.isSome(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())};e.processSyncLayers=function(){this._processLayers(L.noBudget,a=>a.updatePolicy===
R.UpdatePolicy.SYNC)};e.addGeometries=function(a,b,c,d=!1){for(const f of a)g.isNone(f.origin)&&(f.origin=this._localOrigins.getOrigin(f.boundingSphere)),this._geometries.set(f.id,f);this._ensureLayerRenderer(b,d).add(a);c===x.ModelDirty.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(a,b)};e.removeGeometries=function(a,b,c){for(var d of a)this._geometries.delete(g.unwrap(d.id));if(d=this._layerRenderers.get(b))d.remove(a),c===x.ModelDirty.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(a,
b)};e.updateGeometries=function(a,b,c){const d=this._layerRenderers.get(b);if(d)switch(d.modify(a,c),c){case x.ModelDirty.State.TRANSFORMATION:case x.ModelDirty.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(a,b);case x.ModelDirty.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(a,b)}else V.warn("Attempted to update geometry for nonexistent layer")};e._notifyGraphicGeometryChanged=function(a,b){if(!g.isNone(b.notifyGraphicGeometryChanged))for(const d of a)if(a=d.graphicUid,
g.isSome(a)&&a!==c){b.notifyGraphicGeometryChanged(a);var c=a}};e._notifyGraphicVisibilityChanged=function(a,b){if(!g.isNone(b.notifyGraphicVisibilityChanged))for(const d of a)if(a=d.graphicUid,g.isSome(a)&&a!==c){b.notifyGraphicVisibilityChanged(a);var c=a}};e.updateHighlights=function(a,b){(b=this._layerRenderers.get(b))?b.modify(a,x.ModelDirty.State.HIGHLIGHTS):V.warn("Attempted to update highlights for nonexistent layer")};e.isEmpty=function(){return 0===this._geometries.size&&!P.OVERLAY_DRAW_DEBUG_TEXTURE};
e.updateAnimation=function(a){let b=!1;this._layerRenderers.forEach(c=>b=c.updateAnimation(a)||b);return b};e.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};e.drawTarget=function(a,b,c){const d=a.canvasGeometries;if(0===d.numViews)return!1;this._screenToWorldRatio=c*a.mapUnitsPerPixel;const f=b.renderPass;if(this.isEmpty()||f===C.RenderPass.MATERIAL_HIGHLIGHT&&!this.hasHighlights||f===C.RenderPass.MATERIAL_NORMAL&&!this.hasWater||!a.hasSomeSizedView())return!1;const k=b.fbo;if(!k.isValid())return!1;
const l=2*a.resolution,q=a.resolution;k.resize(l,q);const u=this._rctx;t.pixelRatio=a.pixelRatio*c;this._renderContext.pass=f;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio;this._bindParameters.slot=f===C.RenderPass.MATERIAL_NORMAL?K.RenderSlot.DRAPED_WATER:K.RenderSlot.DRAPED_MATERIAL;a.applyViewport(this._rctx);k.bind(u);a.index===z.OverlayIndex.INNER&&(u.setClearColor(0,0,0,0),u.clearSafe(r.ClearBufferBit.COLOR_BUFFER_BIT));
const A=b.type===z.RenderTargetType.ColorNoRasterImage?h.DrawPassOption.ExcludeRasterImage:b.type===z.RenderTargetType.Occluded?h.DrawPassOption.OccludedOnly:h.DrawPassOption.Normal;A===h.DrawPassOption.OccludedOnly&&(this._renderContext.renderOccludedMask=M);if(P.OVERLAY_DRAW_DEBUG_TEXTURE&&A!==h.DrawPassOption.OccludedOnly)for(b=0;b<d.numViews;b++)this._setViewParameters(d.extents[b],a,t),this._drawDebugTexture(a.resolution,Aa[a.index]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forAll(({overlayLayer:y,
renderer:Ba})=>{if(A!==h.DrawPassOption.ExcludeRasterImage||y.drapeSourceType!==B.DrapeSourceType.RasterImage){({fullOpacity:y}=y);var W=g.isSome(y)&&1>y&&f===C.RenderPass.MATERIAL;W&&(this.bindTemporaryFramebuffer(this._rctx,l,q),u.clearSafe(r.ClearBufferBit.COLOR_BUFFER_BIT));for(let N=0;N<d.numViews;N++)this._setViewParameters(d.extents[N],a,t),Ba.render(this._renderContext,this._bindParameters);W&&g.isSome(this._temporaryFBO)&&(k.bind(u),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),
wa.AlphaMode.PremultipliedAlpha,y,va.CompositingFunction.OverlayWithTransparency,a.index))}});u.bindFramebuffer(null);k.generateMipMap();this._renderContext.resetRenderOccludedMask();return!0};e.bindTemporaryFramebuffer=function(a,b,c){g.isNone(this._temporaryFBO)&&(this._temporaryFBO=new ia.OverlayFramebufferObject(a,!1));this._temporaryFBO.resize(b,c);this._temporaryFBO.bind(a)};e.reloadShaders=function(){var a=F._asyncToGenerator(function*(){yield this._shaderTechniqueRepository.reloadAll()});
return function(){return a.apply(this,arguments)}}();e.intersect=function(a,b,c,d){let f=0;this._geometries.forEach(k=>{if(!d||d(k)){this._intersectRenderGeometry(k,c,b,0,a,f);var l=this.longitudeCyclical;l&&(k.boundingSphere[0]-k.boundingSphere[3]<l.min&&this._intersectRenderGeometry(k,c,b,l.range,a,f),k.boundingSphere[0]+k.boundingSphere[3]>l.max&&this._intersectRenderGeometry(k,c,b,-l.range,a,f));f++}})};e._intersectRenderGeometry=function(a,b,c,d,f,k){if(a.instanceParameters.visible){var l=0;
g.isSome(a.transformation)&&(d+=a.transformation[12],l=a.transformation[13]);D[0]=c[0]-d;D[1]=c[1]-l;D[2]=1;E[0]=c[0]-d;E[1]=c[1]-l;E[2]=0;a.screenToWorldRatio=this._screenToWorldRatio;a.material.intersect(a,null,a.getShaderTransformation(),f,D,E,(q,u,A)=>{za(b,A,a.material.renderPriority,k,f,a.layerUid,a.graphicUid)},a.calculateShaderTransformation,b)}};e._ensureLayerRenderer=function(a,b){let c=this._layerRenderers.get(a);c&&b===c instanceof S.DrapedHeatmapRenderer||(c=b?new S.DrapedHeatmapRenderer({rctx:this._rctx,
materialRepository:this._materialRepository}):new ra.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(a,c),this._sortedLayerRenderersDirty=!0,"fullOpacity"in a&&this._handles.add(a.watch("fullOpacity",()=>this.events.emit("content-changed")),a),this._handles.add(G.init(c,"updating",()=>this.notifyChange("updating")),a));return c};e._updateSortedLayerRenderers=function(){if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=
!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var a=this.view.map.allLayers;this._layerRenderers.forEach((b,c)=>{const d=a.indexOf(c.layer);this._sortedLayerRenderers.push(new Ca(c,b,0>d?Infinity:d))});this._sortedLayerRenderers.sort((b,c)=>b.index-c.index)}};e._setViewParameters=function(a,b,c){c.viewport[0]=c.viewport[1]=0;c.viewport[2]=c.viewport[3]=b.resolution;O.ortho(c.projectionMatrix,0,a[2]-a[0],0,a[3]-a[1],c.near,c.far);O.fromTranslation(c.viewMatrix,[-a[0],-a[1],
0]);this._renderContext.camera=c;this._bindParameters.camera=c;this._bindParameters.inverseViewport[0]=1/c.fullViewport[2];this._bindParameters.inverseViewport[1]=1/c.fullViewport[3]};e._updateHasWater=function(){const a=v.someMap(this._layerRenderers,b=>b.hasWater);a!==this._hasWater&&(this._hasWater=a,this.events.emit("has-water",a))};e._updateHasHighlights=function(){const a=v.someMap(this._layerRenderers,b=>b.hasHighlights);a!==this._hasHighlights&&(this._hasHighlights=a,this.events.emit("has-highlights",
a))};e._updateRendersOccluded=function(){const a=v.someMap(this._layerRenderers,b=>b.rendersOccluded);a!==this._rendersOccluded&&(this._rendersOccluded=a,this.events.emit("renders-occluded",a))};e._drawDebugTexture=function(a,b){this._ensureDebugPatternResources(a,a);a=this._rctx;const c=a.useTechnique(this._debugTextureTechnique);c.setUniform4f("uColor",b[0],b[1],b[2],1);c.bindTexture(this._debugPatternTexture,"tex");a.bindVAO(this._quadVAO);a.drawArrays(r.PrimitiveType.TRIANGLE_STRIP,0,ya.vertexCount(this._quadVAO,
"geometry"))};e._ensureDebugPatternResources=function(a,b){if(!this._debugPatternTexture){var c=new Uint8Array(a*b*4),d=0;for(let f=0;f<b;f++)for(let k=0;k<a;k++){const l=Math.floor(k/10),q=Math.floor(f/10);2>l||2>q||10*l>a-20||10*q>b-20?(c[d++]=255,c[d++]=255,c[d++]=255,c[d++]=255):(c[d++]=255,c[d++]=255,c[d++]=255,l&1&&q&1?c[d++]=k&1^f&1?0:255:c[d++]=l&1^q&1?0:128)}this._debugPatternTexture=new xa.Texture(this._rctx,{target:r.TextureType.TEXTURE_2D,pixelFormat:r.PixelFormat.RGBA,dataType:r.PixelType.UNSIGNED_BYTE,
samplingMode:r.TextureSamplingMode.NEAREST,width:a,height:b},c);a=new U.TextureTechniqueConfiguration;a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(U.TextureTechnique,a);this._quadVAO=T.createQuadVAO(this._rctx)}};F._createClass(n,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||this._frameTask.updating||v.someMap(this._layerRenderers,a=>a.updating)}},{key:"hasOverlays",get:function(){return g.isSome(this._overlays)&&g.isSome(this._overlayRenderTarget)}},
{key:"gpuMemoryUsage",get:function(){return g.isSome(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return g.unwrapOr(this._overlays,[])}},{key:"running",get:function(){return this.updating}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]);
return n}(I.AutoDisposableMixin(X));p.__decorate([w.property()],h.OverlayRenderer.prototype,"_frameTask",void 0);p.__decorate([w.property()],h.OverlayRenderer.prototype,"_sortedLayerRenderersDirty",void 0);p.__decorate([I.autoDispose()],h.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0);p.__decorate([I.autoDispose()],h.OverlayRenderer.prototype,"_stippleTextureRepository",void 0);p.__decorate([w.property({constructOnly:!0})],h.OverlayRenderer.prototype,"view",void 0);p.__decorate([w.property()],
h.OverlayRenderer.prototype,"worldToPCSRatio",void 0);p.__decorate([w.property()],h.OverlayRenderer.prototype,"spatialReference",void 0);p.__decorate([w.property({type:Boolean,readOnly:!0})],h.OverlayRenderer.prototype,"updating",null);h.OverlayRenderer=p.__decorate([da.subclass("esri.views.3d.terrain.OverlayRenderer")],h.OverlayRenderer);h.DrawPassOption=void 0;(function(m){m[m.Normal=0]="Normal";m[m.OccludedOnly=1]="OccludedOnly";m[m.ExcludeRasterImage=2]="ExcludeRasterImage"})(h.DrawPassOption||
(h.DrawPassOption={}));let Ca=function(m,n,e){this.overlayLayer=m;this.renderer=n;this.index=e};const Aa=[[1,.5,.5],[.5,.5,1]],t=new la.default;t.near=1;t.far=1E4;t.relativeElevation=null;const D=H.create(),E=H.create(),M=pa.RenderOccludedFlag.OccludeAndTransparent;h.DRAPED_Z=-2;h.overlayRenderOccludedFlag=M;Object.defineProperty(h,"__esModule",{value:!0})});