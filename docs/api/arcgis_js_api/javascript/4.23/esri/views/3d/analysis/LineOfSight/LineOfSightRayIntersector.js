// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/maybe ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../../layers/graphics/dehydratedFeatures ./LineOfSightIntersectionResult ../../layers/i3s/Intersector ../../support/geometryUtils/ray ../../terrain/Intersector ../../terrain/tileUtils ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtilsConversions".split(" "),
function(h,y,q,z,n,A,w,M,N,O,B,k,p,l,C,D,r,E,F,G,H,I,g,J){h.LineOfSightRayIntersector=function(x){function t(a){return x.call(this,a)||this}y._inheritsLoose(t,x);var m=t.prototype;m.initialize=function(){this.intersector=I.newIntersector(this.view.state.viewingMode);this.intersector.options.hud=!1;this.intersector.options.store=g.StoreResults.MIN};m.getScreenPointIntersection=function(a){a=A.screenPointObjectToArray(a,C.sv2d.get());a=F.fromScreen(this.view.state.camera,a,u);return this._getRayIntersection(a)};
m._getRayIntersection=function(a){if(n.isNone(a))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(a,this.intersector);var b=this.intersector.results.min;if(!b.getIntersectionPoint(v))return null;const f=this.view.renderCoordsHelper.fromRenderCoords(v,this.view.spatialReference),d=p.fromArray(b.normal);var c=0<k.dot(d,a.direction)?-1:1;k.scale(d,d,c);if(E.isI3sIntersectorResult(b))return new r.LineOfSightIntersectionResult({type:g.IntersectorType.OBJECT,id:`${b.target.layerUid}/${b.target.nodeIndex}/${b.target.componentIndex}`,
point:f,normal:d,ray:l.copy(a)});if(G.isTerrainIntersectorResult(b))return new r.LineOfSightIntersectionResult({type:g.IntersectorType.TERRAIN,id:b.target.lij.slice(),point:f,normal:d,ray:l.copy(a)});c=J.toGraphic(b,this.view);if(n.isSome(c)){b=c.layer;const e=c.sourceLayer;if(e)switch(e.type){case "scene":c=D.getObjectId(c,e.objectIdField);break;default:c=c.uid}else c=c.uid;return new r.LineOfSightIntersectionResult({type:g.IntersectorType.OBJECT,id:`${b.uid}/${c}`,point:f,normal:d,ray:l.copy(a)})}return null};
m._canUpdateFromIntersectionResult=function(a,b){if(n.isNone(a)||!b||a.type!==b.type)return!1;switch(a.type){case g.IntersectorType.TERRAIN:return a=a.id,b=b.id,a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]||H.tilesAreRelated(a,b);case g.IntersectorType.OBJECT:case g.IntersectorType.I3S:return a.id===b.id}};m.updateFromIntersectionResult=function(a){if(a.type===g.IntersectorType.TERRAIN&&n.isSome(a.point)){var b=v;const c=K,e=L;this.view.renderCoordsHelper.toRenderCoords(a.point,c);this.view.renderCoordsHelper.worldUpAtPosition(c,
e);var f=this.view.basemapTerrain.elevationBounds,d=this.view.renderCoordsHelper.getAltitude(c);f=f?Math.abs(f.max-f.min)/Math.abs(d):100;d=0<d?1:-1;k.normalize(e,e);k.scale(e,e,d*f);k.add(b,c,e);l.fromPoints(b,c,u);b=this._getRayIntersection(u)}else b=this._getRayIntersection(a.ray);return this._canUpdateFromIntersectionResult(b,a)?b.point:null};return t}(z);q.__decorate([w.property()],h.LineOfSightRayIntersector.prototype,"view",void 0);q.__decorate([w.property()],h.LineOfSightRayIntersector.prototype,
"intersector",void 0);h.LineOfSightRayIntersector=q.__decorate([B.subclass("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],h.LineOfSightRayIntersector);const v=p.create(),K=p.create(),L=p.create(),u=l.create();Object.defineProperty(h,"__esModule",{value:!0})});