// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../ViewingMode ./Camera ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(na,U,N,oa,F,
H,d,p,I,R,Y,Z,pa,qa,t,u,ra,S,sa){function x(D,l){d.set(aa,D[l],D[l+3]);return aa}let ta=function(){this.camera=new qa.default;this.lightMat=H.create()},va=function(){function D(a,b,e=0){this.rctx=a;this.viewingMode=b;this._enabled=!1;this._snapshots=[];this.maxTextureSize=this.textureSize=0;this.numCascades=1;this.maxNumCascades=4;this.splitSchemeLambda=0;this.warp=!0;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(a=0;4>a;++a)this.cascades.push(new ta);
this.snapshotCount=e}var l=D.prototype;l.dispose=function(){this._discardDepthTexture();this._discardAllSnapshots()};l.getSnapshot=function(a){return this.enabled?this._snapshots[a]:null};l.getCascades=function(){for(let a=0;a<this.numCascades;++a)V[a]=this.cascades[a];V.length=this.numCascades;return V};l.start=function(a,b,e){t.assert(this.enabled);this.textureSize=this._computeTextureSize(a.fullWidth,a.fullHeight);this._ensureDepthTexture();const {near:f,far:g}=this._clampNearFar(e);this._computeCascadeDistances(g,
f);this._setupMatrices(a,b);e=a.viewMatrix;a=a.projectionMatrix;for(let k=0;k<this.numCascades;++k)this._constructCascade(k,a,e,b);this.lastOrigin=null;this.clear()};l.finish=function(a){t.assert(this.enabled);this.rctx.bindFramebuffer(a)};l.bind=function(a){this.enabled?(this._depthTextureUnit=a.bindTexture(this._depthTexture,"shadowMapTex"),a.setUniform1f("depthHalfPixelSz",.5/this.textureSize),a.setUniform1i("numCascades",this.numCascades),a.setUniform4f("cascadeDistances",this.cascadeDistances[0],
1<this.numCascades?this.cascadeDistances[1]:Infinity,2<this.numCascades?this.cascadeDistances[2]:Infinity,3<this.numCascades?this.cascadeDistances[3]:Infinity)):a.setUniform1f("depthHalfPixelSz",-1)};l.bindView=function(a,b){if(this.enabled){var e=this.lastOrigin;if(!e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2])for(this.lastOrigin=this.lastOrigin||R.create(),I.copy(this.lastOrigin,b),e=0;e<this.numCascades;++e){F.translate(ba,this.cascades[e].lightMat,b);for(let f=0;16>f;++f)ca[16*e+f]=ba[f]}a.setUniformMatrix4fv("shadowMapMatrix",
ca)}};l.takeCascadeSnapshotTo=function(a,b){t.assert(this.enabled);this._ensureSnapshot(b);this._bindFbo();const e=this.rctx;b=e.bindTexture(this._snapshots[b],S.Texture.TEXTURE_UNIT_FOR_UPDATES);e.gl.copyTexSubImage2D(u.TextureType.TEXTURE_2D,0,a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[2],a.camera.viewport[3]);e.bindTexture(b,S.Texture.TEXTURE_UNIT_FOR_UPDATES)};l.clear=function(){const a=this.rctx;this._bindFbo();a.setClearColor(1,1,1,
1);a.clearSafe(u.ClearBufferBit.COLOR_BUFFER_BIT|u.ClearBufferBit.DEPTH_BUFFER_BIT)};l._computeTextureSize=function(a,b){return Math.min(this.maxTextureSize,2*2**Math.round(.5*Math.log(a*a+b*b)*Math.LOG2E+.35))};l._ensureDepthTexture=function(){if(null==this._depthTexture||this._depthTexture.descriptor.width!==this.textureSize)this._discardDepthTexture(),this._depthTexture=new S.Texture(this.rctx,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,
samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize}),this.fbo=new ra.FramebufferObject(this.rctx,{colorTarget:u.TargetType.TEXTURE,depthStencilTarget:u.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this.textureSize,height:this.textureSize},this._depthTexture)};l._ensureSnapshot=function(a){const b=this._snapshots[a];N.isSome(b)&&b.descriptor.width===this.textureSize||(this._discardSnapshot(a),this._snapshots[a]=new S.Texture(this.rctx,{target:u.TextureType.TEXTURE_2D,
pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize}))};l._discardDepthTexture=function(){this.fbo=N.disposeMaybe(this.fbo);this._depthTexture=N.disposeMaybe(this._depthTexture)};l._discardSnapshot=function(a){this._snapshots[a]=N.disposeMaybe(this._snapshots[a])};l._discardAllSnapshots=function(){for(let a=0;a<this.snapshotCount;++a)this._discardSnapshot(a)};
l._bindFbo=function(){const a=this.rctx;N.isSome(this._depthTextureUnit)&&(a.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null);a.bindFramebuffer(this.fbo)};l._constructCascade=function(a,b,e,f){const g=this.cascades[a];var k=-this.cascadeDistances[a],h=-this.cascadeDistances[a+1];k=(b[10]*k+b[14])/Math.abs(b[11]*k+b[15]);b=(b[10]*h+b[14])/Math.abs(b[11]*h+b[15]);t.assert(k<b);for(h=0;8>h;++h){Y.set(da,0===h%4||3===h%4?-1:1,0===h%4||1===h%4?-1:1,4>h?k:b,1);Y.transformMat4(v[h],
da,ea);for(let q=0;3>q;++q)v[h][q]/=v[h][3]}I.negate(W,v[0]);F.translate(fa,ha,W);g.camera.viewMatrix=fa;for(k=0;8>k;++k)I.transformMat4(v[k],v[k],g.camera.viewMatrix);I.copy(A,v[0]);I.copy(B,v[0]);for(k=1;8>k;++k)for(b=0;3>b;++b)A[b]=Math.min(A[b],v[k][b]),B[b]=Math.max(B[b],v[k][b]);A[2]-=200;B[2]+=200;g.camera.near=-B[2];g.camera.far=-A[2];this.warp?this._constructTrapezoidalProjection(e,f,g):this._constructOrthogonalProjection(g);F.multiply(g.lightMat,g.camera.projectionMatrix,g.camera.viewMatrix);
e=this.textureSize/2;g.camera.viewport[0]=0===a%2?0:e;g.camera.viewport[1]=0===Math.floor(a/2)?0:e;g.camera.viewport[2]=e;g.camera.viewport[3]=e};l._constructOrthogonalProjection=function(a){F.ortho(a.camera.projectionMatrix,A[0],B[0],A[1],B[1],a.camera.near,a.camera.far)};l._constructTrapezoidalProjection=function(a,b,e){var f=1/v[0][3],g=1/v[4][3];t.assert(f<g);f+=Math.sqrt(f*g);var k=Math.sin(U.acosClamped(a[2]*b[0]+a[6]*b[1]+a[10]*b[2]));a=v;var h=f/k;b=ia;var q=ja,m=ua;g=ka;f=la;d.set(y,0,0);
for(var r=0;4>r;++r)d.add(y,y,a[r]);d.scale(y,y,.25);d.set(J,0,0);for(r=4;8>r;++r)d.add(J,J,a[r]);d.scale(J,J,.25);d.lerp(G[0],a[4],a[5],.5);d.lerp(G[1],a[5],a[6],.5);d.lerp(G[2],a[6],a[7],.5);d.lerp(G[3],a[7],a[4],.5);r=0;var C=d.squaredDistance(G[0],y);for(var z=1;4>z;++z){var K=d.squaredDistance(G[z],y);K<C&&(C=K,r=z)}d.subtract(n,G[r],a[r+4]);r=n[0];n[0]=-n[1];n[1]=r;d.subtract(X,J,y);0>d.dot(X,n)&&d.negate(n,n);d.lerp(n,n,X,k);d.normalize(n,n);k=r=d.dot(d.subtract(E,a[0],y),n);for(C=1;8>C;++C)z=
d.dot(d.subtract(E,a[C],y),n),z<k?k=z:z>r&&(r=z);d.copy(b,y);d.scale(E,n,k-h);d.add(b,b,E);z=-1;K=1;h=C=0;for(let O=0;8>O;++O){d.subtract(P,a[O],b);d.normalize(P,P);const Q=n[0]*P[1]-n[1]*P[0];0<Q?Q>z&&(z=Q,C=O):Q<K&&(K=Q,h=O)}t.verify(0<z,"leftArea");t.verify(0>K,"rightArea");d.scale(L,n,k);d.add(L,L,y);d.scale(M,n,r);d.add(M,M,y);T[0]=-n[1];T[1]=n[0];q=t.rayRay2D(b,a[h],M,d.add(E,M,T),1,q);m=t.rayRay2D(b,a[C],M,E,1,m);g=t.rayRay2D(b,a[C],L,d.add(E,L,T),1,g);a=t.rayRay2D(b,a[h],L,E,1,f);t.verify(q,
"rayRay");t.verify(m,"rayRay");t.verify(g,"rayRay");t.verify(a,"rayRay");m=ia;a=ja;b=ka;g=la;f=e.camera.projectionMatrix;d.subtract(w,b,g);d.scale(w,w,.5);c[0]=w[0];c[1]=w[1];c[2]=0;c[3]=w[1];c[4]=-w[0];c[5]=0;c[6]=w[0]*w[0]+w[1]*w[1];c[7]=w[0]*w[1]-w[1]*w[0];c[8]=1;c[6]=-d.dot(x(c,0),m);c[7]=-d.dot(x(c,1),m);m=d.dot(x(c,0),b)+c[6];q=d.dot(x(c,1),b)+c[7];h=d.dot(x(c,0),g)+c[6];g=d.dot(x(c,1),g)+c[7];m=-(m+h)/(q+g);c[0]+=c[1]*m;c[3]+=c[4]*m;c[6]+=c[7]*m;m=1/(d.dot(x(c,0),b)+c[6]);q=1/(d.dot(x(c,1),
b)+c[7]);c[0]*=m;c[3]*=m;c[6]*=m;c[1]*=q;c[4]*=q;c[7]*=q;c[2]=c[1];c[5]=c[4];c[8]=c[7];c[7]+=1;m=d.dot(x(c,1),a)+c[7];q=d.dot(x(c,2),a)+c[8];h=d.dot(x(c,1),b)+c[7];g=d.dot(x(c,2),b)+c[8];m=-.5*(m/q+h/g);c[1]+=c[2]*m;c[4]+=c[5]*m;c[7]+=c[8]*m;m=d.dot(x(c,1),a)+c[7];q=d.dot(x(c,2),a)+c[8];h=-q/m;c[1]*=h;c[4]*=h;c[7]*=h;f[0]=c[0];f[1]=c[1];f[2]=0;f[3]=c[2];f[4]=c[3];f[5]=c[4];f[6]=0;f[7]=c[5];f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=c[6];f[13]=c[7];f[14]=0;f[15]=c[8];e.camera.projectionMatrix[10]=2/(A[2]-
B[2]);e.camera.projectionMatrix[14]=-(A[2]+B[2])/(A[2]-B[2])};l._setupMatrices=function(a,b){F.multiply(ma,a.projectionMatrix,a.viewMatrix);F.invert(ea,ma);a=this.viewingMode===pa.ViewingMode.Global?a.eye:I.set(W,0,0,1);F.lookAt(ha,[0,0,0],[-b[0],-b[1],-b[2]],a)};l._clampNearFar=function(a){let {near:b,far:e}=a;2>b&&(b=2);2>e&&(e=2);b>=e&&(b=2,e=4);return{near:b,far:e}};l._computeCascadeDistances=function(a,b){this.numCascades=Math.min(1+Math.floor(t.logWithBase(a/b,4)),this.maxNumCascades);const e=
(a-b)/this.numCascades;a=(a/b)**(1/this.numCascades);let f=b;for(let g=0;g<this.numCascades+1;++g)this.cascadeDistances[g]=U.lerp(f,b,this.splitSchemeLambda),f*=a,b+=e};na._createClass(D,[{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(a){this.maxNumCascades=U.clamp(Math.floor(a),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a;a||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"snapshotCount",get:function(){return this._snapshots.length},
set:function(a){var b=this._snapshots.length;if(a>b){var e=a-b;this._snapshots.length=a;for(a=0;a<e;++a)this._snapshots[b+a]=null}else if(a<this.snapshotCount){b-=a;for(e=0;e<b;++e)this._discardSnapshot(a+e);this._snapshots.length=a}}},{key:"gpuMemoryUsage",get:function(){var a,b;return this._snapshots.reduce((e,f)=>e+sa.getGpuMemoryUsage(f),null!=(a=null==(b=this.fbo)?void 0:b.gpuMemoryUsage)?a:0)}},{key:"test",get:function(){const a=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,
textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(b){a.splitSchemeLambda=b},get splitSchemeLambda(){return a.splitSchemeLambda},set warp(b){a.warp=b},get warp(){return a.warp}}}}]);return D}();const fa=H.create(),ma=H.create(),ea=H.create(),da=Z.create(),v=[];for(let D=0;8>D;++D)v.push(Z.create());const A=R.create(),B=R.create(),ia=p.create(),ja=p.create(),ua=p.create(),ka=p.create(),la=p.create(),ha=H.create(),W=R.create(),V=[],ba=H.create(),ca=new Float32Array(64),
y=p.create(),J=p.create(),G=[p.create(),p.create(),p.create(),p.create()],n=p.create(),X=p.create(),E=p.create(),P=p.create(),L=p.create(),M=p.create(),T=p.create(),aa=p.create(),w=p.create(),c=oa.create();return va});