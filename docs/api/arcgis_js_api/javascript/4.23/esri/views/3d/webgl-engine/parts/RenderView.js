// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/scheduling ../../../../core/time ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/basicInterfaces ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./requireUtils ./ScreenshotManager ../../../webgl/context-util".split(" "),
function(f,x,g,C,D,y,E,m,F,G,H,q,W,X,I,J,K,l,n,L,M,N,O,P,z,Q,R,S,T,U,V){const A=E.getLogger("esri.views.3d.webgl-engine.parts.View");f.RenderView=function(t){function u(b){var a=t.call(this,{})||this;a.events=new D;a.waterTextureRepository=new S.WaterTextureRepository;a._magnifierHelper=new O.MagnifierHelper;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._lastAnimationUpdate=0;a._container=b.container;a._initializeContext(b);H.init(a.waterTextureRepository,
"loadingState",()=>a.requestRender());a._magnifierHelper.events.on("request-render",()=>a.requestRender());a._stippleTextureRepository=new R.StippleTextureRepository(a._rctx);a._shaderTechniqueRepository=new K.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});a._textureRepository=new Q.TextureRepository(b,a._shaderTechniqueRepository,a._rctx);a._textureRepository.events.on("changed",
c=>a.requestRender(c));a._materialRepository=new N.GLMaterialRepository(a._textureRepository,a._shaderTechniqueRepository,()=>a.requestRender(),()=>a.requestRender());a._compositingHelper=new L(a._rctx,a._shaderTechniqueRepository);a._renderer=new P.Renderer(a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,c=>a.requestRender(c),(c,e)=>b.schedule(c,e),b);a._screenshotManager=new U.ScreenshotManager(a._rctx,(c,e,d)=>a._renderer.render(c,
e,e,d),c=>a.requestRender(c),b.options.screenshot.renderOverlay,c=>a.events.emit("force-camera-for-screenshot",c),()=>a._renderer.disposeOffscreenBuffers());a._registerFrameTask(b);return a}x._inheritsLoose(u,t);var h=u.prototype;h.normalizeCtorArgs=function(){return{}};h.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=m.removeMaybe(this._frameTask);this._shaderTechniqueRepository=m.disposeMaybe(this._shaderTechniqueRepository);
t.prototype.dispose.call(this);this._rctx=this._tmpDepthBuffer=null};h.requestRender=function(b=n.RenderRequestType.UPDATE){b===n.RenderRequestType.UPDATE?this._needsUpdate=!0:this._needsRender=!0};h.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};h.updateLightSources=function(b,a,c){this._renderer.updateLightSources(b,a,c);this.requestRender()};h.setRenderParameters=function(b){void 0!==b.idleSuspend&&this._idleSuspend!==!!b.idleSuspend&&(this._idleSuspend=!!b.idleSuspend,this.requestRender());
this._renderer.setRenderParameters(b)};h.modify=function(b){this._renderer.modify(b);b.clear()};h.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b)};h.readAccumulatedShadow=function(b){return this._renderer.readAccumulatedShadow(b[0],b[1])};h.getMinimalDepthForArea=function(b,a,c,e,d,k=d){k=e.constrainWindowSize(a,c,d*e.pixelRatio,k*e.pixelRatio);const p=this._ensureDepthBuffer(k);this._renderer.readDepthPixels(e,k[0],k[1],k[2],k[3],p);d=Number.MAX_VALUE;for(let r=0;r<k[2]*
k[3];r++){const v=M.textureToDepth(4*r,p,e.nearFar);d>v&&v!==e.nearFar[0]&&v!==e.nearFar[1]&&(d=v)}m.isSome(b)&&(b=b.pickDepth(a*e.pixelRatio,c*e.pixelRatio,e),m.isSome(b)&&d>b&&b!==e.nearFar[0]&&b!==e.nearFar[1]&&(d=b));return d===Number.MAX_VALUE?void 0:d};h._ensureDepthBuffer=function(b){b=4*b[2]*b[3];if(m.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};h.reloadShaders=function(){var b=x._asyncToGenerator(function*(){T.removeLoadedShaderModules();
yield this._shaderTechniqueRepository.reloadAll();this.requestRender()});return function(){return b.apply(this,arguments)}}();h._registerFrameTask=function(b){const a=b.state,c={viewCamera:a.camera,frameHasDecorations:!1};let e=!1,d=n.RenderRequestType.BACKGROUND,k=!1;this._frameTask=F.addFrameTask({preRender:p=>{e=this.updating;d=this._needsUpdate?n.RenderRequestType.UPDATE:n.RenderRequestType.BACKGROUND;b.processSyncLayers();const r=G.Milliseconds(p.time-this._lastAnimationUpdate);if(r>this.animationTimestep||
m.isSome(this.forcedAnimationTime)||e||this._needsRender)this._renderer.updateAnimation({camera:a.camera,dt:r,forcedTime:this.forcedAnimationTime})&&this.requestRender(n.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=p.time},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&0<a.camera.fullHeight){const p=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsWaterReflectionUpdate=
this._needsUpdate=this._needsRender=!1;this._renderer.render(null,a.camera,a.contentCamera,n.Decorations.ON);k=!0;p&&this._renderer.hasWaterReflection&&(this.requestRender(n.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:()=>{c.viewCamera=a.camera;c.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(c)},finish:()=>{k&&(this._renderer.finish(d),k=!1)}})};h._initializeContext=function(b){const a=
b.options;this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const c=V.createContextOrErrorHTML("3d",this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,powerPreference:"high-performance"});m.isNone(c)?(b=y("esri-force-webgl"),A.error("A WebGL context with the requested version ("+b?b:"automatic) could not be created.")):(this._rctx=
this._newRenderingContext(c,b),this._loadShaderOnlyExtensions(),!a.alpha&&this._rctx.contextAttributes.alpha&&A.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=y("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};h._newRenderingContext=function(b,a){const c={disabledExtensions:a.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.options.debugWebGLExtensions||
{},maxAnisotropy:8},e=(d,k)=>a.resourceController.memoryController.newCache(d,k);if(B.enableContextCache){let d=w.get(b);if(d)return d.configure(c),d.newCache=e,d.ref(),d;d=new z.RenderingContext(b,c,e);w.set(b,d);d.ref();return d}return new z.RenderingContext(b,c,e)};h._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives");this._rctx.capabilities.enable("shaderTextureLOD");this._rctx.capabilities.enable("textureFloat")};x._createClass(u,[{key:"performanceInfo",
get:function(){const b=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?b.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||
this._magnifierHelper.updating}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"hasShadowsEnabled",
get:function(){return this._renderer.hasShadowsEnabled}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"gpuMemoryUsage",get:function(){return this._renderer.gpuMemoryUsage}},{key:"animationTimestep",get:function(){return this._renderer.animationTimestep}},{key:"componentObjectCollection",get:function(){m.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new J.ComponentObjectCollection(this._renderer.renderPassManager));
return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return u}(l.AutoDisposableMixin(C));g.__decorate([q.property({type:Boolean,readOnly:!0})],f.RenderView.prototype,"updating",null);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_rctx",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_container",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_canvas",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_stippleTextureRepository",
void 0);g.__decorate([l.autoDispose(),q.property()],f.RenderView.prototype,"waterTextureRepository",void 0);g.__decorate([l.autoDispose(),q.property()],f.RenderView.prototype,"_magnifierHelper",void 0);g.__decorate([l.autoDispose(),q.property()],f.RenderView.prototype,"_textureRepository",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_compositingHelper",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_renderer",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,
"_screenshotManager",void 0);g.__decorate([l.autoDispose()],f.RenderView.prototype,"componentObjectCollection",null);g.__decorate([l.autoDispose()],f.RenderView.prototype,"_componentObjectCollection",void 0);g.__decorate([q.property()],f.RenderView.prototype,"_needsUpdate",void 0);g.__decorate([q.property()],f.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);f.RenderView=g.__decorate([I.subclass("esri.views.3d.webgl-engine.parts.RenderView")],f.RenderView);const B={enableContextCache:!1,
disposeContextCache:()=>{w.forEach(t=>t.dispose());w.clear()}},w=new Map;f.test=B;Object.defineProperty(f,"__esModule",{value:!0})});