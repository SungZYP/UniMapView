// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/ray ../../../ViewingMode ./IntersectorInterfaces ./intersectorUtils ./verticalOffsetUtils ../materials/renderers/utils".split(" "),function(w,D,e,H,E,f,q,K,L,h,I,k,M,F,N){function J(d){return new t(d)}let Q=function(){function d(a){this.options=
new k.IntersectorOptions;this._results=new O;this.transform=new F.IntersectorTransform;this.tolerance=1E-5;this.verticalOffset=null;this._ray=h.create();this._rayEnd=q.create();this._rayBeginTransformed=q.create();this._rayEndTransformed=q.create();this.viewingMode=null==a?I.ViewingMode.Global:a}var c=d.prototype;c.reset=function(a,b,n){this.resetWithRay(h.fromPoints(a,b,this._ray),n)};c.resetWithRay=function(a,b){this.camera=b;a!==this._ray&&h.copy(a,this._ray);0!==this.options.verticalOffset?this.viewingMode===
I.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null;f.add(this._rayEnd,this._ray.origin,this._ray.direction);this._results.init(this._ray)};c.intersect=function(a=null,b,n,r,p){this.point=b;this.filterPredicate=r;this.tolerance=null==n?1E-5:n;b=F.getVerticalOffsetObject3D(this.verticalOffset);if(e.isSome(a)&&0<a.length){const l=p?g=>{p(g)&&this.intersectObject(g)}:g=>{this.intersectObject(g)};for(const g of a)a=
g.getSpatialQueryAccelerator&&g.getSpatialQueryAccelerator(),e.isSome(a)?(e.isSome(b)?a.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,l,b):a.forEachAlongRay(this._ray.origin,this._ray.direction,l),this.options.selectionMode&&this.options.hud&&a.forEachDegenerateObject(l)):g.objects.forAll(x=>l(x))}this.sortResults()};c.intersectObject=function(a){const b=a.geometryRecords;if(b){var n=a.transformation,r=F.getVerticalOffsetObject3D(this.verticalOffset);for(const p of b){const {geometry:l,
material:g,instanceParameters:x}=p;if(N.isInstanceHidden(x))continue;const y=l.id;this.transform.setAndInvalidateLazyTransforms(n,p.getShaderTransformation());f.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse);f.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const G=this.transform.transform;e.isSome(r)&&(r.objectTransform=this.transform);g.intersect(l,x,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(m,z,A,B,
u,P)=>{0<=m&&(!e.isSome(this.filterPredicate)||this.filterPredicate(this._ray.origin,this._rayEnd,m))&&(B?(null==this._results.hud.dist||m<this._results.hud.dist)&&this._results.hud.set(k.IntersectorType.HUD,{object:a,geometryId:y,triangleNr:A,center:P},m,z,E.IDENTITY,u):((null==this._results.min.drapedLayerOrder||u>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||m<this._results.min.dist)&&this._results.min.set(k.IntersectorType.OBJECT,{object:a,geometryId:y,triangleNr:A},m,z,
G,u),this.options.store!==k.StoreResults.MIN&&(null==this._results.max.drapedLayerOrder||u<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||m>this._results.max.dist)&&this._results.max.set(k.IntersectorType.OBJECT,{object:a,geometryId:y,triangleNr:A},m,z,G,u),this.options.store===k.StoreResults.ALL&&(B=J(this._ray),B.set(k.IntersectorType.OBJECT,{object:a,geometryId:y,triangleNr:A},m,z,G),this._results.all.push(B))))},p.shaderTransformation)}}};c.sortResults=function(){this._results.all.sort((a,
b)=>a.dist!==b.dist?e.unwrapOr(a.dist,0)-e.unwrapOr(b.dist,0):a.drapedLayerOrder!==b.drapedLayerOrder?e.unwrapOr(a.drapedLayerOrder,Number.MAX_VALUE)-e.unwrapOr(b.drapedLayerOrder,Number.MAX_VALUE):e.unwrapOr(b.drapedLayerGraphicOrder,Number.MIN_VALUE)-e.unwrapOr(a.drapedLayerGraphicOrder,Number.MIN_VALUE))};D._createClass(d,[{key:"results",get:function(){return this._results}},{key:"ray",get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}}]);
return d}(),O=function(){function d(){this._min=new t(h.create());this._max=new t(h.create());this._hud=new t(h.create());this._ground=new t(h.create())}d.prototype.init=function(c){this._min.init(c);this._max.init(c);this._hud.init(c);this._ground.init(c);this.all=[]};D._createClass(d,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}},{key:"hud",get:function(){return this._hud}},{key:"ground",get:function(){return this._ground}}]);return d}(),t=function(){function d(a){this.intersector=
k.IntersectorType.OBJECT;this.normal=q.create();this.transformation=E.create();this._ray=h.create();this.init(a)}var c=d.prototype;c.getIntersectionPoint=function(a){if(!M.isValidIntersectorResult(this))return!1;f.scale(C,this.ray.direction,this.dist);f.add(a,this.ray.origin,C);return!0};c.getTransformedNormal=function(a){f.copy(v,this.normal);v[3]=0;K.transformMat4(v,v,this.transformation);f.copy(a,v);return f.normalize(a,a)};c.init=function(a){this.drapedLayerGraphicOrder=this.drapedLayerOrder=
this.target=this.dist=null;this.intersector=k.IntersectorType.OBJECT;h.copy(a,this._ray)};c.set=function(a,b,n,r,p,l,g){this.intersector=a;this.dist=n;f.copy(this.normal,e.unwrapOr(r,q.UNIT_Z));H.copy(this.transformation,e.unwrapOr(p,E.IDENTITY));this.target=b;this.drapedLayerOrder=l;this.drapedLayerGraphicOrder=g};c.copy=function(a){h.copy(a.ray,this._ray);this.intersector=a.intersector;this.dist=a.dist;this.target=a.target;this.drapedLayerOrder=a.drapedLayerOrder;this.drapedLayerGraphicOrder=a.drapedLayerGraphicOrder;
f.copy(this.normal,a.normal);H.copy(this.transformation,a.transformation)};D._createClass(d,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return e.isSome(this.dist)?(f.scale(C,this.ray.direction,this.dist),f.length(C)):null}}]);return d}();const C=q.create(),v=L.create();w.DEFAULT_TOLERANCE=1E-5;w.newIntersector=function(d){return new Q(d)};w.newIntersectorResult=J;Object.defineProperty(w,"__esModule",{value:!0})});