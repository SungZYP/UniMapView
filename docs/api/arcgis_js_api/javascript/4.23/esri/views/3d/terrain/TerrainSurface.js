// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/aliasOf ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../layers/mixins/RefreshableLayer ../../../layers/support/ElevationQueryTileCache ../../../layers/support/layerUtils ../../../layers/support/LercDecoder ../../2d/engine/vectorTiles/VectorTile ../layers/ElevationLayerView3D ../support/cameraUtils ../support/debugFlags ../support/extentUtils ../support/index ../support/updatingProperties ./ElevationBounds ./ElevationData ./ExtentHelper ./interfaces ./LayerClass ./OverlayManager ./PlanarPatch ./RenderOrder ./SphericalPatch ./TerrainConst ./TerrainRenderer ./TerrainSurfacePerformanceInfo ./terrainUtils ./Tile ./TilePerLayerInfo ./TileUpdate ./tileUtils ./TilingSchemeLogic ./UpsampleInfo ../webgl-engine/lib/basicInterfaces ../../support/Scheduler ../../support/WatchUpdatingTracking".split(" "),
function(da,S,l,ea,k,fa,ha,ia,ja,ka,la,p,I,T,A,U,F,P,Na,Oa,n,ma,na,oa,pa,V,qa,J,ra,w,K,sa,ta,ua,va,wa,xa,W,X,ya,Y,za,Aa,Z,Ba,E,t,Ca,Da,Ea,Fa,z,Ga,Ha,r,aa,Ia,q,G,Ja,Ka,ba,Q,La){function ca(v,B){return v[0]===B[0]&&v[1]===B[1]&&v[2]===B[2]}function H(v){return v.isLeaf?!1:v.children[0].shouldLoad||v.children[1].shouldLoad||v.children[2].shouldLoad||v.children[3].shouldLoad||H(v.children[0])||H(v.children[1])||H(v.children[2])||H(v.children[3])}const x=ka.getLogger("esri.views.3d.terrain.TerrainSurface");
k=function(v){function B(a){var b=v.call(this,a)||this;b._elevationBounds=new Aa.ElevationBounds;b._iteratorPool=new I(G.IteratorPreorder,c=>c.remove=()=>b._iteratorPool.release(c));b._postorderIterator=new G.IteratorPostorder;b._hasPendingUpdates=!1;b._pendingUpdates=0;b._asyncWorkItems=0;b._allTilesDirty=!0;b._allTilesSorted=!0;b._visible=!1;b._usedMemory=-1;b._performanceInfo=new Ha;b._viewChanged=!1;b._inFrameTask=!1;b._viewChangeUpdateDirty=!1;b._eyePosRenderSR=V.create();b._eyePosSurfaceSR=
V.create();b._splitLimits=new aa.SplitLimits;b._snapLevel=Infinity;b._frustum=K.create();b._viewProjectionMatrix=oa.create();b._layerViews=[[],[]];b._layerIndexByUid=[new Map,new Map];b._basemapLayerViewHandles=new Map;b._handles=new ja;b._watchUpdatingTracking=new La.WatchUpdatingTracking;b._frameTask=Q.ImmediateTask;b._allTiles=new T;b._upsampleInfoPool=new I(Ka.UpsampleInfo);b._rootTilesExtent=w.create();b._maxNumUpdating=1;b.maxTextureScale=1.2;b.backgroundImage=z.DEFAULT_TILE_BACKGROUND;b.backgroundColor=
null;b._layerViewsDirty=!1;return b}S._inheritsLoose(B,v);var g=B.prototype;g.initialize=function(){this._lercDecoder=va.acquireDecoder(this.view.resourceController);this._tilePool=this.view.state.isLocal?new I(Da.PlanarPatch):new I(Fa.SphericalPatch);var a=this.view.resourceController.memoryController;this._upsampleMapCache=a.newCache("esri.views.3d.terrain.upsample",b=>b.unloadMapData());this._elevationQueryCache=new ta.ElevationQueryTileCache(a.newCache("elevation-query"));this._set("overlayManager",
new Ca.OverlayManager({surface:this}));this._handles.add([this.watch("overlayManager.hasHighlights",b=>this._renderer.setNeedsHighlight(b)),this.watch("overlayManager.rendersOccluded",b=>this._renderer.setRenderOccludedOverlay(b))],"overlayManager");this._renderer=new Ga({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:ra.getReferenceEllipsoid(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles});this._handles.add([F.init(this,"baseOpacity",b=>{this._handleLayerViewChanges();
this._updateBaseOpacity(b)},!0),F.init(this,"_background",()=>{this._handleLayerViewChanges();this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",b=>{this._renderer.pointsOfInterest=b;this._watchUpdatingTracking.removeAll();b&&this._watchUpdatingTracking.add(()=>b.focus.renderLocation,()=>()=>this._allTilesSorted=!1)}),F.init(X,"TERRAIN_TILE_TREE_SHOW_TILES",b=>{b&&!this._treeDebugger?(new Promise((c,d)=>da(["../layers/support/TerrainTileTree3DDebugger"],c,d))).then(({TerrainTileTree3DDebugger:c})=>
{!this._treeDebugger&&X.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:this.view}))}):b||(this._treeDebugger=p.destroyMaybe(this._treeDebugger))})]);this._extentHelper=Ba.create(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});a=this.view.defaultsFromMap?new ha({getCollections:()=>{var b,c,d;return null==(b=this.view)?void 0:null==(c=b.defaultsFromMap)?void 0:null==(d=c.mapCollections)?void 0:d.map(({layers:e})=>
e)},getChildrenFunction:b=>b&&"layers"in b?b.layers:null}):this.view.map.allLayers;a=new Ja.TilingSchemeLogic({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",a);this._updateTilingScheme();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Y.ClientType.ELEVATION);this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Y.ClientType.BASEMAP);this._frameTask=
this.view.resourceController.scheduler.registerTask(Q.TaskPriority.TERRAIN_SURFACE,this);this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate());this._handles.add([F.init(this._extentHelper,"stencilEnabledExtents",b=>this._renderer.setStencilEnabledLayerExtents(b)),this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingScheme(),!0),F.init(this,"extent",()=>this._updateRootTiles()),this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",
()=>this._viewChangeUpdate(),!0),this.view.watch("state.contentCamera",()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate(),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",()=>this._viewChangeUpdate()),F.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",b=>this._renderer.textureFadingEnabled=0<b),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),U.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),U.sync)]);this._handles.add(this.view.allLayerViews.on("after-changes",
()=>this._layerViewsDirty=!0));this._layerViewsDirty=!0;this._handleLayerViewChanges()};g.destroy=function(){this._frameTask.remove();this._handles.destroy();this._watchUpdatingTracking.destroy();this._lercDecoder=p.releaseMaybe(this._lercDecoder);this._removeAllTiles();this._upsampleMapCache=p.destroyMaybe(this._upsampleMapCache);this._elevationQueryCache=p.destroyMaybe(this._elevationQueryCache);this._set("tilingSchemeLogic",p.destroyMaybe(this.tilingSchemeLogic));this._extentHelper=p.destroyMaybe(this._extentHelper);
this._basemapLayerViewHandles.forEach((a,b)=>this._unregisterTiledLayerView(b));this._mapDataRequester=this._elevationDataRequester=null;this._set("overlayManager",p.destroyMaybe(this.overlayManager));this._tilePool=p.destroyMaybe(this._tilePool);aa.Tile.prune();this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._renderer=p.destroyMaybe(this._renderer);this._iteratorPool=p.destroyMaybe(this._iteratorPool);this._set("view",null);this._upsampleInfoPool=p.destroyMaybe(this._upsampleInfoPool);
wa.printAllocations();Ia.printAllocations()};g.intersect=function(a,b,c,d){this._renderer.intersect(a,b,c,d)};g.getElevation=function(a,b,c,d){a=this.getTileWithElevation(a,b,c,d,y);return p.isNone(a)?null:Z.sampleElevation(y[0],y[1],a.renderData.geometryState.samplerData)};g.getTileWithElevation=function(a,b,c,d,e=y){var f;const h=this.rootTiles;if(p.isNone(h)||!h.length||0===h[0].layerInfo[t.LayerClass.ELEVATION].length)return null;e[0]=a;e[1]=b;e[2]=c;if(!J.projectVectorToVector(e,d,e,null==(f=
this.tilingScheme)?void 0:f.spatialReference))return x.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let m of h)if(m.containsPoint(e)){for(;m&&!m.rendered&&!m.isLeaf;)a=0,e[0]>.5*(m.extent[0]+m.extent[2])&&(a+=1),e[1]<.5*(m.extent[1]+m.extent[3])&&(a+=2),m=m.children[a];if((e=m.renderData)&&e.geometryState.samplerData)return m;break}return null};g.getScale=function(a){if(this.tilingScheme){if(!J.projectPointToVector(a,y,this.spatialReference))return x.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),
null;a=this.rootTiles;if(p.isSome(a))for(let b of a)if(b.containsPoint(y)){for(;null!=b.children[0];)a=0,y[0]>b.children[0].extent[2]&&(a+=1),y[1]<b.children[0].extent[1]&&(a+=2),b=b.children[a];return this._getLodBiasCorrectedScale(b.level)}}return 1E100};g.getSphereScale=function(a,b){if(!this.tilingScheme)return null;if(!J.projectPointToVector(a,y,this.spatialReference))return x.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;y[3]=
b;let c=null;const d=e=>{if(e&&w.intersectsSphere(e.extent,y))if(null!=e.children[0])for(const f of e.children)d(f);else e=this._getLodBiasCorrectedScale(e.level),c=null==c?e:Math.min(c,e)};a=this.rootTiles;if(p.isSome(a))for(const e of a)d(e);return c};g.queryVisibleScaleRange=function(a,b,c,d){b=b?this.tilingScheme.levelAtScale(b):0;c=c?this.tilingScheme.levelAtScale(c):Infinity;const e=this.lodBias;this._renderer.queryVisibleLevelRange(a,b+e,c+e,d)};g._updateBaseOpacity=function(a){const b=this._renderer.opaque;
this._renderer.opaque=1<=a;this._renderer.isTransparent=this._allTransparentSurfaceLayers();a=b===this._renderer.opaque?E.TextureUpdate.UNFADED:E.TextureUpdate.IMMEDIATE;if(a===E.TextureUpdate.IMMEDIATE){var c,d;null==(c=this.view)?void 0:null==(d=c._stage)?void 0:d.renderView.setRenderParameters({opaqueTerrain:this.opaque})}this._updateTileTextures(a)};g._updateTilingScheme=function(){const a=this.tilingSchemeLogic.tilingScheme;a!==this.tilingScheme&&(r.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),
this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference),this._updateRootTiles()))};g._acquireTile=function(a,b,c,d){const e=this._tilePool.acquire();L[0]=a;L[1]=b;L[2]=c;e.init(L,d,this);return e};g._updateRootTiles=function(){const {extent:a,tilingScheme:b}=this;if(b){var c=Ma,d=b.rootTilesInExtent(a,c,5*z.MAX_ROOT_TILES);if(p.isSome(this.rootTiles)){if(d.length>
z.MAX_ROOT_TILES){x.warn(z.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}const e=this.rootTiles.map(h=>h.lij),f=fa.difference(e,d,ca);if(0<f.removed.length||0<f.added.length){const h=this.rootTiles.filter(m=>-1<f.removed.findIndex(u=>ca(u,m.lij))?(this._purgeTile(m),!1):!0);f.added.forEach(m=>h.push(this._newRootTile(m)));this._setRootTiles(h)}}else d.length>z.MAX_ROOT_TILES&&(x.warn(z.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),d=b.rootTilesInExtent(a,c,z.MAX_ROOT_TILES)),this._setRootTiles(d.map(e=>this._newRootTile(e)));
w.equals(c,this._rootTilesExtent)||(this._rootTilesExtent=w.create(c));this.visible=!0;this._viewChangeUpdate();this.overlayManager.setPlacementDirty();this.notifyChange("ready")}};g._newRootTile=function(a){a=this._acquireTile(0,a[1],a[2],null);a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===q.TileUpdate.SPLIT&&a.setPendingUpdate(q.TileUpdate.SPLIT);this._loadTile(a);return a};g._setRootTiles=function(a){this._set("rootTiles",a);this._allTiles.clear();if(p.isSome(a)){const b=
this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());b.remove()}this._renderer.setRootTiles(this.rootTiles);this._updateTilesVisibility(a)};g._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};g._viewChangeUpdate=function(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),
this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))};g._updateClippingStatus=function(a){a.updateClippingStatus(this.extent)&&a.resetPendingUpdate(q.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a)};g._updateTilesVisibility=function(a){if(!p.isNone(a)){var b=G.hasLoadableSiblings(a),c=b?this._elevationBounds.min:Infinity;b=b?this._elevationBounds.max:-Infinity;var d=this.view.state.fixedContentCamera,e=this.extent,f=this._viewProjectionMatrix;this.setTileTreeDirty();var h=this._iteratorPool.acquire();
for(h.reset(a);!h.done;){a=h.next();a.updateClippingStatus(e)&&a.resetPendingUpdate(q.TileUpdate.GEOMETRY)&&this._updateTileGeometry(a);a.setPendingUpdate(q.TileUpdate.RENDERDATA);const m=a.computeVisibility();d||m?(a.updateScreenDepth(f),a.renderData&&(c=Math.min(a.elevationBounds[0],c),b=Math.max(a.elevationBounds[1],b))):h.skipSubtree()}h.remove();this._allTilesDirty=this._viewChanged=!0;isFinite(c)&&isFinite(b)&&(this._elevationBounds.min!==c||this._elevationBounds.max!==b)&&(this._elevationBounds.min=
c,this._elevationBounds.max=b,this.emit("elevation-bounds-change",null))}};g._updateViewDependentParameters=function(){const a=this.view.state.camera,b=this.view.state.contentCamera,c=Math.tan(.5*b.fovX),d=Math.tan(.5*b.fovY),e=this.tilingScheme.pixelSize,f=2**-this.lodBias*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=c;this._splitLimits.fovY=d;this._splitLimits.relativeWidthLimit=e/a.width*this.maxTextureScale*f;this._splitLimits.relativeHeightLimit=e/a.height*
this.maxTextureScale*f;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;this.view.state.fixedContentCamera?(p.isNone(this._splitLimits.frustum)&&(this._splitLimits.frustum=K.create()),K.copy(this._splitLimits.frustum,b.frustum)):this._splitLimits.frustum=null;K.copy(this._frustum,a.frustum);na.multiply(this._viewProjectionMatrix,b.projectionMatrix,b.viewMatrix);pa.copy(this._eyePosRenderSR,b.eye);J.projectVectorToVector(a.eye,
this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};g._updateSkirts=function(){const a=this.view.state.camera;this.skirtScale=r.computeSkirtScale(this,this._eyePosSurfaceSR,this.view.state.constraints.collision.enabled?0:1.11*a.near)};g._updateRenderData=function(a){a.rendered&&!a.shouldLoad&&(H(a)?this._loadChildren(a):a.isLeaf&&a.parent&&a.parent.shouldLoad&&this._loadParent(a))};g._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);
this._elevationUpdate(a);this._usedMemory=-1};g._updateTileTexture=function(a,b){const c=a.resetPendingUpdate(q.TileUpdate.TEXTURE_FADING)?q.TileUpdate.TEXTURE_FADING:a.resetPendingUpdate(q.TileUpdate.TEXTURE_NOFADING)?q.TileUpdate.TEXTURE_NOFADING:!1;c&&(this._renderer.updateTileTexture(a,c),this._usedMemory=-1,b.madeProgress())};g._elevationUpdate=function(a){M.spatialReference=this.spatialReference;M.tile=a;M.extent=a.extent;this.emit("elevation-change",M);w.containsPoint(a.extent,this._eyePosSurfaceSR)&&
this._updateSkirts()};g.runTask=function(a){this._handleLayerViewChanges(a);this._frameTask.processQueue(a);this._inFrameTask=!0;this._pendingUpdates=0;this._hasPendingUpdates=!1;this._updateTileStatus(a);this._sortTiles(a);const b=!this.view.state.fixedContentCamera;this._mergeAndSplit(a,b);a.run(()=>this._updateElevation(a));a.run(()=>this._updateTextures(a));b||this._mergeAndSplit(a,!0);this._inFrameTask=!1;this._runViewChangeUpdateIfDirty();a.done&&this.requestUpdate();this.notifyChange("updatingProgressValue")};
g._updateTileStatus=function(a){if(this._viewChanged&&this.rootTiles&&!a.done){this._viewChanged=!1;var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();if(c.loadable){var d=c.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(d===q.TileUpdate.SPLIT){c.resetPendingUpdate(q.TileUpdate.MERGE);c.isLeaf&&(c.setPendingUpdate(q.TileUpdate.SPLIT),b.skipSubtree());continue}c.resetPendingUpdate(q.TileUpdate.SPLIT)&&c.updateAgentSuspension();d===q.TileUpdate.VSPLITMERGE&&
c.updateAgents(t.LayerClass.ELEVATION)}b.skipSubtree();if(!c.isLeaf){c.setPendingUpdate(q.TileUpdate.MERGE);c.resetPendingUpdate(q.TileUpdate.SPLIT);d=this._iteratorPool.acquire();d.resetOne(c);for(c=d.next();!d.done;c=d.next())this._updateClippingStatus(c),c.updateVisibility(),c.loadable&&c.updateScreenDepth(this._viewProjectionMatrix);d.remove()}}b.remove();this.requestUpdate();a.madeProgress()}};g._sortTiles=function(a){a.done||this._allTilesSorted||(G.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),
this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),a.madeProgress())};g._mergeAndSplit=function(a,b){if(!this.suspended&&!a.done&&this._allTilesDirty){this._allTilesDirty=!1;this.requestUpdate();for(var c=0;!a.done;){let d=!1;c=0;const e=!this._allTiles.some(f=>{c+=f.usedMemory;if(f.resetPendingUpdate(q.TileUpdate.MERGE)){if(!b)return f.setPendingUpdate(q.TileUpdate.MERGE),a.done;this._mergeTile(f);d=!0;a.madeProgress()}else f.resetPendingUpdate(q.TileUpdate.SPLIT)&&(this._splitTile(f),
d=!0,a.madeProgress());!a.done&&f.resetPendingUpdate(q.TileUpdate.RENDERDATA)&&(this._updateRenderData(f),a.madeProgress());return a.done});d&&(this._allTilesSorted=!1,this._allTilesDirty=!0);if(e){this._usedMemory=c;if(!d)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}0===c&&(this._allTilesDirty=!0);this._sortTiles(a)}};g._updateElevation=function(a){this._allTiles.some(b=>{b.resetPendingUpdate(q.TileUpdate.GEOMETRY)&&(this._updateTileGeometry(b),this._updateTileTexture(b,
a),a.madeProgress());return a.done});return a.hasProgressed};g._updateTextures=function(a){this._allTiles.some(b=>{this._updateTileTexture(b,a);return a.done});return a.hasProgressed};g._updateClippingExtent=function(){this.spatialReference&&(this.updateTileOverlayParams(ba.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())};g._getLodBiasCorrectedScale=function(a){const b=this.tilingScheme.levels;a=la.clamp(a-this.lodBias,0,b.length-1);const c=a-Math.floor(a);
return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};g._removeAllTiles=function(){p.isSome(this.rootTiles)&&(this.rootTiles.forEach(a=>this._purgeTile(a)),this._setRootTiles(null),this.notifyChange("ready"));this._allTiles.clear();this.visible=!1};g._purgeChildTiles=function(a){if(a.isLeaf)return!1;let b=this._purgeTile(a.children[0]);b=this._purgeTile(a.children[1])||b;b=this._purgeTile(a.children[2])||b;b=this._purgeTile(a.children[3])||b;a.unsetChildren();return b};g._purgeTile=function(a){const b=
this._purgeChildTiles(a)||a.rendered;this._allTiles.removeUnordered(a);a.unload(this._renderer);this._tilePool.release(a);return b};g._splitTile=function(a){r.weakAssert(a.isLeaf,"tile that is already split should not be split again!");const b=a.level+1,c=2*a.lij[1],d=2*a.lij[2];a.setChildren(this._createTile(b,c,d,a),this._createTile(b,c,d+1,a),this._createTile(b,c+1,d,a),this._createTile(b,c+1,d+1,a));a.setPendingUpdate(q.TileUpdate.RENDERDATA);a.updateAgentSuspension();this._allTiles.pushArray(a.children);
this._allTilesDirty=!0;this._emitTileScaleChange(a,b);++this._performanceInfo.numSplit};g._emitTileScaleChange=function(a,b=a.level){N.spatialReference=this.spatialReference;N.extent=a.extent;N.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",N)};g._createTile=function(a,b,c,d){r.weakAssert(!!d,"_createTile sanity check");a=this._acquireTile(a,b,c,d);a.updateClippingStatus(this.extent);a.loadable&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._splitLimits,this._eyePosRenderSR,
this.lodSnapping)===q.TileUpdate.SPLIT&&a.setPendingUpdate(q.TileUpdate.SPLIT));return a};g._mergeTile=function(a){r.weakAssert(!a.hasPendingUpdate(q.TileUpdate.SPLIT),"_mergeTile sanity check");this._purgeChildTiles(a)&&(r.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a));this._allTilesDirty=!0;++this._performanceInfo.numMerged;this._emitTileScaleChange(a)};g._loadChildren=function(a){r.weakAssert(a.rendered,"parent should be rendered");a.unload(this._renderer);this._loadTile(a.children[0]);
this._loadTile(a.children[1]);this._loadTile(a.children[2]);this._loadTile(a.children[3])};g._loadParent=function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a)};g._unloadChildren=function(a){a.isLeaf||(this._unloadChildren(a.children[0]),a.children[0].unload(this._renderer),this._unloadChildren(a.children[1]),a.children[1].unload(this._renderer),this._unloadChildren(a.children[2]),a.children[2].unload(this._renderer),this._unloadChildren(a.children[3]),a.children[3].unload(this._renderer))};
g._loadTile=function(a){a.load(this._renderer);a.setPendingUpdate(q.TileUpdate.RENDERDATA);this.requestUpdate();this._allTilesDirty=!0;this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(a);this._elevationUpdate(a)};g._elevationDataArrived=function(a,b,c){c=new Z.ElevationData(a.lij,a.extent,c);a.dataArrived(b,t.LayerClass.ELEVATION,c);c=[a];a=a.level;const d=this._iteratorPool.acquire();for(d.reset(c);!d.done;){const e=d.next();e.findElevationBoundsForLayer(b,
a);e.computeElevationBounds()}d.remove();this._updateTilesVisibility(c)};g._handleLayerViewChanges=function(a=Q.noBudget){if(this._layerViewsDirty){var b=this._layerViewsDirty=!1,c=new Set,d=-1;for(const f of this.view.allLayerViews.items)if(c.add(f.uid),r.isSurfaceLayerView(f))if(this._basemapLayerViewHandles.has(f.uid)){var e=this._layerClassFromLayerView(f);e=this._layerIndexByUid[e].get(f.uid);e<d&&(b=!0);d=e}else this._registerTiledLayerView(f),f.layer.loaded&&(b=!0);this._basemapLayerViewHandles.forEach((f,
h)=>{c.has(h)||(this._unregisterTiledLayerView(h),b=!0)});b&&this._updateTiledLayers();this._renderer.isTransparent=this._allTransparentSurfaceLayers();a.madeProgress()}};g._allTransparentSurfaceLayers=function(){var a,b;let c=0===(null==(a=this.view.map)?void 0:null==(b=a.ground)?void 0:b.opacity);for(const d of this.view.allLayerViews.items)if(r.isSurfaceLayerView(d)&&!r.isElevationLayerView(d)&&!ua.isBaseLayer(d.layer)&&0!==d.fullOpacity){c=!1;break}return c};g._layerClassFromLayerView=function(a){return r.isElevationLayerView(a)?
t.LayerClass.ELEVATION:t.LayerClass.MAP};g._registerTiledLayerView=function(a){const b=[],c=this._layerClassFromLayerView(a);b.push(a.watch("suspended",()=>this._updateTiledLayers()));b.push(a.watch("fullOpacity",()=>this._updateTileTextures(E.TextureUpdate.UNFADED)));b.push(a.layer.watch("effectiveScaleRange",()=>this._restartAllAgents(c)));a.on("data-changed",()=>{const d=this._layerIndexByUid[c].get(a.uid);null!=d&&this._invalidateLayerData(d,c)});this._basemapLayerViewHandles.set(a.uid,b)};g._unregisterTiledLayerView=
function(a){const b=this._basemapLayerViewHandles.get(a);if(b){for(let c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};g._updateTiledLayers=function(){if(this.tilingScheme&&!this.view.suspended){var a=this.view.allLayerViews,b=[[],[]],c=null,d=w.empty();a.forEach(f=>{var h=f.layer;if(h&&!f.suspended&&r.isSurfaceLayerView(f)){var m=f.fullExtent;m?(w.expand(d,m,d),h=this._layerClassFromLayerView(f),h===t.LayerClass.MAP&&(m=f.displayLevelRange,Infinity!==m.maxLevel&&(null===
c||m.maxLevel>c)&&(c=m.maxLevel)),b[h].push(f)):x.warn("Terrain: Map or elevation layer does not have fullExtent: "+h.id)}});for(const f of t.LayerClasses){var e=this._layerViews[f];a=b[f];a.reverse();const h=a.length;let m=e.length!==h;const u=Array(h),C=Array(e.length);this._layerIndexByUid[f].clear();for(let D=0;D<h;D++){this._layerIndexByUid[f].set(a[D].uid,D);const O=e.indexOf(a[D]);u[D]=O;D!==O&&(m=!0);-1<O&&(C[O]=D)}if(m){e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(C,
u,f);this._layerViews[f]=a;this._restartAllAgents(f);this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(c)&&this._viewChangeUpdate()}};g._restartAllAgents=function(a){const b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){const c=b.next();c.restartAgents(a);a===t.LayerClass.ELEVATION&&c.computeElevationBounds()}};g.layerViewByIndex=function(a,b){return this._layerViews[b][a]};g.numLayers=function(a){return this._layerViews[a].length};g._updateTileTextures=function(a){this._allTiles.forAll(b=>
{b.updateAgents(t.LayerClass.MAP);a===E.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(b,q.TileUpdate.TEXTURE_NOFADING):b.updateRenderData(t.LayerClass.MAP,a)});this._renderer.isTransparent=this._allTransparentSurfaceLayers()};g._invalidateLayerData=function(a,b){this._allTiles.forAll(c=>c.removeLayerAgent(a,b));this._allTiles.forAll(c=>c.invalidateLayerData(a,b))};g.setTileTreeDirty=function(){this._allTilesDirty=!0};g.requestRender=function(a=ba.RenderRequestType.UPDATE){this.renderer.setNeedsRender(a)};
g.requestUpdate=function(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)};g.requestTileData=function(a,b,c,d){const e=this.layerViewByIndex(b,c);b=e.layer;if(!b.tilemapCache||r.isVectorTileLayerView(e))return this._requestTileData(a,c,e,d);++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],a.lij[1],a.lij[2],{...d,timeout:6E3}).then(()=>--this._asyncWorkItems).catch(f=>{--this._asyncWorkItems;A.isAbortError(f)||this._dataMissing(a,c,e,{notInTilemap:!0});throw f;}).then(()=>
this._frameTask.schedule(()=>this._requestTileData(a,c,e,d),d.signal))};g._requestTileData=function(a,b,c,d){return b===t.LayerClass.ELEVATION?this._requestElevationTileData(a,c,d):this._requestMapTileData(a,c,d)};g._requestElevationTileData=function(a,b,c){if(r.isElevationLayerView(b)){var d=h=>{--this._asyncWorkItems;if(!A.isAborted(c)){var m=this._layerIndexByUid[t.LayerClass.ELEVATION].get(b.uid);null==m?x.warn("TerrainSurface: received data from unknown layer %d %s",t.LayerClass.ELEVATION,a.lij.toString()):
(this._usedMemory=-1,this.requestUpdate(),this._elevationDataArrived(a,m,h))}},e=h=>{--this._asyncWorkItems;A.isAbortError(h)||(this._dataMissing(a,t.LayerClass.ELEVATION,b,h),this.requestUpdate())};++this._asyncWorkItems;if(r.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],{noDataValue:z.ELEVATION_NODATA_VALUE,signal:c.signal}).then(h=>{A.isAborted(c)?(x.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),
e(A.createAbortError())):this._frameTask.schedule(()=>d(h),c.signal,e)},e);var f=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(f,"binary",c).then(h=>this._lercDecoder.decode(h,{noDataValue:z.ELEVATION_NODATA_VALUE},c.signal)).then(h=>{d({values:h.pixelData,width:h.width,height:h.height,noDataValue:h.noDataValue,minValue:h.minValue,maxValue:h.maxValue})},e)}r.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};g._requestMapTileData=
function(a,b,c){if(b instanceof xa)return Promise.reject();++this._asyncWorkItems;const d=(u,C)=>{--this._asyncWorkItems;r.releaseTileData(C);A.isAborted(c)||(this._dataMissing(a,t.LayerClass.MAP,b,u),this.requestUpdate())},e=u=>C=>d(C,u),f=u=>this._frameTask.schedule(()=>{--this._asyncWorkItems;this.requestUpdate();A.isAborted(c)?r.releaseTileData(u):this._mapTileDataArrived(a,b,u)},c.signal,e(u)).catch(e(u)),h=(u,C=null)=>this._frameTask.schedule(()=>d(u,C));if(r.isVectorTileLayerView(b)){var m=
b.schemaHelper.getLevelRowColumn(a.lij);return b.fetchTile(m[0],m[1],m[2],c).then(f,h)}if(r.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(f,h);if(r.isTileLayerView(b)&&r.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(u=>{A.isAborted(c)?(x.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),h(A.createAbortError())):f(u)},h);m=b.getTileUrl(a.lij[0],
a.lij[1],a.lij[2]);sa.isRefreshableLayer(b.layer)&&b.layer.refreshTimestamp&&(m+=`${m.includes("?")?"\x26":"?"}_ts=${b.layer.refreshTimestamp}`);return this._mapDataRequester.request(m,b.hasMixedImageFormats?"image+type":"image",c).then(f,h)};g._mapTileDataArrived=function(a,b,c){b=this._layerIndexByUid[t.LayerClass.MAP].get(b.uid);null!=b?a.dataArrived(b,t.LayerClass.MAP,c):(r.releaseTileData(c),x.warn("TerrainSurface: received data from unknown layer"))};g._dataMissing=function(a,b,c,d){c=this._layerIndexByUid[b].get(c.uid);
null!=c?a.dataMissing(c,b,d):x.warn("TerrainSurface: received data from unknown layer")};g.updateTileOverlayParams=function(a){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(b=>{b.renderData&&this.overlayManager.setTileParameters(b)}),this._renderer.setNeedsRender(a))};g.getUsedMemory=function(){if(!this.tilingScheme)return 0;-1===this._usedMemory&&(this._usedMemory=0,this._allTiles.forAll(a=>this._usedMemory+=a.usedMemory));return this._usedMemory};g.getUsedMemoryForLayerView=function(a){let b=
0;const c=this._layerClassFromLayerView(a),d=this._layerIndexByUid[c].get(a.uid);this._allTiles.forAll(e=>b+=e.getUsedMemoryForLayer(c,d));return b};g.getTile=function(a){if(p.isNone(a)||p.isNone(this.rootTiles))return null;const b=a.split("/").map(f=>+f);if(0===b[0])return this.rootTiles.find(f=>f.lij[1]===b[1]&&f.lij[2]===b[2]);a=2**b[0];const c=Math.floor(b[1]/a),d=Math.floor(b[2]/a);let e;this.rootTiles.some(f=>f.lij[1]===c&&f.lij[2]===d?(e=f,!0):!1);if(e){for(a=1<<b[0]-1;e.lij[0]<b[0];){let f=
b[1]&a?2:0;0<(b[2]&a)&&f++;if(!e.children[f])return null;e=e.children[f];a>>=1}r.weakAssert(e.lij[0]===b[0]&&e.lij[1]===b[1]&&e.lij[2]===b[2],"not the right tile?");return e}return null};S._createClass(B,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){var a,b,c=null==(a=this.view.pointsOfInterest)?void 0:null==(b=a.contentCameraOnSurface)?void 0:b.scale;c&&(a=this.view.state.contentCamera,a=W.directionToHeadingTilt(this.view,
a.eye,a.viewForward,a.up).tilt,90<a&&(a=180-a),a=2*(a/90)**2,c=W.scaleToZoom(this.view,c)-a,.25<Math.abs(this._snapLevel-c)&&(Math.round(c)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=c));return Math.round(this._snapLevel)}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?E.LODSnapping.ON:E.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},
{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var {spatialReference:a}=this,{clippingArea:b}=this.view;if(p.isNone(b)||p.isNone(a))return null;const c=w.create();a=ya.toBoundingRect(b,c,a)?c:null;b=this._get("extent");return w.equals(a,b)?b:a}},{key:"extent",get:function(){const a=w.intersection(this.groundExtent,this._userClippingExtent,w.create()),b=this._get("extent");
return w.equals(a,b)?b:a}},{key:"groundExtent",get:function(){return p.isSome(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var a;return null==(a=this.tilingSchemeLogic)?void 0:a.extent}},{key:"updating",get:function(){this._hasPendingUpdates||(this._maxNumUpdating=1);return!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||0<this._asyncWorkItems||!this._allTilesSorted||this._renderer.updating||
this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}},{key:"updatingProgressValue",get:function(){this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating);return 1-this._pendingUpdates/this._maxNumUpdating}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return p.isSome(this.rootTiles)}},{key:"renderOrder",set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",
a)}},{key:"skirtScale",get:function(){return this._renderer.skirtScale},set:function(a){this._renderer.skirtScale=a}},{key:"spatialReference",get:function(){var a,b;return null!=(a=null==(b=this.tilingScheme)?void 0:b.spatialReference)?a:null}},{key:"_background",get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}},{key:"slicePlaneEnabled",set:function(a){var b,c;this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a);null==(b=this.view)?void 0:
null==(c=b._stage)?void 0:c.renderView.setRenderParameters({opaqueTerrain:this.opaque})}},{key:"velvetOverground",set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)}},{key:"visible",set:function(a){a!==this._visible&&(this._visible=a,this._renderer.setVisibility(a),this.suspended=!a)}},{key:"opaque",get:function(){return this._renderer.opaque}},{key:"suspended",set:function(a){this._set("suspended",a);this._viewChangeUpdate()}},{key:"elevationBounds",
get:function(){return this._elevationBounds}},{key:"running",get:function(){return this.updating&&this.ready&&!this.suspended}},{key:"lodBias",get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*z.MAX_MEMORY_LOD_BIAS}},{key:"performanceInfo",get:function(){const a=this._performanceInfo;a.numNodes=this._allTiles.length;a.numLeaves=a.numVisible=a.numRendered=a.numLoadedPerLevel.length=a.numRenderedPerLevel.length=0;this._allTiles.forAll(b=>
{b.isLeaf&&a.numLeaves++;const c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a}},{key:"test",get:function(){const a=this;return{renderer:a._renderer,lercDecoder:a._lercDecoder,forceReload:()=>{p.isSome(a.rootTiles)&&(a._mergeTile(a.rootTiles[0]),a._viewChangeUpdate())},getTiles:()=>a._allTiles.toArray(),getRenderedTiles(){R.clear();a._allTiles.forAll(c=>
{c.visible&&c.rendered&&R.push(c)});const b=R.toArray();G.sortTiles(a.renderOrder,b);return b},lockTilingScheme(b,c){a._extentHelper.defaultTiledLayersExtent=c;a.tilingSchemeLogic.test.lockTilingScheme(b)}}}}]);return B}(ia.EventedMixin(k));l.__decorate([n.property()],k.prototype,"_renderer",void 0);l.__decorate([n.property()],k.prototype,"_hasPendingUpdates",void 0);l.__decorate([n.property()],k.prototype,"_asyncWorkItems",void 0);l.__decorate([n.property()],k.prototype,"_allTilesDirty",void 0);
l.__decorate([n.property()],k.prototype,"_allTilesSorted",void 0);l.__decorate([n.property()],k.prototype,"_viewChanged",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);l.__decorate([n.property()],k.prototype,"_frameTask",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"snapLevel",null);l.__decorate([n.property({readOnly:!0})],k.prototype,"lodSnapping",null);l.__decorate([n.property({constructOnly:!0})],k.prototype,"view",void 0);l.__decorate([n.property()],
k.prototype,"_userClippingExtent",null);l.__decorate([n.property()],k.prototype,"_rootTilesExtent",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"extent",null);l.__decorate([n.property({readOnly:!0})],k.prototype,"groundExtent",null);l.__decorate([n.property({readOnly:!0})],k.prototype,"_tilingSchemeExtent",null);l.__decorate([n.property({readOnly:!0})],k.prototype,"updating",null);l.__decorate([n.property(za.updatingProgress)],k.prototype,"updatingProgress",void 0);l.__decorate([n.property({readOnly:!0})],
k.prototype,"updatingProgressValue",null);l.__decorate([n.property()],k.prototype,"_maxNumUpdating",void 0);l.__decorate([n.property({aliasOf:"view.map.ground.opacity"})],k.prototype,"baseOpacity",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"overlayManager",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"viewingMode",null);l.__decorate([n.property()],k.prototype,"maxTextureScale",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"ready",null);l.__decorate([n.property({value:Ea.RenderOrder.FRONT_TO_BACK})],
k.prototype,"renderOrder",null);l.__decorate([n.property({readOnly:!0})],k.prototype,"rootTiles",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"spatialReference",null);l.__decorate([n.property()],k.prototype,"backgroundImage",void 0);l.__decorate([n.property({type:ea,aliasOf:"view.map.ground.surfaceColor"})],k.prototype,"backgroundColor",void 0);l.__decorate([n.property()],k.prototype,"_background",null);l.__decorate([n.property({value:!1})],k.prototype,"slicePlaneEnabled",null);l.__decorate([n.property({readOnly:!0})],
k.prototype,"tilingScheme",void 0);l.__decorate([n.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],k.prototype,"tilingSchemeLocked",void 0);l.__decorate([n.property({readOnly:!0})],k.prototype,"tilingSchemeLogic",void 0);l.__decorate([n.property({value:!0})],k.prototype,"velvetOverground",null);l.__decorate([P.aliasOf("_renderer.wireframe")],k.prototype,"wireframe",void 0);l.__decorate([n.property({value:!1})],k.prototype,"suspended",null);l.__decorate([n.property({readOnly:!0,
aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],k.prototype,"textureFadeDuration",void 0);l.__decorate([n.property()],k.prototype,"_layerViewsDirty",void 0);l.__decorate([P.aliasOf("_renderer.renderPatchBorders")],k.prototype,"renderPatchBorders",void 0);l.__decorate([P.aliasOf("_renderer.renderingDisabled")],k.prototype,"renderingDisabled",void 0);l=k=l.__decorate([ma.subclass("esri.views.3d.terrain.TerrainSurface")],k);const y=qa.create(),Ma=w.create(),L=[0,0,0],R=new T,M={spatialReference:null,
tile:null,extent:null,context:"ground"},N={spatialReference:null,extent:null,scale:0};return l});