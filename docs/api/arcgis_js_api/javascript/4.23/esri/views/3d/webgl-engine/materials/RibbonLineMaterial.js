// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutputOptions ../lib/geometryDataUtils ../lib/GLMaterial ../lib/GLMaterials ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariableMaterialParameters ./renderers/utils ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique".split(" "),
function(ka,la,aa,ba,U,S,ra,k,A,Y,N,w,sa,K,ta,ua,va,Z,L,wa,l,xa,ya,ma,ca){function M(n,x,b,a,c){for(let f=0;f<c;f++)b[a++]=n[x++];return a}function da(n,x,b){x=x.get(l.VertexAttribute.POSITION).data;b=b?b.get(l.VertexAttribute.POSITION):null;return n.isClosed?b?2<b.length:6<x.length:!1}const za=aa.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var B;(function(n){n[n.LEFT_JOIN_START=-2]="LEFT_JOIN_START";n[n.LEFT_JOIN_END=-1]="LEFT_JOIN_END";n[n.LEFT_CAP_START=-4]="LEFT_CAP_START";
n[n.LEFT_CAP_END=-5]="LEFT_CAP_END";n[n.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";n[n.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";n[n.RIGHT_CAP_START=4]="RIGHT_CAP_START";n[n.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(B||(B={}));aa=function(n){function x(a){a=n.call(this,a,Aa)||this;a._vertexAttributeLocations=ca.ribbonVertexAttributeLocations;a.techniqueConfig=new ca.RibbonLineTechniqueConfiguration;a.layout=a.createLayout();return a}la._inheritsLoose(x,n);var b=x.prototype;b.isClosed=function(a,c){return this.parameters.isClosed?
c?2<c.length:6<a.length:!1};b.dispose=function(){};b.getPassParameters=function(){return this.parameters};b.getTechniqueConfig=function(a,c){this.techniqueConfig.output=a;this.techniqueConfig.draped=c.slot===L.RenderSlot.DRAPED_MATERIAL;a=U.isSome(this.parameters.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleOffColorEnabled=a&&U.isSome(this.parameters.stippleOffColor);this.techniqueConfig.stippleScaleWithLineWidth=a&&this.parameters.stippleScaleWithLineWidth;this.techniqueConfig.stipplePreferContinuous=
a&&this.parameters.stipplePreferContinuous;this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.parameters.join;this.techniqueConfig.capType=this.parameters.cap;this.techniqueConfig.transparent=this.parameters.transparent;this.techniqueConfig.polygonOffset=this.parameters.polygonOffset;this.techniqueConfig.writeDepth=this.parameters.writeDepth;this.techniqueConfig.vvColor=
this.parameters.vvColorEnabled;this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled;this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.parameters.innerWidth&&U.isSome(this.parameters.innerColor);this.techniqueConfig.falloffEnabled=0<this.parameters.falloff;this.techniqueConfig.occluder=this.parameters.renderOccluded===Z.RenderOccludedFlag.OccludeAndTransparentStencil;this.techniqueConfig.transparencyPassType=c.transparencyPassType;this.techniqueConfig.multipassTerrainEnabled=
c.multipassTerrainEnabled;this.techniqueConfig.cullAboveGround=c.cullAboveGround;this.techniqueConfig.wireframe=this.parameters.wireframe;return this.techniqueConfig};b.intersect=function(a,c,f,m,t,d,e,g,h){U.isSome(h)?this._intersectDrapedLineGeometry(a,m,h,d,e):this._intersectLineGeometry(a,c,f,m,e)};b._intersectDrapedLineGeometry=function(a,c,f,m,t){if(c.options.selectionMode){c=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;var d=a.vertexAttributes.get(l.VertexAttribute.SIZE),e=this.parameters.width;
this.parameters.vvSizeEnabled?(d=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],e*=ba.clamp(this.parameters.vvSizeOffset[0]+d*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])):d&&(e*=d.data[0]);d=m[0];m=m[1];a=(e/2+4)*a.screenToWorldRatio;e=Number.MAX_VALUE;var g=0;for(let C=0;C<c.length-5;C+=3){var h=c[C],v=c[C+1],E=d-h,p=m-v;h=c[C+3]-h;v=c[C+4]-v;const V=ba.clamp((h*E+v*p)/(h*h+v*v),0,1);E=h*V-E;p=v*V-p;p=E*E+p*p;p<e&&(e=
p,g=C/3)}e<a*a&&t(f.dist,f.normal,g,!1)}};b._intersectLineGeometry=function(a,c,f,m,t){if(m.options.selectionMode&&!ya.isInstanceHidden(c))if(wa.isTranslationMatrix(f)){var d=a.vertexAttributes,e=d.get(l.VertexAttribute.POSITION).data;c=this.parameters.width;if(this.parameters.vvSizeEnabled){var g=d.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];c*=ba.clamp(this.parameters.vvSizeOffset[0]+g*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else d.has(l.VertexAttribute.SIZE)&&
(c*=d.get(l.VertexAttribute.SIZE).data[0]);var h=m.camera,v=Ba;ra.copy(v,m.point);g=c*h.pixelRatio/2+4*h.pixelRatio;k.set(W[0],v[0]-g,v[1]+g,0);k.set(W[1],v[0]+g,v[1]+g,0);k.set(W[2],v[0]+g,v[1]-g,0);k.set(W[3],v[0]-g,v[1]-g,0);for(c=0;4>c;c++)if(!h.unprojectFromRenderScreen(W[c],I[c]))return;w.fromPoints(h.eye,I[0],I[1],ea);w.fromPoints(h.eye,I[1],I[2],fa);w.fromPoints(h.eye,I[2],I[3],ha);w.fromPoints(h.eye,I[3],I[0],ia);var E=Number.MAX_VALUE;c=0;a=da(this.parameters,d,a.indices)?e.length-2:e.length-
5;for(d=0;d<a;d+=3){y[0]=e[d]+f[12];y[1]=e[d+1]+f[13];y[2]=e[d+2]+f[14];var p=(d+3)%e.length;z[0]=e[p]+f[12];z[1]=e[p+1]+f[13];z[2]=e[p+2]+f[14];if(!(0>w.signedDistance(ea,y)&&0>w.signedDistance(ea,z)||0>w.signedDistance(fa,y)&&0>w.signedDistance(fa,z)||0>w.signedDistance(ha,y)&&0>w.signedDistance(ha,z)||0>w.signedDistance(ia,y)&&0>w.signedDistance(ia,z))){h.projectToRenderScreen(y,O);h.projectToRenderScreen(z,P);if(0>O[2]&&0<P[2])k.subtract(G,y,z),p=h.frustum,p=-w.signedDistance(p[Y.PlaneIndex.NEAR],
y)/k.dot(G,w.normal(p[Y.PlaneIndex.NEAR])),k.scale(G,G,p),k.add(y,y,G),h.projectToRenderScreen(y,O);else if(0<O[2]&&0>P[2])k.subtract(G,z,y),p=h.frustum,p=-w.signedDistance(p[Y.PlaneIndex.NEAR],z)/k.dot(G,w.normal(p[Y.PlaneIndex.NEAR])),k.scale(G,G,p),k.add(z,z,G),h.projectToRenderScreen(z,P);else if(0>O[2]&&0>P[2])continue;O[2]=0;P[2]=0;p=N.distance2(N.fromPoints(O,P,na),v);p<E&&(E=p,k.copy(oa,y),k.copy(pa,z),c=d/3)}}f=m.rayBegin;m=m.rayEnd;E<g*g&&(e=Number.MAX_VALUE,N.closestLineSegmentPoint(N.fromPoints(oa,
pa,na),N.fromPoints(f,m,Ca),Q)&&(k.subtract(Q,Q,f),e=k.length(Q),k.scale(Q,Q,1/e),e/=k.distance(f,m)),t(e,Q,c,!1))}else za.error("intersection assumes a translation-only matrix")};b.computeAttachmentOrigin=function(a,c){const f=a.vertexAttributes;if(!f)return null;a=a.indices;const m=f.get(l.VertexAttribute.POSITION);return ta.computeAttachmentOriginLines(m,a?a.get(l.VertexAttribute.POSITION):null,a&&da(this.parameters,f,a),c)};b.createLayout=function(){const a=sa.newLayout().vec3f(l.VertexAttribute.POSITION).f32(l.VertexAttribute.SUBDIVISIONFACTOR).vec2f(l.VertexAttribute.UV0).vec3f(l.VertexAttribute.AUXPOS1).vec3f(l.VertexAttribute.AUXPOS2);
this.parameters.vvSizeEnabled?a.f32(l.VertexAttribute.SIZEFEATUREATTRIBUTE):a.f32(l.VertexAttribute.SIZE);this.parameters.vvColorEnabled?a.f32(l.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(l.VertexAttribute.COLOR);this.parameters.vvOpacityEnabled&&a.f32(l.VertexAttribute.OPACITYFEATUREATTRIBUTE);return a};b.createBufferWriter=function(){return new Da(this.layout,this.parameters)};b.requiresSlot=function(a,c){if(a===L.RenderSlot.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Z.RenderOccludedFlag.OccludeAndTransparentStencil)return a===
L.RenderSlot.OPAQUE_MATERIAL||a===L.RenderSlot.OCCLUDER_MATERIAL||a===L.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;c=va.outputFromPass(c);return c===K.ShaderOutput.Color||c===K.ShaderOutput.Alpha?a===(this.parameters.writeDepth?L.RenderSlot.TRANSPARENT_MATERIAL:L.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a===L.RenderSlot.OPAQUE_MATERIAL};b.createGLMaterial=function(a){return a.output===K.ShaderOutput.Color||a.output===K.ShaderOutput.Alpha||a.output===K.ShaderOutput.Highlight||a.output===
K.ShaderOutput.Depth?new Ea(a):null};b.validateParameters=function(a){"miter"!==a.join&&(a.miterLimit=0);this._requiresTransparent(a)&&(a.transparent=!0)};b._requiresTransparent=function(a){return!!(1>(a.color&&a.color[3])||0<a.innerWidth&&this._colorRequiresTransparent(a.innerColor)||a.stipplePattern&&this._colorRequiresTransparent(a.stippleOffColor)||0<a.falloff)};b._colorRequiresTransparent=function(a){return U.isSome(a)&&1>a[3]&&0<a[3]};return x}(Z.Material);let Ea=function(n){function x(){return n.apply(this,
arguments)||this}la._inheritsLoose(x,n);var b=x.prototype;b.updateParameters=function(a){return this.ensureTechnique(ca.RibbonLineTechnique,a)};b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:a.hasOccludees})};b.beginSlot=function(a){this._output!==K.ShaderOutput.Color&&this._output!==K.ShaderOutput.Alpha||this._updateOccludeeState(a);return this.updateParameters(a)};b.bind=function(a,c){c.bindPass(this._material.getPassParameters(),
a)};return x}(ua);const Aa={width:0,color:[1,1,1,1],join:"miter",cap:ma.CapType.BUTT,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,wireframe:!1,...Z.DefaultMaterialParameters,...xa.VisualVariableDefaultMaterialParameters};let Da=function(){function n(b,a){this.parameters=a;this.numJoinSubdivisions=
0;this.vertexBufferLayout=b;b=a.stipplePattern?1:0;switch(this.parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=b;break;case "round":this.numJoinSubdivisions=ma.NUM_ROUND_JOIN_SUBDIVISIONS+b}}var x=n.prototype;x._isClosed=function(b){return da(this.parameters,b.vertexAttributes,b.indices)};x.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};x.elementCount=function(b){var a=b.indices.get(l.VertexAttribute.POSITION).length/2+1;b=this._isClosed(b);a=(b?2:4)+((b?
a:a-1)-(b?0:1))*(2*this.numJoinSubdivisions+4);a+=2;this.parameters.wireframe&&(a=2+4*(a-2));return a};x.write=function(b,a,c,f){var m;const t=Fa,d=Ga,e=Ha,g=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;var h=a.indices&&a.indices.get(l.VertexAttribute.POSITION);const v=null==(m=a.vertexAttributes.get(l.VertexAttribute.DISTANCETOSTART))?void 0:m.data;h&&h.length!==2*(g.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let E=1,p=0;this.parameters.vvSizeEnabled?p=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:
a.vertexAttributes.has(l.VertexAttribute.SIZE)&&(E=a.vertexAttributes.get(l.VertexAttribute.SIZE).data[0]);let C=[1,1,1,1],V=0;this.parameters.vvColorEnabled?V=a.vertexAttributes.get(l.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(l.VertexAttribute.COLOR)&&(C=a.vertexAttributes.get(l.VertexAttribute.COLOR).data);let qa=0;this.parameters.vvOpacityEnabled&&(qa=a.vertexAttributes.get(l.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);m=g.length/3;b=b.transformation;const r=new Float32Array(c.buffer);
h=this.vertexBufferLayout.stride/4;let q=f*h;f=q;let D=0;const ja=v?(u,H,J)=>D=v[J]:(u,H,J)=>D+=k.distance(u,H),F=(u,H,J,Ia,Ja,Ka,La)=>{r[q++]=H[0];r[q++]=H[1];r[q++]=H[2];r[q++]=Ia;r[q++]=La;r[q++]=Ja;r[q++]=u[0];r[q++]=u[1];r[q++]=u[2];r[q++]=J[0];r[q++]=J[1];r[q++]=J[2];this.parameters.vvSizeEnabled?r[q++]=p:r[q++]=E;this.parameters.vvColorEnabled?r[q++]=V:(u=Math.min(4*Ka,C.length-4),r[q++]=C[u+0],r[q++]=C[u+1],r[q++]=C[u+2],r[q++]=C[u+3]);this.parameters.vvOpacityEnabled&&(r[q++]=qa)};q+=h;k.set(d,
g[0],g[1],g[2]);b&&k.transformMat4(d,d,b);if(a=this._isClosed(a)){var R=g.length-3;k.set(t,g[R],g[R+1],g[R+2]);b&&k.transformMat4(t,t,b)}else k.set(e,g[3],g[4],g[5]),b&&k.transformMat4(e,e,b),F(d,d,e,1,B.LEFT_CAP_START,0,0),F(d,d,e,1,B.RIGHT_CAP_START,0,0),k.copy(t,d),k.copy(d,e);R=a?0:1;const X=a?m:m-1;for(let u=R;u<X;u++){var T=(u+1)%m*3;k.set(e,g[T+0],g[T+1],g[T+2]);b&&k.transformMat4(e,e,b);ja(t,d,u);F(t,d,e,0,B.LEFT_JOIN_END,u,D);F(t,d,e,0,B.RIGHT_JOIN_END,u,D);T=this.numJoinSubdivisions;for(let H=
0;H<T;++H){const J=(H+1)/(T+1);F(t,d,e,J,B.LEFT_JOIN_END,u,D);F(t,d,e,J,B.RIGHT_JOIN_END,u,D)}F(t,d,e,1,B.LEFT_JOIN_START,u,D);F(t,d,e,1,B.RIGHT_JOIN_START,u,D);k.copy(t,d);k.copy(d,e)}a?(k.set(e,g[3],g[4],g[5]),b&&k.transformMat4(e,e,b),D=ja(t,d,X),F(t,d,e,0,B.LEFT_JOIN_END,R,D),F(t,d,e,0,B.RIGHT_JOIN_END,R,D)):(D=ja(t,d,X),F(t,d,d,0,B.LEFT_CAP_END,X,D),F(t,d,d,0,B.RIGHT_CAP_END,X,D));M(r,f+h,r,f,h);q=M(r,q-h,r,q,h);this.parameters.wireframe&&this._addWireframeVertices(c,f,q,h)};x._addWireframeVertices=
function(b,a,c,f){const m=new Float32Array(b.buffer,c*Float32Array.BYTES_PER_ELEMENT);b=new Float32Array(b.buffer,a*Float32Array.BYTES_PER_ELEMENT,c-a);a=0;for(c=0;c<b.length-1;c+=2*f)a=M(b,c,m,a,f),a=M(b,c+2*f,m,a,f),a=M(b,c+1*f,m,a,f),a=M(b,c+2*f,m,a,f),a=M(b,c+1*f,m,a,f),a=M(b,c+3*f,m,a,f)};return n}();const y=A.create(),z=A.create(),G=A.create(),Q=A.create(),Ba=A.create(),O=S.createRenderScreenPointArray3(),P=S.createRenderScreenPointArray3(),oa=A.create(),pa=A.create(),na=N.create(),Ca=N.create(),
Fa=A.create(),Ga=A.create(),Ha=A.create(),W=[S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3(),S.createRenderScreenPointArray3()],I=[A.create(),A.create(),A.create(),A.create()],ea=w.create(),fa=w.create(),ha=w.create(),ia=w.create();ka.RibbonLineMaterial=aa;Object.defineProperty(ka,"__esModule",{value:!0})});