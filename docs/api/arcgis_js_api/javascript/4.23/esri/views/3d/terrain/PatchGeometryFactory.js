// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/Ellipsoid ../../../geometry/support/buffer/BufferPool ../support/buffer/InterleavedLayout ./ElevationData ./interfaces ./TerrainConst ../webgl-engine/lib/VertexAttribute ../webgl-engine/materials/internal/MaterialUtil".split(" "),function(P,la,L,ma,Z,na,V,oa,pa,qa,aa,Q,R,ba,ca){function da(d,e,k,m){const F=
k===Q.PatchType.HAS_NORTH_POLE||k===Q.PatchType.HAS_BOTH_POLES,u=e+(m?1024:0)+(F?2048:0);var n=W.get(u);if(!n){{n=e-1;const p=e*e;var a=4*n;let C=6*p,z=6*a,l=6*(2*n+n-1);m&&(C*=2,z*=2,l*=2);a=65536<p+a?new Uint32Array(C+z):new Uint16Array(C+z);let h=0,b=0,c=C;for(let f=0;f<=n;f++){let q=0;F&&(q=0===f?l:f===n?-l:0);c+=q;for(let v=0;v<=n;v++){var r=X(v,f,n);if(L.isSome(r)){var t=0===f&&v!==n?1:v===n&&f!==n?n+1:f===n&&0!==v?-1:0===v&&0!==f?-(n+1):0;if(0!==t){var g=h,y=p+r;r=p+(0===v&&1===f?0:r+1);t=
h+t;m?(a[c++]=g,a[c++]=y,a[c++]=y,a[c++]=r,a[c++]=r,a[c++]=g,a[c++]=r,a[c++]=t,a[c++]=t,a[c++]=g,a[c++]=g,a[c++]=r):(a[c++]=g,a[c++]=y,a[c++]=r,a[c++]=r,a[c++]=t,a[c++]=g)}}++h;v<n&&f<n&&(g=f*(n+1)+v,y=g+1,t=y+(n+1),r=t-1,m?(a[b++]=g,a[b++]=y,a[b++]=y,a[b++]=t,a[b++]=t,a[b++]=g,a[b++]=t,a[b++]=r,a[b++]=r,a[b++]=g,a[b++]=g,a[b++]=t):(a[b++]=g,a[b++]=y,a[b++]=t,a[b++]=t,a[b++]=r,a[b++]=g))}c-=q}n=new ra(a,C,z)}W.set(u,n)}d.indices=n.values;d.numSurfaceIndices=n.numSurfaceIndices;d.numSkirtIndices=n.numSkirtIndices;
d.numWithoutSkirtIndices=d.numSurfaceIndices+(k===Q.PatchType.REGULAR?0:6*(e-1)*(m?2:1))}function Y(d,e,k,m){d<m[0]&&(m[0]=d);d>m[3]&&(m[3]=d);e<m[1]&&(m[1]=e);e>m[4]&&(m[4]=e);k<m[2]&&(m[2]=k);k>m[5]&&(m[5]=k)}function ea(d,e){const k=e>d?1:0;return 2+4*k+(1-2*k)*(d+e)}function X(d,e,k){return 0===e?d:d===k?k+e:e===k?3*k-d:0===d&&0<e?4*k-e:null}const sa=qa.newLayout().vec3f(ba.VertexAttribute.POSITION).vec2f(ba.VertexAttribute.UV0),S=new pa.BufferPool(d=>sa.createBuffer(d),d=>d.count);let ra=function(d,
e,k){this.values=d;this.numSurfaceIndices=e;this.numSkirtIndices=k};const W=new Map,fa=Array(R.MAX_PATCH_TESSELATION+1),ha=Array(R.MAX_PATCH_TESSELATION+1),ia=Array(R.MAX_PATCH_TESSELATION+1),ja=Array(R.MAX_PATCH_TESSELATION+1),ka=ma.create();P.PatchGeometry=function(){this.vertexAttributes=this.indices=null;this.boundingBox=V.empty();this.skirtLength=this.numVertsPerRow=this.numWithoutSkirtIndices=this.numSkirtIndices=this.numSurfaceIndices=0;this.uvOffsetAndScale=na.create()};P.clearCaches=function(){S.clear();
W.clear()};P.createPlanarGlobePatch=function(d,e,k,m,F,u){const n=e[0],a=e[1],r=e[2]-n,t=e[3]-a,g=d.clippingArea,y=L.isSome(g)?Math.max(0,(g[0]-e[0])/r):0,p=L.isSome(g)?Math.max(0,(g[1]-e[1])/t):0,C=L.isSome(g)?Math.min(1,(g[2]-e[0])/r):1;e=L.isSome(g)?Math.min(1,(g[3]-e[1])/t):1;const z=C>y?1/(C-y):1,l=e>p?1/(e-p):1,h=-y*z,b=-p*l,c=r*m*.1,f=d.numVertsPerSide-1,q=d.numVertsPerSide*d.numVertsPerSide,v=S.acquire(q+4*f),w=v.position.typedBuffer,D=v.uv0.typedBuffer,x=u.geometryInfo.boundingBox;V.empty(x);
let B=0;const G=oa.earth.radius,H=d.samplerData,K=L.isSome(H)&&H.some(J=>L.isSome(J))?(J,N)=>aa.sampleElevation(J,N,H):()=>0;for(let J=0;J<=f;J++){var E=J/f;let N=b+E*l;E=a+E*t;L.isSome(g)&&(E<g[1]?(E=g[1],N=0):E>g[3]&&(E=g[3],N=1));const O=(F?(Math.PI/2-2*Math.atan(Math.exp(-E/G)))*G:E*m)-k[1];for(let T=0;T<=f;T++){var I=T/f;let U=h+I*z;I=n+I*r;L.isSome(g)&&(I<g[0]?(I=g[0],U=0):I>g[2]&&(I=g[2],U=1));var M=K(I,E);I=I*m-k[0];M-=k[2];Y(I,O,M,x);var A=R.GEOMETRY_VERTEX_STRIDE*B;w[A+0]=I;w[A+1]=O;w[A+
2]=M;D[A+0]=U;D[A+1]=N;A=X(T,J,f);L.isSome(A)&&(A=R.GEOMETRY_VERTEX_STRIDE*(q+A),w[A+0]=I,w[A+1]=O,w[A+2]=M,D[A+0]=ea(U,N),D[A+1]=c);++B}}u.geometryInfo.numVertsPerRow=d.numVertsPerSide;u.geometryInfo.vertexAttributes=v;u.geometryInfo.skirtLength=c;Z.set(u.geometryInfo.uvOffsetAndScale,y,p,C-y,e-p);da(u.geometryInfo,d.numVertsPerSide,Q.PatchType.REGULAR,d.wireframe);u.intersectionData=null;u.skirtIntersectionData=null};P.createSphericalGlobePatch=function(d,e,k,m,F,u,n,a){var r=F[0];const t=F[1];
var g=F[2];F=F[3];const y=.1*n.radius*(F-t),p=d.numVertsPerSide-1,C=d.numVertsPerSide*d.numVertsPerSide,z=u&&(a===Q.PatchType.HAS_SOUTH_POLE||a===Q.PatchType.HAS_BOTH_POLES),l=u&&(a===Q.PatchType.HAS_NORTH_POLE||a===Q.PatchType.HAS_BOTH_POLES),h=S.acquire(C+4*p),b=h.position.typedBuffer,c=h.uv0.typedBuffer,f=m.geometryInfo.boundingBox;V.empty(f);var q=e[2]-e[0];const v=e[3]-e[1];var w=g-r;g=k[0];const D=k[1];k=k[2];for(var x=0;x<=p;x++){var B=x/p,G=r+B*w;fa[x]=Math.sin(G);ha[x]=Math.cos(G);ia[x]=
B;ja[x]=e[0]+B*q}r=0;const H=d.samplerData;q=L.isSome(H)&&H.some(J=>L.isSome(J))?(J,N)=>aa.sampleElevation(ja[J],N,H):()=>0;for(w=0;w<=p;w++){x=w/p;var K=la.lerp(t,F,x);B=Math.cos(K);G=Math.sin(K);u?(K=n.halfSemiMajorAxis*Math.log((1+G)/(1-G)),x=(K-e[1])/v):K=180*K/Math.PI;for(let J=0;J<=p;J++){const N=ia[J];var E=fa[J],I=ha[J],M=n.radius+q(J,K);I=I*B*M-g;E=E*B*M-D;M=G*M-k;Y(I,E,M,f);var A=R.GEOMETRY_VERTEX_STRIDE*r;b[A+0]=I;b[A+1]=E;b[A+2]=M;c[A+0]=N;c[A+1]=x;A=X(J,w,p);if(L.isSome(A)){A=R.GEOMETRY_VERTEX_STRIDE*
(C+A);const O=z&&0===w?-1:l&&w===p?1:0;I=0===O?I:-g;E=0===O?E:-D;M=0===O?M:n.radius*O-k;b[A+0]=I;b[A+1]=E;b[A+2]=M;c[A+0]=0===O?ea(N,x):N;c[A+1]=0===O?y:x;0!==O&&Y(I,E,M,f)}++r}}m.geometryInfo.numVertsPerRow=d.numVertsPerSide;m.geometryInfo.vertexAttributes=h;m.geometryInfo.skirtLength=y;Z.set(m.geometryInfo.uvOffsetAndScale,0,0,1,1);da(m.geometryInfo,d.numVertsPerSide,u?a:Q.PatchType.REGULAR,d.wireframe);m.intersectionData=null;m.skirtIntersectionData=null};P.getGlobalSkirtGeometry=function(d,e,
k,m,F,u){const n=m.position,a=m.uv0;m=new Map;e*=3;k=3*k-e;const r=new Uint32Array(k);let t=0;for(let y=0;y<k;++y){const p=d[y+e];if(m.has(p))r[y]=m.get(p);else{const C=t++;m.set(p,C);r[y]=C}}const g=new Float64Array(3*t);m.forEach((y,p)=>{let C=n.get(p,0),z=n.get(p,1),l=n.get(p,2);if(2<=a.get(p,0)){p=C+u[0];const h=z+u[1],b=l+u[2],c=F/Math.sqrt(p*p+h*h+b*b);C+=p*c;z+=h*c;l+=b*c}g[3*y]=C;g[3*y+1]=z;g[3*y+2]=l});return{vertices:g,indices:r}};P.intersectSkirtsGlobal=function(d,e,k,m,F,u,n,a,r,t){const g=
u.position;u=u.uv0;const y=d[0],p=d[1];d=d[2];const C=e[0]-y,z=e[1]-p;e=e[2]-d;k*=3;for(m*=3;k<m;k+=3){var l=F[k],h=F[k+1],b=F[k+2],c=g.get(l,0),f=g.get(l,1),q=g.get(l,2),v=g.get(h,0),w=g.get(h,1),D=g.get(h,2),x=g.get(b,0),B=g.get(b,1),G=g.get(b,2);if(2<=u.get(l,0)){l=c+a[0];var H=f+a[1],K=q+a[2];const E=n/Math.sqrt(l*l+H*H+K*K);c+=l*E;f+=H*E;q+=K*E}2<=u.get(h,0)&&(h=v+a[0],l=w+a[1],H=D+a[2],K=n/Math.sqrt(h*h+l*l+H*H),v+=h*K,w+=l*K,D+=H*K);2<=u.get(b,0)&&(b=x+a[0],h=B+a[1],l=G+a[2],H=n/Math.sqrt(b*
b+h*h+l*l),x+=b*H,B+=h*H,G+=l*H);L.isSome(r)&&([c,f,q]=r.applyToVertex(c,f,q),[v,w,D]=r.applyToVertex(v,w,D),[x,B,G]=r.applyToVertex(x,B,G));v-=c;w-=f;D-=q;x-=c;B-=f;G-=q;h=z*G-B*e;l=e*x-G*C;H=C*B-x*z;b=v*h+w*l+D*H;if(!(Math.abs(b)<=Number.EPSILON)){c=y-c;f=p-f;q=d-q;h=c*h+f*l+q*H;if(0<b){if(0>h||h>b)continue}else if(0<h||h<b)continue;l=f*D-w*q;q=q*v-D*c;f=c*w-v*f;c=C*l+z*q+e*f;if(0<b){if(0>c||h+c>b)continue}else if(0<c||h+c<b)continue;q=(x*l+B*q+G*f)/b;0<=q&&(f=ca.computeNormal(v,w,D,x,B,G,ka),t(q,
f))}}};P.intersectSkirtsLocal=function(d,e,k,m,F,u,n,a,r){const t=u.position;u=u.uv0;const g=d[0],y=d[1];d=d[2];const p=e[0]-g,C=e[1]-y;e=e[2]-d;k*=3;for(m*=3;k<m;k+=3){var z=F[k],l=F[k+1],h=F[k+2],b=t.get(z,0),c=t.get(z,1),f=t.get(z,2),q=t.get(l,0),v=t.get(l,1),w=t.get(l,2),D=t.get(h,0),x=t.get(h,1),B=t.get(h,2);2<=u.get(z,0)&&(f+=n);2<=u.get(l,0)&&(w+=n);2<=u.get(h,0)&&(B+=n);L.isSome(a)&&([b,c,f]=a.applyToVertex(b,c,f),[q,v,w]=a.applyToVertex(q,v,w),[D,x,B]=a.applyToVertex(D,x,B));z=q-b;v-=c;w-=
f;D-=b;x-=c;B-=f;h=C*B-x*e;q=e*D-B*p;const G=p*x-D*C;l=z*h+v*q+w*G;if(!(Math.abs(l)<=Number.EPSILON)){b=g-b;c=y-c;f=d-f;h=b*h+c*q+f*G;if(0<l){if(0>h||h>l)continue}else if(0<h||h<l)continue;q=c*w-v*f;f=f*z-w*b;c=b*v-z*c;b=p*q+C*f+e*c;if(0<l){if(0>b||h+b>l)continue}else if(0<b||h+b<l)continue;f=(D*q+x*f+B*c)/l;0<=f&&(z=ca.computeNormal(z,v,w,D,x,B,ka),r(f,z))}}};P.releaseGeometry=function(d){S.release(d.vertexAttributes);d.vertexAttributes=null;d.indices=null};Object.defineProperty(P,"__esModule",{value:!0})});