// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/MapUtils ../../../../core/maybe ../../../../core/time ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../support/animationUtils ../../support/debugFlags ../core/renderPasses/RenderPassManager ../core/shaderLibrary/hud/HUDUniforms ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./glUtil3D ./HighlightHelper ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderPass ./RenderPluginManager ./RenderSlot ./ShadowAccumulator ./ShadowHighlightHelper ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView ./edgeRendering/interfaces ../lighting/SceneLighting ../materials/renderers/MergedRenderer ../shaders/CompositingTechnique ../shaders/ShadowHighlightTechnique ../statistics/RendererPerformanceInfo ../../../webgl/enums ../../../webgl/Measurement".split(" "),
function(n,P,A,W,X,F,t,M,Q,B,wa,xa,ya,Y,w,y,Z,R,aa,ba,z,q,ca,S,da,ea,fa,u,ha,ia,ja,p,ka,l,la,ma,na,oa,pa,qa,ra,G,sa,ta,H,T,m,C,ua){n.Renderer=function(r){function K(a,c,d,h,e,g,k,v,x){var b=r.call(this,{})||this;b._materialRepository=a;b._shaderTechniqueRepository=d;b._rctx=h;b._compositingHelper=e;b._magnifierHelper=g;b._requestRender=k;b._stage=x;b._materialRenderers=new Map;b._needsTransparentPass=!1;b._hasHUDElements=!1;b._hasHighlights=!1;b._hasOccludees=!1;b._hasWater=!1;b._hasOverlayWater=
!1;b._content=new Map;b._isRendering=!1;b._fallbackDepthStencilTexture=null;b.performanceInfo=new m.RendererPerformanceInfo;b._antialiasing=q.AntiAliasingMode.SMAA;b._oitEnabled=!1;b._multipassTerrain=!0;b._opaqueTerrain=!0;b._lighting=new sa.SceneLighting;b._hasAnimations=!1;b._animationTimestep=M.Milliseconds(0);b._handles=new X;b._renderHiddenTransparentEdges=()=>{};b._oitUsed=!1;b._smaaPass=new pa.SmaaRenderPass(b._rctx,d);b._oitEnabled=b._hasOITSupport;b._requestRender();b._offscreenRendering=
new ha.OffscreenRendering(b._rctx,b._compositingHelper);b._sliceHelper=new oa;b._shadowMap=new na(b._rctx,x.viewingMode,2);b._ssaoHelper=new qa.SSAOHelper(d,b._rctx,()=>b._requestRender());b._highlightHelper=new fa(d,b._rctx);b._shadowHighlightHelper=new ma.ShadowHighlightHelper(b._rctx,x.viewingMode);b._shadowAccumulator=new la.ShadowAccumulator(b._rctx,d,x,(D,N)=>{b.renderPassManager.shadowCastingEnabled=!0;b._renderPlugins.prepareRender(D,N);b.renderPassManager.shadowCastingEnabled=b._shadowMap.enabled},
(D,N,O,va)=>{D.start(O,N,va);b._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL,D);O.setGLViewport(b._rctx);b._ensureCameraBindParameters(O)},()=>b._requestRender());b._bindParameters={slot:null,camera:null,inverseViewport:Z.create(),shadowMap:b._shadowMap,shadowMappingEnabled:b._shadowMap.enabled,ssaoHelper:b._ssaoHelper,ssaoEnabled:b._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:b._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,
linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:y.IDENTITY,ssrEnabled:!1,lighting:b._lighting,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0};b._renderContext=new ia.RenderContext(b._rctx,b._offscreenRendering,b._lighting,b._shadowMap,b._ssaoHelper,b._sliceHelper);b._renderContext.multipassTerrainParams={camera:null,
multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null};b._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null};b._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:y.IDENTITY,ssrEnabled:!1};b._renderPlugins=new ka.RenderPluginManager({renderContext:b._renderContext,shaderTechniqueRepository:d,textureRep:c,materialRep:b._materialRepository,requestRender:b._requestRender,schedule:v});
b.renderPassManager=new ba.RenderPassManager(b._rctx,b._shaderTechniqueRepository);b._renderPlugins.add(b.renderPassManager.slots(),b.renderPassManager);b._handles.add([Q.init(aa,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",D=>{b._renderHiddenTransparentEdges=D?()=>b._renderEdges(G.Transparency.TRANSPARENT):()=>{};b._requestRender()}),Q.init(b._stage,"camera",()=>b._requestRender(),!0)]);return b}P._inheritsLoose(K,r);var f=K.prototype;f.normalizeCtorArgs=function(){return{}};f.dispose=function(){this._handles.destroy();
this._smaaPass.dispose();this._materialRenderers.forEach(a=>a.dispose());this._materialRenderers.clear();this._edgeView=t.destroyMaybe(this._edgeView);this._offscreenRendering.dispose();this._fallbackDepthStencilTexture=t.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap.enabled=!1;this._shadowMap.dispose();this._ssaoHelper.enabled=!1;this._ssaoHelper.dispose();this._highlightHelper.dispose();this._shadowHighlightHelper.dispose();this._shadowAccumulator.dispose();ca.BoundingInfo.prune();
this._content.clear()};f.disposeOffscreenBuffers=function(){this._offscreenRendering.dispose();this._shadowMap.dispose();this._smaaPass.disable();this._ssaoHelper.disposeOffscreenBuffers()};f.ensureEdgeView=function(){t.isNone(this._edgeView)&&(this._edgeView=new ra.EdgeView({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:a=>this._stage.resourceController.schedule(a)}),this._handles.add(this._edgeView.watch("updating",
()=>this._requestRender(),!0)),this._requestRender());return this._edgeView};f.setRenderParameters=function(a){const {renderPassManager:c,_shadowMap:d,_ssaoHelper:h}=this;void 0!==a.screenSpaceReflectionsEnabled&&c.screenSpaceReflectionsEnabled!==a.screenSpaceReflectionsEnabled&&(c.screenSpaceReflectionsEnabled=a.screenSpaceReflectionsEnabled,this._requestRender());void 0!==a.fillLightsEnabled&&c.fillLightsEnabled!==a.fillLightsEnabled&&(c.fillLightsEnabled=a.fillLightsEnabled,this._requestRender());
void 0===a.shadowMap||d.enabled===a.shadowMap&&c.shadowCastingEnabled===a.shadowMap||(d.enabled=a.shadowMap,c.shadowCastingEnabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&d.maxCascades!==a.shadowMapMaxCascades&&(d.maxCascades=a.shadowMapMaxCascades,this._requestRender());void 0!==a.ssao&&h.enabled!==a.ssao&&(h.enabled=a.ssao,this._requestRender());a.background&&this._offscreenRendering.background!==a.background&&(this._offscreenRendering.background=a.background,this._requestRender());
const e=a.antialiasingEnabled?q.AntiAliasingMode.SMAA:q.AntiAliasingMode.NONE;void 0!==a.antialiasingEnabled&&this._antialiasing!==e&&(this._antialiasing=e,this._requestRender());void 0!==a.highQualityTransparency&&this._multipassTerrain!==a.highQualityTransparency&&(this._oitEnabled=(this._multipassTerrain=a.highQualityTransparency)&&this._hasOITSupport,this._requestRender());void 0!==a.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(a.defaultHighlightOptions),
this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=t.unwrap(a.slicePlane),this._requestRender());void 0!==a.waterReflectionEnabled&&this._waterReflectionEnabled!==a.waterReflectionEnabled&&(this._waterReflectionEnabled=a.waterReflectionEnabled,this._requestRender());void 0!==a.fillLightsEnabled&&this._hasFillLights!==a.fillLightsEnabled&&(this._hasFillLights=a.fillLightsEnabled,this._requestRender());void 0!==a.opaqueTerrain&&this._opaqueTerrain!==
a.opaqueTerrain&&(this._opaqueTerrain=a.opaqueTerrain,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)};f.modify=function(a){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:c,removes:d,updates:h}=a;if(0!==c.length||0!==d.length||0!==h.length){d.forAll(({id:g})=>this._content.delete(g));
c.forAll(g=>this._content.set(g.id,g));var e=!1;ja.splitRenderGeometryChangeSetByMaterial(a).forEach((g,k)=>{let v=this._materialRenderers.get(k);if(!v)if(0<g.adds.length)v=new ta.MergedRenderer(this._rctx,this._materialRepository,k),this._materialRenderers.set(k,v);else return;v.modify(g);v.isEmpty&&(e=!0)});e&&this._materialRenderers.forEach((g,k)=>{g.isEmpty&&(this._materialRenderers.delete(k),g.dispose())});this._hasHighlights=F.someMap(this._materialRenderers,g=>g.hasHighlights);this._hasOccludees=
F.someMap(this._materialRenderers,g=>g.hasOccludees);this._hasWater=F.someMap(this._materialRenderers,g=>g.hasWater);this._needsTransparentPass=F.someMap(this._materialRenderers,g=>g.requiresSlot(l.RenderSlot.TRANSPARENT_MATERIAL,p.RenderPass.MATERIAL));this._hasHUDElements=F.someMap(this._materialRenderers,g=>g.requiresSlot(l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,p.RenderPass.MATERIAL)||g.requiresSlot(l.RenderSlot.HUD_MATERIAL,p.RenderPass.MATERIAL)||g.requiresSlot(l.RenderSlot.LABEL_MATERIAL,p.RenderPass.MATERIAL));
this._requestRender()}};f.updateAnimation=function(a){this._hasAnimations=!1;this._materialRenderers.forEach(c=>this._hasAnimations=c.updateAnimation(a)||this._hasAnimations);return this._hasAnimations=this._renderPlugins.updateAnimation(a)||this._hasAnimations};f.updateLightSources=function(a,c,d){this._lighting.groundLightingFactor=c;this._lighting.globalFactor=d;this._lighting.set(a)};f.render=function(a,c,d,h){this._isRendering=!0;this.performanceInfo.prerender(this._rctx);this._bindParameters.lighting=
this._lighting;this._renderContext.hasOccludees=this._hasOccludees;this._renderContext.transparencyPassType=this._bindParameters.transparencyPassType=q.TransparencyPassType.NONE;this._renderContext.hasFillLights=this._bindParameters.hasFillLights=this._hasFillLights;var e=this._offscreenRendering;e.needLastFrameColorTexture=this.hasWaterReflection;e.advanceCurrentRenderTarget();const g=this._sliceHelper.plane;h===q.Decorations.OFF&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);c.setGLViewport(this._rctx);
this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0);this._renderPlugins.prepareRender(c,d);this.performanceInfo.advance(m.Statistics.Prepare);var k=this._computeDepthRange(c);this._renderShadowMap(a,c,this._lighting.lightingMainDirection,k);this.performanceInfo.advance(m.Statistics.Shadowmap);e.initializeFrame(c);this._ensureBindParameters(c);this._renderLinearDepth();this.performanceInfo.advance(m.Statistics.Lineardepth);this._accumulateShadows(k,c,d);this._renderNormal();this.performanceInfo.advance(m.Statistics.Normals);
this._ensureBindParametersSSR();this._ensureBindParametersCloudsReflections();this._ssaoHelper.computeSSAO(c,e.linearDepthTexture,e.normalTexture);this.performanceInfo.advance(m.Statistics.SSAO);this._renderContext.pass=p.RenderPass.MATERIAL;e.bindFramebuffer();this._renderOpaqueGeometry();this.performanceInfo.advance(m.Statistics.Opaque);c=this._multipassTerrain&&!this._opaqueTerrain;this._renderTerrainLinearDepth(c);this._setMultipassFlags(c);this._setTerrainCulling(c);this._renderEdges(G.Transparency.OPAQUE);
this.performanceInfo.advance(m.Statistics.OpaqueEdges);this._renderHiddenTransparentEdges();(d=this._needsTransparentPass||this._renderPlugins.needsTransparentPass)&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry());this.performanceInfo.advance(m.Statistics.Transparent);this._renderGeometryLinearDepth(c);k=this._renderHUDVisibility();c||this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.Statistics.Hudvisibility);
this._renderEdges(G.Transparency.TRANSPARENT,c);this.performanceInfo.advance(m.Statistics.TransparentEdges);this._renderSlot(l.RenderSlot.VOXEL);this._renderTransparentTerrain();!this._opaqueTerrain&&k&&(c?this._renderLineCallouts(z.HUDTransparentRenderStyle.OCCLUDED):e.compositeTransparentTerrainOntoHUDVisibility(),this._renderHUD(z.HUDTransparentRenderStyle.OCCLUDED,e.framebuffer),this.performanceInfo.advance(m.Statistics.HudOccluded));this.performanceInfo.advance(m.Statistics.TransparentTerrain);
this._setTerrainCulling(!1);this._opaqueTerrain||(e.compositeTransparentTerrainOntoMain(),c&&(this._renderEdges(G.Transparency.OPAQUE),this.performanceInfo.advance(m.Statistics.OpaqueEdges),d&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(m.Statistics.Transparent),this._renderEdges(G.Transparency.TRANSPARENT),this.performanceInfo.advance(m.Statistics.TransparentEdges)));c&&this._renderLineCallouts(z.HUDTransparentRenderStyle.NOTOCCLUDED);
this._setMultipassFlags(!1);this._shadowAccumulator.render();e.renderToTargets(()=>{this._renderInternalSlot(l.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._renderSlot(l.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT);this._renderSlot(l.RenderSlot.LASERLINES)},e.currentColorTarget,e.mainDepth);this.performanceInfo.advance(m.Statistics.Atmosphere);this._renderPlugins.needsLaserlineWithContrastControl&&e.renderTmpAndCompositeToMain(()=>this._renderSlot(l.RenderSlot.LASERLINES_CONTRAST_CONTROL),
H.AlphaMode.PremultipliedAlpha);this.performanceInfo.advance(m.Statistics.Laserline);this._renderOccluded();this.performanceInfo.advance(m.Statistics.Occluded);e=(h=h===q.Decorations.ON&&this._magnifierHelper.enabled)&&t.isNone(a)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):a;this._rctx.bindFramebuffer(e);c=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,c)&&t.isSome(c)&&this._compositingHelper.composite(c,
H.AlphaMode.None);this.performanceInfo.advance(m.Statistics.Antialiasing);this._renderHUD(z.HUDTransparentRenderStyle.NOTOCCLUDED,e);this.performanceInfo.advance(m.Statistics.HudNotoccluded);this._renderHighlights(e,this._bindParameters);this.performanceInfo.advance(m.Statistics.Highlights);h&&this._magnifierHelper.render(this._rctx,this._bindParameters);e!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,H.AlphaMode.None));this._disposeOITBuffers();
this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera);this._sliceHelper.plane=g;this._isRendering=!1;if(this.onPostRender)this.onPostRender();this.performanceInfo.postrender()};f.finish=function(a){this._hasAnimations||(this._animationTimestep=M.Milliseconds(0));a===q.RenderRequestType.BACKGROUND&&(this._rctx.gl.getError(),this._animationTimestep=M.Milliseconds(Math.max(.9*this._animationTimestep+this.performanceInfo.elapsedTime/R.MAXIMUM_ANIMATION_LOAD*(1-.9),R.MINIMUM_IDLE_ANIMATION_MS)))};
f.readDepthPixels=function(a,c,d,h,e,g){const k=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);this._needsLinearDepth||(this._ensureBindParameters(a),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(C.ClearBufferBit.COLOR_BUFFER_BIT|C.ClearBufferBit.DEPTH_BUFFER_BIT|C.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH));k.readPixels(c,
d,h,e,C.PixelFormat.RGBA,C.PixelType.UNSIGNED_BYTE,g)};f.readAccumulatedShadow=function(a,c){return this._shadowAccumulator.readAccumulatedShadow(a,c)};f._setMultipassFlags=function(a){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=a;this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=a};f._setTerrainCulling=function(a){this._renderContext.multipassTerrainParams.cullAboveGround=
this._bindParameters.cullAboveGround=a};f._renderSlot=function(a){this._renderContext.slot=a;this._renderPlugins.render()};f._renderEdges=function(a,c=!1){const d=this._edgeView;t.isSome(d)&&d.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>d.render(this._bindParameters,a),H.AlphaMode.Alpha,c)};f._renderShadowMap=function(a,c,d,h){const e=this._shadowMap;e.enabled&&(e.start(c,d,h),this._shadowHighlightHelper.updateParameters(c,d),this.needsShadowHighlight?(this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,
this._shadowMap,g=>e.takeCascadeSnapshotTo(g,T.HighlightShadowMapSlot)),e.clear(),this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,g=>{e.takeCascadeSnapshotTo(g,T.DefaultSnapshotSlot);this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)})):this._renderShadowCascades(p.RenderPass.MATERIAL_DEPTH_SHADOWMAP_ALL),e.finish(a),c.setGLViewport(this._rctx))};f._renderShadowCascades=function(a,c=this._shadowMap,d=h=>{}){for(const h of c.getCascades())h.camera.setGLViewport(this._rctx),
this._ensureCameraBindParameters(h.camera),this._renderGeometryAndTransparentTerrainPass(a),d(h)};f._renderLinearDepth=function(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_DEPTH),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth);this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=
this._offscreenRendering.linearDepthTexture};f._renderTerrainLinearDepth=function(a){a?(a=this._renderContext.pass,this._renderContext.pass=p.RenderPass.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1E10,-1E10,-1E10,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=
this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture};f._renderGeometryLinearDepth=function(a){a?(a=this._renderContext.pass,this._offscreenRendering.renderToTargets(()=>this._renderGeometryPass(p.RenderPass.MATERIAL_DEPTH),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=
this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture};f._renderNormal=function(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_NORMAL)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};f._computeDepthRange=function(a){if(!this.needsDepthRange)return S.ZERO;const c=
da.depthRangeFromScene(a,this._content,this._stage.layers);S.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};f._renderGeometryAndTransparentTerrainPass=function(a){this._renderContext.pass=a;this._renderGeometryPass(a);this._renderTransparentTerrain()};f._renderGeometryPass=function(a){this._renderContext.pass=a;this._renderOpaqueGeometry();this._renderTransparentGeometry()};f._renderOpaqueGeometry=function(){this._renderSlot(l.RenderSlot.INTEGRATED_MESH);
this._renderSlot(l.RenderSlot.OPAQUE_TERRAIN);this._renderInternalSlot(l.RenderSlot.OPAQUE_MATERIAL);this._renderSlot(l.RenderSlot.OPAQUE_PLUGIN);this._renderSlot(l.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)};f._renderTransparentGeometry=function(){this._renderInternalSlot(l.RenderSlot.TRANSPARENT_MATERIAL);this._renderSlot(l.RenderSlot.TRANSPARENT_PLUGIN)};f._renderTransparentTerrain=function(){this._renderSlot(l.RenderSlot.TRANSPARENT_TERRAIN)};f._renderHUDVisibility=function(){let a=!1;this._renderContext.offscreenRenderingHelper&&
this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture;a=this._renderInternalSlot(l.RenderSlot.OCCLUSION_PIXELS)},this._multipassTerrain&&!this._opaqueTerrain);return a};f._renderLineCallouts=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;a===z.HUDTransparentRenderStyle.OCCLUDED?this._offscreenRendering.renderToTargets(()=>this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS),
this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS)};f._renderHUD=function(a,c){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(a),!0),this._rctx.bindFramebuffer(c),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,H.AlphaMode.PremultipliedAlpha)):a===z.HUDTransparentRenderStyle.OCCLUDED?this._offscreenRendering.renderToTargets(()=>
this._renderHUDElements(z.HUDTransparentRenderStyle.OCCLUDED),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(a))};f._renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this._renderInternalSlot(l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._renderInternalSlot(l.RenderSlot.HUD_MATERIAL);this._renderInternalSlot(l.RenderSlot.LABEL_MATERIAL)};f._renderHighlights=function(a,c){if(this.needsHighlight){var d=
this._highlightHelper,h=d.profilingCallback&&ua.startMeasurement(this._renderContext.rctx);this._renderContext.highlightDepthTexture=c.highlightDepthTexture;var e=this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(p.RenderPass.MATERIAL_HIGHLIGHT);this._rctx.clearSafe(C.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(z.HUDTransparentRenderStyle.BOTH)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=
e.colorTexture;this.needsShadowHighlight&&this._shadowHighlightHelper.render(c,a);d.render(this._renderContext.camera,e,a);t.isSome(h)&&d.profilingCallback&&h.stop(g=>{d.profilingCallback&&d.profilingCallback(g)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};f._accumulateShadows=function(a,c,d){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,a,c,d),this._shadowAccumulator.accumulateFixedSamples(),
this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)};f._renderOrderIndependentTransparency=function(a,c){const d=e=>{this._renderContext.transparencyPassType=e;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._offscreenRendering.renderOITPass(()=>a(),e,c)},h=this._renderContext.pass;this._renderContext.pass=p.RenderPass.MATERIAL_ALPHA;d(q.TransparencyPassType.Alpha);this._renderContext.pass=p.RenderPass.MATERIAL;d(q.TransparencyPassType.Color);
d(q.TransparencyPassType.FrontFace);this._offscreenRendering.compositeTransparentOntoOpaque(c);this._renderContext.transparencyPassType=q.TransparencyPassType.NONE;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._renderContext.pass=h;this._oitUsed=!0};f._disposeOITBuffers=function(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),
this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget));this._oitUsed=!1};f._renderOccluded=function(){let a=0;this._materialRenderers.forEach((g,k)=>{k&&k.isVisible()&&k.renderOccluded===u.RenderOccludedFlag.OccludeAndTransparentStencil&&(a|=k.renderOccluded,I.push(k))});const c=this._offscreenRendering,d=(g,k,v,x,b)=>{0!==(a&k)&&(c.renderToTargets(v,c.tmpColor,c.mainDepth,[0,0,0,0],x,b),c.compositeOccludedOntoMain(g))};0!==I.length&&(this._renderInternalSlot(l.RenderSlot.OCCLUDER_MATERIAL,
I),d(.5,u.RenderOccludedFlag.OccludeAndTransparentStencil,()=>this._renderInternalSlot(l.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,I),!1,!1),I.length=0);this._materialRenderers.forEach((g,k)=>{k&&k.isVisible()&&(k.renderOccluded===u.RenderOccludedFlag.OccludeAndTransparent||k.renderOccluded===u.RenderOccludedFlag.Transparent||k.renderOccluded===u.RenderOccludedFlag.Opaque)&&(a|=k.renderOccluded,J.push(k))});const h=this._renderPlugins.renderOccludedFlags;if(a|=h){var e=g=>{this._renderContext.renderOccludedMask=
g;h>u.RenderOccludedFlag.Occlude&&this._renderSlot(l.RenderSlot.OCCLUDED_TERRAIN);this._renderInternalSlot(l.RenderSlot.OPAQUE_MATERIAL,J);this._renderInternalSlot(l.RenderSlot.TRANSPARENT_MATERIAL,J);this._renderInternalSlot(l.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,J);this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=p.RenderPass.MATERIAL;d(.5,u.RenderOccludedFlag.OccludeAndTransparent,()=>e(u.RenderOccludedFlag.OccludeAndTransparent),!0,q.StencilBits.OutlineVisualElementMask);
d(.5,u.RenderOccludedFlag.Transparent,()=>e(u.RenderOccludedFlag.Transparent),!0,q.StencilBits.OutlineVisualElementMask);d(1,u.RenderOccludedFlag.Opaque,()=>e(u.RenderOccludedFlag.Opaque),!0,q.StencilBits.OutlineVisualElementMask);J.length=0}};f._renderAntiAliasing=function(a,c){if(a===q.AntiAliasingMode.SMAA){if(this._smaaPass.enable(()=>this._requestRender())&&t.isSome(c))return this._smaaPass.render(c),!0}else this._smaaPass.disable();return!1};f._ensureCameraBindParameters=function(a){this._renderContext.camera=
a;this._bindParameters.camera=this._renderContext.camera;this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2];this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]};f._ensureBindParameters=function(a){var c;this._ensureCameraBindParameters(a);a=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap;this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled;this._bindParameters.ssaoHelper=
this._renderContext.ssaoHelper;this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled;this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane;this._bindParameters.hasOccludees=this._renderContext.hasOccludees;this._renderContext.multipassTerrainParams.camera=this._renderContext.camera;this._bindParameters.hudVisibilityTexture=a.hudVisibilityTexture;this._bindParameters.highlightDepthTexture=null!=(c=a.depthTexture)?c:this._getFallbackDepthTexture()};f._ensureBindParametersSSR=
function(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=y.IDENTITY:(w.translate(U,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),w.translate(L,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),w.invert(L,L),w.invert(V,this._renderContext.camera.projectionMatrix),
w.multiply(E,L,V),w.multiply(E,U,E),w.multiply(E,this._renderContext.lastFrameCamera.projectionMatrix,E),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=E),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null;this._renderContext.ssrParams.ssrEnabled=
this._bindParameters.ssrEnabled=this.hasWaterReflection};f._ensureBindParametersCloudsReflections=function(){this._bindParameters.cloudsCompositionParams=this._renderContext.cloudsCompositionParams};f._renderInternalSlot=function(a,c){let d=!1;this._bindParameters.slot=a;t.isSome(c)?c.forEach(h=>{h.shouldRender(this._renderContext)&&(h=this._materialRenderers.get(h),t.isSome(h)&&(d=h.render(a,this._renderContext.pass,this._bindParameters)||d))}):this._materialRenderers.forEach((h,e)=>{e.shouldRender(this._renderContext)&&
(d=h.render(a,this._renderContext.pass,this._bindParameters)||d)});return d};f._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=ea.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};P._createClass(K,[{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"hasWaterReflection",get:function(){return this.hasWater&&this._waterReflectionEnabled}},{key:"updating",get:function(){return this._antialiasing===
q.AntiAliasingMode.SMAA&&this._smaaPass.updating||t.isSome(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return null===this._bindParameters.reprojectionMatrix||w.equals(this._bindParameters.reprojectionMatrix,y.IDENTITY)}},{key:"_reprojectionMatrix",set:function(a){w.equals(this._bindParameters.reprojectionMatrix,a)||(this._bindParameters.reprojectionMatrix=
a,this.notifyChange("isCameraFinal"))}},{key:"hasShadowsEnabled",get:function(){var a;return!(null==(a=this._shadowMap)||!a.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlendWorking}},{key:"animationTimestep",get:function(){return this._animationTimestep}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.enabled||
this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}},{key:"needsNormal",get:function(){return this._ssaoHelper.enabled}},{key:"needsDepthRange",get:function(){return this._shadowMap.enabled||this.needsShadowCast}},{key:"needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&
this.needsHighlight}},{key:"needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){var a,c,d,h,e,g,k,v,x,b;return{offscreen:null!=(a=null==(c=this._offscreenRendering)?void 0:c.gpuMemoryUsage)?a:0,highlights:(null!=(d=null==(h=this._highlightHelper)?void 0:h.gpuMemoryUsage)?d:0)+(null!=(e=null==(g=this._shadowHighlightHelper)?void 0:g.gpuMemoryUsage)?e:0),shadows:null!=(k=null==(v=this._shadowMap)?void 0:v.gpuMemoryUsage)?k:0,ssao:null!=
(x=null==(b=this._ssaoHelper)?void 0:b.gpuMemoryUsage)?x:0}}},{key:"test",get:function(){const a=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:c=>{var d;switch(c){case n.FramebufferId.Color:return a._offscreenRendering.colorTexture;case n.FramebufferId.LinearDepth:return a._offscreenRendering.linearDepthTexture;
case n.FramebufferId.Normals:return a._offscreenRendering.normalTexture;case n.FramebufferId.ShadowMap:return null==(d=a._shadowMap)?void 0:d.test.depthTexture;case n.FramebufferId.HudVisibility:return a._offscreenRendering.hudVisibilityTexture;case n.FramebufferId.Highlight:return a._offscreenRendering.highlightTexture}}}}}]);return K}(W);A.__decorate([B.property()],n.Renderer.prototype,"_shadowAccumulator",void 0);A.__decorate([B.property()],n.Renderer.prototype,"_smaaPass",void 0);A.__decorate([B.property()],
n.Renderer.prototype,"_antialiasing",void 0);A.__decorate([B.property()],n.Renderer.prototype,"_edgeView",void 0);A.__decorate([B.property()],n.Renderer.prototype,"updating",null);A.__decorate([B.property()],n.Renderer.prototype,"isCameraFinal",null);n.Renderer=A.__decorate([Y.subclass("esri.views.3d.webgl-engine.lib.Renderer")],n.Renderer);n.FramebufferId=void 0;(function(r){r[r.Color=0]="Color";r[r.LinearDepth=1]="LinearDepth";r[r.Normals=2]="Normals";r[r.ShadowMap=3]="ShadowMap";r[r.HudVisibility=
4]="HudVisibility";r[r.Highlight=5]="Highlight"})(n.FramebufferId||(n.FramebufferId={}));const J=[],I=[],U=y.create(),V=y.create(),L=y.create(),E=y.create();Object.defineProperty(n,"__esModule",{value:!0})});