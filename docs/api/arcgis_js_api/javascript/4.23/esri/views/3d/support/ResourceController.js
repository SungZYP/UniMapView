// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/scheduling ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(g,p,d,v,w,l,x,y,h,D,E,F,t,u,z,A,e){g.ResourceControllerMain=
function(k){function b(){var m=k.apply(this,arguments)||this;m.updating=!1;return m}p._inheritsLoose(b,k);return b}(v);d.__decorate([h.property({readOnly:!0})],g.ResourceControllerMain.prototype,"updating",void 0);g.ResourceControllerMain=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],g.ResourceControllerMain);var q;(function(k){let b=function(m){function n(){var a=m.apply(this,arguments)||this;a._scheduler=null;a._memoryController=null;a._streamDataLoader=null;a._cameraChangeTime=
0;a._handles=new w;a._frameTask=null;a._scheduleTask=e.ImmediateTask;a._state=e.State.IDLE;return a}p._inheritsLoose(n,m);var f=n.prototype;f.initialize=function(){this._cameraChangeTime=this.now();this._scheduler=e.newScheduler(this.now);this._memoryController=z.newMemoryController(this.view);this._streamDataLoader=new A.StreamDataLoader;this._streamDataLoader.setup(u.maxDownloadSlots,u.downloadSlotsPerClient,this._scheduler);this._handles.add([this.view.watch("state.camera",(a,c)=>this._cameraChangedHandler(a,
c),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]);this._frameTask=x.addFrameTask({update:a=>this._frame(a)});this._scheduleTask=this._scheduler.registerTask(e.TaskPriority.RESOURCE_CONTROLLER)};f.destroy=function(){this._handles=l.destroyMaybe(this._handles);this._scheduleTask.remove();this._frameTask=l.removeMaybe(this._frameTask);this._streamDataLoader=l.destroyMaybe(this._streamDataLoader);
this._memoryController=l.destroyMaybe(this._memoryController);this._scheduler=l.destroyMaybe(this._scheduler)};f.schedule=function(a,c,r){return this._scheduleTask.schedule(a,c,r)};f.createStreamDataRequester=function(a){const c=this._streamDataLoader;return{request(r,B,C){return c.request(r,B,a,C)},get busy(){return!c.hasDownloadSlots(a)}}};f._frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(y.secondsFromMilliseconds(a.deltaTime)),!this._scheduler))return;
this._updateState();this._scheduler.state=this._state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};f._cameraChangedHandler=function(a,c){a&&c&&a.almostEquals(c)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)};f._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};f._updateState=function(){this.view.animation?
this._state=e.State.ANIMATING:this.view.interacting?this._state=e.State.INTERACTING:(this._state===e.State.ANIMATING&&(this._cameraChangeTime=0),this._state=300>=this._scheduler.now-this._cameraChangeTime?e.State.INTERACTING:e.State.IDLE)};p._createClass(n,[{key:"updating",get:function(){var a,c;return!!(null!=(a=this._memoryController)&&a.updating||null!=(c=this._streamDataLoader)&&c.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},
{key:"test",get:function(){return{getQueueStats:a=>this._streamDataLoader.test.loadQueue.getStatsForType(a),state:this._state}}}]);return n}(g.ResourceControllerMain);d.__decorate([h.property({constructOnly:!0})],b.prototype,"view",void 0);d.__decorate([h.property({constructOnly:!0})],b.prototype,"now",void 0);d.__decorate([h.property()],b.prototype,"_scheduler",void 0);d.__decorate([h.property()],b.prototype,"_memoryController",void 0);d.__decorate([h.property()],b.prototype,"_streamDataLoader",
void 0);d.__decorate([h.property({readOnly:!0})],b.prototype,"updating",null);b=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],b);k.ResourceController=b})(q||(q={}));g.newResourceController=function(k,b=()=>performance.now()){return new q.ResourceController({view:k,now:b})};Object.defineProperty(g,"__esModule",{value:!0})});