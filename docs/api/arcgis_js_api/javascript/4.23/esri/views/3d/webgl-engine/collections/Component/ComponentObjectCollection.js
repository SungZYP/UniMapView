// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat3 ../../../../../chunks/mat3f32 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4 ../../../../../chunks/vec4f32 ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./ComponentData ./ComponentObject ./interface ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./Material/ComponentMaterial ./Material/ComponentTechnique ../../core/util/TwoVectorPosition ../../lib/ComponentUtils ../../lib/Util ../../lib/VertexAttribute ../../lib/TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/VertexArrayObject".split(" "),
function(G,P,C,m,H,u,I,r,J,Q,R,D,K,L,S,T,y,U,V,W,X,Y,Z,l,aa,ba,M,ca,da,ea,E,z,fa){function F(v,d){return v===d?l.ComponentParameterSummary.All:0===v?l.ComponentParameterSummary.None:l.ComponentParameterSummary.Some}const N=C.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");C=function(){function v(a){this._renderManager=a;this._objects=[new H,new H];this._renderSubmit=new Y.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);this._componentBufferManager=
new ea.BufferManager(a.rctx)}var d=v.prototype;d.dispose=function(){ca.assert(0===this._objects[y.State.Hidden].length&&0===this._objects[y.State.Visible].length,"ObjectCollection should be empty upon disposal");this._componentBufferManager.destroy()};d.createObject=function(a){const b=new y.ComponentObject;b.toMapSpace=a.toMapSpace.slice();b.transform=a.transform;b.obb=K.clone(a.obb);b.components=new T(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=this._createRenderable(a,
b.components);b.intersectionGeometry=new V(a.geometry.positionData,b.components);this._objects[b.visible].push(b);return b};d.destroyObject=function(a){this._objects[a.visible].removeUnordered(a);a.dispose();this._notifyDirty()};d.setObjectVisibility=function(a,b){b!==a.visible&&(this._objects[a.visible].removeUnordered(a),this._objects[b].push(a),a.visible=b,this._notifyDirty())};d.preSubmit=function(a){const b=a.camera.eye;this.visibleObjects.forAll(c=>{const e=r.squaredDistance(b,c.obb.center);
c.renderable.meta.cameraDepthSquared=e})};d.getMaterial=function(a){return a.renderable.material};d.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};d.setAllComponentVisibilities=function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};d.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};d.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,
invisible:a.components.count-b}};d.setComponentData=function(a,b){const c=a.renderable.material;if(U.isVaryingComponentParameters(b)){a=a.components;var e=a.materialDataBuffer;const k=a.materialDataIndices,f={castShadows:!0,pickable:!0,externalColor:R.create(),externalColorMixMode:D.ColorMixModeEnum.Multiply};e=e.textureBuffer;const g=new Uint8Array(4),w=new Uint32Array(g.buffer);let n=0,h=0,p=0,q=!1,x=0;for(let t=0;t<a.count;t++)b(t,f),n+=+(1>f.externalColor[3]),h+=+(f.externalColorMixMode===D.ColorMixModeEnum.Replace&&
1===f.externalColor[3]),p+=+f.castShadows,D.encodeSymbolColor(f.externalColor,f.externalColorMixMode,g),g[2]=g[2]&254|+f.castShadows,e.setData(k[t],0,g[0],g[1],g[2],g[3]),q=q||0<t&&x!==w[0],x=w[0],f.pickable!==M.getVisibility(a.pickability,t)&&(a.pickability=M.updateVisibilityWithCount(a.pickability,a.count,t,f.pickable));q?(c.componentParameters=new l.ComponentParametersVarying,c.componentParameters.castShadows=F(p,a.count),c.componentParameters.transparent=F(n,a.count),c.componentParameters.opaqueOverride=
F(h,a.count),c.componentParameters.texture=e,e.updateTexture()):(c.componentParameters=new l.ComponentParametersUniform,c.componentParameters.castShadows=f.castShadows?l.ComponentParameterSummary.All:l.ComponentParameterSummary.None,c.componentParameters.externalColor=f.externalColor,c.componentParameters.externalColorMixMode=f.externalColorMixMode)}else c.componentParameters=new l.ComponentParametersUniform,c.componentParameters.castShadows=b.castShadows?l.ComponentParameterSummary.All:l.ComponentParameterSummary.None,
c.componentParameters.externalColor=b.externalColor,c.componentParameters.externalColorMixMode=b.externalColorMixMode;this._notifyDirty()};d.getComponentAabb=function(a,b,c){return a.intersectionGeometry.getComponentAabb(b,c)};d.getComponentObb=function(a){return a.obb};d.getObjectTransform=function(a){return a.transform};d.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};d.intersect=function(a,b,c,e,k,f){m.isSome(k)&&(k.localOrigin=a.transform.position);
const g=u.invert(O,a.transform.rotationScale);r.sub(A,b,a.transform.position);r.sub(B,c,a.transform.position);r.transformMat3(A,A,g);r.transformMat3(B,B,g);b=u.transpose(O,g);return a.intersectionGeometry.intersect(A,B,e,b,k,f)};d.addEdges=function(a,b,c,e){const {indices:k,positions:f}=a.intersectionGeometry,g=a.components.offsets;return b.addComponentObject(a,a.transform,{center:a.obb.center,radius:K.radius(a.obb)},f,k,g,c,e)};d.addComponentHighlight=function(a,b){a=a.components;m.isNone(a.highlightCounts)&&
(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};d.removeComponentHighlight=function(a,b){a=a.components;if(m.isNone(a.highlightCounts))N.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],e=a.highlightCounts[a.count];0===c?N.warn("Removing non-existing highlight."):1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=e-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),
1===e?a.highlightCounts=null:a.highlightCounts[a.count]=e-1)}};d.clearHighlights=function(a){a=a.components;m.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};d.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};d._createRenderable=function(a,b){const c=this._renderManager.rctx;var e=a.geometry,k=e.vertices.layoutParameters,f=E.BufferObject.createVertex(c,z.Usage.STATIC_DRAW,e.vertices.data);const g=m.applySome(e.indices,q=>
E.BufferObject.createIndex(c,z.Usage.STATIC_DRAW,q));var w=L.glLayout(Z.createVertexBufferLayout(k)),n=new Uint16Array(e.vertices.count);for(var h=0;h<b.count;h++){var p=b.offsets[h];const q=b.offsets[h+1],x=b.materialDataIndices[h];if(m.isSome(e.indices))for(;p<q;p++)n[e.indices[p]]=x;else for(;p<q;p++)n[p]=x}e=E.BufferObject.createVertex(c,z.Usage.STATIC_DRAW,n.buffer);n=new ba.TwoVectorPosition(a.transform.position);h=I.clone(a.transform.rotationScale);u.invert(h,h);u.transpose(h,h);b=new aa.ComponentDrawParameters;
r.copy(b.transformWorldFromModelTL,n.low);r.copy(b.transformWorldFromModelTH,n.high);u.copy(b.transformWorldFromModelRS,a.transform.rotationScale);u.copy(b.transformNormalGlobalFromModel,h);Q.copy(b.toMapSpace,a.toMapSpace);a=new l.ComponentMaterial;w=new fa.VertexArrayObject(c,a.attributeLocations,{data:w,componentIndices:ha},{data:f,componentIndices:e},m.unwrap(g));k=new X.RenderGeometry(w,z.PrimitiveType.TRIANGLES,k,m.isSome(g));f={cameraDepthSquared:.5,gpuMemoryEstimate:f.byteSize+e.byteSize+
(m.isSome(g)?g.byteSize:0)};return new W.Renderable(a,b,k,f)};d._notifyDirty=function(){this._renderManager.notifyDirty()};P._createClass(v,[{key:"visibleObjects",get:function(){return this._objects[y.State.Visible]}}]);return v}();const ha=L.glLayout(S.newLayout().u16(da.VertexAttribute.COMPONENTINDEX)),O=I.create(),A=J.create(),B=J.create();G.ComponentObjectCollection=C;Object.defineProperty(G,"__esModule",{value:!0})});