// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/HandleOwner ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3f64 ../../../layers/graphics/data/QueryEngineResult ./SnappingConstraint ./snappingUtils ./candidates/EdgeSnappingCandidate ./candidates/FeatureSnappingCandidate ./candidates/RightAngleSnappingCandidate".split(" "),
function(x,n,y,r,E,F,G,g,z,H,A,t,Q,R,S,I,J,B,K,v,L,M,C){n.FeatureSnappingEngine=function(u){function l(a){a=u.call(this,a)||this;a.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}};return a}y._inheritsLoose(l,u);var f=l.prototype;f.initialize=function(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),H.sync);g.isSome(this.view)&&this.handles.add([this.view.on("layerview-create",
a=>this._updateLayerView(a.layer,a.layerView)),this.view.on("layerview-destroy",a=>this._updateLayerView(a.layer,null))])};f._updateLayerView=function(a,b){for(const [,c]of this.snappingSources)c.snappingSource.layerSource.layer===a&&(c.layerView=b)};f.destroy=function(){this._set("options",null);for(const [,a]of this.snappingSources)a.destroy()};f.fetchCandidates=function(){var a=y._asyncToGenerator(function*(b,c,d){if(!this.options.effectiveFeatureEnabled)return[];var e=[];const k=this._computeScreeenSizeDistanceParameters(b,
c),h={distance:k,point:b,coordinateHelper:c.coordinateHelper,types:this.types,filter:null};for(const [,{snappingSource:m,layerView:q}]of this.snappingSources)!m.layerSource.enabled||g.isSome(q)&&q.suspended||e.push(m.fetchCandidates(h,d).then(p=>p.filter(w=>!this._candidateIsExcluded(m,w,c.excludeFeature))));e=(yield z.eachAlwaysValues(e)).flat();this._addRightAngleCandidates(e,b,k,c);z.throwIfAborted(d);v.sortCandidatesInPlace(b,e);return e});return function(b,c,d){return a.apply(this,arguments)}}();
f._addRightAngleCandidates=function(a,b,c,d){var e,k,h,m,q,p,w,D;const N=g.isSome(d.vertexHandle)?null==(e=d.vertexHandle.rightEdge)?void 0:null==(k=e.rightVertex)?void 0:k.pos:g.isSome(d.editGeometryOperations)&&"polygon"===d.editGeometryOperations.data.type?null==(h=g.unwrap(null==(m=d.editGeometryOperations.data.components[0])?void 0:m.getFirstVertex()))?void 0:h.pos:null;e=g.isSome(d.vertexHandle)?null==(q=d.vertexHandle.leftEdge)?void 0:null==(p=q.leftVertex)?void 0:p.pos:g.isSome(d.editGeometryOperations)?
null==(w=g.unwrap(null==(D=d.editGeometryOperations.data.components[0])?void 0:D.getLastVertex()))?void 0:w.pos:null;q=a.length;for(p=0;p<q;p++)this._addRightAngleCandidate(a[p],e,b,c,d,a),this._addRightAngleCandidate(a[p],N,b,c,d,a)};f._addRightAngleCandidate=function(a,b,c,d,e,k){if(!g.isNone(b)&&a instanceof L.EdgeSnappingCandidate){var h=a.constraint.closestTo(b),m=(h[0]-c[0])/d.x;c=(h[1]-c[1])/d.y;1>=m*m+c*c&&(e=e.coordinateHelper,k.push(new C.RightAngleSnappingCandidate({coordinateHelper:e,
targetPoint:h,otherVertex:b,otherVertexType:C.OtherVertexType.NEXT,previousVertex:a.constraint.start,constraint:new K.RayConstraint(e,b,h),objectId:a.objectId})))}};f._computeScreeenSizeDistanceParameters=function(a,b){const c=this.options.distance*("touch"===b.pointer?this.options.touchSensitivityMultiplier:1);return g.isNone(this.view)?{x:c,y:c}:"2d"===this.view.type?{x:c*this.view.resolution,y:c*this.view.resolution}:this._computeScreeenSizeDistanceParameters3D(a,c,this.view,b)};f._computeScreeenSizeDistanceParameters3D=
function(a,b,c,d){const {coordinateHelper:e,elevationInfo:k}=d,h=c.state.camera.computeScreenPixelSizeAt(v.anyMapPointToRender(a,e,k,c,O))*c.renderCoordsHelper.unitInMeters/c.mapCoordsHelper.unitInMeters;b*=h;const m=this._computeScreenMagnitudeOfMapOffset(a,h,0,c,d);a=this._computeScreenMagnitudeOfMapOffset(a,0,h,c,d);return{x:b/m,y:b/a}};f._computeScreenMagnitudeOfMapOffset=function(a,b,c,d,{coordinateHelper:e,elevationInfo:k}){const h=e.clone(a);h[0]+=b;h[1]+=c;a=v.anyMapPointToScreenPoint(a,e,
k,d);e=v.anyMapPointToScreenPoint(h,e,k,d);d=e.x-a.x;e=e.y-a.y;return Math.sqrt(d*d+e*e)};f._candidateIsExcluded=function(a,b,c){if(g.isNone(c))return!1;b=this._getCandidateObjectId(b);if(g.isNone(b))return!1;a=a.layerSource.layer;return"graphics"===a.type?c.uid===b:c.sourceLayer===a&&c.attributes&&"objectIdField"in a?c.attributes[a.objectIdField]===b:!1};f._getCandidateObjectId=function(a){return a instanceof M.FeatureSnappingCandidate?a.objectId:null};f._createSourceInfo=function(a){const b=this._createFeatureSnappingSourceType(a);
if(g.isNone(b))return null;if("loading"in b)return this.updatingHandles.addPromise(b.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const c=g.isSome(this.view)?this.view.allLayerViews.find(d=>d.layer===a.layer):null;return new P(b.source,c)};f._createFeatureSnappingSourceType=function(a){switch(a.layer.type){case "feature":case "geojson":case "csv":case "subtype-group":case "wfs":return this._createFeatureSnappingSourceFeatureLayer(a);case "graphics":return this._createFeatureSnappingSourceGraphicsLayer(a)}return null};
f._createFeatureSnappingSourceFeatureLayer=function(a){switch(a.layer.source.type){case "feature-layer":var b=this._getSourceModule("featureService");return g.isSome(b.module)?{source:new b.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader};case "memory":case "csv":case "geojson":case "wfs":if("mesh"!==a.layer.geometryType)return b=this._getSourceModule("featureCollection"),g.isSome(b.module)?{source:new b.module.FeatureCollectionSnappingSource({layerSource:a})}:
{loading:b.loader}}return null};f._createFeatureSnappingSourceGraphicsLayer=function(a){const b=this._getSourceModule("graphics");return g.isSome(b.module)?{source:new b.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader}};f._getSourceModule=function(a){const b=this.sourceModules[a];return g.isNone(b.loader)?(a=this._loadSourceModule(a).then(c=>{b.module=c}),b.loader=a,{module:b.module,loader:a}):{module:b.module,loader:b.loader}};
f._loadSourceModule=function(a){switch(a){case "featureService":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/FeatureServiceSnappingSource"],b,c)));case "featureCollection":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/FeatureCollectionSnappingSource"],b,c)));case "graphics":return this.updatingHandles.addPromise(new Promise((b,c)=>x(["./featureSources/GraphicsSnappingSource"],b,c)))}return null};y._createClass(l,[{key:"updating",get:function(){return G.someMap(this.snappingSources,
({snappingSource:a})=>a.updating)||this.updatingHandles.updating}},{key:"snappingSources",get:function(){var a;const b=this._get("snappingSources")||new Map,c=new Map;if(null!=(a=this.options)&&a.featureSources)for(const e of this.options.featureSources.items){a=e.layer.uid;var d=b.get(a);d?(b.delete(a),c.set(a,d)):e.layer.loaded?(d=this._createSourceInfo(e),g.isSome(d)&&c.set(a,d)):this.updatingHandles.addPromise(e.layer.load())}for(const [,e]of b)e.destroy();return c}},{key:"types",get:function(){return B.SnappingTypes.EDGE|
B.SnappingTypes.VERTEX}}]);return l}(E.HandleOwner);r.__decorate([t.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"spatialReference",void 0);r.__decorate([t.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"view",void 0);r.__decorate([t.property()],n.FeatureSnappingEngine.prototype,"options",void 0);r.__decorate([t.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"updating",null);r.__decorate([t.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,
"snappingSources",null);n.FeatureSnappingEngine=r.__decorate([I.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],n.FeatureSnappingEngine);let P=function(){function u(l,f){this.snappingSource=l;this.layerView=f;this.handles=new F;f=this.snappingSource.layerSource.layer;"refresh"in f&&this.handles.add(f.on("refresh",()=>l.refresh()));this.handles.add([A.init(l,"updating",a=>l.layerSource.updating=a,!0),A.init(l,"availability",a=>l.layerSource.availability=a,!0)])}u.prototype.destroy=
function(){this.snappingSource.destroy();this.handles.destroy()};return u}();const O=J.create();Object.defineProperty(n,"__esModule",{value:!0})});