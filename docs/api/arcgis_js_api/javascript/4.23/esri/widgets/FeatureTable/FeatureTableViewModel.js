// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Grid ./Grid/GridViewModel ./support/FeatureStore ../../intl/locale ../../intl/messages".split(" "),
function(n,g,F,f,y,G,H,I,z,r,h,U,V,W,J,K,L,A,M,N,B,O,C){f=function(D){function w(a){var b=D.call(this,a)||this;b._debounceRefresh=z.debounce(()=>b._refresh());b._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"];b._highlights=new H;b.activeFilters=new y;b.autoRefreshEnabled=!0;b.cellClassNameGenerator=(k,l)=>k.path||null;b.dataProvider=function(){var k=n._asyncToGenerator(function*(l,p){const {store:q}=n._assertThisInitialized(b),{page:v,pageSize:t,sortOrders:u}=l;l=b._sortOrdersToLayerOrderByFields(u);
p&&(q?(yield q.set({orderByFields:l}),"loaded"!==q.state&&"loading"!==q.state&&(yield q.load()),p&&p(yield q.fetchItems({page:v,pageSize:t}))):p&&p([]))});return function(l,p){return k.apply(this,arguments)}}();b.editingEnabled=!1;b.grid=null;b.hiddenFields=new y;b.highlightOnRowSelectEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.relatedRecordsEnabled=!1;b.store=null;b.view=null;const {hiddenFields:c,itemIdPath:e}=n._assertThisInitialized(b);c.addMany(b._defaultHiddenFields);b._onLayerRefresh=
b._onLayerRefresh.bind(n._assertThisInitialized(b));b._set("store",new B);b._set("grid",new M({itemIdPath:e,viewModel:n._assertThisInitialized(b)}));return b}n._inheritsLoose(w,D);var d=w.prototype;d.initialize=function(){var a=this;const b=function(){var c=n._asyncToGenerator(function*(){a.messages=yield C.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");a.messagesCommon=yield C.fetchMessageBundle("esri/t9n/common")});return function(){return c.apply(this,arguments)}}();b();this.handles.add([O.onLocaleChange(b),
r.on(()=>this.grid.selectedItems,"change",c=>this._onSelectionChange(c)),r.watch(()=>this.relatedRecordsEnabled,c=>this.store.relatedRecordsEnabled=c),r.watch(()=>{var c;return null==(c=this.layer)?void 0:c.loaded},c=>c&&this._onLayerLoad()),r.watch(()=>this.store.state,c=>{if("loaded"===c){var e;null==(e=this.grid)?void 0:e.scrollToTop()}}),r.watch(()=>[this.editingEnabled,this.messages],()=>{var c;return(null==(c=this.layer)?void 0:c.loaded)&&this._generateColumns()}),r.watch(()=>{var c;return null==
(c=this.layer)?void 0:c.definitionExpression},(c,e)=>(c||e)&&"loaded"===this.store.state&&this.reset()),r.on(()=>this.layer,"refresh",c=>this._onLayerRefresh(c))])};d.destroy=function(){var a,b;this._resetColumns();this.handles.removeAll();this._highlights.removeAll();this._highlights.destroy();null==(a=this.grid)?void 0:a.destroy();null==(b=this.columns)?void 0:b.destroy();this.view=this.layer=null};d.clearHighlights=function(){this._highlights.removeAll()};d.clearSelection=function(){var a;null==
(a=this.grid)?void 0:a.clearSelection()};d.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.deselectRows(a)};d.filterBySelection=function(){const a=this.grid.getSelectedRowIds();a.length&&(this.clearSelectionFilter(),this.store.objectIds=a,this.activeFilters.add({type:"selection",objectIds:a}))};d.getObjectIdIndex=function(a){var b;return null==(b=this.store)?void 0:b.getObjectIdIndex(a)};d.getValue=function(a,b){var c;a=this.store.getItemByObjectId(a);return null==a?
void 0:null==(c=a.feature)?void 0:c.attributes[b]};d.refresh=function(){var a=n._asyncToGenerator(function*(){return z.ignoreAbortErrors(this._debounceRefresh())});return function(){return a.apply(this,arguments)}}();d.reset=function(){this.grid.reset()};d.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.selectRows(a)};d.scrollToIndex=function(a){var b;null==(b=this.grid)?void 0:b.scrollToIndex(a)};d.clearSelectionFilter=function(){this.store.objectIds=null;const a=this.activeFilters.find(b=>
"selection"===b.type);a&&this.activeFilters.remove(a)};d.zoomToSelection=function(){const {layer:a,view:b}=this,c=this.grid.getSelectedRowIds();if(a&&b&&c.length){var e=a.createQuery();e.objectIds=c;e.returnGeometry=!0;a.queryFeatures(e).then(k=>{b.goTo(k.features).catch(l=>{"AbortError"!==l.name&&console.error(l)})})}};d._refresh=function(){var a=n._asyncToGenerator(function*(){yield this.store.refreshLayerInfo();const b=this.grid.getSelectedRowIds();b.length&&(yield this.store.verifyFeaturesByObjectId(b)).forEach((c,
e)=>{c||this.deselectRows(b[e])});this.grid.refreshPageCache()});return function(){return a.apply(this,arguments)}}();d._onLayerLoad=function(){const a=this.layer.capabilities.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};d._onLayerRefresh=function(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()};d._generateColumns=function(){this._resetColumns();this.columns.addMany([...this._createFieldColumns()]);this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())};
d._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()};d._createColumnsFromConfigs=function(){var a,b;const {editingEnabled:c,fieldConfigs:e,grid:k,hiddenFields:l,layer:p,messages:q,messagesCommon:v,store:t}=this,u=null!=(a=null==(b=this.layer)?void 0:b.fields)?a:[];return e.filter(m=>(u||[]).find(x=>m.name===x.name)).map(m=>{const x=m.direction||null,P=m.formatFunction||null,Q=m.textAlign||null,R=I.isSome(m.initialSortPriority)?
m.initialSortPriority:null,E=(u||[]).find(S=>m.name===S.name),T=!1===m.visible||!0!==m.visible&&-1<l.indexOf(E.name);return new A({config:m,direction:x,editingEnabled:c,field:E,formatFunction:P,grid:k,hidden:T,layer:p,store:t,messages:q,messagesCommon:v,textAlign:Q,initialSortPriority:R})})};d._createColumnsFromFields=function(){var a,b;const {editingEnabled:c,grid:e,hiddenFields:k,layer:l,messages:p,messagesCommon:q,store:v}=this;return(null!=(a=null==(b=this.layer)?void 0:b.fields)?a:[]).map(t=>
{const u=-1<k.indexOf(t.name);return new A({editingEnabled:c,field:t,grid:e,hidden:u,layer:l,store:v,messages:p,messagesCommon:q})})};d._createAttachmentsColumn=function(){var a;return new L({header:null==(a=this.messages)?void 0:a.attachments})};d._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,e)=>e.map(k=>k.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,path:c})=>c+" "+b.toUpperCase()):[]};d._highlight=function(a){var {view:b}=this;b=b&&a&&
b.allLayerViews.items.find(({layer:c})=>c===a.layer);K.highlightsSupported(b)&&this._highlights.add(b.highlight(a),`feature-${a.getObjectId()}`)};d._unhighlight=function(a){a&&this._highlights.remove(`feature-${a.getObjectId()}`)};d._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{let e=c instanceof F?c:null;c=e?e.getObjectId():c;if("number"===typeof c||"string"===typeof c){if(!e){const k=this.store.getItemByObjectId(c);k&&(e=k.feature)}b.push({objectId:c,
feature:e})}});return b};d._onSelectionChange=function(a){const {highlightOnRowSelectEnabled:b}=this,{added:c,removed:e}=a;b&&c.forEach(k=>this._highlight(k.feature));b&&e.forEach(k=>this._unhighlight(k.feature))};d._resetColumns=function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};n._createClass(w,[{key:"activeSortOrders",get:function(){var a;return(null==(a=this.grid)?void 0:a.sortOrders)||[]}},{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",
a),this._generateColumns(),this.store.attachmentsEnabled=a)}},{key:"fieldConfigs",set:function(a){var b;this._set("fieldConfigs",a);(null==(b=this.layer)?0:b.loaded)&&this._generateColumns()}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);this.clearSelection();this._set("filterGeometry",a);(this.store.filterGeometry=a)&&this.activeFilters.add({type:"geometry",geometry:a})}}},{key:"layer",set:function(a){var b;
this._set("layer",a);null==(b=this.grid)?void 0:b.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}},{key:"messages",set:function(a){var b;null==(b=this.grid)?void 0:b.set("messages",a);this._set("messages",a)}}]);return w}(G.HandleOwnerMixin(N));g.__decorate([h.property({readOnly:!0})],f.prototype,"activeFilters",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"activeSortOrders",null);g.__decorate([h.property()],
f.prototype,"attachmentsEnabled",null);g.__decorate([h.property()],f.prototype,"autoRefreshEnabled",void 0);g.__decorate([h.property()],f.prototype,"cellClassNameGenerator",void 0);g.__decorate([h.property()],f.prototype,"dataProvider",void 0);g.__decorate([h.property()],f.prototype,"editingEnabled",void 0);g.__decorate([h.property()],f.prototype,"fieldConfigs",null);g.__decorate([h.property()],f.prototype,"filterGeometry",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"grid",void 0);
g.__decorate([h.property()],f.prototype,"hiddenFields",void 0);g.__decorate([h.property()],f.prototype,"highlightOnRowSelectEnabled",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"itemIdPath",void 0);g.__decorate([h.property()],f.prototype,"layer",null);g.__decorate([h.property()],f.prototype,"messages",null);g.__decorate([h.property()],f.prototype,"messagesCommon",void 0);g.__decorate([h.property()],f.prototype,"relatedRecordsEnabled",void 0);g.__decorate([h.property({readOnly:!0,
type:B})],f.prototype,"store",void 0);g.__decorate([h.property()],f.prototype,"view",void 0);return f=g.__decorate([J.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],f)});