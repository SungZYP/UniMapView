// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ./InteractiveToolViewModel".split(" "),function(e,l,h,t,c,p,m,k,w,x,y,u,v){e.InteractiveAnalysisViewModel=function(r){function q(a={}){var b=r.call(this,a)||this;b.analysisView=
null;b._reconnectViewTask=null;b._analysisBaseHandles=new t;b._parentChangeFromReconnect=!1;a=null==a?void 0:a.analysis;c.isSome(a)?b.analysis=a:(b._set("analysis",b.constructAnalysis()),b._set("isAnalysisOwner",!0));return b}l._inheritsLoose(q,r);var f=q.prototype;f.normalizeCtorArgs=function(a){const {analysis:b,...d}=a;return d};f.initialize=function(){this._analysisBaseHandles.add([m.watch(()=>({analysis:this.analysis,parent:c.applySome(this.analysis,({parent:a})=>a)}),({parent:a})=>{this._parentChangeFromReconnect||
a===this.view||this._set("isAnalysisOwner",!1);a=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1;a&&this._scheduleViewReconnect()}),m.watch(()=>({view:this.view,ready:c.isSome(this.view)&&this.view.ready,supported:this.supported}),({view:a},{view:b})=>{a!==b&&this._disconnectFromView(b);this._scheduleViewReconnect()},m.syncAndInitial),m.watch(()=>this.analysis.isEditable,(a,b)=>{c.isNone(this.analysisView)||(a&&!b&&c.isNone(this.tool)?this.createTool():!a&&b&&c.isSome(this.tool)&&
!this.tool.active&&this.removeTool())})]);this.analysis.visible=this.visible};f.destroy=function(){this._analysisBaseHandles=c.destroyMaybe(this._analysisBaseHandles);this._reconnectViewTask=c.abortMaybe(this._reconnectViewTask);this._disconnectFromView(this.view);c.isSome(this.analysis)&&(this.isAnalysisOwner?(this.analysis.destroy(),this._set("analysis",null)):this.analysis.visible=!0)};f.start=function(){var a=l._asyncToGenerator(function*(){this.clear();this.ready||(yield m.whenOnce(()=>this.ready));
this.createTool({interactive:!0})});return function(){return a.apply(this,arguments)}}();f.onConnectToAnalysisView=function(a){};f.onDisconnectFromAnalysisView=function(){};f._scheduleViewReconnect=function(){var a=this;this._reconnectViewTask=c.abortMaybe(this._reconnectViewTask);const b=p.createTask(function(){var d=l._asyncToGenerator(function*(n){try{yield a._reconnectView(n)}catch(g){p.throwIfAborted(n);if(p.isAbortError(g))throw g;a.logger.warn("Failed to use analysis in view model",g)}finally{b===
a._reconnectViewTask&&(a._reconnectViewTask=null)}});return function(n){return d.apply(this,arguments)}}());this._reconnectViewTask=b};f._reconnectView=function(){var a=l._asyncToGenerator(function*(b){const {view:d}=this,n=c.isSome(d)&&d.ready&&this.supported,g=this.analysis;this._disconnectFromView(d);if(n&&!c.isNone(d)&&!c.isNone(g)){if(this.isAnalysisOwner){if(c.isSome(g.parent)){this.logError("expected owned analysis to have null parent when connecting to view");return}this._parentChangeFromReconnect=
!0;d.analyses.add(g)}this.analysisView=yield d.whenAnalysisView(g);p.isAborted(b)?this._disconnectFromView(d):(this.onConnectToAnalysisView(this.analysisView),!this.analysis.visible&&this.isAnalysisOwner||this.createTool())}});return function(b){return a.apply(this,arguments)}}();f._disconnectFromView=function(a){c.isSome(a)&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,a.analyses.remove(this.analysis));this.analysisView=null;this.onDisconnectFromAnalysisView();this.removeTool()};f._setExternalAnalysis=
function(a){c.isSome(this.analysis)&&!this.isAnalysisOwner&&(this.analysis.visible=!0);this._set("analysis",a);this._set("isAnalysisOwner",!1);this._parentChangeFromReconnect=!1;a.isEditable||this.logger.warn(`The assigned ${a.type} analysis object will not be editable in the view. ${a.nonEditableMessage}`)};l._createClass(q,[{key:"analysis",set:function(a){a!==this._get("analysis")&&(this._disconnectFromView(this.view),this._setExternalAnalysis(a),this._scheduleViewReconnect())}},{key:"ready",get:function(){return c.isSome(this.analysisView)&&
!this.connectingToView}},{key:"connectingToView",get:function(){return c.isSome(this._reconnectViewTask)}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}}]);return q}(v.InteractiveToolViewModel);h.__decorate([k.property({nonNullable:!0})],e.InteractiveAnalysisViewModel.prototype,"analysis",null);h.__decorate([k.property()],e.InteractiveAnalysisViewModel.prototype,"analysisView",void 0);h.__decorate([k.property()],e.InteractiveAnalysisViewModel.prototype,"ready",null);h.__decorate([k.property()],
e.InteractiveAnalysisViewModel.prototype,"connectingToView",null);h.__decorate([k.property({readOnly:!0})],e.InteractiveAnalysisViewModel.prototype,"isAnalysisOwner",null);h.__decorate([k.property()],e.InteractiveAnalysisViewModel.prototype,"_reconnectViewTask",void 0);e.InteractiveAnalysisViewModel=h.__decorate([u.subclass("esri.widgets.support.InteractiveAnalysisViewModel")],e.InteractiveAnalysisViewModel);Object.defineProperty(e,"__esModule",{value:!0})});