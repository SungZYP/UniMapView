// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/Promise ../../core/reactiveUtils ../../core/ReentrantObjectPool ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../form/FormTemplate ../../layers/support/ContingentValue ../../layers/support/LayerContingentValuesCache ../../support/arcadeOnDemand ./InputField ./InputFieldGroup ../../intl/locale ../../intl/messages".split(" "),
function(x,q,p,T,G,H,I,t,J,z,C,r,U,V,W,K,L,D,M,N,O,P,Q,R){const A=new p({attributes:{}}),E=I.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel");p=function(F){function y(a){var b=F.call(this,a)||this;b._arcade=null;b._compiledExpressionLookup=new Map;b._expressionLookup=new Map;b._contingentValuesCache=null;b._fieldPool=new C.ReentrantObjectPool(O,c=>b.handles.add(z.watch(()=>c.value,()=>{c.isUsingValueExpression&&b._afterValueChange(c)}),c.id),({id:c})=>b.handles.remove(c));b._fieldGroupPool=
new C.ReentrantObjectPool(P);b._featureClone=A.clone();b._initialFeature=A.clone();b._needsArcade=!1;b._inputFieldCache=new Map;b._inputFieldGroupCache=new Map;b.contingencyConstraintViolations=new Map;b.messages=null;b.strict=!1;return b}x._inheritsLoose(y,F);var m=y.prototype;m.initialize=function(){var a=this;const b=function(){var e=x._asyncToGenerator(function*(){return a.messages=yield R.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")});return function(){return e.apply(this,arguments)}}();
b();const c=z.watch(()=>this.layer,e=>{"feature"===(null==e?void 0:e.type)&&this.addResolvingPromise(M.createLoadedLayerContingentValuesCache(e).then(f=>{this._contingentValuesCache=f;this.notifyChange("fieldsWithContingentValues")}))},{initial:!0}),d=z.watch(()=>{var e,f;const {formTemplate:g}=this;if(t.isNone(g))return null;const h=null!=(e=g.expressionInfos)?e:[];e=null!=(f=g.elements)?f:[];return[...h.map(l=>l.expression),...null==e?void 0:e.map(l=>this._getExpressionsFromElementRecursive(l)).flat()]},
function(){var e=x._asyncToGenerator(function*(f){if(!f||1>f.length)a._compiledExpressionLookup.clear(),a._expressionLookup.clear();else{var {_compiledExpressionLookup:g,_expressionLookup:h,formTemplate:l}=a;f=new Set(f);h.clear();if(t.isSome(l)&&t.isSome(l.expressionInfos))for(var n of l.expressionInfos)f.delete(n.name),h.set(n.name,n.expression);for(const k of g.keys())f.delete(k),h.set(k,k);if(!(1>f.size)){a._needsArcade=!0;n=yield N.loadArcade();a._arcade=n;({arcadeUtils:n}=n);for(const k of f.values())n.hasGeometryOperations(k)&&
(yield n.enableGeometryOperations(),d.remove()),h.set(k,k),a._setFunctionForExpression(k);a.notifyChange("inputFields")}}});return function(f){return e.apply(this,arguments)}}(),{initial:!0});this.handles.add([Q.onLocaleChange(b),d,c])};m.destroy=function(){this.layer=this.feature=null;this._contingentValuesCache=t.destroyMaybe(this._contingentValuesCache);this._fieldPool.destroy();this._fieldGroupPool.destroy()};m.findField=function(a){return this.allInputFields.find(b=>b.name===a)};m.getValue=function(a){var b;
const {_featureClone:c,layer:d}=this,e=!(null==d||!d.getField(a));return null!=(b=c.getAttribute(a))?b:e?null:void 0};m.setValue=function(a,b){const {_featureClone:c,strict:d}=this,e=this.findField(a);b=""===b?null:b;e&&c.getAttribute(a)!==b&&(e.value=b,d&&!e.valid||this._afterValueChange(e))};m.getValues=function(){return{...this._featureClone.attributes}};m.submit=function(){var a=this.allInputFields;const b=new Set(a.filter(d=>d.valid).map(({name:d})=>d));a=a.filter(d=>!d.valid).map(({name:d})=>
d);const c=this.getValues();if(0<this.validateContingencyConstraints(c,{includeIncompleteViolations:!0}).length)for(const [d,e]of this.contingencyConstraintViolations.entries())"error"===e.type&&(b.delete(d),a.push(d));this.emit("submit",{valid:[...b],invalid:a,values:c})};m.validateContingencyConstraints=function(a,b){const {_contingentValuesCache:c}=this,d=new Map;this.contingencyConstraintViolations=d;if(t.isNone(c))return[];const {invalid:e,incomplete:f}=c.validateContingencyConstraints(a);a=
[...e,...null!=b&&b.includeIncompleteViolations?f:[]];for(const g of a)for(const h of g.fieldGroup.fields)d.set(h,g);return a};m._cullCaches=function(a,b,c){const d=[],e=[];for(const f of a)f.inputFields?(e.push(f.label),d.push(...f.inputFields.map(g=>g.name))):d.push(f.name);this._cullInputFieldCache(d,b);this._cullInputFieldGroupCache(e,c)};m._cullInputFieldCache=function(a,b){b=b.filter(c=>!a.includes(c));for(const c in b)this._inputFieldCache.delete(c)};m._cullInputFieldGroupCache=function(a,
b){b=b.filter(c=>!a.includes(c));for(const c in b)this._inputFieldGroupCache.delete(c)};m._releasePreviousInputFields=function(){const a=this._get("inputFields");if(a&&!(1>a.length))for(const b of a)"groupElement"in b?this._releaseInputFieldGroup(b):this._releaseInputField(b)};m._releaseInputFieldGroup=function(a){a.inputFields.forEach(b=>this._releaseInputField(b));this._fieldGroupPool.release(a)};m._releaseInputField=function(a){this._fieldPool.release(a)};m._emitChangeEvent=function({name:a,valid:b,
value:c}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:c,valid:b})};m._generateInputFieldsFromElements=function(a,b){const c=[];for(const d of a)this._isSupportedElement(d)&&c.push("group"===d.type?this._acquireAndInitializeInputFieldGroup(d,b):this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(d.fieldName),fieldElement:d,...b}));return c};m._generateInputFieldsFromLayerFields=function(a,b){return Array.isArray(a)?a.map(c=>this._acquireAndInitializeInputField({field:c,
fieldElement:null,...b})):(E.warn("esri.widgets.FeatureForm.FeatureFormViewModel","No attribute fields found."),[])};m._acquireAndInitializeInputField=function(a){var b,c,d,e,f,g;const {arcade:h,feature:l,field:n,fieldElement:k,group:u,initialFeature:v,layer:w,messages:B}=a;a=null!=(b=this._getCompiledExpression(null==k?void 0:k.requiredExpression))?b:void 0;b=null!=(c=this._getCompiledExpression(null==k?void 0:k.visibilityExpression))?c:void 0;c=null!=(d=this._getCompiledExpression(null==k?void 0:
k.valueExpression))?d:void 0;d=null!=(e=this._getCompiledExpression(null==k?void 0:k.editableExpression))?e:void 0;e=n.name;const S=null!=(f=null==(g=this._inputFieldCache.get(e))?void 0:g.value)?f:this.getValue(e);f=this._fieldPool.acquire();this._inputFieldCache.set(e,f);return f.set({field:n,fieldElement:k,arcade:h,feature:l,group:u,initialFeature:v,layer:w,messages:B,requiredFunction:a,visibilityFunction:b,editableFunction:d,valueFunction:c,value:S})};m._acquireAndInitializeInputFieldGroup=function(a,
b){var c,d;const e=null!=(c=null==(d=this._inputFieldGroupCache.get(a.label))?void 0:d.state)?c:a.initialState;c=this._fieldGroupPool.acquire();this._inputFieldGroupCache.set(a.label,c);d=[];for(const h of a.elements)this._isSupportedElement(h)&&d.push(this._acquireAndInitializeInputField({field:this._layerFieldsByName.get(h.fieldName),fieldElement:h,group:c,...b}));const {arcade:f,feature:g}=b;b=this._getCompiledExpression(a.visibilityExpression);return c.set({arcade:f,feature:g,groupElement:a,inputFields:d,
state:e,visibilityFunction:b})};m._afterValueChange=function(a){const {name:b,value:c}=a;if(this.get("layer.typeIdField")===a.name&&"types"in this.layer){const d=new Set;this.layer.types.forEach(e=>Object.keys(e.domains).forEach(f=>d.add(f)));d.forEach(e=>{(e=this.findField(e))&&e.notifyChange("domain")})}this._featureClone.setAttribute(b,c);this.notifyChange("inputFields");this._emitChangeEvent(a)};m._getCompiledExpression=function(a){return this._compiledExpressionLookup.get(this._expressionLookup.get(a))};
m._getExpressionsFromElementRecursive=function(a){const b=[];a.visibilityExpression&&b.push(a.visibilityExpression);if("field"===a.type){const c=["requiredExpression","valueExpression","editableExpression"];for(const d of c)a[d]&&b.push(a[d])}if("group"===a.type&&a.elements)for(const c of a.elements)b.push(...this._getExpressionsFromElementRecursive(c));return b};m._setFunctionForExpression=function(a){const {_arcade:{arcadeUtils:b},_compiledExpressionLookup:c}=this;c.set(a,b.createFunction(a))};
m._isSupportedElement=function(a){if("field"===a.type||"group"===a.type)return!0;E.warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${a.label} has unsupported type '${a.type}'`);return!1};m._joinContingentValues=function(){var a=this._contingentValuesCache;if(t.isNone(a))return[];var b="typeIdField"in this.layer?this.layer.typeIdField:null;b=b?this.getValue(b):null;const c=[];for(var d of a.fieldGroups){const {contingencies:h,fields:l,name:n}=
d;a=[];for(var e of h)e.isRetired||t.isSome(e.subtype)&&e.subtype.code!==b||a.push({values:e.values});0<a.length&&c.push({name:n,fields:l,contingencies:a})}const [f,g]=this._generateJoinPlan(c);d=f.flatMap(h=>this._joinFieldGroupContingencies(h));e=g.flatMap(h=>h.contingencies);return[...d,...e]};m._generateJoinPlan=function(a){var b=new Map,c=[],d=new Set;for(var e of a)for(const l of e.fields)if(b.has(l)){const n=b.get(l),k=e,u=[n.name,k.name].sort().join("|");d.has(u)||(c.push([n,k]),d.add(u),
b.set(l,k))}else b.set(l,e);b=new Set(c.flat());a=new Set(a);for(var f of b)a.delete(f);f=new Map;b=new Map;for(var g of new Set(c.flat()))d=Symbol(g.name),f.set(d,new Set([g])),b.set(g,d);for(const [l,n]of c)if(c=b.get(l),g=b.get(n),c!==g){d=f.get(c);e=f.get(g);for(var h of e)d.add(h),b.set(h,c);f.delete(g)}h=[...f.values()].map(l=>[...l]);c=[...a];return[h,c]};m._joinFieldGroupContingencies=function(a){const b=a.slice();var c=b.shift(),d=b.shift();a=this._generateJoinKey(c.fields,d.fields);let e=
new Set([...c.fields,...d.fields]),f=new Map;for(var g of c.contingencies)[c]=this._hashContingency(g,a.codedValueFields,!0),f.has(c)?f.get(c).push(g):f.set(c,[g]);for(;0<b.length;){g=new Map;c=b.shift();const n=this._generateJoinKey(e,c.fields);for(var h of d.contingencies){const [k,u]=this._hashContingency(h,a.codedValueFields);d=u?this._findMatchingContingenciesWithAnyHashMask(f,k):f.get(k);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&d.push(...this._findMatchingContingenciesContainingAny(h,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),
a.codedValueFields));if(!t.isNone(d))for(var l of d){d=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(l,h,a.rangeFields):this._joinContingencies(l,h);if(t.isNone(d))break;const [v]=this._hashContingency(d,n.codedValueFields,!0);g.has(v)?g.get(v).push(d):g.set(v,[d])}}f=g;d=c;a=n;e=new Set([...e,...d.fields])}h=[];for(const n of d.contingencies){const [k,u]=this._hashContingency(n,a.codedValueFields);l=u?this._findMatchingContingenciesWithAnyHashMask(f,k):f.get(k);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&
l.push(...this._findMatchingContingenciesContainingAny(n,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(!t.isNone(l))for(const v of l)l=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(v,n,a.rangeFields):this._joinContingencies(v,n),t.isSome(l)&&h.push(l)}return h};m._joinContingencies=function(a,b){b={values:{...a.values,...b.values}};for(const [c,d]of Object.entries(b.values))"any"===d.objectType&&t.isSome(a.values[c])&&(b.values[c]=a.values[c]);return b};m._joinContingenciesWithRangeDomains=
function(a,b,c){const d=this._joinContingencies(a,b);for(const f of c){var e=a.values[f];const g=b.values[f],{leftIsNull:h,rightIsNull:l,bothAreNull:n,leftIsAny:k,rightIsAny:u,bothAreAny:v,leftIsRange:w,rightIsRange:B}=this._compareObjectTypes(e.objectType,g.objectType);if(!n&&!v)if(h&&u||l&&k)d.values[f]=new D({objectType:"null"});else{if(h&&B||l&&w)return null;k?(e.minValue=-Infinity,e.maxValue=Infinity):u&&(g.minValue=-Infinity,g.maxValue=Infinity);c=Math.max(e.minValue,g.minValue);e=Math.min(e.maxValue,
g.maxValue);if(c>e)return null;d.values[f]=new D({objectType:"range",minValue:c,maxValue:e})}}return d};m._findMatchingContingenciesContainingAny=function(a,b,c){return b.filter(d=>c.every(e=>{var f,g;const h=d.values[e];e=a.values[e];return"any"===h.objectType||"any"===e.objectType||(null==(f=h.codedValue)?void 0:f.code)===(null==(g=e.codedValue)?void 0:g.code)}))};m._findMatchingContingenciesWithAnyHashMask=function(a,b){b=RegExp(`${b}$`);const c=[];for(const [d,e]of a){if("#JSAPI_CONTINGENT_VALUE_ANY_HASH"===
d)break;b.test(d)&&c.push(...e)}return c};m._generateJoinKey=function(a,b){a=Array.isArray(a)?new Set(a):a;var c=Array.isArray(b)?new Set(b):b;b=a.size<c.size?a:c;a=b===a?c:a;c=new Set;const d=new Set;for(const e of b)if(a.has(e)&&(b=this.layer.getFieldDomain(e,{feature:this.feature}),!t.isNone(b)))switch(b.type){case "coded-value":c.add(e);break;case "range":d.add(e)}return{codedValueFields:[...c],rangeFields:[...d]}};m._hashContingency=function(a,b,c=!1){if(1>b.length)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",
!1];const d=[];let e=!1;for(const g of b)if(b=a.values[g],"any"===b.objectType){if(c)return["#JSAPI_CONTINGENT_VALUE_ANY_HASH",!0];e=!0;d.push(`${g}:.*`)}else if("null"===b.objectType)d.push(`${g}:${"#JSAPI_CONTINGENT_VALUE_NULL_HASH"}`);else{var f;d.push(`${g}:${null==(f=b.codedValue)?void 0:f.code}`)}return[d.sort().join("\x26"),e]};m._compareObjectTypes=function(a,b){return{leftIsNull:"null"===a,rightIsNull:"null"===b,bothAreNull:"null"===a&&"null"===b,leftIsAny:"any"===a,rightIsAny:"any"===b,
bothAreAny:"any"===a&&"any"===b,leftIsRange:"range"===a,rightIsRange:"range"===b}};x._createClass(y,[{key:"allInputFields",get:function(){return this.inputFields.reduce((a,b)=>b.inputFields?[...a,...b.inputFields]:[...a,b],[])}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer.fields.map(a=>[a.name,a]))}},{key:"description",get:function(){const {formTemplate:a}=this;return t.isSome(a)?a.description:""},set:function(a){void 0===a?this._clearOverride("description"):this._override("description",
a)}},{key:"feature",get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():A.clone();this._initialFeature=this._featureClone.clone();this._inputFieldCache.clear();this._inputFieldGroupCache.clear();this.contingencyConstraintViolations.clear();this._set("feature",a)}},{key:"fieldsWithContingentValues",get:function(){if(t.isNone(this._contingentValuesCache))return new Set;const a=this._contingentValuesCache.fieldGroups.flatMap(b=>b.fields);return new Set(a)}},{key:"formTemplate",
get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(a){void 0===a?this._clearOverride("formTemplate"):this._override("formTemplate",a)}},{key:"inputFields",get:function(){const {_arcade:a,_featureClone:b,_initialFeature:c,_inputFieldCache:d,_inputFieldGroupCache:e,_needsArcade:f,formTemplate:g,messages:h,layer:l,state:n}=this;if("ready"!==n||f&&!a)return[];var k=b.clone();const u=Array.from(d.keys()),v=Array.from(e.keys());k={arcade:a,feature:k,
initialFeature:c,layer:l,messages:h};k=t.isSome(g)&&0<g.elements.length?this._generateInputFieldsFromElements(g.elements,k):this._generateInputFieldsFromLayerFields(null==l?void 0:l.fields,k);this._cullCaches(k,u,v);this._releasePreviousInputFields();return k.filter(w=>w.visible)}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){var a;return null!=(a=this.feature)&&a.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:
null},set:function(a){a?this._override("layer",a):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return this.valid?!0:this.allInputFields.filter(a=>!a.valid).every(({submittable:a})=>a)}},{key:"title",get:function(){const {formTemplate:a}=this;return t.isSome(a)?a.title:""},set:function(a){void 0===a?this._clearOverride("title"):this._override("title",a)}},{key:"valid",get:function(){const a=
this.allInputFields;return 0<a.length&&a.every(({valid:b})=>b)}}]);return y}(H.HandleOwnerMixin(J.EsriPromiseMixin(G.EventedAccessor)));q.__decorate([r.property({readOnly:!0})],p.prototype,"allInputFields",null);q.__decorate([r.property()],p.prototype,"_layerFieldsByName",null);q.__decorate([r.property({readOnly:!0})],p.prototype,"_inputFieldCache",void 0);q.__decorate([r.property({readOnly:!0})],p.prototype,"_inputFieldGroupCache",void 0);q.__decorate([r.property()],p.prototype,"contingencyConstraintViolations",
void 0);q.__decorate([r.property()],p.prototype,"description",null);q.__decorate([r.property()],p.prototype,"feature",null);q.__decorate([r.property()],p.prototype,"fieldsWithContingentValues",null);q.__decorate([r.property({type:L})],p.prototype,"formTemplate",null);q.__decorate([r.property({readOnly:!0,dependsOn:"formTemplate messages feature layer.fields layer.loaded state".split(" ")})],p.prototype,"inputFields",null);q.__decorate([r.property()],p.prototype,"joinedContingentValues",null);q.__decorate([r.property()],
p.prototype,"layer",null);q.__decorate([r.property()],p.prototype,"messages",void 0);q.__decorate([r.property()],p.prototype,"state",null);q.__decorate([r.property()],p.prototype,"strict",void 0);q.__decorate([r.property()],p.prototype,"submittable",null);q.__decorate([r.property()],p.prototype,"title",null);q.__decorate([r.property()],p.prototype,"valid",null);q.__decorate([r.property()],p.prototype,"getValues",null);q.__decorate([r.property()],p.prototype,"submit",null);return p=q.__decorate([K.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],
p)});