// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/Logger ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/set ../../core/accessorSupport/decorators/subclass ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./Workflow ./workflowUtils".split(" "),function(f,C,y,z,h,A,w,N,O,P,D,E,F,G,p){var x;w=x=function(B){function u(a){a=
B.call(this,a)||this;a.type="create-features";a.createFeatureState="create-new";a.featureFormHandle=null;a.visualVariableAttributes={rotation:null,size:null};a.highlightHandles=new Map;a.preventDefaultActionOnCancel=!1;return a}f._inheritsLoose(u,B);var v=u.prototype;v.updatePendingFeature=function(){var a=f._asyncToGenerator(function*(d){this.preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();y.remove(this.lastActiveGraphics,d);return this._startUpdating(d)});return function(d){return a.apply(this,
arguments)}}();u.create=function(a,d,c,q){a=new x({data:new F.CreateFeaturesWorkflowData({creationInfo:h.unwrap(d),viewModel:a}),onCommit:function(){var r=f._asyncToGenerator(function*(m){yield q(m.creationInfo.layer,{addFeatures:m.viewModel.sketchViewModel.layer.graphics.toArray()})});return function(m){return r.apply(this,arguments)}}()});a._set("steps",this._createWorkflowSteps(a,c));return a};v._fadeExistingFeatures=function(a){if("effect"in a){const c=a.effect;a.effect="saturate(0.6) opacity(0.8)";
return z.makeHandle(()=>a.effect=c)}const d=a.opacity;a.opacity=.7;return z.makeHandle(()=>a.opacity=d)};v._highlight=function(a){const d=this.data.viewModel.view;"3d"===d.type&&this.highlightHandles.set(a,d.highlight(a))};v._removeHighlight=function(a){h.removeMaybe(this.highlightHandles.get(a));this.highlightHandles.delete(a)};v._startCreating=function(){var a=f._asyncToGenerator(function*(){this.createFeatureState="create-new";return p.startCreatingNewFeature(this.data.viewModel.sketchViewModel,
this.data.creationInfo)});return function(){return a.apply(this,arguments)}}();v._startUpdating=function(){var a=f._asyncToGenerator(function*(d){const c=this.data.viewModel,q=c.sketchViewModel,r=this.data.creationInfo.layer,m=p.findLayerInfo(c.layerInfos,r);c.featureFormViewModel.set({feature:d,formTemplate:null==m?void 0:m.formTemplate});h.removeMaybe(this.featureFormHandle);this.featureFormHandle=c.featureFormViewModel.on("value-change",f._asyncToGenerator(function*(){d.attributes=c.featureFormViewModel.getValues();
yield p.updateGraphicSymbolWhenRequired(d)}));this._removeHighlight(d);this.createFeatureState="update-pending";this.visualVariableAttributes=p.getVisualVariableAttributes(d);return p.startUpdatingFeature(q,d,r,this.visualVariableAttributes)});return function(d){return a.apply(this,arguments)}}();u._createWorkflowSteps=function(a,d="awaiting-feature-creation-info"){const {data:c,handles:q}=a;let r=null,m=!0;d=p.createWorkflowSteps(["awaiting-feature-creation-info","creating-features"],d,{"awaiting-feature-creation-info":()=>
({id:"awaiting-feature-creation-info",setUp(){var t=this;return f._asyncToGenerator(function*(){c.creationInfo=null;q.add(c.viewModel.featureTemplatesViewModel.on("select",({item:n})=>{c.creationInfo={layer:n.layer,template:n.template};c.viewModel.activeWorkflow.next()}),t.id)})()},tearDown(){var t=this;return f._asyncToGenerator(function*(){q.remove(t.id)})()}}),"creating-features":()=>({id:"creating-features",setUp(){var t=this;return f._asyncToGenerator(function*(){const n=c.viewModel.view,g=c.viewModel.sketchViewModel;
m=g.updateOnGraphicClick;g.updateOnGraphicClick=!1;a.lastActiveGraphics=[];a.featureFormHandle=h.removeMaybe(a.featureFormHandle);a.visualVariableAttributes={rotation:null,size:null};const H="2d"===n.type?a._fadeExistingFeatures(c.creationInfo.layer):null,I=g.on("create",function(){var k=f._asyncToGenerator(function*(b){if("cancel"===b.state){if(a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}if(1>a.lastActiveGraphics.length)return a._startCreating();b=a.lastActiveGraphics.pop();
return a._startUpdating(b)}if("complete"===b.state)return a._startUpdating(b.graphic)});return function(b){return k.apply(this,arguments)}}()),J=g.on("update",function(){var k=f._asyncToGenerator(function*(b){var e=b.graphics[0];if("complete"===b.state){e!==r&&(a.lastActiveGraphics.push(e),a._highlight(e));r=null;if(b.aborted&&a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}return a._startCreating()}"start"===b.state&&a._removeHighlight(e);yield p.visualVariableInteractiveUpdate(n,
e,b,a.visualVariableAttributes);b=e.attributes;h.isSome(a.visualVariableAttributes.rotation)&&({field:e}=a.visualVariableAttributes.rotation,c.viewModel.featureFormViewModel.setValue(e,b[e]));h.isSome(a.visualVariableAttributes.size)&&({field:e}=a.visualVariableAttributes.size,c.viewModel.featureFormViewModel.setValue(e,b[e]))});return function(b){return k.apply(this,arguments)}}()),K=g.on("delete",function(){var k=f._asyncToGenerator(function*(b){b=b.graphics[0];y.remove(a.lastActiveGraphics,b);
r=b});return function(b){return k.apply(this,arguments)}}());let l=null;const L=A.watch(()=>{var k;const b=g.snappingOptions.featureSources.find(e=>e.layer===c.creationInfo.layer);return{hasFeatureLayerSource:!!b,enabled:null!=(k=null==b?void 0:b.enabled)?k:!1}},({hasFeatureLayerSource:k,enabled:b})=>{const e=g.snappingOptions.featureSources;k?(h.isNone(l)&&(l=new E({layer:g.layer,enabled:b}),e.add(l)),l.enabled=b):(h.isSome(l)&&e.remove(l),l=h.destroyMaybe(l))},A.syncAndInitial),M=n.on("immediate-click",
function(){var k=f._asyncToGenerator(function*(b){b=yield n.hitTest(b,{include:g.layer});0<b.results.length&&(b=b.results[0].graphic,"transform"!==g.activeTool&&"reshape"!==g.activeTool||g.updateGraphics.getItemAt(0)===b||(yield a.updatePendingFeature(b)))});return function(b){return k.apply(this,arguments)}}());yield a._startCreating();q.add({remove:()=>{h.removeMaybe(a.featureFormHandle);I.remove();J.remove();K.remove();L.remove();h.isSome(l)&&g.snappingOptions.featureSources.remove(l);l=h.destroyMaybe(l);
g.cancel();M.remove();h.removeMaybe(H)}},t.id)})()},tearDown(t){var n=this;return f._asyncToGenerator(function*(){t.cancelled&&c.viewModel.sketchViewModel.layer.removeAll();q.remove(n.id);c.viewModel.sketchViewModel.updateOnGraphicClick=m})()}})});return p.avoidFeatureTemplateSelectionWithOnlyOneItem(c,d)};f._createClass(u,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]);
return u}(G);return w=x=C.__decorate([D.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],w)});