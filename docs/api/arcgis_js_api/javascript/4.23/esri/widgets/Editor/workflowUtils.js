// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../Graphic ../../core/has ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/watchUtils ../../core/accessorSupport/diffUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils".split(" "),
function(U,u,p,ca,va,n,y,D,V,da,ea,fa,W,X,ha,E,ia,ja,ka){function Y(b){const a=b.sourceLayer;var c;if(!(c="feature"!==a.type)){a:switch(a.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let d=c=null;var f=a.renderer.getVisualVariablesForType("rotation").filter(e=>(!e.axis||"heading"===e.axis)&&e.field&&!e.valueExpression&&n.isSome(X.getRotationAngle(e,b)));1===f.length&&(c=
la(f[0],a));f=a.renderer.getVisualVariablesForType("size").filter(e=>e.field&&!e.useSymbolValue&&!e.valueExpression&&W.getTransformationType(e)===W.TransformationType.RealWorldSize&&n.isSome(X.getSize(e,b)));1===f.length&&(d=ma(f[0],a));return{rotation:c,size:d}}function la(b,a){const c="heading"===(b.axis||"heading")&&"arithmetic"===b.rotationType?-1:1,d=b.field,f=(b=a.fields&&a.fields.filter(h=>h.name===d))&&1===b.length?b[0].type:"double";var e=0,g=0;return{field:d,getDefault:()=>Promise.resolve(0),
getValue:h=>{g=e-c*h;return F((g+360)%360,f)},initValue:h=>{e=null!=h?h:g;g=0},isUpdatingInteractively:!1}}function na(b,a){switch(a){case "width":return b[0];case "depth":return b[1];case "height":return b[2];default:return b[2]||b[1]||b[0]}}function oa(b,a,c){return G.apply(this,arguments)}function G(){G=p._asyncToGenerator(function*(b,a,c){if(n.isNone(a))return 0;({symbol:a}=ha.to3D(a));if(n.isNone(a)||"web-style"===a.type||"cim"===a.type)return 0;a=a.symbolLayers.getItemAt(0);if(!a)return 0;switch(a.type){case "icon":return{computeIconLayerResourceSize:c}=
yield new Promise((d,f)=>U(["../../symbols/support/symbolLayerUtils"],d,f)),a.size||Math.min(x.icon,(yield c(a,x.icon))[0])||x.icon;case "text":return a.size||x.text;case "line":return a.size||x.line;case "object":{const {computeObjectLayerResourceSize:d}=yield new Promise((f,e)=>U(["../../symbols/support/symbolLayerUtils"],f,e));b=yield d(a,b.scale/x.viewScaleSizeFactor);return na(b,c)}case "path":return(null!=a.width?a.width:a.height)||b.scale/x.viewScaleSizeFactor;case "extrude":return a.size||
b.scale/x.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}});return G.apply(this,arguments)}function ma(b,a){const c=b.field,d=b.axis,f=(a=a.fields&&a.fields.filter(k=>k.name===c))&&1===a.length?a[0].type:"double";var e=0,g=0;const h=fa.meterIn[b.valueUnit];let l;l="area"===b.valueRepresentation?k=>(k*h/2)**2*Math.PI:"radius"===b.valueRepresentation||"distance"===b.valueRepresentation?k=>k*h/2:k=>k*h;return{field:c,getDefault:function(){var k=p._asyncToGenerator(function*(m,
v){return F(l(yield oa(v,m,d)),f)});return function(m,v){return k.apply(this,arguments)}}(),getValue:(k,m)=>{e||(e=m.pixelSizeAt(m.center));g=e*k;return F(g,f)},initValue:k=>{e=null!=k?k:g;g=0},isUpdatingInteractively:!1}}function F(b,a){switch(a){case "small-integer":case "integer":case "long":return Math.round(b);case "double":case "single":return b;default:return 0}}function z(b){return H.apply(this,arguments)}function H(){H=p._asyncToGenerator(function*(b){const a=yield E.getDisplayedSymbol(b,
{useSourceLayer:!0,ignoreGraphicSymbol:!0}),c=da.diff(b.symbol,a);n.isSome(c)&&(b.symbol=a)});return H.apply(this,arguments)}function pa(b){if("mesh"===b||"multipatch"===b)throw Error("Mesh and Multipatch not supported");return b}function I(){I=p._asyncToGenerator(function*(b,a,c){yield J(b,a);const d=b.on("create",function(){var f=p._asyncToGenerator(function*(e){if("cancel"===e.state)return J(b,a);"complete"===e.state&&(e=e.graphic,e.sourceLayer||(e.sourceLayer=a.layer),e.attributes||(e.attributes=
{...a.template.prototype.attributes}),yield z(e),c(e))});return function(e){return f.apply(this,arguments)}}());return{remove:()=>{d.remove();b.cancel()}}});return I.apply(this,arguments)}function J(b,a){return K.apply(this,arguments)}function K(){K=p._asyncToGenerator(function*(b,a){const c=a.layer;a={...a.template.prototype.attributes};yield qa(b,c,a);a={graphicProperties:{attributes:a,sourceLayer:c},hasZ:c.capabilities.data.supportsZ};b.layer.elevationInfo=c.elevationInfo;return b.create(pa(c.geometryType),
a)});return K.apply(this,arguments)}function qa(b,a,c){return L.apply(this,arguments)}function L(){L=p._asyncToGenerator(function*(b,a,c){var d;a=new ca({sourceLayer:a,attributes:c});const {rotation:f,size:e}=Y(a);let g=yield E.getDisplayedSymbol(a,{useSourceLayer:!0}),h=!1;for(const l of[e,f])n.isNone(l)||null!=c[l.field]||(c[l.field]=yield l.getDefault(g,b.view),h=!0);h&&(g=yield E.getDisplayedSymbol(a,{useSourceLayer:!0}));switch(null==(d=g)?void 0:d.type){case "simple-fill":case "polygon-3d":b.polygonSymbol=
g;break;case "simple-line":case "line-3d":b.polylineSymbol=g;break;case "simple-marker":case "picture-marker":case "point-3d":b.pointSymbol=g}});return L.apply(this,arguments)}function ra(b,a,c,d){return M.apply(this,arguments)}function M(){M=p._asyncToGenerator(function*(b,a,c,d){if(0===b.length)return[];const {updatable:f,graphicsByLayer:e}=yield c.async(p._asyncToGenerator(function*(){var {results:g}=yield y.whenOrAbort(ka.hitTestSelectSameDistance(a,c),d);const h=new Map,l=({layer:k})=>{var m=
h.get(k);return m?m:(m=[],h.set(k,m),m)};g.forEach(({graphic:k})=>l(k).push(k));g=b.filter(({supports:k,layer:m})=>-1<k.indexOf("update")&&h.has(m));0!==g.length&&c.stopPropagation();return{updatable:g,graphicsByLayer:h}}));return y.whenOrAbort(y.eachAlways(f.map(function(){var g=p._asyncToGenerator(function*({layer:h}){const {objectIdField:l,displayField:k}=h,m=[l];h.fieldsIndex.has(k)&&m.push(k);const v=e.get(h);if(v.some(r=>m.some(w=>!(w in r.attributes)))){const r=h.createQuery();r.outFields=
m;r.returnGeometry=!1;r.objectIds=v.map(w=>w.getObjectId());return h.queryFeatures(r,{signal:d}).then(({features:w})=>w)}return v});return function(h){return g.apply(this,arguments)}}())),d)});return M.apply(this,arguments)}function sa(b,a,c,d){return N.apply(this,arguments)}function N(){N=p._asyncToGenerator(function*(b,a,c,d){if(0===b.length)return[];let f=null;const e=yield c.async(p._asyncToGenerator(function*(){var {results:g}=yield y.whenOrAbort(a.hitTest(c),d);if(0===g.length)return[];const h=
new Set;f=g;f.forEach(({graphic:l})=>h.add(l.layer));g=b.items.filter(({layer:l,supports:k})=>-1<k.indexOf("update")&&h.has(l));0<g.length&&c.stopPropagation();return g}));return y.whenOrAbort(y.eachAlways(e.map(({layer:g})=>{const {objectIdField:h,displayField:l}=g;var k=[h];g.fieldsIndex.has(l)&&k.push(l);const m=g.createQuery();m.outFields=k;m.returnGeometry=!1;k="renderer"in g?ea.calculateTolerance({renderer:g.renderer,event:c}):0;m.geometry=ja.createQueryGeometry(c.mapPoint,k,a);m.outSpatialReference=
a.spatialReference;return g.queryFeatures(m,{signal:d}).then(({features:v})=>{f.forEach(({graphic:r})=>{r.layer===g&&(v.find(w=>w.attributes[h]===r.attributes[g.objectIdField])||v.push(r))});return v})})),d)});return N.apply(this,arguments)}function O(){O=p._asyncToGenerator(function*(b,a,c,d){switch(a.type){case "3d":return ra(b,a,c,d);case "2d":return sa(b,a,c,d)}});return O.apply(this,arguments)}function P(){P=p._asyncToGenerator(function*(b,a,c){const d=b.layer,f=d.createQuery();f.objectIds=[b.getAttribute(d.objectIdField)];
f.outFields=["*"];f.outSpatialReference=a.spatialReference;f.returnM=d.capabilities.data.supportsM;f.returnZ=d.capabilities.data.supportsZ;return(yield d.queryFeatures(f,{signal:c})).features[0]});return P.apply(this,arguments)}function Q(b,a,c,d){return R.apply(this,arguments)}function R(){R=p._asyncToGenerator(function*(b,a,c,d){let f=!1;const {rotation:e,size:g}=d;[e,g].forEach(function(){var h=p._asyncToGenerator(function*(l){if(!n.isNone(l)){var k=a.attributes[l.field];n.isSome(k)?l.initValue(k):
(k=yield l.getDefault(a.symbol,b.view),l.initValue(k),a.setAttribute(l.field,k),f=!0)}});return function(l){return h.apply(this,arguments)}}());f&&(yield z(a));d={multipleSelectionEnabled:!1};"point"===c.geometryType&&(d.enableRotation=n.isSome(e),d.enableScaling=n.isSome(g));b.layer.elevationInfo=c.elevationInfo;return b.update(a,d)});return R.apply(this,arguments)}function Z(b,a,c,d){return S.apply(this,arguments)}function S(){S=p._asyncToGenerator(function*(b,a,c,d){var f;if(n.isSome(a.geometry)&&
"point"===(null==(f=a.geometry)?void 0:f.type)){f=d.rotation;var e=c.toolEventInfo;e=!e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e;if(n.isSome(f)&&n.isSome(e))if("rotate-stop"===e.type)f.isUpdatingInteractively=!1,f.initValue();else{f.isUpdatingInteractively=!0;const {field:g,getValue:h}=f;a.attributes[g]=h(e.angle,b)}d=d.size;c=c.toolEventInfo;c=!c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(n.isSome(d)&&n.isSome(c))if("scale-stop"===
c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:g,getValue:h}=d;a.attributes[g]=h(c.xScale,b)}yield z(a)}});return S.apply(this,arguments)}function T(){T=p._asyncToGenerator(function*(b,a,c,d,f){const e=b.clone();yield z(e);d.map.add(c.layer);c.layer.add(e);const g=b.sourceLayer,h=d.whenLayerView(g),l=()=>{const t=b.attributes[b.layer.objectIdField];h.then(q=>q.setVisibility(t,!1),()=>{});return{remove(){h.then(q=>q.setVisibility(t,!0),()=>{})}}};let k=
null,m=null;if("3d"===d.type){const t=new ia.GraphicState({graphic:e});k=d.trackGraphicState(t);V.init(t,"displaying",q=>{m=q?l():n.removeMaybe(m)})}else m=l();yield Q(c,e,g,a);let v=null;h.then(t=>v=t,()=>{});const r=a.size,w=a.rotation,aa=b.watch("attributes",function(){var t=p._asyncToGenerator(function*(q){let A=!1;for(const B in q){const C=q[B];C!==e.attributes[B]&&(e.setAttribute(B,C),n.isSome(r)&&!r.isUpdatingInteractively&&r.field===B&&r.initValue(C),n.isSome(w)&&!w.isUpdatingInteractively&&
w.field===B&&w.initValue(C),n.isNone(v)||v.requiredFields.includes(B))&&(A=!0)}A&&(yield z(e))});return function(q){return t.apply(this,arguments)}}()),ta=c.on("update",function(){var t=p._asyncToGenerator(function*(q){const A=q.graphics[0];if("complete"===q.state)return Q(c,A,g,a);yield Z(d,A,q,a);f(A.clone())});return function(q){return t.apply(this,arguments)}}()),ua=c.on(["undo","redo"],function(){var t=p._asyncToGenerator(function*(q){f(q.graphics[0].clone())});return function(q){return t.apply(this,
arguments)}}()),ba=()=>{};return{interactive:{remove(){ua.remove();ta.remove();c.cancel();aa&&aa.remove();this.remove=ba}},visual:{remove(){n.removeMaybe(m);d.whenLayerView(g).then(t=>V.whenFalseOnce(t,"updating")).then(()=>{n.removeMaybe(k);c.layer.remove(e);this.remove=ba})}}}});return T.apply(this,arguments)}const x={icon:D.px2pt(24),text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100};u.avoidFeatureTemplateSelectionWithOnlyOneItem=function(b,a){b.viewModel.refreshCreationTemplates();if("awaiting-feature-creation-info"===
a[0].id){var c=b.viewModel.featureTemplatesViewModel.items;1!==c.length?c=null:(c=c[0],c="items"in c?1===c.items.length?c.items[0]:null:c);n.isSome(c)&&(b.creationInfo={layer:c.layer,template:c.template},a.shift())}return a};u.createWorkflowSteps=function(b,a,c){let d=!1;return b.filter(f=>d?!0:d=f===a).map(f=>c[f]())};u.fetchCandidates=function(b,a,c,d){return O.apply(this,arguments)};u.fetchFullFeature=function(b,a,c){return P.apply(this,arguments)};u.findLayerInfo=function(b,a){return b&&b.find(c=>
c.layer===a)};u.getVisualVariableAttributes=Y;u.setUpFeatureAdd=function(b,a,c){return I.apply(this,arguments)};u.setUpGeometryUpdate=function(b,a,c,d,f){return T.apply(this,arguments)};u.sizeDefaults=x;u.startCreatingNewFeature=J;u.startUpdatingFeature=Q;u.updateGraphicSymbolWhenRequired=z;u.visualVariableInteractiveUpdate=Z;Object.defineProperty(u,"__esModule",{value:!0})});