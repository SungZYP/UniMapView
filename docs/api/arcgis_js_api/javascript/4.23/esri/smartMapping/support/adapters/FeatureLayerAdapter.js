// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.23/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/arrayUtils ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/support/arcgisLayerUrl ../../../layers/support/fieldType ../../../layers/support/fieldUtils ../../../rest/support/GenerateRendererParameters ../../../rest/support/QuantizationParameters ../../../rest/support/StatisticDefinition ../../../rest/support/UniqueValueDefinition ../../statistics/support/predominanceUtils ../../statistics/support/statsWorker ../../statistics/support/utils ../../statistics/support/WorkerClient ../utils ./LayerAdapter ./support/utils ../../../statistics/utils ../../../tasks/GenerateRendererTask ../../../geometry/Point".split(" "),
function(v,K,E,L,y,R,G,B,S,T,ea,fa,U,M,N,V,W,C,H,X,I,Y,O,D,t,Z,P,aa,q,x,ba,ca){const da=R.getLogger("esri.smartMapping.support.adapters.FeatureLayerAdapter");E=function(Q){function J(b){return Q.call(this,b)||this}v._inheritsLoose(J,Q);var m=J.prototype;m.destroy=function(){var b;this._hasLocalSource=null;null==(b=this.workerClient)?void 0:b.destroy()};m._isStatsSupportedOnService=function(){const b=this.layer;return!b.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&
!V.isHostedAgolService(b.url)&&10.5>b.version?Promise.reject(new y("feature-layer-adapter:not-supported","Layer does not support statistics query")):Promise.resolve()};m._waitForLayerViewUpdate=function(){var b=v._asyncToGenerator(function*(a){if(!a)throw new y("feature-layer-adapter:insufficient-data","layerView is required to fetch the features");const c=new AbortController;a=S.whenFalseOnce(a,"updating",c.signal);yield B.timeout(a,5E3,c).catch(d=>{da.warn("LayerView is taking too long to update. Aborting fetch from layerView.");
throw d;})});return function(a){return b.apply(this,arguments)}}();m._fetchFeaturesFromMemory=function(){var b=v._asyncToGenerator(function*(a,c,d,e){const f=this.layer;e="json"===e;if(this._hasLocalSource)return a=yield f.queryFeatures(c),e?q.ensureFeaturesJSON(a.features):a.features;yield this._waitForLayerViewUpdate(a);if(e&&"queryFeaturesJSON"in a&&a.queryFeaturesJSON)return{features:e}=yield a.queryFeaturesJSON(c,{signal:d}),e;a=yield a.queryFeatures(c,{signal:d});return e?q.ensureFeaturesJSON(a.features):
a.features});return function(a,c,d,e){return b.apply(this,arguments)}}();m._fetchFeaturesFromService=function(b,a){return this.layer.queryFeatures(b,{signal:a}).then(c=>c.features)};m._fetchFeaturesJSONFromService=function(b,a){return this._fetchFeaturesFromService(b,a).then(q.ensureFeaturesJSON)};m._fetchFeaturesForStats=function(b,a){return P.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression}).then(c=>this.getSampleFeatures({sampleSize:-1,view:b.view,
returnGeometry:b.returnGeometry,requiredFields:c,signal:b.signal},a))};m._summaryStatsFromGenRend=function(b){const a=b.normalizationType,c=b.normalizationField;return this.classBreaks({field:b.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:a,normalizationField:"field"===a?c:void 0,minValue:b.minValue,maxValue:b.maxValue,signal:b.signal}).then(d=>{let e,f;d.classBreakInfos.some(g=>{g.hasAvg&&(e=g);return!!e});if(e){var k=e.maxValue-e.minValue;
f=e.minValue+k/2;k*=4}return x.processSummaryStatisticsResult({min:d.minValue,max:d.maxValue,avg:f,stddev:k})})};m._getSummaryStatsQuery=function(b,a){const {field:c,normalizationType:d,normalizationField:e,normalizationTotal:f,minValue:k,maxValue:g}=b;a=this.supportsSQLExpression&&a?q.msSinceUnixEpochSQL(this,c):b.sqlExpression;var h=q.getFieldExpr({field:c,normalizationType:d,normalizationField:e,normalizationTotal:f,layer:this});const l=a||h;h=l?t.getRangeExpr(l,k,g):null;var n=t.getSQLFilterForNormalization({field:c,
normalizationField:e,normalizationType:d});b=t.mergeWhereClauses(b.sqlWhere,n);b=t.mergeWhereClauses(b,h);const p=x.isNullCountSupported({normalizationField:e,normalizationType:d,sqlExpression:a,supportsSQLExpression:this.supportsSQLExpression,minValue:k,maxValue:g}),r=C.isStringField(this.getField(c));h=x.statisticTypes.filter(u=>"nullcount"===u?p:r?"count"===u:!0);n=this.layer.createQuery();n.where=t.mergeWhereClauses(n.where,b);n.sqlFormat=a?"standard":null;n.outStatistics=h.map(u=>{const A=new I;
let z=null,w=null,F=`${u}_value`;"variance"===u?(z="var",w=l):"nullcount"===u?(z="count",w=this.layer.objectIdField,F="totalcount_value"):"median"===u?(z="percentile-continuous",w=l,A.statisticParameters={value:.5}):(z=u,w=l);A.statisticType=z;A.onStatisticField=w;A.outStatisticFieldName=F;return A});return n};m._summaryStatsFromServiceQuery=function(){var b=v._asyncToGenerator(function*(a,c){yield this._isStatsSupportedOnService();"percent-of-total"===a.normalizationType&&(a.normalizationTotal=yield this._getNormalizationTotal(a.field,
a.normalizationType));const d=this._getSummaryStatsQuery(a,c);a=yield this.layer.queryFeatures(d,{signal:a.signal});c=q.getSummaryStatisticsFromFeatureSet(a,c);return x.processSummaryStatisticsResult(c)});return function(a,c){return b.apply(this,arguments)}}();m._summaryStatsFromClientQuery=function(){var b=v._asyncToGenerator(function*(a,c){const d=this._getSummaryStatsQuery(a,c);a=yield this.layer.queryFeatures(d,{signal:a.signal});c=q.getSummaryStatisticsFromFeatureSet(a,c);return x.processSummaryStatisticsResult(c)});
return function(a,c){return b.apply(this,arguments)}}();m._getNormalizationTotalFromMemory=function(){var b=v._asyncToGenerator(function*(a,c,d){const {featuresJSON:e,graphics:f,layerView:k,query:g}=c;a=(!e&&!f&&k&&"querySummaryStatistics"in k?yield k.querySummaryStatistics(g,{field:a},{signal:d}):e?yield this.workerClient.summaryStatistics({field:a},e):yield D.summaryStatistics({attribute:{field:a},features:f})).sum;if(null==a)throw new y("feature-layer-adapter:invalid","invalid normalizationTotal");
return a});return function(a,c,d){return b.apply(this,arguments)}}();m._summaryStatsFromMemory=function(){var b=v._asyncToGenerator(function*(a,c){const {view:d,field:e,valueExpression:f,normalizationType:k,signal:g}=a,h={field:e,valueExpression:f,normalizationType:k,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue},{featuresJSON:l,graphics:n,layerView:p,query:r}=yield this._processStatsFromMemoryParams(a);f&&d&&(l||n)&&(h.fieldType=
null!=c&&c.type?W.kebabDict.toJSON(c.type):null,h.viewInfoParams=q.getViewInfoParams(d));"percent-of-total"===k&&null==a.normalizationTotal&&(h.normalizationTotal=yield this._getNormalizationTotalFromMemory(e,{featuresJSON:l,graphics:n,layerView:p,query:r},g));return!l&&!n&&p&&"querySummaryStatistics"in p?p.querySummaryStatistics(r,h,{signal:g}):l?this.workerClient.summaryStatistics(h,l):D.summaryStatistics({attribute:h,features:n})});return function(a,c){return b.apply(this,arguments)}}();m._processStatsFromMemoryParams=
function(){var b=v._asyncToGenerator(function*(a){var c=a.features;if(null!=c&&c.length)return c.length&&"declaredClass"in c[0]&&"esri.Graphic"===c[0].declaredClass?{graphics:c}:{featuresJSON:c};const {view:d,field:e,normalizationField:f,valueExpression:k,signal:g}=a;let h=c=a=null,l=null;if(d)try{a=yield d.whenLayerView(this.layer),c="querySummaryStatistics"in a&&"function"===typeof a.querySummaryStatistics}catch{c=!1}if(c)try{yield this._waitForLayerViewUpdate(a);const p=yield P.getFieldsList({field:e,
normalizationField:f,valueExpression:k});(yield q.getMissingFields(this,p,a)).length?c=!1:(h=this.layer.createQuery(),h.outFields=p,h.returnGeometry=!1);a.suspended&&(c=!1)}catch{c=!1}if(!c){var n;l=yield this._fetchFeaturesForStats({field:e,valueExpression:k,normalizationField:f,view:d,signal:g},"json");if(null==(n=l)||!n.length)throw new y("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");}return{layerView:a,query:h,featuresJSON:l}});return function(a){return b.apply(this,
arguments)}}();m._uvFromGenRenderer=function(b,a){const c=b.field,d=new Y;d.attributeField=c;const e=new H;e.classificationDefinition=d;return this.generateRenderer(e,b.signal).then(f=>{const k={},g=this.getField(c);f.uniqueValues.forEach(h=>{let l=h.value;if(null==l||""===l||"string"===typeof l&&(""===l.trim()||"\x3cnull\x3e"===l.toLowerCase()))l=null;null==k[l]?k[l]={count:h.count,data:C.isNumericField(g)&&l?Number(l):l}:k[l].count+=h.count});return{count:k}}).then(f=>x.createUVResult(f,a,b.returnAllCodedValues))};
m._getUVQuery=function(b){const a=b.field,c=b.sqlExpression;var d="countOF"+(a||"Expr");const e=new I;e.statisticType="count";e.onStatisticField=c?"1":a;e.outStatisticFieldName=d;d=this.layer.createQuery();d.where=t.mergeWhereClauses(d.where,b.sqlWhere);d.sqlFormat=c?"standard":null;d.outStatistics=[e];d.groupByFieldsForStatistics=[a||c];return d};m._uvFromServiceQuery=function(b,a){return this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(this._getUVQuery(b),{signal:b.signal})).then(c=>
q.getUniqueValuesFromFeatureSet(c,this,b.field,b.view,null,b.signal)).then(c=>x.createUVResult(c,a,b.returnAllCodedValues))};m._uvFromClientQuery=function(){var b=v._asyncToGenerator(function*(a,c){var {signal:d}=a,e=this._getUVQuery(a);e=yield this.layer.queryFeatures(e,{signal:d});d=yield q.getUniqueValuesFromFeatureSet(e,this,a.field,a.view,null,d);return x.createUVResult(d,c,a.returnAllCodedValues)});return function(a,c){return b.apply(this,arguments)}}();m._uvFromMemory=function(){var b=v._asyncToGenerator(function*(a,
c){const {view:d,field:e,valueExpression:f,returnAllCodedValues:k,signal:g}=a,{featuresJSON:h,graphics:l,layerView:n,query:p}=yield this._processStatsFromMemoryParams(a);a={field:e,valueExpression:f,domain:c,returnAllCodedValues:k};f&&d&&h&&(a.viewInfoParams=q.getViewInfoParams(d));return!h&&!l&&n&&"queryUniqueValues"in n?n.queryUniqueValues(p,a,{signal:g}):h?this.workerClient.uniqueValues(a,h):D.uniqueValues({attribute:a,features:l})});return function(a,c){return b.apply(this,arguments)}}();m._calcBinsSQL=
function(b,a,c){const d=[],e=a.length;a.forEach((f,k)=>{const [g,h]=f;f=null;f=0!==k||c?k!==e-1||c?t.mergeWhereClauses(`${b} >= ${g}`,`${b} ${k===e-1?" \x3c\x3d ":" \x3c "} ${h}`):`${b} >= ${g}`:`${b} < ${h}`;d.push("WHEN ("+f+") THEN "+(k+1))});return["CASE",d.join(" "),"ELSE 0 END"].join(" ")};m._getNormalizationTotal=function(b,a,c){return b&&"percent-of-total"===a?this.summaryStatistics({field:b,signal:c}).then(d=>d.sum):Promise.resolve(null)};m._getQueryParamsForExpr=function(b,a){const c=b.signal;
if(!b.valueExpression&&!b.sqlExpression){const {field:e,normalizationType:f,normalizationField:k}=b;var d=e?this.getField(e):null;d=C.isDateField(d);a={field:e,normalizationType:f,normalizationField:k,normalizationTotal:a,layer:this};return{sqlExpression:d?q.msSinceUnixEpochSQL(this,e):q.getFieldExpr(a),sqlWhere:d?null:b.sqlWhere||t.getSQLFilterForNormalization({field:e,normalizationType:f,normalizationField:k}),signal:c}}return{valueExpression:b.valueExpression,sqlExpression:b.sqlExpression,sqlWhere:b.sqlWhere,
signal:c}};m._getDataRange=function(b,a,c){return null!=a&&null!=c?Promise.resolve({min:a,max:c}):this.summaryStatistics(b).then(d=>({min:d.min,max:d.max}))};m._histogramForExpr=function(b){return this._getNormalizationTotal(b.field,b.normalizationType,b.signal).then(a=>{const c=this._getQueryParamsForExpr(b,a);return this._getDataRange(c,b.minValue,b.maxValue).then(d=>{const {min:e,max:f}=d,k=b.numBins||10;d=x.getEqualIntervalBins(e,f,k);d=this._calcBinsSQL(c.sqlExpression,d,null!=b.minValue&&null!=
b.maxValue);const g=new I({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),h=this.layer.createQuery();h.where=t.mergeWhereClauses(h.where,c.sqlWhere);h.sqlFormat="standard";h.outStatistics=[g];h.groupByFieldsForStatistics=[d];h.orderByFields=[d];return this._isStatsSupportedOnService().then(()=>this.layer.queryFeatures(h,{signal:c.signal})).then(l=>q.getHistogramFromFeatureSet(l,e,f,k,a))})})};m._histogramForField=function(b){let a=null;a=null!=b.minValue&&null!=b.maxValue?
Promise.resolve({min:b.minValue,max:b.maxValue}):this.summaryStatistics(b).then(c=>{if(!c.count)throw new y("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");return{min:c.min,max:c.max}});return a.then(c=>this._getBins({min:c.min,max:c.max},b.field,b.numBins,b.view,b.signal))};m._getBins=function(b,a,c=10,d,e){const {min:f,max:k,normTotal:g,excludeZerosExpr:h}=b,l=b.intervals||x.getEqualIntervalBins(f,k,c);return this._queryBins(l,
b.sqlExpr||a,h,d,e).then(n=>({bins:n.map((p,r)=>({minValue:l[r][0],maxValue:l[r][1],count:p.value})),minValue:f,maxValue:k,normalizationTotal:g}))};m._queryBins=function(b,a,c,d,e){const f=[],k=b.length;for(let g=0;g<k;g++){const h=t.mergeWhereClauses(c,t.mergeWhereClauses(a+" \x3e\x3d "+b[g][0],null!==b[g][1]?a+(g===k-1?" \x3c\x3d ":" \x3c ")+b[g][1]:""));f.push(h)}return B.eachAlways(f.map(g=>this.queryFeatureCount({whereClause:g,view:d,signal:e})))};m._binParamsFromGenRend=function(b,a){const {field:c,
normalizationType:d,normalizationField:e,signal:f}=b,k=t.getSQLFilterForNormalization({field:c,normalizationType:d,normalizationField:e});b=new H({classificationDefinition:x.createClassBreaksDefinition({field:c,normalizationType:d,normalizationField:e,classificationMethod:b.classificationMethod,standardDeviationInterval:b.standardDeviationInterval,breakCount:b.numBins||10}),where:t.mergeWhereClauses(k,a)});return this.generateRenderer(b,f).then(g=>{const {normalizationTotal:h,classBreaks:l}=g;return q.generateBinParams({field:c,
normalizationType:d,normalizationField:e,normalizationTotal:h,classBreaks:l,where:k,layer:this})})};m._histogramFromMemory=function(){var b=v._asyncToGenerator(function*(a){const {view:c,field:d,signal:e}=a,{featuresJSON:f,graphics:k,layerView:g,query:h}=yield this._processStatsFromMemoryParams(a),l={field:d,valueExpression:a.valueExpression,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue,
standardDeviationInterval:a.standardDeviationInterval,classificationMethod:a.classificationMethod,numBins:a.numBins};a.valueExpression&&c&&f&&(l.viewInfoParams=q.getViewInfoParams(c));"percent-of-total"===a.normalizationType&&null==a.normalizationTotal&&(l.normalizationTotal=yield this._getNormalizationTotalFromMemory(d,{featuresJSON:f,graphics:k,layerView:g,query:h},e));return!f&&!k&&g&&"queryHistogram"in g?g.queryHistogram(h,l,{signal:e}):f?this.workerClient.histogram(l,f):D.histogram({attribute:l,
features:k})});return function(a){return b.apply(this,arguments)}}();m._classBreaksFromGenRend=function(b){const {field:a,normalizationType:c,normalizationField:d,normalizationTotal:e,signal:f}=b,k=t.getSQLFilterForNormalization({field:a,normalizationType:c,normalizationField:d});var g=q.getFieldExpr({field:a,normalizationType:c,normalizationField:d,normalizationTotal:e,layer:this});g=t.getRangeExpr(g,b.minValue,b.maxValue);const h=x.createClassBreaksDefinition({field:a,normalizationType:c,normalizationField:d,
classificationMethod:b.classificationMethod,standardDeviationInterval:b.standardDeviationInterval,breakCount:b.numClasses||5}),l=new H;l.classificationDefinition=h;l.where=t.mergeWhereClauses(k,g);return this.generateRenderer(l,f).then(n=>x.resolveCBResult(n,b.classificationMethod))};m._classBreaksFromInterpolation=function(b){const {minValue:a,maxValue:c}=b,d=b.numClasses||5,e=[],f=(c-a)/d;for(let k=0;k<d;k++){const g=a+k*f;e.push({minValue:g,maxValue:g+f})}e[d-1].maxValue=c;b=x.resolveCBResult({classBreaks:e,
normalizationTotal:b.normalizationTotal},b.classificationMethod);return Promise.resolve(b)};m._classBreaksFromMemory=function(){var b=v._asyncToGenerator(function*(a){const {view:c,field:d,signal:e}=a,{featuresJSON:f,graphics:k,layerView:g,query:h}=yield this._processStatsFromMemoryParams(a),l={field:d,valueExpression:a.valueExpression,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,minValue:a.minValue,maxValue:a.maxValue,standardDeviationInterval:a.standardDeviationInterval,
classificationMethod:a.classificationMethod,numClasses:a.numClasses};a.valueExpression&&c&&f&&(l.viewInfoParams=q.getViewInfoParams(c));"percent-of-total"===a.normalizationType&&null==a.normalizationTotal&&(l.normalizationTotal=yield this._getNormalizationTotalFromMemory(d,{featuresJSON:f,graphics:k,layerView:g,query:h},e));return!f&&!k&&g&&"queryClassBreaks"in g?g.queryClassBreaks(h,l,{signal:e}):f?this.workerClient.classBreaks(l,f):D.classBreaks({attribute:l,features:k})});return function(a){return b.apply(this,
arguments)}}();m._heatmapStatsFromMemory=function(){var b=v._asyncToGenerator(function*(a,c){const {blurRadius:d,field:e,view:f,signal:k}=a,g=new X({extent:f.extent,tolerance:"2d"===f.type?f.state.resolution:1});a=this._quantizeFeatures(a.features||(yield this._fetchFeaturesForStats({field:e,view:f,returnGeometry:!0,signal:k})),g,f);if(!a||!a.length)return{count:0,min:null,max:null,avg:null,stddev:null};if(c=q.calculateHeatmapStats(a,d,c,e,f.size[0],f.size[1]))return{count:c.count,min:c.min,max:c.max,
avg:c.mean,stddev:c.stdDev};throw new y("feature-layer-adapter:invalid","unable to calculate heatmap statistics");});return function(a,c){return b.apply(this,arguments)}}();m._quantizeFeatures=function(b,a,c){const d=M.toQuantizationTransform(a),{spatialReference:e,size:f}=c,k=N.isWrappable(e)?N.getInfo(e):null,g=k?Math.round((k.valid[1]-k.valid[0])/d.scale[0]):null;return b.map(h=>{const l=new ca(G.unwrap(h.geometry));M.quantizePoint(d,l,l,l.hasZ,l.hasM);h.geometry=k?this._wrapPoint(l,g,f[0]):l;
return h})};m._wrapPoint=function(b,a,c){0>b.x?b.x+=a:b.x>c&&(b.x-=a);return b};m.getField=function(b=""){return this.layer.getField(b)};m.getFieldUsageInfo=function(b){return this.getField(b)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};m.getFieldDomain=function(b,a){return this.layer.getFieldDomain(b,a)};m.summaryStatistics=function(b){const {field:a,normalizationType:c,sqlExpression:d,view:e,features:f,useFeaturesInView:k}=
b,g=a?this.getField(a):null,h=C.isDateField(g),l=b.valueExpression||d,n=l&&!d,p=e&&"3d"===e.type;return this._hasLocalSource||f||k||n?n||f||k||p?this._summaryStatsFromMemory(b,g):this._summaryStatsFromClientQuery(b,h):this.supportsSQLExpression||!h&&!l&&"natural-log"!==c&&"square-root"!==c?(c&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(b):this._summaryStatsFromServiceQuery(b,h)).catch(()=>{B.throwIfAborted(b.signal);return this._summaryStatsFromMemory(b,g)}):Promise.reject(new y("feature-layer-adapter:not-supported",
"Layer does not support standardized SQL expression for queries"))};m.uniqueValues=function(b){const {field:a,valueExpression:c,sqlExpression:d,features:e,useFeaturesInView:f,signal:k}=b,g=(a?this.getField(a):null)&&this.getFieldDomain(a),h=c&&(!d||!this.supportsSQLExpression),l=b.view,n=l&&"3d"===l.type;return this._hasLocalSource||e||f||h?h||e||f||n?this._uvFromMemory(b,g):this._uvFromClientQuery(b,g):this._uvFromServiceQuery(b,g).catch(p=>{B.throwIfAborted(k);return b.field?this._uvFromGenRenderer(b,
g):p}).catch(()=>{B.throwIfAborted(k);return n?this._uvFromMemory(b,g):this._uvFromClientQuery(b,g)})};m.histogram=function(b){const {field:a,normalizationType:c,normalizationField:d,classificationMethod:e,view:f,signal:k}=b;var g=a?this.getField(a):null;g=C.isDateField(g);const h=b.valueExpression||b.sqlExpression,l=h&&!b.sqlExpression,n=this.supportsSQLExpression,p=!e||"equal-interval"===e,r=b.minValue,u=b.maxValue,A=null!=r&&null!=u,z=b.numBins||10;return this._hasLocalSource||b.features||b.useFeaturesInView||
l?this._histogramFromMemory(b):(h||n)&&p?n||!h&&"natural-log"!==c&&"square-root"!==c?this._histogramForExpr(b):Promise.reject(new y("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):g&&p?Promise.reject(new y("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):c||!p?this._binParamsFromGenRend(b).then(w=>{if(!A)return this._getBins(w,a,z,f,k);
if(r>w.max||u<w.min)throw new y("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(p)return this._getBins({min:r,max:u,sqlExpr:w.sqlExpr,excludeZerosExpr:w.excludeZerosExpr},a,z,f,k);w=q.getFieldExpr({field:a,normalizationType:c,normalizationField:d,normalizationTotal:w.normTotal,layer:this});w=t.getRangeExpr(w,r,u);return this._binParamsFromGenRend(b,w).then(F=>this._getBins(F,a,z,f,k))}):this._histogramForField(b)};
m.classBreaks=function(b){const a=!1!==b.analyzeData,c=this._hasLocalSource||b.features||b.useFeaturesInView||b.valueExpression;return a&&c?this._classBreaksFromMemory(b):(a?this._classBreaksFromGenRend(b):this._classBreaksFromInterpolation(b)).catch(()=>{B.throwIfAborted(b.signal);return this._classBreaksFromMemory(b)})};m.queryFeatureCount=function(b){if(this._hasLocalSource)return Promise.reject(new y("feature-layer-adapter:not-supported","Layer does not support count query"));const a=this.layer,
c=a.createQuery();c.where=t.mergeWhereClauses(c.where,b.whereClause);return a.queryFeatureCount(c,{signal:b.signal})};m.generateRenderer=function(b,a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return Promise.reject(new y("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));const d=new ba({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion});c=c.createQuery();b.where=t.mergeWhereClauses(b.where,
c.where);return d.execute(b,{signal:a})};m.heatmapStatistics=function(b){const {field:a,fieldOffset:c,view:d,signal:e}=b;return(a&&null==c?this.summaryStatistics({field:a,view:d,signal:e}):Promise.resolve(null)).then(f=>{let k=c||0;if(f){const {count:g,min:h,max:l}=f;g?h===l&&0===h?k=1:0>=l?k="abs":0>h&&(k=-1.01*h):k=1}return this._heatmapStatsFromMemory(b,k).then(g=>({...g,summaryStatistics:f,fieldOffset:k}))})};m.predominantCategories=function(){var b=v._asyncToGenerator(function*(a){if(!this._hasLocalSource&&
!this.supportsSQLExpression)throw new y("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");const {fields:c,view:d,signal:e}=a;a=O.getArcadeForPredominantCategory(c);const f=O.getSQLForPredominantCategoryName(c);a=d&&this._hasLocalSource?yield this._uvFromMemory({valueExpression:a,view:d,signal:e}):yield this._uvFromServiceQuery({sqlExpression:f.expression,valueExpression:a,signal:e});return q.getPredominantCategoriesFromUVInfos(a.uniqueValueInfos,
c)});return function(a){return b.apply(this,arguments)}}();m.getSampleFeatures=function(){var b=v._asyncToGenerator(function*(a,c){const {view:d,sampleSize:e,requiredFields:f,returnGeometry:k,signal:g}=a,h=this.layer.createQuery(),l="json"===c;h.outSpatialReference=a.spatialReference||d&&d.spatialReference;h.returnGeometry=!!k;h.outFields=f;let n=[],p=!1;if(d)try{const r=yield d.whenLayerView(this.layer);if(p=!(yield q.getMissingFields(this,f,r)).length)if(n=yield this._fetchFeaturesFromMemory(r,
h,g,c),n.length&&0<e&&e<=n.length)return L.pickRandom(n,e,1)}catch(r){B.throwIfAborted(g)}try{if(this._hasLocalSource)return p?n:l?this._fetchFeaturesJSONFromService(h,g):this._fetchFeaturesFromService(h,g);const r=yield this.queryFeatureCount({view:d,signal:g}),u=this.layer.capabilities.query.maxRecordCount;c=-1===e?r:e;c=u&&c>u?u:c;if(r<=n.length||n.length>=u)return n;const A=d.extent.width/d.width/d.scale*4E5;h.maxAllowableOffset=a.resolution||A;if(r<=c)return l?this._fetchFeaturesJSONFromService(h,
g):this._fetchFeaturesFromService(h,g);if(2E4>=r){const z=yield this.layer.queryObjectIds();h.objectIds=L.pickRandom(z,c,1);return l?this._fetchFeaturesJSONFromService(h,g):this._fetchFeaturesFromService(h,g)}this.layer.get("capabilities.query.supportsPagination")&&(h.num=Math.min(c,2E4));return l?this._fetchFeaturesJSONFromService(h,g):this._fetchFeaturesFromService(h,g)}catch(r){return B.throwIfAborted(g),n}});return function(a,c){return b.apply(this,arguments)}}();m.load=function(b){var a=this;
const c=this.layer.load(b).then(function(){var d=v._asyncToGenerator(function*(e){a.geometryType=e.geometryType;a.objectIdField=e.objectIdField;a.supportsSQLExpression=e.get("capabilities.query.supportsSqlExpression");a._hasLocalSource=!e.url&&!!e.source;a.hasQueryEngine=a._hasLocalSource;a.minScale=e.minScale;a.maxScale=e.maxScale;a.fullExtent=e.fullExtent;a.workerClient=Z.WorkerClient.getInstance();yield a.workerClient.open(G.unwrap(G.unwrap(b).signal))});return function(e){return d.apply(this,
arguments)}}());this.addResolvingPromise(c);return Promise.resolve(this)};return J}(aa);K.__decorate([T.property({constructOnly:!0})],E.prototype,"layer",void 0);return E=K.__decorate([U.subclass("esri.smartMapping.support.adapters.FeatureLayerAdapter")],E)});